<!doctype html><html><head><title>StackLang Part VIII: Compiler Stacks â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>StackLang Part VIII: Compiler Stacks</h1><div class=entry-meta><span class=entry-date>2023-08-11</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/stacklang>StackLang</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/assemblers>Assemblers</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/compilers>Compilers</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/memory>Memory</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/stacks>Stacks</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/virtual-machines>Virtual Machines</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link></a><a class=taxonomy-value href=/series/stacklang>StackLang</a><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2023/08/10/wolverine-old-man-logan-vol.-3-the-last-ronin/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/08/12/wolverine-old-man-logan-vol.-4-old-monsters/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Let&rsquo;s continue <a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/>StackLang Part VII: New CLI and Datatypes</a> and implement <del>lists</del> stacks in the compiler!</p><div class=ranking><h3 class=title>Posts in <a href=/series/stacklang/>StackLang</a>:</h3><div class=content><ul><li><a href=https://blog.jverkamp.com/2023/04/14/stacklang-part-i-the-idea/>StackLang Part I: The Idea</a></li><li><a href=https://blog.jverkamp.com/2023/04/16/stacklang-part-ii-the-lexer/>StackLang Part II: The Lexer</a></li><li><a href=https://blog.jverkamp.com/2023/04/24/stacklang-part-iii-the-parser/>StackLang Part III: The Parser</a></li><li><a href=https://blog.jverkamp.com/2023/05/01/stacklang-part-iv-an-interpreter/>StackLang Part IV: An Interpreter</a></li><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/>StackLang Part V: Compiling to C</a></li><li><a href=https://blog.jverkamp.com/2023/07/16/stacklang-part-vi-some-examples/>StackLang Part VI: Some Examples</a></li><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/>StackLang Part VII: New CLI and Datatypes</a></li><li><a href=https://blog.jverkamp.com/2023/08/11/stacklang-part-viii-compiler-stacks/>StackLang Part VIII: Compiler Stacks</a></li><li><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/>StackLang Part IX: Better Testing</a></li></ul></div></div><p>In this post:</p><nav id=TableOfContents><ul><li><a href=#implementing-stacks>Implementing stacks</a><ul><li><a href=#adding-c-code>Adding C code</a></li><li><a href=#connecting-it-to-the-compiler>Connecting it to the compiler</a></li></ul></li><li><a href=#adding-type-assertions>Adding type assertions</a></li><li><a href=#the-proof-is-in-the-collatz-pudding>The proof is in the (Collatz) pudding?</a></li><li><a href=#cleaning-up-the-compiler-code>Cleaning up the compiler code</a></li></ul></nav><p>Full source code for StackLang: <a href=https://github.com/jpverkamp/stacklang/ target=_blank rel=noopener>github:jpverkamp/stacklang</a></p><h2 id=implementing-stacks>Implementing stacks</h2><h3 id=adding-c-code>Adding C code</h3><p>To implement stacks in the compiler, the first thing that we&rsquo;re going to need is the C version of a stack. I&rsquo;m going to make it a <code>ValueStack</code>, specifically to only store <code>Value</code>. I could probably make it more generic, but&mldr; why? It&rsquo;s not what we need and C doesn&rsquo;t really do generic things.</p><p>First, let&rsquo;s define the struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> capacity;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> size;
</span></span><span style=display:flex><span>    Value <span style=color:#f92672>*</span>values;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} ValueStack;
</span></span></code></pre></div><p>We&rsquo;re going to pre-allocate <code>capacity</code>. That&rsquo;s how many <code>Values</code> the <code>ValueStack</code> can currently hold while <code>size</code> is the number of <code>Values</code> it is <em>actually</em> holding. Then <code>values</code> is a block of memory to store the values.</p><p>The goal is when we need more <code>values</code> than we have <code>capacity</code>, <code>realloc</code> and increase <code>capacity</code> and move the pointer (if necessary). It&rsquo;s more low level memory manipulation than I normally do, but it&rsquo;s certainly interesting.</p><p>Okay, let&rsquo;s init:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define VS_INITIAL_CAPACITY 8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Initialize the stack with default capacity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>ValueStack <span style=color:#f92672>*</span><span style=color:#a6e22e>vs_init</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ValueStack <span style=color:#f92672>*</span>stack <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#66d9ef>sizeof</span>(ValueStack));
</span></span><span style=display:flex><span>    Value <span style=color:#f92672>*</span>values <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#66d9ef>sizeof</span>(Value) <span style=color:#f92672>*</span> VS_INITIAL_CAPACITY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>stack <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>values)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Failed to allocate memory for a ValueStack</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    stack<span style=color:#f92672>-&gt;</span>capacity <span style=color:#f92672>=</span> VS_INITIAL_CAPACITY;
</span></span><span style=display:flex><span>    stack<span style=color:#f92672>-&gt;</span>size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    stack<span style=color:#f92672>-&gt;</span>values <span style=color:#f92672>=</span> values;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> stack;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Straight forward. Yes, <code>VS_INITIAL_CAPACITY</code> is totally arbitrary. ðŸ˜„</p><p>Next, let&rsquo;s reallocate (when necessary):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Ensure there&#39;s room to push another value onto the stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>vs_ensure_capacity</span>(ValueStack <span style=color:#f92672>*</span>stack, <span style=color:#66d9ef>size_t</span> new_size)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (new_size <span style=color:#f92672>&gt;=</span> stack<span style=color:#f92672>-&gt;</span>capacity)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>size_t</span> new_capacity <span style=color:#f92672>=</span> stack<span style=color:#f92672>-&gt;</span>capacity <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        Value <span style=color:#f92672>*</span>new_values <span style=color:#f92672>=</span> <span style=color:#a6e22e>realloc</span>(stack<span style=color:#f92672>-&gt;</span>values, <span style=color:#66d9ef>sizeof</span>(Value) <span style=color:#f92672>*</span> new_capacity);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>new_values)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Failed to re-allocate memory for a ValueStack</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stack<span style=color:#f92672>-&gt;</span>capacity <span style=color:#f92672>=</span> new_capacity;
</span></span><span style=display:flex><span>        stack<span style=color:#f92672>-&gt;</span>values <span style=color:#f92672>=</span> new_values;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m going to go ahead and double the size of the stack whenever it needs to expand. This is probably overestimating (significantly), but I have to choose something. I don&rsquo;t expect it will double too many times in general, so it should be fine.</p><p>It really is fascinating to me that that&rsquo;s all that&rsquo;s needed. If <code>realloc</code> can just grab the next chunk of memory, it will just return the same pointer. If not, it will copy all of the values for you and free the old memory. Pretty cool.</p><p>Okay, next the basic stack things, <code>push</code> and <code>pop</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Push a value onto the stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>vs_push</span>(ValueStack <span style=color:#f92672>*</span>stack, Value val)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vs_ensure_capacity</span>(stack, stack<span style=color:#f92672>-&gt;</span>size <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    stack<span style=color:#f92672>-&gt;</span>values[stack<span style=color:#f92672>-&gt;</span>size<span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> val;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Pop and return a  value from the stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Value <span style=color:#f92672>*</span><span style=color:#a6e22e>vs_pop</span>(ValueStack <span style=color:#f92672>*</span>stack)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (stack<span style=color:#f92672>-&gt;</span>size <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Attempted to pop from an empty stack</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span>stack<span style=color:#f92672>-&gt;</span>values[<span style=color:#f92672>--</span>stack<span style=color:#f92672>-&gt;</span>size];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Sweet.</p><p>Next, random access (making it a <code>vec</code> rather than a <a href=https://en.wikipedia.org/wiki/linked%20list>linked list</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Get a value from the stack by index without removing it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Value <span style=color:#f92672>*</span><span style=color:#a6e22e>vs_get</span>(ValueStack <span style=color:#f92672>*</span>stack, <span style=color:#66d9ef>size_t</span> index)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (index <span style=color:#f92672>&gt;=</span> stack<span style=color:#f92672>-&gt;</span>size)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Attempted to get a value from the stack at an invalid index (%lu, size is %lu)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, index, stack<span style=color:#f92672>-&gt;</span>size);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span>stack<span style=color:#f92672>-&gt;</span>values[index];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Set a value in the stack at a given index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>vs_set</span>(ValueStack <span style=color:#f92672>*</span>stack, <span style=color:#66d9ef>size_t</span> index, Value value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (index <span style=color:#f92672>&gt;=</span> stack<span style=color:#f92672>-&gt;</span>size)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Attempted to get a value from the stack at an invalid index (%lu, size is %lu)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, index, stack<span style=color:#f92672>-&gt;</span>size);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    stack<span style=color:#f92672>-&gt;</span>values[index] <span style=color:#f92672>=</span> value;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And that&rsquo;s it. A C style <code>ValueStack</code>.</p><h3 id=connecting-it-to-the-compiler>Connecting it to the compiler</h3><p>First, a bunch of identical blocks in the <code>compile_expr</code> block for <code>Expression::Identifier</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#e6db74>&#34;make-stack&#34;</span> <span style=color:#f92672>=&gt;</span> lines.push(
</span></span><span style=display:flex><span>    include_str!(<span style=color:#e6db74>&#34;../compile_c_includes/builtins/stack-new.c&#34;</span>)
</span></span><span style=display:flex><span>        .to_string(),
</span></span><span style=display:flex><span>),
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;stack-ref&#34;</span> <span style=color:#f92672>=&gt;</span> lines.push(
</span></span><span style=display:flex><span>    include_str!(<span style=color:#e6db74>&#34;../compile_c_includes/builtins/stack-ref.c&#34;</span>)
</span></span><span style=display:flex><span>        .to_string(),
</span></span><span style=display:flex><span>),
</span></span><span style=display:flex><span><span style=color:#f92672>..</span>.
</span></span></code></pre></div><p>And then each of those generate a small block of C:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// stack-new.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>    Value v <span style=color:#f92672>=</span> {.type <span style=color:#f92672>=</span> TAG_STACK, .as_stack <span style=color:#f92672>=</span> <span style=color:#a6e22e>vs_init</span>()};
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(<span style=color:#f92672>++</span>stack_ptr) <span style=color:#f92672>=</span> v;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// stack-ref.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>    Value <span style=color:#f92672>*</span>i <span style=color:#f92672>=</span> stack_ptr<span style=color:#f92672>--</span>;
</span></span><span style=display:flex><span>    Value <span style=color:#f92672>*</span>s <span style=color:#f92672>=</span> stack_ptr<span style=color:#f92672>--</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert_type</span>(<span style=color:#e6db74>&#34;stack-ref&#34;</span>, <span style=color:#e6db74>&#34;stack&#34;</span>, TAG_STACK, s, names);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert_type</span>(<span style=color:#e6db74>&#34;stack-ref&#34;</span>, <span style=color:#e6db74>&#34;integer&#34;</span>, TAG_NUMBER_INTEGER, i, names);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ValueStack <span style=color:#f92672>*</span>stack <span style=color:#f92672>=</span> s<span style=color:#f92672>-&gt;</span>as_stack;
</span></span><span style=display:flex><span>    Value <span style=color:#f92672>*</span>v <span style=color:#f92672>=</span> <span style=color:#a6e22e>vs_get</span>(stack, i<span style=color:#f92672>-&gt;</span>as_integer);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(<span style=color:#f92672>++</span>stack_ptr) <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>v;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Other than the new <a href=#adding-type-assertions>type assertions</a>, pretty simple code.</p><p>And that&rsquo;s it. We have stacks!</p><h2 id=adding-type-assertions>Adding type assertions</h2><p>So what did I do for type assertions?</p><p>Well, I started writing decent error messages that would output something like &ldquo;Error in stack-ref; expected stack, got &mldr;&rdquo;. But that&rsquo;s a handful of expressions each time (calling <code>value_write</code> and <code>stack_dump</code>). Instead, we can make it a single function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>assert_type</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>type_name, <span style=color:#66d9ef>uint8_t</span> type_tag, Value <span style=color:#f92672>*</span>value, Name <span style=color:#f92672>*</span>names)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (value<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>!=</span> type_tag)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Error in %s, expected a %s, got: &#34;</span>, name, type_name);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>value_write</span>(stderr, value);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34; with&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>stack_dump</span>(names);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It&rsquo;s a bit ugly to have to pass both the type name and tag, but the tags are numeric. I could probably do something with macros and <code>#type_tag</code>, but I couldn&rsquo;t get it to work. Likewise, having to pass <code>names</code> because <code>stack_dump</code> needs it is a bit weird, but scoping.</p><p>Still, it&rsquo;s much easier to type one long <code>assert_type</code> call rather than those ~6 lines. Good times.</p><h2 id=the-proof-is-in-the-collatz-pudding>The proof is in the (Collatz) pudding?</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ./target/release/stacklang vm examples/collatz.stack
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>2 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>3 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>4 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>5 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>6 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>7 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>8 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>9 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>19</span>
</span></span><span style=display:flex><span>10 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>11 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>12 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>13 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>14 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>15 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>16 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>17 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>18 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>19 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>20 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ./target/release/stacklang compile --run examples/collatz.stack
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>2 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>3 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>4 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>5 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>6 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>7 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>8 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>9 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>19</span>
</span></span><span style=display:flex><span>10 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>11 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>12 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>13 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>14 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>15 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>16 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>17 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>18 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>19 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>20 <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>7</span>
</span></span></code></pre></div><p>That&rsquo;s so cool when something (eventually) just works(tm).</p><h2 id=cleaning-up-the-compiler-code>Cleaning up the compiler code</h2><p>While I was working here, one thing that I wanted to do was clean up the compiler code a bit.</p><p>For some reason, I&rsquo;d been factoring out the generated code into many different files. But that &mldr; doesn&rsquo;t really make sense. I&rsquo;m always including it.</p><p>So instead, I&rsquo;m now making a single <a href=https://github.com/jpverkamp/stacklang/blob/f52e0a1adb4142bc6ca3898b6ba74afc26471acb/compile_c_includes/template.c target=_blank rel=noopener>template.c file</a> with blocks that look like <code>/*{BLOCK}*/</code> that will be replaced with generated code. Much cleaner.</p><p>I did also add VSCode style <code>// #region</code> blocks to the template so that both when I&rsquo;m editing it and when I&rsquo;m looking at the generated code, I can get folding and outlines. Pretty cool.</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
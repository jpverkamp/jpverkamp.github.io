<!doctype html><html><head><title>Automated transcripts from video with Whisper(.cpp) â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.e0e68b86dea32185ab89b0b9cc01649107cc6b0be3290c8c7b13c716bc0dabfa.css integrity="sha256-4OaLht6jIYWribC5zAFkkQfMawvjKQyMexPHFrwNq/o="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Automated transcripts from video with Whisper(.cpp)</h1><div class=entry-meta><span class=entry-date>2023-03-27</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2022/02/11/go-is-faster-than-python-an-example-parsing-huge-json-logs/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a class=taxonomy-value href=/programming/topics/ai>AI</a></li><li><a href=https://blog.jverkamp.com/2023/02/10/genuary-2023.10-generative-music/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/audio>Audio</a></li><li><a class=taxonomy-value href=/programming/topics/ffmpeg>ffmpeg</a></li><li><a class=taxonomy-value href=/programming/topics/llm>LLM</a></li><li><a class=taxonomy-value href=/programming/topics/ml>ML</a></li><li><a class=taxonomy-value href=/programming/topics/openai>OpenAI</a></li><li><a href=https://blog.jverkamp.com/2023/02/14/genuary-2023.14-asemic-writing/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/text>Text</a></li><li><a class=taxonomy-value href=/programming/topics/transcription>Transcription</a></li><li><a class=taxonomy-value href=/programming/topics/video>Video</a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2023/03/26/redis-in-rust-evictions-and-implementations/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/03/27/wildcard-lets-encrypt-certificates-with-nginx-proxy-manager-and-cloudflare/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2023/03/26/redis-in-rust-evictions-and-implementations/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/03/27/wildcard-lets-encrypt-certificates-with-nginx-proxy-manager-and-cloudflare/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>I tend to be something of a digital packrat. If there&rsquo;s interesting data somewhere, I&rsquo;ll collect it <em>just in case</em> I want to do something with it.</p><p>Helpful? Usually not. But it does lead to some interesting scripts.</p><p>In this case, I have a site that hosts videos. I want to download those videos and get a text based transcription of them. With new AI tools, that shouldn&rsquo;t be hard at all. Let&rsquo;s give it a try!</p><nav id=TableOfContents><ul><li><a href=#installing-whispercpp>Installing whisper.cpp</a></li><li><a href=#setting-up-a-python-poetry-project>Setting up a Python Poetry project</a></li><li><a href=#scraping-the-page>Scraping the page</a></li></ul></nav><h2 id=installing-whispercpp>Installing whisper.cpp</h2><p>First up, <a href=https://openai.com/research/whisper>OpenAI&rsquo;s whisper</a>. It&rsquo;s a audio to text model that does exactly what I&rsquo;m looking for. Really, there are two main wrappers around the model itself:</p><ul><li><a href=https://github.com/openai/whisper>whisper</a> - the original Python version</li><li><a href=https://github.com/ggerganov/whisper.cpp>whisper.cpp</a> - a port using the same models, but in C++</li></ul><p>I&rsquo;ve used the Python version at first and it works fine. It&rsquo;s also a bit more compatible, it doesn&rsquo;t mind taking an mp3 in and will convert it behind the scenes. But I&rsquo;m primarily writing this on an M1 mac. Out of the box, whisper.cpp supports the NEON chipset and (being C++) is just generally faster.</p><p>So let&rsquo;s set that up instead, since (at least with my current setup) it&rsquo;s really not so bad:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#75715e># Checkout</span>
</span></span><span style=display:flex><span>â”Œ ^_^ jp@Mercury ~/Projects
</span></span><span style=display:flex><span>â”” git clone git@github.com:ggerganov/whisper.cpp.git
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Cloning into <span style=color:#e6db74>&#39;whisper.cpp&#39;</span>...
</span></span><span style=display:flex><span>remote: Enumerating objects: 3024, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>remote: Counting objects: 100% <span style=color:#f92672>(</span>46/46<span style=color:#f92672>)</span>, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>remote: Compressing objects: 100% <span style=color:#f92672>(</span>25/25<span style=color:#f92672>)</span>, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>remote: Total <span style=color:#ae81ff>3024</span> <span style=color:#f92672>(</span>delta 20<span style=color:#f92672>)</span>, reused <span style=color:#ae81ff>38</span> <span style=color:#f92672>(</span>delta 19<span style=color:#f92672>)</span>, pack-reused <span style=color:#ae81ff>2978</span>
</span></span><span style=display:flex><span>Receiving objects: 100% <span style=color:#f92672>(</span>3024/3024<span style=color:#f92672>)</span>, 5.10 MiB | 18.40 MiB/s, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>Resolving deltas: 100% <span style=color:#f92672>(</span>1864/1864<span style=color:#f92672>)</span>, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build and download the base English model</span>
</span></span><span style=display:flex><span>â”Œ ^_^ jp@Mercury <span style=color:#f92672>{</span>git master<span style=color:#f92672>}</span> ~/Projects/whisper.cpp
</span></span><span style=display:flex><span>â”” make base.en
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>I whisper.cpp build info:
</span></span><span style=display:flex><span>I UNAME_S:  Darwin
</span></span><span style=display:flex><span>I UNAME_P:  arm
</span></span><span style=display:flex><span>I UNAME_M:  arm64
</span></span><span style=display:flex><span>I CFLAGS:   -I.              -O3 -DNDEBUG -std<span style=color:#f92672>=</span>c11   -fPIC -pthread -DGGML_USE_ACCELERATE
</span></span><span style=display:flex><span>I CXXFLAGS: -I. -I./examples -O3 -DNDEBUG -std<span style=color:#f92672>=</span>c++11 -fPIC -pthread
</span></span><span style=display:flex><span>I LDFLAGS:   -framework Accelerate
</span></span><span style=display:flex><span>I CC:       Apple clang version 14.0.0 <span style=color:#f92672>(</span>clang-1400.0.29.202<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>I CXX:      Apple clang version 14.0.0 <span style=color:#f92672>(</span>clang-1400.0.29.202<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cc  -I.              -O3 -DNDEBUG -std<span style=color:#f92672>=</span>c11   -fPIC -pthread -DGGML_USE_ACCELERATE   -c ggml.c -o ggml.o
</span></span><span style=display:flex><span>c++ -I. -I./examples -O3 -DNDEBUG -std<span style=color:#f92672>=</span>c++11 -fPIC -pthread -c whisper.cpp -o whisper.o
</span></span><span style=display:flex><span>c++ -I. -I./examples -O3 -DNDEBUG -std<span style=color:#f92672>=</span>c++11 -fPIC -pthread examples/main/main.cpp examples/common.cpp ggml.o whisper.o -o main  -framework Accelerate
</span></span><span style=display:flex><span>./main -h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>usage: ./main <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> file0.wav file1.wav ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>options:
</span></span><span style=display:flex><span>  -h,        --help              <span style=color:#f92672>[</span>default<span style=color:#f92672>]</span> show this help message and exit
</span></span><span style=display:flex><span>  -t N,      --threads N         <span style=color:#f92672>[</span><span style=color:#ae81ff>4</span>      <span style=color:#f92672>]</span> number of threads to use during computation
</span></span><span style=display:flex><span>  -p N,      --processors N      <span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>      <span style=color:#f92672>]</span> number of processors to use during computation
</span></span><span style=display:flex><span>  -ot N,     --offset-t N        <span style=color:#f92672>[</span><span style=color:#ae81ff>0</span>      <span style=color:#f92672>]</span> time offset in milliseconds
</span></span><span style=display:flex><span>  -on N,     --offset-n N        <span style=color:#f92672>[</span><span style=color:#ae81ff>0</span>      <span style=color:#f92672>]</span> segment index offset
</span></span><span style=display:flex><span>  -d  N,     --duration N        <span style=color:#f92672>[</span><span style=color:#ae81ff>0</span>      <span style=color:#f92672>]</span> duration of audio to process in milliseconds
</span></span><span style=display:flex><span>  -mc N,     --max-context N     <span style=color:#f92672>[</span>-1     <span style=color:#f92672>]</span> maximum number of text context tokens to store
</span></span><span style=display:flex><span>  -ml N,     --max-len N         <span style=color:#f92672>[</span><span style=color:#ae81ff>0</span>      <span style=color:#f92672>]</span> maximum segment length in characters
</span></span><span style=display:flex><span>  -sow,      --split-on-word     <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> split on word rather than on token
</span></span><span style=display:flex><span>  -bo N,     --best-of N         <span style=color:#f92672>[</span><span style=color:#ae81ff>5</span>      <span style=color:#f92672>]</span> number of best candidates to keep
</span></span><span style=display:flex><span>  -bs N,     --beam-size N       <span style=color:#f92672>[</span>-1     <span style=color:#f92672>]</span> beam size <span style=color:#66d9ef>for</span> beam search
</span></span><span style=display:flex><span>  -wt N,     --word-thold N      <span style=color:#f92672>[</span>0.01   <span style=color:#f92672>]</span> word timestamp probability threshold
</span></span><span style=display:flex><span>  -et N,     --entropy-thold N   <span style=color:#f92672>[</span>2.40   <span style=color:#f92672>]</span> entropy threshold <span style=color:#66d9ef>for</span> decoder fail
</span></span><span style=display:flex><span>  -lpt N,    --logprob-thold N   <span style=color:#f92672>[</span>-1.00  <span style=color:#f92672>]</span> log probability threshold <span style=color:#66d9ef>for</span> decoder fail
</span></span><span style=display:flex><span>  -su,       --speed-up          <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> speed up audio by x2 <span style=color:#f92672>(</span>reduced accuracy<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -tr,       --translate         <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> translate from source language to english
</span></span><span style=display:flex><span>  -di,       --diarize           <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> stereo audio diarization
</span></span><span style=display:flex><span>  -nf,       --no-fallback       <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> <span style=color:#66d9ef>do</span> not use temperature fallback <span style=color:#66d9ef>while</span> decoding
</span></span><span style=display:flex><span>  -otxt,     --output-txt        <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> output result in a text file
</span></span><span style=display:flex><span>  -ovtt,     --output-vtt        <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> output result in a vtt file
</span></span><span style=display:flex><span>  -osrt,     --output-srt        <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> output result in a srt file
</span></span><span style=display:flex><span>  -owts,     --output-words      <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> output script <span style=color:#66d9ef>for</span> generating karaoke video
</span></span><span style=display:flex><span>  -fp,       --font-path         <span style=color:#f92672>[</span>/System/Library/Fonts/Supplemental/Courier New Bold.ttf<span style=color:#f92672>]</span> path to a monospace font <span style=color:#66d9ef>for</span> karaoke video
</span></span><span style=display:flex><span>  -ocsv,     --output-csv        <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> output result in a CSV file
</span></span><span style=display:flex><span>  -oj,       --output-json       <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> output result in a JSON file
</span></span><span style=display:flex><span>  -of FNAME, --output-file FNAME <span style=color:#f92672>[</span>       <span style=color:#f92672>]</span> output file path <span style=color:#f92672>(</span>without file extension<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -ps,       --print-special     <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> print special tokens
</span></span><span style=display:flex><span>  -pc,       --print-colors      <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> print colors
</span></span><span style=display:flex><span>  -pp,       --print-progress    <span style=color:#f92672>[</span>false  <span style=color:#f92672>]</span> print progress
</span></span><span style=display:flex><span>  -nt,       --no-timestamps     <span style=color:#f92672>[</span>true   <span style=color:#f92672>]</span> <span style=color:#66d9ef>do</span> not print timestamps
</span></span><span style=display:flex><span>  -l LANG,   --language LANG     <span style=color:#f92672>[</span>en     <span style=color:#f92672>]</span> spoken language <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;auto&#39;</span> <span style=color:#66d9ef>for</span> auto-detect<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             --prompt PROMPT     <span style=color:#f92672>[</span>       <span style=color:#f92672>]</span> initial prompt
</span></span><span style=display:flex><span>  -m FNAME,  --model FNAME       <span style=color:#f92672>[</span>models/ggml-base.en.bin<span style=color:#f92672>]</span> model path
</span></span><span style=display:flex><span>  -f FNAME,  --file FNAME        <span style=color:#f92672>[</span>       <span style=color:#f92672>]</span> input WAV file path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bash ./models/download-ggml-model.sh base.en
</span></span><span style=display:flex><span>Downloading ggml model base.en from <span style=color:#e6db74>&#39;https://huggingface.co/ggerganov/whisper.cpp&#39;</span> ...
</span></span><span style=display:flex><span>ggml-base.en.bin                  100%<span style=color:#f92672>[============================================================</span>&gt;<span style=color:#f92672>]</span> 141.11M   103MB/s    in 1.4s
</span></span><span style=display:flex><span>Done! Model <span style=color:#e6db74>&#39;base.en&#39;</span> saved in <span style=color:#e6db74>&#39;models/ggml-base.en.bin&#39;</span>
</span></span><span style=display:flex><span>You can now use it like this:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  $ ./main -m models/ggml-base.en.bin -f samples/jfk.wav
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>===============================================</span>
</span></span><span style=display:flex><span>Running base.en on all samples in ./samples ...
</span></span><span style=display:flex><span><span style=color:#f92672>===============================================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>----------------------------------------------
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Running base.en on samples/jfk.wav ... <span style=color:#f92672>(</span>run <span style=color:#e6db74>&#39;ffplay samples/jfk.wav&#39;</span> to listen<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>----------------------------------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>whisper_init_from_file_no_state: loading model from <span style=color:#e6db74>&#39;models/ggml-base.en.bin&#39;</span>
</span></span><span style=display:flex><span>whisper_model_load: loading model
</span></span><span style=display:flex><span>whisper_model_load: n_vocab       <span style=color:#f92672>=</span> <span style=color:#ae81ff>51864</span>
</span></span><span style=display:flex><span>whisper_model_load: n_audio_ctx   <span style=color:#f92672>=</span> <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span>whisper_model_load: n_audio_state <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>whisper_model_load: n_audio_head  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>whisper_model_load: n_audio_layer <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>whisper_model_load: n_text_ctx    <span style=color:#f92672>=</span> <span style=color:#ae81ff>448</span>
</span></span><span style=display:flex><span>whisper_model_load: n_text_state  <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>whisper_model_load: n_text_head   <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>whisper_model_load: n_text_layer  <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>whisper_model_load: n_mels        <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>whisper_model_load: f16           <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>whisper_model_load: type          <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>whisper_model_load: mem required  <span style=color:#f92672>=</span>  215.00 MB <span style=color:#f92672>(</span>+    6.00 MB per decoder<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>whisper_model_load: adding <span style=color:#ae81ff>1607</span> extra tokens
</span></span><span style=display:flex><span>whisper_model_load: model ctx     <span style=color:#f92672>=</span>  140.60 MB
</span></span><span style=display:flex><span>whisper_model_load: model size    <span style=color:#f92672>=</span>  140.54 MB
</span></span><span style=display:flex><span>whisper_init_state: kv self size  <span style=color:#f92672>=</span>    5.25 MB
</span></span><span style=display:flex><span>whisper_init_state: kv cross size <span style=color:#f92672>=</span>   17.58 MB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>system_info: n_threads <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> / <span style=color:#ae81ff>8</span> | AVX <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> | AVX2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> | AVX512 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> | FMA <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> | NEON <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> | ARM_FMA <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> | F16C <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> | FP16_VA <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> | WASM_SIMD <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> | BLAS <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> | SSE3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> | VSX <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> |
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main: processing <span style=color:#e6db74>&#39;samples/jfk.wav&#39;</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>176000</span> samples, 11.0 sec<span style=color:#f92672>)</span>, <span style=color:#ae81ff>4</span> threads, <span style=color:#ae81ff>1</span> processors, lang <span style=color:#f92672>=</span> en, task <span style=color:#f92672>=</span> transcribe, timestamps <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>00:00:00.000 --&gt; 00:00:11.000<span style=color:#f92672>]</span>   And so my fellow Americans, ask not what your country can <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>for</span> you, ask what you can <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>for</span> your country.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>whisper_print_timings:     load time <span style=color:#f92672>=</span>   117.99 ms
</span></span><span style=display:flex><span>whisper_print_timings:     fallbacks <span style=color:#f92672>=</span>   <span style=color:#ae81ff>0</span> p /   <span style=color:#ae81ff>0</span> h
</span></span><span style=display:flex><span>whisper_print_timings:      mel time <span style=color:#f92672>=</span>    20.57 ms
</span></span><span style=display:flex><span>whisper_print_timings:   sample time <span style=color:#f92672>=</span>    11.74 ms /    <span style=color:#ae81ff>27</span> runs <span style=color:#f92672>(</span>    0.43 ms per run<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>whisper_print_timings:   encode time <span style=color:#f92672>=</span>   304.17 ms /     <span style=color:#ae81ff>1</span> runs <span style=color:#f92672>(</span>  304.17 ms per run<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>whisper_print_timings:   decode time <span style=color:#f92672>=</span>    72.67 ms /    <span style=color:#ae81ff>27</span> runs <span style=color:#f92672>(</span>    2.69 ms per run<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>whisper_print_timings:    total time <span style=color:#f92672>=</span>   544.48 ms
</span></span></code></pre></div><p>And that&rsquo;s really it.</p><h2 id=setting-up-a-python-poetry-project>Setting up a Python Poetry project</h2><p>Next up, setting up a quick Python script. I&rsquo;ve recently gotten a bit annoyed at requirements.txt files (not having a nice CLI and not locking versions by default) and am trying out <a href=https://python-poetry.org/>Poetry</a>.</p><p>It&rsquo;s really quite easy as well:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#75715e># Set up a new directory for the project</span>
</span></span><span style=display:flex><span>â”Œ ^_^ jp@Mercury ~/Projects
</span></span><span style=display:flex><span>â”” mkdir transcript-scraper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>â”Œ ^_^ jp@Mercury ~/Projects
</span></span><span style=display:flex><span>â”” cd transcript-scraper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Initialize poetry, just use the defaults</span>
</span></span><span style=display:flex><span>â”Œ ^_^ jp@Mercury ~/Projects/transcript-scraper
</span></span><span style=display:flex><span>â”” poetry init -q
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install the libraries I&#39;m going to use</span>
</span></span><span style=display:flex><span>â”Œ ^_^ jp@Mercury ~/Projects/transcript-scraper
</span></span><span style=display:flex><span>â”” poetry add bs4 requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Creating virtualenv transcript-scraper-WqErZKPo-py3.10 in /Users/jp/Library/Caches/pypoetry/virtualenvs
</span></span><span style=display:flex><span>Using version ^0.0.1 <span style=color:#66d9ef>for</span> bs4
</span></span><span style=display:flex><span>Using version ^2.28.2 <span style=color:#66d9ef>for</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Updating dependencies
</span></span><span style=display:flex><span>Resolving dependencies... <span style=color:#f92672>(</span>0.2s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Writing lock file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Package operations: <span style=color:#ae81ff>8</span> installs, <span style=color:#ae81ff>0</span> updates, <span style=color:#ae81ff>0</span> removals
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  â€¢ Installing soupsieve <span style=color:#f92672>(</span>2.4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  â€¢ Installing beautifulsoup4 <span style=color:#f92672>(</span>4.12.0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  â€¢ Installing certifi <span style=color:#f92672>(</span>2022.12.7<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  â€¢ Installing charset-normalizer <span style=color:#f92672>(</span>3.1.0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  â€¢ Installing idna <span style=color:#f92672>(</span>3.4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  â€¢ Installing urllib3 <span style=color:#f92672>(</span>1.26.15<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  â€¢ Installing bs4 <span style=color:#f92672>(</span>0.0.1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  â€¢ Installing requests <span style=color:#f92672>(</span>2.28.2<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Et voila.</p><h2 id=scraping-the-page>Scraping the page</h2><p>Finally, the script itself. I did use Github Copilot to help accelerate some of this, but it got a bit more wrong than last time I tried it out. YMMV.</p><p>Our goals:</p><ul><li>Download the page</li><li>For each video:<ul><li>Extract date and title from this specific format</li><li>Generate the filenames we&rsquo;ll be using</li><li>Check if we&rsquo;ve already generate the text file, if so skip</li><li>Otherwise:<ul><li>Use <code>requests</code> with <code>stream=True</code> to download the mp4</li><li>Use <code>ffmpeg</code> to extract the audio as mp3 (this could be combined with the next step, but I wanted to keep the mp3 + text)</li><li>Use <code>ffmpeg</code> to convert to the mp3 to wav (whisper needs this; this is where Copilot failed, it didn&rsquo;t add the extra parameters to <em>actually</em> convert to a wav)</li><li>Use <code>whisper</code> to extract the text</li><li>Clean up the <code>mp4</code> and <code>wav</code>, keeping only the <code>mp3</code> and <code>txt</code> files</li></ul></li></ul></li></ul><p>Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> bs4
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> urllib.parse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Scraping&#39;</span>, url)
</span></span><span style=display:flex><span>response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url)
</span></span><span style=display:flex><span>soup <span style=color:#f92672>=</span> bs4<span style=color:#f92672>.</span>BeautifulSoup(response<span style=color:#f92672>.</span>text, <span style=color:#e6db74>&#39;html.parser&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> article <span style=color:#f92672>in</span> soup<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#39;article&#39;</span>):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Extract metadata</span>
</span></span><span style=display:flex><span>    time <span style=color:#f92672>=</span> article<span style=color:#f92672>.</span>select_one(<span style=color:#e6db74>&#39;.time&#39;</span>)<span style=color:#f92672>.</span>text<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>    title <span style=color:#f92672>=</span> article<span style=color:#f92672>.</span>select_one(<span style=color:#e6db74>&#39;h4 a&#39;</span>)<span style=color:#f92672>.</span>text<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>    href <span style=color:#f92672>=</span> article<span style=color:#f92672>.</span>select_one(<span style=color:#e6db74>&#39;.media a&#39;</span>)<span style=color:#f92672>.</span>attrs[<span style=color:#e6db74>&#39;href&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Convert date like Mar 05, 2023 to datetime</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Copilot just wrote this line for me; how cool is that? </span>
</span></span><span style=display:flex><span>    date <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>strptime(time, <span style=color:#e6db74>&#39;%b </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>, %Y&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Generate filename</span>
</span></span><span style=display:flex><span>    working_path <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;data/</span><span style=color:#e6db74>{</span>date<span style=color:#e6db74>:</span><span style=color:#e6db74>%Y</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>date<span style=color:#e6db74>:</span><span style=color:#e6db74>%m</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/&#39;</span>
</span></span><span style=display:flex><span>    output_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;output&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    filename <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>date<span style=color:#e6db74>:</span><span style=color:#e6db74>%Y-%m-%d</span><span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>title<span style=color:#e6db74>}}</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    print(filename)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>makedirs(working_path, exist_ok<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>makedirs(output_path, exist_ok<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mp4_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(working_path, filename <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.mp4&#39;</span>)
</span></span><span style=display:flex><span>    mp3_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(working_path, filename <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.mp3&#39;</span>)
</span></span><span style=display:flex><span>    wav_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(working_path, filename <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.wav&#39;</span>)
</span></span><span style=display:flex><span>    txt_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(output_path, filename <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.txt&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Skip if text already exists</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(txt_filename):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Download href video</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(mp4_filename):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;- Downloading&#39;</span>, mp4_filename)
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(href, stream<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> open(filename <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.mp4&#39;</span>, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> chunk <span style=color:#f92672>in</span> response<span style=color:#f92672>.</span>iter_content(chunk_size<span style=color:#f92672>=</span><span style=color:#ae81ff>1024</span>):
</span></span><span style=display:flex><span>                f<span style=color:#f92672>.</span>write(chunk)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Convert to mp3 with ffmpeg</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(mp3_filename):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;- Converting&#39;</span>, mp3_filename)
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;ffmpeg -i &#34;</span><span style=color:#e6db74>{</span>mp4_filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34; &#34;</span><span style=color:#e6db74>{</span>mp3_filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Covert to wav with ffmpeg</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(wav_filename):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;- Converting&#39;</span>, wav_filename)
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;ffmpeg -i &#34;</span><span style=color:#e6db74>{</span>mp3_filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34; -acodec pcm_s16le -ac 1 -ar 16000 &#34;</span><span style=color:#e6db74>{</span>wav_filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Extract text with whisper</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(txt_filename):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;- Extracting text&#39;</span>, txt_filename)
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;~/Projects/whisper.cpp/main -m ~/Projects/whisper.cpp/models/ggml-base.en.bin -f &#34;./</span><span style=color:#e6db74>{</span>wav_filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34; --output-txt&#39;</span>)
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>rename(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>wav_filename<span style=color:#e6db74>}</span><span style=color:#e6db74>.txt&#39;</span>, txt_filename)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Once we have the text, we no longer need to keep the video or wav</span>
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>remove(mp4_filename)
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>remove(wav_filename)
</span></span></code></pre></div><p>So I&rsquo;m doing a few ugly things.</p><p>For example, a lot of <code>os.system</code> calls instead of <code>subprocess.check_call</code> / <code>subprocess.check_output</code>. If there are any quotes in the filenames, I&rsquo;ve opened myself right up for a command injection attack.</p><p>And then there&rsquo;s the super ugly whisper command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/Projects/whisper.cpp/main 
</span></span><span style=display:flex><span>    -m ~/Projects/whisper.cpp/models/ggml-base.en.bin
</span></span><span style=display:flex><span>    -f &#34;./{wav_filename}&#34;
</span></span><span style=display:flex><span>    --output-txt
</span></span></code></pre></div><p>Having to specify the executable&rsquo;s full path made sense, I didn&rsquo;t put it on my Path. I&rsquo;ll probably fix that at some point, but not right now.</p><p>But having to specify the full path to the model (rather than whisper knowing to check relative to first my working directory and then it&rsquo;s own directory) is a bit annoying. And if you don&rsquo;t have the <code>./</code> prefix on the file path, who knows where it&rsquo;s going to run from&mldr;</p><p>But other than that, worked great. 10 minutes of transcription in a few seconds.</p><p>And that&rsquo;s it. Something I&rsquo;ll fire set up as a cronjob and just leave running until I decide to try to do something more with it. ðŸ˜„</p><p>Onward!</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
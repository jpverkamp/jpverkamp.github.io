<!doctype html><html><head><title>AoC 2023 Day 24: Collisionator â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>AoC 2023 Day 24: Collisionator</h1><div class=entry-meta><span class=entry-date>2023-12-24</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/12/23/aoc-2023-day-23-looong-mazinator/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/rust>Rust</a><a href=https://blog.jverkamp.com/2023/12/25/aoc-2023-day-25-graph-splitinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/12/23/aoc-2023-day-23-looong-mazinator/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/advent-of-code>Advent of Code</a><a href=https://blog.jverkamp.com/2023/12/25/aoc-2023-day-25-graph-splitinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/12/23/aoc-2023-day-23-looong-mazinator/ class=previous-link></a><a class=taxonomy-value href=/series/advent-of-code-2023>Advent of Code 2023</a><a href=https://blog.jverkamp.com/2023/12/25/aoc-2023-day-25-graph-splitinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2023/12/23/aoc-2023-day-23-looong-mazinator/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/12/25/aoc-2023-day-25-graph-splitinator/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2023/12/23/aoc-2023-day-23-looong-mazinator/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/12/25/aoc-2023-day-25-graph-splitinator/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><h2 id=source-day-24-never-tell-me-the-oddshttpsadventofcodecom2023day24>Source: <a href=https://adventofcode.com/2023/day/24 target=_blank rel=noopener>Day 24: Never Tell Me The Odds</a></h2><p><a href=https://github.com/jpverkamp/advent-of-code/tree/master/2023/solutions/day24 target=_blank rel=noopener>Full solution</a> for today (spoilers!)</p><nav id=TableOfContents><ul><li><a href=#source-day-24-never-tell-me-the-oddshttpsadventofcodecom2023day24>Source: <a href=https://adventofcode.com/2023/day/24>Day 24: Never Tell Me The Odds</a></a></li><li><a href=#part-1>Part 1</a><ul><li><a href=#parsing-and-types>Parsing and Types</a></li><li><a href=#xy-intersections>XY Intersections</a></li><li><a href=#solution>Solution</a></li></ul></li><li><a href=#part-2>Part 2</a><ul><li><a href=#solution-1-brute-force>Solution 1: Brute Force</a></li><li><a href=#solution-2-using-z3>Solution 2: Using Z3</a></li></ul></li><li><a href=#performance>Performance</a></li></ul></nav><h2 id=part-1>Part 1</h2><blockquote><p>Given a set of 3D vectors (origin + velocity), count how many times the vectors would intersect. Ignore the Z-coordinate for this part; the collisions do not have to be at the same time.</p></blockquote><h3 id=parsing-and-types>Parsing and Types</h3><p>We don&rsquo;t have a <code>Point3</code>, so we&rsquo;ll make one:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, Copy, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Point</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> x: <span style=color:#66d9ef>f64</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> y: <span style=color:#66d9ef>f64</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> z: <span style=color:#66d9ef>f64</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Add<span style=color:#f92672>&lt;</span>Point<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> Point {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Output</span> <span style=color:#f92672>=</span> Point;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>add</span>(self, rhs: <span style=color:#a6e22e>Point</span>) -&gt; <span style=color:#a6e22e>Self</span>::Output {
</span></span><span style=display:flex><span>        Point {
</span></span><span style=display:flex><span>            x: <span style=color:#a6e22e>self</span>.x <span style=color:#f92672>+</span> rhs.x,
</span></span><span style=display:flex><span>            y: <span style=color:#a6e22e>self</span>.y <span style=color:#f92672>+</span> rhs.y,
</span></span><span style=display:flex><span>            z: <span style=color:#a6e22e>self</span>.z <span style=color:#f92672>+</span> rhs.z,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, Copy, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Line</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> origin: <span style=color:#a6e22e>Point</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> direction: <span style=color:#a6e22e>Point</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m using floating point since the collisions for this part don&rsquo;t have to be integer values. I may <a href=#part-2>regret that</a>.</p><p>And <code>nom</code> it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>point</span>(input: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>IResult</span><span style=color:#f92672>&lt;&amp;</span><span style=color:#66d9ef>str</span>, Point<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    map(
</span></span><span style=display:flex><span>        tuple((
</span></span><span style=display:flex><span>            complete::<span style=color:#66d9ef>i128</span>,
</span></span><span style=display:flex><span>            preceded(terminated(complete::<span style=color:#66d9ef>char</span>(<span style=color:#e6db74>&#39;,&#39;</span>), space0), complete::<span style=color:#66d9ef>i128</span>),
</span></span><span style=display:flex><span>            preceded(terminated(complete::<span style=color:#66d9ef>char</span>(<span style=color:#e6db74>&#39;,&#39;</span>), space0), complete::<span style=color:#66d9ef>i128</span>),
</span></span><span style=display:flex><span>        )),
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span>(x, y, z)<span style=color:#f92672>|</span> Point {
</span></span><span style=display:flex><span>            x: <span style=color:#a6e22e>x</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>,
</span></span><span style=display:flex><span>            y: <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>,
</span></span><span style=display:flex><span>            z: <span style=color:#a6e22e>z</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    )(input)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>line</span>(input: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>IResult</span><span style=color:#f92672>&lt;&amp;</span><span style=color:#66d9ef>str</span>, Line<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    map(
</span></span><span style=display:flex><span>        tuple((point, delimited(space0, complete::<span style=color:#66d9ef>char</span>(<span style=color:#e6db74>&#39;@&#39;</span>), space0), point)),
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span>(origin, _, direction)<span style=color:#f92672>|</span> Line { origin, direction },
</span></span><span style=display:flex><span>    )(input)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>lines</span>(input: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>IResult</span><span style=color:#f92672>&lt;&amp;</span><span style=color:#66d9ef>str</span>, Vec<span style=color:#f92672>&lt;</span>Line<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>    separated_list1(line_ending, line)(input)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=xy-intersections>XY Intersections</h3><p>This problem is <em>loaded</em> with algebra&mldr; I probably should have remembered how to do matrix/vector math, but so it goes.</p><p>Here&rsquo;s the derivation. Times are $t$ and $t&rsquo;$, positions are $x, y$ and velocities are $u, v$.</p><p>First solve for $t$ using $x$:</p><p>$$
\text{} \newline
x_1 + t u_1 = x_2 + t&rsquo; u_2 \newline
t u_1 = x_2 + t&rsquo; u_2 - x_1 \newline
t = (x_2 + t&rsquo; u_2 - x_1) / u_1 \newline
$$</p><p>Then $y$:</p><p>$$
y_1 + t v_1 = y_2 + t&rsquo; v_2 \newline
t v_1 = y_2 + t&rsquo; v_2 - y_1
t = (y_2 + t&rsquo; * v_2 - y_1) / v_1
$$</p><p>Set equal and solve for $t&rsquo;$:</p><p>$$
(x_2 + t&rsquo; u_2 - x_1) / u_1 = (y_2 + t&rsquo; v_2 - y_1) / v_1 \newline
(x_2 + t&rsquo; u_2 - x_1) v_1 = (y_2 + t&rsquo; v_2 - y_1) u_1 \newline
x_2 v_1 + t&rsquo; u_2 v_1 - x_1 v_1 = y_2 u_1 + t&rsquo; v_2 u_1 - y_1 u_1 \newline
t&rsquo; u_2 v_1 - t&rsquo; v_2 u_1 = y_2 u_1 - x_2 v_1 - y_1 u_1 + x_1 v_1 \newline
t&rsquo; (u_2 v_1 - v_2 u_1) = y_2 u_1 - x_2 v_1 - y_1 u_1 + x_1 v_1 \newline
t&rsquo; = (y_2 u_1 - x_2 v_1 - y_1 u_1 + x_1 v_1) / (u_2 v_1 - v_2 u_1)
$$</p><p>And here&rsquo;s that in code (using <code>dx, dy</code> as $u, v$):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>intersect_xy</span>(l1: <span style=color:#a6e22e>Line</span>, l2: <span style=color:#a6e22e>Line</span>) -&gt; Option<span style=color:#f92672>&lt;</span>Point<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> Point {
</span></span><span style=display:flex><span>        x: <span style=color:#a6e22e>x1</span>,
</span></span><span style=display:flex><span>        y: <span style=color:#a6e22e>y1</span>,
</span></span><span style=display:flex><span>        z: <span style=color:#a6e22e>_z1</span>,
</span></span><span style=display:flex><span>    } <span style=color:#f92672>=</span> l1.origin;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> Point {
</span></span><span style=display:flex><span>        x: <span style=color:#a6e22e>x2</span>,
</span></span><span style=display:flex><span>        y: <span style=color:#a6e22e>y2</span>,
</span></span><span style=display:flex><span>        z: <span style=color:#a6e22e>_z2</span>,
</span></span><span style=display:flex><span>    } <span style=color:#f92672>=</span> l2.origin;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> Point {
</span></span><span style=display:flex><span>        x: <span style=color:#a6e22e>dx1</span>,
</span></span><span style=display:flex><span>        y: <span style=color:#a6e22e>dy1</span>,
</span></span><span style=display:flex><span>        z: <span style=color:#a6e22e>_dz1</span>,
</span></span><span style=display:flex><span>    } <span style=color:#f92672>=</span> l1.direction;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> Point {
</span></span><span style=display:flex><span>        x: <span style=color:#a6e22e>dx2</span>,
</span></span><span style=display:flex><span>        y: <span style=color:#a6e22e>dy2</span>,
</span></span><span style=display:flex><span>        z: <span style=color:#a6e22e>_dz2</span>,
</span></span><span style=display:flex><span>    } <span style=color:#f92672>=</span> l2.direction;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If the denominator is (close enough to) zero, they never intersect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (dx2 <span style=color:#f92672>*</span> dy1 <span style=color:#f92672>-</span> dy2 <span style=color:#f92672>*</span> dx1).abs() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0.0000001_</span><span style=color:#66d9ef>f64</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> None;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> u <span style=color:#f92672>=</span> (y2 <span style=color:#f92672>*</span> dx1 <span style=color:#f92672>-</span> x2 <span style=color:#f92672>*</span> dy1 <span style=color:#f92672>-</span> y1 <span style=color:#f92672>*</span> dx1 <span style=color:#f92672>+</span> x1 <span style=color:#f92672>*</span> dy1) <span style=color:#f92672>/</span> (dx2 <span style=color:#f92672>*</span> dy1 <span style=color:#f92672>-</span> dy2 <span style=color:#f92672>*</span> dx1);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> t <span style=color:#f92672>=</span> (x2 <span style=color:#f92672>+</span> u <span style=color:#f92672>*</span> dx2 <span style=color:#f92672>-</span> x1) <span style=color:#f92672>/</span> dx1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Edge case: they intersect at time zero (we&#39;re told this shouldn&#39;t happen)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> u <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0_</span><span style=color:#66d9ef>f64</span> <span style=color:#f92672>||</span> t <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0_</span><span style=color:#66d9ef>f64</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> None;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> x <span style=color:#f92672>=</span> x1 <span style=color:#f92672>+</span> t <span style=color:#f92672>*</span> dx1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> y <span style=color:#f92672>=</span> y1 <span style=color:#f92672>+</span> t <span style=color:#f92672>*</span> dy1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Some(Point { x, y, z: <span style=color:#ae81ff>0_</span><span style=color:#66d9ef>f64</span> })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=solution>Solution</h3><p>And with that we can just count them!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stdin <span style=color:#f92672>=</span> io::stdin();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> input <span style=color:#f92672>=</span> io::read_to_string(stdin.lock())<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (s, lines) <span style=color:#f92672>=</span> parse::lines(input.as_str()).unwrap();
</span></span><span style=display:flex><span>    assert!(s.trim().is_empty());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result <span style=color:#f92672>=</span> lines
</span></span><span style=display:flex><span>        .iter()
</span></span><span style=display:flex><span>        .cartesian_product(lines.iter())
</span></span><span style=display:flex><span>        .filter_map(<span style=color:#f92672>|</span>(l1, l2)<span style=color:#f92672>|</span> intersect_xy(<span style=color:#f92672>*</span>l1, <span style=color:#f92672>*</span>l2))
</span></span><span style=display:flex><span>        .filter(<span style=color:#f92672>|</span>p<span style=color:#f92672>|</span> p.x <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>MIN_X</span> <span style=color:#f92672>&amp;&amp;</span> p.x <span style=color:#f92672>&lt;=</span> <span style=color:#66d9ef>MAX_X</span> <span style=color:#f92672>&amp;&amp;</span> p.y <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>MIN_Y</span> <span style=color:#f92672>&amp;&amp;</span> p.y <span style=color:#f92672>&lt;=</span> <span style=color:#66d9ef>MAX_Y</span>)
</span></span><span style=display:flex><span>        .count()
</span></span><span style=display:flex><span>        <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>; <span style=color:#75715e>// counts l1,l2 and l2,l1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{result:?}</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We are a bit inefficient, since we count both times for each pair of lines, but it&rsquo;s fast enough not to worry about that.</p><h2 id=part-2>Part 2</h2><blockquote><p>Find a new vector with integer position and velocity such that it hits every given vector at some future point.</p></blockquote><p>This time&mldr; it&rsquo;s not enough to just intersect the lines, we also have to deal with time!</p><h3 id=solution-1-brute-force>Solution 1: Brute Force</h3><p>Man this one took some math. I&rsquo;m just going to leave my derivations in source code comments rather than reformatting for LaTeX this time. But the general idea is this:</p><ul><li>Iterate all possible velocities out from <code>(0, 0, 0)</code> in a sort of spiraling motion</li><li>For each velocity <code>v</code>:<ul><li>Take each pair of lines <code>l1</code> and <code>l2</code><ul><li>Calculate if it&rsquo;s possible that if our solution point started at <code>l1</code> at <code>t1</code>, would it make it to <code>l2</code> at <code>t2</code> with the velocity <code>v</code> (note: <code>l1</code> moves until <code>t1</code> and <code>l2</code> moves until <code>t2</code>)</li><li>Much like before, we can use piles of algebra to determine what <code>t1</code> (using only <code>x</code> and <code>y</code> coordinates) would be and then substitute that into <code>t2</code>, call this <code>t2xy</code></li><li>Repeat this for <code>t2xz</code> and <code>t2yz</code></li><li>If all of these time values are equal (and non-zero), we have a potential velocity!</li></ul></li></ul></li><li>For each potential velocity <code>v</code>:<ul><li>Try to calculate an origin point <code>p</code> much the same way<ul><li>Use just two of the lines <code>l1</code> and <code>l2</code></li><li>Use these to calculate <code>t1xy</code>, <code>t1xz</code>, and <code>t1yz</code> again, this time referring to the &lsquo;real&rsquo; <code>t1</code> associated with the intersection with <code>l1</code><ul><li>If any of the values don&rsquo;t match, if they are negative, or if they are <em>non integers</em> this isn&rsquo;t a valid solution</li></ul></li><li>Use this to work backwards to what point <code>p</code> would be, again, these values have to be <em>integers</em></li></ul></li></ul></li></ul><p>Once we&rsquo;ve found a value, bam! We&rsquo;re done.</p><p>Turn that into a lot of code (and as many comments):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    env_logger::init();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stdin <span style=color:#f92672>=</span> io::stdin();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> input <span style=color:#f92672>=</span> io::read_to_string(stdin.lock())<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (s, lines) <span style=color:#f92672>=</span> parse::lines(input.as_str()).unwrap();
</span></span><span style=display:flex><span>    assert!(s.trim().is_empty());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[allow(unused_assignments)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> velocity <span style=color:#f92672>=</span> None;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> position <span style=color:#f92672>=</span> None;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>&#39;found_solution</span>: <span style=color:#a6e22e>for</span> bound <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0_</span><span style=color:#66d9ef>i64</span><span style=color:#f92672>..</span> {
</span></span><span style=display:flex><span>        log::info!(<span style=color:#e6db74>&#34;bound: {}&#34;</span>, bound);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> vx <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>..=</span>bound {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> vy <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>..=</span>(bound <span style=color:#f92672>-</span> vx) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> vz <span style=color:#f92672>=</span> bound <span style=color:#f92672>-</span> vx <span style=color:#f92672>-</span> vy;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (xd, yd, zd) <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>INVERSIONS</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> vx <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> xd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> vy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> yd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> vz <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> zd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>let</span> xd <span style=color:#f92672>=</span> vx <span style=color:#f92672>*</span> xd;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>let</span> yd <span style=color:#f92672>=</span> vy <span style=color:#f92672>*</span> yd;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>let</span> zd <span style=color:#f92672>=</span> vz <span style=color:#f92672>*</span> zd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// for any two lines l1 and l2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// we want to be at l1 at t2 and at l2 at t2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// the time between is t2 - t1 = td
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// we do not know x0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// x0 + xd * t1 = l1.o.x + l1.d.x * t1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// x0 + xd * t2 = l2.o.x + l2.d.x * t2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// l1.o.x + l1.d.x * t1 - xd * t1 = l2.o.x + l2.d.x * t2 - xd * t2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// currently t1 and t2 are unknown
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// l1.d.x * t1 - xd * t1 = l2.o.x + l2.d.x * t2 - xd * t2 - l1.o.x
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// t1 * (l1.d.x - xd) = l2.o.x + l2.d.x * t2 - xd * t2 - l1.o.x
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// t1 = (l2.o.x + l2.d.x * t2 - xd * t2 - l1.o.x) / (l1.d.x - xd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// t1 = (l2.o.y + l2.d.y * t2 - yd * t2 - l1.o.y) / (l1.d.y - yd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// (l2.o.x + l2.d.x * t2 - xd * t2 - l1.o.x) / (l1.d.x - xd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>//      = (l2.o.y + l2.d.y * t2 - yd * t2 - l1.o.y) / (l1.d.y - yd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// (l2.o.x + l2.d.x * t2 - xd * t2 - l1.o.x) * (l1.d.y - yd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>//      = (l2.o.y + l2.d.y * t2 - yd * t2 - l1.o.y) * (l1.d.x - xd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// let A = l2.o.x - l1.o.x
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// let B = l1.d.y - yd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// let C = l2.o.y - l1.o.y
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// let D = l1.d.x - xd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// (A + l2.d.x * t2 - xd * t2) * B = (C + l2.d.y * t2 - yd * t2) * D
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// AB + B l2.d.x t2 - B xd t2 = CD + D l2.d.y t2 - D yd t2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// B l2.d.x t2 - B xd t2 - D l2.d.y t2 + D yd t2 = CD - AB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// t2 = (CD - AB) / (B l2.d.x - B xd - D l2.d.y + D yd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// To have a potential velocity some one line must be able to get to all of the other lines
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>let</span> valid <span style=color:#f92672>=</span> lines.iter().any(<span style=color:#f92672>|</span>l1<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>                        lines.iter().filter(<span style=color:#66d9ef>move</span> <span style=color:#f92672>|</span>l2<span style=color:#f92672>|</span> l1 <span style=color:#f92672>!=</span> <span style=color:#f92672>*</span>l2).all(<span style=color:#f92672>|</span>l2<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> axy <span style=color:#f92672>=</span> l2.origin.x <span style=color:#f92672>-</span> l1.origin.x;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> bxy <span style=color:#f92672>=</span> l1.direction.y <span style=color:#f92672>-</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> cxy <span style=color:#f92672>=</span> l2.origin.y <span style=color:#f92672>-</span> l1.origin.y;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> dxy <span style=color:#f92672>=</span> l1.direction.x <span style=color:#f92672>-</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> t2xy <span style=color:#f92672>=</span> (cxy <span style=color:#f92672>*</span> dxy <span style=color:#f92672>-</span> axy <span style=color:#f92672>*</span> bxy)
</span></span><span style=display:flex><span>                                <span style=color:#f92672>/</span> (bxy <span style=color:#f92672>*</span> l2.direction.x <span style=color:#f92672>-</span> bxy <span style=color:#f92672>*</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>-</span> dxy <span style=color:#f92672>*</span> l2.direction.y
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>+</span> dxy <span style=color:#f92672>*</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (t2xy <span style=color:#f92672>-</span> t2xy.round()).abs() <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>EPSILON</span> {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> t2xy <span style=color:#f92672>=</span> t2xy.round() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i32</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> axz <span style=color:#f92672>=</span> l2.origin.x <span style=color:#f92672>-</span> l1.origin.x;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> bxz <span style=color:#f92672>=</span> l1.direction.z <span style=color:#f92672>-</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> cxz <span style=color:#f92672>=</span> l2.origin.z <span style=color:#f92672>-</span> l1.origin.z;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> dxz <span style=color:#f92672>=</span> l1.direction.x <span style=color:#f92672>-</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> t2xz <span style=color:#f92672>=</span> (cxz <span style=color:#f92672>*</span> dxz <span style=color:#f92672>-</span> axz <span style=color:#f92672>*</span> bxz)
</span></span><span style=display:flex><span>                                <span style=color:#f92672>/</span> (bxz <span style=color:#f92672>*</span> l2.direction.x <span style=color:#f92672>-</span> bxz <span style=color:#f92672>*</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>-</span> dxz <span style=color:#f92672>*</span> l2.direction.z
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>+</span> dxz <span style=color:#f92672>*</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (t2xz <span style=color:#f92672>-</span> t2xz.round()).abs() <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>EPSILON</span> {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> t2xz <span style=color:#f92672>=</span> t2xz.round() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i32</span>;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> t2xy <span style=color:#f92672>!=</span> t2xz {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> ayz <span style=color:#f92672>=</span> l2.origin.y <span style=color:#f92672>-</span> l1.origin.y;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> byz <span style=color:#f92672>=</span> l1.direction.z <span style=color:#f92672>-</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> cyz <span style=color:#f92672>=</span> l2.origin.z <span style=color:#f92672>-</span> l1.origin.z;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> dyz <span style=color:#f92672>=</span> l1.direction.y <span style=color:#f92672>-</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> t2yz <span style=color:#f92672>=</span> (cyz <span style=color:#f92672>*</span> dyz <span style=color:#f92672>-</span> ayz <span style=color:#f92672>*</span> byz)
</span></span><span style=display:flex><span>                                <span style=color:#f92672>/</span> (byz <span style=color:#f92672>*</span> l2.direction.y <span style=color:#f92672>-</span> byz <span style=color:#f92672>*</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>-</span> dyz <span style=color:#f92672>*</span> l2.direction.z
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>+</span> dyz <span style=color:#f92672>*</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (t2yz <span style=color:#f92672>-</span> t2yz.round()).abs() <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>EPSILON</span> {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>let</span> t2yz <span style=color:#f92672>=</span> t2yz.round() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i32</span>;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> t2xy <span style=color:#f92672>!=</span> t2yz {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>                        })
</span></span><span style=display:flex><span>                    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> valid {
</span></span><span style=display:flex><span>                        velocity <span style=color:#f92672>=</span> Some((xd, yd, zd));
</span></span><span style=display:flex><span>                        log::info!(<span style=color:#e6db74>&#34;found potential velocity: {:?}&#34;</span>, velocity);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// at t = 0 we&#39;re at x0, t0 is l[0], t1 is l[1]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// x0 + xd * t0 = l[0].o.x + l[0].d.x * t0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// x0 + xd * t1 = l[1].o.x + l[1].d.x * t1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// l0ox + l0dx * t0 - xd * t0 = l1ox + l1dx * t1 - xd * t1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// t0 = (l1ox + l1dx * t1 - xd * t1 - l0ox) / (l0dx - xd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// t0 = (l1oy + l1dy * t1 - yd * t1 - l0oy) / (l0dy - yd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// (l1ox + l1dx * t1 - xd * t1 - l0ox) / (l0dx - xd) = (l1oy + l1dy * t1 - yd * t1 - l0oy) / (l0dy - yd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// (l1ox + l1dx * t1 - xd * t1 - l0ox) * (l0dy - yd) = (l1oy + l1dy * t1 - yd * t1 - l0oy) * (l0dx - xd)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// let A = l0dy - yd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// let B = 10dx - xd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// (l1ox + l1dx * t1 - xd * t1 - l0ox) * A = (l1oy + l1dy * t1 - yd * t1 - l0oy) * B
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// l1ox * A + l1dx * t1 * A - xd * t1 * A - l0ox * A = l1oy * B + l1dy * t1 * B - yd * t1 * B - l0oy * B
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// l1dx * t1 * A - xd * t1 * A - l1dy * t1 * B + yd * t1 * B = l1oy * B - l1ox * A - l0oy * B + l0ox * A
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// t1 * (l1dx * A - xd * A - l1dy * B + yd * B) = l1oy * B - l1ox * A - l0oy * B + l0ox * A
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// t1 = (l1oy * B - l1ox * A - l0oy * B + l0ox * A) / (l1dx * A - xd * A - l1dy * B + yd * B)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> axy <span style=color:#f92672>=</span> lines[<span style=color:#ae81ff>0</span>].direction.y <span style=color:#f92672>-</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> bxy <span style=color:#f92672>=</span> lines[<span style=color:#ae81ff>0</span>].direction.x <span style=color:#f92672>-</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> t1xy <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>(lines[<span style=color:#ae81ff>1</span>].origin.y <span style=color:#f92672>*</span> bxy
</span></span><span style=display:flex><span>                            <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>1</span>].origin.x <span style=color:#f92672>*</span> axy
</span></span><span style=display:flex><span>                            <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>0</span>].origin.y <span style=color:#f92672>*</span> bxy
</span></span><span style=display:flex><span>                            <span style=color:#f92672>+</span> lines[<span style=color:#ae81ff>0</span>].origin.x <span style=color:#f92672>*</span> axy)
</span></span><span style=display:flex><span>                            <span style=color:#f92672>/</span> (lines[<span style=color:#ae81ff>1</span>].direction.y <span style=color:#f92672>*</span> bxy
</span></span><span style=display:flex><span>                                <span style=color:#f92672>-</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> bxy
</span></span><span style=display:flex><span>                                <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>1</span>].direction.x <span style=color:#f92672>*</span> axy
</span></span><span style=display:flex><span>                                <span style=color:#f92672>+</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> axy);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> axz <span style=color:#f92672>=</span> lines[<span style=color:#ae81ff>0</span>].direction.z <span style=color:#f92672>-</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> bxz <span style=color:#f92672>=</span> lines[<span style=color:#ae81ff>0</span>].direction.x <span style=color:#f92672>-</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> t1xz <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>(lines[<span style=color:#ae81ff>1</span>].origin.z <span style=color:#f92672>*</span> bxz
</span></span><span style=display:flex><span>                            <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>1</span>].origin.x <span style=color:#f92672>*</span> axz
</span></span><span style=display:flex><span>                            <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>0</span>].origin.z <span style=color:#f92672>*</span> bxz
</span></span><span style=display:flex><span>                            <span style=color:#f92672>+</span> lines[<span style=color:#ae81ff>0</span>].origin.x <span style=color:#f92672>*</span> axz)
</span></span><span style=display:flex><span>                            <span style=color:#f92672>/</span> (lines[<span style=color:#ae81ff>1</span>].direction.z <span style=color:#f92672>*</span> bxz
</span></span><span style=display:flex><span>                                <span style=color:#f92672>-</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> bxz
</span></span><span style=display:flex><span>                                <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>1</span>].direction.x <span style=color:#f92672>*</span> axz
</span></span><span style=display:flex><span>                                <span style=color:#f92672>+</span> xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> axz);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> ayz <span style=color:#f92672>=</span> lines[<span style=color:#ae81ff>0</span>].direction.z <span style=color:#f92672>-</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> byz <span style=color:#f92672>=</span> lines[<span style=color:#ae81ff>0</span>].direction.y <span style=color:#f92672>-</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> t1yz <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>(lines[<span style=color:#ae81ff>1</span>].origin.z <span style=color:#f92672>*</span> byz
</span></span><span style=display:flex><span>                            <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>1</span>].origin.y <span style=color:#f92672>*</span> ayz
</span></span><span style=display:flex><span>                            <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>0</span>].origin.z <span style=color:#f92672>*</span> byz
</span></span><span style=display:flex><span>                            <span style=color:#f92672>+</span> lines[<span style=color:#ae81ff>0</span>].origin.y <span style=color:#f92672>*</span> ayz)
</span></span><span style=display:flex><span>                            <span style=color:#f92672>/</span> (lines[<span style=color:#ae81ff>1</span>].direction.z <span style=color:#f92672>*</span> byz
</span></span><span style=display:flex><span>                                <span style=color:#f92672>-</span> zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> byz
</span></span><span style=display:flex><span>                                <span style=color:#f92672>-</span> lines[<span style=color:#ae81ff>1</span>].direction.y <span style=color:#f92672>*</span> ayz
</span></span><span style=display:flex><span>                                <span style=color:#f92672>+</span> yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> ayz);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (t1xy <span style=color:#f92672>-</span> t1xz).abs() <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>EPSILON</span> <span style=color:#f92672>||</span> (t1xy <span style=color:#f92672>-</span> t1yz).abs() <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>EPSILON</span> {
</span></span><span style=display:flex><span>                            log::info!(<span style=color:#e6db74>&#34;found non-matching t1: {:?} {:?} {:?}&#34;</span>, t1xy, t1xz, t1yz);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> t1xy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0_</span><span style=color:#66d9ef>f64</span> {
</span></span><span style=display:flex><span>                            log::info!(<span style=color:#e6db74>&#34;found negative t1: {:?}&#34;</span>, t1xy);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// x0 + xd * t1 = l[1].o.x + l[1].d.x * t1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// x0 = l[1].o.x + l[1].d.x * t1 - xd * t1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> x0 <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                            lines[<span style=color:#ae81ff>1</span>].origin.x <span style=color:#f92672>+</span> lines[<span style=color:#ae81ff>1</span>].direction.x <span style=color:#f92672>*</span> t1xy <span style=color:#f92672>-</span> (xd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>) <span style=color:#f92672>*</span> t1xy;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> y0 <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                            lines[<span style=color:#ae81ff>1</span>].origin.y <span style=color:#f92672>+</span> lines[<span style=color:#ae81ff>1</span>].direction.y <span style=color:#f92672>*</span> t1xy <span style=color:#f92672>-</span> (yd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>) <span style=color:#f92672>*</span> t1xy;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> z0 <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                            lines[<span style=color:#ae81ff>1</span>].origin.z <span style=color:#f92672>+</span> lines[<span style=color:#ae81ff>1</span>].direction.z <span style=color:#f92672>*</span> t1xy <span style=color:#f92672>-</span> (zd <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>) <span style=color:#f92672>*</span> t1xy;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> x0.fract() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0.0</span> <span style=color:#f92672>||</span> y0.fract() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0.0</span> <span style=color:#f92672>||</span> z0.fract() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0.0</span> {
</span></span><span style=display:flex><span>                            log::info!(<span style=color:#e6db74>&#34;found non-integer position: {:?}&#34;</span>, (x0, y0, z0));
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> x0 <span style=color:#f92672>=</span> x0.round() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i128</span>;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> y0 <span style=color:#f92672>=</span> y0.round() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i128</span>;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> z0 <span style=color:#f92672>=</span> z0.round() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i128</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        position <span style=color:#f92672>=</span> Some((x0, y0, z0));
</span></span><span style=display:flex><span>                        log::info!(<span style=color:#e6db74>&#34;found valid position: {position:?}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span> &#39;found_solution;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> position <span style=color:#f92672>=</span> position.unwrap();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result <span style=color:#f92672>=</span> position.<span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> position.<span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> position.<span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{result:?}</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Wow that&rsquo;s a lot. It works though! Takes a minute and change, which all things considered isn&rsquo;t that bad!</p><h3 id=solution-2-using-z3>Solution 2: Using Z3</h3><p>Okay, admission time. That wasn&rsquo;t actually my first solution. The first thing I did was realize this is a <a href=https://en.wikipedia.org/wiki/constrained%20optimization>constrained optimization</a> problem and throw <a href=https://github.com/Z3Prover/z3 target=_blank rel=noopener>Microsoft Research&rsquo;s z3</a> at it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    env_logger::init();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stdin <span style=color:#f92672>=</span> io::stdin();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> input <span style=color:#f92672>=</span> io::read_to_string(stdin.lock())<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (s, lines) <span style=color:#f92672>=</span> parse::lines(input.as_str()).unwrap();
</span></span><span style=display:flex><span>    assert!(s.trim().is_empty());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make a giant system of equations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// X + XD * [t] = [x] + [xd] * [t]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// X and XD are scalars
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// [t] is a vector we&#39;re solving for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// [x] and [xd] are the input vectors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> config <span style=color:#f92672>=</span> Config::new();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> context <span style=color:#f92672>=</span> Context::new(<span style=color:#f92672>&amp;</span>config);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> solver <span style=color:#f92672>=</span> Solver::new(<span style=color:#f92672>&amp;</span>context);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> origin_x <span style=color:#f92672>=</span> Int::new_const(<span style=color:#f92672>&amp;</span>context, <span style=color:#e6db74>&#34;ox&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> origin_y <span style=color:#f92672>=</span> Int::new_const(<span style=color:#f92672>&amp;</span>context, <span style=color:#e6db74>&#34;oy&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> origin_z <span style=color:#f92672>=</span> Int::new_const(<span style=color:#f92672>&amp;</span>context, <span style=color:#e6db74>&#34;oz&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> direction_x <span style=color:#f92672>=</span> Int::new_const(<span style=color:#f92672>&amp;</span>context, <span style=color:#e6db74>&#34;dx&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> direction_y <span style=color:#f92672>=</span> Int::new_const(<span style=color:#f92672>&amp;</span>context, <span style=color:#e6db74>&#34;dy&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> direction_z <span style=color:#f92672>=</span> Int::new_const(<span style=color:#f92672>&amp;</span>context, <span style=color:#e6db74>&#34;dz&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#66d9ef>in</span> lines {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> line_origin_x <span style=color:#f92672>=</span> Int::from_i64(<span style=color:#f92672>&amp;</span>context, line.origin.x <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i64</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> line_origin_y <span style=color:#f92672>=</span> Int::from_i64(<span style=color:#f92672>&amp;</span>context, line.origin.y <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i64</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> line_origin_z <span style=color:#f92672>=</span> Int::from_i64(<span style=color:#f92672>&amp;</span>context, line.origin.z <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i64</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> line_direction_x <span style=color:#f92672>=</span> Int::from_i64(<span style=color:#f92672>&amp;</span>context, line.direction.x <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i64</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> line_direction_y <span style=color:#f92672>=</span> Int::from_i64(<span style=color:#f92672>&amp;</span>context, line.direction.y <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i64</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> line_direction_z <span style=color:#f92672>=</span> Int::from_i64(<span style=color:#f92672>&amp;</span>context, line.direction.z <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i64</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> t <span style=color:#f92672>=</span> Int::fresh_const(<span style=color:#f92672>&amp;</span>context, <span style=color:#e6db74>&#34;t&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        solver.assert(
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span>(<span style=color:#f92672>&amp;</span>line_origin_x <span style=color:#f92672>+</span> <span style=color:#f92672>&amp;</span>line_direction_x <span style=color:#f92672>*</span> <span style=color:#f92672>&amp;</span>t)._eq(<span style=color:#f92672>&amp;</span>(<span style=color:#f92672>&amp;</span>origin_x <span style=color:#f92672>+</span> <span style=color:#f92672>&amp;</span>direction_x <span style=color:#f92672>*</span> <span style=color:#f92672>&amp;</span>t)),
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        solver.assert(
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span>(<span style=color:#f92672>&amp;</span>line_origin_y <span style=color:#f92672>+</span> <span style=color:#f92672>&amp;</span>line_direction_y <span style=color:#f92672>*</span> <span style=color:#f92672>&amp;</span>t)._eq(<span style=color:#f92672>&amp;</span>(<span style=color:#f92672>&amp;</span>origin_y <span style=color:#f92672>+</span> <span style=color:#f92672>&amp;</span>direction_y <span style=color:#f92672>*</span> <span style=color:#f92672>&amp;</span>t)),
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        solver.assert(
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span>(<span style=color:#f92672>&amp;</span>line_origin_z <span style=color:#f92672>+</span> <span style=color:#f92672>&amp;</span>line_direction_z <span style=color:#f92672>*</span> <span style=color:#f92672>&amp;</span>t)._eq(<span style=color:#f92672>&amp;</span>(<span style=color:#f92672>&amp;</span>origin_z <span style=color:#f92672>+</span> <span style=color:#f92672>&amp;</span>direction_z <span style=color:#f92672>*</span> <span style=color:#f92672>&amp;</span>t)),
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    solver.check();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> model <span style=color:#f92672>=</span> solver.get_model().unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result_x <span style=color:#f92672>=</span> model.get_const_interp(<span style=color:#f92672>&amp;</span>origin_x).unwrap().as_i64().unwrap();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result_y <span style=color:#f92672>=</span> model.get_const_interp(<span style=color:#f92672>&amp;</span>origin_y).unwrap().as_i64().unwrap();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result_z <span style=color:#f92672>=</span> model.get_const_interp(<span style=color:#f92672>&amp;</span>origin_z).unwrap().as_i64().unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result_dx <span style=color:#f92672>=</span> model
</span></span><span style=display:flex><span>        .get_const_interp(<span style=color:#f92672>&amp;</span>direction_x)
</span></span><span style=display:flex><span>        .unwrap()
</span></span><span style=display:flex><span>        .as_i64()
</span></span><span style=display:flex><span>        .unwrap();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result_dy <span style=color:#f92672>=</span> model
</span></span><span style=display:flex><span>        .get_const_interp(<span style=color:#f92672>&amp;</span>direction_y)
</span></span><span style=display:flex><span>        .unwrap()
</span></span><span style=display:flex><span>        .as_i64()
</span></span><span style=display:flex><span>        .unwrap();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result_dz <span style=color:#f92672>=</span> model
</span></span><span style=display:flex><span>        .get_const_interp(<span style=color:#f92672>&amp;</span>direction_z)
</span></span><span style=display:flex><span>        .unwrap()
</span></span><span style=display:flex><span>        .as_i64()
</span></span><span style=display:flex><span>        .unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log::info!(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;result: {:?} + {:?}&#34;</span>,
</span></span><span style=display:flex><span>        (result_x, result_y, result_z),
</span></span><span style=display:flex><span>        (result_dx, result_dy, result_dz),
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result <span style=color:#f92672>=</span> result_x <span style=color:#f92672>+</span> result_y <span style=color:#f92672>+</span> result_z;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{result:?}</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Somehow&mldr; that&rsquo;s just not as satisfying though, you know?</p><p>So then I spent <em>entirely too long</em> playing with algebra to work it out by hand. Yay me?</p><h2 id=performance>Performance</h2><p>Like I said, <a href=#part-1>part 1</a> is fast. <a href=#solution-1-brute-force>Part 2 brute forced</a> is not as bad as I would have thought. And <a href=#solution-2-using-z3>part 2 with Z3</a> runs in 2.5 seconds. So&mldr; I guess there is that!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Part 1</span>
</span></span><span style=display:flex><span>$ just time <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hyperfine --warmup <span style=color:#ae81ff>3</span> <span style=color:#e6db74>&#39;just run 24 1&#39;</span>
</span></span><span style=display:flex><span>Benchmark 1: just run <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  Time <span style=color:#f92672>(</span>mean Â± Ïƒ<span style=color:#f92672>)</span>:     119.2 ms Â±  17.3 ms    <span style=color:#f92672>[</span>User: 42.6 ms, System: 17.8 ms<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  Range <span style=color:#f92672>(</span>min â€¦ max<span style=color:#f92672>)</span>:   107.1 ms â€¦ 173.2 ms    <span style=color:#ae81ff>26</span> runs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Part 2: Z3</span>
</span></span><span style=display:flex><span>$ just time <span style=color:#ae81ff>24</span> 2-z3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hyperfine --warmup <span style=color:#ae81ff>3</span> <span style=color:#e6db74>&#39;just run 24 2-z3&#39;</span>
</span></span><span style=display:flex><span>Benchmark 1: just run <span style=color:#ae81ff>24</span> 2-z3
</span></span><span style=display:flex><span>  Time <span style=color:#f92672>(</span>mean Â± Ïƒ<span style=color:#f92672>)</span>:      2.561 s Â±  0.047 s    <span style=color:#f92672>[</span>User: 2.261 s, System: 0.046 s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  Range <span style=color:#f92672>(</span>min â€¦ max<span style=color:#f92672>)</span>:    2.499 s â€¦  2.634 s    <span style=color:#ae81ff>10</span> runs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Part 2: Brute force</span>
</span></span><span style=display:flex><span>$ just time <span style=color:#ae81ff>24</span> 2-brute
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hyperfine --warmup <span style=color:#ae81ff>3</span> <span style=color:#e6db74>&#39;just run 24 2-brute&#39;</span>
</span></span><span style=display:flex><span>Benchmark 1: just run <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Time <span style=color:#f92672>(</span>mean Â± Ïƒ<span style=color:#f92672>)</span>:     78.324 s Â±  0.562 s    <span style=color:#f92672>[</span>User: 77.359 s, System: 0.037 s<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  Range <span style=color:#f92672>(</span>min â€¦ max<span style=color:#f92672>)</span>:   77.860 s â€¦ 79.578 s    <span style=color:#ae81ff>10</span> runs
</span></span></code></pre></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!doctype html><html><head><title>StackLang Part VI: Some Examples â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>StackLang Part VI: Some Examples</h1><div class=entry-meta><span class=entry-date>2023-07-16</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/stacklang>StackLang</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/assemblers>Assemblers</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/compilers>Compilers</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/memory>Memory</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/stacks>Stacks</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/virtual-machines>Virtual Machines</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link></a><a class=taxonomy-value href=/series/stacklang>StackLang</a><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2023/07/15/brave-new-world/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/07/17/ultimate-ff-strangest-ever/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>We&rsquo;ve gone through all sorts of things building up the StackLang language so far:</p><div class=ranking><h3 class=title>Posts in <a href=/series/stacklang/>StackLang</a>:</h3><div class=content><ul><li><a href=https://blog.jverkamp.com/2023/04/14/stacklang-part-i-the-idea/>StackLang Part I: The Idea</a></li><li><a href=https://blog.jverkamp.com/2023/04/16/stacklang-part-ii-the-lexer/>StackLang Part II: The Lexer</a></li><li><a href=https://blog.jverkamp.com/2023/04/24/stacklang-part-iii-the-parser/>StackLang Part III: The Parser</a></li><li><a href=https://blog.jverkamp.com/2023/05/01/stacklang-part-iv-an-interpreter/>StackLang Part IV: An Interpreter</a></li><li><a href=https://blog.jverkamp.com/2023/07/12/stacklang-part-v-compiling-to-c/>StackLang Part V: Compiling to C</a></li><li><a href=https://blog.jverkamp.com/2023/07/16/stacklang-part-vi-some-examples/>StackLang Part VI: Some Examples</a></li><li><a href=https://blog.jverkamp.com/2023/08/05/stacklang-part-vii-new-cli-and-datatypes/>StackLang Part VII: New CLI and Datatypes</a></li><li><a href=https://blog.jverkamp.com/2023/08/11/stacklang-part-viii-compiler-stacks/>StackLang Part VIII: Compiler Stacks</a></li><li><a href=https://blog.jverkamp.com/2023/08/12/stacklang-part-ix-better-testing/>StackLang Part IX: Better Testing</a></li></ul></div></div><p>But what can we actually <em>do</em> with it?</p><nav id=TableOfContents><ul><li><a href=#factorial-in-three-parts>Factorial (in three parts)</a><ul><li><a href=#with-a-loop>With a loop</a></li><li><a href=#as-a-function>As a function</a></li><li><a href=#with-recursion>With recursion</a></li></ul></li><li><a href=#fibonacci>Fibonacci</a></li><li><a href=#naive-recursion>Naive recursion</a><ul><li><a href=#naive>Naive</a></li><li><a href=#with-a-loop-1>With a loop</a></li><li><a href=#loop-only-keeping-two>Loop, only keeping two</a></li><li><a href=#with-a-recursive-helper>With a recursive helper</a></li></ul></li><li><a href=#complex-numbers>Complex numbers</a></li><li><a href=#mandelbrot>Mandelbrot</a><ul><li><a href=#taking-user-input-now-with-more-colors>Taking user input; now with more colors!</a></li></ul></li></ul></nav><p>Nothing that particularly deep (yet), but I did think the code for <a href=#mandelbrot>generating the Mandelbrot set</a> is pretty cool!</p><p>Full source code for StackLang: <a href=https://github.com/jpverkamp/stacklang/ target=_blank rel=noopener>github:jpverkamp/stacklang</a></p><h2 id=factorial-in-three-parts>Factorial (in three parts)</h2><p><a href=https://en.wikipedia.org/wiki/Factorial>Factorial</a> - calculating the product of 1 to N.</p><p>It&rsquo;s a great first problem to implement, mostly because you can do it at least two ways (with a loop or recursively). Other than that, it&rsquo;s simple math: add and multiply.</p><p>So let&rsquo;s try to write out the solution a few different ways!</p><h3 id=with-a-loop>With a loop</h3><p>First up, a loop. In StackLang, the <code>loop</code> syntax is <code>{ @block } @iter loop</code>. Assuming <code>@iter</code> is a number <code>N</code> times, <code>{ @block }</code> will be called <code>N</code> times, with each of those values being sent as the last parameter.</p><p>So we can directly calculate <code>10 fact</code> as so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>1               # Push the initial 1 onto the stack
</span></span><span style=display:flex><span>{ @2 1 + * }    # The loop block:
</span></span><span style=display:flex><span>                # - Take two parameters (the current value and the loop index) and return 1 (the default)
</span></span><span style=display:flex><span>                # - Add 1 to the loop index (it&#39;s zero based)
</span></span><span style=display:flex><span>                # - Multiply and &#39;return&#39; that value for the next iteration
</span></span><span style=display:flex><span>10              # The value of N
</span></span><span style=display:flex><span>loop            # Call the loop
</span></span></code></pre></div><p>Or in a single line: <code>1 { @2 1 + * } 10 loop</code>. It&rsquo;s a bit esoteric, not going to lie, but I do like how compact it can be!</p><h3 id=as-a-function>As a function</h3><p>Okay, but what if we want to generalize? Perhaps even (<em>le gasp</em>) call it <em>more than once</em>?</p><p>Well, that&rsquo;s easy enough. We can take the above, wrap it up in a new block all it&rsquo;s own (taking one named parameter <code>@n</code>), and name it <code>@fact</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>    @n
</span></span><span style=display:flex><span>    1 { @2 1 + * } n loop
</span></span><span style=display:flex><span>} @fact
</span></span></code></pre></div><p>Now we just call it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>10 fact writeln
</span></span></code></pre></div><p>Pretty cool.</p><h3 id=with-recursion>With recursion</h3><p>Okay, we can do it with loops, what about recursion? To make this work:</p><ul><li>Take a value N<ul><li>If N is 1, return 1 (this is the base case)</li><li>If not, calculate <code>fact(N - 1)</code> (recursion!) and multiply by N (the recursive case)</li></ul></li></ul><p>It translates pretty directly to StackLang:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>  @n
</span></span><span style=display:flex><span>  1                      # True case
</span></span><span style=display:flex><span>  { @0 n 1 - fact n * }  # False case
</span></span><span style=display:flex><span>  n 1 &lt; if               # Check if n &lt; 1 (&lt;= would be the same if one step faster)
</span></span><span style=display:flex><span>} @fact
</span></span></code></pre></div><p>That&rsquo;s it! From the outside, <code>10 fact</code> works exactly the same as the loop based function.</p><h2 id=fibonacci>Fibonacci</h2><p>On to <a href=https://en.wikipedia.org/wiki/Fibonacci>Fibonacci</a>. This falls into mostly the same category as Factorial. It&rsquo;s a simple math definition that&rsquo;s great for testing code.</p><p>In this case, <code>fib(0) = fib(1) = 1</code> and <code>fib(n) = fib(n-1) + fib(n-2)</code>.</p><p>Or non-recursively, start with the list <code>1 1</code>. Until you reach <code>N (+1)</code> elements, generate a new element by adding the current last two numbers. So <code>1 1 -> 1 1 2 -> 1 1 2 3 -> 1 1 2 3 5</code>.</p><h2 id=naive-recursion>Naive recursion</h2><p>First, let&rsquo;s just implement it (naively) with the recursive definition:</p><h3 id=naive>Naive</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>    @[n]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    1
</span></span><span style=display:flex><span>    { 
</span></span><span style=display:flex><span>        @0 !1
</span></span><span style=display:flex><span>        n 1 - fib
</span></span><span style=display:flex><span>        n 2 - fib
</span></span><span style=display:flex><span>        +
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    n 2 &lt;= if
</span></span><span style=display:flex><span>} @fib
</span></span></code></pre></div><p>It&rsquo;s much the same as the recursive factorial function. Have a base case (<code>n 2 &lt;=</code> that returns <code>1</code>), otherwise have a block. In this case, it takes no parameters and returns 1 (<code>@0 !1</code>), calculates <code>fib(n - 1)</code> and <code>fib(n - 2)</code> and adds them.</p><p>That&rsquo;s it!</p><p>But there&rsquo;s one problem with that. Let&rsquo;s expand <code>fib(3)</code>:</p><div class=mermaid align=center>flowchart TD
A1 --> A11["fib(3)"]
A1 --> A12["fib(2)"]
A11 --> A111["fib(2)"]
A11 --> A112["fib(1) = 1"]
A111 --> A1111["fib(1) = 1"]
A111 --> A1112["fib(0) = 1"]</div><p>Not so bad. 7 nodes. What about <code>fib(5)</code>?</p><div class=mermaid align=center>flowchart TD
A["fib(5)"] --> A1["fib(4)"]
A["fib(5)"] --> A2["fib(3)"]
A1 --> A11["fib(3)"]
A1 --> A12["fib(2)"]
A11 --> A111["fib(2)"]
A11 --> A112["fib(1) = 1"]
A111 --> A1111["fib(1) = 1"]
A111 --> A1112["fib(0) = 1"]
A12 --> A121["fib(1) = 1"]
A12 --> A122["fib(0) = 1"]
A2 --> A21["fib(2)"]
A2 --> A22["fib(1) = 1"]
A21 --> A211["fib(1) = 1"]
A21 --> A212["fib(0) = 1"]</div><p>Already 15 nodes.</p><p>As you might expect, it increases very very quickly. Each time, roughly doubling the number of nodes. So how long does it take (with this code, even compiled) to calculate <code>fib(50)</code>?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run --release -- --file examples/fibonacci-naive-block.stack --compile &gt; output/fibonacci-naive-block.c
</span></span><span style=display:flex><span>    Finished release <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.09s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/release/stacklang --file examples/fibonacci-naive-block.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang -Ofast output/fibonacci-naive-block.c -o output/fibonacci-naive-block
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ time output/fibonacci-naive-block
</span></span><span style=display:flex><span><span style=color:#ae81ff>102334155</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real	0m12.347s
</span></span><span style=display:flex><span>user	0m11.571s
</span></span><span style=display:flex><span>sys	0m0.060s
</span></span></code></pre></div><p>That should not take that long.</p><p>But there&rsquo;s good news! That&rsquo;s an awful of lot of duplicated work. Just how many times are we calculating <code>fib(2)</code> after all?</p><h3 id=with-a-loop-1>With a loop</h3><p>The much faster way to solve the problem is to build from the ground up. Make that list (implicitly), adding two numbers until we get the final form. You can do this two ways: with a loop and recursively with a helper function.</p><p>First, with a loop:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>    @n
</span></span><span style=display:flex><span>    1 1
</span></span><span style=display:flex><span>    { 
</span></span><span style=display:flex><span>        @1 !1    # pop n (ignore it), return a+b
</span></span><span style=display:flex><span>        @[a b n] # name the top three values of the stack a, b, n
</span></span><span style=display:flex><span>        a b +    # push a + b
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    n 2 - loop
</span></span><span style=display:flex><span>} @fib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>40 fib write
</span></span></code></pre></div><p>It&rsquo;s a bit funny looking, but essentially we&rsquo;re going to keep the entire list on the stack. Start by pushing the two initial 1s (and that&rsquo;s why there&rsquo;s an <code>n 2 -</code> at the end).</p><p>Then loop to fill out the list. Each time, we pop a single value (<code>@1</code>) which we&rsquo;re going to ignore. That&rsquo;s the loop index. Then we peek/name the top three values of the stack: <code>@[a b n]</code>. We could also start the loop block with <code>@[a b n]</code>, but that implies that we want to pop those three values off the stack, which we do not. Finally, pop the new sum and continue.</p><p>After the loop has run, the stack should contain the fibonacci sequence all the way up to N. We can see this in debug mode:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run -- --debug --file examples/fibonacci-loop.stack --compile &gt; output/fibonacci-loop.c
</span></span><span style=display:flex><span>   Compiling stacklang v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/stacklang<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 1.26s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/stacklang --debug --file examples/fibonacci-loop.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang output/fibonacci-loop.c -o output/fibonacci-loop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ output/fibonacci-loop
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_0 called -- STACK: &lt;empty&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_1 called -- STACK: <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>That&rsquo;s pretty cool to see!</p><p>Running it for the original 40:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run --release -- --file examples/fibonacci-loop.stack --compile &gt; output/fibonacci-loop.c
</span></span><span style=display:flex><span>    Finished release <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.11s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/release/stacklang --file examples/fibonacci-loop.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang -Ofast output/fibonacci-loop.c -o output/fibonacci-loop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ time output/fibonacci-loop
</span></span><span style=display:flex><span><span style=color:#ae81ff>102334155</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real	0m0.085s
</span></span><span style=display:flex><span>user	0m0.001s
</span></span><span style=display:flex><span>sys	0m0.001s
</span></span></code></pre></div><p>Pretty cool. Much much faster.</p><h3 id=loop-only-keeping-two>Loop, only keeping two</h3><p>But it turns out&mldr; why are we actually keeping the entire stack? We never actually need anything other than the most recent two values. So rather than the trick to name/peek, let&rsquo;s actually go ahead and pop the values. The one gotcha is that we do then have to push two values back on:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>    @n
</span></span><span style=display:flex><span>    1 1
</span></span><span style=display:flex><span>    { 
</span></span><span style=display:flex><span>        @[a b n] !2 # take a, b and n (ignored), return 2
</span></span><span style=display:flex><span>        b           # new a
</span></span><span style=display:flex><span>        a b +       # new b
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    n 2 - loop
</span></span><span style=display:flex><span>} @fib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>40 fib writeln
</span></span></code></pre></div><p>Of course, we get the same answer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run --release -- --file examples/fibonacci-loop-keep2.stack --compile &gt; output/fibonacci-loop-keep2.c
</span></span><span style=display:flex><span>    Finished release <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.11s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/release/stacklang --file examples/fibonacci-loop-keep2.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang -Ofast output/fibonacci-loop-keep2.c -o output/fibonacci-loop-keep2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ time output/fibonacci-loop-keep2
</span></span><span style=display:flex><span><span style=color:#ae81ff>102334155</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real	0m0.088s
</span></span><span style=display:flex><span>user	0m0.000s
</span></span><span style=display:flex><span>sys	0m0.001s
</span></span></code></pre></div><p>And in debug mode, we can confirm that we&rsquo;re not blowing up the stack this time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run -- --debug --file examples/fibonacci-loop-keep2.stack --compile &gt; output/fibonacci-loop-keep2.c
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.08s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/stacklang --debug --file examples/fibonacci-loop-keep2.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang output/fibonacci-loop-keep2.c -o output/fibonacci-loop-keep2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ output/fibonacci-loop-keep2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_0 called -- STACK: &lt;empty&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_1 called -- STACK: <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 <span style=color:#66d9ef>return</span> -- STACK: <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: n<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> | fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Pretty cool.</p><h3 id=with-a-recursive-helper>With a recursive helper</h3><p>And finally, just to show that we can, we can also write the function without using <code>loop</code> at all, instead rewriting the above &rsquo;loop-keep2&rsquo; in a recursive style:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>    @n 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        @[n a b]
</span></span><span style=display:flex><span>        b
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            @0 !1
</span></span><span style=display:flex><span>            (n 1 -) (a b +) a fibacc
</span></span><span style=display:flex><span>        } 
</span></span><span style=display:flex><span>        n 1 &lt;= if
</span></span><span style=display:flex><span>    } @fibacc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    n 1 1 fibacc
</span></span><span style=display:flex><span>} @fib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>40 fib writeln
</span></span></code></pre></div><p>In this case, we define a hidden/helper function: <code>fibacc</code>, only visible when inside of the <code>fib</code> block. In this case, <code>fibacc</code> explicitly takes three variables: <code>n</code> (to control recursion) and <code>a</code>/<code>b</code>. If <code>n</code> is small enough, base case. Otherwise, update <code>a</code> and <code>b</code> and recur.</p><p>And of course, it works the same (and just about as fast):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run --release -- --file examples/fibonacci-acc.stack --compile &gt; output/fibonacci-acc.c
</span></span><span style=display:flex><span>    Finished release <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.08s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/release/stacklang --file examples/fibonacci-acc.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang -Ofast output/fibonacci-acc.c -o output/fibonacci-acc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ time output/fibonacci-acc
</span></span><span style=display:flex><span><span style=color:#ae81ff>102334155</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real	0m0.083s
</span></span><span style=display:flex><span>user	0m0.000s
</span></span><span style=display:flex><span>sys	0m0.001s
</span></span></code></pre></div><p>Unfortunately, we don&rsquo;t (yet) have any sort of {{wikipedia &ldquo;tail call optimization&rdquo;}}, so each of those values (as we&rsquo;re recursively calling) is kept on the stack:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run -- --debug --file examples/fibonacci-acc.stack --compile &gt; output/fibonacci-acc.c
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.08s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/stacklang --debug --file examples/fibonacci-acc.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang output/fibonacci-acc.c -o output/fibonacci-acc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ output/fibonacci-acc
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_0 called -- STACK: &lt;empty&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_1 called -- STACK: <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_3 called -- STACK: <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_3 called -- STACK: <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_3 called -- STACK: <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>38</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>37</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>38</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_3 called -- STACK: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>37</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>37</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>38</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>36</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>37</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>37</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>38</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_3 called -- STACK: <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>36</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>37</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>36</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>37</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>38</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DEBUG<span style=color:#f92672>]</span> block_2 called -- STACK: <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>35</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>36</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>37</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>{</span>block<span style=color:#f92672>}</span> NAMES: b<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>36</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>37</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>38</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>39</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> | a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fibacc<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span> | n<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span> fib<span style=color:#f92672>={</span>block<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Oy. Back to exploding the stack!</p><p>Something to work on in the future though!</p><h2 id=complex-numbers>Complex numbers</h2><p>Okay, we&rsquo;ve done a lot of math. Let&rsquo;s move on &mldr; to more math!</p><p>At this time, I don&rsquo;t yet have <a href=https://en.wikipedia.org/wiki/complex%20numbers>complex numbers</a> implemented as a native datatype as I&rsquo;d like. But that doesn&rsquo;t matter, since with arbitrarily many parameters and return values, we can just directly implement them!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>  @[ar ai br bi] !2
</span></span><span style=display:flex><span>  ar br * ai bi * - 
</span></span><span style=display:flex><span>  ar bi * ai br * +
</span></span><span style=display:flex><span>} @cmul
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  @[ar ai br bi] !2
</span></span><span style=display:flex><span>  ar br +
</span></span><span style=display:flex><span>  ai bi +
</span></span><span style=display:flex><span>} @cadd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  @[r i] !0
</span></span><span style=display:flex><span>  r write 
</span></span><span style=display:flex><span>  &#34;+&#34; write
</span></span><span style=display:flex><span>  i write
</span></span><span style=display:flex><span>  &#34;i&#34; write
</span></span><span style=display:flex><span>} @cwrite
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&#34;multiply:&#34; writeln
</span></span><span style=display:flex><span>3 -2 4 5 cmul cwrite newline
</span></span><span style=display:flex><span>22 7 cwrite newline
</span></span><span style=display:flex><span>newline
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&#34;add:&#34; writeln
</span></span><span style=display:flex><span>3 -2 4 5 cadd cwrite newline
</span></span><span style=display:flex><span>7 3 cwrite newline
</span></span></code></pre></div><p>So each of the functions takes 2 parameters: the real and imaginary part of a complex number. Then in the case of <code>cmul</code> and <code>cadd</code>, we return 2 as well: the new real and imaginary parts.</p><p>The naming really helps here.</p><h2 id=mandelbrot>Mandelbrot</h2><p>And then finally, the piece de resistance, using those complex numbers to calculate the <a href=https://en.wikipedia.org/wiki/Mandelbrot%20set>Mandelbrot set</a>!</p><p>I&rsquo;m not going to talk through the code this time, since it&rsquo;s pretty much a direct translation of the algorithm (see the link above). But I do think it&rsquo;s a good example of how you can start to write &lsquo;real code&rsquo; in StackLang:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Set image dimensions and maximum number of iterations
</span></span><span style=display:flex><span>1920 @width
</span></span><span style=display:flex><span>1080 @height
</span></span><span style=display:flex><span>16 @max_iterations
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Set the range of complex numbers to visualize
</span></span><span style=display:flex><span>-2.0 @min_real
</span></span><span style=display:flex><span>1.0 @max_real
</span></span><span style=display:flex><span>-1.0 @min_imag
</span></span><span style=display:flex><span>1.0 @max_imag
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Calculate the step sizes for the real and imaginary parts
</span></span><span style=display:flex><span>max_real min_real - width / @real_step
</span></span><span style=display:flex><span>max_imag min_imag - height / @imag_step
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  @[ar ai br bi] !2
</span></span><span style=display:flex><span>  ar br * ai bi * - 
</span></span><span style=display:flex><span>  ar bi * ai br * +
</span></span><span style=display:flex><span>} @cmul
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  @[ar ai br bi] !2
</span></span><span style=display:flex><span>  ar br +
</span></span><span style=display:flex><span>  ai bi +
</span></span><span style=display:flex><span>} @cadd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  @[r i]
</span></span><span style=display:flex><span>  r i * r i * +
</span></span><span style=display:flex><span>} @cmag2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>  @[px py max_iter]
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    @[zx zy i iter] 
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    0
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      @0 !1
</span></span><span style=display:flex><span>      i
</span></span><span style=display:flex><span>      { 
</span></span><span style=display:flex><span>        @0 !1
</span></span><span style=display:flex><span>        zx zy zx zy cmul px py cadd
</span></span><span style=display:flex><span>        i 1 +
</span></span><span style=display:flex><span>        $iter iter
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      zx zy cmag2 4.0 &gt; if
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>    i max_iter = if
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  } @iter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  px py 1 $iter iter
</span></span><span style=display:flex><span>} @mandelbrot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Write the PPM header
</span></span><span style=display:flex><span>&#34;P3&#34; writeln
</span></span><span style=display:flex><span>width writeln
</span></span><span style=display:flex><span>height writeln
</span></span><span style=display:flex><span>&#34;255&#34; writeln
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Loop through image rows (y) and columns (x)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    @y
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        @x
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # Calculate the current complex number (real + imag * i)
</span></span><span style=display:flex><span>        x real_step * min_real + @real
</span></span><span style=display:flex><span>        y imag_step * min_imag + @imag
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # Calculate the number of iterations for the current complex number
</span></span><span style=display:flex><span>        real imag max_iterations mandelbrot @iterations
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # Scale the number of iterations to a color value (assuming grayscale)
</span></span><span style=display:flex><span>        1.0 iterations * max_iterations / 255 * to_int @color
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # Write the color value to the PPM file (red, green, blue)
</span></span><span style=display:flex><span>        color write &#34; &#34; write
</span></span><span style=display:flex><span>        color write &#34; &#34; write
</span></span><span style=display:flex><span>        color write &#34; &#34; write
</span></span><span style=display:flex><span>    } width loop
</span></span><span style=display:flex><span>    newline
</span></span><span style=display:flex><span>} height loop
</span></span></code></pre></div><p>And with the compiler, it&rsquo;s relatively quick:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run --release -- --file examples/mandelbrot.stack --compile &gt; output/mandelbrot.c
</span></span><span style=display:flex><span>    Finished release <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.07s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/release/stacklang --file examples/mandelbrot.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang -Ofast output/mandelbrot.c -o output/mandelbrot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ time output/mandelbrot | convert - output/mandelbrot-compile.png
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real	0m10.250s
</span></span><span style=display:flex><span>user	0m9.599s
</span></span><span style=display:flex><span>sys	0m0.101s
</span></span></code></pre></div><figure><img src=/embeds/2023/mandelbrot-1920x1080x16.png></figure><h3 id=taking-user-input-now-with-more-colors>Taking user input; now with more colors!</h3><p>As one last aside though, we have implemented <code>read</code> into the language. This reads a single line from stdin and stores it as a string. We can then use <code>to_int</code> to convert it and thus parameterize our <code>mandelbrot</code> function!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Set image dimensions and maximum number of iterations
</span></span><span style=display:flex><span>read to_int @width
</span></span><span style=display:flex><span>read to_int @height
</span></span><span style=display:flex><span>read to_int @max_iterations
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Likewise, we can tweak the color algorithm to use the value not as grayscale but rather in the red and green channels:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Write the color value to the PPM file (red, green, blue)
</span></span><span style=display:flex><span>color write &#34; &#34; write
</span></span><span style=display:flex><span>255 color - write &#34; &#34; write
</span></span><span style=display:flex><span>0 write &#34; &#34; write
</span></span></code></pre></div><p>Now we run it again, this time providing the size at runtime:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run --release -- --file examples/mandelbrot-read.stack --compile &gt; output/mandelbrot-read.c
</span></span><span style=display:flex><span>    Finished release <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.10s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/release/stacklang --file examples/mandelbrot-read.stack --compile<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ clang -Ofast output/mandelbrot-read.c -o output/mandelbrot-read
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ output/mandelbrot-read
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Note: These three lines are user input</span>
</span></span><span style=display:flex><span><span style=color:#75715e># I can&#39;t write a prompt (yet) because I&#39;m redirecting stdout to a PPM file</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Normally (and in the future) this would be done by using stderr for the prompt</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1920</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1080</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>16</span>
</span></span></code></pre></div><figure><img src=/embeds/2023/mandelbrot-1920x1080x16-color.png></figure><p>Whee!</p><p>Well, that&rsquo;s all for today. I&rsquo;ve certainly got a few things to work on. So let&rsquo;s see where we can go from here!</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!doctype html><html><head><title>Redis in Rust: Testing redis-cli + GET/SET support â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="><link rel=stylesheet href=/main.min.2dfe13db7d2a586897d92d224a9dd8392b5abf84b4587e14bc4ede772802dc14.css integrity="sha256-Lf4T230qWGiX2S0iSp3YOStav4S0WH4UvE7edygC3BQ="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Redis in Rust: Testing redis-cli + GET/SET support</h1><div class=entry-meta><span class=entry-date>2023-02-28</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/rust>Rust</a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/client>Client</a></li><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/networking>Networking</a></li><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/parsing>Parsing</a></li><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/redis>Redis</a></li><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/repl>REPL</a></li><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/tcp>TCP</a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=previous-link></a><a class=taxonomy-value href=/series/cloning-redis-in-rust>Cloning Redis in Rust</a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2023/02/27/genuary-2023.27-in-the-style-of-hilma-af-klint/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/02/28/genuary-2023.28-generative-poetry/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2023/02/28/runaways-vol.-5-escape-to-new-york/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/02/28/genuary-2023.28-generative-poetry/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>And I&rsquo;m back. It&rsquo;s been a busy month with the <a href=https://blog.jverkamp.com/series/genuary-2023/>Genuary</a> series and life in general, but I&rsquo;m still thinking about Redis in general ðŸ˜„.</p><p>Up this time, let&rsquo;s see what the official <code>redis-cli</code> app does when talking to our client and actually start handling some commands. Specifically, the very basic commands: <code>SET</code> and <code>GET</code>. With that, we would actually have a (very very basic) keystore up and running!</p><nav id=TableOfContents><ul><li><a href=#testing-the-client>Testing the client</a></li><li><a href=#implementing-commands>Implementing Commands</a></li><li><a href=#parsing-and-running-a-command>Parsing and running a <code>Command</code></a></li><li><a href=#set-and-get>SET and GET</a></li><li><a href=#testing-with-our-client>Testing with our client</a></li><li><a href=#full-source>Full source</a></li><li><a href=#next-steps>Next steps</a></li></ul></nav><h2 id=testing-the-client>Testing the client</h2><p>Okay, first things first. I mentioned <a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/>last time</a> that I wanted to see how my server reacted to the official client, so let&rsquo;s do that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 1.43s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>2023-02-28T22:44:26.820918Z  INFO server: Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span>2023-02-28T22:44:31.563159Z DEBUG server: Accepted connection from 127.0.0.1:57879
</span></span><span style=display:flex><span>2023-02-28T22:44:31.563366Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:57879<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-28T22:44:31.563464Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:57879<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>27</span> bytes
</span></span><span style=display:flex><span>2023-02-28T22:44:31.563532Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:57879 Received Array <span style=color:#f92672>{</span> value: <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;COMMAND&#34;</span> <span style=color:#f92672>}</span>, String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;DOCS&#34;</span> <span style=color:#f92672>}]</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>2023-02-28T22:44:31.563937Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:57879<span style=color:#f92672>]</span> Ending connection
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ redis-cli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Assertion failed: <span style=color:#f92672>(</span>commandTable-&gt;element<span style=color:#f92672>[</span>i + 1<span style=color:#f92672>]</span>-&gt;type <span style=color:#f92672>==</span> REDIS_REPLY_MAP <span style=color:#f92672>||</span> commandTable-&gt;element<span style=color:#f92672>[</span>i + 1<span style=color:#f92672>]</span>-&gt;type <span style=color:#f92672>==</span> REDIS_REPLY_ARRAY<span style=color:#f92672>)</span>, <span style=color:#66d9ef>function</span> cliCountCommands, file redis-cli.c, line 724.
</span></span><span style=display:flex><span>zsh: abort      redis-cli
</span></span></code></pre></div><p>That&rsquo;s a good start. ðŸ˜„</p><p>It looks like before you even get to run a command, the first thing that <code>redis-cli</code> does is ask the server what commands it has, which is an interesting choice. Specifically it sends a <code>COMMAND DOCS</code> command to the server. Let&rsquo;s try just responding to that with an empty string:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span># server.rs
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>TcpStream</span>, addr: <span style=color:#a6e22e>SocketAddr</span>) -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[{addr}] Accepted connection&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> buf <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; <span style=color:#ae81ff>1024</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> state <span style=color:#f92672>=</span> State::default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> bytes_read <span style=color:#f92672>=</span> stream.read(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> buf).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> bytes_read <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[{addr}] Received {bytes_read} bytes&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stream.write_all(RedisType::Array { value: <span style=color:#a6e22e>vec</span><span style=color:#f92672>!</span>[] }.to_string().as_bytes()).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I don&rsquo;t want to actually deal actually sending all of the commands just yet, so let&rsquo;s see if this is enough to get away with for the time being:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 1.23s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>2023-02-28T22:47:29.964696Z  INFO server: Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span>2023-02-28T22:47:32.176521Z DEBUG server: Accepted connection from 127.0.0.1:58089
</span></span><span style=display:flex><span>2023-02-28T22:47:32.176730Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:58089<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-28T22:47:32.176781Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:58089<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>27</span> bytes
</span></span><span style=display:flex><span>2023-02-28T22:47:32.176866Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:58089 Received: COMMAND <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;DOCS&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>2023-02-28T22:47:35.527012Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:58089<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>24</span> bytes
</span></span><span style=display:flex><span>2023-02-28T22:47:35.527265Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:58089 Received: GET <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>2023-02-28T22:47:36.623683Z  WARN server: An error occurred: Os <span style=color:#f92672>{</span> code: 54, kind: ConnectionReset, message: <span style=color:#e6db74>&#34;Connection reset by peer&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ redis-cli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; GET hello
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>empty array<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; EXIT
</span></span></code></pre></div><p>Sweet. We actually get to a REPL in the <code>redis-cli</code>. So we don&rsquo;t have to actually send anything interesting back, an empty array is fine. And it turns out that we can send that back to every command the REPL will happily print it out. Now that&rsquo;s progress.</p><p>Let&rsquo;s actually implement something!</p><h2 id=implementing-commands>Implementing Commands</h2><p>Okay, to actually implement commands, let&rsquo;s take a step back and actually decide what a <code>Command</code> actually is. I think that we&rsquo;ll need:</p><ol><li>some state for the server (whatever values we&rsquo;re storing, timeouts for values, ability to serialize to disk for backups)</li><li>the function(s) to run in specific commands</li></ol><p>Eventually we&rsquo;ll probably be able to put a lot more here, like type checking and parsing, but that&rsquo;s for another day. For now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Default)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>State</span> {
</span></span><span style=display:flex><span>    keystore: <span style=color:#a6e22e>HashMap</span><span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive()]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Command</span> {
</span></span><span style=display:flex><span>    f: Box<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>fn</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> State, <span style=color:#f92672>&amp;</span>[RedisType]) -&gt; Result<span style=color:#f92672>&lt;</span>RedisType, String<span style=color:#f92672>&gt;&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Specifically, the <code>State</code> right now will store just the basic <code>keystore</code> which is <code>String</code> to <code>String</code> (we&rsquo;ll get more types later, the value of this can be various data types.</p><p><code>Command</code> likewise just has the function <code>f</code> right now which takes in a mutable reference to a state (we&rsquo;ll need that for <code>SET</code> and friends) and a slice of <code>RedisType</code> as the arguments (whatever they may be). We&rsquo;ll return either a <code>RedisType</code> as the return value or a <code>String</code> as an error (which we&rsquo;ll &lsquo;promote&rsquo; to <code>RedisType::Error</code>).</p><p>And then we can use <code><a href=https://docs.rs/lazy_static/latest/lazy_static/>lazy_static</a></code>
to create a <code>&'static</code> <code>HashMap</code> of <code>Commands</code>!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>lazy_static! {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>ref</span> <span style=color:#66d9ef>COMMANDS</span>: <span style=color:#a6e22e>HashMap</span><span style=color:#f92672>&lt;&amp;</span>&#39;static <span style=color:#66d9ef>str</span>, Command<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> m <span style=color:#f92672>=</span> HashMap::new();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        m.insert(<span style=color:#e6db74>&#34;COMMAND&#34;</span>, Command {
</span></span><span style=display:flex><span>            f: Box::new(<span style=color:#f92672>|</span>_state, _args<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// TODO: Assume for now it&#39;s run as COMMAND DOCS with no more parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// Eventually we&#39;ll want to serialize and send `COMMANDS` back
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                Ok(RedisType::Array { value: <span style=color:#a6e22e>vec</span><span style=color:#f92672>!</span>[] })
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Pretty bizarre looking, not going to lie, but for the moment it does what I want. I think that I&rsquo;ll have to figure out a better abstraction for this, but let&rsquo;s see if this works.</p><h2 id=parsing-and-running-a-command>Parsing and running a <code>Command</code></h2><p>Assuming we have the above, let&rsquo;s modify the <code>handle</code> function to use it. We need to:</p><ol><li>Verify that we actually got at least one argument from the client (the <code>Command</code>)</li><li>Parse that</li><li>Verify that it&rsquo;s defined in our <code>COMMANDS</code> <code>HashMap</code> (or return an error)</li><li>Run the stored function (which may mutate <code>State</code>)</li><li>Return whatever that function returns to the client <em>or</em> if we got an error, return a <code>RedisType::Error</code> instead</li></ol><p>Like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>TcpStream</span>, addr: <span style=color:#a6e22e>SocketAddr</span>) -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[{addr}] Accepted connection&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> buf <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; <span style=color:#ae81ff>1024</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> state <span style=color:#f92672>=</span> State::default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> bytes_read <span style=color:#f92672>=</span> stream.read(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> buf).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> bytes_read <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[{addr}] Received {bytes_read} bytes&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> string <span style=color:#f92672>=</span> String::from_utf8_lossy(<span style=color:#f92672>&amp;</span>buf[<span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>bytes_read]);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> command <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> RedisType::from_str(<span style=color:#f92672>&amp;</span>string) {
</span></span><span style=display:flex><span>            Ok(RedisType::Array { value }) <span style=color:#f92672>=&gt;</span> value,
</span></span><span style=display:flex><span>            Ok(data) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                tracing::warn!(<span style=color:#e6db74>&#34;[{addr}] Error, input should be array, got: {data:?}&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            Err(err) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                tracing::warn!(<span style=color:#e6db74>&#34;[{addr}] Error parsing input: {err:?}&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> command.len() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>            tracing::warn!(<span style=color:#e6db74>&#34;[{addr}] Input command was empty&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> args <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>command[<span style=color:#ae81ff>1</span><span style=color:#f92672>..</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> command <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> <span style=color:#f92672>&amp;</span>command[<span style=color:#ae81ff>0</span>] {
</span></span><span style=display:flex><span>            RedisType::String { value } <span style=color:#f92672>=&gt;</span> value.to_ascii_uppercase().to_owned(),
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                tracing::warn!(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;[{addr}] Input command must be a string, got {:?}&#34;</span>,
</span></span><span style=display:flex><span>                    command[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>                );
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[{addr} Received: {command} {args:?}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> <span style=color:#66d9ef>COMMANDS</span>.get(command.as_str()) {
</span></span><span style=display:flex><span>            Some(command) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> response <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> command.f.as_ref()(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> state, args) {
</span></span><span style=display:flex><span>                    Ok(value) <span style=color:#f92672>=&gt;</span> value,
</span></span><span style=display:flex><span>                    Err(value) <span style=color:#f92672>=&gt;</span> RedisType::Error { value },
</span></span><span style=display:flex><span>                };
</span></span><span style=display:flex><span>                stream.write_all(response.to_string().as_bytes()).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            None <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                tracing::warn!(<span style=color:#e6db74>&#34;[{addr}] Unimplemented command: {command} {args:?}&#34;</span>);
</span></span><span style=display:flex><span>                stream
</span></span><span style=display:flex><span>                    .write_all(
</span></span><span style=display:flex><span>                        RedisType::Error {
</span></span><span style=display:flex><span>                            value: <span style=color:#a6e22e>format</span><span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;Unimplemented command: {command}&#34;</span>).to_owned(),
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        .to_string()
</span></span><span style=display:flex><span>                        .as_bytes(),
</span></span><span style=display:flex><span>                    )
</span></span><span style=display:flex><span>                    .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[{addr}] Ending connection&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s actually not bad. More to do the initial parsing than there is in the running the functions even. We do make sure that there&rsquo;s not only at least a first argument but that the first argument has to be a <code>RedisType::String</code>, since that&rsquo;s what commands have to do.</p><p>Testing it out&mldr; should be no different, since our only command is <code>COMMAND DOCS</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 1.13s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>2023-02-28T23:03:59.250735Z  INFO server: Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span>2023-02-28T23:04:02.523925Z DEBUG server: Accepted connection from 127.0.0.1:59537
</span></span><span style=display:flex><span>2023-02-28T23:04:02.524167Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:59537<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-28T23:04:02.524225Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:59537<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>27</span> bytes
</span></span><span style=display:flex><span>2023-02-28T23:04:02.524414Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:59537 Received: COMMAND <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;DOCS&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>2023-02-28T23:04:05.358497Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:59537<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>24</span> bytes
</span></span><span style=display:flex><span>2023-02-28T23:04:05.358628Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:59537 Received: GET <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>2023-02-28T23:04:05.358706Z  WARN server: <span style=color:#f92672>[</span>127.0.0.1:59537<span style=color:#f92672>]</span> Unimplemented command: GET <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>2023-02-28T23:04:07.477619Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:59537<span style=color:#f92672>]</span> Ending connection
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>redis-cli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; GET hello
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>error<span style=color:#f92672>)</span> Unimplemented command: GET
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; EXIT
</span></span></code></pre></div><p>Sweet. It&rsquo;s even happy about sending commands I don&rsquo;t know yet and just sends those back as a <code>RedisType::Err</code>.</p><h2 id=set-and-get>SET and GET</h2><p>Okay, so we have a server, let&rsquo;s implement our first two commands: <code>SET</code> and <code>GET</code>. <code>SET</code> actually takes far more optional parameters than I even knew&mldr; but we can ignore most of them for now. For now, just <code>SET key value</code> and <code>GET key</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>m.insert(<span style=color:#e6db74>&#34;SET&#34;</span>, Command {
</span></span><span style=display:flex><span>    f: Box::new(<span style=color:#f92672>|</span>state, args<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> args.len() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Err(<span style=color:#e6db74>&#34;Expected: SET key value [NX | XX] [GET] [EX seconds | PX milliseconds | EXAT unix-time-seconds | PXAT unix-time-milliseconds | KEEPTTL]&#34;</span>.to_string());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> args.len() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Err(<span style=color:#e6db74>&#34;Expected: SET key value; additional parameters are not yet supported&#34;</span>.to_string());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> key <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> <span style=color:#f92672>&amp;</span>args[<span style=color:#ae81ff>0</span>] {
</span></span><span style=display:flex><span>            RedisType::String { value } <span style=color:#f92672>=&gt;</span> value.to_owned(),
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>return</span> Err(<span style=color:#e6db74>&#34;SET: Unknown key format&#34;</span>.to_string())
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> value <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> <span style=color:#f92672>&amp;</span>args[<span style=color:#ae81ff>1</span>] {
</span></span><span style=display:flex><span>            RedisType::String { value } <span style=color:#f92672>=&gt;</span> value.to_owned(),
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>return</span> Err(<span style=color:#e6db74>&#34;SET: Unknown value format&#34;</span>.to_string())
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        state.keystore.insert(key, value);
</span></span><span style=display:flex><span>        Ok(RedisType::String { value: <span style=color:#e6db74>&#34;OK&#34;</span>.to_owned() })
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>m.insert(<span style=color:#e6db74>&#34;GET&#34;</span>, Command {
</span></span><span style=display:flex><span>    f: Box::new(<span style=color:#f92672>|</span>state, args<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> args.len() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Err(<span style=color:#e6db74>&#34;Expected: GET $key&#34;</span>.to_string());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> key <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> <span style=color:#f92672>&amp;</span>args[<span style=color:#ae81ff>0</span>] {
</span></span><span style=display:flex><span>            RedisType::String { value } <span style=color:#f92672>=&gt;</span> value.to_owned(),
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>return</span> Err(<span style=color:#e6db74>&#34;Expected: GET $key:String&#34;</span>.to_string())
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(<span style=color:#66d9ef>match</span> state.keystore.get(<span style=color:#f92672>&amp;</span>key) {
</span></span><span style=display:flex><span>            Some(value) <span style=color:#f92672>=&gt;</span> RedisType::String { value: <span style=color:#a6e22e>value</span>.to_owned() },
</span></span><span style=display:flex><span>            None <span style=color:#f92672>=&gt;</span> RedisType::NullString,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>That&rsquo;s not so bad. We do need to do some manual parsing of the <code>key</code> / <code>value</code> right now. I should probably macro that. But for the moment, it just works. Let&rsquo;s test it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.03s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>...<span style=color:#f92672>[</span>server<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ redis-cli
</span></span><span style=display:flex><span>...<span style=color:#f92672>[</span>client<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:29.755427Z  INFO server: Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:31.825408Z DEBUG server: Accepted connection from 127.0.0.1:60005
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:31.825627Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:60005<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:31.825674Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>27</span> bytes
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:31.825741Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005 Received: COMMAND <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;DOCS&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>client<span style=color:#f92672>]</span> 127.0.0.1:6379&gt; GET hello
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:33.413137Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>24</span> bytes
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:33.413269Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005 Received: GET <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>client<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>nil<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>client<span style=color:#f92672>]</span> 127.0.0.1:6379&gt; SET hello <span style=color:#e6db74>&#34;world&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:39.452693Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>35</span> bytes
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:39.452771Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005 Received: SET <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>}</span>, String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;world&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>client<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;OK&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>client<span style=color:#f92672>]</span> 127.0.0.1:6379&gt; GET hello
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:41.571335Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>24</span> bytes
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:41.571410Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:60005 Received: GET <span style=color:#f92672>[</span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>}]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>client<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;world&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>client<span style=color:#f92672>]</span> 127.0.0.1:6379&gt; EXIT
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> 2023-02-28T23:07:43.393666Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:60005<span style=color:#f92672>]</span> Ending connection
</span></span></code></pre></div><p>(I&rsquo;m not sure how to better print those&mldr;)</p><p>But it&rsquo;s totally working. We can <code>GET</code> values that aren&rsquo;t stored yet, <code>SET</code> them, and then <code>GET</code> them again.</p><p>Not so bad.</p><h2 id=testing-with-our-client>Testing with our client</h2><p>What about if we actually use our client?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo run --bin client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>redis-rs&gt; GET hello
</span></span><span style=display:flex><span>NullString
</span></span><span style=display:flex><span>redis-rs&gt; SET hello <span style=color:#e6db74>&#34;world&#34;</span>
</span></span><span style=display:flex><span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;OK&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>redis-rs&gt; GET hello
</span></span><span style=display:flex><span>String <span style=color:#f92672>{</span> value: <span style=color:#e6db74>&#34;\&#34;world\&#34;&#34;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Well that&rsquo;s actually really close! Except I totally don&rsquo;t parse or handle quotes correctly in my client. That&rsquo;s probably something I really should do&mldr; another day.</p><h2 id=full-source>Full source</h2><p>As always (although I don&rsquo;t know if I&rsquo;ve said it), the full source is <a href=https://github.com/jpverkamp/redis-rs/>on GitHub</a> with <a href=https://github.com/jpverkamp/redis-rs/tags>tags available</a> for the code at the state of each blog post.</p><h2 id=next-steps>Next steps</h2><ul><li>Implement the optional parameters of <code>SET</code><ul><li>Implement timing out and eviction of entries</li></ul></li><li>Implement another data type (sets, hashes, sorted sets, streams, etc)</li><li>Implement persistance to disk / backups</li><li>Improve the client to handle quoted strings<ul><li>Test the improved client against the official server</li></ul></li></ul><p>So much to do. Onward!</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
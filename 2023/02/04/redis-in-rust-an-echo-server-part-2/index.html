<!doctype html><html><head><title>Redis in Rust: An Echo Server [Part 2] â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Redis in Rust: An Echo Server [Part 2]</h1><div class=entry-meta><span class=entry-date>2023-02-04</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/01/31/cloning-redis-in-rust-resp-part-1/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/rust>Rust</a><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a class=taxonomy-value href=/programming/topics/networking>Networking</a><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2023/01/31/cloning-redis-in-rust-resp-part-1/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/redis>Redis</a><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/server>Server</a></li><li><a class=taxonomy-value href=/programming/topics/tcp>TCP</a><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2023/01/31/cloning-redis-in-rust-resp-part-1/ class=previous-link></a><a class=taxonomy-value href=/series/cloning-redis-in-rust>Cloning Redis in Rust</a><a href=https://blog.jverkamp.com/2023/02/09/redis-in-rust-a-repl-client-part-3/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2023/02/04/genuary-2023.04-intersections/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/02/05/genuary-2023.05-debug-view/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2023/02/04/genuary-2023.04-intersections/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2023/02/04/the-lord-of-the-rings-the-rings-of-power/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Following up from <a href=https://blog.jverkamp.com/2023/01/31/cloning-redis-in-rust-resp-part-1/>Cloning Redis in Rust: RESP [Part 1]</a>, we can parse the protocol. So now&mldr; let&rsquo;s do something with it.</p><p>The obvious(ish) next step, in my mind? Make a server. It&rsquo;s all going to be over the network eventually, so it&rsquo;s either here or storing data. Here it is!</p><p>Specifically, my goal is <em>not</em> to build the networking and data structures for this project from scratch. Where there are primitives or libraries that will do something like networking for me, I&rsquo;m going to use them.</p><p>Ergo:</p><ul><li><a href=https://docs.rs/tokio/latest/tokio/ target=_blank rel=noopener><code>tokio</code></a> for networking (+ async)</li><li><a href=https://docs.rs/tracing/latest/tracing/ target=_blank rel=noopener><code>tracing</code></a> for logging</li></ul><p>So, how do I write a simple server in Tokio?</p><nav id=TableOfContents><ul><li><a href=#im-listening>I&rsquo;m listening!</a></li><li><a href=#what-did-you-say-again>What did you say again?</a></li><li><a href=#actually-asynchronously>Actually asynchronously</a></li><li><a href=#doing-the-lumberjack-thing>Doing the lumberjack thing.</a></li><li><a href=#so-werent-we-doing-something-with-redis>So&mldr; weren&rsquo;t we doing something with Redis?</a></li><li><a href=#is-that-it>Is that it?</a></li></ul></nav><h2 id=im-listening>I&rsquo;m listening!</h2><p>Okay, very first version. Let&rsquo;s start up Tokio, listen on a port, get a client, and say hello.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::net::{TcpListener, TcpStream};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::io::{AsyncWriteExt};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> addr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0:6379&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> listener <span style=color:#f92672>=</span> TcpListener::bind(addr).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (stream, _) <span style=color:#f92672>=</span> listener.accept().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> _result <span style=color:#f92672>=</span> handle(stream).<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>TcpStream</span>) -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    stream.write_all(<span style=color:#e6db74>&#34;Hello world!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>.as_bytes()).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>One thing to note is that this does have <code>cargo add tokio --features full</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo add tokio --features full
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Updating crates.io index
</span></span><span style=display:flex><span>      Adding tokio v1.25.0 to dependencies.
</span></span><span style=display:flex><span>             Features:
</span></span><span style=display:flex><span>             + bytes
</span></span><span style=display:flex><span>             + fs
</span></span><span style=display:flex><span>             + full
</span></span><span style=display:flex><span>             + io-std
</span></span><span style=display:flex><span>             + io-util
</span></span><span style=display:flex><span>             + libc
</span></span><span style=display:flex><span>             + macros
</span></span><span style=display:flex><span>             + memchr
</span></span><span style=display:flex><span>             + net
</span></span><span style=display:flex><span>             + num_cpus
</span></span><span style=display:flex><span>             + parking_lot
</span></span><span style=display:flex><span>             + process
</span></span><span style=display:flex><span>             + rt
</span></span><span style=display:flex><span>             + rt-multi-thread
</span></span><span style=display:flex><span>             + signal
</span></span><span style=display:flex><span>             + signal-hook-registry
</span></span><span style=display:flex><span>             + socket2
</span></span><span style=display:flex><span>             + sync
</span></span><span style=display:flex><span>             + time
</span></span><span style=display:flex><span>             + tokio-macros
</span></span><span style=display:flex><span>             - mio
</span></span><span style=display:flex><span>             - stats
</span></span><span style=display:flex><span>             - test-util
</span></span><span style=display:flex><span>             - tracing
</span></span><span style=display:flex><span>             - windows-sys
</span></span></code></pre></div><p>That gives us the macro for <code>#[tokio::main]</code> (which allows us to make <code>main</code> <code>async</code> and handles setting up a task runner for us), the <code>TcpListener</code> and <code>TcpStream</code> modules that are specific to Tokio, and also <code>AsyncWriteExt</code> which lets us call <code>stream.write_all</code>. I&rsquo;m not 100% sure why it&rsquo;s all broken up like that. Binary size? Compilation time?</p><p>In any case, it&rsquo;s not much code. It just starts up a server with <code>TcpListener::bind</code>, waiting for connections. For each connection, just say hi.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>$ cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 1.02s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client</span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hello world!
</span></span></code></pre></div><p>Sweet.</p><h2 id=what-did-you-say-again>What did you say again?</h2><p>Okay, so the server can talk to the client. What about the reverse? Can we read from the client?</p><p>To be able to <code>stream.read</code>, we need a buffer for it to read into. Handle that and go ahead and do the <code>.await?</code> thing to allow it to run <code>async</code> (although we&rsquo;re not actually doing that well yet, I&rsquo;ll come back to that&mldr;) and return errors immediately (the <code>?</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::net::{TcpListener, TcpStream};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::io::{AsyncReadExt, AsyncWriteExt};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> addr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0:6379&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> listener <span style=color:#f92672>=</span> TcpListener::bind(addr).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (stream, _) <span style=color:#f92672>=</span> listener.accept().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> _result <span style=color:#f92672>=</span> handle(stream).<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>TcpStream</span>) -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    stream.write_all(<span style=color:#e6db74>&#34;Hello world!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>.as_bytes()).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> buf <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; <span style=color:#ae81ff>1024</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> bytes_read <span style=color:#f92672>=</span> stream.read(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> buf).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> bytes_read <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;From client: </span><span style=color:#e6db74>{:?}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#f92672>&amp;</span>buf[<span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>bytes_read]);
</span></span><span style=display:flex><span>        stream.write_all(<span style=color:#f92672>&amp;</span>buf[<span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>bytes_read]).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Trying it out?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>$ cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.52s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>From client: <span style=color:#f92672>[</span>72, 111, 119, 32, 97, 114, 101, 32, 121, 111, 117, 63, 10<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>From client: <span style=color:#f92672>[</span>71, 111, 111, 100, 32, 98, 121, 101, 10<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client</span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hello world!
</span></span><span style=display:flex><span>How are you?
</span></span><span style=display:flex><span>How are you?
</span></span><span style=display:flex><span>Good bye
</span></span><span style=display:flex><span>Good bye
</span></span><span style=display:flex><span>^C
</span></span></code></pre></div><p>Sweet.</p><p>But we have a bit of a problem:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.44s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1</span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2</span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 RECV: Hello world!</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 SEND: Hello from 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [72, 101, 108, 108, 111, 32, 102, 114, 111, 109, 32, 49, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 RECV: Hello from 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 SEND: Hello from 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 SEND: Hello? Are you listening? </span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 SEND: Hello again from 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [72, 101, 108, 108, 111, 32, 50, 32, 102, 114, 111, 109, 32, 49, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 RECV: Hello again from 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 CLOSE</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 RECV: Hello world!</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [72, 101, 108, 108, 111, 32, 102, 114, 111, 109, 32, 50, 10, 72, 101, 108, 108, 111, 32, 50, 32, 102, 114, 111, 109, 32, 50, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 RECV: Hello from 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 RECV: Hello? Are you listening? </span>
</span></span></code></pre></div><p>In a nutshell, we&rsquo;re not actually handling these clients asynchronously at all. Luckily, netcat buffered for us, so when the first client let go, the second client got <code>accepted</code> and the server responded. But what we really want is to be able to talk to 2 (or even more?!) clients at the same time.</p><h2 id=actually-asynchronously>Actually asynchronously</h2><p>It&rsquo;s actually amazing how easy this part is with Tokio:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::net::{TcpListener, TcpStream};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::io::{AsyncReadExt, AsyncWriteExt};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> addr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0:6379&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> listener <span style=color:#f92672>=</span> TcpListener::bind(addr).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (stream, _) <span style=color:#f92672>=</span> listener.accept().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        tokio::spawn(<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> _result <span style=color:#f92672>=</span> handle(stream).<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>TcpStream</span>) -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>That&rsquo;s it. That&rsquo;s the difference. We just need to wrap the call to <code>handle</code> in <code>tokio::spawn</code> and essentially for free, the two can run async along side one another:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 1.71s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 RECV: Hello world!</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 SEND: Hello from 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [72, 101, 108, 108, 111, 32, 102, 114, 111, 109, 32, 49, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 RECV: Hello from 1</span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 RECV: Hello world!</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 SEND: Hello again from 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [72, 101, 108, 108, 111, 32, 97, 103, 97, 105, 110, 32, 102, 114, 111, 109, 32, 49, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 RECV: Hello again from 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 SEND: Hello from 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [72, 101, 108, 108, 111, 32, 102, 114, 111, 109, 32, 50, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 RECV: Hello from 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 SEND: Hello again from 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [72, 101, 108, 108, 111, 32, 97, 103, 97, 105, 110, 32, 102, 114, 111, 109, 32, 50, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 RECV: Hello again from 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 SEND: Good bye</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [71, 111, 111, 100, 32, 98, 121, 101, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 RECV: Good bye</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 2 CLOSE</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 SEND: Good bye</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server: From client: [71, 111, 111, 100, 32, 98, 121, 101, 10]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 RECV: Good bye</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client 1 CLOSE</span>
</span></span></code></pre></div><p>Nice!</p><h2 id=doing-the-lumberjack-thing>Doing the lumberjack thing.</h2><p>One thing that I always want to build in relatively early is good logging. For Python, I almost always use the built in <code>logging</code> module + <a href=https://pypi.org/project/coloredlogs/ target=_blank rel=noopener><code>coloredlogs</code></a>. For Rust, the equivalent would seem to be <a href=https://docs.rs/tracing/latest/tracing/ target=_blank rel=noopener><code>tracing</code></a>.</p><p>So let&rsquo;s add that!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo add tracing tracing_subscriber
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Updating crates.io index
</span></span><span style=display:flex><span>warning: translating <span style=color:#e6db74>`</span>tracing_subscriber<span style=color:#e6db74>`</span> to <span style=color:#e6db74>`</span>tracing-subscriber<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      Adding tracing v0.1.37 to dependencies.
</span></span><span style=display:flex><span>             Features:
</span></span><span style=display:flex><span>             + attributes
</span></span><span style=display:flex><span>             + std
</span></span><span style=display:flex><span>             + tracing-attributes
</span></span><span style=display:flex><span>             - async-await
</span></span><span style=display:flex><span>             - log
</span></span><span style=display:flex><span>             - log-always
</span></span><span style=display:flex><span>             - max_level_debug
</span></span><span style=display:flex><span>             - max_level_error
</span></span><span style=display:flex><span>             - max_level_info
</span></span><span style=display:flex><span>             - max_level_off
</span></span><span style=display:flex><span>             - max_level_trace
</span></span><span style=display:flex><span>             - max_level_warn
</span></span><span style=display:flex><span>             - release_max_level_debug
</span></span><span style=display:flex><span>             - release_max_level_error
</span></span><span style=display:flex><span>             - release_max_level_info
</span></span><span style=display:flex><span>             - release_max_level_off
</span></span><span style=display:flex><span>             - release_max_level_trace
</span></span><span style=display:flex><span>             - release_max_level_warn
</span></span><span style=display:flex><span>             - valuable
</span></span><span style=display:flex><span>      Adding tracing-subscriber v0.3.16 to dependencies.
</span></span><span style=display:flex><span>             Features:
</span></span><span style=display:flex><span>             + alloc
</span></span><span style=display:flex><span>             + ansi
</span></span><span style=display:flex><span>             + fmt
</span></span><span style=display:flex><span>             + nu-ansi-term
</span></span><span style=display:flex><span>             + registry
</span></span><span style=display:flex><span>             + sharded-slab
</span></span><span style=display:flex><span>             + smallvec
</span></span><span style=display:flex><span>             + std
</span></span><span style=display:flex><span>             + thread_local
</span></span><span style=display:flex><span>             + tracing-log
</span></span><span style=display:flex><span>             - env-filter
</span></span><span style=display:flex><span>             - json
</span></span><span style=display:flex><span>             - local-time
</span></span><span style=display:flex><span>             - matchers
</span></span><span style=display:flex><span>             - once_cell
</span></span><span style=display:flex><span>             - parking_lot
</span></span><span style=display:flex><span>             - regex
</span></span><span style=display:flex><span>             - serde
</span></span><span style=display:flex><span>             - serde_json
</span></span><span style=display:flex><span>             - time
</span></span><span style=display:flex><span>             - tracing
</span></span><span style=display:flex><span>             - tracing-serde
</span></span><span style=display:flex><span>             - valuable
</span></span><span style=display:flex><span>             - valuable-serde
</span></span><span style=display:flex><span>             - valuable_crate
</span></span></code></pre></div><p>It&rsquo;s actually pretty cool that you can actually use <code>--features max_level_info</code> to just automatically log up to info for free. That&rsquo;s neat. But for now, I&rsquo;ll use <code>tracing_subscribe</code> manually.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::net::SocketAddr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::net::{TcpListener, TcpStream};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::io::{AsyncReadExt, AsyncWriteExt};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tracing_subscriber;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    tracing_subscriber::fmt::init();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> addr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0:6379&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> listener <span style=color:#f92672>=</span> TcpListener::bind(addr).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[server] Listening on {addr}&#34;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (stream, addr) <span style=color:#f92672>=</span> listener.accept().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[server] Accepted connection from {addr:?}&#34;</span>);
</span></span><span style=display:flex><span>        tokio::spawn(<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> Err(e) <span style=color:#f92672>=</span> handle(stream, addr).<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>                tracing::warn!(<span style=color:#e6db74>&#34;[server] An error occurred: {e:?}&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>TcpStream</span>, addr: <span style=color:#a6e22e>SocketAddr</span>) -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[{addr}] Accepted connection&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> buf <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; <span style=color:#ae81ff>1024</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> bytes_read <span style=color:#f92672>=</span> stream.read(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> buf).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> bytes_read <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[{addr}] Received {bytes_read} bytes&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> string <span style=color:#f92672>=</span> String::from_utf8_lossy(<span style=color:#f92672>&amp;</span>buf[<span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>bytes_read]);
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[{addr} Received {string:?}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stream.write_all(string.as_bytes()).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[{addr}] Ending connection&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Mostly, we just have a bunch of <code>tracing::info!</code> and <code>tracing::debug!</code> calls around. I did try to get spans working, but they seemed to act funny with multiple threads, so this is enough for now.</p><p>Checking it out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.56s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client</span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client I/O</span>
</span></span><span style=display:flex><span><span style=color:#75715e># &gt; Hello</span>
</span></span><span style=display:flex><span><span style=color:#75715e># &lt; Hello</span>
</span></span><span style=display:flex><span><span style=color:#75715e># &gt; Goodbye</span>
</span></span><span style=display:flex><span><span style=color:#75715e># &lt; Goodbye</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server logs</span>
</span></span><span style=display:flex><span>2023-02-05T02:23:44.647267Z  INFO server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span>2023-02-05T02:23:47.556100Z DEBUG server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Accepted connection from 127.0.0.1:53986
</span></span><span style=display:flex><span>2023-02-05T02:23:47.556184Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:53986<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-05T02:23:49.148031Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:53986<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>6</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:23:49.148187Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:53986 Received <span style=color:#e6db74>&#34;Hello\n&#34;</span>
</span></span><span style=display:flex><span>2023-02-05T02:23:52.525595Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:53986<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>8</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:23:52.525690Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:53986 Received <span style=color:#e6db74>&#34;Goodbye\n&#34;</span>
</span></span><span style=display:flex><span>2023-02-05T02:23:53.329806Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:53986<span style=color:#f92672>]</span> Ending connection
</span></span></code></pre></div><p>That&rsquo;s pretty cool. And it does work fine with multiple clients as well:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.10s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>2023-02-05T02:26:03.249739Z  INFO server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span>2023-02-05T02:26:07.012916Z DEBUG server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Accepted connection from 127.0.0.1:54523
</span></span><span style=display:flex><span>2023-02-05T02:26:07.013035Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:54523<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-05T02:26:08.963769Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54523<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>13</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:26:08.964088Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54523 Received <span style=color:#e6db74>&#34;Hello from 1\n&#34;</span>
</span></span><span style=display:flex><span>2023-02-05T02:26:10.421350Z DEBUG server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> accepted connection from 127.0.0.1:54527
</span></span><span style=display:flex><span>2023-02-05T02:26:10.421475Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:54527<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-05T02:26:12.230319Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54527<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>13</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:26:12.230440Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54527 Received <span style=color:#e6db74>&#34;Hello from 2\n&#34;</span>
</span></span><span style=display:flex><span>2023-02-05T02:26:15.365158Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54523<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>11</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:26:15.365239Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54523 Received <span style=color:#e6db74>&#34;Still here\n&#34;</span>
</span></span><span style=display:flex><span>2023-02-05T02:26:17.203135Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54527<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>9</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:26:17.203212Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54527 Received <span style=color:#e6db74>&#34;Good bye\n&#34;</span>
</span></span><span style=display:flex><span>2023-02-05T02:26:19.171721Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54523<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>9</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:26:19.171809Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:54523 Received <span style=color:#e6db74>&#34;Good bye\n&#34;</span>
</span></span><span style=display:flex><span>2023-02-05T02:26:19.507445Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:54523<span style=color:#f92672>]</span> Ending connection
</span></span><span style=display:flex><span>2023-02-05T02:26:20.473141Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:54527<span style=color:#f92672>]</span> Ending connection
</span></span></code></pre></div><h2 id=so-werent-we-doing-something-with-redis>So&mldr; weren&rsquo;t we doing something with Redis?</h2><p>Right. Redis. This is already getting a bit long, so for now, let&rsquo;s just assume we have a client that knows how to speak RESP (see <a href=https://blog.jverkamp.com/2023/01/31/cloning-redis-in-rust-resp-part-1/>Cloning Redis in Rust: RESP [Part 1]</a>).</p><p>Take that, parse it, log the parsed version, turn it back into a string, and send it back.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::net::SocketAddr;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::<span style=color:#66d9ef>str</span>::FromStr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> redis_rs::RedisType;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::net::{TcpListener, TcpStream};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::io::{AsyncReadExt, AsyncWriteExt};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tracing_subscriber;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    tracing_subscriber::fmt::init();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> addr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0:6379&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> listener <span style=color:#f92672>=</span> TcpListener::bind(addr).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[server] Listening on {addr}&#34;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (stream, addr) <span style=color:#f92672>=</span> listener.accept().<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[server] Accepted connection from {addr:?}&#34;</span>);
</span></span><span style=display:flex><span>        tokio::spawn(<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> Err(e) <span style=color:#f92672>=</span> handle(stream, addr).<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>                tracing::warn!(<span style=color:#e6db74>&#34;[server] An error occurred: {e:?}&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>TcpStream</span>, addr: <span style=color:#a6e22e>SocketAddr</span>) -&gt; <span style=color:#a6e22e>std</span>::io::Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[{addr}] Accepted connection&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> buf <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; <span style=color:#ae81ff>1024</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> bytes_read <span style=color:#f92672>=</span> stream.read(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> buf).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> bytes_read <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[{addr}] Received {bytes_read} bytes&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> string <span style=color:#f92672>=</span> String::from_utf8_lossy(<span style=color:#f92672>&amp;</span>buf[<span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>bytes_read]);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> RedisType::from_str(<span style=color:#f92672>&amp;</span>string) {
</span></span><span style=display:flex><span>            Ok(data) <span style=color:#f92672>=&gt;</span> data,
</span></span><span style=display:flex><span>            Err(err) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                tracing::warn!(<span style=color:#e6db74>&#34;[{addr}] Error parsing input: {err:?}&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        tracing::debug!(<span style=color:#e6db74>&#34;[{addr} Received {data:?}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stream.write_all(data.to_string().as_bytes()).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tracing::info!(<span style=color:#e6db74>&#34;[{addr}] Ending connection&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The main difference is that we&rsquo;re taking the <code>buf</code>, converting it into a <code>string</code> (for reasons?), turning that into a <code>RedisType</code>, logging it, and then turning it back <code>to_string().as_bytes()</code> to send back to the client.</p><p>Whew.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Compiling redis-rs v0.1.0 <span style=color:#f92672>(</span>/Users/jp/Projects/redis-rs<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 1.02s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client</span>
</span></span><span style=display:flex><span>$ nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; :42
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server logs</span>
</span></span><span style=display:flex><span>2023-02-05T02:29:40.849183Z  INFO server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span>2023-02-05T02:29:43.191540Z DEBUG server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Accepted connection from 127.0.0.1:55112
</span></span><span style=display:flex><span>2023-02-05T02:29:43.191725Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:55112<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-05T02:29:44.694273Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:55112<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>4</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:29:44.694439Z  WARN server: <span style=color:#f92672>[</span>127.0.0.1:55112<span style=color:#f92672>]</span> Error parsing input: InvalidSuffix
</span></span></code></pre></div><p>Hmm. It turns out that the version of <code>nc</code> I have doesn&rsquo;t have a <code>--crlf</code> flag to send <code>\r\n</code> as we&rsquo;re expecting. So&mldr; we have to cheat a bit with echo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.10s
</span></span><span style=display:flex><span>     Running <span style=color:#e6db74>`</span>target/debug/server<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client </span>
</span></span><span style=display:flex><span>$ echo -ne <span style=color:#e6db74>&#39;:42\r\n&#39;</span> | nc localhost <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>:42
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server logs</span>
</span></span><span style=display:flex><span>2023-02-05T02:30:45.463949Z  INFO server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Listening on 0.0.0.0:6379
</span></span><span style=display:flex><span>2023-02-05T02:30:50.970001Z DEBUG server: <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span> Accepted connection from 127.0.0.1:55312
</span></span><span style=display:flex><span>2023-02-05T02:30:50.970090Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:55312<span style=color:#f92672>]</span> Accepted connection
</span></span><span style=display:flex><span>2023-02-05T02:30:50.970109Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:55312<span style=color:#f92672>]</span> Received <span style=color:#ae81ff>5</span> bytes
</span></span><span style=display:flex><span>2023-02-05T02:30:50.970130Z DEBUG server: <span style=color:#f92672>[</span>127.0.0.1:55312 Received Integer <span style=color:#f92672>{</span> value: <span style=color:#ae81ff>42</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>2023-02-05T02:30:50.970145Z  INFO server: <span style=color:#f92672>[</span>127.0.0.1:55312<span style=color:#f92672>]</span> Ending connection
</span></span></code></pre></div><p>Much better!</p><p>So now, we can receive proper RESP data and parse it! Sweet.</p><h2 id=is-that-it>Is that it?</h2><p>For now, that&rsquo;s it.</p><p>Next up though, I think I&rsquo;ll probably want to actually add a few commands to the server. It looks like the expected input is always an RESP Array of Bulk Strings. And probably write a simple client that can turn commands into this, so that I don&rsquo;t have to keep using echo.</p><p>My goal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin server
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ RUST_LOG<span style=color:#f92672>=</span>debug cargo run --bin client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; SET greeting <span style=color:#e6db74>&#34;Hello world!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;OK&#34;</span>
</span></span><span style=display:flex><span>&gt; GET greeting
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;Hello world!&#34;</span>
</span></span></code></pre></div><p>But that is for another day.</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
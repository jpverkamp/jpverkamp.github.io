<!doctype html><html>
<head>
<title>Automagically storing Python objects in Redis â€“ jverkamp.com</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous>
<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet>
<link rel=stylesheet href=/custom.css defer>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script>
</head>
<body>
<div id=wrapper><header id=page-header role=banner>
<h1><a href=/>JP's Blog</a></h1>
<ul id=page-header-links>
<li>
<a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a>
</li>
<li>
<form action=//www.google.com/search method=get onsubmit="(function(a){a.q.value='site:blog.jverkamp.com '+a.qfront.value})(this)" class="navbar-form navbar-right" role=search _lpchecked=1>
<div class=form-group>
<input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button>
</div>
</form>
</li>
</ul>
<nav id=header-navigation role=navigation class=ribbon>
<ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li>
</ul>
</nav>
</header>
<div id=page-content-wrapper>
<div id=page-content><article>
<header>
<h1 class=entry-title>Automagically storing Python objects in Redis</h1>
<div class=entry-meta><span class=entry-date>2015-07-16</span>
</div>
<div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li>
<a class=taxonomy-key href=/programming/languages/>Languages</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/07/10/backing-up-moves-data/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li></ul>
</li><li>
<a class=taxonomy-key href=/programming/topics/>Topics</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/databases>Databases</a></li><li><a class=taxonomy-value href=/programming/topics/redis>Redis</a><a href=https://blog.jverkamp.com/2020/07/14/directly-monitoring-sidekiq-in-redis/ class=next-link></a></li></ul>
</li><li><a class=taxonomy-key href=/programming>programming</a>
<ul>
<li><a href=https://blog.jverkamp.com/2015/07/10/backing-up-moves-data/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link>Next</a></ul>
</li><li><a class=taxonomy-key href=/>All Posts</a>
<ul>
<li><a href=https://blog.jverkamp.com/2015/07/11/the-fuller-memorandum/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/07/17/the-apocalypse-codex/ class=next-link>Next</a></ul>
</li></ul>
</div>
</div>
</header>
<div class=entry-content><p>When you&rsquo;re starting out on a simple web application, eventually<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> you will reach the point where you need to store some form of persistant data. Basically, you have three options<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p>
<ul>
<li>Store the information in flat files on the file system</li>
<li>Store the information in a database (<a href=https://www.mysql.com/>MySQL</a>, <a href=https://www.sqlite.org/>SQLite</a> etc)</li>
<li>Store the information in a key/value store (<a href=https://www.mongodb.org/>mongoDB</a>, <a href=http://redis.io/>reddis</a>)</li>
</ul>
<p>There are all manner of pros and cons to each, in particular how easy they are to get started in, how well they fit the data you are using, and how well they will scale horizontally (adding more machines rather than bigger ones).</p>
<p>For the project that I was working on (I&rsquo;ll post about it eventually), I didn&rsquo;t have terribly many different kinds of data to store, so it would be easy enough to start with anything. I started with a simple file system backing, with one json file per object that I was storing. That worked well enough, but I didn&rsquo;t particularly care for having to write all of the code myself to join / find child objects. I wanted something a little more powerful.</p>
<p>Next, I considered using a database with an <a href=https://en.wikipedia.org/wiki/ORM>Object-relational mapping</a> layer. That would let me define everything as Python objects and let the library handle all of the mappings to the actual database. That way, I could write a bare minimum of code for my actual models. Unfortunately, the data wasn&rsquo;t particularly well structured for a relational database, being more hierarchical in struture. It&rsquo;s entirely possible to represent hierarchical data in a relational database, it&rsquo;s just not what they are best suited for.</p>
<p>Finally, I came to Redis. I&rsquo;ve used Redis in a few projects at work and come to really like it. It works great as a simple key/value store and even better when you start taking advatage of some of their other data structures. In particular, Redis hashes and lists map nicely to Python dicts and lists. So that&rsquo;s what I ended up doing: Writing a pair of base classes (<code>RedisDict</code> and <code>RedisList</code>) which to the programmer act just like a Python dict or list, but actually store all of their data transparently in Redis.</p>
<p>Let&rsquo;s get to it.</p>
<p>First, there is a bit of shared code that both <code>RedisDict</code> and <code>RedisList</code> share, which we can factor out into a base class for the two of them: <code>RedisObject</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> base64
<span style=color:#f92672>import</span> json
<span style=color:#f92672>import</span> redis
<span style=color:#f92672>import</span> os

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisObject</span>(object):
    <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>    A base object backed by redis.
</span><span style=color:#e6db74>    Genrally, use RedisDict or RedisList rather than this directly.
</span><span style=color:#e6db74>    &#39;&#39;&#39;</span>

    <span style=color:#66d9ef>def</span> __init__(self, id <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
        <span style=color:#e6db74>&#39;&#39;&#39;Create or load a RedisObject.&#39;&#39;&#39;</span>

        self<span style=color:#f92672>.</span>redis <span style=color:#f92672>=</span> redis<span style=color:#f92672>.</span>StrictRedis(host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;redis&#39;</span>, decode_responses <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>)

        <span style=color:#66d9ef>if</span> id:
            self<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> id
        <span style=color:#66d9ef>else</span>:
            self<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>urlsafe_b64encode(os<span style=color:#f92672>.</span>urandom(<span style=color:#ae81ff>9</span>))<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)

        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>id:
            self<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>__name__ <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>id


    <span style=color:#66d9ef>def</span> __bool__(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Test if an object currently exists&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>exists(self<span style=color:#f92672>.</span>id)

    <span style=color:#66d9ef>def</span> __eq__(self, other):
        <span style=color:#e6db74>&#39;&#39;&#39;Tests if two redis objects are equal (they have the same key)&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>id <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span>id

    <span style=color:#66d9ef>def</span> __str__(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Return this object as a string for testing purposes.&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>id

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>delete</span>(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Delete this object from redis&#39;&#39;&#39;</span>

        self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>delete(self<span style=color:#f92672>.</span>id)

    <span style=color:#a6e22e>@staticmethod</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decode_value</span>(type, value):
        <span style=color:#e6db74>&#39;&#39;&#39;Decode a value if it is non-None, otherwise, decode with no arguments.&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>if</span> value <span style=color:#f92672>==</span> <span style=color:#66d9ef>None</span>:
            <span style=color:#66d9ef>return</span> type()
        <span style=color:#66d9ef>else</span>:
            <span style=color:#66d9ef>return</span> type(value)

    <span style=color:#a6e22e>@staticmethod</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encode_value</span>(value):
        <span style=color:#e6db74>&#39;&#39;&#39;Encode a value using json.dumps, with default = str&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>return</span> str(value)
</code></pre></div><p>Most of that should be pretty straight forward. The basic idea is that any <code>RedisObject</code>, be it a <code>RedisDict</code> or a <code>RedisList</code> has an ID. This will be used as the key that Redis stores the object under. In particular, I&rsquo;ve used a neat (in my opinion) trick to generate random alphanumeric identifiers:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>&gt;&gt;&gt;</span> base64<span style=color:#f92672>.</span>urlsafe_b64encode(os<span style=color:#f92672>.</span>urandom(<span style=color:#ae81ff>9</span>))<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;UQTfwq8XLZr6&#39;</span>
</code></pre></div><p>Neat. Alternatively, if you want to use a specific value for an ID (such as a user&rsquo;s email address), you can just specify that instead. Next, the <code>__bool__</code> method will make a <code>RedisObject</code> &lsquo;truthy&rsquo;. You can use Python&rsquo;s <code>if</code> to tell if an object acutally exists or not. Finally, <code>delete</code>. I wanted to use <code>__del__</code> originally, but that actually gets called when an object is garbage collected, which doesn&rsquo;t quite work for this usage<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p>
<p>Finally, static helper functions <code>decode_value</code> and <code>encode_value</code>. These will be used in a bit, since Redis only stores strings. Thus a <code>RedisObject</code> stores the type of each value and needs to know how to read/write that in a systematic way. For that, I&rsquo;m using Python&rsquo;s <code>json</code> encoding, falling back to <code>str</code> (and thus the <code>__str__</code> magic function on objects). This will deal nicely with most default Python objects and can be easily extended for all manner of more interesting ones if you&rsquo;d like (I&rsquo;ve done it for <code>RedisObject</code>s).</p>
<p>One oddity that you&rsquo;ve probably noticed is that I&rsquo;ve hard coded the Reids IP to connect to. I&rsquo;m using <a href=https://github.com/docker/compose>docker-compose</a> to run my project, which sets up hostnames automagically within the various containers.</p>
<p>Next, <code>RedisDict</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> json
<span style=color:#f92672>import</span> redis

<span style=color:#f92672>from</span> lib.RedisObject <span style=color:#f92672>import</span> RedisObject

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisDict</span>(RedisObject):
    <span style=color:#e6db74>&#39;&#39;&#39;An equivalent to dict where all keys/values are stored in Redis.&#39;&#39;&#39;</span>

    <span style=color:#66d9ef>def</span> __init__(self, id <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>, fields <span style=color:#f92672>=</span> {}, defaults <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
        <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>        Create a new RedisObject
</span><span style=color:#e6db74>        id: If specified, use this as the redis ID, otherwise generate a random ID.
</span><span style=color:#e6db74>        fields: A map of field name to construtor used to read values from redis.
</span><span style=color:#e6db74>            Objects will be written with json.dumps with default = str, so override __str__ for custom objects.
</span><span style=color:#e6db74>            This should generally be set by the subobject&#39;s constructor.
</span><span style=color:#e6db74>        defaults: A map of field name to values to store when constructing the object.
</span><span style=color:#e6db74>        &#39;&#39;&#39;</span>

        RedisObject<span style=color:#f92672>.</span>__init__(self, id)

        self<span style=color:#f92672>.</span>fields <span style=color:#f92672>=</span> fields

        <span style=color:#66d9ef>if</span> defaults:
            <span style=color:#66d9ef>for</span> key, val <span style=color:#f92672>in</span> defaults<span style=color:#f92672>.</span>items():
                self[key] <span style=color:#f92672>=</span> val

    <span style=color:#66d9ef>def</span> __getitem__(self, key):
        <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>        Load a field from this redis object.
</span><span style=color:#e6db74>        Keys that were not specified in self.fields will raise an exception.
</span><span style=color:#e6db74>        Keys that have not been set (either in defaults or __setitem__) will return the default for their type (if set)
</span><span style=color:#e6db74>        &#39;&#39;&#39;</span>

        <span style=color:#66d9ef>if</span> key <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;id&#39;</span>:
            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>id

        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> key <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>fields:
            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>KeyError</span>(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> not found in </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(key, self))

        <span style=color:#66d9ef>return</span> RedisObject<span style=color:#f92672>.</span>decode_value(self<span style=color:#f92672>.</span>fields[key], self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>hget(self<span style=color:#f92672>.</span>id, key))

    <span style=color:#66d9ef>def</span> __setitem__(self, key, val):
        <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>        Store a value in this redis object.
</span><span style=color:#e6db74>        Keys that were not specified in self.fields will raise an exception.
</span><span style=color:#e6db74>        Keys will be stored with json.dumps with a default of str, so override __str__ for custom objects.
</span><span style=color:#e6db74>        &#39;&#39;&#39;</span>

        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> key <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>fields:
            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>KeyError</span>(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> not found in </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(key, self))

        self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>hset(self<span style=color:#f92672>.</span>id, key, RedisObject<span style=color:#f92672>.</span>encode_value(val))

    <span style=color:#66d9ef>def</span> __iter__(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Return (key, val) pairs for all values stored in this RedisDict.&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>yield</span> (<span style=color:#e6db74>&#39;id&#39;</span>, self<span style=color:#f92672>.</span>id<span style=color:#f92672>.</span>rsplit(<span style=color:#e6db74>&#39;:&#39;</span>, <span style=color:#ae81ff>1</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])

        <span style=color:#66d9ef>for</span> key <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>fields:
            <span style=color:#66d9ef>yield</span> (key, self[key])
</code></pre></div><p>Basically, there are three interesting parts to this code: <code>__init__</code> stores the fields that this object has (and should be set by the constructors in subclasses) and can also be used as as a constructor for new objects. <code>__get/setitem__</code> will load/store items via Redis. Given the <code>encode/decode_value</code> functions in <code>RedisObject</code>, this is actually really straight forward.</p>
<p>So how would you use something like this?</p>
<p>Here&rsquo;s is most of the <code>User</code> class from the project I am working on:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> bcrypt

<span style=color:#f92672>import</span> lib
<span style=color:#f92672>import</span> models
<span style=color:#f92672>import</span> utils

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>(lib<span style=color:#f92672>.</span>RedisDict):
    <span style=color:#e6db74>&#39;&#39;&#39;A user. Duh.&#39;&#39;&#39;</span>

    <span style=color:#66d9ef>def</span> __init__(self, id <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>, email <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>, <span style=color:#f92672>**</span>defaults):

        <span style=color:#75715e># Use email as id, if specified</span>
        <span style=color:#66d9ef>if</span> email:
            id <span style=color:#f92672>=</span> email
            defaults[<span style=color:#e6db74>&#39;email&#39;</span>] <span style=color:#f92672>=</span> email

        lib<span style=color:#f92672>.</span>RedisDict<span style=color:#f92672>.</span>__init__(
            self,
            id <span style=color:#f92672>=</span> email,
            fields <span style=color:#f92672>=</span> {
                <span style=color:#e6db74>&#39;name&#39;</span>: str,
                <span style=color:#e6db74>&#39;email&#39;</span>: str,
                <span style=color:#e6db74>&#39;password&#39;</span>: str,
                <span style=color:#e6db74>&#39;friends&#39;</span>: lib<span style=color:#f92672>.</span>RedisList<span style=color:#f92672>.</span>as_child(self, <span style=color:#e6db74>&#39;friends&#39;</span>, models<span style=color:#f92672>.</span>User),
            },
            defaults <span style=color:#f92672>=</span> defaults
        )

    <span style=color:#66d9ef>def</span> __setitem__(self, key, val):
        <span style=color:#e6db74>&#39;&#39;&#39;Override the behavior if user is trying to change the password&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>if</span> key <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;password&#39;</span>:
            val <span style=color:#f92672>=</span> bcrypt<span style=color:#f92672>.</span>hashpw(
                val<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>),
                bcrypt<span style=color:#f92672>.</span>gensalt()
            )<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)

        lib<span style=color:#f92672>.</span>RedisDict<span style=color:#f92672>.</span>__setitem__(self, key, val)

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>verifyPassword</span>(self, testPassword):
        <span style=color:#e6db74>&#39;&#39;&#39;Verify if a given password is correct&#39;&#39;&#39;</span>

        hashedTestPassword <span style=color:#f92672>=</span> bcrypt<span style=color:#f92672>.</span>hashpw(
            testPassword<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>),
            self[<span style=color:#e6db74>&#39;password&#39;</span>]<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
        )<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)

        <span style=color:#66d9ef>return</span> hashedTestPassword <span style=color:#f92672>==</span> self[<span style=color:#e6db74>&#39;password&#39;</span>]
</code></pre></div><p>A <code>User</code> will have four fields: a <code>name</code>, an <code>email</code>, a <code>password</code>, and a list of <code>friends</code> (we&rsquo;ll get to how that works in a bit). Then, I&rsquo;ve added some custom code to automatically store passwords using <a href=https://en.wikipedia.org/wiki/bcrypt>bcrypt</a><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>. You can use it just like you would a <code>dict</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>&gt;&gt;&gt;</span> han <span style=color:#f92672>=</span> User(
<span style=color:#f92672>...</span>     name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Luke Skywalker&#39;</span>,
<span style=color:#f92672>...</span>     email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;luke@rebel-alliance.io&#39;</span>,
<span style=color:#f92672>...</span>     password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TheForce&#39;</span>,
<span style=color:#f92672>...</span> )
<span style=color:#f92672>...</span>

<span style=color:#f92672>&gt;&gt;&gt;</span> print(luke[<span style=color:#e6db74>&#39;name&#39;</span>])
Luke Skywalker

<span style=color:#f92672>&gt;&gt;&gt;</span> luke<span style=color:#f92672>.</span>verifyPassword(<span style=color:#e6db74>&#39;password&#39;</span>)
<span style=color:#66d9ef>False</span>

<span style=color:#f92672>&gt;&gt;&gt;</span> luke<span style=color:#f92672>.</span>verifyPassword(<span style=color:#e6db74>&#39;TheForce&#39;</span>)
<span style=color:#66d9ef>True</span>

<span style=color:#f92672>&gt;&gt;&gt;</span> han <span style=color:#f92672>=</span> User(
<span style=color:#f92672>...</span>     name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Han Solo&#39;</span>,
<span style=color:#f92672>...</span>     email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;han@rebel-alliance.io&#39;</span>,
<span style=color:#f92672>...</span>     password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;LetTheWookieWin&#39;</span>,
<span style=color:#f92672>...</span> )
<span style=color:#f92672>...</span>

<span style=color:#f92672>&gt;&gt;&gt;</span> luke[<span style=color:#e6db74>&#39;friends&#39;</span>]<span style=color:#f92672>.</span>append(han)

<span style=color:#f92672>&gt;&gt;&gt;</span> han[<span style=color:#e6db74>&#39;friends&#39;</span>]<span style=color:#f92672>.</span>append(luke)

<span style=color:#f92672>&gt;&gt;&gt;</span> print(luke[<span style=color:#e6db74>&#39;friends&#39;</span>][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;name&#39;</span>])
<span style=color:#e6db74>&#39;Han Solo&#39;</span>
</code></pre></div><p>Then we can go into the <code>redis-cli</code> to verify that everything saved correctly:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>127.0.0.1:6379&gt; keys *
1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;User:han@rebel-alliance.io:friends&#34;</span>
2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;User:han@rebel-alliance.io&#34;</span>
3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;User:luke@rebel-alliance.io:friends&#34;</span>
4<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;User:luke@rebel-alliance.io&#34;</span>

127.0.0.1:6379&gt; hgetall User:luke@rebel-alliance.io
1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;name&#34;</span>
2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;Luke Skywalker&#34;</span>
3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;email&#34;</span>
4<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;luke@rebel-alliance.io&#34;</span>
5<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;password&#34;</span>
6<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>b</span>$12$XQ1zDvl5PLS6g<span style=color:#e6db74>.K64H27xewPQMnkELa3LvzFSyay8p9kz0XXHVOFq&#34;</span>

127.0.0.1:6379&gt; lrange User:luke@rebel-alliance.io:friends <span style=color:#ae81ff>0</span> -1
1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;User:han@rebel-alliance.io&#34;</span>
</code></pre></div><p>There are two entires for each, since technically the <code>friends</code> list is a <code>RedisList</code>. Originally, I was storing these as JSON encoded lists, but as they got larger, this started to get a little unweildy.</p>
<p>Another plus is that since all of the objects are backed by Redis, you get automatic persistance. Stop Python completely, start it back up, and you can just load the same objects again (remember, for these objects, I&rsquo;m using the <code>email</code> as the ID):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>&gt;&gt;&gt;</span> luke <span style=color:#f92672>=</span> User(<span style=color:#e6db74>&#39;luke@rebel-alliance.io&#39;</span>)

<span style=color:#f92672>&gt;&gt;&gt;</span> print(luke[<span style=color:#e6db74>&#39;friends&#39;</span>][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;name&#39;</span>])
<span style=color:#e6db74>&#39;Han Solo&#39;</span>
</code></pre></div><p>Very cool.</p>
<p>So, speaking of <code>RedisList</code>, how does that work? Mostly the same as <code>RedisDict</code> (although I had a few more functions to implement):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> json
<span style=color:#f92672>import</span> redis

<span style=color:#f92672>from</span> lib.RedisObject <span style=color:#f92672>import</span> RedisObject

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisList</span>(RedisObject):
    <span style=color:#e6db74>&#39;&#39;&#39;An equivalent to list where all items are stored in Redis.&#39;&#39;&#39;</span>

    <span style=color:#66d9ef>def</span> __init__(self, id <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>, item_type <span style=color:#f92672>=</span> str, items <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
        <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>        Create a new RedisList
</span><span style=color:#e6db74>        id: If specified, use this as the redis ID, otherwise generate a random ID.
</span><span style=color:#e6db74>        item_type: The constructor to use when reading items from redis.
</span><span style=color:#e6db74>        values: Default values to store during construction.
</span><span style=color:#e6db74>        &#39;&#39;&#39;</span>

        RedisObject<span style=color:#f92672>.</span>__init__(self, id)

        self<span style=color:#f92672>.</span>item_type <span style=color:#f92672>=</span> item_type

        <span style=color:#66d9ef>if</span> items:
            <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> items:
                self<span style=color:#f92672>.</span>append(item)

    <span style=color:#a6e22e>@classmethod</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>as_child</span>(cls, parent, tag, item_type):
        <span style=color:#e6db74>&#39;&#39;&#39;Alternative callable constructor that instead defines this as a child object&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>helper</span>(_ <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
            <span style=color:#66d9ef>return</span> cls(parent<span style=color:#f92672>.</span>id <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> tag, item_type)

        <span style=color:#66d9ef>return</span> helper

    <span style=color:#66d9ef>def</span> __getitem__(self, index):
        <span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>        Load an item by index where index is either an int or a slice
</span><span style=color:#e6db74>        Warning: this is O(n))
</span><span style=color:#e6db74>        &#39;&#39;&#39;</span>

        <span style=color:#66d9ef>if</span> isinstance(index, slice):
            <span style=color:#66d9ef>if</span> slice<span style=color:#f92672>.</span>step <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>:
                <span style=color:#66d9ef>raise</span> NotImplemented(<span style=color:#e6db74>&#39;Cannot specify a step to a RedisObject slice&#39;</span>)

            <span style=color:#66d9ef>return</span> [
                RedisObject<span style=color:#f92672>.</span>decode_value(self<span style=color:#f92672>.</span>item_type, el)
                <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lrange(self<span style=color:#f92672>.</span>id, slice<span style=color:#f92672>.</span>start, slice<span style=color:#f92672>.</span>end)
            ]
        <span style=color:#66d9ef>else</span>:
            <span style=color:#66d9ef>return</span> RedisObject<span style=color:#f92672>.</span>decode_value(self<span style=color:#f92672>.</span>item_type, self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lindex(self<span style=color:#f92672>.</span>id, index))

    <span style=color:#66d9ef>def</span> __setitem__(self, index, val):
        <span style=color:#e6db74>&#39;&#39;&#39;Update an item by index
</span><span style=color:#e6db74>        Warning: this is O(n)
</span><span style=color:#e6db74>        &#39;&#39;&#39;</span>

        self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lset(self<span style=color:#f92672>.</span>id, index, RedisObject<span style=color:#f92672>.</span>encode_value(val))

    <span style=color:#66d9ef>def</span> __len__(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Return the size of the list.&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>llen(self<span style=color:#f92672>.</span>id)

    <span style=color:#66d9ef>def</span> __delitem__(self, index):
        <span style=color:#e6db74>&#39;&#39;&#39;Delete an item from a RedisList by index. (warning: this is O(n))&#39;&#39;&#39;</span>

        self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lset(self<span style=color:#f92672>.</span>id, index, <span style=color:#e6db74>&#39;__DELETED__&#39;</span>)
        self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lrem(self<span style=color:#f92672>.</span>id, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;__DELETED__&#39;</span>)

    <span style=color:#66d9ef>def</span> __iter__(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Iterate over all items in this list.&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lrange(self<span style=color:#f92672>.</span>id, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
            <span style=color:#66d9ef>yield</span> RedisObject<span style=color:#f92672>.</span>decode_value(self<span style=color:#f92672>.</span>item_type, el)

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lpop</span>(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Remove and return a value from the left (low) end of the list.&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>return</span> RedisObject<span style=color:#f92672>.</span>decode_value(self<span style=color:#f92672>.</span>item_type, self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lpop(self<span style=color:#f92672>.</span>id))

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rpop</span>(self):
        <span style=color:#e6db74>&#39;&#39;&#39;Remove a value from the right (high) end of the list.&#39;&#39;&#39;</span>

        <span style=color:#66d9ef>return</span> RedisObject<span style=color:#f92672>.</span>decode_value(self<span style=color:#f92672>.</span>item_type, self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>rpop(self<span style=color:#f92672>.</span>id))

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lpush</span>(self, val):
        <span style=color:#e6db74>&#39;&#39;&#39;Add an item to the left (low) end of the list.&#39;&#39;&#39;</span>

        self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>lpush(self<span style=color:#f92672>.</span>id, RedisObject<span style=color:#f92672>.</span>encode_value(val))

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rpush</span>(self, val):
        <span style=color:#e6db74>&#39;&#39;&#39;Add an item to the right (high) end of the list.&#39;&#39;&#39;</span>

        self<span style=color:#f92672>.</span>redis<span style=color:#f92672>.</span>rpush(self<span style=color:#f92672>.</span>id, RedisObject<span style=color:#f92672>.</span>encode_value(val))

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>append</span>(self, val):
        self<span style=color:#f92672>.</span>rpush(val)
</code></pre></div><p>Basically, I&rsquo;m mapping a lot of the default Python <code>list</code> functionality to Redis lists and vice versa<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. It&rsquo;s a little odd and some things aren&rsquo;t as efficient as I&rsquo;d like (you only get <code>O(1)</code> access to the beginning and end of the list), but so it goes. It works great, as you saw in the <code>friends</code> example above.</p>
<p>The one interesting function is <code>as_child</code>. Since either a <code>RedisDict</code> or a <code>RedisList</code> expect a &lsquo;constructor-like&rsquo; function as the data type, I need something that will correctly store a <code>RedisList</code> inside of a <code>RedisDict</code> while generating a human readable ID (with <code>:friends</code> appended in the example above). I love <a href=https://en.wikipedia.org/wiki/higher%20order%20functions>higher order functions</a>.</p>
<p>And&mldr; that&rsquo;s it. Eventually, I think I&rsquo;ll look into publishing this as a library to <code>pip</code> or the like. But since I&rsquo;ve never done that before and this post is already a little on the long sice, we&rsquo;ll leave that for another day. All of the code is included in the post, so you can copy and paste it into your project if you&rsquo;d like to try it out before I publish it. Once I have, I&rsquo;ll edit this post.</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Pretty quickly actually&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p>Yes, there are a few other choices; these are the most common in practice&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:3 role=doc-endnote>
<p>Although I did have a similar model with lazily loaded objects from disk that would only save when they were <code>del</code>eted. That was neat.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:4 role=doc-endnote>
<p>A combination hash+salt; never store plain text or unsalted passwords&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:5 role=doc-endnote>
<p>I can never remember exactly how that&rsquo;s spelled&mldr;&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section></div>
</article></div>
</div><footer id=page-footer role=contentinfo>
<nav id=footer-navigation role=navigation class=ribbon>
<ul class=main-navigation>
<li><a href=/archive-by-date/>All posts: By Date</a></li>
<li><a href=/archive-by-tag/>All posts: By Tag</a></li>
<li>
<a href=/atom.xml>
RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li><li>
<a href=/programming/atom.xml>
RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li></ul>
</nav>
<div id=page-footer-content>
<div class=legal>
<p>
All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US>
<img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png>
</a>
</p>
<p>
Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a>
</p>
</div>
</div>
</footer>
</div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script src=/custom.js></script>
</body>
</html>
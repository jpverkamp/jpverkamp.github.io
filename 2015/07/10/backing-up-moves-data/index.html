<!DOCTYPE html>
<html>
<head>
    <title>
    Backing up Moves Data â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Backing up Moves Data</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2015-07-10</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/07/02/scraping-kindle-highlights/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/python">Python</a>
                        <a href="https://blog.jverkamp.com/2015/07/16/automagically-storing-python-objects-in-redis/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/07/02/scraping-kindle-highlights/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/backups">Backups</a>
                        <a href="https://blog.jverkamp.com/2015/09/08/backing-up-github-repositories/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/07/02/scraping-kindle-highlights/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/07/16/automagically-storing-python-objects-in-redis/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/07/05/equoid/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/07/11/the-fuller-memorandum/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>Another <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">backup post</a>, this time I&rsquo;m going to back up my data from the <a href="https://www.moves-app.com/">Moves App</a> (step counter + GPS tracker). Theoretically, it should be possible to get this same data from the app as part of my <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">iOS Backup</a> series, but the data there is in a strange binary format. Much easier to use their API.</p>

<p></p>

<p>The first step will be to make a few helper methods. As I often do with web scripts, I&rsquo;ll be using <a href="https://blog.jverkamp.com/2007/10/20/pymint---a-python-multi-interpreter/">Python</a> and the excellent <a href="http://docs.python-requests.org/en/latest/">Requests</a> library. First things first, we have to get an <code>access_token</code> using an <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> handshake. It&rsquo;s a little complicated since our app is designed to run from the command line, yet needs to interact with the user on initial set up, but luckily that only has to be done once:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Request a new access token</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;access_token&#39;</span> <span style="color:#f92672">in</span> config:
    url <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;https://api.moves-app.com/oauth/v1/authorize?response_type=code&amp;client_id={client_id}&amp;scope={scope}&#39;</span><span style="color:#f92672">.</span>format(
        client_id <span style="color:#f92672">=</span> config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;client_id&#39;</span>],
        scope <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;activity location&#39;</span>
    )
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Opening URL in browser...&#39;</span>)
    webbrowser<span style="color:#f92672">.</span>open(url)
    code <span style="color:#f92672">=</span> raw_input(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Please follow prompts and enter code: &#39;</span>)

    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;https://api.moves-app.com/oauth/v1/access_token?grant_type=authorization_code&amp;code={code}&amp;client_id={client_id}&amp;client_secret={client_secret}&amp;redirect_uri={redirect_uri}&#39;</span><span style="color:#f92672">.</span>format(
        code <span style="color:#f92672">=</span> code,
        client_id <span style="color:#f92672">=</span> config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;client_id&#39;</span>],
        client_secret <span style="color:#f92672">=</span> config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;client_secret&#39;</span>],
        redirect_uri <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;http://localhost/&#39;</span>,
    ))
    js <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
    <span style="color:#66d9ef">print</span>(js)

    config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;access_token&#39;</span>] <span style="color:#f92672">=</span> js[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;access_token&#39;</span>]
    config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;refresh_token&#39;</span>] <span style="color:#f92672">=</span> js[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;refresh_token&#39;</span>]
    config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;user_id&#39;</span>] <span style="color:#f92672">=</span> js[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;user_id&#39;</span>]

    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;config.yaml&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> fout:
        yaml<span style="color:#f92672">.</span>safe_dump(config, fout, default_flow_style<span style="color:#f92672">=</span>False)</code></pre></div>
<p>Basically, we have to have two values to start the handshake: <code>client_id</code> and <code>client_secret</code>. I&rsquo;ve put those in a separate file (<code>config.yaml</code>) so that we don&rsquo;t have secrets in a repository. From there, we make a request to a given endpoint (see above), which opens in a browser. The user then gets an eight digit code which they enter in the app on the phone, prompting the web browser in turn to redirect with a <code>code</code> parameter. This part is a little ugly and I could make it much nicer by running a temporary single endpoint server, but since this only needs to be done once, I didn&rsquo;t bother.</p>

<p>After that, we take the <code>code</code> we just got, along with the <code>client_id</code> and <code>client_secret</code> and get the initial <code>access_token</code> and a <code>refresh_token</code> we can periodically use to prove we&rsquo;re still the same person.</p>

<p>Next, a little bit of framework. We&rsquo;ll wrap the default <code>requests</code> object to automatically provide an <code>access_token</code> to any <code>GET</code> or <code>POST</code> requests I want to make to the API, now that I&rsquo;ve gotten one:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">makeMethod</span>(f):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(url, <span style="color:#f92672">**</span>kwargs):

        <span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;access_token&#39;</span> <span style="color:#f92672">in</span> config:
            headers <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Authorization&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Bearer {access_token}&#39;</span><span style="color:#f92672">.</span>format(access_token <span style="color:#f92672">=</span> config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;access_token&#39;</span>])}
        <span style="color:#66d9ef">else</span>:
            headers <span style="color:#f92672">=</span> {}

        url <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;https://api.moves-app.com/api/1.1&#39;</span> <span style="color:#f92672">+</span> url<span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>kwargs)

        <span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">in</span> kwargs:
            <span style="color:#66d9ef">return</span> f(url, data <span style="color:#f92672">=</span> kwargs[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;data&#39;</span>], headers <span style="color:#f92672">=</span> headers)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> f(url, headers <span style="color:#f92672">=</span> headers)

    <span style="color:#66d9ef">return</span> run

get <span style="color:#f92672">=</span> makeMethod(requests<span style="color:#f92672">.</span>get)
post <span style="color:#f92672">=</span> makeMethod(requests<span style="color:#f92672">.</span>post)</code></pre></div>
<p>With that, we can just always use that <code>refresh_token</code> we got above every time we run the script. This is definitely over kill, but it saves a little bit of logic telling when we have to refresh the code or not and doesn&rsquo;t really cost anything more than a single extra request:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Perform a refresh on the access token just as a matter of course</span>

response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;https://api.moves-app.com/oauth/v1/access_token&#39;</span>, data <span style="color:#f92672">=</span> {
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;grant_type&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;refresh_token&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;refresh_token&#39;</span>: config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;refresh_token&#39;</span>],
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;client_id&#39;</span>: config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;client_id&#39;</span>],
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;client_secret&#39;</span>: config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;client_secret&#39;</span>]
})
js <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()

config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;access_token&#39;</span>] <span style="color:#f92672">=</span> js[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;access_token&#39;</span>]
config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;refresh_token&#39;</span>] <span style="color:#f92672">=</span> js[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;refresh_token&#39;</span>]
config[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;user_id&#39;</span>] <span style="color:#f92672">=</span> js[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;user_id&#39;</span>]

<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;config.yaml&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> fout:
    yaml<span style="color:#f92672">.</span>safe_dump(config, fout, default_flow_style<span style="color:#f92672">=</span>False)</code></pre></div>
<p>Next, fetch my user profile:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Load the user profile to see how far back data goes</span>

user_profile <span style="color:#f92672">=</span> get(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;/user/profile&#39;</span>)<span style="color:#f92672">.</span>json()</code></pre></div>
<p>The most interesting bit of information here is <code>.profile.firstDate</code>, which tells us when we first started using Moves. We can then loop from that date forward in time, grabbing any days we are missing. Since sometimes previous days aren&rsquo;t completely done processing the next morning, I&rsquo;ll also always re-download the last week&rsquo;s worth of data no matter what.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Loop through all missing files, or force load anything less than a week ago</span>

date <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>strptime(user_profile[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;profile&#39;</span>][<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;firstDate&#39;</span>], <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>)
today <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now()
oneWeekAgo <span style="color:#f92672">=</span> today <span style="color:#f92672">-</span> datetime<span style="color:#f92672">.</span>timedelta(days <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>)

<span style="color:#66d9ef">while</span> date <span style="color:#f92672">&lt;</span> today:
    dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;data&#39;</span>, date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;%Y&#39;</span>), date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;%m&#39;</span>))
    filename <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dir, date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;.json&#39;</span>)

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> date <span style="color:#f92672">&gt;</span> oneWeekAgo <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(filename):
        date <span style="color:#f92672">+=</span> datetime<span style="color:#f92672">.</span>timedelta(days <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
        <span style="color:#66d9ef">continue</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(dir):
        os<span style="color:#f92672">.</span>makedirs(dir)

    <span style="color:#66d9ef">print</span>(filename)

    response <span style="color:#f92672">=</span> get(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;/user/storyline/daily/{date}?trackPoints=true&#39;</span>, date <span style="color:#f92672">=</span> date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))

    <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Bad response, stopping&#39;</span>)
        <span style="color:#66d9ef">print</span>(response<span style="color:#f92672">.</span>text)
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)

    <span style="color:#66d9ef">if</span> int(response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;x-ratelimit-minuteremaining&#39;</span>]) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Rate limited, waiting one minute before continuing&#39;</span>)
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">60</span>)

    <span style="color:#66d9ef">if</span> int(response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;x-ratelimit-hourremaining&#39;</span>]) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Rate limited, wait one hour and try again&#39;</span>)
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">3600</span>)

    <span style="color:#66d9ef">with</span> codecs<span style="color:#f92672">.</span>open(filename, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;w&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">as</span> fout:
        fout<span style="color:#f92672">.</span>write(response<span style="color:#f92672">.</span>text)

    date <span style="color:#f92672">+=</span> datetime<span style="color:#f92672">.</span>timedelta(days <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)</code></pre></div>
<p>There is a neat bit in there with the <code>x-ratelimit-minuteremaining</code> and <code>x-ratelimit-hourremaining</code>. If we&rsquo;re downloading the entire history for the first time, you&rsquo;re going to get rate limited. So in this case, we&rsquo;ll wait a minute or an hour until the rate limit has expired.</p>

<p>And that&rsquo;s it. In the end, I end up with a pile of files, one for each day, each with exactly where I was on that day. I can use that data for all sorts of interesting analytics, like how far I walk in the average week, what my area of influence is, or even to combine with my <a href="/photography/">photography</a> so that I can geotag my pictures. It&rsquo;s a lot of fun.</p>

<p>So, yes. I am something of a digital hoarder. But on the flip side, storage space is cheap and data is interesting. Perhaps I&rsquo;ll get a post or two out of making pretty pretty pictures out of where all I&rsquo;ve been!</p>

<p>If you&rsquo;d like to see / download the entire script for my Moves backup (or any of my other non-iOS backups, those are <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">here</a>), you can do so here: <a href="https://github.com/jpverkamp/backup">jpverkamp/backup on GitHub</a></p>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Backing up Moves Data";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2015\/07\/10\/backing-up-moves-data\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

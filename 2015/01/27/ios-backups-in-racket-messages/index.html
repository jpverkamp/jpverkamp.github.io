<!DOCTYPE html>
<html>
<head>
    <title>
    iOS Backups in Racket: Messages â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">iOS Backups in Racket: Messages</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2015-01-27</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a>
                        <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/backups">Backups</a>
                        <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/data-structures">Data Structures</a>
                        <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/databases">Databases</a>
                        <a href="https://blog.jverkamp.com/2015/07/16/automagically-storing-python-objects-in-redis/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/series/ios-backups-in-racket">iOS Backups in Racket</a>
                        <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/" class="next-link"></a>
                    </li>
                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/01/25/his-majestys-dragon/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>So far we&rsquo;ve <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">laid the groundwork</a>, loading local iOS backups and parsed out <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/">contacts</a>. Today let&rsquo;s take another step down the rabbit hole and figure out how messages are stored.</p>

<p></p>

<p>Okay, first things first, we need to find the database(s) that messages are stored in. Using the <a href="https://theiphonewiki.com/wiki/ITunes_Backup#Files">same source</a> as last time, we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (hash-filename <span style="color:#e6db74">&#34;Library/SMS/sms.db&#34;</span> <span style="color:#e6db74">&#34;HomeDomain&#34;</span>)
<span style="color:#e6db74">&#34;3d0d7e5fb2ce288813306e4d4636395e047a3d28&#34;</span></code></pre></div>
<p>Interesting. What&rsquo;s in there?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> .tables
_SqliteDatabaseProperties  chat_message_join
attachment                 handle
chat                       message
chat_handle_join           message_attachment_join</code></pre></div>
<p>Dang. That&rsquo;s rather less than there was when dealing with contacts. From a first guess, I would say that <code>message</code> contains the text itself, <code>chat</code> is a group of messages with the same people, and <code>*_join</code> are tables that related those. <code>handle</code> could perhaps be a way of relating who is in a chat to the information in contacts from last week. Let&rsquo;s see how I did:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> message (ROWID INTEGER <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTOINCREMENT,
    guid TEXT <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
    text TEXT,
    <span style="color:#66d9ef">replace</span> INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    service_center TEXT,
    handle_id INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    subject TEXT,
    country TEXT,
    attributedBody BLOB,
    <span style="color:#66d9ef">version</span> INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    <span style="color:#66d9ef">type</span> INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    service TEXT,
    account TEXT,
    account_guid TEXT,
    error INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    date INTEGER,
    date_read INTEGER,
    date_delivered INTEGER,
    is_delivered INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_finished INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_emote INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_from_me INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_empty INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_delayed INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_auto_reply INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_prepared INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_read INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_system_message INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_sent INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    has_dd_results INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_service_message INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_forward INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    was_downgraded INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_archive INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    cache_has_attachments INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    cache_roomnames TEXT,
    was_data_detected INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    was_deduplicated INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_audio_message INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    is_played INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    date_played INTEGER,
    item_type INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    other_handle INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
    group_title TEXT,
    group_action_type INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    share_status INTEGER,
    share_direction INTEGER,
    is_expirable INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    expire_state INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    message_action_type INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    message_source INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>
 );</code></pre></div>
<p>Oof. Okay, that&rsquo;s more like what I was expecting. In particular though, it looks like we don&rsquo;t care about most of those fields. In particular, I think the interesting fields will be <code>guid</code>, <code>text</code>, <code>handle_id</code> (it looks like we will need the <code>handle</code> table), <code>date</code>, and <code>is_from_me</code>.</p>

<p>Next, <code>chat</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> .<span style="color:#66d9ef">schema</span> chat
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> chat (ROWID INTEGER <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTOINCREMENT,
    guid TEXT <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
    style INTEGER,
    <span style="color:#66d9ef">state</span> INTEGER,
    account_id TEXT,
    properties BLOB,
    chat_identifier TEXT,
    service_name TEXT,
    room_name TEXT,
    account_login TEXT,
    is_archived INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">0</span>,
    last_addressed_handle TEXT,
    display_name TEXT,
    group_id TEXT
);</code></pre></div>
<p>Hmm. It turns out that we don&rsquo;t actually need anything there. All that we need to know about chats is which ID we need, which because it&rsquo;s a join table, that will be in <code>chat_message_join</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> .<span style="color:#66d9ef">schema</span> chat_message_join
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> chat_message_join (
    chat_id INTEGER <span style="color:#66d9ef">REFERENCES</span> chat (ROWID) <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">CASCADE</span>,
    message_id INTEGER <span style="color:#66d9ef">REFERENCES</span> message (ROWID) <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">CASCADE</span>,
    <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (chat_id, message_id)
);</code></pre></div>
<p>So if we have a chat ID, we can get all of that information:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>
  message.ROWID <span style="color:#66d9ef">as</span> message_id,
  message.date,
  message.service,
  message.is_from_me,
  (<span style="color:#66d9ef">CASE</span> <span style="color:#66d9ef">WHEN</span> message.subject <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">ELSE</span> message.subject <span style="color:#66d9ef">END</span>),
  (<span style="color:#66d9ef">CASE</span> <span style="color:#66d9ef">WHEN</span> message.text <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">ELSE</span> message.text <span style="color:#66d9ef">END</span>)
<span style="color:#66d9ef">FROM</span>
  chat_message_join,
  message
<span style="color:#66d9ef">WHERE</span>
  chat_id <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
  <span style="color:#66d9ef">AND</span> message_id <span style="color:#f92672">=</span> message.ROWID
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> date <span style="color:#66d9ef">ASC</span></code></pre></div>
<p>The conversion from <code>NULL</code> to an empty string is mostly for later. I know that I&rsquo;ll want to serialize these, most likely to JSON and I don&rsquo;t particularly care about the difference between a <code>NULL</code> entry and an empty string.</p>

<p>That&rsquo;s a good start. We still need to know who they&rsquo;re from though.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> .<span style="color:#66d9ef">schema</span> handle
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> handle (
    ROWID INTEGER <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTOINCREMENT <span style="color:#66d9ef">UNIQUE</span>,
    id TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
    country TEXT,
    service TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
    uncanonicalized_id TEXT,
    <span style="color:#66d9ef">UNIQUE</span> (id,
    service)
);</code></pre></div>
<p>Looking at some of the values, it seems that <code>id</code> is either an email or a phone number, while service is either SMS or iMessage (at least in my case). Country might be interesting later, but we&rsquo;ll ignore it for the moment.</p>

<p>So let&rsquo;s expand the query to include that information:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>
  message.ROWID <span style="color:#66d9ef">as</span> message_id,
  message.date,
  message.service,
  message.is_from_me,
  handle.id <span style="color:#66d9ef">as</span> them,
  (<span style="color:#66d9ef">CASE</span> <span style="color:#66d9ef">WHEN</span> message.subject <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">ELSE</span> message.subject <span style="color:#66d9ef">END</span>),
  (<span style="color:#66d9ef">CASE</span> <span style="color:#66d9ef">WHEN</span> message.text <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">ELSE</span> message.text <span style="color:#66d9ef">END</span>)
<span style="color:#66d9ef">FROM</span>
  chat_message_join,
  message,
  handle
<span style="color:#66d9ef">WHERE</span>
  chat_id <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
  <span style="color:#66d9ef">AND</span> message_id <span style="color:#f92672">=</span> message.ROWID
  <span style="color:#66d9ef">AND</span> handle_id <span style="color:#f92672">=</span> handle.ROWID
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> date <span style="color:#66d9ef">ASC</span></code></pre></div>
<p>Cool. One last thing. Remember that <code>attachment</code> table? Let&rsquo;s go ahead and add that in, just loading the attachments as a single string:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>
  message.ROWID <span style="color:#66d9ef">as</span> message_id,
  message.date,
  message.service,
  message.is_from_me,
  handle.id <span style="color:#66d9ef">as</span> them,
  (<span style="color:#66d9ef">CASE</span> <span style="color:#66d9ef">WHEN</span> message.subject <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">ELSE</span> message.subject <span style="color:#66d9ef">END</span>),
  (<span style="color:#66d9ef">CASE</span> <span style="color:#66d9ef">WHEN</span> message.text <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">THEN</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">ELSE</span> message.text <span style="color:#66d9ef">END</span>),
  (<span style="color:#66d9ef">SELECT</span> group_concat(attachment.filename)
     <span style="color:#66d9ef">FROM</span> message_attachment_join, attachment
     <span style="color:#66d9ef">WHERE</span> message_attachment_join.message_id <span style="color:#f92672">=</span> message.ROWID
       <span style="color:#66d9ef">AND</span> message_attachment_join.attachment_id <span style="color:#f92672">=</span> attachment.ROWID)
<span style="color:#66d9ef">FROM</span>
  chat_message_join,
  message,
  handle
<span style="color:#66d9ef">WHERE</span>
  chat_id <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
  <span style="color:#66d9ef">AND</span> message_id <span style="color:#f92672">=</span> message.ROWID
  <span style="color:#66d9ef">AND</span> handle_id <span style="color:#f92672">=</span> handle.ROWID
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> date <span style="color:#66d9ef">ASC</span></code></pre></div>
<p>Okay. They say that 
<figure >
    <a href="https://www.youtube.com/watch?v=pele5vptVgc">
        <img src="/embeds/2015/knowing%20is%20half%20the%20battle" />
    </a>
    
</figure>
, so having all of the structure and that SQL query should translate pretty directly to code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">(<span style="color:#66d9ef">struct</span> chat (contacts messages) <span style="color:#66d9ef">#:prefab</span>)
(<span style="color:#66d9ef">struct</span> message (date service sender subject text attachments) <span style="color:#66d9ef">#:prefab</span>)
(<span style="color:#66d9ef">struct</span> attachment (name path) <span style="color:#66d9ef">#:prefab</span>)

<span style="color:#75715e">; Load all chats from a backup directory</span>
(<span style="color:#66d9ef">define</span> (list-chats)
  (hash-ref!
   chats-by-backup
   (current-backup)
   (<span style="color:#66d9ef">Î»</span> ()
     (<span style="color:#66d9ef">parameterize</span> ([date-display-format <span style="color:#f92672">&#39;</span><span style="color:#e6db74">iso-8601</span>])
       <span style="color:#75715e">; Connect to the correct DB</span>
       (<span style="color:#66d9ef">define</span> sms-db
         (sqlite3-connect
           <span style="color:#66d9ef">#:database</span> (build-path (backup-path (current-backup))
                                  MESSAGES-DB)))

       <span style="color:#75715e">; Loop over the individual chat ids</span>
       (<span style="color:#66d9ef">for/list</span> ([(chat-id) (in-query sms-db <span style="color:#e6db74">&#34;SELECT ROWID FROM chat&#34;</span>)])
         <span style="color:#75715e">; Determine which contacts were involved in the conversation by contact</span>
         <span style="color:#75715e">; Use models/contacts.rkt to figure out who belongs to contact information</span>
         (<span style="color:#66d9ef">define</span> user-query <span style="color:#e6db74">&#34;SELECT id FROM chat_handle_join, handle
</span><span style="color:#e6db74">                             WHERE chat_id = $1 AND handle_id = ROWID
</span><span style="color:#e6db74">                             ORDER BY handle_id ASC&#34;</span>)
         (<span style="color:#66d9ef">define</span> contacts
           (<span style="color:#66d9ef">for/list</span> ([(contact) (in-query sms-db user-query chat-id)])
             (find-contact (normalize-contact contact))))

         <span style="color:#75715e">; Load the individual messages</span>
         (<span style="color:#66d9ef">define</span> msg-query <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">  message.ROWID as message_id,
</span><span style="color:#e6db74">  message.date,
</span><span style="color:#e6db74">  message.service,
</span><span style="color:#e6db74">  message.is_from_me,
</span><span style="color:#e6db74">  handle.id as them,
</span><span style="color:#e6db74">  (CASE WHEN message.subject IS NULL THEN &#39;&#39; ELSE message.subject END),
</span><span style="color:#e6db74">  (CASE WHEN message.text IS NULL THEN &#39;&#39; ELSE message.text END),
</span><span style="color:#e6db74">  (SELECT group_concat(attachment.filename)
</span><span style="color:#e6db74">     FROM message_attachment_join, attachment
</span><span style="color:#e6db74">     WHERE message_attachment_join.message_id = message.ROWID
</span><span style="color:#e6db74">       AND message_attachment_join.attachment_id = attachment.ROWID)
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">  chat_message_join,
</span><span style="color:#e6db74">  message,
</span><span style="color:#e6db74">  handle
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">  chat_id = ?
</span><span style="color:#e6db74">  AND message_id = message.ROWID
</span><span style="color:#e6db74">  AND handle_id = handle.ROWID
</span><span style="color:#e6db74">ORDER BY date ASC&#34;</span>)
         (<span style="color:#66d9ef">define</span> messages
           (<span style="color:#66d9ef">for/list</span> ([(message-id
                        raw-date
                        service
                        from-me?
                        other-party
                        subject
                        text
                        raw-attachments)
                       (in-query sms-db msg-query chat-id)])
             <span style="color:#75715e">; Correct dates from Apple time to unix time</span>
             <span style="color:#75715e">; TODO: Account for timezones?</span>
             (<span style="color:#66d9ef">define</span> date (seconds-&gt;date (+ raw-date <span style="color:#ae81ff">978336000</span> (- (* <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">60</span>))) <span style="color:#66d9ef">#f</span>))

             (<span style="color:#66d9ef">define</span> sender
               (<span style="color:#66d9ef">if</span> (= <span style="color:#ae81ff">1</span> from-me?)
                   (backup-phone-number (current-backup))
                   (normalize-contact other-party)))

             <span style="color:#75715e">; Load attachments,</span>
             (<span style="color:#66d9ef">define</span> attachments
               (<span style="color:#66d9ef">if</span> (sql-null? raw-attachments)
                   <span style="color:#f92672">&#39;</span>()
                   (<span style="color:#66d9ef">for/list</span> ([path (in-list (string-split raw-attachments <span style="color:#e6db74">&#34;,&#34;</span>))])
                     (attachment
                      (path-&gt;string (last (explode-path path)))
                      (build-path (backup-path (current-backup))
                                  (hash-filename path))))))

             (message date service sender subject text attachments)))

         <span style="color:#75715e">; Create the chat object</span>
         (chat contacts messages))))))</code></pre></div>
<p>Theoretically, that should be a fairly direct translation. One interesting bit is the format of <code>date</code>. It&rsquo;s actually a timestamp, but not a normal <a href="https://en.wikipedia.org/wiki/Unix%20timestamp">Unix timestamp</a>. So I have a bit of a <a href="https://en.wikipedia.org/wiki/magic%20number">magic number</a>, but it works correctly for my backups, so we&rsquo;ll just leave it for the moment. Other than that, we use the <code>hash-filename</code> function from last time to get a local path for any <code>attachment</code> and we&rsquo;ve got everything pretty much written.</p>

<p>And that&rsquo;s really all we need. One thing that would be nice to be able to do though is, given a contact, filter for only the messages with that contact (either directly or in group chats as well):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Get all chats involving a specific chat</span>
(<span style="color:#66d9ef">define</span> (find-chats-by-contact contact <span style="color:#66d9ef">#:direct?</span> [direct? <span style="color:#66d9ef">#f</span>])
  <span style="color:#75715e">; Allow the user to specify the contact by name / phone number / email / etc</span>
  (<span style="color:#66d9ef">when</span> (not (contact? contact))
    (<span style="color:#66d9ef">set!</span> contact (find-contact contact)))

  <span style="color:#75715e">; Filter the list of chats</span>
  (<span style="color:#66d9ef">for/list</span> ([chat (in-list (list-chats))]
             <span style="color:#66d9ef">#:when</span> (<span style="color:#66d9ef">if</span> direct?
                        (equal? (list contact) (chat-contacts chat))
                        (member contact (chat-contacts chat))))
    chat))</code></pre></div>
<p>If you have an iOS device, check it out. It makes certain things really easy. For example, if I want to have a log of every word that I&rsquo;ve ever said in a conversation with Jenny:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (with-backup <span style="color:#e6db74">&#34;86b18...aa36&#34;</span>
    (<span style="color:#66d9ef">for*/list</span> ([chat (in-list (find-chats-by-contact <span style="color:#e6db74">&#34;Jenny&#34;</span> <span style="color:#66d9ef">#:direct?</span> <span style="color:#66d9ef">#t</span>))]
                [message (in-list (chat-messages chat))])
      (message-text message)))
<span style="color:#f92672">&#39;</span>(<span style="color:#e6db74">&#34;Jenny, Jenny, who can I turn to?&#34;</span>
  <span style="color:#e6db74">&#34;You give me somethin&#39; I can hold on to&#34;</span>
  <span style="color:#e6db74">...</span>)</code></pre></div>
<p>That&rsquo;s exactly the sort of that prompted this entire thought: the ability to take the fairly opaque structure of iOS backups and dump them into an easily readable / easily diffable format for my own purposes. Sweet.</p>

<p>If you&rsquo;d like to see the entire project, you can do so on GitHub: <a href="https://github.com/jpverkamp/ios-backup">ios-backup</a>. Alternatively, it&rsquo;s set up as a package, so you should be able to install it with <code>raco pkg install</code>. If you do, just import one or more of these:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">(<span style="color:#66d9ef">require</span> ios-backup
         ios-backup/contacts
         ios-backup/messages)</code></pre></div>
<p>Here is a list of all of the posts in this series:</p>

<div class="ranking">
    <h3 class="title">Posts in <a href="/series/ios-backups-in-racket/">iOS Backups in Racket</a>:</h3>
    <div class="content">
        <ul>
        
        
            <li><a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">iOS Backups in Racket: Groundwork</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/">iOS Backups in Racket: Contacts</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/">iOS Backups in Racket: Messages</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">iOS Backups in Racket: Apps</a></li>
        
        </ul>
    </div>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "iOS Backups in Racket: Messages";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2015\/01\/27\/ios-backups-in-racket-messages\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

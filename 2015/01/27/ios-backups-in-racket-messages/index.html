<!doctype html><html><head><title>iOS Backups in Racket: Messages â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js defer></script>
<script src=/custom.min.9bb1a6d1e0b58ced38df246e4479317e4561461cfabab31b36fbc36035186214.js defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css><link rel=stylesheet href=/custom.min.3bcba67844fc4a76aa7c1947a1fcf14cddaf8e9e0f1e734fde0fa219416f058d.css></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>iOS Backups in Racket: Messages</h1><div class=entry-meta><span class=entry-date>2015-01-27</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/backups>Backups</a><a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/databases>Databases</a><a href=https://blog.jverkamp.com/2015/07/16/automagically-storing-python-objects-in-redis/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/ class=previous-link></a><a class=taxonomy-value href=/series/ios-backups-in-racket>iOS Backups in Racket</a><a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2015/01/25/his-majestys-dragon/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>So far we&rsquo;ve <a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/>laid the groundwork</a>, loading local iOS backups and parsed out <a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/>contacts</a>. Today let&rsquo;s take another step down the rabbit hole and figure out how messages are stored.</p><p>Okay, first things first, we need to find the database(s) that messages are stored in. Using the <a href=https://theiphonewiki.com/wiki/ITunes_Backup#Files>same source</a> as last time, we have:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>&gt; (hash-filename <span style=color:#e6db74>&#34;Library/SMS/sms.db&#34;</span> <span style=color:#e6db74>&#34;HomeDomain&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;3d0d7e5fb2ce288813306e4d4636395e047a3d28&#34;</span>
</span></span></code></pre></div><p>Interesting. What&rsquo;s in there?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sqlite<span style=color:#f92672>&gt;</span> .tables
</span></span><span style=display:flex><span>_SqliteDatabaseProperties  chat_message_join
</span></span><span style=display:flex><span>attachment                 handle
</span></span><span style=display:flex><span>chat                       message
</span></span><span style=display:flex><span>chat_handle_join           message_attachment_join
</span></span></code></pre></div><p>Dang. That&rsquo;s rather less than there was when dealing with contacts. From a first guess, I would say that <code>message</code> contains the text itself, <code>chat</code> is a group of messages with the same people, and <code>*_join</code> are tables that related those. <code>handle</code> could perhaps be a way of relating who is in a chat to the information in contacts from last week. Let&rsquo;s see how I did:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> message (ROWID INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTOINCREMENT,
</span></span><span style=display:flex><span>    guid TEXT <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    text TEXT,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>replace</span> INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    service_center TEXT,
</span></span><span style=display:flex><span>    handle_id INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    subject TEXT,
</span></span><span style=display:flex><span>    country TEXT,
</span></span><span style=display:flex><span>    attributedBody BLOB,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>version</span> INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    service TEXT,
</span></span><span style=display:flex><span>    account TEXT,
</span></span><span style=display:flex><span>    account_guid TEXT,
</span></span><span style=display:flex><span>    error INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    date INTEGER,
</span></span><span style=display:flex><span>    date_read INTEGER,
</span></span><span style=display:flex><span>    date_delivered INTEGER,
</span></span><span style=display:flex><span>    is_delivered INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_finished INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_emote INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_from_me INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_empty INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_delayed INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_auto_reply INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_prepared INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_read INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_system_message INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_sent INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    has_dd_results INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_service_message INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_forward INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    was_downgraded INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_archive INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    cache_has_attachments INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    cache_roomnames TEXT,
</span></span><span style=display:flex><span>    was_data_detected INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    was_deduplicated INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_audio_message INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    is_played INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    date_played INTEGER,
</span></span><span style=display:flex><span>    item_type INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    other_handle INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    group_title TEXT,
</span></span><span style=display:flex><span>    group_action_type INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    share_status INTEGER,
</span></span><span style=display:flex><span>    share_direction INTEGER,
</span></span><span style=display:flex><span>    is_expirable INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    expire_state INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    message_action_type INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    message_source INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> );
</span></span></code></pre></div><p>Oof. Okay, that&rsquo;s more like what I was expecting. In particular though, it looks like we don&rsquo;t care about most of those fields. In particular, I think the interesting fields will be <code>guid</code>, <code>text</code>, <code>handle_id</code> (it looks like we will need the <code>handle</code> table), <code>date</code>, and <code>is_from_me</code>.</p><p>Next, <code>chat</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sqlite<span style=color:#f92672>&gt;</span> .<span style=color:#66d9ef>schema</span> chat
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> chat (ROWID INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTOINCREMENT,
</span></span><span style=display:flex><span>    guid TEXT <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    style INTEGER,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>state</span> INTEGER,
</span></span><span style=display:flex><span>    account_id TEXT,
</span></span><span style=display:flex><span>    properties BLOB,
</span></span><span style=display:flex><span>    chat_identifier TEXT,
</span></span><span style=display:flex><span>    service_name TEXT,
</span></span><span style=display:flex><span>    room_name TEXT,
</span></span><span style=display:flex><span>    account_login TEXT,
</span></span><span style=display:flex><span>    is_archived INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    last_addressed_handle TEXT,
</span></span><span style=display:flex><span>    display_name TEXT,
</span></span><span style=display:flex><span>    group_id TEXT
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Hmm. It turns out that we don&rsquo;t actually need anything there. All that we need to know about chats is which ID we need, which because it&rsquo;s a join table, that will be in <code>chat_message_join</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sqlite<span style=color:#f92672>&gt;</span> .<span style=color:#66d9ef>schema</span> chat_message_join
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> chat_message_join (
</span></span><span style=display:flex><span>    chat_id INTEGER <span style=color:#66d9ef>REFERENCES</span> chat (ROWID) <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>CASCADE</span>,
</span></span><span style=display:flex><span>    message_id INTEGER <span style=color:#66d9ef>REFERENCES</span> message (ROWID) <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>CASCADE</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (chat_id, message_id)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>So if we have a chat ID, we can get all of that information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>  message.ROWID <span style=color:#66d9ef>as</span> message_id,
</span></span><span style=display:flex><span>  message.date,
</span></span><span style=display:flex><span>  message.service,
</span></span><span style=display:flex><span>  message.is_from_me,
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> message.subject <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>ELSE</span> message.subject <span style=color:#66d9ef>END</span>),
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> message.text <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>ELSE</span> message.text <span style=color:#66d9ef>END</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>  chat_message_join,
</span></span><span style=display:flex><span>  message
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>  chat_id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> message_id <span style=color:#f92672>=</span> message.ROWID
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> date <span style=color:#66d9ef>ASC</span>
</span></span></code></pre></div><p>The conversion from <code>NULL</code> to an empty string is mostly for later. I know that I&rsquo;ll want to serialize these, most likely to JSON and I don&rsquo;t particularly care about the difference between a <code>NULL</code> entry and an empty string.</p><p>That&rsquo;s a good start. We still need to know who they&rsquo;re from though.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sqlite<span style=color:#f92672>&gt;</span> .<span style=color:#66d9ef>schema</span> handle
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> handle (
</span></span><span style=display:flex><span>    ROWID INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTOINCREMENT <span style=color:#66d9ef>UNIQUE</span>,
</span></span><span style=display:flex><span>    id TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    country TEXT,
</span></span><span style=display:flex><span>    service TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    uncanonicalized_id TEXT,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>UNIQUE</span> (id,
</span></span><span style=display:flex><span>    service)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Looking at some of the values, it seems that <code>id</code> is either an email or a phone number, while service is either SMS or iMessage (at least in my case). Country might be interesting later, but we&rsquo;ll ignore it for the moment.</p><p>So let&rsquo;s expand the query to include that information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>  message.ROWID <span style=color:#66d9ef>as</span> message_id,
</span></span><span style=display:flex><span>  message.date,
</span></span><span style=display:flex><span>  message.service,
</span></span><span style=display:flex><span>  message.is_from_me,
</span></span><span style=display:flex><span>  handle.id <span style=color:#66d9ef>as</span> them,
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> message.subject <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>ELSE</span> message.subject <span style=color:#66d9ef>END</span>),
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> message.text <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>ELSE</span> message.text <span style=color:#66d9ef>END</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>  chat_message_join,
</span></span><span style=display:flex><span>  message,
</span></span><span style=display:flex><span>  handle
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>  chat_id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> message_id <span style=color:#f92672>=</span> message.ROWID
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> handle_id <span style=color:#f92672>=</span> handle.ROWID
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> date <span style=color:#66d9ef>ASC</span>
</span></span></code></pre></div><p>Cool. One last thing. Remember that <code>attachment</code> table? Let&rsquo;s go ahead and add that in, just loading the attachments as a single string:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>  message.ROWID <span style=color:#66d9ef>as</span> message_id,
</span></span><span style=display:flex><span>  message.date,
</span></span><span style=display:flex><span>  message.service,
</span></span><span style=display:flex><span>  message.is_from_me,
</span></span><span style=display:flex><span>  handle.id <span style=color:#66d9ef>as</span> them,
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> message.subject <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>ELSE</span> message.subject <span style=color:#66d9ef>END</span>),
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> message.text <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>ELSE</span> message.text <span style=color:#66d9ef>END</span>),
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>SELECT</span> group_concat(attachment.filename)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>FROM</span> message_attachment_join, attachment
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>WHERE</span> message_attachment_join.message_id <span style=color:#f92672>=</span> message.ROWID
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>AND</span> message_attachment_join.attachment_id <span style=color:#f92672>=</span> attachment.ROWID)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>  chat_message_join,
</span></span><span style=display:flex><span>  message,
</span></span><span style=display:flex><span>  handle
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>  chat_id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> message_id <span style=color:#f92672>=</span> message.ROWID
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> handle_id <span style=color:#f92672>=</span> handle.ROWID
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> date <span style=color:#66d9ef>ASC</span>
</span></span></code></pre></div><p>Okay. They say that<figure><a href="https://www.youtube.com/watch?v=pele5vptVgc"><img src=/embeds/2015/knowing%20is%20half%20the%20battle></a></figure>, so having all of the structure and that SQL query should translate pretty directly to code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>(<span style=color:#66d9ef>struct</span> chat (contacts messages) <span style=color:#66d9ef>#:prefab</span>)
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>struct</span> message (date service sender subject text attachments) <span style=color:#66d9ef>#:prefab</span>)
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>struct</span> attachment (name path) <span style=color:#66d9ef>#:prefab</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Load all chats from a backup directory</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define</span> (list-chats)
</span></span><span style=display:flex><span>  (hash-ref!
</span></span><span style=display:flex><span>   chats-by-backup
</span></span><span style=display:flex><span>   (current-backup)
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>Î»</span> ()
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>parameterize</span> ([date-display-format <span style=color:#f92672>&#39;</span><span style=color:#e6db74>iso-8601</span>])
</span></span><span style=display:flex><span>       <span style=color:#75715e>; Connect to the correct DB</span>
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define</span> sms-db
</span></span><span style=display:flex><span>         (sqlite3-connect
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>#:database</span> (build-path (backup-path (current-backup))
</span></span><span style=display:flex><span>                                  MESSAGES-DB)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>; Loop over the individual chat ids</span>
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>for/list</span> ([(chat-id) (in-query sms-db <span style=color:#e6db74>&#34;SELECT ROWID FROM chat&#34;</span>)])
</span></span><span style=display:flex><span>         <span style=color:#75715e>; Determine which contacts were involved in the conversation by contact</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>; Use models/contacts.rkt to figure out who belongs to contact information</span>
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define</span> user-query <span style=color:#e6db74>&#34;SELECT id FROM chat_handle_join, handle
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                             WHERE chat_id = $1 AND handle_id = ROWID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                             ORDER BY handle_id ASC&#34;</span>)
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define</span> contacts
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>for/list</span> ([(contact) (in-query sms-db user-query chat-id)])
</span></span><span style=display:flex><span>             (find-contact (normalize-contact contact))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>; Load the individual messages</span>
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define</span> msg-query <span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  message.ROWID as message_id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  message.date,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  message.service,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  message.is_from_me,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  handle.id as them,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  (CASE WHEN message.subject IS NULL THEN &#39;&#39; ELSE message.subject END),
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  (CASE WHEN message.text IS NULL THEN &#39;&#39; ELSE message.text END),
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  (SELECT group_concat(attachment.filename)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     FROM message_attachment_join, attachment
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     WHERE message_attachment_join.message_id = message.ROWID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>       AND message_attachment_join.attachment_id = attachment.ROWID)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  chat_message_join,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  message,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  handle
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WHERE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  chat_id = ?
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  AND message_id = message.ROWID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  AND handle_id = handle.ROWID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ORDER BY date ASC&#34;</span>)
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define</span> messages
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>for/list</span> ([(message-id
</span></span><span style=display:flex><span>                        raw-date
</span></span><span style=display:flex><span>                        service
</span></span><span style=display:flex><span>                        from-me?
</span></span><span style=display:flex><span>                        other-party
</span></span><span style=display:flex><span>                        subject
</span></span><span style=display:flex><span>                        text
</span></span><span style=display:flex><span>                        raw-attachments)
</span></span><span style=display:flex><span>                       (in-query sms-db msg-query chat-id)])
</span></span><span style=display:flex><span>             <span style=color:#75715e>; Correct dates from Apple time to unix time</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>; TODO: Account for timezones?</span>
</span></span><span style=display:flex><span>             (<span style=color:#66d9ef>define</span> date (seconds-&gt;date (+ raw-date <span style=color:#ae81ff>978336000</span> (- (* <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>60</span> <span style=color:#ae81ff>60</span>))) <span style=color:#66d9ef>#f</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             (<span style=color:#66d9ef>define</span> sender
</span></span><span style=display:flex><span>               (<span style=color:#66d9ef>if</span> (= <span style=color:#ae81ff>1</span> from-me?)
</span></span><span style=display:flex><span>                   (backup-phone-number (current-backup))
</span></span><span style=display:flex><span>                   (normalize-contact other-party)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>; Load attachments,</span>
</span></span><span style=display:flex><span>             (<span style=color:#66d9ef>define</span> attachments
</span></span><span style=display:flex><span>               (<span style=color:#66d9ef>if</span> (sql-null? raw-attachments)
</span></span><span style=display:flex><span>                   <span style=color:#f92672>&#39;</span>()
</span></span><span style=display:flex><span>                   (<span style=color:#66d9ef>for/list</span> ([path (in-list (string-split raw-attachments <span style=color:#e6db74>&#34;,&#34;</span>))])
</span></span><span style=display:flex><span>                     (attachment
</span></span><span style=display:flex><span>                      (path-&gt;string (last (explode-path path)))
</span></span><span style=display:flex><span>                      (build-path (backup-path (current-backup))
</span></span><span style=display:flex><span>                                  (hash-filename path))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             (message date service sender subject text attachments)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>; Create the chat object</span>
</span></span><span style=display:flex><span>         (chat contacts messages))))))
</span></span></code></pre></div><p>Theoretically, that should be a fairly direct translation. One interesting bit is the format of <code>date</code>. It&rsquo;s actually a timestamp, but not a normal <a href=https://en.wikipedia.org/wiki/Unix%20timestamp>Unix timestamp</a>. So I have a bit of a <a href=https://en.wikipedia.org/wiki/magic%20number>magic number</a>, but it works correctly for my backups, so we&rsquo;ll just leave it for the moment. Other than that, we use the <code>hash-filename</code> function from last time to get a local path for any <code>attachment</code> and we&rsquo;ve got everything pretty much written.</p><p>And that&rsquo;s really all we need. One thing that would be nice to be able to do though is, given a contact, filter for only the messages with that contact (either directly or in group chats as well):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span><span style=color:#75715e>; Get all chats involving a specific chat</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define</span> (find-chats-by-contact contact <span style=color:#66d9ef>#:direct?</span> [direct? <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Allow the user to specify the contact by name / phone number / email / etc</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>when</span> (not (contact? contact))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>set!</span> contact (find-contact contact)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Filter the list of chats</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>for/list</span> ([chat (in-list (list-chats))]
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>#:when</span> (<span style=color:#66d9ef>if</span> direct?
</span></span><span style=display:flex><span>                        (equal? (list contact) (chat-contacts chat))
</span></span><span style=display:flex><span>                        (member contact (chat-contacts chat))))
</span></span><span style=display:flex><span>    chat))
</span></span></code></pre></div><p>If you have an iOS device, check it out. It makes certain things really easy. For example, if I want to have a log of every word that I&rsquo;ve ever said in a conversation with Jenny:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>&gt; (with-backup <span style=color:#e6db74>&#34;86b18...aa36&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>for*/list</span> ([chat (in-list (find-chats-by-contact <span style=color:#e6db74>&#34;Jenny&#34;</span> <span style=color:#66d9ef>#:direct?</span> <span style=color:#66d9ef>#t</span>))]
</span></span><span style=display:flex><span>                [message (in-list (chat-messages chat))])
</span></span><span style=display:flex><span>      (message-text message)))
</span></span><span style=display:flex><span><span style=color:#f92672>&#39;</span>(<span style=color:#e6db74>&#34;Jenny, Jenny, who can I turn to?&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;You give me somethin&#39; I can hold on to&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>...</span>)
</span></span></code></pre></div><p>That&rsquo;s exactly the sort of that prompted this entire thought: the ability to take the fairly opaque structure of iOS backups and dump them into an easily readable / easily diffable format for my own purposes. Sweet.</p><p>If you&rsquo;d like to see the entire project, you can do so on GitHub: <a href=https://github.com/jpverkamp/ios-backup>ios-backup</a>. Alternatively, it&rsquo;s set up as a package, so you should be able to install it with <code>raco pkg install</code>. If you do, just import one or more of these:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>(<span style=color:#66d9ef>require</span> ios-backup
</span></span><span style=display:flex><span>         ios-backup/contacts
</span></span><span style=display:flex><span>         ios-backup/messages)
</span></span></code></pre></div><p>Here is a list of all of the posts in this series:</p><div class=ranking><h3 class=title>Posts in <a href=/series/ios-backups-in-racket/>iOS Backups in Racket</a>:</h3><div class=content><ul><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/>iOS Backups in Racket: Groundwork</a></li><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/>iOS Backups in Racket: Contacts</a></li><li><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/>iOS Backups in Racket: Messages</a></li><li><a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/>iOS Backups in Racket: Apps</a></li></ul></div></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
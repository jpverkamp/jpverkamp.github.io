<!DOCTYPE html>
<html onclick >
<head>
    <title>iOS Backups in Racket: Apps – jverkamp.com</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a> *
            <a href="/resume">Resume</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>
    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/maker/">Maker</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">iOS Backups in Racket: Apps</h1>

        <div class="entry-meta"><span class="entry-date">2015-01-29</span>
            </div>

        <div class="entry-taxonomies"><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2015/04/07/generating-perfect-portmanteaus/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a><a href="https://blog.jverkamp.com/2021/08/05/raco-pkg-install-noise/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/backups">Backups</a><a href="https://blog.jverkamp.com/2015/07/02/scraping-kindle-highlights/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/data-structures">Data Structures</a><a href="https://blog.jverkamp.com/2016/12/11/aoc-2016-day-11-radiation-avoider/" class="next-link"></a></li><li><a class="taxonomy-value" href="/programming/topics/file-formats">File Formats</a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="previous-link"></a><a class="taxonomy-value" href="/series/ios-backups-in-racket">iOS Backups in Racket</a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2015/02/04/docker-bash-and-docker-stop-all/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2015/02/02/writing-excuses-10.3-watching-the-end-of-the-world/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</div>
    </header>

	<div class="entry-content"><p>So far we&rsquo;ve read <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">backup files</a>, parsed <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/">contacts</a>, and parsed <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/">messages</a>. Today we&rsquo;re going to dig a little deeper and start parsing apps specifically.</p>
<p>First things first, let&rsquo;s get a list of applications. That&rsquo;s actually in two different files: <code>Manifest.plist</code> and <code>Manifest.mbdb</code>. In versions of iTunes prior to 9.2, <code>Manifest.plist</code> had a nice listing of files, but now it only contains the list of applications. Still, that&rsquo;s a good enough place to start.</p>
<p>Remember back in the <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">first post</a>? We learned how how to read plist files. In this one in particular, we have a list of installed applications, using their internal names:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">(<span style="color:#66d9ef">struct</span> app (name plist files) <span style="color:#66d9ef">#:prefab</span> <span style="color:#66d9ef">#:mutable</span>)
(<span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">file</span> (name path) <span style="color:#66d9ef">#:prefab</span>)

<span style="color:#75715e">; List all installed applications</span>
(<span style="color:#66d9ef">define</span> (list-apps)
  (hash-ref!
   apps-by-backup
   (current-backup)
   (<span style="color:#66d9ef">λ</span> ()
     (<span style="color:#66d9ef">for/list</span> ([name (in-list
                       (hash-ref
                        (call-with-input-file
                          (build-path (backup-path (current-backup))
                                                   <span style="color:#e6db74">&#34;Info.plist&#34;</span>)
                          read-plist/jsexpr)
                        <span style="color:#f92672">&#39;</span><span style="color:#e6db74">|Installed Applications|</span>))])
       (app name <span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span>)))))<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>For the moment, we&rsquo;ll leave out the plist and files. Eventually, plist is going to store a list of properties stored with the application (all apps have it, even if some don&rsquo;t store anything interesting). Files will store any files stored in the local filesystem for app in specific.</p>
<p>So how does it work?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (with-backup <span style="color:#e6db74">&#34;86b1...aa36&#34;</span>
    (map app-name (list-apps)))
<span style="color:#f92672">&#39;</span>(<span style="color:#e6db74">&#34;com.google.Maps&#34;</span>
  <span style="color:#e6db74">&#34;com.apple.mobilesms.notification&#34;</span>
  <span style="color:#e6db74">&#34;com.roku.ios.roku&#34;</span>
  <span style="color:#e6db74">...</span>
  <span style="color:#e6db74">&#34;com.apple.iBooks&#34;</span>
  <span style="color:#e6db74">&#34;com.apple.MobileSMS&#34;</span>
  <span style="color:#e6db74">&#34;com.apple.CoreAuthUI&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Neat. That&rsquo;s pretty much exactly what I was hoping to see.</p>
<p>Next, let&rsquo;s load up the plists. On doing some digging around, it looks like every app will have a file with a path something like <code>AppDomain-Library/Preferences/{app-name}.plist</code>, so let&rsquo;s try to load that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Load an app&#39;s plist file</span>
(<span style="color:#66d9ef">define</span> (load-plist! app)
  (set-app-plist!
   app
   (<span style="color:#66d9ef">let</span> ([plist-path
          (build-path
           (backup-path (current-backup))
           (hash-filename
            (~a <span style="color:#e6db74">&#34;Library/Preferences/&#34;</span> (app-name app) <span style="color:#e6db74">&#34;.plist&#34;</span>)
            (~a <span style="color:#e6db74">&#34;AppDomain-&#34;</span> (app-name app))))])

     <span style="color:#75715e">; Try to load in text mode first, if that fails fall back to binary</span>
     (<span style="color:#66d9ef">with-handlers</span> ([exn? (<span style="color:#66d9ef">λ</span> (exn)
                             (call-with-input-file plist-path
                               read-plist/jsexpr/binary))])
       (call-with-input-file plist-path read-plist/jsexpr)))))<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Here we run into our first wrinkle. It turns out that while the <code><a href="http://docs.racket-lang.org/search/index.html?q=xml/plist">xml/plist</a></code>
 file works just fine on the text format plist files, it doesn&rsquo;t deal well with binary ones. And unfortunately most (if not all) apps use the binary format. So we need something that will be able to convert and load those (warning, this is ugly):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Read a plist file as a JSON expression from a binary plist file</span>
(<span style="color:#66d9ef">define</span> (read-plist/jsexpr/binary [in (current-input-port)])
  <span style="color:#75715e">; Copy the file to a temporary path</span>
  (<span style="color:#66d9ef">define</span> temp-filename (~a (gensym) <span style="color:#e6db74">&#34;.plist&#34;</span>))
  (call-with-output-file temp-filename
    (<span style="color:#66d9ef">λ</span> (out) (copy-port in out)))

  <span style="color:#75715e">; Run Apple&#39;s plutil to convert it</span>
  <span style="color:#75715e">; Redirect err to suppress from missing programs</span>
  (<span style="color:#66d9ef">parameterize</span> ([current-error-port (open-output-nowhere)])
    (<span style="color:#66d9ef">for*</span> ([path
            (in-list
              <span style="color:#f92672">&#39;</span>(<span style="color:#e6db74">&#34;plutil&#34;</span>
                <span style="color:#e6db74">&#34;plutil.exe&#34;</span>
                <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Program Files (x86)</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Common Files</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Apple</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Apple Application Support</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">plutil.exe</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>
                <span style="color:#e6db74">&#34;&#34;</span><span style="color:#e6db74">\&#34;C:\\Program</span> <span style="color:#e6db74">Files\\Common</span> <span style="color:#e6db74">Files\\Apple\\Apple</span> <span style="color:#e6db74">Application</span> <span style="color:#e6db74">Support\\plutil.exe\&#34;</span><span style="color:#e6db74">&#34;))]
</span><span style="color:#e6db74">           [return (in-value (system (~a path &#34;</span> <span style="color:#e6db74">-convert</span> <span style="color:#e6db74">xml1</span> <span style="color:#e6db74">&#34; temp-filename)))]
</span><span style="color:#e6db74">           #:break return)
</span><span style="color:#e6db74">      #t))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  ; Patch over xml/plist&#39;s handling of empty string element
</span><span style="color:#e6db74">  (define plist-fixed-content
</span><span style="color:#e6db74">    (regexp-replace* #px&#34;</span><span style="color:#e6db74">&lt;string&gt;&lt;/string&gt;</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">                     (file-&gt;string temp-filename)
</span><span style="color:#e6db74">                     &#34;</span><span style="color:#e6db74">&lt;string&gt;</span> <span style="color:#e6db74">&lt;/string&gt;</span><span style="color:#e6db74">&#34;))
</span><span style="color:#e6db74">  (delete-file temp-filename)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  ; Read the plist into memory and remove the temporary file
</span><span style="color:#e6db74">  (call-with-input-string plist-fixed-content read-plist/jsexpr))
</span></code></pre></div><p>Basically, if you have iTunes installed, it comes with a program (on Windows, it&rsquo;s built in on OSX) called <code>plutil</code>. That can be used to convert between binary, xml, and json formats of plist files. Unfortunately though, the json format cannont handle a lot of plists, so we have to convert to xml and then use our previous <code>plist-&gt;jsexpr</code> function to convert it.</p>
<p>Other hacks: we have to copy it to a temporary file. It&rsquo;s probably possible to open <code>plutil</code> and pass the file on stdin and read from stdout instead, but this works so we&rsquo;ll leave it as is for the moment.</p>
<p>Finally, another caveat of the <code><a href="http://docs.racket-lang.org/search/index.html?q=xml/plist">xml/plist</a></code>
 library: it breaks on empty string elements. So there&rsquo;s a fix above to take any empty string elements and insert a single space into them. Hacky, but so it goes. When all this is said and done though, we can use this to read in the plist data for an application:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (with-backup <span style="color:#e6db74">&#34;86b18eea28a991f4dd569d1f59737a842e24aa36&#34;</span>
    (<span style="color:#66d9ef">let</span> ([app (list-ref (list-apps) <span style="color:#ae81ff">12</span>)])
      (load-plist! app)
      app))

<span style="color:#f92672">&#39;#s</span>((<span style="color:#e6db74">app</span> <span style="color:#f92672">#</span>(<span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span>))
    <span style="color:#e6db74">&#34;com.google.Maps&#34;</span>
    <span style="color:#f92672">#hash</span>((<span style="color:#e6db74">WebKitCacheModelPreferenceKey</span> <span style="color:#f92672">.</span> <span style="color:#ae81ff">1</span>)
          (<span style="color:#e6db74">WebKitDiskImageCacheSavedCacheDirectory</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34; &#34;</span>)
          (<span style="color:#e6db74">WebKitMediaPlaybackAllowsInline</span> <span style="color:#f92672">.</span> <span style="color:#66d9ef">#t</span>)
          (<span style="color:#e6db74">WebKitOfflineWebApplicationCacheEnabled</span> <span style="color:#f92672">.</span> <span style="color:#66d9ef">#t</span>)
          (<span style="color:#e6db74">WebKitShrinksStandaloneImagesToFit</span> <span style="color:#f92672">.</span> <span style="color:#66d9ef">#t</span>)
          <span style="color:#e6db74">...</span>
          (<span style="color:#e6db74">kGIPMicPermissionControllerPermissionRequested</span> <span style="color:#f92672">.</span> <span style="color:#66d9ef">#t</span>)
          (<span style="color:#e6db74">kGMSMapsUserClientLegalCountry</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;US&#34;</span>)
          (<span style="color:#e6db74">kGMSUserEvent3LoggerSequenceIDKey</span> <span style="color:#f92672">.</span> <span style="color:#ae81ff">8860</span>))
    <span style="color:#66d9ef">#f</span>)<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Whee! For any particular app, I&rsquo;m not entirely sure what I&rsquo;m looking for, but there&rsquo;s a whole heck of a lot of information there.</p>
<p>But one thing that I was hoping to find is still missing: a list of files for a given application. I was hoping each application would know that, but apparently not. Then again, why would they? A given application probably knows exactly what files it&rsquo;s looking for, it doesn&rsquo;t have to list them.</p>
<p>Fine. I guess I have to read that <code>Manifest.mbdb</code> file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ xxd <span style="color:#e6db74">&#34;Manifest.mbdb&#34;</span>

0000000: 6d62 <span style="color:#ae81ff">6462</span> <span style="color:#ae81ff">0500</span> 001d <span style="color:#ae81ff">4170</span> <span style="color:#ae81ff">7044</span> 6f6d <span style="color:#ae81ff">6169</span>  mbdb....AppDomai
0000010: 6e2d 636f 6d2e 6f6f 6b6c 612e <span style="color:#ae81ff">7370</span> <span style="color:#ae81ff">6565</span>  n-com.ookla.spee
0000020: <span style="color:#ae81ff">6474</span> <span style="color:#ae81ff">6573</span> <span style="color:#ae81ff">7400</span> 00ff ffff ffff ff41 ed00  dtest........A..
0000030: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> 005f bc00 <span style="color:#ae81ff">0001</span> f500 <span style="color:#ae81ff">0001</span> f554  ....._.........T
0000040: <span style="color:#ae81ff">3044</span> <span style="color:#ae81ff">1354</span> <span style="color:#ae81ff">3044</span> <span style="color:#ae81ff">1354</span> <span style="color:#ae81ff">2757</span> c900 <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  0D.T0D.T<span style="color:#e6db74">&#39;W......
</span><span style="color:#e6db74">0000050: 0000 0000 0000 1d41 7070 446f 6d61 696e  .......AppDomain
</span><span style="color:#e6db74">0000060: 2d63 6f6d 2e6f 6f6b 6c61 2e73 7065 6564  -com.ookla.speed
</span><span style="color:#e6db74">0000070: 7465 7374 0007 4c69 6272 6172 79ff ffff  test..Library...
</span><span style="color:#e6db74">0000080: ffff ff41 ed00 0000 0000 0013 b600 0001  ...A............
</span><span style="color:#e6db74">0000090: f500 0001 f554 2757 c954 2758 1f54 1b09  .....T&#39;</span>W.T<span style="color:#960050;background-color:#1e0010">&#39;</span>X.T..
00000a0: df00 <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> 1d41 <span style="color:#ae81ff">7070</span>  .............App
00000b0: 446f 6d61 696e 2d63 6f6d 2e6f 6f6b 6c61  Domain-com.ookla
...
</code></pre></div><p>Right. That&rsquo;s some sort of binary file. I can see the app names repeated several times for each app, but we&rsquo;re still going to have to figure out the format.</p>
<p>Luckily for me, the format has already been relatively well reverse engineered<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. First, we have a file header, the bytes <code>mbdb\5\0</code>. The last two are probably versioning, but so far as I can tell, it hasn&rsquo;t changed. So we&rsquo;ll skip over that for the moment.</p>
<p>Next, we have a sequence of records:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Name</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>domain</td>
<td>Used for <code>hash-filename</code></td>
</tr>
<tr>
<td>string</td>
<td>path</td>
<td></td>
</tr>
<tr>
<td>string</td>
<td>target</td>
<td>Absolute path, only for <a href="https://en.wikipedia.org/wiki/symlinks">symlinks</a></td>
</tr>
<tr>
<td>string</td>
<td>data hash</td>
<td>SHA1 (for encrypted files)</td>
</tr>
<tr>
<td>string</td>
<td>encryption key</td>
<td></td>
</tr>
<tr>
<td>uint16</td>
<td>mode</td>
<td>file/directory/symlink (see below)</td>
</tr>
<tr>
<td>uint64</td>
<td><a href="https://en.wikipedia.org/wiki/inode">inode</a></td>
<td></td>
</tr>
<tr>
<td>uint32</td>
<td>user id</td>
<td></td>
</tr>
<tr>
<td>uint32</td>
<td>group id</td>
<td></td>
</tr>
<tr>
<td>uint32</td>
<td>last modified</td>
<td></td>
</tr>
<tr>
<td>uint32</td>
<td>last accessed</td>
<td></td>
</tr>
<tr>
<td>uint32</td>
<td>created at</td>
<td></td>
</tr>
<tr>
<td>uint64</td>
<td>file size</td>
<td>0 for symlinks and directories</td>
</tr>
<tr>
<td>uint8</td>
<td>data protection class</td>
<td>0 if special (link, directory), otherwise ranges from 1-11</td>
</tr>
<tr>
<td>uint8</td>
<td>property count</td>
<td>number of properties following</td>
</tr>
</tbody>
</table>
<p>This is then followed by a list of properties:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Name</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>name</td>
<td></td>
</tr>
<tr>
<td>string</td>
<td>value</td>
<td>either UTF8 or binary data</td>
</tr>
</tbody>
</table>
<p>That sounds pretty straight forward (relatively speaking). Let&rsquo;s write a function to read it. We want to fill out this structure:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">(<span style="color:#66d9ef">struct</span> record (domain path hash mode size properties) <span style="color:#66d9ef">#:prefab</span>)
(<span style="color:#66d9ef">struct</span> property (name value) <span style="color:#66d9ef">#:prefab</span>)<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>In general LISP style (so far as I understand it), we will write a series of functions named <code>read-*</code>, each of which will read the specified form of data from the current input port. Then, for example, we can have a <code>read-mbdb</code> function, which calls <code>read-record</code>, which in turn has a bunch of calls to either <code>read-uint</code> or <code>read-string</code> followed by zero or more calls to <code>read-property</code>.</p>
<p>Starting at the outermost layer, lets read an entire file. Specifically, we want a function that will read off those 6 header bytes then continuously read records until the end of the file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Read mdbd records until eof</span>
(<span style="color:#66d9ef">define</span> (read-mbdb [in (current-input-port)])
  (read-bytes <span style="color:#ae81ff">6</span> in)
  (<span style="color:#66d9ef">let</span> loop ()
    (<span style="color:#66d9ef">cond</span>
      [(eof-object? (peek-char in)) <span style="color:#f92672">&#39;</span>()]
      [<span style="color:#66d9ef">else</span>
       (cons (read-record in) (loop))])))<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Having that, we need the ability to read an individual record:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Read an mbdb record</span>
(<span style="color:#66d9ef">define</span> (read-record [in (current-input-port)])

  (<span style="color:#66d9ef">define</span> domain (read-string-data in))
  (<span style="color:#66d9ef">define</span> path (read-string-data in))
  (<span style="color:#66d9ef">define</span> link-target (read-string-data in))
  (<span style="color:#66d9ef">define</span> data-hash (read-string-data in))
  (<span style="color:#66d9ef">define</span> encryption-key (read-string-data in))

  (<span style="color:#66d9ef">define</span> raw-mode (read-uint <span style="color:#ae81ff">2</span> in))
  (<span style="color:#66d9ef">define</span> mode
    (<span style="color:#66d9ef">case</span> (arithmetic-shift raw-mode <span style="color:#ae81ff">-12</span>)
      [(<span style="color:#ae81ff">#xA</span>) (list <span style="color:#f92672">&#39;</span><span style="color:#e6db74">symlink</span> link-target)]
      [(<span style="color:#ae81ff">#x8</span>) <span style="color:#f92672">&#39;</span><span style="color:#e6db74">file</span>]
      [(<span style="color:#ae81ff">#x4</span>) <span style="color:#f92672">&#39;</span><span style="color:#e6db74">directory</span>]))

  (<span style="color:#66d9ef">define</span> inode (read-uint <span style="color:#ae81ff">8</span> in))
  (<span style="color:#66d9ef">define</span> user-id (read-uint <span style="color:#ae81ff">4</span> in))
  (<span style="color:#66d9ef">define</span> group-id (read-uint <span style="color:#ae81ff">4</span> in))

  (<span style="color:#66d9ef">define</span> last-modified (read-uint <span style="color:#ae81ff">4</span> in))
  (<span style="color:#66d9ef">define</span> last-accessed (read-uint <span style="color:#ae81ff">4</span> in))
  (<span style="color:#66d9ef">define</span> created-at (read-uint <span style="color:#ae81ff">4</span> in))
  (<span style="color:#66d9ef">define</span> file-size (read-uint <span style="color:#ae81ff">8</span> in))

  (<span style="color:#66d9ef">define</span> data-protection-class (read-uint <span style="color:#ae81ff">1</span> in)) <span style="color:#75715e">; 0x1 to 0xB</span>
  (<span style="color:#66d9ef">define</span> property-count (read-uint <span style="color:#ae81ff">1</span> in))

  (<span style="color:#66d9ef">define</span> properties
    (<span style="color:#66d9ef">for/list</span> ([i (in-range property-count)])
      (<span style="color:#66d9ef">define</span> name (read-string-data in))
      (<span style="color:#66d9ef">define</span> value (read-string-data in))
      (property name value)))

  (<span style="color:#66d9ef">define</span> hash (hash-filename path domain))

  (record domain path hash mode file-size properties))<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Other than the missing functions, one caveat here is the definition of <code>mode</code>. I&rsquo;m not actually sure what&rsquo;s in the other three half bytes, but all we care about is in the first. If it&rsquo;s <code>A</code>, it&rsquo;s a symlink. <code>8</code> is a file; <code>4</code> is a directory. That handles every entry at least on my phone.</p>
<p>Also, you may note that we&rsquo;re not returning all of the data in the records. Honestly, for most of it I just don&rsquo;t need it. It&rsquo;s useful if you&rsquo;re trying to do more interesting things and then write back to the backup, but just to read it? We don&rsquo;t care about user/group ids, et al. It&rsquo;s all there though, with just a tweak. Perhaps I&rsquo;ll figure out a way to pull out the full record if wanted in the future.</p>
<p>Okay, so next, what does it mean to <code>read-uint</code>? Well, we&rsquo;re going to have anywhere from 1 to 8 bytes, which we then need to turn into a single value. That&rsquo;s easy enough doing a base conversion (from essentially base 256 to base 10):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Read size bytes as a big-endian unsigned integer</span>
(<span style="color:#66d9ef">define</span> (read-uint size [in (current-input-port)])
  (<span style="color:#66d9ef">define</span> b* (read-bytes size in))
  (<span style="color:#66d9ef">for/sum</span> ([i (in-naturals)]
            [b (in-bytes b*)])
    (* (expt <span style="color:#ae81ff">256</span> (- (bytes-length b*) i <span style="color:#ae81ff">1</span>)) b)))<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Cool. That means that all that&rsquo;s left is reading strings. Luckily, they have a nice format. Rather than <a href="https://en.wikipedia.org/wiki/null%20terminated%20strings">null terminated strings</a> a la C/C++, they store first the length of the string (as a <code>uint16</code>) and then that many bytes. There are two caveats though:</p>
<ul>
<li>If the size is maxed (<code>#xFFFF</code>), it&rsquo;s actually empty</li>
<li>This same datatype can be either a UTF8 string or raw binary data (try to parse it as a string, fall back to bytes)</li>
</ul>
<p>Codewise:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Read a length + string, if length if #xFFFF the string is empty</span>
<span style="color:#75715e">; Note: Sometimes &#39;strings&#39; are actually binary data, return those as bytes</span>
(<span style="color:#66d9ef">define</span> (read-string-data [in (current-input-port)])
  (<span style="color:#66d9ef">define</span> size (read-uint <span style="color:#ae81ff">2</span> in))
  (<span style="color:#66d9ef">cond</span>
    [(equal? size <span style="color:#ae81ff">#xFFFF</span>) <span style="color:#e6db74">&#34;&#34;</span>]
    [<span style="color:#66d9ef">else</span>
     (<span style="color:#66d9ef">define</span> raw (read-bytes size in))
     (<span style="color:#66d9ef">with-handlers</span> ([exn? (<span style="color:#66d9ef">λ</span> (<span style="color:#66d9ef">_</span>) raw)])
       (bytes-&gt;string/utf-8 raw))]))<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Cool.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (with-backup <span style="color:#e6db74">&#34;86b1...aa36&#34;</span>
    (call-with-input-file (build-path (backup-path (current-backup))
                                      <span style="color:#e6db74">&#34;Manifest.mbdb&#34;</span>)
      read-mbdb))
<span style="color:#f92672">&#39;</span>(<span style="color:#f92672">#s</span>(<span style="color:#e6db74">record</span> <span style="color:#e6db74">&#34;AppDomain-com.ookla.speedtest&#34;</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#66d9ef">#f</span> <span style="color:#e6db74">directory</span> <span style="color:#ae81ff">0</span> ())
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">record</span> <span style="color:#e6db74">&#34;AppDomain-com.ookla.speedtest&#34;</span> <span style="color:#e6db74">&#34;Library&#34;</span> <span style="color:#e6db74">&#34;83fee2b4383a3d59c99185862e220d5a0a77d546&#34;</span> <span style="color:#e6db74">directory</span> <span style="color:#ae81ff">0</span> ())
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">record</span> <span style="color:#e6db74">&#34;AppDomain-com.ookla.speedtest&#34;</span> <span style="color:#e6db74">&#34;Library/Preferences&#34;</span> <span style="color:#e6db74">&#34;726b41739d2c95794288f354134f75515db58dbd&#34;</span> <span style="color:#e6db74">directory</span> <span style="color:#ae81ff">0</span> ())
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">record</span>
     <span style="color:#e6db74">&#34;AppDomain-com.ookla.speedtest&#34;</span>
     <span style="color:#e6db74">&#34;Library/Preferences/com.ookla.speedtest.plist&#34;</span>
     <span style="color:#e6db74">&#34;dc4081fac8bf5bdf6ed025d3da24e6b8a287c4fb&#34;</span>
     <span style="color:#e6db74">file</span>
     <span style="color:#ae81ff">620</span>
     ())
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">record</span>
     <span style="color:#e6db74">&#34;AppDomain-com.ookla.speedtest&#34;</span>
     <span style="color:#e6db74">&#34;Library/Preferences/com.apple.PeoplePicker.plist&#34;</span>
     <span style="color:#e6db74">&#34;f9e644265dbcc0a7179c631e0ba3173868663b04&#34;</span>
     (<span style="color:#e6db74">symlink</span> <span style="color:#e6db74">&#34;/private/var/mobile/Library/Preferences/com.apple.PeoplePicker.plist&#34;</span>)
     <span style="color:#ae81ff">0</span>
     ())
  <span style="color:#e6db74">...</span>)<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>It&rsquo;s kind of neat how cleanly binary formats can actually be read at least if they&rsquo;re relatively well documented.</p>
<p>Let&rsquo;s go ahead and add this to the <code>app</code> structure and then write a helper as we have before to find a specific app:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Load the list of files associated with an app</span>
(<span style="color:#66d9ef">define</span> (load-files! app)
  (<span style="color:#66d9ef">define</span> app-domain (~a <span style="color:#e6db74">&#34;AppDomain-&#34;</span> (app-name app)))

  (set-app-files!
   app
   (<span style="color:#66d9ef">for/list</span> ([record (in-list (list-mdbd-records))]
              <span style="color:#66d9ef">#:when</span> (<span style="color:#66d9ef">and</span> (equal? (record-domain record) app-domain)
                          (eq? <span style="color:#f92672">&#39;</span><span style="color:#e6db74">file</span> (record-mode record))))
     (<span style="color:#66d9ef">file</span> (record-path record)
           (build-path (backup-path (current-backup)) (record-hash record))))))

<span style="color:#75715e">; Find an app by name (actually a case insensative regex)</span>
<span style="color:#75715e">; plists and files in domain are loaded when this is called and cached</span>
(<span style="color:#66d9ef">define</span> (find-app name)
  (<span style="color:#66d9ef">define</span> app
    (<span style="color:#66d9ef">for/first</span> ([app (in-list (list-apps))]
                <span style="color:#66d9ef">#:when</span> (regexp-match (~a <span style="color:#e6db74">&#34;(?i:&#34;</span> name <span style="color:#e6db74">&#34;)&#34;</span>) (app-name app)))
      app))

  <span style="color:#75715e">; If this app is missing it&#39;s plist / files, load them</span>
  (<span style="color:#66d9ef">when</span> (<span style="color:#66d9ef">and</span> app (not (app-plist app))) (load-plist! app))
  (<span style="color:#66d9ef">when</span> (<span style="color:#66d9ef">and</span> app (not (app-files app))) (load-files! app))

  app)<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Yes, this does has the disadvantage that if you just <code>list-apps</code>, you won&rsquo;t get the plists and file lists. On the flip side though, this one uses a regex, so you can just search by app name. Most developers (although not all I&rsquo;ve found) will include that as part of their internal name. They take a bit to load though, especially if you have a lot of apps, so I think that&rsquo;s a fair enough trade off. It&rsquo;s still caching <code>Manifest.mbdb</code> though, so at least that only has to be read once:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">(<span style="color:#66d9ef">define</span> mdbd-records-by-backup (make-hash))
(hash-set! mdbd-records-by-backup <span style="color:#66d9ef">#f</span> <span style="color:#f92672">&#39;</span>())

<span style="color:#75715e">; Get all MDBD records</span>
(<span style="color:#66d9ef">define</span> (list-mdbd-records)
  (hash-ref!
   mdbd-records-by-backup
   (current-backup)
   (<span style="color:#66d9ef">λ</span> ()
     (call-with-input-file (build-path (backup-path (current-backup))
                                       <span style="color:#e6db74">&#34;Manifest.mbdb&#34;</span>)
       read-mbdb))))<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Once you start digging through these lists, there are some pretty interesting files &hellip; but that will have to wait for another post. This one is already pretty long. I think I&rsquo;ll have at least one more post in this series taking everything I&rsquo;ve done thus far and turning it into an actual backup solution. Keep an eye out!</p>
<p>The full source thus far (and I&rsquo;ve finally caught up) is on GitHub: <a href="https://github.com/jpverkamp/ios-backup">ios-backup</a>.</p>
<p>If you&rsquo;ve installed <code>ios-backup</code> as a library, you can import these new functions with <code>(require ios-backup/apps)</code> or if you really want to get adventerous <code>(require ios-backup/mbdb)</code>.</p>
<p>Here is a list of all of the posts in this series:</p>
<div class="ranking">
    <h3 class="title">Posts in <a href="/series/ios-backups-in-racket/">iOS Backups in Racket</a>:</h3>
    <div class="content">
        <ul><li>
                <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">
                    iOS Backups in Racket: Groundwork
                </a></li><li>
                <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/">
                    iOS Backups in Racket: Contacts
                </a></li><li>
                <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/">
                    iOS Backups in Racket: Messages
                </a></li><li>
                <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">
                    iOS Backups in Racket: Apps
                </a></li></ul>
    </div>
</div>

<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>initial source: <a href="https://code.google.com/p/iphonebackupbrowser/wiki/MbdbMbdxFormat">iphonebackupbrowser</a>, although some of the details came from elsewhere <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>
</article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script src="/custom.js"></script>
</body>
</html>

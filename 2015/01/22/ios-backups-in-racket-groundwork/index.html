<!DOCTYPE html>
<html>
<head>
    <title>
    iOS Backups in Racket: Groundwork – jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">iOS Backups in Racket: Groundwork</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2015-01-22</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/09/let-it-snow/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/09/let-it-snow/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2012/09/05/backing-up-google-reader-/-calendar/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/backups">Backups</a>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/06/17/factor-trees/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/data-structures">Data Structures</a>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/series/ios-backups-in-racket">iOS Backups in Racket</a>
                        <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="next-link"></a>
                    </li>
                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/01/09/let-it-snow/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/01/21/writing-excuses-10.2-combine-and-grow/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>For the last little while, I&rsquo;ve been spending my spare programming time working on a slightly larger project than I normally do: a <a href="https://blog.jverkamp.com/2014/06/11/call-stack-bracket-matcher/">Racket</a> library for reading iOS backups.</p>

<p>Basically, I want to take the mess that is an iOS backup (not particularly designed to be easy to read by other programs) and extract some information from it, backing it up in a more easily readable format.</p>

<p>Specifically, I would like to be able to backup:</p>

<ul>
<li>Contact information: Even thought they&rsquo;re mostly from Facebook, it will be useful for the other parts</li>
<li>Messages: These are taking up a large portion of my phone&rsquo;s hard drive, mostly due to attachments. Back them up just in case<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup><sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup></li>
<li>Photos: I&rsquo;m already backing these up, but it would be nice to have it in the same process</li>
<li>Application data:</li>
<li>List of applications over time</li>
<li><a href="https://www.moves-app.com/">Moves</a>: GPS location</li>
<li><a href="http://www.downcastapp.com/">Downcast</a>: List of current podcasts</li>
<li><a href="http://www.sleepcycle.com/">Sleep Cycle</a>: Sleep data</li>
<li><a href="http://www.boardgamescorer.com/">Boardgame Scorer</a>: High scores for board games</li>
</ul>

<p></p>

<p>The first thing to look at is the basic structure of the iOS backup directory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">~/Library/Application Support/MobileSync/Backup/
    86b1...aa36/
        0003...1b9a
        0009...521c
        000b...46ab
        ...
        fff6...5152
        fff8...9f8a
        fffa...ca34
        Info.plist
        Manifest.mbdb
        Manifest.plist
        Status.plist</code></pre></div>
<p>Okay, that&rsquo;s helpful<sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup>. 6788 files, all but four of which named via <a href="https://en.wikipedia.org/wiki/SHA-1">SHA-1</a> hashes. I know that there are pictures, applications, and various databases here, so there has to be a map somewhere.</p>

<p>But first, those last four files:</p>

<ul>
<li><code>Info.plist</code> - Contains information about the backup, including the phone&rsquo;s name, various IDs, the phone&rsquo;s number, and versioning information</li>
<li><code>Manifest.mbdb</code> - Binary file containing a listing of every file in the backup</li>
<li><code>Manifest.plist</code> - Legacy file, useful information is mostly a list of installed applications</li>
<li><code>Status.plist</code> - Mostly a subset of the information in <code>Info.plist</code></li>
</ul>

<p>Of those, we&rsquo;ll start with the first one. We want to be able to load that information into a basic structure to represent a backup:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Represents an iPhone backup on disk</span>
(<span style="color:#66d9ef">struct</span> backup (name hash date phone-number path) <span style="color:#66d9ef">#:prefab</span>)</code></pre></div>
<p>Cool. First thing first, let&rsquo;s find the backups on disk. We want to be able to support either Windows or OSX (I use both), so try both locations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Load all backups on disk into a list</span>
(<span style="color:#66d9ef">define</span> list-backups
  (<span style="color:#66d9ef">let*</span> (<span style="color:#75715e">; OS agnostic (I hope) way of finding the backup root</span>
         [backup-root
          (<span style="color:#66d9ef">for*/first</span> ([path-parts (in-list <span style="color:#f92672">&#39;</span>((<span style="color:#e6db74">&#34;AppData&#34;</span> <span style="color:#e6db74">&#34;Roaming&#34;</span> <span style="color:#e6db74">&#34;Apple Computer&#34;</span>
                                               <span style="color:#e6db74">&#34;MobileSync&#34;</span> <span style="color:#e6db74">&#34;Backup&#34;</span>)
                                              (<span style="color:#e6db74">&#34;Library&#34;</span> <span style="color:#e6db74">&#34;Application Support&#34;</span>
                                                <span style="color:#e6db74">&#34;MobileSync&#34;</span> <span style="color:#e6db74">&#34;Backup&#34;</span>)))]
                       [path (in-value (apply build-path
                                              (cons (find-system-path <span style="color:#f92672">&#39;</span><span style="color:#e6db74">home-dir</span>)
                                                    path-parts)))]
                       <span style="color:#66d9ef">#:when</span> (directory-exists? path))
            path)]

         <span style="color:#75715e">; List all backups in that directory, along with some metadata</span>
         [backups
          (<span style="color:#66d9ef">for/list</span> ([dir (in-list (directory-list backup-root))])
            (<span style="color:#66d9ef">define</span> info-file
              (call-with-input-file (build-path backup-root dir <span style="color:#e6db74">&#34;Info.plist&#34;</span>)
                read-plist/jsexpr))

            (backup (dict-ref info-file <span style="color:#f92672">&#39;</span><span style="color:#e6db74">|Device Name|</span>)
                    (path-&gt;string dir)
                    (dict-ref info-file <span style="color:#f92672">&#39;</span><span style="color:#e6db74">|Last Backup Date|</span>)
                    (normalize-contact (dict-ref info-file <span style="color:#f92672">&#39;</span><span style="color:#e6db74">|Phone Number|</span>))
                    (build-path backup-root dir)))])

    (<span style="color:#66d9ef">λ</span> () backups)))</code></pre></div>
<p>The function is a little strange looking, mostly because of caching. Rather than scanning and loading the backup every time we want a list, scan it once on load, then return that whenever the function is called.</p>

<p>One thing missing though, we have to define the function <code>read-plist/jsexpr</code> yet. Luckily, we have the <code><a href="http://docs.racket-lang.org/search/index.html?q=xml/plist">xml/plist</a></code>
 library to handle the first part of this<sup class="footnote-ref" id="fnref:4"><a rel="footnote" href="#fn:4">4</a></sup>, but personally I&rsquo;d rather a more straight forward format (a <code><a href="http://docs.racket-lang.org/search/index.html?q=jsexpr">jsexpr</a></code>
 is basically a mix of hashes, lists, and atoms):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Convert a plist into a JSON expression</span>
(<span style="color:#66d9ef">define</span> (plist-&gt;jsexpr data)
  (<span style="color:#66d9ef">match</span> data
    [(? string?) data]
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">true</span>) <span style="color:#66d9ef">#t</span>]
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">false</span>) <span style="color:#66d9ef">#f</span>]
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">integer</span> <span style="color:#f92672">,</span>v) v]
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">real</span> <span style="color:#f92672">,</span>v) v]
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">data</span> <span style="color:#f92672">,</span>v) v] <span style="color:#75715e">; Should we special case these?</span>
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">date</span> <span style="color:#f92672">,</span>v) v] <span style="color:#75715e">; Ditto</span>
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">array</span> <span style="color:#f92672">.</span> <span style="color:#f92672">,</span>v*)
     (map plist-&gt;jsexpr v*)]
    [<span style="color:#f92672">`</span>(<span style="color:#e6db74">dict</span> <span style="color:#f92672">.</span> <span style="color:#f92672">,</span>kv*)
     (<span style="color:#66d9ef">for/hash</span> ([kv (in-list kv*)])
       (values (string-&gt;symbol (second kv)) (plist-&gt;jsexpr (third kv))))]))

<span style="color:#75715e">; Read a plist file as a JSON expression from a file</span>
(<span style="color:#66d9ef">define</span> (read-plist/jsexpr [in (current-input-port)])
  (plist-&gt;jsexpr (read-plist in)))</code></pre></div>
<p>I still haven&rsquo;t decided if special casing <code>data</code> and <code>date</code> elements is worthwhile.</p>

<p>The other interesting function is another utility function <code>normalize-contact</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Process a phone number or email address into a common format</span>
(<span style="color:#66d9ef">define</span> (normalize-contact value)
  (<span style="color:#66d9ef">define</span> re <span style="color:#e6db74">#px&#34;^\\+?1? ?[\\(\\.]?(\\d\\d\\d)[\\)\\.-]? ?(\\d\\d\\d)[ \\.-]?(\\d\\d\\d\\d)$&#34;</span>)
  (<span style="color:#66d9ef">cond</span>
    [(sql-null? value)
     <span style="color:#66d9ef">#f</span>]
    <span style="color:#75715e">; Standard phone numbers</span>
    <span style="color:#75715e">; TODO: Figure out international numbers</span>
    [(regexp-match re value)
     <span style="color:#66d9ef">=&gt;</span> (<span style="color:#66d9ef">λ</span> (<span style="color:#66d9ef">match</span>) (string-join (rest <span style="color:#66d9ef">match</span>) <span style="color:#e6db74">&#34;.&#34;</span>))]
    <span style="color:#75715e">; Email addresses</span>
    [(regexp-match <span style="color:#e6db74">#px&#34;^[^@]+@[^@]+$&#34;</span> value)
     value]
    <span style="color:#75715e">; Short phone numbers</span>
    [(regexp-match <span style="color:#e6db74">#px&#34;^\\d{,6}$&#34;</span> value)
     value]
    <span style="color:#75715e">; No idea...</span>
    [<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">#f</span>]))</code></pre></div>
<p>Phone numbers in an iPhone backup are stored all sorts of odd ways. In particular, once you start looking at the contacts, you can get three or four different formats just for normal area code + 7 phone numbers (I haven&rsquo;t yet decided how to support international numbers). So this can be used to at least put them all in the same format.</p>

<p>But with that, we now have the ability to list all backups on the local system:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (list-backups)
<span style="color:#f92672">&#39;</span>(<span style="color:#f92672">#s</span>(<span style="color:#e6db74">backup</span>
     <span style="color:#e6db74">&#34;JP’s iPhone&#34;</span>
     <span style="color:#e6db74">&#34;63b5...a651&#34;</span>
     <span style="color:#e6db74">&#34;2014-04-17T21:53:16Z&#34;</span>
     <span style="color:#e6db74">&#34;{redacted}&#34;</span>
     <span style="color:#e6db74">#&lt;path:/Users/jp/Library/Application</span> <span style="color:#e6db74">Support/MobileSync/Backup/63b5....a651&gt;</span>))</code></pre></div>
<p>It&rsquo;s an older backup, but that&rsquo;s fine.</p>

<p>Next, what if we have more than one backup on the system? It would be nice to have a function that could take that list of backups and load just one (that other parts of the library can access) based on name/hash/phone number:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Store the most recently used backup for other modules</span>
(<span style="color:#66d9ef">define</span> current-backup (make-parameter <span style="color:#66d9ef">#f</span>))

<span style="color:#75715e">; Load a specific backup, try to guess what the identifier is</span>
(<span style="color:#66d9ef">define</span> (read-backup identifier)
  (<span style="color:#66d9ef">for/first</span> ([backup (in-list (list-backups))]
              <span style="color:#66d9ef">#:when</span> (<span style="color:#66d9ef">or</span> (equal? identifier (backup-date backup))
                         (equal? identifier (backup-name backup))
                         (equal? identifier (backup-hash backup))
                         (equal? identifier (backup-phone-number backup))))
    backup))</code></pre></div>
<p>Fair enough. At the moment, you have to have an exact match, but that&rsquo;s fine. If we want to later, we could replace the calls to <code><a href="http://docs.racket-lang.org/search/index.html?q=equal?">equal?</a></code>
 with <code><a href="http://docs.racket-lang.org/search/index.html?q=regexp-match">regexp-match</a></code>
.</p>

<p>So now I can find my own backup:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (read-backup <span style="color:#e6db74">&#34;86b1...aa36&#34;</span>)
<span style="color:#f92672">&#39;#s</span>(<span style="color:#e6db74">backup</span>
    <span style="color:#e6db74">&#34;JP’s iPhone&#34;</span>
    <span style="color:#e6db74">&#34;63b5...a651&#34;</span>
    <span style="color:#e6db74">&#34;2014-04-17T21:53:16Z&#34;</span>
    <span style="color:#e6db74">&#34;{redacted}&#34;</span>
    <span style="color:#e6db74">#&lt;path:/Users/jp/Library/Application</span> <span style="color:#e6db74">Support/MobileSync/Backup/63b5....a651&gt;</span>)</code></pre></div>
<p>One more utility macro:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Parameterize code with a current backup</span>
(<span style="color:#66d9ef">define-syntax-rule</span> (with-backup identifier body <span style="color:#66d9ef">...</span>)
  (<span style="color:#66d9ef">parameterize</span> ([current-backup (read-backup identifier)])
    body <span style="color:#66d9ef">...</span>))</code></pre></div>
<p>This will be nice, since it can let us do things like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (<span style="color:#66d9ef">define</span> contacts
    (with-backup <span style="color:#e6db74">&#34;86b1...aa36&#34;</span>
      (list-contacts)))</code></pre></div>
<p>Nice and clean.</p>

<p>I think that&rsquo;s about enough for today. The entire code for today&rsquo;s post (along with the entire library thus far, which is significantly further along<sup class="footnote-ref" id="fnref:5"><a rel="footnote" href="#fn:5">5</a></sup>), is available on GitHub: <a href="https://github.com/jpverkamp/ios-backup">ios-backup</a></p>

<p>Here is a list of all of the posts in this series:</p>

<div class="ranking">
    <h3 class="title">Posts in <a href="/series/ios-backups-in-racket/">iOS Backups in Racket</a>:</h3>
    <div class="content">
        <ul>
        
        
            <li><a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">iOS Backups in Racket: Groundwork</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/">iOS Backups in Racket: Contacts</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/">iOS Backups in Racket: Messages</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">iOS Backups in Racket: Apps</a></li>
        
        </ul>
    </div>
</div>

<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Yeah, I know I&rsquo;m something of a digital packrat. ¯\<em>(ツ)</em>/¯ Disk space is cheap.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">Except on iPhones. Seriously, that&rsquo;s the only difference within a model, yes?
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">For some definitions of helpful&hellip;
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
<li id="fn:4">Sort of. Turns out that library doesn&rsquo;t handle binary plists. We&rsquo;ll work around that when we handle applications.
 <a class="footnote-return" href="#fnref:4"><sup>[return]</sup></a></li>
<li id="fn:5">Although still somewhat lacking in documentation
 <a class="footnote-return" href="#fnref:5"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "iOS Backups in Racket: Groundwork";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2015\/01\/22\/ios-backups-in-racket-groundwork\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

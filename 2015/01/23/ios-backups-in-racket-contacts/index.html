<!doctype html><html><head><title>iOS Backups in Racket: Contacts – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.7a29c6e86e28b6da48d6e8a526f4fa597dfba1464ca3f975ea9e0fb8c00052b7.css integrity="sha256-einG6G4ottpI1uilJvT6WX37oUZMo/l16p4PuMAAUrc="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/home-automation/>Home Automation</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>iOS Backups in Racket: Contacts</h1><div class=entry-meta><span class=entry-date>2015-01-23</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/backups>Backups</a><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2012/10/04/querying-csv-files-with-sql/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/databases>Databases</a><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/ class=previous-link></a><a class=taxonomy-value href=/series/ios-backups-in-racket>iOS Backups in Racket</a><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>After <a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/>yesterday&rsquo;s post</a> laying the groundwork for looking into <a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/>iOS Backups</a>, today why don&rsquo;t we actually start digging into one of the more interesting files: your list of contacts.</p><p>First things first, we have to find where the list of contacts is stored. That&rsquo;s the problem with the backup format&ndash;we have a giant list of files each of which is a SHA-1 hash. But of what?</p><p>Doing a little bit of digging, it looks like each of those hashes is based more or less on the filename of the source file. So if we happened to know that contacts are stored in the file <code>Library/AddressBook/AddressBook.sqlitedb</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, we should just be able to hash that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>&gt; (call-with-input-string <span style=color:#e6db74>&#34;Library/AddressBook/AddressBook.sqlitedb&#34;</span> sha1)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;adb8c77534444e97c31ff15924d50f3ed1fbd3b1&#34;</span>
</span></span></code></pre></div><p>Hmm. That file doesn&rsquo;t exist. But all of my sources are telling me that <code>AddressBook.sqlitedb</code> is in <code>HomeDomain</code>. What does that mean? Well it seems that iOS has some amount of sandboxing in it&rsquo;s filesystem, rather than a more traditional Unix style. Basically, the path is actually:</p><p><code>Domain-Path</code></p><p>Specifically:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span><span style=color:#75715e>; Hash attachments so that we can find the local path</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define</span> (hash-filename path [domain <span style=color:#e6db74>&#34;MediaDomain&#34;</span>])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>for*/first</span> ([<span style=color:#66d9ef>prefix</span> (in-list (list <span style=color:#e6db74>&#34;/var/mobile/&#34;</span>
</span></span><span style=display:flex><span>                                      <span style=color:#e6db74>&#34;~/&#34;</span>
</span></span><span style=display:flex><span>                                      <span style=color:#e6db74>&#34;&#34;</span>))]
</span></span><span style=display:flex><span>               <span style=color:#66d9ef>#:when</span> (<span style=color:#66d9ef>and</span> (&gt; (string-length path) (string-length <span style=color:#66d9ef>prefix</span>))
</span></span><span style=display:flex><span>                           (equal? (substring path <span style=color:#ae81ff>0</span> (string-length <span style=color:#66d9ef>prefix</span>)) <span style=color:#66d9ef>prefix</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define</span> path-w/o-prefix (substring path (string-length <span style=color:#66d9ef>prefix</span>)))
</span></span><span style=display:flex><span>    (call-with-input-string (~a domain <span style=color:#e6db74>&#34;-&#34;</span> path-w/o-prefix) sha1)))
</span></span></code></pre></div><p>There&rsquo;s a bit of complication there. If a file uses a traditional Unix path, starting with with <code>/var/mobile/</code> or <code>~/</code> (the home directory), that is stripped off before adding the domain. If we try it again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>&gt; (hash-filename <span style=color:#e6db74>&#34;Library/AddressBook/AddressBook.sqlitedb&#34;</span> <span style=color:#e6db74>&#34;HomeDomain&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;31bb7ba8914766d4ba40d6dfb6113c8b614be442&#34;</span>
</span></span></code></pre></div><p>Ah hah! That file actually exists (and matches the hash I&rsquo;ve found online).</p><p>Let&rsquo;s poke around. First things first, let&rsquo;s load it up in <code>sqlite3</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sqlite<span style=color:#f92672>&gt;</span> .tables
</span></span><span style=display:flex><span>ABAccount                        ABPersonFullTextSearch_segdir
</span></span><span style=display:flex><span>ABGroup                          ABPersonFullTextSearch_segments
</span></span><span style=display:flex><span>ABGroupChanges                   ABPersonFullTextSearch_stat
</span></span><span style=display:flex><span>ABGroupMembers                   ABPersonLink
</span></span><span style=display:flex><span>ABMultiValue                     ABPersonMultiValueDeletes
</span></span><span style=display:flex><span>ABMultiValueEntry                ABPersonSearchKey
</span></span><span style=display:flex><span>ABMultiValueEntryKey             ABPhoneLastFour
</span></span><span style=display:flex><span>ABMultiValueLabel                ABRecent
</span></span><span style=display:flex><span>ABPerson                         ABStore
</span></span><span style=display:flex><span>ABPersonBasicChanges             FirstSortSectionCount
</span></span><span style=display:flex><span>ABPersonChanges                  FirstSortSectionCountTotal
</span></span><span style=display:flex><span>ABPersonFullTextSearch           LastSortSectionCount
</span></span><span style=display:flex><span>ABPersonFullTextSearch_content   LastSortSectionCountTotal
</span></span><span style=display:flex><span>ABPersonFullTextSearch_docsize   _SqliteDatabaseProperties
</span></span></code></pre></div><p>A lot of those are indicies or other things that we don&rsquo;t necessarily care about, but the first one that jumps out to me is <code>ABPerson</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sqlite<span style=color:#f92672>&gt;</span> .<span style=color:#66d9ef>schema</span> ABPerson
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> ABPerson (
</span></span><span style=display:flex><span>  ROWID INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTOINCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>First</span> TEXT,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Last</span> TEXT,
</span></span><span style=display:flex><span>  Middle TEXT,
</span></span><span style=display:flex><span>  FirstPhonetic TEXT,
</span></span><span style=display:flex><span>  MiddlePhonetic TEXT,
</span></span><span style=display:flex><span>  LastPhonetic TEXT,
</span></span><span style=display:flex><span>  Organization TEXT,
</span></span><span style=display:flex><span>  Department TEXT,
</span></span><span style=display:flex><span>  Note TEXT,
</span></span><span style=display:flex><span>  Kind INTEGER,
</span></span><span style=display:flex><span>  Birthday TEXT,
</span></span><span style=display:flex><span>  JobTitle TEXT,
</span></span><span style=display:flex><span>  Nickname TEXT,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Prefix</span> TEXT,
</span></span><span style=display:flex><span>  Suffix TEXT,
</span></span><span style=display:flex><span>  FirstSort TEXT,
</span></span><span style=display:flex><span>  LastSort TEXT,
</span></span><span style=display:flex><span>  CreationDate INTEGER,
</span></span><span style=display:flex><span>  ModificationDate INTEGER,
</span></span><span style=display:flex><span>  CompositeNameFallback TEXT,
</span></span><span style=display:flex><span>  ExternalIdentifier TEXT,
</span></span><span style=display:flex><span>  ExternalModificationTag TEXT,
</span></span><span style=display:flex><span>  ExternalUUID TEXT,
</span></span><span style=display:flex><span>  StoreID INTEGER,
</span></span><span style=display:flex><span>  DisplayName TEXT,
</span></span><span style=display:flex><span>  ExternalRepresentation BLOB,
</span></span><span style=display:flex><span>  FirstSortSection TEXT,
</span></span><span style=display:flex><span>  LastSortSection TEXT,
</span></span><span style=display:flex><span>  FirstSortLanguageIndex INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>2147483647</span>,
</span></span><span style=display:flex><span>  LastSortLanguageIndex INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>2147483647</span>,
</span></span><span style=display:flex><span>  PersonLink INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  ImageURI TEXT,
</span></span><span style=display:flex><span>  IsPreferredName INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  guid TEXT <span style=color:#66d9ef>DEFAULT</span> (ab_generate_guid()),
</span></span><span style=display:flex><span>  PhonemeData TEXT,
</span></span><span style=display:flex><span>  AlternateBirthday TEXT,
</span></span><span style=display:flex><span>  MapsData TEXT,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNIQUE</span>(guid)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>There is rather a pile of other statements after that, but that&rsquo;s the table that we&rsquo;re interested in. Specifically, that at least has the names and organizations (which at the moment is what I&rsquo;m really interested in). What&rsquo;s suspiciously absent though, is the phone numbers. Hmm&mldr;</p><p>After a little bit of digging, I came across this table:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>sqlite<span style=color:#f92672>&gt;</span> .<span style=color:#66d9ef>schema</span> ABMultiValue
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> ABMultiValue (
</span></span><span style=display:flex><span>  UID INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>  record_id INTEGER,
</span></span><span style=display:flex><span>  property INTEGER,
</span></span><span style=display:flex><span>  identifier INTEGER,
</span></span><span style=display:flex><span>  label INTEGER,
</span></span><span style=display:flex><span>  value TEXT,
</span></span><span style=display:flex><span>  guid TEXT <span style=color:#66d9ef>DEFAULT</span> (ab_generate_guid()),
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNIQUE</span>(guid)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Specifically, <code>record_id</code> matches <code>ABPerson.ROWID</code> and <code>value</code> contains phone numbers, email address, etc. (This is the real reason that I wrote the <code>normalize-contact</code> function).</p><p>Okay. That should be enough for the moment. Let&rsquo;s switch gears and lay out a similar framework to <code>backup</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>(<span style=color:#66d9ef>define</span> CONTACTS-DB
</span></span><span style=display:flex><span>  (hash-filename <span style=color:#e6db74>&#34;Library/AddressBook/AddressBook.sqlitedb&#34;</span> <span style=color:#e6db74>&#34;HomeDomain&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Name is a human readable name for a contact</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Identifiers is a list of phone numbers / emails / etc</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>struct</span> contact (name identifiers) <span style=color:#66d9ef>#:prefab</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Store a separate list of contacts for each backup (potentially)</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define</span> contacts-by-backup (make-hash))
</span></span><span style=display:flex><span>(hash-set! contacts-by-backup <span style=color:#66d9ef>#f</span> <span style=color:#f92672>&#39;</span>())
</span></span></code></pre></div><p>Cool. Now we want to load the specific list of contacts, caching them the same way we did with the backups themselves:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span><span style=color:#75715e>; Load all contacts stored in a specific backup</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define</span> (list-contacts)
</span></span><span style=display:flex><span>  (hash-ref!
</span></span><span style=display:flex><span>   contacts-by-backup
</span></span><span style=display:flex><span>   (current-backup)
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>λ</span> ()
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>define</span> contacts-db
</span></span><span style=display:flex><span>       (sqlite3-connect <span style=color:#66d9ef>#:database</span> (build-path (backup-path (current-backup))
</span></span><span style=display:flex><span>                                               CONTACTS-DB)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>for/list</span> ([(user-id first-name middle-name last-name organization)
</span></span><span style=display:flex><span>                 (in-query contacts-db <span style=color:#e6db74>&#34;SELECT ROWID, First, Middle, Last, Organization FROM ABPerson&#34;</span>)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define</span> (fix str) (<span style=color:#66d9ef>if</span> (sql-null? str) <span style=color:#e6db74>&#34;&#34;</span> str))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define</span> name
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>let*</span> ([name (~a (fix first-name) <span style=color:#e6db74>&#34; &#34;</span>
</span></span><span style=display:flex><span>                          (fix middle-name) <span style=color:#e6db74>&#34; &#34;</span>
</span></span><span style=display:flex><span>                          (fix last-name) <span style=color:#e6db74>&#34; &#34;</span>
</span></span><span style=display:flex><span>                          <span style=color:#e6db74>&#34;(&#34;</span> (fix organization) <span style=color:#e6db74>&#34;)&#34;</span>)]
</span></span><span style=display:flex><span>                [name (regexp-replace* <span style=color:#e6db74>#px&#34;\\(\\)&#34;</span> name <span style=color:#e6db74>&#34;&#34;</span>)]
</span></span><span style=display:flex><span>                [name (regexp-replace* <span style=color:#e6db74>#px&#34;\\s+&#34;</span> name <span style=color:#e6db74>&#34; &#34;</span>)]
</span></span><span style=display:flex><span>                [name (string-trim name)]
</span></span><span style=display:flex><span>                [name (regexp-replace* <span style=color:#e6db74>#px&#34;^\\((.*)\\)$&#34;</span> name <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>1&#34;</span>)])
</span></span><span style=display:flex><span>           name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define</span> identifiers
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>for*/list</span> ([raw-value (in-list (query-list contacts-db <span style=color:#e6db74>&#34;SELECT value FROM ABMultiValue WHERE record_id = $1&#34;</span> user-id))]
</span></span><span style=display:flex><span>                     [value (in-value (normalize-contact raw-value))]
</span></span><span style=display:flex><span>                     <span style=color:#66d9ef>#:when</span> value)
</span></span><span style=display:flex><span>           value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       (contact name identifiers)))))
</span></span></code></pre></div><p>Basically, we want to make a nested set of queries, first one for each user and then another for all contact information for that user. It&rsquo;s Not the perfect way of doing itl as theoretically we could have done a sql join, but it works well enough.</p><p>As far as the name formatting, that&rsquo;s just the way I needed it to work. When I get around to it, I&rsquo;ll probably write a <code>name-display-format</code> parameter akin to <code><a href="http://docs.racket-lang.org/search/index.html?q=date-display-format">date-display-format</a></code>
from <code><a href="http://docs.racket-lang.org/search/index.html?q=racket/date">racket/date</a></code>
. Not today though!</p><p>So let&rsquo;s see how it works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>&gt; (with-backup <span style=color:#e6db74>&#34;86b18eea28a991f4dd569d1f59737a842e24aa36&#34;</span>
</span></span><span style=display:flex><span>    (list-contacts))
</span></span><span style=display:flex><span><span style=color:#f92672>&#39;</span>(<span style=color:#f92672>#s</span>(<span style=color:#e6db74>contact</span> <span style=color:#e6db74>&#34;Charles I. Clarke&#34;</span> (<span style=color:#e6db74>&#34;555.555.1234&#34;</span> <span style=color:#e6db74>&#34;charlie.c@example.com&#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#f92672>#s</span>(<span style=color:#e6db74>contact</span> <span style=color:#e6db74>&#34;Jenny Reichert (Catsitter)&#34;</span> (<span style=color:#e6db74>&#34;555.867.5309&#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#f92672>#s</span>(<span style=color:#e6db74>contact</span> <span style=color:#e6db74>&#34;Mary Orndorff&#34;</span> (<span style=color:#e6db74>&#34;555.555.0000&#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#f92672>#s</span>(<span style=color:#e6db74>contact</span> <span style=color:#e6db74>&#34;Pizza Palace&#34;</span> (<span style=color:#e6db74>&#34;555.555.1123&#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#f92672>#s</span>(<span style=color:#e6db74>contact</span> <span style=color:#e6db74>&#34;Willie S. Culpepper&#34;</span> (<span style=color:#e6db74>&#34;555.555.1491&#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#e6db74>...</span>)
</span></span></code></pre></div><p>Sweet.</p><p>And as a bonus, let&rsquo;s include a basic search function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span><span style=color:#75715e>; Load a user by name or value</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define</span> (find-contact key)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>for/first</span> ([contact (in-list (list-contacts))]
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>#:when</span> (<span style=color:#66d9ef>or</span> (equal? key (contact-name contact))
</span></span><span style=display:flex><span>                         (member key (contact-identifiers contact))))
</span></span><span style=display:flex><span>    contact))
</span></span></code></pre></div><p>Again, it&rsquo;s not a fuzzy match (you have to have the name exact), but that&rsquo;s something I&rsquo;ll probably clean up later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-racket data-lang=racket><span style=display:flex><span>&gt; (with-backup <span style=color:#e6db74>&#34;86b18eea28a991f4dd569d1f59737a842e24aa36&#34;</span>
</span></span><span style=display:flex><span>    (find-contact <span style=color:#e6db74>&#34;Charles I. Clarke&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>#s</span>(<span style=color:#e6db74>contact</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;Charles I. Clarke&#34;</span>
</span></span><span style=display:flex><span>   (<span style=color:#e6db74>&#34;555.555.1234&#34;</span> <span style=color:#e6db74>&#34;charlie.c@example.com&#34;</span>)
</span></span></code></pre></div><p>And there you have it. Contacts. We&rsquo;re really starting to get somewhere here. Next week (probably Monday or Tuesday), I&rsquo;ll write up messages (both SMS and iMessage). That one will really be fun.</p><p>As always entire code for today&rsquo;s post is available on GitHub: <a href=https://github.com/jpverkamp/ios-backup>ios-backup</a></p><p>Here is a list of all of the posts in this series:</p><div class=ranking><h3 class=title>Posts in <a href=/series/ios-backups-in-racket/>iOS Backups in Racket</a>:</h3><div class=content><ul><li><a href=https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/>iOS Backups in Racket: Groundwork</a></li><li><a href=https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/>iOS Backups in Racket: Contacts</a></li><li><a href=https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/>iOS Backups in Racket: Messages</a></li><li><a href=https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/>iOS Backups in Racket: Apps</a></li></ul></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://theiphonewiki.com/wiki/ITunes_Backup#Files>theiphonewiki.com</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
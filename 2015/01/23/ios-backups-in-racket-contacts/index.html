<!DOCTYPE html>
<html>
<head>
    <title>
    iOS Backups in Racket: Contacts â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">iOS Backups in Racket: Contacts</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2015-01-23</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a>
                        <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/backups">Backups</a>
                        <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/data-structures">Data Structures</a>
                        <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2012/10/04/querying-csv-files-with-sql/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/databases">Databases</a>
                        <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/series/ios-backups-in-racket">iOS Backups in Racket</a>
                        <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2015/01/25/his-majestys-dragon/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>After <a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">yesterday&rsquo;s post</a> laying the groundwork for looking into <a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">iOS Backups</a>, today why don&rsquo;t we actually start digging into one of the more interesting files: your list of contacts.</p>

<p>First things first, we have to find where the list of contacts is stored. That&rsquo;s the problem with the backup format&ndash;we have a giant list of files each of which is a SHA-1 hash. But of what?</p>

<p>Doing a little bit of digging, it looks like each of those hashes is based more or less on the filename of the source file. So if we happened to know that contacts are stored in the file <code>Library/AddressBook/AddressBook.sqlitedb</code><sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>, we should just be able to hash that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (call-with-input-string <span style="color:#e6db74">&#34;Library/AddressBook/AddressBook.sqlitedb&#34;</span> sha1)
<span style="color:#e6db74">&#34;adb8c77534444e97c31ff15924d50f3ed1fbd3b1&#34;</span></code></pre></div>
<p>Hmm. That file doesn&rsquo;t exist. But all of my sources are telling me that <code>AddressBook.sqlitedb</code> is in <code>HomeDomain</code>. What does that mean? Well it seems that iOS has some amount of sandboxing in it&rsquo;s filesystem, rather than a more traditional Unix style. Basically, the path is actually:</p>

<p><code>Domain-Path</code></p>

<p>Specifically:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Hash attachments so that we can find the local path</span>
(<span style="color:#66d9ef">define</span> (hash-filename path [domain <span style="color:#e6db74">&#34;MediaDomain&#34;</span>])
  (<span style="color:#66d9ef">for*/first</span> ([<span style="color:#66d9ef">prefix</span> (in-list (list <span style="color:#e6db74">&#34;/var/mobile/&#34;</span>
                                      <span style="color:#e6db74">&#34;~/&#34;</span>
                                      <span style="color:#e6db74">&#34;&#34;</span>))]
               <span style="color:#66d9ef">#:when</span> (<span style="color:#66d9ef">and</span> (&gt; (string-length path) (string-length <span style="color:#66d9ef">prefix</span>))
                           (equal? (substring path <span style="color:#ae81ff">0</span> (string-length <span style="color:#66d9ef">prefix</span>)) <span style="color:#66d9ef">prefix</span>)))
    (<span style="color:#66d9ef">define</span> path-w/o-prefix (substring path (string-length <span style="color:#66d9ef">prefix</span>)))
    (call-with-input-string (~a domain <span style="color:#e6db74">&#34;-&#34;</span> path-w/o-prefix) sha1)))</code></pre></div>
<p>There&rsquo;s a bit of complication there. If a file uses a traditional Unix path, starting with with <code>/var/mobile/</code> or <code>~/</code> (the home directory), that is stripped off before adding the domain. If we try it again:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (hash-filename <span style="color:#e6db74">&#34;Library/AddressBook/AddressBook.sqlitedb&#34;</span> <span style="color:#e6db74">&#34;HomeDomain&#34;</span>)
<span style="color:#e6db74">&#34;31bb7ba8914766d4ba40d6dfb6113c8b614be442&#34;</span></code></pre></div>
<p>Ah hah! That file actually exists (and matches the hash I&rsquo;ve found online).</p>

<p>Let&rsquo;s poke around. First things first, let&rsquo;s load it up in <code>sqlite3</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> .tables
ABAccount                        ABPersonFullTextSearch_segdir
ABGroup                          ABPersonFullTextSearch_segments
ABGroupChanges                   ABPersonFullTextSearch_stat
ABGroupMembers                   ABPersonLink
ABMultiValue                     ABPersonMultiValueDeletes
ABMultiValueEntry                ABPersonSearchKey
ABMultiValueEntryKey             ABPhoneLastFour
ABMultiValueLabel                ABRecent
ABPerson                         ABStore
ABPersonBasicChanges             FirstSortSectionCount
ABPersonChanges                  FirstSortSectionCountTotal
ABPersonFullTextSearch           LastSortSectionCount
ABPersonFullTextSearch_content   LastSortSectionCountTotal
ABPersonFullTextSearch_docsize   _SqliteDatabaseProperties</code></pre></div>
<p>A lot of those are indicies or other things that we don&rsquo;t necessarily care about, but the first one that jumps out to me is <code>ABPerson</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> .<span style="color:#66d9ef">schema</span> ABPerson
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> ABPerson (
  ROWID INTEGER <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTOINCREMENT,
  <span style="color:#66d9ef">First</span> TEXT,
  <span style="color:#66d9ef">Last</span> TEXT,
  Middle TEXT,
  FirstPhonetic TEXT,
  MiddlePhonetic TEXT,
  LastPhonetic TEXT,
  Organization TEXT,
  Department TEXT,
  Note TEXT,
  Kind INTEGER,
  Birthday TEXT,
  JobTitle TEXT,
  Nickname TEXT,
  <span style="color:#66d9ef">Prefix</span> TEXT,
  Suffix TEXT,
  FirstSort TEXT,
  LastSort TEXT,
  CreationDate INTEGER,
  ModificationDate INTEGER,
  CompositeNameFallback TEXT,
  ExternalIdentifier TEXT,
  ExternalModificationTag TEXT,
  ExternalUUID TEXT,
  StoreID INTEGER,
  DisplayName TEXT,
  ExternalRepresentation BLOB,
  FirstSortSection TEXT,
  LastSortSection TEXT,
  FirstSortLanguageIndex INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">2147483647</span>,
  LastSortLanguageIndex INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">2147483647</span>,
  PersonLink INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
  ImageURI TEXT,
  IsPreferredName INTEGER <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">1</span>,
  guid TEXT <span style="color:#66d9ef">DEFAULT</span> (ab_generate_guid()),
  PhonemeData TEXT,
  AlternateBirthday TEXT,
  MapsData TEXT,
  <span style="color:#66d9ef">UNIQUE</span>(guid)
);
...</code></pre></div>
<p>There is rather a pile of other statements after that, but that&rsquo;s the table that we&rsquo;re interested in. Specifically, that at least has the names and organizations (which at the moment is what I&rsquo;m really interested in). What&rsquo;s suspiciously absent though, is the phone numbers. Hmm&hellip;</p>

<p>After a little bit of digging, I came across this table:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> .<span style="color:#66d9ef">schema</span> ABMultiValue
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> ABMultiValue (
  UID INTEGER <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
  record_id INTEGER,
  property INTEGER,
  identifier INTEGER,
  label INTEGER,
  value TEXT,
  guid TEXT <span style="color:#66d9ef">DEFAULT</span> (ab_generate_guid()),
  <span style="color:#66d9ef">UNIQUE</span>(guid)
);</code></pre></div>
<p>Specifically, <code>record_id</code> matches <code>ABPerson.ROWID</code> and <code>value</code> contains phone numbers, email address, etc. (This is the real reason that I wrote the <code>normalize-contact</code> function).</p>

<p>Okay. That should be enough for the moment. Let&rsquo;s switch gears and lay out a similar framework to <code>backup</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">(<span style="color:#66d9ef">define</span> CONTACTS-DB
  (hash-filename <span style="color:#e6db74">&#34;Library/AddressBook/AddressBook.sqlitedb&#34;</span> <span style="color:#e6db74">&#34;HomeDomain&#34;</span>))

<span style="color:#75715e">; Name is a human readable name for a contact</span>
<span style="color:#75715e">; Identifiers is a list of phone numbers / emails / etc</span>
(<span style="color:#66d9ef">struct</span> contact (name identifiers) <span style="color:#66d9ef">#:prefab</span>)

<span style="color:#75715e">; Store a separate list of contacts for each backup (potentially)</span>
(<span style="color:#66d9ef">define</span> contacts-by-backup (make-hash))
(hash-set! contacts-by-backup <span style="color:#66d9ef">#f</span> <span style="color:#f92672">&#39;</span>())</code></pre></div>
<p>Cool. Now we want to load the specific list of contacts, caching them the same way we did with the backups themselves:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Load all contacts stored in a specific backup</span>
(<span style="color:#66d9ef">define</span> (list-contacts)
  (hash-ref!
   contacts-by-backup
   (current-backup)
   (<span style="color:#66d9ef">Î»</span> ()
     (<span style="color:#66d9ef">define</span> contacts-db
       (sqlite3-connect <span style="color:#66d9ef">#:database</span> (build-path (backup-path (current-backup))
                                               CONTACTS-DB)))

     (<span style="color:#66d9ef">for/list</span> ([(user-id first-name middle-name last-name organization)
                 (in-query contacts-db <span style="color:#e6db74">&#34;SELECT ROWID, First, Middle, Last, Organization FROM ABPerson&#34;</span>)])

       (<span style="color:#66d9ef">define</span> (fix str) (<span style="color:#66d9ef">if</span> (sql-null? str) <span style="color:#e6db74">&#34;&#34;</span> str))

       (<span style="color:#66d9ef">define</span> name
         (<span style="color:#66d9ef">let*</span> ([name (~a (fix first-name) <span style="color:#e6db74">&#34; &#34;</span>
                          (fix middle-name) <span style="color:#e6db74">&#34; &#34;</span>
                          (fix last-name) <span style="color:#e6db74">&#34; &#34;</span>
                          <span style="color:#e6db74">&#34;(&#34;</span> (fix organization) <span style="color:#e6db74">&#34;)&#34;</span>)]
                [name (regexp-replace* <span style="color:#e6db74">#px&#34;\\(\\)&#34;</span> name <span style="color:#e6db74">&#34;&#34;</span>)]
                [name (regexp-replace* <span style="color:#e6db74">#px&#34;\\s+&#34;</span> name <span style="color:#e6db74">&#34; &#34;</span>)]
                [name (string-trim name)]
                [name (regexp-replace* <span style="color:#e6db74">#px&#34;^\\((.*)\\)$&#34;</span> name <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">1&#34;</span>)])
           name))

       (<span style="color:#66d9ef">define</span> identifiers
         (<span style="color:#66d9ef">for*/list</span> ([raw-value (in-list (query-list contacts-db <span style="color:#e6db74">&#34;SELECT value FROM ABMultiValue WHERE record_id = $1&#34;</span> user-id))]
                     [value (in-value (normalize-contact raw-value))]
                     <span style="color:#66d9ef">#:when</span> value)
           value))

       (contact name identifiers)))))</code></pre></div>
<p>Basically, we want to make a nested set of queries, first one for each user and then another for all contact information for that user. It&rsquo;s Not the perfect way of doing itl as theoretically we could have done a sql join, but it works well enough.</p>

<p>As far as the name formatting, that&rsquo;s just the way I needed it to work. When I get around to it, I&rsquo;ll probably write a <code>name-display-format</code> parameter akin to <code><a href="http://docs.racket-lang.org/search/index.html?q=date-display-format">date-display-format</a></code>
 from <code><a href="http://docs.racket-lang.org/search/index.html?q=racket/date">racket/date</a></code>
. Not today though!</p>

<p>So let&rsquo;s see how it works:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (with-backup <span style="color:#e6db74">&#34;86b18eea28a991f4dd569d1f59737a842e24aa36&#34;</span>
    (list-contacts))
<span style="color:#f92672">&#39;</span>(<span style="color:#f92672">#s</span>(<span style="color:#e6db74">contact</span> <span style="color:#e6db74">&#34;Charles I. Clarke&#34;</span> (<span style="color:#e6db74">&#34;555.555.1234&#34;</span> <span style="color:#e6db74">&#34;charlie.c@example.com&#34;</span>))
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">contact</span> <span style="color:#e6db74">&#34;Jenny Reichert (Catsitter)&#34;</span> (<span style="color:#e6db74">&#34;555.867.5309&#34;</span>))
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">contact</span> <span style="color:#e6db74">&#34;Mary Orndorff&#34;</span> (<span style="color:#e6db74">&#34;555.555.0000&#34;</span>))
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">contact</span> <span style="color:#e6db74">&#34;Pizza Palace&#34;</span> (<span style="color:#e6db74">&#34;555.555.1123&#34;</span>))
  <span style="color:#f92672">#s</span>(<span style="color:#e6db74">contact</span> <span style="color:#e6db74">&#34;Willie S. Culpepper&#34;</span> (<span style="color:#e6db74">&#34;555.555.1491&#34;</span>))
  <span style="color:#e6db74">...</span>)</code></pre></div>
<p>Sweet.</p>

<p>And as a bonus, let&rsquo;s include a basic search function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Load a user by name or value</span>
(<span style="color:#66d9ef">define</span> (find-contact key)
  (<span style="color:#66d9ef">for/first</span> ([contact (in-list (list-contacts))]
              <span style="color:#66d9ef">#:when</span> (<span style="color:#66d9ef">or</span> (equal? key (contact-name contact))
                         (member key (contact-identifiers contact))))
    contact))</code></pre></div>
<p>Again, it&rsquo;s not a fuzzy match (you have to have the name exact), but that&rsquo;s something I&rsquo;ll probably clean up later.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">&gt; (with-backup <span style="color:#e6db74">&#34;86b18eea28a991f4dd569d1f59737a842e24aa36&#34;</span>
    (find-contact <span style="color:#e6db74">&#34;Charles I. Clarke&#34;</span>))
<span style="color:#f92672">#s</span>(<span style="color:#e6db74">contact</span>
   <span style="color:#e6db74">&#34;Charles I. Clarke&#34;</span>
   (<span style="color:#e6db74">&#34;555.555.1234&#34;</span> <span style="color:#e6db74">&#34;charlie.c@example.com&#34;</span>)</code></pre></div>
<p>And there you have it. Contacts. We&rsquo;re really starting to get somewhere here. Next week (probably Monday or Tuesday), I&rsquo;ll write up messages (both SMS and iMessage). That one will really be fun.</p>

<p>As always entire code for today&rsquo;s post is available on GitHub: <a href="https://github.com/jpverkamp/ios-backup">ios-backup</a></p>

<p>Here is a list of all of the posts in this series:</p>

<div class="ranking">
    <h3 class="title">Posts in <a href="/series/ios-backups-in-racket/">iOS Backups in Racket</a>:</h3>
    <div class="content">
        <ul>
        
        
            <li><a href="https://blog.jverkamp.com/2015/01/22/ios-backups-in-racket-groundwork/">iOS Backups in Racket: Groundwork</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/23/ios-backups-in-racket-contacts/">iOS Backups in Racket: Contacts</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/27/ios-backups-in-racket-messages/">iOS Backups in Racket: Messages</a></li>
        
            <li><a href="https://blog.jverkamp.com/2015/01/29/ios-backups-in-racket-apps/">iOS Backups in Racket: Apps</a></li>
        
        </ul>
    </div>
</div>

<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://theiphonewiki.com/wiki/ITunes_Backup#Files">theiphonewiki.com</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "iOS Backups in Racket: Contacts";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2015\/01\/23\/ios-backups-in-racket-contacts\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

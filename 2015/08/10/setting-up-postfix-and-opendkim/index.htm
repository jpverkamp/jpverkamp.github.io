<!DOCTYPE html>
<html>
<head>
        
        

        <title>Setting up Postfix and OpenDKIM | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" defer></script>
        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js" defer></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" defer />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" defer />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" defer></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" defer />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js" defer></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js" defer></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" defer />
        <script src="/highlight/highlight.pack.js" defer></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" defer />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js" defer ></script>

        <!-- Pretty pretty fonts -->
        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Calligraffitti" defer />

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" defer />
        <script src="/custom.js" defer></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="//blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="//blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="//blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="//blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="//blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="//blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="//blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="//blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="//blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="//blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="//blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="//blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="//blog.jverkamp.com/category/archives/2015">2015</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="//blog.jverkamp.com/category/other/book-reviews">Book Reviews</a></li><li><a href="//blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="//blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="//blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="//blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="//blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="//blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="//blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="//blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="//blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="//blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="//blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="//blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="//blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="//blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="//blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Setting up Postfix and OpenDKIM</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2015-08-10"><span class="year">2015</span> <span class="month">Aug</span> <span class="day">10</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="//blog.jverkamp.com/category/programming/by-topic/cryptography">Cryptography</a></li><li><a href="//blog.jverkamp.com/category/programming/by-topic/email">Email</a></li><li><a href="//blog.jverkamp.com/category/programming">Programming</a></li><li><a href="//blog.jverkamp.com/category/programming/by-topic/cryptography/public-key-cryptography">Public-key cryptography</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>Last week, I was presented with a fairly interesting challenge: add DKIM (via <a href="http://www.opendkim.org/">OpenDKIM</a>) support to our mail servers (running <a href="http://www.postfix.org/">Postfix</a>). Given that I've never actually worked on a mail server before, it sounded fun. <img alt="smile" class="emoji" src="/emoji/smile.svg" /></p>
<!--more-->
<p>First, a bit of background on what exactly DKIM is:</p>
<blockquote>
    DomainKeys Identified Mail (DKIM) is an email validation system designed to detect email spoofing by providing a mechanism to allow receiving mail exchangers to check that incoming mail from a domain is authorized by that domain's administrators and that the email (including attachments) has not been modified during transport. A digital signature included with the message can be validated by the recipient using the signer's public key published in the DNS.
    -- Wikipedia: <a href="https://en.wikipedia.org/wiki/DKIM">DKIM</a>
</blockquote>
<p>Sounds nice. So what in the world does that mean?</p>
<h2>A bit of background</h2>
<p>Starting in the details, we have <a href="https://en.wikipedia.org/wiki/public_key cryptography">public key cryptography</a>. The basic idea of public key cryptography is that you have some sort of algorithm with two keys: one of which can be used to encrypt things and can be made public and another separate piece of information which can be used to decrypt things and should remain private. That way, you can publish your public key, well, publically. Then anyone that wants to send you a message can do so, knowing that only you (since only you possess the private key) can read it.</p>
<p>If we take this a step further, we can swap the roles of the public and private key<span class="footnote"><sup><a href="#footnote-1">[1]</a></sup></span>. Instead of encrypting with the public key, we will use the private key, requiring the <em>public</em> key for decryption. This sounds mad, since the public key is, by definition public. So what's the point of a message that only you can write but anyone can read?</p>
<p>Well, that's exactly the point: <em>only you</em> can write it. This is what's called a digital signature. Since only your private key could have encoded the message and since only you have the private key, this allows anyone to read your message and be safe in the knowledge that you wrote it.</p>
<p>This is exactly what DKIM does.</p>
<p>By creating an public/private key pair, publishing the public key to a DNS record, and using the private key to sign messages, you are allowing any receiver to verify that <em>you</em> were person who sent them. Don't get me wrong, there are still a few problems with this approach (we'll get to them later), but it's a cool idea.</p>
<h2>Implementation</h2>
<p>So how do you actually implement it in practice?</p>
<p>Given that I don't have any particular previous experience with mail servers, the answer involves a lot of Google. Here are the steps that worked for me.</p>
<h4>1 - Have a previously configured server correctly delivering mail via <a href="http://www.postfix.org/">Postfix</a></h4>
<h4>2 - Install <a href="http://www.opendkim.org/">OpenDKIM</a></h4>
<pre class="bash"><code>sudo apt-get install -y opendkim opendkim-tools</code></pre>
<h4>3 - Generate a new keypair</h4>
<pre class="bash"><code>sudo opendkim-genkey -s mail -d example.com</code></pre>
<p>The <code>-s</code> argument specifies a selector, which allows us to have multiple keypairs specified on the same domain (if we wanted to), while the <code>-d</code> is the domain we are signing for. In this case, we are generating a record for <code>mail._domainkey.example.com</code>.</p>
<p>This will generate two files. The first is <code>mail.private</code>, which we will move to <code>/etc/opendkim/keys/example.com.private</code> (to match the <code>KeyFile</code> later). Also, we need to make sure that the file has correctly narrow Unix permissions, or OpenDKIM will refuse to use it (for our own safety):</p>
<pre class="bash"><code>sudo chmod 0400 /etc/opendkim/keys/example.com.private
sudo chown opendkim:opendkim /etc/opendkim/keys/example.com.private
sudo adduser postfix opendkim</code></pre>
<p>The second file is <code>mail.txt</code>, which is a DNS record for the above domain. Set it up so this returns successfully:</p>
<pre class="bash"><code>$ dig mail._domainkey.example.com TXT

...
;; ANSWER SECTION:
mail._domainkey.example.com. 599	IN TXT "v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5N3lnvvrYgPCRSoqn+awTpE+iGYcKBPpo8HHbcFfCIIV10Hwo4PhCoGZSaKVHOjDm4yefKXhQjM7iKzEPuBatE7O47hAx1CJpNuIdLxhILSbEmbMxJrJAG0HZVn8z6EAoOHZNaPHmK2h4UUrjOG8zA5BHfzJf7tGwI+K619fFUwIDAQAB" ; ----- DKIM key mail for example.com
...</code></pre>
<p>That's (almost) all we have to do to configure the public half of the key pair. (We still have to use the same selector later in the <code>KeyFile</code>, but that's it.)</p>
<h4>4 - Create an OpenDKIM configuration file (<code>/etc/opendkim.conf</code>)</h4>
<pre class="bash"><code>Canonicalization        relaxed/relaxed
ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
InternalHosts           refile:/etc/opendkim/TrustedHosts
KeyTable                refile:/etc/opendkim/KeyTable
LogWhy                  Yes
MinimumKeyBits          1024
Mode                    sv
PidFile                 /var/run/opendkim/opendkim.pid
SigningTable            refile:/etc/opendkim/SigningTable
Socket                  inet:8891@localhost
Syslog                  Yes
SyslogSuccess           Yes
UMask                   022
UserID                  opendkim:opendkim</code></pre>
<p>What in the world do those all mean? Well, (based somewhat on documentation and somewhat on expirimentation):</p>
<ul>
    <li><code>Canonicalization</code> - controls whether further mail servers can edit the message contents with destroying the signature. <code>relaxed</code> allows more modification, <code>simple</code> is more strict. <code>relaxed</code> seems to be the more common option.</li>
    <li><code>ExternalIgnoreList</code> - hosts that we trust to send us mail; do not validate their DKIM signatures (if present). Specifying <code>refile</code> means that we can use wildcards.</li>
    <li><code>InternalHosts</code> - hosts that will relay mail through us; if we see an unsigned message coming from one of them, sign it before forwarding it along (This is important! I'll get to why in a bit)</li>
    <li><code>KeyTable</code> - a list of private keys we can use to sign messages (included later)</li>
    <li><code>LogWhy</code> - log errors to <code>/var/log/mail.log</code> (useful for debugging)</li>
    <li><code>MinimumKeyBits</code> - flag an error if we try to specify a private key shorter (less secure) than this</li>
    <li><code>Mode</code> - various options, <code>sv</code> is fairly common and means <code>s</code>ign outgoing messages and <code>v</code>erify incoming ones</li>
    <li><code>PidFile</code> - where to store the <a href="https://en.wikipedia.org/wiki/PID_file">PID file</a></li>
    <li><code>SigningTable</code> - specify which key from the <code>KeyTable</code> should be used for a given message</li>
    <li><code>Socket</code> - how Postfix and OpenDKIM communicate</li>
    <li><code>Syslog</code>, <code>SyslogSuccess</code> - log to <a href="https://en.wikipedia.org/wiki/syslog">syslog</a> as well as <code>mail.log</code>; log successes as well as failures</li>
    <li><code>UMask</code> - allows other Linux users (such as Postfix's) to talk to OpenDKIM</li>
    <li><code>UserID</code> - the user that OpenDKIM runs as</li>
</ul>
<p>Fairly straight forward.</p>
<h4>5 - Next, another copy of the socket definition in <code>/etc/default/opendkim</code> (I'm actually not sure why this one is necessary)</h4>
<pre class="bash"><code>SOCKET="inet:8891@localhost"</code></pre>
<p>Next, specify our keys in <code>/etc/opendkim/KeyTable</code>:</p>
<pre class="bash"><code>example.com example.com:mail:/etc/opendkim/keys/example.com.private</code></pre>
<p>The first entry is a name for the key. It can be anything and doesn't necessary have to match the domain, just so long as the corresponding entry in <code>SigningTable</code> matches. After that, you have the domain where your public key is hosted, the selector on that domain, and where the private key is locally located. So in the above example, <code>example.com:mail</code> corresponds to a key at <code>mail._domainkey.example.com</code>.</p>
<p>And what emails to sign in <code>/etc/opendkim/SigningTable</code>:</p>
<pre class="bash"><code>*@example.com example.com
*@*.example.com example.com
*@*.example.org example.com</code></pre>
<p>This one is a bit more complicated, since for my particular case, I had emails coming from two different domains, along with subdomains in both cases (the first field). They can (and in this case) all use the same key, since the second entry matches the value specified in <code>KeyTable</code>.</p>
<p>Note again: Since we're using wildcards here, we have to specify <code>refile</code> up above in <code>opendkim.conf</code>.</p>
<h4>6 - Next, <code>/etc/opendkim/TrustedHosts</code></h4>
<p>This file will be used to specify both incoming message we trust and outgoing message we will sign (although it doesn't have to do both).</p>
<pre class="bash"><code>127.0.0.1
10.77.0.0/16
example.com
*.example.com
*.example.org
*.*.example.org</code></pre>
<p>Entries here can be either IP addresses, <a href="https://en.wikipedia.org/wiki/CIDR">CIDR</a> style IP ranges, or hostnames (including wildcards, since this is a <code>refile</code>), all of which I use above. This actually took a bit to figure out, since originally I was signing email directly from the box (successfully), but when I attempted to actually send a signed email from the product, it didn't work (since the frontends relay mail to the mail servers).</p>
<h4>7 - Okay, that's enough to configure OpenDKIM. Next, we need to tell Postfix to talk to it</h4>
<p>This one is relatively straight forward as well. Just add a few lines to the bottom of <code>/etc/postfix/main.cf</code>:</p>
<pre class="bash"><code># DKIM
milter_default_action = accept
milter_protocol = 2
smtpd_milters = inet:localhost:8891
non_smtpd_milters = inet:localhost:8891</code></pre>
<p>Essentially, milter is a protocol Postfix uses for plugins. We want to configure all mail traffic (both from smptd and not) to go to OpenDKIM, via the port we specified (twice) earlier. Shiny.</p>
<h4>8 - Finally, restart both OpenDKIM and Postfix, so they can take advantage of their new settings</h4>
<pre class="bash"><code>sudo service opendkim restart
sudo service postfix restart</code></pre>
<p>This should only take a few seconds.</p>
<p>And that's it. We can send a test email:</p>
<pre class="bash"><code>echo "test email" | mail -s &lt;code&gt;hostname&lt;/code&gt; me@example.com</code></pre>
<p>That will send an email with the <code>hostname</code> of the current machine to the specified address, useful if you're working with multiple different machines and need to know which are up to date.</p>
<p>Check the message headers and you should see a block that looks like this:</p>
<pre class="bash"><code>DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=example.com; s=mail;
        t=1439063676; bh=RnRlt9pNo9HfghopMAD1V157IZOFVrE6piv9xdXYFNs=;
        h=To:Subject:Reply-To:From:Date;
        b=LekoRRQgOX97WUHP/ELtl/yhMzZsiCPr8kqaYUpZER5sYZ1dyAwgOKKvuI3mL3IMo
         4Y90NDGv+CHm2ZmAaGmFOgGnDPsDxLE+ptleVBP/cQny9grftwA8Emc3MKS6aJ/w5P
         E1bh2wFE8LiRTl/wcof6JL0MyeoR8R63FCKMgnA8=</code></pre>
<p>Bam.</p>
<h2>A few caveats</h2>
<p>So, what is DKIM actually used for?</p>
<p>The original claim is that it's an <em>email validation system designed to detect email spoofing</em>. Which is all well and good, but there's one big problem: adaptation.</p>
<p>Numbers are a little hard to come by, but one site that I found is builtWith trends: <a href="https://trends.builtwith.com/mx/DKIM">DKIM Usage Statistics</a>. Their reported coverage notes:</p>
<ul>
    <li>Quantcast Top 10k - 14 of 10,000</li>
    <li>Quantcast Top 100k - 104 of 100,000</li>
    <li>Quantcast Top Million - 585 of 865,105</li>
    <li>Entire Internet - 24,064 of 328,844,222</li>
</ul>
<p>That's less than 0.1% in any category. Not so great.</p>
<p>This is a problem, not because it means that mail servers aren't using it, but rather because there is little reason for mail <em>clients</em> to support it. It's easy enough to verify a DKIM signature if present, but they're so rarely present, that most will not go through that effort.</p>
<p>Furthmore, the header does not sign the message headers and (unless you are using SMTP over TLS), it is trivial to remove. If the DKIM header is not present, the message is trivial to modify with the recipient none the wiser. This could be offset--for some business models--by requiring messages to contain a DKIM header and rejecting those that don't.</p>
<p>Still, it's an interesting technology and there's no particular harm (other than a small amount of extra CPU effort to do the signing) in implementing it.</p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol><li><a name="footnote-1"></a>If I understand, all of the public key systems in general use have this property, although they don't strictly speaking have to.</li></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Setting up Postfix and OpenDKIM";
var disqus_url = "http://blog.jverkamp.com/2015/08/10/setting-up-postfix-and-opendkim/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="//blog.jverkamp.com/2015/07/28/laundry-files">← Laundry Files</a></li><li><a href="//blog.jverkamp.com/category/archives">Archives</a></li><li><a href="//blog.jverkamp.com/2015/08/24/adjacency-matrix-generator">Adjacency Matrix Generator →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="//blog.jverkamp.com/2015/07/22/finding-aws-iam-users-by-access-key">← Finding AWS IAM users by access key</a></li><li><a href="//blog.jverkamp.com/category/programming">Programming</a></li><li><a href="//blog.jverkamp.com/2015/08/24/adjacency-matrix-generator">Adjacency Matrix Generator →</a></li></ul></nav>

                <div class="legal">
                        <a href="//blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="//blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.defer=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
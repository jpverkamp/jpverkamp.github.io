<!doctype html><html><head><title>Performance problems with Flask and Docker – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet><link rel=stylesheet href=/custom.css defer><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Performance problems with Flask and Docker</h1><div class=entry-meta><span class=entry-date>2015-04-03</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/02/26/ts-timestamping-stdout/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2015/04/14/a-quick-look-at-rc4/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/04/01/parsing-aws-instance-data-with-jq/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/aws>AWS</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2015/04/01/parsing-aws-instance-data-with-jq/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/aws-ec2>AWS EC2</a><a href=https://blog.jverkamp.com/2015/10/30/finding-ec2-instances-by-tag/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/aws-elb>AWS ELB</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2015/02/04/docker-bash-and-docker-stop-all/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/docker>Docker</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/flask>Flask</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/11/13/a-one-line-echo-server-using-let-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/networks>Networks</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/nginx>nginx</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/websites>Websites</a><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2015/04/01/parsing-aws-instance-data-with-jq/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/04/07/generating-perfect-portmanteaus/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2015/04/01/parsing-aws-instance-data-with-jq/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2015/04/07/generating-perfect-portmanteaus/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>I had an interesting problem recently on a project I was working on. It&rsquo;s a simple <a href=http://flask.pocoo.org/>Flask</a>-based webapp, designed to be deployed to <a href=https://aws.amazon.com/>AWS</a> using <a href=https://www.docker.com/>Docker</a>. The application worked just fine when I was running it locally, but as soon as I pushed the docker container&mldr;</p><p>Latency spikes. Bad enough that the application was failing AWS&rsquo;s healthy host checks, cycling in and out of existence<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><figure><img src=/embeds/2015/health-check.png></figure><p>At that time, the only traffic to the container was the health checks, every 30 seconds, as regular as clockwork. So it wasn&rsquo;t load that was making them fail. And it was exactly the same code each time<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/&#39;</span>, methods <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;GET&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>healthcheck</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;I&#39;m a teapot&#34;</span>
</span></span></code></pre></div><p>So not that either. So what in the world was going on?</p><p>Google to the rescue! <code>&lt;a href="https://www.google.com/search?q=flask application periodically slow">flask application periodically slow&lt;/a></code></p><p>The very first link is a response on StackOverflow:</p><blockquote><p>On operating systems that support ipv6 and have it configured such as modern Linux systems, OS X 10.4 or higher as well as Windows Vista some browsers can be painfully slow if accessing your local server. The reason for this is that sometimes “localhost” is configured to be available on both ipv4 and ipv6 socktes and some browsers will try to access ipv6 first and then ivp4. &ndash; <a href=http://stackoverflow.com/questions/11150343/slow-requests-on-local-flask-server>Slow Requests on Local Flask Server</a></p></blockquote><p>Huh. Get a shell into my docker container, and what do you know:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /etc/hosts
</span></span><span style=display:flex><span>172.17.1.112	27392a3e0fa5
</span></span><span style=display:flex><span>127.0.0.1	localhost
</span></span><span style=display:flex><span>::1	localhost ip6-localhost ip6-loopback
</span></span><span style=display:flex><span>fe00::0	ip6-localnet
</span></span><span style=display:flex><span>ff00::0	ip6-mcastprefix
</span></span><span style=display:flex><span>ff02::1	ip6-allnodes
</span></span><span style=display:flex><span>ff02::2	ip6-allrouters
</span></span></code></pre></div><p>Yup. <code>localhost</code> routes to both IPv4&rsquo;s <code>127.0.0.1</code> and IPv6&rsquo;s <code>::1</code>. Comment out the <code>::1</code> line and give it a shot&mldr; Yup. That did it. Waited ten minutes and the hosts weren&rsquo;t marked unhealthy once. All I should need to do is add it to the <code>Dockerfile</code> and we should be golden, yes?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ vi Dockerfile
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>RUN sed -i &#34;s/::1.*//g&#34;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker build .
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Step 9 : RUN sed -i &#34;s/::1.*//g&#34; /etc/hosts
</span></span><span style=display:flex><span> ---&gt; Running in 7c73dc473507
</span></span><span style=display:flex><span>sed: cannot rename /etc/sedXZv0Yy: Device or resource busy
</span></span></code></pre></div><p>What.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ vi Dockerfile
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>RUN sed &#34;s/::1.*//g&#34; /etc/hosts &gt; /etc/hosts-new &amp;&amp; mv /etc/hosts-new /etc/hosts
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker build .
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>RUN sed &#34;s/::1.*//g&#34; /etc/hosts &gt; /etc/hosts-new &amp;&amp; mv /etc/hosts-new /etc/hosts
</span></span><span style=display:flex><span> ---&gt; Running in d6b896f4fc9e
</span></span><span style=display:flex><span>sed: cannot rename /etc/sedqYrfxO: Device or resource busy
</span></span></code></pre></div><p>Double what.</p><p>Back to Google: <code>&lt;a href="https://www.google.com/search?q=docker edit hosts">docker edit hosts&lt;/a></code></p><p>Specifically: <a href=https://github.com/docker/docker/issues/1951>Unable to modify /etc/hosts file in a container #1951</a>. Looks like there was a fix that would let you edit <code>/etc/hosts</code> if you were in a container (that used to not be possible), but (because it&rsquo;s actually mounted rather than just a container file), it&rsquo;s non-trivial to edit it as part of a build.</p><p>All righty then.</p><p>That&rsquo;s about when I decided to listen to the Flask documentation:</p><blockquote><p>You can use the builtin server during development, but you should use a full deployment option for production applications. (Do not use the builtin development server in production.)</p></blockquote><p>All right. Not only is it what I&rsquo;m actually supposed to be doing, but if I used CGI, I can avoid Flask trying to resolve <code>localhost</code> at all. I&rsquo;ve worked with <a href=http://wiki.nginx.org/Main>nginx</a> before. Let&rsquo;s use that.</p><p>Picking some documentation from a hat, I decided to use <a href=https://uwsgi-docs.readthedocs.org/en/latest/>uWSGI</a> as the glue between nginx and Flask. Easy enough to install with pip (although I had to grab a C compiler from the apt package <code>build-essential</code>) and off we go.</p><p>First, a small <code>nginx</code> config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/</span> { <span style=color:#f92672>try_files</span> $uri <span style=color:#e6db74>@project</span>; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>@project</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>include</span> <span style=color:#e6db74>uwsgi_params</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>uwsgi_pass</span> <span style=color:#e6db74>unix:/tmp/uwsgi.sock</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then, to start it all up, a change to the <code>Dockerfile</code> <code>CMD</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>CMD uwsgi -s /tmp/uwsgi.sock -w project:app --chown-socket<span style=color:#f92672>=</span>www-data:www-data --enable-threads &amp; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    nginx -g <span style=color:#e6db74>&#39;daemon off;&#39;</span>
</span></span></code></pre></div><p>That <code>--chown-socket</code> flag really drove me a bit batty. Basically, <code>uwsgi</code> was starting as the <code>root</code> user (within the Docker container). <code>nginx</code> was starting as <code>root</code>. But the <code>nginx</code> threads were not. They were starting as <code>www-data</code> and thus couldn&rsquo;t read the Unix socket between the two.</p><p>All righty then.</p><p>Let&rsquo;s go!</p><p>Starting successfully&mldr; And it&rsquo;s running. Not on the first try or even the 10th (I left out quite a bit of fumbling around tweaking flags), but eventually as was well in the world.</p><p>Push it out to AWS&mldr;</p><p>Health check passed.</p><p>Bam.</p><p>Awesome.</p><p>Now I not only have a neat little webapp, I have one that doesn&rsquo;t randomly decide to take forever on every other request or so.</p><p>If you&rsquo;re looking for the bare minimum <code>requirements.txt</code> and <code>Dockerfile</code> that I&rsquo;m using (in addition to that <code>nginx</code> host configuration file above), here they are:</p><p><code>requirements.txt</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>flask
</span></span><span style=display:flex><span>flup6
</span></span><span style=display:flex><span>uwsgi
</span></span></code></pre></div><p><code>Dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>FROM ubuntu:14.04
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN apt-get update &amp;&amp; apt-get install -y build-essential nginx python3.4 python3.4-dev
</span></span><span style=display:flex><span>RUN easy_install3 pip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WORKDIR /project
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ADD requirements.txt /project/requirements.txt
</span></span><span style=display:flex><span>RUN pip install -r requirements.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ADD . /project
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ADD nginx /etc/nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD uwsgi -s /tmp/uwsgi.sock -w project:app --chown-socket=www-data:www-data --enable-threads &amp; \
</span></span><span style=display:flex><span>    nginx -g &#39;daemon off;&#39;
</span></span></code></pre></div><p>It&rsquo;s for moments like these that I do software. That little moment when everything comes together just right and it all just &mldr; works.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>The tighter spikes are when I was playing with the health check timeout to see if that would help&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>See <a href=https://en.wikipedia.org/wiki/HTTP%20418>HTTP 418</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>I really want to implement that properly one day&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script defer src=/custom.js></script></body></html>
<!DOCTYPE html>
<html>
<head>
        
        

        <title>Twitter puddle | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" defer></script>
        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js" defer></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" defer />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" defer />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" defer></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" defer />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js" defer></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js" defer></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" defer />
        <script src="/highlight/highlight.pack.js" defer></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" defer />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js" defer ></script>

        <!-- Pretty pretty fonts -->
        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Calligraffitti" defer />

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" defer />
        <script src="/custom.js" defer></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="http://blog.jverkamp.com/category/archives/2015">2015</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/book-reviews">Book Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="http://blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Twitter puddle</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-11-30"><span class="year">2013</span> <span class="month">Nov</span> <span class="day">30</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-topic/cellular-automata">Cellular Automata</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/graphics">Graphics</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/procedurally-generated-content">Procedurally Generated Content</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/websites/twitter">Twitter</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>This one has been sitting in my backlog for a while and its been a while since I've gotten to write a programming post<span class="footnote"><sup><a href="#footnote-1">[1]</a></sup></span>, but now seems as good time as ever: <a href="http://programmingpraxis.com/2013/11/15/twitter-puddle/">Twitter puzzle</a></p>
<!--more-->
<p>The basic idea is that you're going to get a series of wall heights representing a bumpy landscape. For example:</p>
<pre class="scheme"><code>&gt; (draw-puddle (make-puddle '(2 5 1 2 3 4 7 7 6)))</code></pre>
<p><a href="http://blog.jverkamp.com/2013/11/30/twitter-puddle/initial-state.png" data-toggle="lightbox"><img src="http://blog.jverkamp.com/2013/11/30/twitter-puddle/initial-state.png" /></a></p>
<p>(Just ignore the water at the top, this is actually the first state of the simulation that we'll be writing.)</p>
<p>Once we have a world, the goal is to figure out how much water we could store in that world. In this case, any water on either side of the middle pool will fall off the sides, as will water over the left wall in the center. So the final state we're looking for should look something like this:</p>
<p><a href="http://blog.jverkamp.com/2013/11/30/twitter-puddle/final-state.png" data-toggle="lightbox"><img src="http://blog.jverkamp.com/2013/11/30/twitter-puddle/final-state.png" /></a></p>
<p>So how do we get there?</p>
<p>Well, first we need some way to represent the world. I'm going to go with a two dimensional vector of vectors. Each element will be one of the symbols <code>empty</code>, <code>wall</code>, or <code>water</code>. Something like this:</p>
<pre class="scheme"><code>; Twitter puddle structure; 2d grid of item types (empty, wall, water)
(struct puddle (data) #:transparent #:mutable)</code></pre>
<p>In addition to that, we probably want a few convince functions. In this case, we'll write a function to turn a list of wall heights into a puddle (as seen above), accessors for the height, and a getter/setter. I'm going to do something a bit interesting with the getter/setter. Rather than forcing the programmer to deal with boundary conditions, I'll just check the bounds here and return <code>#f</code> if we can't get/set a value.</p>
<pre class="scheme"><code>; Create a puddle from a list of wall heights
(define (make-puddle wall-heights)
  (define w (length wall-heights))
  (define h (add1 (apply max wall-heights)))

  (puddle
   (for/vector ([r (in-range h)])
     (for/vector ([c (in-range w)]
                  [h (in-list wall-heights)])
       (if (&lt; r h) 'wall 'empty)))))

; Getter/setter for puddle data
(define (puddle-ref p r c)
  (with-handlers ([exn? (λ (e) #f)])
    (vector-ref (vector-ref (puddle-data p) r) c)))

(define (puddle-set!? p r c v)
  (with-handlers ([exn? (λ (e) #f)])
    (vector-set! (vector-ref (puddle-data p) r) c v))
  #t)

; Get the size of a puddle
(define (puddle-height p)
  (vector-length (puddle-data p)))

(define (puddle-width p)
  (vector-length (vector-ref (puddle-data p) 0)))</code></pre>
<p>From here, we have two options for our simulation. Either we want to step the entire simulation (so that water falls down) or we want to add some new water. For both cases, we'll create a new puddle and mutate that one. That way later when we want to compare the current state to previous states, we can do so. So first, stepping:</p>
<pre class="scheme"><code>; Perform one step in puddle simulation
; Try moving each water these directions in order:
; - down, down left, down right, left, right, no move (will always succeed)
(define (step p)
  ; Create the new puddle (if you do it in place, water teleports)
  (define new-p
    (puddle (for/vector ([row (in-vector (puddle-data p))])
              (for/vector ([col (in-vector row)])
                (case col
                  [(empty water) 'empty]
                  [(wall)        'wall])))))

  ; Update each element in turn
  (for ([r (in-naturals)]
        [row (in-vector (puddle-data p))])
    (for ([c (in-naturals)]
          [col (in-vector row)])
      (let/ec break
        (when (eq? 'water col)
          (for ([rd (in-list '(-1 -1 -1  0  0  0  1))]
                [cd (in-list '( 0 -1  1 -1  1  0  0))])
            (case (puddle-ref new-p (+ r rd) (+ c cd))
              [(empty #f)
               (when (puddle-set!? new-p (+ r rd) (+ c cd) 'water)
                 (break))]))))))

  new-p)</code></pre>
<p>Essentially, copy the puddle and then check down, diagonally, and finally to the sides. This will help water fill in puddles and drain off to the sides when walls aren't high enough. I'm using a trick I've used before with <code>let/ec</code> to basically add early returns to Racket. It's nice how things like that are possible.</p>
<p>Next, dripping. Essentially, we want to create new water along the top. Originally, I had this random, but to make sure that we tried each of them I changed it so optionally you can specify the column:</p>
<pre class="scheme"><code>; Add water to the top row (randomly if column is #f)
(define (drip p [column #f])
  ; Copy the old puddle
  (define new-p
    (puddle (for/vector ([row (in-vector (puddle-data p))])
              (for/vector ([col (in-vector row)])
                col))))

  ; Insert at a specified location or randomly
  (define r (sub1 (puddle-height p)))
  (cond
    [column
     (puddle-set!? new-p r column 'water)]
    [else
     (let/ec break
       (for ([c (in-list (shuffle (range (puddle-width p))))])
         (when (puddle-set!? new-p r c 'water)
           (break))))])

  new-p)</code></pre>
<p>Cool. So what do we need to make this actually run a simulation? Well, first you could write everything manually. But that won't (easily) let you visualize it. Luckily, there is a perfect solution to running and visualizing a simulation: <code><a href="http://docs.racket-lang.org/search/index.html?q=2hdtp/universe">2hdtp/universe</a></code>. Specifically, the <code><a href="http://docs.racket-lang.org/search/index.html?q=big-bang">big-bang</a></code> function.</p>
<pre class="scheme"><code>; Run an entire simulation until steady state
(define (simulate puddle)
  (define previous-states          (make-hash))
  (define (previous-state? puddle) (hash-has-key? previous-states puddle))
  (define (add-state! puddle)      (hash-set! previous-states puddle #t))

  (define potential-drips (shuffle (range (puddle-width puddle))))
  (define stop? #f)

  (big-bang puddle
    [record? "output"]
    [stop-when (λ (puddle) stop?)]
    [on-draw draw-puddle]
    [on-tick
     (λ (puddle)
       (let/ec return
         ; We've not seen the stepped case before, use that
         (define stepped (step puddle))
         (when (and (not (equal? stepped puddle))
                    (not (previous-state? stepped)))
           (add-state! stepped)
           (return stepped))

         ; If we don't have any potential drips left, we've reached steady state
         ; Try inverting first
         (when (null? potential-drips)
           (when (equal? stepped puddle)
             (printf "steady state: ~a\n" (puddle-count puddle 'water))
             (set! stop? #t))

           (return stepped))

         ; Try to drip instead, if we've seen this drip, don't drip here again
         (define dripped (drip puddle (car potential-drips)))
         (when (or (equal? dripped puddle)
                   (previous-state? dripped))
           (set! potential-drips (cdr potential-drips)))

         (return dripped)))]))</code></pre>
<p>There are a few other bits here, so let's break it down. First, we have some separate state for the simulation. We want to keep track of every state that we generate, since if we see something that we've already seen before, we know that we can advance. When we get into the <code>big-bang</code>, we have four clauses of interest:</p>
<ul>
  <li><code>record?</code></li>
  <li><code>stop-when</code></li>
  <li><code>on-draw</code></li>
  <li><code>on-tick</code></li>
</ul>
<p><code>record?</code> lets us generate GIFs. I'll show one here in a second. <code>stop-when?</code> stops the simulation and returns the ending state. <code>on-draw</code> is the function used to turn a puddle into an image that <code>2htdp/universe</code> can use. Finally, <code>on-tick</code> is the meat of the function.</p>
<p>Within <code>on-tick</code> we have a series of checks. First, we try to step. If we can't, then the current water has reached a steady state. Unfortunately, we also need to check multiple previous states because it's easily possible for water to alternate between two states given a flat surface.</p>
<p>If both of those conditions are skipped, then we should try to drip. Here, I have a list of the columns (shuffled for appearance) that will each be tried in turn. Once that list is <code>null?</code>, we're probably null. Run one last time until steady state so that the water can settle and then count it up.</p>
<p>Finally, if we get this far, try to drip. We know that a state is done if dripping ends up with the same state we've seen before because that means water is no longer settling and instead draining out of the world.</p>
<p>Well, that's that. The only thing we have left is the drawing function: Using the <code>2htdp/image</code> library, it's rather straight forward:</p>
<pre class="scheme"><code>; Convert a puddle into a pict
(define (draw-puddle p)
  (define (make-row row)
    (apply beside
           (for/list ([col (in-vector row)])
             (rectangle
              (current-block-size) (current-block-size)
              "solid"
              (case col
                [(empty) "white"]
                [(wall)  "black"]
                [(water) "blue"])))))

  (apply above
         (reverse
          (for/list ([row (in-vector (puddle-data p))])
            (make-row row)))))</code></pre>
<p>And that's it. I did promise an animated GIF (and <code>record?</code> makes that trivial), so here it is:</p>
<pre class="scheme"><code>&gt; (parameterize ([current-block-size 25])
    (simulate (make-puddle '(2 5 1 2 3 4 7 7 6))))</code></pre>
<p><a href="http://blog.jverkamp.com/2013/11/30/twitter-puddle/solution.gif" data-toggle="lightbox"><img src="http://blog.jverkamp.com/2013/11/30/twitter-puddle/solution.gif" /></a></p>
<pre class="scheme"><code>steady state: 10
(puddle
 '#(#(wall wall wall wall wall wall wall wall wall)
    #(wall wall water wall wall wall wall wall wall)
    #(empty wall water water wall wall wall wall wall)
    #(empty wall water water water wall wall wall wall)
    #(empty wall water water water water wall wall wall)
    #(empty empty empty empty empty empty wall wall wall)
    #(empty empty empty empty empty empty wall wall empty)
    #(empty empty empty empty empty empty empty empty empty)))</code></pre>
<p>And there we have it. As always, if you'd like to see the code for today's post, you can do so here: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/twitter-puddle.rkt">twitter-puddle</a>.</p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol><li><a name="footnote-1"></a>Don't worry, I am still intending to post more in the <a href="http://blog.jverkamp.com/2013/11/09/chapter-2-writings-in-silver">Making music series</a>, just not today.</li></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Twitter puddle";
var disqus_url = "http://blog.jverkamp.com/2013/11/30/twitter-puddle/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/11/29/thor-the-dark-world">← Thor: The Dark World</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2013/11/30/chapter-8-and-something-else">Chapter 8 -- And Something Else →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise">← Making music, part 3: Making noise</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2013/12/21/rock-paper-scissors">Rock-paper-scissors →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.defer=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
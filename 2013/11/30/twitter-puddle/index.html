<!doctype html><html><head><title>Twitter puddle – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.9efa38cb8d96be1a2d31208e5279a2f48fd2a15f6bcc9173c7375c675225b767.css integrity="sha256-nvo4y42WvhotMSCOUnmi9I/SoV9rzJFzxzdcZ1Ilt2c="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Twitter puddle</h1><div class=entry-meta><span class=entry-date>2013-11-30</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/12/21/rock-paper-scissors/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2013/12/21/rock-paper-scissors/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/10/17/rule-30-rng/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/cellular-automata>Cellular Automata</a><a href=https://blog.jverkamp.com/2014/03/11/brownian-trees/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/graphics>Graphics</a><a href=https://blog.jverkamp.com/2014/03/11/brownian-trees/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/procedural-content>Procedural Content</a><a href=https://blog.jverkamp.com/2014/03/11/brownian-trees/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/01/17/decoding-escaped-unicode-strings/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/twitter>Twitter</a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/12/21/rock-paper-scissors/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/11/27/chapter-7-angels-and-demons/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/11/30/chapter-8-and-something-else/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>This one has been sitting in my backlog for a while and its been a while since I&rsquo;ve gotten to write a programming post<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, but now seems as good time as ever: <a href=http://programmingpraxis.com/2013/11/15/twitter-puddle/>Twitter puzzle</a></p><p>The basic idea is that you&rsquo;re going to get a series of wall heights representing a bumpy landscape. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>draw-puddle</span> (<span style=color:#a6e22e>make-puddle</span> <span style=color:#f92672>&#39;</span>(<span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>6</span>)))
</span></span></code></pre></div><figure><img src=/embeds/2013/initial-state.png></figure><p>(Just ignore the water at the top, this is actually the first state of the simulation that we&rsquo;ll be writing.)</p><p>Once we have a world, the goal is to figure out how much water we could store in that world. In this case, any water on either side of the middle pool will fall off the sides, as will water over the left wall in the center. So the final state we&rsquo;re looking for should look something like this:</p><figure><img src=/embeds/2013/final-state.png></figure><p>So how do we get there?</p><p>Well, first we need some way to represent the world. I&rsquo;m going to go with a two dimensional vector of vectors. Each element will be one of the symbols <code>empty</code>, <code>wall</code>, or <code>water</code>. Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Twitter puddle structure; 2d grid of item types (empty, wall, water)</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> puddle (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>#</span>:transparent <span style=color:#f92672>#</span>:mutable)
</span></span></code></pre></div><p>In addition to that, we probably want a few convince functions. In this case, we&rsquo;ll write a function to turn a list of wall heights into a puddle (as seen above), accessors for the height, and a getter/setter. I&rsquo;m going to do something a bit interesting with the getter/setter. Rather than forcing the programmer to deal with boundary conditions, I&rsquo;ll just check the bounds here and return <code>#f</code> if we can&rsquo;t get/set a value.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Create a puddle from a list of wall heights</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>make-puddle</span> wall-heights)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>w (length wall-heights))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>h (<span style=color:#a6e22e>add1</span> (apply max wall-heights)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>puddle</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for/vector</span> ([r (<span style=color:#a6e22e>in-range</span> h)])
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>for/vector</span> ([c (<span style=color:#a6e22e>in-range</span> w)]
</span></span><span style=display:flex><span>                  [h (<span style=color:#a6e22e>in-list</span> wall-heights)])
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>if </span>(&lt; r h) <span style=color:#e6db74>&#39;wall</span> <span style=color:#e6db74>&#39;empty</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Getter/setter for puddle data</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>puddle-ref</span> p r c)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>with-handlers</span> ([exn? (<span style=color:#960050;background-color:#1e0010>λ</span> (<span style=color:#a6e22e>e</span>) <span style=color:#66d9ef>#f</span>)])
</span></span><span style=display:flex><span>    (vector-ref (vector-ref (<span style=color:#a6e22e>puddle-data</span> p) r) c)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>puddle-set!?</span> p r c v)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>with-handlers</span> ([exn? (<span style=color:#960050;background-color:#1e0010>λ</span> (<span style=color:#a6e22e>e</span>) <span style=color:#66d9ef>#f</span>)])
</span></span><span style=display:flex><span>    (vector-set! (vector-ref (<span style=color:#a6e22e>puddle-data</span> p) r) c v))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>#t</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Get the size of a puddle</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>puddle-height</span> p)
</span></span><span style=display:flex><span>  (vector-length (<span style=color:#a6e22e>puddle-data</span> p)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>puddle-width</span> p)
</span></span><span style=display:flex><span>  (vector-length (vector-ref (<span style=color:#a6e22e>puddle-data</span> p) <span style=color:#ae81ff>0</span>)))
</span></span></code></pre></div><p>From here, we have two options for our simulation. Either we want to step the entire simulation (so that water falls down) or we want to add some new water. For both cases, we&rsquo;ll create a new puddle and mutate that one. That way later when we want to compare the current state to previous states, we can do so. So first, stepping:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Perform one step in puddle simulation</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Try moving each water these directions in order:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; - down, down left, down right, left, right, no move (will always succeed)</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>step</span> p)
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Create the new puddle (if you do it in place, water teleports)</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>new-p
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>puddle</span> (<span style=color:#a6e22e>for/vector</span> ([row (<span style=color:#a6e22e>in-vector</span> (<span style=color:#a6e22e>puddle-data</span> p))])
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>for/vector</span> ([col (<span style=color:#a6e22e>in-vector</span> row)])
</span></span><span style=display:flex><span>                (<span style=color:#66d9ef>case </span>col
</span></span><span style=display:flex><span>                  [(<span style=color:#a6e22e>empty</span> water) <span style=color:#e6db74>&#39;empty</span>]
</span></span><span style=display:flex><span>                  [(<span style=color:#a6e22e>wall</span>)        <span style=color:#e6db74>&#39;wall</span>])))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Update each element in turn</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>for</span> ([r (<span style=color:#a6e22e>in-naturals</span>)]
</span></span><span style=display:flex><span>        [row (<span style=color:#a6e22e>in-vector</span> (<span style=color:#a6e22e>puddle-data</span> p))])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>for</span> ([c (<span style=color:#a6e22e>in-naturals</span>)]
</span></span><span style=display:flex><span>          [col (<span style=color:#a6e22e>in-vector</span> row)])
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>let/ec</span> break
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>when</span> (eq? <span style=color:#e6db74>&#39;water</span> col)
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>for</span> ([rd (<span style=color:#a6e22e>in-list</span> <span style=color:#f92672>&#39;</span>(<span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>))]
</span></span><span style=display:flex><span>                [cd (<span style=color:#a6e22e>in-list</span> <span style=color:#f92672>&#39;</span>( <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>0</span>))])
</span></span><span style=display:flex><span>            (<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>puddle-ref</span> new-p (+ r rd) (+ c cd))
</span></span><span style=display:flex><span>              [(<span style=color:#a6e22e>empty</span> <span style=color:#66d9ef>#f</span>)
</span></span><span style=display:flex><span>               (<span style=color:#a6e22e>when</span> (<span style=color:#a6e22e>puddle-set!?</span> new-p (+ r rd) (+ c cd) <span style=color:#e6db74>&#39;water</span>)
</span></span><span style=display:flex><span>                 (<span style=color:#a6e22e>break</span>))]))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  new-p)
</span></span></code></pre></div><p>Essentially, copy the puddle and then check down, diagonally, and finally to the sides. This will help water fill in puddles and drain off to the sides when walls aren&rsquo;t high enough. I&rsquo;m using a trick I&rsquo;ve used before with <code>let/ec</code> to basically add early returns to Racket. It&rsquo;s nice how things like that are possible.</p><p>Next, dripping. Essentially, we want to create new water along the top. Originally, I had this random, but to make sure that we tried each of them I changed it so optionally you can specify the column:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Add water to the top row (randomly if column is #f)</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>drip</span> p [column <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Copy the old puddle</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>new-p
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>puddle</span> (<span style=color:#a6e22e>for/vector</span> ([row (<span style=color:#a6e22e>in-vector</span> (<span style=color:#a6e22e>puddle-data</span> p))])
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>for/vector</span> ([col (<span style=color:#a6e22e>in-vector</span> row)])
</span></span><span style=display:flex><span>                col))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Insert at a specified location or randomly</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>r (<span style=color:#a6e22e>sub1</span> (<span style=color:#a6e22e>puddle-height</span> p)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    [column
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>puddle-set!?</span> new-p r column <span style=color:#e6db74>&#39;water</span>)]
</span></span><span style=display:flex><span>    [else
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>let/ec</span> break
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>for</span> ([c (<span style=color:#a6e22e>in-list</span> (<span style=color:#a6e22e>shuffle</span> (<span style=color:#a6e22e>range</span> (<span style=color:#a6e22e>puddle-width</span> p))))])
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>when</span> (<span style=color:#a6e22e>puddle-set!?</span> new-p r c <span style=color:#e6db74>&#39;water</span>)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>break</span>))))])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  new-p)
</span></span></code></pre></div><p>Cool. So what do we need to make this actually run a simulation? Well, first you could write everything manually. But that won&rsquo;t (easily) let you visualize it. Luckily, there is a perfect solution to running and visualizing a simulation: <code><a href="http://docs.racket-lang.org/search/index.html?q=2hdtp/universe">2hdtp/universe</a></code>
. Specifically, the <code><a href="http://docs.racket-lang.org/search/index.html?q=big-bang">big-bang</a></code>
function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Run an entire simulation until steady state</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>simulate</span> puddle)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>previous-states          (<span style=color:#a6e22e>make-hash</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>previous-state?</span> puddle) (<span style=color:#a6e22e>hash-has-key?</span> previous-states puddle))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>add-state!</span> puddle)      (<span style=color:#a6e22e>hash-set!</span> previous-states puddle <span style=color:#66d9ef>#t</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>potential-drips (<span style=color:#a6e22e>shuffle</span> (<span style=color:#a6e22e>range</span> (<span style=color:#a6e22e>puddle-width</span> puddle))))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>stop? <span style=color:#66d9ef>#f</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>big-bang</span> puddle
</span></span><span style=display:flex><span>    [record? <span style=color:#e6db74>&#34;output&#34;</span>]
</span></span><span style=display:flex><span>    [stop-when (<span style=color:#960050;background-color:#1e0010>λ</span> (<span style=color:#a6e22e>puddle</span>) stop?)]
</span></span><span style=display:flex><span>    [on-draw draw-puddle]
</span></span><span style=display:flex><span>    [on-tick
</span></span><span style=display:flex><span>     (<span style=color:#960050;background-color:#1e0010>λ</span> (<span style=color:#a6e22e>puddle</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>let/ec</span> return
</span></span><span style=display:flex><span>         <span style=color:#75715e>; We&#39;ve not seen the stepped case before, use that</span>
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define </span>stepped (<span style=color:#a6e22e>step</span> puddle))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>and </span>(not (equal? stepped puddle))
</span></span><span style=display:flex><span>                    (not (<span style=color:#a6e22e>previous-state?</span> stepped)))
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>add-state!</span> stepped)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>return</span> stepped))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>; If we don&#39;t have any potential drips left, we&#39;ve reached steady state</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>; Try inverting first</span>
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>when</span> (null? potential-drips)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>when</span> (equal? stepped puddle)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;steady state: ~a\n&#34;</span> (<span style=color:#a6e22e>puddle-count</span> puddle <span style=color:#e6db74>&#39;water</span>))
</span></span><span style=display:flex><span>             (<span style=color:#66d9ef>set! </span>stop? <span style=color:#66d9ef>#t</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>return</span> stepped))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>; Try to drip instead, if we&#39;ve seen this drip, don&#39;t drip here again</span>
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define </span>dripped (<span style=color:#a6e22e>drip</span> puddle (car potential-drips)))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>or </span>(equal? dripped puddle)
</span></span><span style=display:flex><span>                   (<span style=color:#a6e22e>previous-state?</span> dripped))
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>set! </span>potential-drips (cdr potential-drips)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>return</span> dripped)))]))
</span></span></code></pre></div><p>There are a few other bits here, so let&rsquo;s break it down. First, we have some separate state for the simulation. We want to keep track of every state that we generate, since if we see something that we&rsquo;ve already seen before, we know that we can advance. When we get into the <code>big-bang</code>, we have four clauses of interest:</p><ul><li><code>record?</code></li><li><code>stop-when</code></li><li><code>on-draw</code></li><li><code>on-tick</code></li></ul><p><code>record?</code> lets us generate GIFs. I&rsquo;ll show one here in a second. <code>stop-when?</code> stops the simulation and returns the ending state. <code>on-draw</code> is the function used to turn a puddle into an image that <code>2htdp/universe</code> can use. Finally, <code>on-tick</code> is the meat of the function.</p><p>Within <code>on-tick</code> we have a series of checks. First, we try to step. If we can&rsquo;t, then the current water has reached a steady state. Unfortunately, we also need to check multiple previous states because it&rsquo;s easily possible for water to alternate between two states given a flat surface.</p><p>If both of those conditions are skipped, then we should try to drip. Here, I have a list of the columns (shuffled for appearance) that will each be tried in turn. Once that list is <code>null?</code>, we&rsquo;re probably null. Run one last time until steady state so that the water can settle and then count it up.</p><p>Finally, if we get this far, try to drip. We know that a state is done if dripping ends up with the same state we&rsquo;ve seen before because that means water is no longer settling and instead draining out of the world.</p><p>Well, that&rsquo;s that. The only thing we have left is the drawing function: Using the <code>2htdp/image</code> library, it&rsquo;s rather straight forward:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Convert a puddle into a pict</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>draw-puddle</span> p)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>make-row</span> row)
</span></span><span style=display:flex><span>    (apply beside
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>for/list</span> ([col (<span style=color:#a6e22e>in-vector</span> row)])
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>rectangle</span>
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>current-block-size</span>) (<span style=color:#a6e22e>current-block-size</span>)
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;solid&#34;</span>
</span></span><span style=display:flex><span>              (<span style=color:#66d9ef>case </span>col
</span></span><span style=display:flex><span>                [(<span style=color:#a6e22e>empty</span>) <span style=color:#e6db74>&#34;white&#34;</span>]
</span></span><span style=display:flex><span>                [(<span style=color:#a6e22e>wall</span>)  <span style=color:#e6db74>&#34;black&#34;</span>]
</span></span><span style=display:flex><span>                [(<span style=color:#a6e22e>water</span>) <span style=color:#e6db74>&#34;blue&#34;</span>])))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (apply above
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>reverse</span>
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>for/list</span> ([row (<span style=color:#a6e22e>in-vector</span> (<span style=color:#a6e22e>puddle-data</span> p))])
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>make-row</span> row)))))
</span></span></code></pre></div><p>And that&rsquo;s it. I did promise an animated GIF (and <code>record?</code> makes that trivial), so here it is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>parameterize</span> ([current-block-size <span style=color:#ae81ff>25</span>])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>simulate</span> (<span style=color:#a6e22e>make-puddle</span> <span style=color:#f92672>&#39;</span>(<span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>6</span>))))
</span></span></code></pre></div><figure><img src=/embeds/2013/solution.gif></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>steady state: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>puddle</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&#39;#</span>(<span style=color:#f92672>#</span>(wall wall wall wall wall wall wall wall wall)
</span></span><span style=display:flex><span>    <span style=color:#f92672>#</span>(wall wall water wall wall wall wall wall wall)
</span></span><span style=display:flex><span>    <span style=color:#f92672>#</span>(empty wall water water wall wall wall wall wall)
</span></span><span style=display:flex><span>    <span style=color:#f92672>#</span>(empty wall water water water wall wall wall wall)
</span></span><span style=display:flex><span>    <span style=color:#f92672>#</span>(empty wall water water water water wall wall wall)
</span></span><span style=display:flex><span>    <span style=color:#f92672>#</span>(empty empty empty empty empty empty wall wall wall)
</span></span><span style=display:flex><span>    <span style=color:#f92672>#</span>(empty empty empty empty empty empty wall wall empty)
</span></span><span style=display:flex><span>    <span style=color:#f92672>#</span>(empty empty empty empty empty empty empty empty empty)))
</span></span></code></pre></div><p>And there we have it. As always, if you&rsquo;d like to see the code for today&rsquo;s post, you can do so here: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/twitter-puddle.rkt>twitter-puddle</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Don&rsquo;t worry, I am still intending to post more in the <a href=https://blog.jverkamp.com/2013/11/09/chapter-2-writings-in-silver/>Making music series</a>, just not today.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
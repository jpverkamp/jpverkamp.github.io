<!DOCTYPE html>
<html>
<head>
    <title>
    Twitter puddle â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Twitter puddle</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2013-11-30</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2013/12/21/rock-paper-scissors/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a>
                        <a href="https://blog.jverkamp.com/2013/12/21/rock-paper-scissors/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2012/10/17/rule-30-rng/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/cellular-automata">Cellular Automata</a>
                        <a href="https://blog.jverkamp.com/2014/03/11/brownian-trees/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/graphics">Graphics</a>
                        <a href="https://blog.jverkamp.com/2014/03/11/brownian-trees/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/programming/topics/procedural-content">Procedural Content</a>
                        <a href="https://blog.jverkamp.com/2014/03/11/brownian-trees/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/01/17/decoding-escaped-unicode-strings/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/twitter">Twitter</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/12/21/rock-paper-scissors/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/11/29/thor-the-dark-world/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/11/30/chapter-8---and-something-else/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>This one has been sitting in my backlog for a while and its been a while since I&rsquo;ve gotten to write a programming post<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>, but now seems as good time as ever: <a href="http://programmingpraxis.com/2013/11/15/twitter-puddle/">Twitter puzzle</a></p>

<p></p>

<p>The basic idea is that you&rsquo;re going to get a series of wall heights representing a bumpy landscape. For example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (draw-puddle (make-puddle <span style="color:#f92672">&#39;</span>(<span style="color:#ae81ff">2</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">6</span>)))</code></pre></div>

<figure >
    
        <img src="/embeds/2013/initial-state.png" />
    
    
</figure>


<p>(Just ignore the water at the top, this is actually the first state of the simulation that we&rsquo;ll be writing.)</p>

<p>Once we have a world, the goal is to figure out how much water we could store in that world. In this case, any water on either side of the middle pool will fall off the sides, as will water over the left wall in the center. So the final state we&rsquo;re looking for should look something like this:</p>


<figure >
    
        <img src="/embeds/2013/final-state.png" />
    
    
</figure>


<p>So how do we get there?</p>

<p>Well, first we need some way to represent the world. I&rsquo;m going to go with a two dimensional vector of vectors. Each element will be one of the symbols <code>empty</code>, <code>wall</code>, or <code>water</code>. Something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Twitter puddle structure; 2d grid of item types (empty, wall, water)</span>
(struct puddle (data) <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable)</code></pre></div>
<p>In addition to that, we probably want a few convince functions. In this case, we&rsquo;ll write a function to turn a list of wall heights into a puddle (as seen above), accessors for the height, and a getter/setter. I&rsquo;m going to do something a bit interesting with the getter/setter. Rather than forcing the programmer to deal with boundary conditions, I&rsquo;ll just check the bounds here and return <code>#f</code> if we can&rsquo;t get/set a value.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Create a puddle from a list of wall heights</span>
(<span style="color:#66d9ef">define </span>(make-puddle wall-heights)
  (<span style="color:#66d9ef">define </span>w (length wall-heights))
  (<span style="color:#66d9ef">define </span>h (add1 (apply max wall-heights)))

  (puddle
   (for/vector ([r (in-range h)])
     (for/vector ([c (in-range w)]
                  [h (in-list wall-heights)])
       (<span style="color:#66d9ef">if </span>(&lt; r h) <span style="color:#e6db74">&#39;wall</span> <span style="color:#e6db74">&#39;empty</span>)))))

<span style="color:#75715e">; Getter/setter for puddle data</span>
(<span style="color:#66d9ef">define </span>(puddle-ref p r c)
  (with-handlers ([exn? (Î» (e) <span style="color:#66d9ef">#f</span>)])
    (vector-ref (vector-ref (puddle-data p) r) c)))

(<span style="color:#66d9ef">define </span>(puddle-set!? p r c v)
  (with-handlers ([exn? (Î» (e) <span style="color:#66d9ef">#f</span>)])
    (vector-set! (vector-ref (puddle-data p) r) c v))
  <span style="color:#66d9ef">#t</span>)

<span style="color:#75715e">; Get the size of a puddle</span>
(<span style="color:#66d9ef">define </span>(puddle-height p)
  (vector-length (puddle-data p)))

(<span style="color:#66d9ef">define </span>(puddle-width p)
  (vector-length (vector-ref (puddle-data p) <span style="color:#ae81ff">0</span>)))</code></pre></div>
<p>From here, we have two options for our simulation. Either we want to step the entire simulation (so that water falls down) or we want to add some new water. For both cases, we&rsquo;ll create a new puddle and mutate that one. That way later when we want to compare the current state to previous states, we can do so. So first, stepping:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Perform one step in puddle simulation</span>
<span style="color:#75715e">; Try moving each water these directions in order:</span>
<span style="color:#75715e">; - down, down left, down right, left, right, no move (will always succeed)</span>
(<span style="color:#66d9ef">define </span>(step p)
  <span style="color:#75715e">; Create the new puddle (if you do it in place, water teleports)</span>
  (<span style="color:#66d9ef">define </span>new-p
    (puddle (for/vector ([row (in-vector (puddle-data p))])
              (for/vector ([col (in-vector row)])
                (<span style="color:#66d9ef">case </span>col
                  [(empty water) <span style="color:#e6db74">&#39;empty</span>]
                  [(wall)        <span style="color:#e6db74">&#39;wall</span>])))))

  <span style="color:#75715e">; Update each element in turn</span>
  (for ([r (in-naturals)]
        [row (in-vector (puddle-data p))])
    (for ([c (in-naturals)]
          [col (in-vector row)])
      (let/ec break
        (when (eq? <span style="color:#e6db74">&#39;water</span> col)
          (for ([rd (in-list <span style="color:#f92672">&#39;</span>(<span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">-1</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>))]
                [cd (in-list <span style="color:#f92672">&#39;</span>( <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">-1</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">-1</span>  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>))])
            (<span style="color:#66d9ef">case </span>(puddle-ref new-p (+ r rd) (+ c cd))
              [(empty <span style="color:#66d9ef">#f</span>)
               (when (puddle-set!? new-p (+ r rd) (+ c cd) <span style="color:#e6db74">&#39;water</span>)
                 (break))]))))))

  new-p)</code></pre></div>
<p>Essentially, copy the puddle and then check down, diagonally, and finally to the sides. This will help water fill in puddles and drain off to the sides when walls aren&rsquo;t high enough. I&rsquo;m using a trick I&rsquo;ve used before with <code>let/ec</code> to basically add early returns to Racket. It&rsquo;s nice how things like that are possible.</p>

<p>Next, dripping. Essentially, we want to create new water along the top. Originally, I had this random, but to make sure that we tried each of them I changed it so optionally you can specify the column:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Add water to the top row (randomly if column is #f)</span>
(<span style="color:#66d9ef">define </span>(drip p [column <span style="color:#66d9ef">#f</span>])
  <span style="color:#75715e">; Copy the old puddle</span>
  (<span style="color:#66d9ef">define </span>new-p
    (puddle (for/vector ([row (in-vector (puddle-data p))])
              (for/vector ([col (in-vector row)])
                col))))

  <span style="color:#75715e">; Insert at a specified location or randomly</span>
  (<span style="color:#66d9ef">define </span>r (sub1 (puddle-height p)))
  (cond
    [column
     (puddle-set!? new-p r column <span style="color:#e6db74">&#39;water</span>)]
    [else
     (let/ec break
       (for ([c (in-list (shuffle (range (puddle-width p))))])
         (when (puddle-set!? new-p r c <span style="color:#e6db74">&#39;water</span>)
           (break))))])

  new-p)</code></pre></div>
<p>Cool. So what do we need to make this actually run a simulation? Well, first you could write everything manually. But that won&rsquo;t (easily) let you visualize it. Luckily, there is a perfect solution to running and visualizing a simulation: <code><a href="http://docs.racket-lang.org/search/index.html?q=2hdtp/universe">2hdtp/universe</a></code>
. Specifically, the <code><a href="http://docs.racket-lang.org/search/index.html?q=big-bang">big-bang</a></code>
 function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Run an entire simulation until steady state</span>
(<span style="color:#66d9ef">define </span>(simulate puddle)
  (<span style="color:#66d9ef">define </span>previous-states          (make-hash))
  (<span style="color:#66d9ef">define </span>(previous-state? puddle) (hash-has-key? previous-states puddle))
  (<span style="color:#66d9ef">define </span>(add-state! puddle)      (hash-set! previous-states puddle <span style="color:#66d9ef">#t</span>))

  (<span style="color:#66d9ef">define </span>potential-drips (shuffle (range (puddle-width puddle))))
  (<span style="color:#66d9ef">define </span>stop? <span style="color:#66d9ef">#f</span>)

  (big-bang puddle
    [record? <span style="color:#e6db74">&#34;output&#34;</span>]
    [stop-when (Î» (puddle) stop?)]
    [on-draw draw-puddle]
    [on-tick
     (Î» (puddle)
       (let/ec return
         <span style="color:#75715e">; We&#39;ve not seen the stepped case before, use that</span>
         (<span style="color:#66d9ef">define </span>stepped (step puddle))
         (when (<span style="color:#66d9ef">and </span>(not (equal? stepped puddle))
                    (not (previous-state? stepped)))
           (add-state! stepped)
           (return stepped))

         <span style="color:#75715e">; If we don&#39;t have any potential drips left, we&#39;ve reached steady state</span>
         <span style="color:#75715e">; Try inverting first</span>
         (when (null? potential-drips)
           (when (equal? stepped puddle)
             (printf <span style="color:#e6db74">&#34;steady state: ~a\n&#34;</span> (puddle-count puddle <span style="color:#e6db74">&#39;water</span>))
             (<span style="color:#66d9ef">set! </span>stop? <span style="color:#66d9ef">#t</span>))

           (return stepped))

         <span style="color:#75715e">; Try to drip instead, if we&#39;ve seen this drip, don&#39;t drip here again</span>
         (<span style="color:#66d9ef">define </span>dripped (drip puddle (car potential-drips)))
         (when (<span style="color:#66d9ef">or </span>(equal? dripped puddle)
                   (previous-state? dripped))
           (<span style="color:#66d9ef">set! </span>potential-drips (cdr potential-drips)))

         (return dripped)))]))</code></pre></div>
<p>There are a few other bits here, so let&rsquo;s break it down. First, we have some separate state for the simulation. We want to keep track of every state that we generate, since if we see something that we&rsquo;ve already seen before, we know that we can advance. When we get into the <code>big-bang</code>, we have four clauses of interest:</p>

<ul>
<li><code>record?</code></li>
<li><code>stop-when</code></li>
<li><code>on-draw</code></li>
<li><code>on-tick</code></li>
</ul>

<p><code>record?</code> lets us generate GIFs. I&rsquo;ll show one here in a second. <code>stop-when?</code> stops the simulation and returns the ending state. <code>on-draw</code> is the function used to turn a puddle into an image that <code>2htdp/universe</code> can use. Finally, <code>on-tick</code> is the meat of the function.</p>

<p>Within <code>on-tick</code> we have a series of checks. First, we try to step. If we can&rsquo;t, then the current water has reached a steady state. Unfortunately, we also need to check multiple previous states because it&rsquo;s easily possible for water to alternate between two states given a flat surface.</p>

<p>If both of those conditions are skipped, then we should try to drip. Here, I have a list of the columns (shuffled for appearance) that will each be tried in turn. Once that list is <code>null?</code>, we&rsquo;re probably null. Run one last time until steady state so that the water can settle and then count it up.</p>

<p>Finally, if we get this far, try to drip. We know that a state is done if dripping ends up with the same state we&rsquo;ve seen before because that means water is no longer settling and instead draining out of the world.</p>

<p>Well, that&rsquo;s that. The only thing we have left is the drawing function: Using the <code>2htdp/image</code> library, it&rsquo;s rather straight forward:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Convert a puddle into a pict</span>
(<span style="color:#66d9ef">define </span>(draw-puddle p)
  (<span style="color:#66d9ef">define </span>(make-row row)
    (apply beside
           (for/list ([col (in-vector row)])
             (rectangle
              (current-block-size) (current-block-size)
              <span style="color:#e6db74">&#34;solid&#34;</span>
              (<span style="color:#66d9ef">case </span>col
                [(empty) <span style="color:#e6db74">&#34;white&#34;</span>]
                [(wall)  <span style="color:#e6db74">&#34;black&#34;</span>]
                [(water) <span style="color:#e6db74">&#34;blue&#34;</span>])))))

  (apply above
         (reverse
          (for/list ([row (in-vector (puddle-data p))])
            (make-row row)))))</code></pre></div>
<p>And that&rsquo;s it. I did promise an animated GIF (and <code>record?</code> makes that trivial), so here it is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (parameterize ([current-block-size <span style="color:#ae81ff">25</span>])
    (simulate (make-puddle <span style="color:#f92672">&#39;</span>(<span style="color:#ae81ff">2</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">6</span>))))</code></pre></div>

<figure >
    
        <img src="/embeds/2013/solution.gif" />
    
    
</figure>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">steady state: <span style="color:#ae81ff">10</span>
(puddle
 <span style="color:#f92672">&#39;#</span>(<span style="color:#f92672">#</span>(wall wall wall wall wall wall wall wall wall)
    <span style="color:#f92672">#</span>(wall wall water wall wall wall wall wall wall)
    <span style="color:#f92672">#</span>(empty wall water water wall wall wall wall wall)
    <span style="color:#f92672">#</span>(empty wall water water water wall wall wall wall)
    <span style="color:#f92672">#</span>(empty wall water water water water wall wall wall)
    <span style="color:#f92672">#</span>(empty empty empty empty empty empty wall wall wall)
    <span style="color:#f92672">#</span>(empty empty empty empty empty empty wall wall empty)
    <span style="color:#f92672">#</span>(empty empty empty empty empty empty empty empty empty)))</code></pre></div>
<p>And there we have it. As always, if you&rsquo;d like to see the code for today&rsquo;s post, you can do so here: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/twitter-puddle.rkt">twitter-puddle</a>.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Don&rsquo;t worry, I am still intending to post more in the <a href="https://blog.jverkamp.com/2013/11/09/chapter-2---writings-in-silver/">Making music series</a>, just not today.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Twitter puddle";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2013\/11\/30\/twitter-puddle\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

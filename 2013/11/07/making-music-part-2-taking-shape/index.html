<!DOCTYPE html>
<html>
<head>
    <title>Making music, part 2: Taking shape – jverkamp.com</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Making music, part 2: Taking shape</h1>

        <div class="entry-meta"><span class="entry-date">2013-11-07</span>
            </div><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a><a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/abc-notation">ABC Notation</a><a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/audio">Audio</a><a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/lexing">Lexing</a><a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/music">Music</a><a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/parsing">Parsing</a><a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/11/06/chapter-1-the-book/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/11/09/chapter-2-writings-in-silver/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</header>

	<div class="entry-content"><p>It&rsquo;s been a bit, but as you may have noticed life is a bit mad at the moment. But I&rsquo;ve still made some progress.</p>

<p>When we left off <a href="https://blog.jverkamp.com/2013/10/29/making-music-part-1-reading-abc-notation/">last time</a>, we&rsquo;d finished the first step towards making some lovely music with Racket: <a href="https://en.wikipedia.org/wiki/tokenization">tokenization</a>. Now we want to take those songs and form them into something actually approaching music.</p>

<p>My first attempt at this was to keep every bit of information I could, making it possible to either parse music for display use or for playback. Unfortunately, it turns out that&rsquo;s kind of complicated (there&rsquo;s a lot that can go oddly with music), so I&rsquo;ve since narrowed it down to just playback. After we&rsquo;ve actually gotten something actually making noise (with the <a href="http://pkg.racket-lang.org/#[rsound]">rsound library</a> I mentioned earlier), I&rsquo;ll potentially come back to this.</p>

<p>If you&rsquo;d like to follow along, here&rsquo;s the GitHub: <a href="https://github.com/jpverkamp/abc/">jpverkamp/abc</a>.</p>

<p>Now that that is out of the way, we want a structure to convert the music into. The parser here will be doing a bit more heavy lifting than parsers sometimes do. My end goal is to make a linked list of notes. Each note will have a pitch, a duration, and the next note to play. The structs will look something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; item    : Linked list of note, chord, rest; see note below</span>
<span style="color:#75715e">; note    : Single pitch</span>
<span style="color:#75715e">; chord   : Multiple notes at once</span>
<span style="color:#75715e">; silence : Silence, blessed silence</span>

(struct item          (next length) <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable) 
(struct note     item (pitch)       <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable)
(struct chord    item (notes)       <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable)
(struct silence  item ()            <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable)</code></pre></div>
<p>This isn&rsquo;t something I&rsquo;ve ever used before, but you can make structs that inherit from one another. In this case, a <code>note?</code> is also an <code>item?</code>. You can create a new note like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(note next length pitch)</code></pre></div>
<p>Then you can use the functions <code>item-next</code>, <code>item-length</code>, and <code>note-pitch</code> to pull out the values. It&rsquo;s a nice combination all around. This way we can share the length between the three kinds of things we want to be able to play: notes, chords, and pitches.</p>

<p>In addition, we&rsquo;re going to need one additional struct:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Special item that should have length 0 that represents the start of a song</span>
<span style="color:#75715e">; This will be removed at the end of processing so the user should never see it</span>

(struct start    item ()            <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable)</code></pre></div>
<p>As the comment says, I&rsquo;m only using this because of how I&rsquo;m building the linked lists. It will be removed before the list is returned.</p>

<p>So are we ready to parse the song yet? Well, not quite. First, we need to actually make sense of a few of the items. Specifically, key and time signatures, notes, and lengths. First, key signatures. Basically, these tell use the number of sharps or flats notes will have by default:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Key signature</span>
(struct key
  (base     <span style="color:#75715e">; Base note for the key (C-B, ex: G)</span>
   type     <span style="color:#75715e">; Type of key (major, minor, etc)</span>
   sharps   <span style="color:#75715e">; List of notes that are sharp (C-B)</span>
   flats    <span style="color:#75715e">; List of flats</span>
   ) <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable)

<span style="color:#75715e">; Parse a key signature</span>
(<span style="color:#66d9ef">define </span>(parse-key text)
  (match-define (list _ note type)
    (map 
     string-&gt;symbol
     (regexp-match <span style="color:#f92672">#</span>px<span style="color:#e6db74">&#34;([A-G][#b]?)(|Maj|m|Min|Mix|Dor|Phr|Lyd|Loc)&#34;</span> text)))

  (when (eq? type <span style="color:#e6db74">&#39;||</span>) (<span style="color:#66d9ef">set! </span>type <span style="color:#e6db74">&#39;Maj</span>))
  (when (eq? type <span style="color:#e6db74">&#39;m</span>)  (<span style="color:#66d9ef">set! </span>type <span style="color:#e6db74">&#39;Min</span>))

  (define-values (num-sharps num-flats)
    (<span style="color:#66d9ef">case </span>(string-&gt;symbol (format <span style="color:#e6db74">&#34;~a~a&#34;</span> note type))
      [(C<span style="color:#f92672">#</span>Maj, AMin, G<span style="color:#f92672">#</span>Mix, D<span style="color:#f92672">#</span>Dor, E<span style="color:#f92672">#</span>Phr, F<span style="color:#f92672">#</span>Lyd, B<span style="color:#f92672">#</span>Loc) (values <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">0</span>)]
      [(F<span style="color:#f92672">#</span>Maj, DMin, C<span style="color:#f92672">#</span>Mix, G<span style="color:#f92672">#</span>Dor, A<span style="color:#f92672">#</span>Phr, BLyd, E<span style="color:#f92672">#</span>Loc)  (values <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">0</span>)]
      [(BMaj, GMin, F<span style="color:#f92672">#</span>Mix, C<span style="color:#f92672">#</span>Dor, D<span style="color:#f92672">#</span>Phr, ELyd, A<span style="color:#f92672">#</span>Loc)   (values <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">0</span>)]
      [(EMaj, CMin, BMix, F<span style="color:#f92672">#</span>Dor, G<span style="color:#f92672">#</span>Phr, ALyd, D<span style="color:#f92672">#</span>Loc)    (values <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">0</span>)]
      [(AMaj, FMin, EMix, BDor, C<span style="color:#f92672">#</span>Phr, DLyd, G<span style="color:#f92672">#</span>Loc)     (values <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span>)]
      [(DMaj, Min, AMix, EDor, F<span style="color:#f92672">#</span>Phr, GLyd, C<span style="color:#f92672">#</span>Loc)      (values <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>)]
      [(GMaj, Min, DMix, ADor, BPhr, CLyd, F<span style="color:#f92672">#</span>Loc)       (values <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>)]
      [(CMaj, Min, GMix, DDor, EPhr, FLyd, BLoc)        (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>)]
      [(FMaj, Min, CMix, GDor, APhr, BbLyd, ELoc)       (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span>)]
      [(BbMaj, Min, FMix, CDor, DPhr, EbLyd, ALoc)      (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">2</span>)]
      [(EbMaj, Min, BbMix, FDor, GPhr, AbLyd, DLoc)     (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">3</span>)]
      [(AbMaj, Min, EbMix, BbDor, CPhr, DbLyd, GLoc)    (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">4</span>)]
      [(DbMaj, BMin, AbMix, EbDor, FPhr, GbLyd, CLoc)   (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">5</span>)]
      [(GbMaj, EMin, DbMix, AbDor, BbPhr, CbLyd, FLoc)  (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">6</span>)]
      [(CbMaj, AMin, GbMix, DbDor, EbPhr, FbLyd, BbLoc) (values <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">7</span>)]))

  (key note 
       type 
       (take <span style="color:#f92672">&#39;</span>(F C G D A E B) num-sharps)
       (take <span style="color:#f92672">&#39;</span>(B E A D G C F) num-flats)))</code></pre></div>
<p>It&rsquo;s mostly only confusing because I went ahead and supported some of the more esoteric keys (such as <a href="https://en.wikipedia.org/wiki/Dorian%20mode">Dorian</a> and <a href="https://en.wikipedia.org/wiki/Lydian%20mode">Lydian</a> mode). The important part is that any valid combination with up to either seven sharps or flats can be returned.</p>

<p>Next, we have the meter. This will normally be a fraction representing the number of beats per measure and how large a beat is. The only exception is that non-specified meters and <code>C</code> mean common time (<sup>4</sup>&frasl;<sub>4</sub>) and <code>C|</code> means cut time (<sup>2</sup>&frasl;<sub>2</sub>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Meter / time signature</span>
(struct meter
  (beats    <span style="color:#75715e">; How many notes are in a measure</span>
   <span style="color:#ae81ff">1</span>-beat   <span style="color:#75715e">; Which note is a beat (4 = quarter, so 1/n)</span>
   ) <span style="color:#f92672">#</span>:transparent <span style="color:#f92672">#</span>:mutable)

<span style="color:#75715e">; Parse a meter definition</span>
(<span style="color:#66d9ef">define </span>(parse-meter text)
  (cond
    [(equal? text <span style="color:#e6db74">&#34;none&#34;</span>) (meter <span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span>)]
    [(equal? text <span style="color:#e6db74">&#34;C&#34;</span>)    (meter <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">4</span>)]
    [(equal? text <span style="color:#e6db74">&#34;C|&#34;</span>)   (meter <span style="color:#e6db74">&#34;C|&#34;</span>)]
    [else
     (apply meter (map string-&gt;number (string-split text <span style="color:#e6db74">&#34;/&#34;</span>)))]))</code></pre></div>
<p>After that, the next two header fields are trivial to parse. The tempo (<code>Q:</code>) represents beats per minute and is just a number. Likewise, the default note length (<code>L:</code>) is a fraction representing the length to use on any notes without a specified duration and as a multiplier for those that do. For either case though, we can just trust Racket to parse the values for us:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Parse tempo information</span>
(<span style="color:#66d9ef">define </span>(parse-tempo text)
  (string-&gt;number text))

<span style="color:#75715e">; Parse length header information</span>
(<span style="color:#66d9ef">define </span>(parse-length text)
  (string-&gt;number text))</code></pre></div>
<p>The next two things to parse are the note pitches and the note/rest durations. First, the pitches. As I&rsquo;ve mentioned in the previous post, a pitch is made up of three parts where the first and third are optional:</p>

<ul>
<li>accidental (optional) - sharps, flats, and naturals (^ / ^^ / _ / __ / =)</li>
<li>pitch - a lower case or upper case letter, A-G (upper case is the higher of two octaves</li>
<li>octave - an octave offset, apostrophes for higher octaves and commas for lower</li>
</ul>

<p>The parser here is a little more complicated (and thus error prone), but still relatively straight forward:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Parse a note, taking into account the current key</span>
(<span style="color:#66d9ef">define </span>(parse-pitch text)
  (match-define (list _ accidental note octave)
    (regexp-match <span style="color:#f92672">#</span>px<span style="color:#e6db74">&#34;(^|^^|_|__|=)([A-Ga-g])([&#39;,]*)&#34;</span> text))

  (<span style="color:#66d9ef">define </span>accidental-w/key
    (<span style="color:#66d9ef">or </span>accidental
        (<span style="color:#66d9ef">let </span>([note-name (string-&gt;symbol (string-upcase note))])
          (cond
            [(member note-name (key-sharps (current-key))) <span style="color:#e6db74">&#34;^&#34;</span>]
            [(member note-name (key-flats  (current-key))) <span style="color:#e6db74">&#34;_&#34;</span>]
            [<span style="color:#66d9ef">else </span>                                         <span style="color:#e6db74">&#34;&#34;</span>]))))

  (<span style="color:#66d9ef">define </span>octave-offset
    (for/sum ([c (in-string octave)])
      (<span style="color:#66d9ef">if </span>(eq? c <span style="color:#e6db74">#\&#39;</span>) <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">-1</span>)))

  (+ <span style="color:#ae81ff">49</span>
     (<span style="color:#66d9ef">case </span>(string-&gt;symbol accidental-w/key)
       [(|| |=|) <span style="color:#ae81ff">0</span>] [(^) <span style="color:#ae81ff">1</span>] [(^^) <span style="color:#ae81ff">2</span>] [(_) <span style="color:#ae81ff">-1</span>] [(__) <span style="color:#ae81ff">-2</span>])
     (<span style="color:#66d9ef">case </span>(string-&gt;symbol note)
       [(c) <span style="color:#ae81ff">-21</span>] [(d) <span style="color:#ae81ff">-19</span>] [(e) <span style="color:#ae81ff">-17</span>] [(f) <span style="color:#ae81ff">-16</span>] [(g) <span style="color:#ae81ff">-14</span>] [(a) <span style="color:#ae81ff">-12</span>] [(b) <span style="color:#ae81ff">-10</span>]
       [(C) <span style="color:#ae81ff">-9</span>]  [(D) <span style="color:#ae81ff">-7</span>]  [(E) <span style="color:#ae81ff">-5</span>]  [(F) <span style="color:#ae81ff">-4</span>]  [(G) <span style="color:#ae81ff">-2</span>]  [(A) <span style="color:#ae81ff">0</span>]   [(B) <span style="color:#ae81ff">2</span>])
     (* <span style="color:#ae81ff">12</span> octave-offset)))</code></pre></div>
<p>Finally, we have the note duration. This can follow a note or rest to use any duration other than the default. These are fractions with optional numbers. If the numbers aren&rsquo;t specified, a single slash (/) is equivalent to <sup>1</sup>&frasl;<sub>2</sub> and two slashes are a quarter: <sup>1</sup>&frasl;<sub>4</sub>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Parse a duration, taking into account the current note length and tempo</span>
(<span style="color:#66d9ef">define </span>(parse-duration text)
  (match-define (list _ numer slashes denom)
    (regexp-match <span style="color:#f92672">#</span>px<span style="color:#e6db74">&#34;(\\d*)(/*)(\\d*)&#34;</span> text))

  (* (cond
       [(<span style="color:#66d9ef">and </span>(equal? <span style="color:#e6db74">&#34;&#34;</span> numer) (equal? <span style="color:#e6db74">&#34;&#34;</span> denom))
        (/ <span style="color:#ae81ff">1</span> (* <span style="color:#ae81ff">2</span> (string-length slashes)))]
       [else
        (/ (<span style="color:#66d9ef">or </span>(<span style="color:#66d9ef">and </span>numer (string-&gt;number numer)) <span style="color:#ae81ff">1</span>)
           (<span style="color:#66d9ef">or </span>(<span style="color:#66d9ef">and </span>denom (string-&gt;number denom)) <span style="color:#ae81ff">1</span>))])
     (current-length)))</code></pre></div>
<p>Okay, finally we&rsquo;re into the parsing. The function is a little long, but parsers tend to do that. First we want to set up a series of parameters. This sort of dynamic scoping (where variables will sometimes change but not always) is exactly what parameters were designed for.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Current parser state</span>
(<span style="color:#66d9ef">define </span>current-key    (make-parameter <span style="color:#66d9ef">#f</span>))
(<span style="color:#66d9ef">define </span>current-length (make-parameter <span style="color:#66d9ef">#f</span>))
(<span style="color:#66d9ef">define </span>current-tempo  (make-parameter <span style="color:#66d9ef">#f</span>))
(<span style="color:#66d9ef">define </span>current-repeat (make-parameter <span style="color:#66d9ef">#f</span>))
(<span style="color:#66d9ef">define </span>current-item   (make-parameter <span style="color:#66d9ef">#f</span>))</code></pre></div>
<p>Within the actual function, we&rsquo;ll start by setting these to a sensible value. This is to help clean up if we happen to run more than one song at a time:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Parse a song into a linked list of notes/chords/rests (see above)</span>
(<span style="color:#66d9ef">define </span>(abc-parse/playback tokens)
  <span style="color:#75715e">; Reset parameters for this song</span>
  (current-key    (parse-key    <span style="color:#e6db74">&#34;CMaj&#34;</span>))
  (current-length (parse-length <span style="color:#e6db74">&#34;1/8&#34;</span>))
  (current-tempo  (parse-tempo  <span style="color:#e6db74">&#34;120&#34;</span>))
  (current-repeat <span style="color:#66d9ef">#f</span>)
  (current-item   <span style="color:#66d9ef">#f</span>)

  <span style="color:#f92672">...</span></code></pre></div>
<p>After that, we&rsquo;re going to create that special start token I talked about before. This is because we&rsquo;re going to keep the current (technically previous) token around and we need an initial value:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#f92672">...</span>
  <span style="color:#75715e">; Special token at the start makes the world go round, remove this later</span>
  (<span style="color:#66d9ef">define </span>*start* (start <span style="color:#66d9ef">#f</span> <span style="color:#ae81ff">0</span>))
  (current-repeat *start*)
  (current-item *start*)
  <span style="color:#f92672">...</span></code></pre></div>
<p>Now, we&rsquo;ll read across the song body. Headers can appear either at the beginning of the song or inline, but there&rsquo;s really no difference between the two cases. The comments should be relatively straight forward (I hope):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#f92672">...</span>
  <span style="color:#75715e">; Read the song body</span>
  (<span style="color:#66d9ef">let </span>loop ([tokens tokens])
    (match tokens
      <span style="color:#75715e">; Ran out of tokens, force the end of the song</span>
      <span style="color:#75715e">; Return the first token (which is the &#39;next&#39; of the special start token)</span>
      [(list)
       (item-next *start*)]
      <span style="color:#75715e">; Deal with headers (inline or not)</span>
      [(list-rest (header text) tokens)
         (match-define (list _ key val)
           (regexp-match <span style="color:#f92672">#</span>px<span style="color:#e6db74">&#34;([A-Z])\\s*\\:\\s*([^\n]*)\n?&#34;</span> text))

         (<span style="color:#66d9ef">case </span>(string-&gt;symbol key)
           [(K) (current-key    (parse-key val))]
           [(L) (current-length (parse-length val))]
           [(Q) (current-tempo  (parse-tempo val))])

         (loop tokens)]
      <span style="color:#75715e">; Ignore bars</span>
      [(list-rest (<span style="color:#66d9ef">or </span><span style="color:#e6db74">&#39;bar</span> <span style="color:#e6db74">&#39;double-bar</span> <span style="color:#e6db74">&#39;double-bar-start</span> <span style="color:#e6db74">&#39;double-bar-end</span>) tokens)
       (loop tokens)]
      <span style="color:#75715e">; Remember the current item as the start of a repeat block</span>
      [(list-rest <span style="color:#e6db74">&#39;repeat-start</span> tokens)
       (current-repeat (current-item))
       (loop tokens)]
      <span style="color:#75715e">; Add the start of the repeat block to the current item&#39;s nexts</span>
      <span style="color:#75715e">; Note:The current item is the previous, so use the next</span>
      <span style="color:#75715e">; The actual next item will get added as the second option</span>
      [(list-rest <span style="color:#e6db74">&#39;repeat-end</span> tokens)
       (add-next-to-current-item! (item-next (current-repeat)))
       (loop tokens)]
      <span style="color:#75715e">; Start/end repeat pairings do both</span>
      [(list-rest <span style="color:#e6db74">&#39;repeat-end-start</span> tokens)
       (add-next-to-current-item! (item-next (current-repeat)))
       (current-repeat (current-item))
       (loop tokens)]
      <span style="color:#75715e">; Notes with a set duration</span>
      [(list-rest (pitch p) (duration d) tokens)
       (next-item-is! (note <span style="color:#66d9ef">#f</span> (parse-duration d) (parse-pitch p)))
       (loop tokens)]
      <span style="color:#75715e">; Notes without a duration</span>
      [(list-rest (pitch p) tokens)
       (next-item-is! (note <span style="color:#66d9ef">#f</span> (parse-duration <span style="color:#e6db74">&#34;1&#34;</span>) (parse-pitch p)))
       (loop tokens)]
      <span style="color:#75715e">; Rests with a set duration</span>
      [(list-rest <span style="color:#e6db74">&#39;rest</span> (duration d) tokens)
       (next-item-is! (silence <span style="color:#66d9ef">#f</span> (parse-duration d)))
       (loop tokens)]
      <span style="color:#75715e">; Rests with standard duration</span>
      [(list-rest <span style="color:#e6db74">&#39;rest</span> tokens)
       (next-item-is! (silence <span style="color:#66d9ef">#f</span> (parse-duration <span style="color:#e6db74">&#34;1&#34;</span>)))
       (loop tokens)])))</code></pre></div>
<p>In most of the cases, we use the function <code>next-item-is!</code> to add the newly created item as <code>item-next</code> to the <code>(current-item)</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Add the new item to the current (see above) and update current item</span>
(<span style="color:#66d9ef">define </span>(next-item-is! new-next)
  (add-next-to-current-item! new-next)
  (current-item new-next))</code></pre></div>
<p>Adding the current item has a bunch of special cases because there are three different values that next can take:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Append a given item to the current item&#39;s next value</span>
<span style="color:#75715e">; If it was #f, this item is a singletone</span>
<span style="color:#75715e">; If it was a single item, make it a list and add to the end</span>
<span style="color:#75715e">; If it was a list, add it to the end</span>
<span style="color:#75715e">; (If the current item is #f, this function does nothing)</span>
(<span style="color:#66d9ef">define </span>(add-next-to-current-item! new-next)
  (when (current-item)
    (cond
      [(list? (item-next (current-item)))
       (set-item-next! (current-item) (snoc (item-next (current-item)) new-next))]
      [(item-next (current-item))
       (set-item-next! (current-item) (list (item-next (current-item)) new-next))]
      [else
       (set-item-next! (current-item) new-next)])))</code></pre></div>
<p>And that&rsquo;s really all there is to it. We already can parse relatively complicated songs. Here&rsquo;s a simple example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (require <span style="color:#e6db74">&#34;tokenizer.rkt&#34;</span>)
&gt; (abc-parse/playback
    (call-with-input-string
        <span style="color:#e6db74">&#34;|abcd|:g2g/g/:|zcba||&#34;</span>
      abc-lex))

(note
 (note
  (note
   (note
    <span style="color:#f92672">#</span><span style="color:#ae81ff">0</span>=(note
        (note (note (list <span style="color:#f92672">#</span><span style="color:#ae81ff">0</span><span style="color:#f92672">#</span> (silence (note 
                                        (note 
                                         (note <span style="color:#66d9ef">#f</span> <span style="color:#ae81ff">1</span>/8 <span style="color:#ae81ff">37</span>) 
                                         <span style="color:#ae81ff">1</span>/8 <span style="color:#ae81ff">39</span>) 
                                        <span style="color:#ae81ff">1</span>/8 <span style="color:#ae81ff">28</span>) 
                                       <span style="color:#ae81ff">1</span>/8)) 
                    <span style="color:#ae81ff">1</span>/16 <span style="color:#ae81ff">35</span>) 
              <span style="color:#ae81ff">1</span>/16 <span style="color:#ae81ff">35</span>)
        <span style="color:#ae81ff">1</span>/4 <span style="color:#ae81ff">35</span>)
    <span style="color:#ae81ff">1</span>/8 <span style="color:#ae81ff">30</span>)
   <span style="color:#ae81ff">1</span>/8 <span style="color:#ae81ff">28</span>)
  <span style="color:#ae81ff">1</span>/8 <span style="color:#ae81ff">39</span>)
 <span style="color:#ae81ff">1</span>/8 <span style="color:#ae81ff">37</span>)</code></pre></div>
<p>That looks a bit strange, but basically it means that it&rsquo;s a nested structure (the linked list we were trying to make) with an infinite recursive structure (the <code>#0=</code> defines a reference and <code>#0#</code> means that the reference goes there). This is how we&rsquo;re dealing with repeats. When we get to the playback, each time you see a list in a repeat, remove one from it. That way you&rsquo;ll go back to <code>#0=</code> the first time, but continue playing the second time.</p>

<p>It&rsquo;s a bit dense right now, but next time it will all become clearer (since we&rsquo;ll have actual sounds!). Theoretically, it shouldn&rsquo;t take as long since I&rsquo;ve already written probably 90% of the playback code. Unfortunately, there&rsquo;s a saying in Computer Science&ndash;probably others as well&ndash;that when you&rsquo;re 90% of the way done, you still have more than half the work to go. So it goes.</p>

<p>As always, I&rsquo;ve uploaded my code to GitHub: <a href="https://github.com/jpverkamp/abc/">jpverkamp/abc</a>. Feel free to offer comments / suggestions, I always love to have them.</p></div>
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Making music, part 2: Taking shape";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2013\/11\/07\/making-music-part-2-taking-shape\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div></article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>
</body>
</html>

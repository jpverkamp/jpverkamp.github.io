<!doctype html><html><head><title>Adventures in Racket: gzip â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.82ab51144325fae71ddbca46269a80c63b28bdab6be6b01aa9ec638c013748e6.js integrity="sha256-gqtRFEMl+ucd28pGJpqAxjsovatr5rAaqexjjAE3SOY=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="><link rel=stylesheet href=/main.min.5cb1123af6f7b30230b5393c75ce8864dee1f2dcd12b5c4d5cfc0bf351a34476.css integrity="sha256-XLESOvb3swIwtTk8dc6IZN7h8tzRK1xNXPwL81GjRHY="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Adventures in Racket: gzip</h1><div class=entry-meta><span class=entry-date>2013-08-06</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/08/06/authorship-attribution-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/08/21/a-tiny-virtual-machine-in-racket/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/08/06/authorship-attribution-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2013/08/21/a-tiny-virtual-machine-in-racket/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a class=taxonomy-value href=/programming/topics/compression>Compression</a><a href=https://blog.jverkamp.com/2016/12/09/aoc-2016-day-9-decompressinator/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/gzip>Gzip</a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/08/06/authorship-attribution-part-3/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/08/21/a-tiny-virtual-machine-in-racket/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/08/06/authorship-attribution-part-3/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/08/13/usenix/foci-2013-five-incidents-one-theme-twitter-spam-as-a-weapon-to-drown-voices-of-protest/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>In my research, I work with a lot of rather large text files&ndash;on the order of gigabytes if not terabytes per file. Since they&rsquo;re plain text, they&rsquo;re generally rather compressible though, so it makes sense to <code>gzip</code> them while they&rsquo;re on disk. The drawback though comes when you&rsquo;re working with them. There are a few options though.</p><p>First, you could <code>gunzip</code> the files before use and <code>gzip</code> them again when you&rsquo;re done:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gunzip data.txt.gz
</span></span><span style=display:flex><span>analyze data.txt
</span></span><span style=display:flex><span>gzip -9 data.txt
</span></span></code></pre></div><p>It&rsquo;s simple, it&rsquo;s straight forward, but it requires a heck of a lot more disk space. Even if you only do one file at a time, you still need to have at least enough to deal with the files. In addition, if you could possibly bail out early when dealing with the file, you can&rsquo;t here. You&rsquo;ll have to decompress the entire file, then re-compress it in turn.</p><p>The next option would be to use your Unix-fu:<code>gunzip</code> it into a pipe then directly into the program, something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gunzip -c data.txt.gz &gt; analyze
</span></span></code></pre></div><p>It has the same advantages of the previous form in that it&rsquo;s easy to deal with, but we lose a bit of flexibility. For example, what if we want to process more than one file?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gunzip -c data.*.txt.gz &gt; analyze
</span></span></code></pre></div><p>This works, but we lose the delineation between files. If that&rsquo;s important, this is a no go. Also, we still have to decode the entire file.</p><p>Okay, so what about to do it directly in the script? Traditionally, I write a lot of scripts in Python. It&rsquo;s quick and generally painless to write and I know the language particularly well. If I wanted to process gzipped files, all I would need is something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> gzip
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> gzip<span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#39;data.txt.gz&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> fin:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> fin:
</span></span><span style=display:flex><span>         print(line)
</span></span></code></pre></div><p>Quick and easy. In addition, <code>gzip.open</code> returns a file-like object that&rsquo;s only read as we need it. That way, we can only have (roughly) one line in memory at a time. That&rsquo;s exactly what I want when dealing with large files.</p><p>More recently though though, I&rsquo;ve been writing a lot of scripts in Racket. For slightly more in depth scripts, it has a lot going for it. Racket is<code><a href="http://docs.racket-lang.org/search/index.html?q=batteries%20included">batteries included</a></code>
, nicely functional<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, and can be much more parallelized to multi-core machines without running into Python&rsquo;s pesky <a href=https://en.wikipedia.org/wiki/Global%20Interpreter%20Lock>Global Interpreter Lock</a><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>So how can we write the same code in Racket?</p><p>Unfortunately, it&rsquo;s not quite as easy. There is<code><a href="http://docs.racket-lang.org/search/index.html?q=file/unzip">file/unzip</a></code>
module, but it doesn&rsquo;t really have a nice <code>with-input-from-gzipped-file</code> or <code>with-gunzip</code> function. The closest thing we have appears to be <code>gunzip-through-ports</code>. It takes two ports,<code>in</code> and <code>out</code>, reading gzipped data from<code>in</code>and writing decompressed data to <code>out</code>. But how do we make use of that?</p><p>It took me a while to find what I was looking for, but finally I came across<code><a href="http://docs.racket-lang.org/search/index.html?q=pipes">pipes</a></code>
. They&rsquo;re essentially equivalent to Unix-like pipes<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>, forming a sort of bridge between two streams. So theoretically, we can open the file, use <code>gunzip-through-ports</code> to attach it to the pipe, and then read from the other end. Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>with-gunzip</span> thunk)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>pipe-from</span> pipe-to) (<span style=color:#a6e22e>make-pipe</span>))
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>gunzip-through-ports</span> (<span style=color:#a6e22e>current-input-port</span>) pipe-to)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>parameterize</span> ([current-input-port pipe-from])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>thunk</span>))
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>thunk</span>))
</span></span></code></pre></div><p>Parameterize will allow us to redirect the <code>current-input-port</code> and automatically set it back when we&rsquo;re done, even if we bail out with an error.</p><p>To use it, we would write code like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(with-input-from-file <span style=color:#e6db74>&#34;data.txt.gz&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>with-gunzip</span>
</span></span><span style=display:flex><span>      (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>for</span> ([i (<span style=color:#a6e22e>in-naturals</span>)]
</span></span><span style=display:flex><span>              [line (<span style=color:#a6e22e>in-lines</span>)])
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;line ~a: ~a\n&#34;</span> i line))))))
</span></span></code></pre></div><p>It actually works pretty well, but unfortunately it doesn&rsquo;t work entirely. There are at least three issues that we&rsquo;re going to want to deal with:</p><ul><li>It doesn&rsquo;t terminate; once the file has been read it hangs in <code>in-lines</code></li><li>It doesn&rsquo;t close the ports; if you try to use the same file, you&rsquo;ll get an error</li><li>There&rsquo;s no error handling; ugly things happen if you pass it a non-gzipped stream for example</li><li>There&rsquo;s no buffering; the entire file is gunzipped in memory (if possible)</li></ul><p>Let&rsquo;s take each one in order.</p><p>First, we have termination. Based on <a href=http://lists.racket-lang.org/users/archive/2013-August/058852.html>a response from Ryan Culpepper</a> on the Racket mailing list, the problem is that <code>gunzip-through-ports</code> doesn&rsquo;t actually close the port. This means that an <code>eof-object?</code> is never sent through the <code>pipe</code> to <code>in-lines</code>.</p><p>So at some point we need to close the port. The problem is: when? If we close it at the end as one might expect, it won&rsquo;t work. Since the code hangs in the <code>for</code>, we&rsquo;ll never get to it. So we have to have it before that at least. Let&rsquo;s true putting it right after the <code>gunzip-through-ports</code> line<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>with-gunzip</span> thunk)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>pipe-from</span> pipe-to) (<span style=color:#a6e22e>make-pipe</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>gunzip-through-ports</span> (<span style=color:#a6e22e>current-input-port</span>) pipe-to)
</span></span><span style=display:flex><span>  (close-output-port pipe-to)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>parameterize</span> ([current-input-port pipe-from])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>thunk</span>))
</span></span><span style=display:flex><span>  (close-input-port pipe-from))
</span></span></code></pre></div><p>It turns out, this actually works perfectly. It was counter intuitive to me at first, but then I ran some timing tests. It turns out that the <code>pipe</code> and <code>gunzip-through-ports</code> aren&rsquo;t actually buffering anything. On the latter call, everything that was on <code>current-input-port</code> is gunzipped and written through <code>pipe-to</code> to <code>pipe-from</code>. So we can go ahead and close <code>pipe-to</code> right then. Better yet, we&rsquo;ve actually finished the second point as well. Everything should now be closed by the time <code>with-gunzip</code> exits.</p><p>This leads us directly to the third problem though. What do we do if we have an error? Since control bails out, the ports will never be closed. Let&rsquo;s check out Racket&rsquo;s <code><a href="http://docs.racket-lang.org/search/index.html?q=exception%20model">exception model</a></code>
.</p><p>Theoretically, we&rsquo;re looking for <code>with-handlers</code> looking specifically for a <code>exn:fail?</code> condition (the one raised internally by <code>error</code>). Something like this should do what we need:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>with-gunzip</span> thunk)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>pipe-from</span> pipe-to) (<span style=color:#a6e22e>make-pipe</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>with-handlers</span> ([exn:fail?
</span></span><span style=display:flex><span>                   (<span style=color:#960050;background-color:#1e0010>Î»</span> (<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                     (close-output-port pipe-to)
</span></span><span style=display:flex><span>                     (close-input-port pipe-from)
</span></span><span style=display:flex><span>                     (<span style=color:#a6e22e>raise</span> err))])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>gunzip-through-ports</span> (<span style=color:#a6e22e>current-input-port</span>) pipe-to)
</span></span><span style=display:flex><span>    (close-output-port pipe-to)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>parameterize</span> ([current-input-port pipe-from])
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>thunk</span>))
</span></span><span style=display:flex><span>    (close-input-port pipe-from)))
</span></span></code></pre></div><p><del>This way, we close the two ports and then pass along the error. Originally, I just used <code>(raise err)</code>, but that revealed the guts of my function. I don&rsquo;t mind if people go looking, but I don&rsquo;t want that to be necessary. Using <code>exn-message</code> allows us to pass along the message but not the original error. So if we try do do this:</del></p><p><strong>Edit 6 Aug 13:</strong>: Based on <a href=http://lists.racket-lang.org/users/archive/2013-August/058858.html>this message from Robby Findler</a>, <code>raise</code> is the better option since it will preserve the stack trace into the code I&rsquo;m using. Plus it&rsquo;s cleaner. Mostly, I got confused when originally using <code>raise</code> since the error didn&rsquo;t appear to be caught (since of course I was re-raising the original).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(with-input-from-file <span style=color:#e6db74>&#34;not-gzipped.txt&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>with-gunzip</span>
</span></span><span style=display:flex><span>      (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>))))
</span></span></code></pre></div><p>We&rsquo;ll get this error:</p><pre tabindex=0><code>&lt;span style=&#34;color: red;&#34;&gt;with-gunzip: gnu-unzip: bad header&lt;/span&gt;
</code></pre><p>It looks a bit strange with the nested colons, but it gives us exactly what we want. Better yet, the ports are correctly being closed.</p><p>All that leaves us is buffering. Originally, my biggest problem with this code was that it read the entire file into memory at once. With files in the tens of gigabytes, that could be a problem&mldr; So how do we fix it? <a href=http://lists.racket-lang.org/users/archive/2013-August/058852.html>Mailing list</a> to the rescue once again! Essentially, I missed an optional argument to <code>make-pipe</code>. If you pass <code>#f</code> (the default), there&rsquo;s no buffer. But instead, you can pass an <code>exact-positive-integer?</code> which will be the buffer size in bytes.</p><p>We don&rsquo;t necessary want to assume that the user either wants buffering or wants a certain size, so we&rsquo;ll make it configurable. Quick and easy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>with-gunzip</span> thunk <span style=color:#f92672>#</span>:buffer-size [buffer-size <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>pipe-from</span> pipe-to) (<span style=color:#a6e22e>make-pipe</span> buffer-size))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>with-handlers</span> ([exn:fail?
</span></span><span style=display:flex><span>                   (<span style=color:#960050;background-color:#1e0010>Î»</span> (<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                     (close-output-port pipe-to)
</span></span><span style=display:flex><span>                     (close-input-port pipe-from)
</span></span><span style=display:flex><span>                     (<span style=color:#a6e22e>raise</span> err))])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>gunzip-through-ports</span> (<span style=color:#a6e22e>current-input-port</span>) pipe-to)
</span></span><span style=display:flex><span>    (close-output-port pipe-to)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>parameterize</span> ([current-input-port pipe-from])
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>thunk</span>))
</span></span><span style=display:flex><span>    (close-input-port pipe-from)))
</span></span></code></pre></div><p>It&rsquo;s starting to get a bit more complicated, but it works great. If we want a buffer of 1 megabyte:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(with-input-from-file <span style=color:#e6db74>&#34;data.txt.gz&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>with-gunzip</span>
</span></span><span style=display:flex><span>      (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>for</span> ([i (<span style=color:#a6e22e>in-naturals</span>)]
</span></span><span style=display:flex><span>              [line (<span style=color:#a6e22e>in-lines</span>)])
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;line ~a: ~a\n&#34;</span> i line)))
</span></span><span style=display:flex><span>      <span style=color:#f92672>#</span>:buffer-size (* <span style=color:#ae81ff>1024</span> <span style=color:#ae81ff>1024</span>))))
</span></span></code></pre></div><p>There is one problem though, the user can pass absolutely anything to <code>#:buffer-size</code>. Let&rsquo;s use a Racket feature I probably don&rsquo;t take as much advantage of as I probably should: <code><a href="http://docs.racket-lang.org/search/index.html?q=contracts">contracts</a></code>
. Essentially, they work like <a href=https://en.wikipedia.org/wiki/Type%20signature>type signatures</a>. It looks a little ugly, but they&rsquo;re fairly easy to work with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>provide/contract</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>with-gunzip</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>-&gt;*</span> ((<span style=color:#a6e22e>-&gt;</span> any))
</span></span><span style=display:flex><span>        (<span style=color:#f92672>#</span>:buffer-size (<span style=color:#a6e22e>or/c</span> false? exact-positive-integer?))
</span></span><span style=display:flex><span>        any)))
</span></span></code></pre></div><p>Breaking this apart, we have a function (<code>->*</code>, the <code>*</code> signifies optional parameters) which tasks a required thunk&ndash;<code>(-> any)</code>, required because it&rsquo;s in the first list&ndash;and an optional (because it&rsquo;s in the second list) keyword (<code>#:...</code>) parameter that&rsquo;s either <code>false?</code> or the same <code>exact-positive-integer?</code> that <code>make-pipe</code> is expecting>. After all that, we&rsquo;ll return some generic data value (<code>any</code>). This way, we can&rsquo;t do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>with-gunzip</span> (<span style=color:#960050;background-color:#1e0010>Î»</span> () (<span style=color:#a6e22e>read</span>)) <span style=color:#f92672>#</span>:buffer-size <span style=color:#e6db74>&#39;frog</span>)
</span></span></code></pre></div><pre tabindex=0><code>&lt;span style=&#34;color: red;&#34;&gt;with-gunzip: contract violation
  expected: (or/c false? exact-positive-integer?)
  given: &#39;frog&lt;/span&gt;
</code></pre><p>Exactly what we wanted!</p><p>Well, that&rsquo;s almost it. One thing we can still do is write a parallel <code>with-gzip</code> function. We&rsquo;ll use <code>#f</code> to ignore the filename and the current system time for timestamp (since gzipped files require those), but other than that, everything is pretty much exactly the same:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>provide/contract</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>with-gzip</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>-&gt;</span> (<span style=color:#a6e22e>-&gt;</span> any) <span style=color:#f92672>#</span>:buffer-size [or/c false? exact-positive-integer?] any)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>with-gzip</span> thunk <span style=color:#f92672>#</span>:buffer-size [buffer-size <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>pipe-from</span> pipe-to) (<span style=color:#a6e22e>make-pipe</span> buffer-size))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>with-handlers</span> ([exn:fail?
</span></span><span style=display:flex><span>                   (<span style=color:#960050;background-color:#1e0010>Î»</span> (<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                     (close-output-port pipe-to)
</span></span><span style=display:flex><span>                     (close-input-port pipe-from)
</span></span><span style=display:flex><span>                     (<span style=color:#a6e22e>raise</span> err))])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>gzip-through-ports</span> (<span style=color:#a6e22e>current-input-port</span>) pipe-to <span style=color:#66d9ef>#f</span> (<span style=color:#a6e22e>current-seconds</span>))
</span></span><span style=display:flex><span>    (close-output-port pipe-to)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>parameterize</span> ([current-input-port pipe-from])
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>thunk</span>))
</span></span><span style=display:flex><span>    (close-input-port pipe-from)))
</span></span></code></pre></div><p>We can test it by using both in sequence:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>input <span style=color:#e6db74>&#34;This is a test: The duck quacks at midnight...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;input: ~s\n&#34;</span> input)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>gzipped
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>with-output-to-bytes</span>
</span></span><span style=display:flex><span>   (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>with-input-from-string</span> input
</span></span><span style=display:flex><span>      (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>with-gzip</span>
</span></span><span style=display:flex><span>         (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>           (display (<span style=color:#a6e22e>port-&gt;bytes</span> (<span style=color:#a6e22e>current-input-port</span>))))))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;gzipped: ~s\n&#34;</span> gzipped)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>gunzipped
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>with-output-to-string</span>
</span></span><span style=display:flex><span>   (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>with-input-from-bytes</span> gzipped
</span></span><span style=display:flex><span>      (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>with-gunzip</span>
</span></span><span style=display:flex><span>         (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>           (display (<span style=color:#a6e22e>port-&gt;string</span> (<span style=color:#a6e22e>current-input-port</span>))))))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;gunzipped: ~s\n&#34;</span> gunzipped)
</span></span></code></pre></div><p>The test is a but contrived and the nested thunks are a bit ugly, but it works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>input: &#34;This is a test: The duck quacks at midnight...&#34;
</span></span><span style=display:flex><span>gzipped: #&#34;\37\213\b\0\336u\0R\0\3\v\311\310,V\0\242D\205\222\324\342\22+\205\220\214T\205\224\322\344l\205\302\322\304\344l\240x\211BnfJ^fzF\211\236\236\36\0G7\244\232.\0\0\0&#34;
</span></span><span style=display:flex><span>gunzipped: &#34;This is a test: The duck quacks at midnight...&#34;
</span></span></code></pre></div><p>Good to go!</p><p>Eventually, I&rsquo;ll put it on PLaneT, but for now it&rsquo;s available on GitHub: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/with-gzip.rkt>with-gzip</a></p><p><strong>Edit 6 Aug 2013:</strong> Robby Findler had <a href=http://lists.racket-lang.org/users/archive/2013-August/058858.html>another suggestion</a> on the mailing list: rather than using <code>with-handlers</code>, try <code>dynamic-wind</code>. Essentially, <code>dynamic-wind</code> takes three thunks: pre, value, and post. It will call the pre-thunk when control is passed to it, then the value-thunk, then the post-thunk, returning whatever the value-thunk would have. The best part though is that if control exits for other reasons (say, an error), post-thunk will still be called. This way we can handle errors without error handling. If we wanted to turn that into code, we have something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>with-gunzip</span> thunk <span style=color:#f92672>#</span>:buffer-size [buffer-size <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>pipe-from</span> pipe-to) (<span style=color:#a6e22e>make-pipe</span> buffer-size))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>dynamic-wind</span>
</span></span><span style=display:flex><span>   void
</span></span><span style=display:flex><span>   (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>thread</span>
</span></span><span style=display:flex><span>      (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>gunzip-through-ports</span> (<span style=color:#a6e22e>current-input-port</span>) pipe-to)
</span></span><span style=display:flex><span>        (close-output-port pipe-to)))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>parameterize</span> ([current-input-port pipe-from])
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>thunk</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#960050;background-color:#1e0010>Î»</span> ()
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>unless</span> (<span style=color:#a6e22e>port-closed?</span> pipe-to) (close-output-port pipe-to))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>unless</span> (<span style=color:#a6e22e>port-closed?</span> pipe-from) (close-input-port pipe-from)))))
</span></span></code></pre></div><p>It&rsquo;s nice and clean, even correctly dealing with closing the pipe whether or not things work correctly. The <code>thread</code> there helps with reading. Without it, <code>gunzip-through-ports</code> will block, depending on how much it is trying to read. This way, it can run in parallel as needed.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Yes, I know I <em>can</em> write functional code in Python. I often do. It&rsquo;s just more natural in Racket&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Using<code><a href="http://docs.racket-lang.org/search/index.html?q=places">places</a></code>
;<code><a href="http://docs.racket-lang.org/search/index.html?q=threads">threads</a></code>
run in a single OS thread and thus have the same problem&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Although they&rsquo;re implented without them&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>While we&rsquo;re at it, we&rsquo;ll go ahead and close <code>pipe-from</code> as well&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
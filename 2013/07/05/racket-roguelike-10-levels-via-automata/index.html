<!DOCTYPE html>
<html onclick >
<head>
    <title>Racket Roguelike 10: Levels via automata! â€“ jverkamp.com</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a> *
            <a href="/resume">Resume</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>
    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/maker/">Maker</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Racket Roguelike 10: Levels via automata!</h1>

        <div class="entry-meta"><span class="entry-date">2013-07-05</span>
            </div>

        <div class="entry-taxonomies"><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2013/07/19/racket-roguelike-post-mortem/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/" class="previous-link"></a><a class="taxonomy-value" href="/programming/sources/7drl">7DRL</a><a href="https://blog.jverkamp.com/2013/07/19/racket-roguelike-post-mortem/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/games">Games</a><a href="https://blog.jverkamp.com/2013/07/19/racket-roguelike-post-mortem/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/roguelikes">Roguelikes</a><a href="https://blog.jverkamp.com/2013/07/19/racket-roguelike-post-mortem/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/" class="previous-link"></a><a class="taxonomy-value" href="/series/racket-roguelike">Racket Roguelike</a><a href="https://blog.jverkamp.com/2013/07/19/racket-roguelike-post-mortem/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/07/19/racket-roguelike-post-mortem/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/07/04/new-years/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/07/07/despicable-me-2/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</div>
    </header>

	<div class="entry-content"><p><a href="https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/">Last week</a> we made mazes on a regular grid using the <a href="https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/">noise generators</a>. That was pretty neat, but it got me thinking. What other ways do we have to procedurally generate interesting level patterns?</p>
<p>Well, one option would be to use <a href="https://en.wikipedia.org/wiki/cellular%20automaton">cellular automaton</a>. I&rsquo;ve written about them <a href="https://blog.jverkamp.com/2012/10/03/elementary-cellular-automaton/">before</a>, but in summary, they&rsquo;re basically applying a set of rules to a regular grid resulting in emergent features. In this case, our rule will be simple. Start with an empty grid seeded with a random central tile. From there, randomly generate new tiles, making them walkable if and only if there is 1-3 walkable tiles around them. This means that they have to be connected and they can&rsquo;t be too connected (allowing for branches but nothing more).</p>
<p>The first problem we have with that is that our current setup doesn&rsquo;t really allow for taking a tile&rsquo;s neighbors into account when generating content. So we&rsquo;ll have to directly access the level&rsquo;s tile hash. It&rsquo;s suboptimal (since we&rsquo;re breaking the abstraction), but it will work.</p>
<p>The second problem is that we can&rsquo;t rely on the normal terrain generation to work since it&rsquo;s too regular. Since we build the terrain when it&rsquo;s seen and always from top left to bottom right, we&rsquo;ll always get the same (poor) levels. We can get around this though. Any time the level generation function is called that means we&rsquo;re generating a new region. So clear the current region around that tile and then repeatedly randomly fill it back in.</p>
<p>So how does the code for this look?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Use a cellular automaton to generate levels</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">cellular</span> seed x y)
  <span style="color:#75715e">; Get the current level</span>
  (<span style="color:#66d9ef">define </span>current-level (<span style="color:#a6e22e">get-level</span> (<span style="color:#a6e22e">current-depth</span>)))

  <span style="color:#75715e">; Helper to count neighboring grass tiles</span>
  (<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">grass?</span> at)
    (eq? <span style="color:#e6db74">#\.</span> (<span style="color:#a6e22e">thing-get</span> (<span style="color:#a6e22e">hash-ref</span> current-level at empty) <span style="color:#e6db74">&#39;character</span> <span style="color:#e6db74">#\space</span>)))
  (<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">count</span> at)
    (<span style="color:#a6e22e">for*/sum</span> ([xi (<span style="color:#a6e22e">in-range</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">2</span>)]
               [yi (<span style="color:#a6e22e">in-range</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">2</span>)]
               <span style="color:#f92672">#</span>:unless (= <span style="color:#ae81ff">0</span> xi yi))
      (<span style="color:#66d9ef">if </span>(<span style="color:#a6e22e">grass?</span> (+ at (<span style="color:#a6e22e">pt</span> xi yi))) <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>)))

  <span style="color:#75715e">; Now randomly set some percentage of the surrounding tiles</span>
  (<span style="color:#66d9ef">define </span>region-size <span style="color:#ae81ff">10</span>)

  <span style="color:#75715e">; Clear the area first</span>
  (<span style="color:#a6e22e">for*</span> ([xi (<span style="color:#a6e22e">in-range</span> (- x region-size) (+ x region-size <span style="color:#ae81ff">1</span>))]
         [yi (<span style="color:#a6e22e">in-range</span> (- y region-size) (+ y region-size <span style="color:#ae81ff">1</span>))])
    (<span style="color:#a6e22e">hash-set!</span> current-level (<span style="color:#a6e22e">pt</span> xi yi) (<span style="color:#a6e22e">make-thing</span> wall)))

  <span style="color:#75715e">; Set the center tile</span>
  (<span style="color:#a6e22e">hash-set!</span> current-level (<span style="color:#a6e22e">pt</span> x y) (<span style="color:#a6e22e">make-thing</span> grass))

  <span style="color:#75715e">; Random grow</span>
  (<span style="color:#a6e22e">for</span> ([i (<span style="color:#a6e22e">in-range</span> (* region-size region-size region-size))])
    <span style="color:#75715e">; Choose a random point from the nearby area</span>
    (<span style="color:#66d9ef">define </span>new-pt (+ (<span style="color:#a6e22e">pt</span> x y)
                      (<span style="color:#a6e22e">pt</span> (- (<span style="color:#a6e22e">random</span> (* region-size <span style="color:#ae81ff">2</span>)) region-size)
                          (- (<span style="color:#a6e22e">random</span> (* region-size <span style="color:#ae81ff">2</span>)) region-size))))

    <span style="color:#75715e">; Set the new tile if we have 3 or less neighbors</span>
    <span style="color:#75715e">; And this tile hasn&#39;t already been set</span>
    <span style="color:#75715e">; Some become stairs instead</span>
    (<span style="color:#a6e22e">when</span> (&lt;= <span style="color:#ae81ff">1</span> (<span style="color:#a6e22e">count</span> new-pt) <span style="color:#ae81ff">2</span>)
      (<span style="color:#a6e22e">hash-set!</span> current-level new-pt
                 (<span style="color:#66d9ef">if </span>(zero? (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">100</span>))
                     (<span style="color:#a6e22e">make-thing</span> stairs-up)
                     (<span style="color:#a6e22e">make-thing</span> grass)))))

  <span style="color:#75715e">; Return our tile</span>
  (<span style="color:#a6e22e">hash-ref</span> current-level (<span style="color:#a6e22e">pt</span> x y)))
</code></pre></div><p>Theoretically, the comments should be all you need to understand what&rsquo;s going on.</p>
<p>So how does it look?</p>
<figure>
    <img src="/embeds/2013/Cellular-growth-1.png"/> 
</figure>

<p>Basically, we have a nice warren of tightly curving caves. It really reminds me a fair bit of Sandbox. Some day I want to go back to that&hellip;</p>
<p>So that&rsquo;s one non-noise based level generation script. What else can we do?</p>
<p>This time I&rsquo;m going back way to the dawn of my computing experience. Something nearing two decades ago, I started programming in <a href="https://en.wikipedia.org/wiki/Qbasic">Qbasic</a> (yup). One of my favorite programs from that time? Bugs. Basically, I started a bunch of random points on the screen, each of which would <a href="https://en.wikipedia.org/wiki/random%20walk">random walk</a> for a while, drawing a line. In the end, you&rsquo;d get something like this:</p>
<p><a href="https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Random_walk_in2D_closeup.png/510px-Random_walk_in2D_closeup.png"><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Random_walk_in2D_closeup.png/510px-Random_walk_in2D_closeup.png" class="alignnone" width="255" height="300" /></a></p>
<p>That looks a lot like the sorts of caves we might want to generate. So let&rsquo;s do it!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Generate levels using skittering bugs</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">bugs</span> seed x y)
  (<span style="color:#66d9ef">define </span>current-level (<span style="color:#a6e22e">get-level</span> (<span style="color:#a6e22e">current-depth</span>)))

  <span style="color:#75715e">; When a tile is requested, spread out from it for a while</span>
  (<span style="color:#66d9ef">let </span>loop ([i <span style="color:#ae81ff">0</span>] [x x] [y y])
    (<span style="color:#66d9ef">define </span>at (<span style="color:#a6e22e">pt</span> x y))

    <span style="color:#75715e">; Clear unset neighbors</span>
    (<span style="color:#a6e22e">for*</span> ([xi (<span style="color:#a6e22e">in-range</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">2</span>)] [yi (<span style="color:#a6e22e">in-range</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">2</span>)])
      (<span style="color:#66d9ef">define </span>ati (+ at (<span style="color:#a6e22e">pt</span> xi yi)))
      (<span style="color:#a6e22e">when</span> (not (<span style="color:#a6e22e">hash-has-key?</span> current-level ati))
        (<span style="color:#a6e22e">hash-set!</span> current-level ati (<span style="color:#a6e22e">make-thing</span> wall))))

    <span style="color:#75715e">; Set the current tile</span>
    (<span style="color:#a6e22e">hash-set!</span> current-level at
               (<span style="color:#66d9ef">if </span>(zero? (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">100</span>))
                   (<span style="color:#a6e22e">make-thing</span> stairs-up)
                   (<span style="color:#a6e22e">make-thing</span> grass)))

    <span style="color:#75715e">; Wonder around</span>
    (<span style="color:#a6e22e">when</span> (&lt; i <span style="color:#ae81ff">10</span>)
      (<span style="color:#a6e22e">loop</span> (+ i <span style="color:#ae81ff">1</span>) (+ x (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">-1</span>) (+ y (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">-1</span>))))

  <span style="color:#75715e">; Return the tile</span>
  (<span style="color:#a6e22e">hash-ref</span> current-level (<span style="color:#a6e22e">pt</span> x y)))
</code></pre></div><p>Basically, we use the same idea as before. When the function is called, spread out from there. That stops the nearby area from having to generate. So we get nice regions centered on each non-generated text.</p>
<p>And how does this one look?</p>
<figure>
    <img src="/embeds/2013/Bug-growth.png"/> 
</figure>

<p>It looks a lot like the cellular growth, but this time we have a lot more open caverns (as expected, each generating block will tend to form a room). What&rsquo;s nice is that there are all sorts of parameters to tweak. So we could make all sorts of rooms.</p>
<p>In any case, it&rsquo;s entirely too late now, so I really should be getting to sleep. One of these days I&rsquo;ll work ahead on these. ðŸ˜„</p>
<p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:</p>
<ul>
<li><a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike/tree/day-10">Racket Roguelike - Day 10</a></li>
<li><a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">Racket Roguelike - Up to date</a></li>
</ul>
<p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-10
git submodule init
git submodule update
racket main.rkt
</code></pre></div><p><strong>Edit:</strong></p>
<p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">raco pkg install github://github.com:jpverkamp/ascii-canvas/master
raco pkg install github://github.com:jpverkamp/noise/master
raco pkg install github://github.com:jpverkamp/thing/master
git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-10
racket main.rkt
</code></pre></div></div>
</article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script src="/custom.js"></script>
</body>
</html>

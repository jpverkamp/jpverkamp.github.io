<!DOCTYPE html>
<html>
<head>
    <title>
    Racket Roguelike 2: Infinite caves! – jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Racket Roguelike 2: Infinite caves!</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2013-04-11</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/sources/7drl">7DRL</a>
                        <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/games">Games</a>
                        <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/roguelikes">Roguelikes</a>
                        <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/series/racket-roguelike">Racket Roguelike</a>
                        <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>When <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/">last we met</a>, we had a working GUI with the player&rsquo;s <code>@</code> walking about. Today, we&rsquo;re going to add somewhere for the player to wander about<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>.</p>

<p>If you&rsquo;d like to start at the beginning, click here: <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/">Racket Roguelike 1: A GUI, screens, I/O, and you!</a></p>

<p>The bulk of today&rsquo;s post relies on having noise generating functions (nope, not <a href="https://en.wikipedia.org/wiki/Noise">that noise</a>). That was actually enough for a <a title="Perlin and simplex noise in Racket" href="http://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/?preview=true">post all its own</a>, so if making some noise sounds at all interesting, check it out. Otherwise, we&rsquo;re just going to add my new <a title="noise on GitHub" href="https://github.com/jpverkamp/noise">noise library</a> as a Git submodule to the project (so you&rsquo;ll need to run <code>git submodule update</code> if you&rsquo;re following along at home IIUC) and go from there.</p>

<p>Basically, what we need to do is add something to the <code>game-screen%</code> that will draw caverns. As a first test, how about just calculating the (scaled) Perlin noise for each point. If it&rsquo;s negative, it&rsquo;s open space. If it&rsquo;s positive, it&rsquo;s a wallRemember, Perlin noise has the range [-1.0, 1.0].</p>

<p>Here&rsquo;s what we&rsquo;d need to add to <code>draw</code>; I put it just after the <code>clear</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>

<span style="color:#75715e">; Draw some caverns around the player</span>
(for* ([xi (in-range (send canvas get-width-in-characters))]
       [yi (in-range (send canvas get-height-in-characters))])
  (<span style="color:#66d9ef">define </span>x/y (recenter canvas (pt xi yi)))
  (when (&gt; (perlin (* <span style="color:#ae81ff">0.1</span> (pt-x x/y)) (* <span style="color:#ae81ff">0.1</span> (pt-y x/y))) <span style="color:#ae81ff">0</span>)
    (send canvas write <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">#</span> xi yi)))</code></pre></div>
<p>If we run it, here&rsquo;s our first cave:</p>

<figure>
    <img src="/embeds/2013/initial-caverns.png"/> 
</figure>


<p>That&rsquo;s actually pretty awesome. There was about a <sup>50</sup>&frasl;<sub>50</sub> chance that we would have spawned inside of a wall or that we&rsquo;d have basically all walls or all floor. But we have a nice mix and start in a neat little cutoff. One drawback that you can see if you&rsquo;re looking closely is that Perlin noise tends to have little artifacts. You can see that in the sharp edge both to the east and south of the player where the arguments to <code>perlin</code> cross over 0. How about we try <code>simplex</code> instead? Just switch <code>perlin</code> for <code>simplex</code> and you get this instead:</p>

<figure>
    <img src="/embeds/2013/with-simplex.png"/> 
</figure>


<p>That looks much nicer, but this time we did spawn in a wall, as you can see if you move a bit to one side:</p>

<figure>
    <img src="/embeds/2013/move-away.png"/> 
</figure>


<p>This actually reveals a pretty big downside with the current setup though. With the noise functions, we have an essentially unlimited cave system that we could wonder through. But it certainly doesn&rsquo;t look like it&hellip; Without scrolling, we can only see a small slice. So how about scrolling?</p>

<p>Well, first we want to abstract out the map generation. We&rsquo;re going to keep a cache of all of the tiles (so we can theoretically make the map mutable later if we want to&ndash;I&rsquo;m imaging destructible terrain and burrowing baddies). There will be a <code><a href="http://docs.racket-lang.org/search/index.html?q=hash">hash</a></code>
 of <code>(x y)</code> points to their contents. Even better, this would allow for additional systems of map generation on top of just noise. For example, we could add buildings or other more dungeon-y features just by pre-generating a second of coordinates. For now, this is just a symbol: either <code>wall</code> or <code>empty</code>. All together, we want to add this code to the <code>game-screen%</code>, right after we define the <code>player</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>

<span style="color:#75715e">; Get the contents of a given point, caching for future use</span>
<span style="color:#75715e">; Hash on (x y) =&gt; char</span>
(<span style="color:#66d9ef">define </span>caves (make-hash))
(<span style="color:#66d9ef">define </span>(get-tile x y)
  (unless (hash-has-key? caves (list x y))
    (hash-set! caves (list x y)
               (<span style="color:#66d9ef">let </span>()
                 (<span style="color:#66d9ef">define </span>wall? (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0</span>))
                 (cond
                   [wall? <span style="color:#e6db74">&#39;wall</span>]
                   [<span style="color:#66d9ef">else </span> <span style="color:#e6db74">&#39;empty</span>]))))
  (hash-ref caves (list x y)))</code></pre></div>
<p>Then we change the drawing function to use <code>get-tile</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>

<span style="color:#75715e">; Draw some caverns around the player</span>
(for* ([xi (in-range (send canvas get-width-in-characters))]
       [yi (in-range (send canvas get-height-in-characters))])
  (<span style="color:#66d9ef">define </span>x/y (recenter canvas (pt xi yi)))
  (<span style="color:#66d9ef">case </span>(get-tile (pt-x x/y) (pt-y x/y))
    [(wall) (send canvas write <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">#</span> xi yi)]))</code></pre></div>
<p>Run and we have exactly what we did before.</p>

<p>Next, scrolling. Basically, we have two options. We can either force the player to stay at the center of the screen and constantly scroll the world around him or we can only scroll when we&rsquo;re near the edge of the screen. For the moment, we&rsquo;re going to go with the first option since it&rsquo;s far simpler to code. Basically, we need to change two points in the code. Where previously we used <code>recenter</code> on the player coordinates, we&rsquo;ll just use (0 0). This way, we&rsquo;ll always draw the player at the center of the screen:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>

<span style="color:#75715e">; Draw the player centered on the screen</span>
(<span style="color:#66d9ef">let </span>([player (recenter canvas (pt <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>))])
  (send canvas write <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">\</span>@ (pt-x player) (pt-y player)))</code></pre></div>
<p>Also, we want to offset the caves around the player. This is where the real beauty of using complex numbers as our coordinate system comes in. Since we can add them, we can add the player coordinates to the <code>x/y</code> of the tiles as we draw them. This will offset the map. It&rsquo;s really just as simple as tweaking this line:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>
(<span style="color:#66d9ef">define </span>x/y (recenter canvas (+ (pt xi yi) player)))</code></pre></div>
<p>With all of that, here&rsquo;s what we have:</p>

<figure>
    <img src="/embeds/2013/scrolling.png"/> 
</figure>


<p>I also added a debug printout to the top left showing the current player location. Note that the y-coordinate increases as you go down rather than up. Check out the <a href="https://github.com/jpverkamp/racket-roguelike/blob/master/src/game-screen.rkt" title="game screen source on GitHub">code on GitHub</a> if you&rsquo;re curious.</p>

<p>Unfortunately, we&rsquo;ve run right into one of the downsides of using noise to generate maps. There&rsquo;s no real guarantee that things will be connected (in fact there&rsquo;s a pretty strong guarantee that they won&rsquo;t be). There are ways to deal with this, but in the interest of progress, I&rsquo;m going to &lsquo;fix&rsquo; it for the time being by hacking the player&rsquo;s initial coordinates to <code>(pt -12 -7)</code> which will give us a bit larger region to explore:</p>

<figure>
    <img src="/embeds/2013/start-at-neg12-neg7.png"/> 
</figure>


<p>There are two things that we still want to add today before we can consider the initial cave generation working: more cave features and collision detection.</p>

<p>More features are easy enough, we just need to modify the <code>get-tile</code> function to be able to add more things and <code>draw</code> to draw them. How about some water and trees. I&rsquo;ll use <code>(x z)</code> and <code>(y z)</code> instead of <code>(x y)</code> to generate these so there won&rsquo;t be any artifacts from using the same coordinates. Overall, here is the new core of the <code>get-tile</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>
(<span style="color:#66d9ef">define </span>wall?  (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y) <span style="color:#ae81ff">0</span>)         <span style="color:#ae81ff">0.0</span>))
(<span style="color:#66d9ef">define </span>water? (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) <span style="color:#ae81ff">0</span>         (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
(<span style="color:#66d9ef">define </span>tree?  (&gt; (simplex <span style="color:#ae81ff">0</span>         (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
(cond
  [wall?  <span style="color:#e6db74">&#39;wall</span>]
  [water? <span style="color:#e6db74">&#39;water</span>]
  [tree?  <span style="color:#e6db74">&#39;tree</span>]
  [<span style="color:#66d9ef">else </span>  <span style="color:#e6db74">&#39;empty</span>])</code></pre></div>
<p>This could certainly be tweaked. Here&rsquo;s the relevant part of the new drawing function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>
(<span style="color:#66d9ef">case </span>(get-tile (pt-x x/y) (pt-y x/y))
  [(wall) (send canvas write <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">#</span> xi yi)]
  [(water) (send canvas write <span style="color:#e6db74">#\space</span> xi yi <span style="color:#e6db74">&#34;blue&#34;</span> <span style="color:#e6db74">&#34;blue&#34;</span>)]
  [(tree) (send canvas write <span style="color:#e6db74">#\u0005</span> xi yi <span style="color:#e6db74">&#34;green&#34;</span>)]))</code></pre></div>
<p>And here&rsquo;s what it looks like:</p>

<figure>
    <img src="/embeds/2013/water-and-trees.png"/> 
</figure>


<p>It&rsquo;s certainly not pretty, but I think it&rsquo;s a decent start. We&rsquo;ll make it better in a future post.</p>

<p>The last thing we want to do today is collision detection. Again, the idea should be straight forward. Essentially, we need to add a check in the <code>update</code> function that calls <code>get-tile</code> to see where we&rsquo;ll be going. If it&rsquo;s <code>empty</code>, move there. If not, block the move. Essentially, replace <code>update</code> with this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>

<span style="color:#75715e">; Process keyboard events</span>
(define/override (update key-event)
  <span style="color:#75715e">; NOTE: Y axis is top down, X axis is left to right</span>

  <span style="color:#75715e">; Find where we are attempting to go</span>
  (<span style="color:#66d9ef">define </span>target player)
  (<span style="color:#66d9ef">case </span>(send key-event get-key-code)
    [(numpad8 <span style="color:#e6db74">#\w</span> up)    (<span style="color:#66d9ef">set! </span>target (+ (pt  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">-1</span>) player))]
    [(numpad4 <span style="color:#e6db74">#\a</span> left)  (<span style="color:#66d9ef">set! </span>target (+ (pt <span style="color:#ae81ff">-1</span>  <span style="color:#ae81ff">0</span>) player))]
    [(numpad2 <span style="color:#e6db74">#\s</span> down)  (<span style="color:#66d9ef">set! </span>target (+ (pt  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>) player))]
    [(numpad6 <span style="color:#e6db74">#\d</span> right) (<span style="color:#66d9ef">set! </span>target (+ (pt  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>) player))])

  <span style="color:#75715e">; Only move if it&#39;s open</span>
  (when (eq? <span style="color:#e6db74">&#39;empty</span> (get-tile (pt-x target) (pt-y target)))
    (<span style="color:#66d9ef">set! </span>player target))

  <span style="color:#75715e">; Keep the state</span>
  this)</code></pre></div>
<p>And now we can move around and collide with things.</p>

<p>Unfortunately, the collisions seem to be totally and completely random! Sometimes we can walk through walls; sometimes we collide with empty space. What in the world is going on?</p>

<p>Well, it turns out that I lied. Remember back when I said that all we had to do was add the <code>player</code> coordinate to the coordinate we were drawing? Well, that displays nicely. But it&rsquo;s not actually correct. What we actually wanted was this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>
(<span style="color:#66d9ef">define </span>x/y (recenter canvas (- player (pt xi yi))))</code></pre></div>
<p>That solves one problem&ndash;now we correctly collide with terrain and can freely move through the empty space. But in solving one, we introduce another: we just flipped the coordinate system. Left is right and up is down! Madness!</p>

<p>But easy to fix madness. Just flip all of the differences in the <code>update</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>
(<span style="color:#66d9ef">case </span>(send key-event get-key-code)
  [(numpad8 <span style="color:#e6db74">#\w</span> up)    (<span style="color:#66d9ef">set! </span>target (+ (pt  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>) player))]
  [(numpad4 <span style="color:#e6db74">#\a</span> left)  (<span style="color:#66d9ef">set! </span>target (+ (pt  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span>) player))]
  [(numpad2 <span style="color:#e6db74">#\s</span> down)  (<span style="color:#66d9ef">set! </span>target (+ (pt  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">-1</span>) player))]
  [(numpad6 <span style="color:#e6db74">#\d</span> right) (<span style="color:#66d9ef">set! </span>target (+ (pt <span style="color:#ae81ff">-1</span>  <span style="color:#ae81ff">0</span>) player))])</code></pre></div>
<p>Now left is left, and up is up. All is good in the world&hellip;</p>

<p>Of course it&rsquo;s not. Now the coordinates are inverted. Moving east decreases the x-coordinate, as does south and the y-coordinate. The second seems strange, but remember that we wanted the y-coordinate to increase going down the screen (as computer graphics are wont to do).</p>

<p>For the time being, we&rsquo;re going to leave that as an exercise to the reader. I&rsquo;m 90% sure I have a few things consistently flipped around, but at the moment I don&rsquo;t have the time to figure out exactly where. If anyone has a fix, feel free to post it in the comments. Otherwise, I&rsquo;ll fix it in the next post.</p>

<p>Now that we&rsquo;re done, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:
- <a href="https://github.com/jpverkamp/racket-roguelike/tree/day-2" title="Racket Roguelike on GitHub">Racket Roguelike - Day 2</a>
- <a href="https://github.com/jpverkamp/racket-roguelike" title="Racket Roguelike on GitHub">Racket Roguelike - Up to date</a></p>

<p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-2
git submodule init
git submodule update
racket main.rkt</code></pre></div>
<p><strong>Edit:</strong></p>

<p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">raco pkg install github://github.com:jpverkamp/ascii-canvas/master
raco pkg install github://github.com:jpverkamp/noise/master
raco pkg install github://github.com:jpverkamp/thing/master
git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-2
racket main.rkt</code></pre></div>
<p>Like last time just remove the third line to get the up to date code instead if you&rsquo;d rather.</p>

<p>For part 3, click here: <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/">Racket Roguelike 3: Rats, rats, everywhere!</a></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Forever!
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Racket Roguelike 2: Infinite caves!";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2013\/04\/11\/racket-roguelike-2-infinite-caves\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

<!doctype html><html><head><title>Racket Roguelike 2: Infinite caves! – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Racket Roguelike 2: Infinite caves!</h1><div class=entry-meta><span class=entry-date>2013-04-11</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/7drl>7DRL</a><a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/games>Games</a><a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/roguelikes>Roguelikes</a><a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/ class=previous-link></a><a class=taxonomy-value href=/series/racket-roguelike>Racket Roguelike</a><a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>When <a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/>last we met</a>, we had a working GUI with the player&rsquo;s <code>@</code> walking about. Today, we&rsquo;re going to add somewhere for the player to wander about<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>If you&rsquo;d like to start at the beginning, click here: <a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/>Racket Roguelike 1: A GUI, screens, I/O, and you!</a></p><p>The bulk of today&rsquo;s post relies on having noise generating functions (nope, not <a href=https://en.wikipedia.org/wiki/Noise>that noise</a>). That was actually enough for a <a title="Perlin and simplex noise in Racket" href="http://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/?preview=true">post all its own</a>, so if making some noise sounds at all interesting, check it out. Otherwise, we&rsquo;re just going to add my new <a title="noise on GitHub" href=https://github.com/jpverkamp/noise>noise library</a> as a Git submodule to the project (so you&rsquo;ll need to run <code>git submodule update</code> if you&rsquo;re following along at home IIUC) and go from there.</p><p>Basically, what we need to do is add something to the <code>game-screen%</code> that will draw caverns. As a first test, how about just calculating the (scaled) Perlin noise for each point. If it&rsquo;s negative, it&rsquo;s open space. If it&rsquo;s positive, it&rsquo;s a wallRemember, Perlin noise has the range [-1.0, 1.0].</p><p>Here&rsquo;s what we&rsquo;d need to add to <code>draw</code>; I put it just after the <code>clear</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Draw some caverns around the player</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>for*</span> ([xi (<span style=color:#a6e22e>in-range</span> (<span style=color:#a6e22e>send</span> canvas get-width-in-characters))]
</span></span><span style=display:flex><span>       [yi (<span style=color:#a6e22e>in-range</span> (<span style=color:#a6e22e>send</span> canvas get-height-in-characters))])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>x/y (<span style=color:#a6e22e>recenter</span> canvas (<span style=color:#a6e22e>pt</span> xi yi)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (&gt; (<span style=color:#a6e22e>perlin</span> (* <span style=color:#ae81ff>0.1</span> (<span style=color:#a6e22e>pt-x</span> x/y)) (* <span style=color:#ae81ff>0.1</span> (<span style=color:#a6e22e>pt-y</span> x/y))) <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>send</span> canvas write <span style=color:#e6db74>#\#</span> xi yi)))
</span></span></code></pre></div><p>If we run it, here&rsquo;s our first cave:</p><figure><img src=/embeds/2013/initial-caverns.png></figure><p>That&rsquo;s actually pretty awesome. There was about a 50/50 chance that we would have spawned inside of a wall or that we&rsquo;d have basically all walls or all floor. But we have a nice mix and start in a neat little cutoff. One drawback that you can see if you&rsquo;re looking closely is that Perlin noise tends to have little artifacts. You can see that in the sharp edge both to the east and south of the player where the arguments to <code>perlin</code> cross over 0. How about we try <code>simplex</code> instead? Just switch <code>perlin</code> for <code>simplex</code> and you get this instead:</p><figure><img src=/embeds/2013/with-simplex.png></figure><p>That looks much nicer, but this time we did spawn in a wall, as you can see if you move a bit to one side:</p><figure><img src=/embeds/2013/move-away.png></figure><p>This actually reveals a pretty big downside with the current setup though. With the noise functions, we have an essentially unlimited cave system that we could wonder through. But it certainly doesn&rsquo;t look like it&mldr; Without scrolling, we can only see a small slice. So how about scrolling?</p><p>Well, first we want to abstract out the map generation. We&rsquo;re going to keep a cache of all of the tiles (so we can theoretically make the map mutable later if we want to&ndash;I&rsquo;m imaging destructible terrain and burrowing baddies). There will be a <code><a href="http://docs.racket-lang.org/search/index.html?q=hash">hash</a></code>
of <code>(x y)</code> points to their contents. Even better, this would allow for additional systems of map generation on top of just noise. For example, we could add buildings or other more dungeon-y features just by pre-generating a second of coordinates. For now, this is just a symbol: either <code>wall</code> or <code>empty</code>. All together, we want to add this code to the <code>game-screen%</code>, right after we define the <code>player</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Get the contents of a given point, caching for future use</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Hash on (x y) =&gt; char</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>caves (<span style=color:#a6e22e>make-hash</span>))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-tile</span> x y)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>unless</span> (<span style=color:#a6e22e>hash-has-key?</span> caves (list x y))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>hash-set!</span> caves (list x y)
</span></span><span style=display:flex><span>               (<span style=color:#66d9ef>let </span>()
</span></span><span style=display:flex><span>                 (<span style=color:#66d9ef>define </span>wall? (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>                 (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>                   [wall? <span style=color:#e6db74>&#39;wall</span>]
</span></span><span style=display:flex><span>                   [<span style=color:#66d9ef>else </span> <span style=color:#e6db74>&#39;empty</span>]))))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>hash-ref</span> caves (list x y)))
</span></span></code></pre></div><p>Then we change the drawing function to use <code>get-tile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Draw some caverns around the player</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>for*</span> ([xi (<span style=color:#a6e22e>in-range</span> (<span style=color:#a6e22e>send</span> canvas get-width-in-characters))]
</span></span><span style=display:flex><span>       [yi (<span style=color:#a6e22e>in-range</span> (<span style=color:#a6e22e>send</span> canvas get-height-in-characters))])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>x/y (<span style=color:#a6e22e>recenter</span> canvas (<span style=color:#a6e22e>pt</span> xi yi)))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>get-tile</span> (<span style=color:#a6e22e>pt-x</span> x/y) (<span style=color:#a6e22e>pt-y</span> x/y))
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>wall</span>) (<span style=color:#a6e22e>send</span> canvas write <span style=color:#e6db74>#\#</span> xi yi)]))
</span></span></code></pre></div><p>Run and we have exactly what we did before.</p><p>Next, scrolling. Basically, we have two options. We can either force the player to stay at the center of the screen and constantly scroll the world around him or we can only scroll when we&rsquo;re near the edge of the screen. For the moment, we&rsquo;re going to go with the first option since it&rsquo;s far simpler to code. Basically, we need to change two points in the code. Where previously we used <code>recenter</code> on the player coordinates, we&rsquo;ll just use (0 0). This way, we&rsquo;ll always draw the player at the center of the screen:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Draw the player centered on the screen</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>let </span>([player (<span style=color:#a6e22e>recenter</span> canvas (<span style=color:#a6e22e>pt</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>))])
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>send</span> canvas write <span style=color:#e6db74>#\@</span> (<span style=color:#a6e22e>pt-x</span> player) (<span style=color:#a6e22e>pt-y</span> player)))
</span></span></code></pre></div><p>Also, we want to offset the caves around the player. This is where the real beauty of using complex numbers as our coordinate system comes in. Since we can add them, we can add the player coordinates to the <code>x/y</code> of the tiles as we draw them. This will offset the map. It&rsquo;s really just as simple as tweaking this line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>x/y (<span style=color:#a6e22e>recenter</span> canvas (+ (<span style=color:#a6e22e>pt</span> xi yi) player)))
</span></span></code></pre></div><p>With all of that, here&rsquo;s what we have:</p><figure><img src=/embeds/2013/scrolling.png></figure><p>I also added a debug printout to the top left showing the current player location. Note that the y-coordinate increases as you go down rather than up. Check out the <a href=https://github.com/jpverkamp/racket-roguelike/blob/master/src/game-screen.rkt title="game screen source on GitHub">code on GitHub</a> if you&rsquo;re curious.</p><p>Unfortunately, we&rsquo;ve run right into one of the downsides of using noise to generate maps. There&rsquo;s no real guarantee that things will be connected (in fact there&rsquo;s a pretty strong guarantee that they won&rsquo;t be). There are ways to deal with this, but in the interest of progress, I&rsquo;m going to &lsquo;fix&rsquo; it for the time being by hacking the player&rsquo;s initial coordinates to <code>(pt -12 -7)</code> which will give us a bit larger region to explore:</p><figure><img src=/embeds/2013/start-at-neg12-neg7.png></figure><p>There are two things that we still want to add today before we can consider the initial cave generation working: more cave features and collision detection.</p><p>More features are easy enough, we just need to modify the <code>get-tile</code> function to be able to add more things and <code>draw</code> to draw them. How about some water and trees. I&rsquo;ll use <code>(x z)</code> and <code>(y z)</code> instead of <code>(x y)</code> to generate these so there won&rsquo;t be any artifacts from using the same coordinates. Overall, here is the new core of the <code>get-tile</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>wall?  (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y) <span style=color:#ae81ff>0</span>)         <span style=color:#ae81ff>0.0</span>))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>water? (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) <span style=color:#ae81ff>0</span>         (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>tree?  (&gt; (<span style=color:#a6e22e>simplex</span> <span style=color:#ae81ff>0</span>         (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>  [wall?  <span style=color:#e6db74>&#39;wall</span>]
</span></span><span style=display:flex><span>  [water? <span style=color:#e6db74>&#39;water</span>]
</span></span><span style=display:flex><span>  [tree?  <span style=color:#e6db74>&#39;tree</span>]
</span></span><span style=display:flex><span>  [<span style=color:#66d9ef>else </span>  <span style=color:#e6db74>&#39;empty</span>])
</span></span></code></pre></div><p>This could certainly be tweaked. Here&rsquo;s the relevant part of the new drawing function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>get-tile</span> (<span style=color:#a6e22e>pt-x</span> x/y) (<span style=color:#a6e22e>pt-y</span> x/y))
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>wall</span>) (<span style=color:#a6e22e>send</span> canvas write <span style=color:#e6db74>#\#</span> xi yi)]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>water</span>) (<span style=color:#a6e22e>send</span> canvas write <span style=color:#e6db74>#\space</span> xi yi <span style=color:#e6db74>&#34;blue&#34;</span> <span style=color:#e6db74>&#34;blue&#34;</span>)]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>tree</span>) (<span style=color:#a6e22e>send</span> canvas write <span style=color:#e6db74>#\u</span><span style=color:#ae81ff>0005</span> xi yi <span style=color:#e6db74>&#34;green&#34;</span>)]))
</span></span></code></pre></div><p>And here&rsquo;s what it looks like:</p><figure><img src=/embeds/2013/water-and-trees.png></figure><p>It&rsquo;s certainly not pretty, but I think it&rsquo;s a decent start. We&rsquo;ll make it better in a future post.</p><p>The last thing we want to do today is collision detection. Again, the idea should be straight forward. Essentially, we need to add a check in the <code>update</code> function that calls <code>get-tile</code> to see where we&rsquo;ll be going. If it&rsquo;s <code>empty</code>, move there. If not, block the move. Essentially, replace <code>update</code> with this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Process keyboard events</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define/override</span> (<span style=color:#a6e22e>update</span> key-event)
</span></span><span style=display:flex><span>  <span style=color:#75715e>; NOTE: Y axis is top down, X axis is left to right</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Find where we are attempting to go</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>target player)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>send</span> key-event get-key-code)
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>numpad8</span> <span style=color:#e6db74>#\w</span> up)    (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>) player))]
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>numpad4</span> <span style=color:#e6db74>#\a</span> left)  (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>) player))]
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>numpad2</span> <span style=color:#e6db74>#\s</span> down)  (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>) player))]
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>numpad6</span> <span style=color:#e6db74>#\d</span> right) (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>) player))])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Only move if it&#39;s open</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (eq? <span style=color:#e6db74>&#39;empty</span> (<span style=color:#a6e22e>get-tile</span> (<span style=color:#a6e22e>pt-x</span> target) (<span style=color:#a6e22e>pt-y</span> target)))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>set! </span>player target))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Keep the state</span>
</span></span><span style=display:flex><span>  this)
</span></span></code></pre></div><p>And now we can move around and collide with things.</p><p>Unfortunately, the collisions seem to be totally and completely random! Sometimes we can walk through walls; sometimes we collide with empty space. What in the world is going on?</p><p>Well, it turns out that I lied. Remember back when I said that all we had to do was add the <code>player</code> coordinate to the coordinate we were drawing? Well, that displays nicely. But it&rsquo;s not actually correct. What we actually wanted was this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>x/y (<span style=color:#a6e22e>recenter</span> canvas (- player (<span style=color:#a6e22e>pt</span> xi yi))))
</span></span></code></pre></div><p>That solves one problem&ndash;now we correctly collide with terrain and can freely move through the empty space. But in solving one, we introduce another: we just flipped the coordinate system. Left is right and up is down! Madness!</p><p>But easy to fix madness. Just flip all of the differences in the <code>update</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>send</span> key-event get-key-code)
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>numpad8</span> <span style=color:#e6db74>#\w</span> up)    (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>) player))]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>numpad4</span> <span style=color:#e6db74>#\a</span> left)  (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>) player))]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>numpad2</span> <span style=color:#e6db74>#\s</span> down)  (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>) player))]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>numpad6</span> <span style=color:#e6db74>#\d</span> right) (<span style=color:#66d9ef>set! </span>target (+ (<span style=color:#a6e22e>pt</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>) player))])
</span></span></code></pre></div><p>Now left is left, and up is up. All is good in the world&mldr;</p><p>Of course it&rsquo;s not. Now the coordinates are inverted. Moving east decreases the x-coordinate, as does south and the y-coordinate. The second seems strange, but remember that we wanted the y-coordinate to increase going down the screen (as computer graphics are wont to do).</p><p>For the time being, we&rsquo;re going to leave that as an exercise to the reader. I&rsquo;m 90% sure I have a few things consistently flipped around, but at the moment I don&rsquo;t have the time to figure out exactly where. If anyone has a fix, feel free to post it in the comments. Otherwise, I&rsquo;ll fix it in the next post.</p><p>Now that we&rsquo;re done, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:</p><ul><li><a href=https://github.com/jpverkamp/racket-roguelike/tree/day-2 title="Racket Roguelike on GitHub">Racket Roguelike - Day 2</a></li><li><a href=https://github.com/jpverkamp/racket-roguelike title="Racket Roguelike on GitHub">Racket Roguelike - Up to date</a></li></ul><p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href=http://git-scm.com/>Git</a> and <a href=http://racket-lang.org/>Racket</a> and run the following series of commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-2
</span></span><span style=display:flex><span>git submodule init
</span></span><span style=display:flex><span>git submodule update
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p><strong>Edit:</strong></p><p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/ascii-canvas/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/noise/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/thing/master
</span></span><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-2
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p>Like last time just remove the third line to get the up to date code instead if you&rsquo;d rather.</p><p>For part 3, click here: <a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/>Racket Roguelike 3: Rats, rats, everywhere!</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Forever!&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
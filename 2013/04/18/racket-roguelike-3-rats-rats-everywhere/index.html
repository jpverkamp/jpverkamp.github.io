<!DOCTYPE html>
<html>
<head>
    <title>Racket Roguelike 3: Rats, rats, everywhere! – jverkamp.com</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li><a href="/resume" title="My Resume">Resume</a></li>
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Racket Roguelike 3: Rats, rats, everywhere!</h1>

        <div class="entry-meta"><span class="entry-date">2013-04-18</span>
            </div><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2013/04/23/user-space-continuation-based-thread-pool/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/" class="previous-link"></a><a class="taxonomy-value" href="/programming/sources/7drl">7DRL</a><a href="https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/games">Games</a><a href="https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/roguelikes">Roguelikes</a><a href="https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/" class="previous-link"></a><a class="taxonomy-value" href="/series/racket-roguelike">Racket Roguelike</a><a href="https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/04/23/user-space-continuation-based-thread-pool/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/04/23/user-space-continuation-based-thread-pool/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</header>

	<div class="entry-content"><p>So far, we&rsquo;ve <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/">worked out our GUI and I/O</a> and <a href="https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/">created procedurally generated caves</a>. So what does that leave for today? Something to fight!</p>

<p>If you&rsquo;d like to start at the beginning, click here: <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/">Racket Roguelike 1: A GUI, screens, I/O, and you!</a></p>

<p>Today&rsquo;s changes are pretty substantial, so it might be worth it to grab the source and get it handy while we go. In particularly, I&rsquo;ve added the ⟦ crosslink &ldquo;a-prototype-object-system-for-racket&rdquo; &ldquo;prototype &ldquo;thing&rdquo; code&rdquo; ⟧ from last night, refactored the point code into it&rsquo;s <a title="point source" href="https://github.com/jpverkamp/racket-roguelike/blob/master/src/point.rkt">own file</a>, and created a <a title="world source" href="https://github.com/jpverkamp/racket-roguelike/blob/master/src/world.rkt">&lsquo;world&rsquo; abstraction</a> to hold things like the player and tiles. I&rsquo;ll mention each of those in turn, but really not much changed in either, things just moved around.</p>

<p>That being said, what do we need to get everything working?</p>

<ul>
<li>Create entity / enemy &lsquo;things&rsquo;</li>
<li>Create the world abstraction</li>
<li>Get the enemies moving around</li>
<li>Entities attack each other when they move into each other</li>
<li>Entities (and the player) can die</li>
<li>Logging functionality</li>
</ul>

<p>So let&rsquo;s get to it, shall we?</p>

<p>First, let&rsquo;s use the <a href="https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/">&lsquo;thing&rsquo; framework</a> to create some enemies. If you haven&rsquo;t already read about the system, you probably should. But after that, it should be pretty straight forward. We&rsquo;ll start with basic entities. An entity is anything that has a location but isn&rsquo;t a tile in the map. So enemies and (in the future) items:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; entities.rkt</span>

<span style="color:#75715e">; All entities have:</span>
<span style="color:#75715e">; - a location on the map</span>
<span style="color:#75715e">; - attack and defense strengths</span>
<span style="color:#75715e">; - hitpoints</span>
(define-thing entity
  [character <span style="color:#e6db74">#\x</span>]
  [color <span style="color:#e6db74">&#34;white&#34;</span>]
  [location (pt <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>)])</code></pre></div>
<p>Each one has the character and color used to describe it and a location in the world. From here, we can extend this to enemies. These will have statistics for attack, defense, and health, along with an <code>act</code> method that will be called each tick to update the enemy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; entities.rkt</span>

<span style="color:#75715e">; An enemy must have an act method</span>
<span style="color:#75715e">; It should mutate the world with it&#39;s updated state</span>
<span style="color:#75715e">; The default enemy does nothing</span>
(define-thing enemy entity
  [name <span style="color:#e6db74">&#34;enemy&#34;</span>]
  [color <span style="color:#e6db74">&#34;gray&#34;</span>]
  [attack <span style="color:#ae81ff">10</span>]
  [defense <span style="color:#ae81ff">10</span>]
  [health <span style="color:#ae81ff">10</span>]
  [(act me world) (void)])</code></pre></div>
<p>The real beauty of a prototype based system comes in when we extend that enemy function in turn with a method that implements random movement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; entities.rkt</span>

<span style="color:#75715e">; A wandering enemy randomly chooses a neighboring open square</span>
(define-thing wandering-enemy enemy
  [(act me world)
   <span style="color:#75715e">; Choose a random possible move</span>
   (send world try-move
         me
         (+ (thing-get me <span style="color:#e6db74">&#39;location</span>)
            (pt (- (random <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">1</span>)
                (- (random <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">1</span>))))])</code></pre></div>
<p>We&rsquo;ll still have to define <code>try-move</code>, but it&rsquo;s a good start.</p>

<p>Finally, here&rsquo;s our first enemy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; entities.rkt</span>

(make-thing wandering-enemy
  [name <span style="color:#e6db74">&#34;rat&#34;</span>]
  [character <span style="color:#e6db74">#\r</span>])</code></pre></div>
<p>But all of this is completely worthless if we don&rsquo;t actually add them to the world. So let&rsquo;s do that. In order to do so though, this is where we want to factor out the <code>world</code> into it&rsquo;s own file so that we can keep it separate from the rest of the <code>game-screen%</code> functionality.</p>

<p>In parts, we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

(<span style="color:#66d9ef">define </span>world%
  (class object%
    <span style="color:#75715e">; Store the player</span>
    (<span style="color:#66d9ef">define </span>player
      (make-thing entity
        [name <span style="color:#e6db74">&#34;player&#34;</span>]
        [attack <span style="color:#ae81ff">10</span>]
        [defense <span style="color:#ae81ff">10</span>]
        [health <span style="color:#ae81ff">100</span>]))
    (define/public (get-player) player)

    <span style="color:#75715e">; Get the contents of a given point, caching for future use</span>
    <span style="color:#75715e">; Hash on (x y) =&gt; char</span>
    (<span style="color:#66d9ef">define </span>tiles (make-hash))
    (define/public (get-tile x y)
      <span style="color:#f92672">...</span>)

    <span style="color:#75715e">; Try to move an entity to a given location</span>
    (define/public (try-move entity target)
      <span style="color:#f92672">...</span>)

    <span style="color:#75715e">; Store a list of non-player entities</span>
    (<span style="color:#66d9ef">define </span>npcs <span style="color:#f92672">&#39;</span>())

    (define/public (update-npcs)
      <span style="color:#f92672">...</span>)

    (define/public (draw-npcs canvas)
      <span style="color:#f92672">...</span>)

    (super-new)))</code></pre></div>
<p>Let&rsquo;s go through each function in turn. First, we have the <code>get-tile</code> function. It&rsquo;s the same thing that we used in last week&rsquo;s post to generate the map in the first place, but now it&rsquo;s been extended to generate enemies as well. The trick here is that we tie enemy generation into new tile generation. So whenever we generate a new (open) tile&ndash;by moving into unexplored territory for example&ndash;there&rsquo;s a random chance of generating a random enemy as well. So far, we only have rats, but the framework is already there to add any number of enemies.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

<span style="color:#75715e">; Get the contents of a given point, caching for future use</span>
<span style="color:#75715e">; Hash on (x y) =&gt; char</span>
(<span style="color:#66d9ef">define </span>tiles (make-hash))
(define/public (get-tile x y)
  <span style="color:#75715e">; If the tile doesn&#39;t already exist, generate it</span>
  (unless (hash-has-key? tiles (list x y))
    <span style="color:#75715e">; Generate a random tile</span>
    (<span style="color:#66d9ef">define </span>new-tile
      (<span style="color:#66d9ef">let </span>()
        (<span style="color:#66d9ef">define </span>wall?  (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y) <span style="color:#ae81ff">0</span>)         <span style="color:#ae81ff">0.0</span>))
        (<span style="color:#66d9ef">define </span>water? (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) <span style="color:#ae81ff">0</span>         (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
        (<span style="color:#66d9ef">define </span>tree?  (&gt; (simplex <span style="color:#ae81ff">0</span>         (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
        (cond
          [wall?  wall]
          [water? water]
          [tree?  tree]
          [<span style="color:#66d9ef">else </span>  empty])))
    (hash-set! tiles (list x y) new-tile)

    <span style="color:#75715e">; Sometimes, generate a new enemy</span>
    <span style="color:#75715e">; Only if the new tile is walkable</span>
    (when (<span style="color:#66d9ef">and </span>(thing-get new-tile <span style="color:#e6db74">&#39;walkable</span>)
               (&lt; (random <span style="color:#ae81ff">100</span>) <span style="color:#ae81ff">1</span>))
      (<span style="color:#66d9ef">define </span>new-thing
        (make-thing
          <span style="color:#75715e">; Base it off a randomly chosen enemy</span>
          (vector-ref random-enemies
                      (random (vector-length random-enemies)))
          <span style="color:#75715e">; This is it&#39;s location</span>
          [location (pt x y)]))

      <span style="color:#75715e">; Store it in the npc list</span>
      (<span style="color:#66d9ef">set! </span>npcs (cons new-thing npcs))))

  <span style="color:#75715e">; Return the tile (newly generated or not)</span>
  (hash-ref tiles (list x y)))</code></pre></div>
<p>You may notice that the tiles returned aren&rsquo;t simple symbols anymore. Instead, they&rsquo;re another parallel thing hierarchy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

<span style="color:#75715e">; Define tile types</span>
(define-thing tile
  [walkable <span style="color:#66d9ef">#f</span>]
  [character <span style="color:#e6db74">#\space</span>]
  [color <span style="color:#e6db74">&#34;black&#34;</span>])

(define-thing empty tile
  [walkable <span style="color:#66d9ef">#t</span>])

(define-thing wall tile
  [character <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">#</span>]
  [color <span style="color:#e6db74">&#34;white&#34;</span>])

(define-thing water tile
  [character <span style="color:#e6db74">#\u00db</span>]
  [color <span style="color:#e6db74">&#34;blue&#34;</span>])

(define-thing tree tile
  [character <span style="color:#e6db74">#\u0005</span>]
  [color <span style="color:#e6db74">&#34;green&#34;</span>])</code></pre></div>
<p>Other than that, the code should theoretically be straightforward. One neat part is that each critter is instantiated as it&rsquo;s generated simply by using <code>make-thing</code> to extend it (and override the location). This is that nice overlap with extending and instantiating classes that I noted in the <a href="https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/">prototype post</a>.</p>

<p>What about<code>try-move</code>? Originally, the player movement and the entity movement (in <code>wandering-enemy</code>&rsquo;s <code>act</code> method) duplicated the code that checked for enemies. But this wasn&rsquo;t particularly helpful. Instead, we want a method that can handle the three possible cases when moving to a new tile:</p>

<ul>
<li>If the tile isn&rsquo;t walkable, do nothing</li>
<li>If the tile is walkable and not otherwise occupied, update the location</li>
<li>If the tile is walkable and occupied, attack the occupant and stay where you are</li>
</ul>

<p>All of that translates pretty directly to this code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

<span style="color:#75715e">; Try to move an entity to a given location</span>
(define/public (try-move entity target)
  (<span style="color:#66d9ef">define </span>tile (send this get-tile (pt-x target) (pt-y target)))
  (<span style="color:#66d9ef">define </span>others
    (filter
     <span style="color:#75715e">; Only get ones at the target location that aren&#39;t me</span>
     (<span style="color:#66d9ef">lambda </span>(thing) (<span style="color:#66d9ef">and </span>(not (eqv? thing entity))
                          (= (thing-get thing <span style="color:#e6db74">&#39;location</span>) target)))
     <span style="color:#75715e">; Include the player and all npcs</span>
     (cons player npcs)))

  (cond
    <span style="color:#75715e">; If it&#39;s not walkable, do nothing</span>
    [(not (thing-get tile <span style="color:#e6db74">&#39;walkable</span>))
     (void)]
    <span style="color:#75715e">; If it&#39;s walkable and not occupied, update the location</span>
    [(null? others)
     (thing-set! entity <span style="color:#e6db74">&#39;location</span> target)]
    <span style="color:#75715e">; If it&#39;s walkable and occupied, attack the occupant and don&#39;t move</span>
    <span style="color:#75715e">; damage = max(0, rand(min(1, attack)) - rand(min(1, defense)))</span>
    [else
     (for ([other (in-list others)])
       <span style="color:#75715e">; Do the damage</span>
       (<span style="color:#66d9ef">define </span>damage
         (max <span style="color:#ae81ff">0</span> (- (random (max <span style="color:#ae81ff">1</span> (thing-get entity <span style="color:#e6db74">&#39;attack</span>)))
                   (random (max <span style="color:#ae81ff">1</span> (thing-get other <span style="color:#e6db74">&#39;defense</span>))))))
       (thing-set! other <span style="color:#e6db74">&#39;health</span> (- (thing-get other <span style="color:#e6db74">&#39;health</span>) damage))

       <span style="color:#75715e">; Log a message</span>
       (send this log
             (format <span style="color:#e6db74">&#34;~a attacked ~a, did ~a damage&#34;</span>
                     (thing-get entity <span style="color:#e6db74">&#39;name</span>)
                     (thing-get other <span style="color:#e6db74">&#39;name</span>)
                     damage)))]))</code></pre></div>
<p>The first part gets the tile and any other entities that could be in the target tile. Right now, there&rsquo;s no way that more than one entity should ever be in the same tile, but that&rsquo;s not a hard restriction, it could change in the future.</p>

<p>The second part controls the three conditions. The first two are straightforward, either doing nothing or just updating the location. The last part is a little more complicated because we have to deal with doing damage. For the moment, I&rsquo;m using a completely made up damage function with a nice degree of randomness:</p>

<div class="latex-block">damage = max(0, random(1, max(1, attack)) - random(1, max(1, defense)))</div>


<p>This means that it&rsquo;s not possible to do 0 damage and that the minimum attack and defense values are 1. This was a bit of a problem at first, when I used <code>min</code> instead of <code>max</code> on the inner two parts. That meant everything had an attack and defense of 1&ndash;which means no one could do any damage. Oops.</p>

<p>Finally, we log the message. I&rsquo;ll talk about that later.</p>

<p>There are two more parts that we have to deal with, updating and drawing the NPCs. To update them, we have to call each of their <code>act</code> methods in turn then filter out the ones that have fallen to 0 or less <code>health</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

(define/public (update-npcs)
  <span style="color:#75715e">; Allow each to move</span>
  (for ([npc (in-list npcs)])
    (thing-call npc <span style="color:#e6db74">&#39;act</span> npc this))
  <span style="color:#75715e">; Check for (and remove) any dead npcs</span>
  (<span style="color:#66d9ef">set! </span>npcs
        (filter
         (<span style="color:#66d9ef">lambda </span>(npc)
           (when (&lt;= (thing-get npc <span style="color:#e6db74">&#39;health</span>) <span style="color:#ae81ff">0</span>)              (send this log (format <span style="color:#e6db74">&#34;~a has died&#34;</span> (thing-get npc <span style="color:#e6db74">&#39;name</span>))))            (&gt; (thing-get npc <span style="color:#e6db74">&#39;health</span>) <span style="color:#ae81ff">0</span>))
         npcs)))</code></pre></div>
<p>This does allow for an oddity that an NPC could die during the action loop but then still take it&rsquo;s turn. It&rsquo;s suboptimal but on the flip side I think it&rsquo;s fair. Think of it as the NPCs attack in parallel rather than in turn and everything is fine.</p>

<p>The draw method is pretty much the same. Again, we take advantage of the fact that points are complex numbers and can thus be used mathematically:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

(define/public (draw-npcs canvas)
  (for ([npc (in-list npcs)])
    (<span style="color:#66d9ef">define </span>x/y (recenter canvas (- (thing-get player <span style="color:#e6db74">&#39;location</span>)
                                    (thing-get npc <span style="color:#e6db74">&#39;location</span>))))
    (when (<span style="color:#66d9ef">and </span>(&lt;= <span style="color:#ae81ff">0</span> (pt-x x/y) (sub1 (send canvas get-width-in-characters)))
               (&lt;= <span style="color:#ae81ff">0</span> (pt-y x/y) (sub1 (send canvas get-height-in-characters))))
      (send canvas write
            (thing-get npc <span style="color:#e6db74">&#39;character</span>)
            (pt-x x/y)
            (pt-y x/y)
            (thing-get npc <span style="color:#e6db74">&#39;color</span>)))))</code></pre></div>
<p>That&rsquo;s the majorities of the changes for this week. What&rsquo;s left is checking if the player is dead, which we do in <code>game-screen%</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>

<span style="color:#75715e">; Process keyboard events</span>
(<span style="color:#66d9ef">define </span>game-over <span style="color:#66d9ef">#f</span>)
(define/override (update key-event)
  (cond
    [game-over (new game-screen%)]
    [else
     <span style="color:#f92672">...</span>

     <span style="color:#75715e">; Check if the player is dead</span>
     <span style="color:#75715e">; If so, tell the player they lost</span>
     <span style="color:#75715e">; Otherwise, keep on the current screen</span>
     (when (&lt;= (thing-get player <span style="color:#e6db74">&#39;health</span>) <span style="color:#ae81ff">0</span>)
       (send world log <span style="color:#e6db74">&#34;You lose!&#34;</span>)
       (send world log <span style="color:#e6db74">&#34;Press any key to continue.&#34;</span>)
       (<span style="color:#66d9ef">set! </span>game-over <span style="color:#66d9ef">#t</span>))

     this]))</code></pre></div>
<p>What this does is check for a game over and then run for one more update so that the player can read the game over message. Then it creates an entirely new game and throws you right back into the fun. The beauty of it all is that everything we had before should all be garbage collected now. That&rsquo;s the fun of not having to manually manage memory. 😄</p>

<p>Finally, the logging functionality. Optimally, this should be in <code>game-screen%</code>, but a <code>world%</code> doesn&rsquo;t know about the <code>game-screen%</code> so this is non-trivial to hook up. So <code>world%</code> handles the logging and <code>game-screen%</code> asks it for new messages when it updates.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

<span style="color:#75715e">; Log messages to display to the player</span>
(<span style="color:#66d9ef">define </span>log-messages <span style="color:#f92672">&#39;</span>())

(define/public (log msg)
  (<span style="color:#66d9ef">set! </span>log-messages (cons msg log-messages)))

(define/public (get-log [count <span style="color:#ae81ff">1</span>])
  (<span style="color:#66d9ef">let </span>loop ([i <span style="color:#ae81ff">0</span>] [msgs log-messages])
    (cond
      [(= i count) <span style="color:#f92672">&#39;</span>()]
      [(null? msgs) (cons <span style="color:#e6db74">&#34;&#34;</span> (loop (+ i <span style="color:#ae81ff">1</span>) msgs))]
      [else
       (cons (car msgs)
             (loop (+ i <span style="color:#ae81ff">1</span>) (cdr msgs)))])))

<span style="color:#75715e">; game-screen.rkt</span>

<span style="color:#75715e">; Draw recent log messages</span>
(for ([i (in-naturals)]
      [msg (in-list (send world get-log <span style="color:#ae81ff">3</span>))])
  (send canvas write-string
        msg
        <span style="color:#ae81ff">1</span> (- (send canvas get-height-in-characters) i <span style="color:#ae81ff">2</span>)
        <span style="color:#e6db74">&#34;green&#34;</span>))</code></pre></div>
<p>And that&rsquo;s everything. Perhaps we should get some screenshots? Because screenshots are cool<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>.</p>

<figure>
    <img src="/embeds/2013/1-starting-out.png"/> 
</figure>


<p>First, we&rsquo;re just starting out. The caves look much the same (as they should), but now we have a bunch of ratty buddies just sort of hanging out. Since we have a 1% chance per newly generated tile and the map is originally 960 tiles (and a little more than half full) we might expect about 5 rats. I count three and there might be another hidden under the text in the top left, so everything seems good to go.</p>

<figure>
    <img src="/embeds/2013/2-rat-hunting.png"/> 
</figure>


<p>Now we&rsquo;re chasing down a rat. We don&rsquo;t have any AI yet, so they&rsquo;re remarkably dumb. That&rsquo;s the goal for next week, to have monsters that will either run away from you (as the rats will probably do) or chase you down. This should be one of the more interesting parts of the project.</p>

<figure>
    <img src="/embeds/2013/3-attack.png"/> 
</figure>


<p>We&rsquo;ve finally managed to see some real damage here. Interestingly, the monsters can attack each other. I didn&rsquo;t intentionally plan for this, I just didn&rsquo;t put in any code that will prevent it. The AI should be smart enough eventually to avoid it, but I think having it as an option is pretty nice. Also, since the rats have equal attack and defense more often than not we shouldn&rsquo;t see any damage.</p>

<figure>
    <img src="/embeds/2013/4-one-down.png"/> 
</figure>


<p>Bam. Dead rat. The nice thing is that any NPCs that are killed are removed from the NPC list, so that should help both with efficiency and error checking.</p>

<figure>
    <img src="/embeds/2013/5-they-keep-coming.png"/> 
</figure>


<p>We&rsquo;re starting to get a bit more afield and there&rsquo;s just more and more rats. We got another one here, but there are four more just waiting for us.</p>

<figure>
    <img src="/embeds/2013/6-doom.png"/> 
</figure>


<p>And finally, the game over screen. I had to add another monster type (the <code>doom</code>) that had a higher attack to actually kill the player in any reasonable amount of time. The rats are just too weak. That&rsquo;s definitaly a topic for a later article&ndash;how do you balance all of this?</p>

<p>And there you have it. Week 3 of writing a roguelike in Racket.</p>

<p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:
- <a href="https://github.com/jpverkamp/racket-roguelike/tree/day-3" title="Racket Roguelike on GitHub">Racket Roguelike - Day 3</a>
- <a href="https://github.com/jpverkamp/racket-roguelike" title="Racket Roguelike on GitHub">Racket Roguelike - Up to date</a></p>

<p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-3
git submodule init
git submodule update
racket main.rkt</code></pre></div>
<p><strong>Edit:</strong></p>

<p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">raco pkg install github://github.com:jpverkamp/ascii-canvas/master
raco pkg install github://github.com:jpverkamp/noise/master
raco pkg install github://github.com:jpverkamp/thing/master
git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-3
racket main.rkt</code></pre></div>
<p>If you already have the code, you&rsquo;ll still have to <code>init</code> and <code>update</code> the submodules since I added a third one. Theoretically, I should be using <a href="http://planet.racket-lang.org/">PLaneT</a> for this instead, but that&rsquo;s something to put off for another day.</p>

<p>For part 4, click here: <a href="https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/">Racket Roguelike 4: Slightly smarter critters!</a></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">I may or may not have been watching Doctor Who for the last few hours&hellip;
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div></div>
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Racket Roguelike 3: Rats, rats, everywhere!";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2013\/04\/18\/racket-roguelike-3-rats-rats-everywhere\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div></article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>
</body>
</html>

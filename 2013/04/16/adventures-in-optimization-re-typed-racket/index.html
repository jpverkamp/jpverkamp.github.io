<!doctype html><html><head><title>Adventures in optimization, re: Typed Racket â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet><link rel=stylesheet href=/custom.css defer><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Adventures in optimization, re: Typed Racket</h1><div class=entry-meta><span class=entry-date>2013-04-16</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2013/06/26/swap-list-nodes/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/graphics>Graphics</a><a href=https://blog.jverkamp.com/2013/11/30/twitter-puddle/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/mathematics>Mathematics</a><a href=https://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/noise>Noise</a><a href=https://blog.jverkamp.com/2016/12/13/aoc-2016-day-13-noisy-puzzle/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/optimization>Optimization</a><a href=https://blog.jverkamp.com/2014/12/23/palette-swapping/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/type-systems>Type Systems</a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/04/18/a-prototype-object-system-for-racket/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Last Thursday I wrote a <a href=https://blog.jverkamp.com/2013/04/11/perlin-and-simplex-noise-in-racket/>post about generating Perlin/simplex noise</a> in Racket. Later that day, I <a title="[racket] Perlin and simplex noise - optimizing Racket code" href=http://lists.racket-lang.org/users/archive/2013-April/057245.html>posted to the Racket mailing list</a> asking how I could make it faster. What resulted was a whole sequence of responses (primarily about Typed Racket) and a bit of a rabbit hole that I&rsquo;m still trying to wrap my head around.</p><p>The first version that I tried to run was the original untyped code which used the <code><a href="http://docs.racket-lang.org/search/index.html?q=picturing-programs">picturing-programs</a></code>
Â teachpack to generate an image. Running Racket 5.3.3 on an x86_64 Linux machine, here are the timing results (if you&rsquo;d like to try itÂ yourself, use <a href=https://github.com/jpverkamp/noise/tree/b2d12e4>git b2d12e4</a>):</p><pre tabindex=0><code> perlin: cpu time: 355 real time: 356 gc time: 40
simplex: cpu time: 243 real time: 242 gc time: 4
</code></pre><p>That&rsquo;s actually much better than I originally got on my 64-bit Windows 7 machine, despite a slightly faster CPU from the same year. I&rsquo;m still not sure sure why that&rsquo;s the case.</p><p>But that&rsquo;s not what I&rsquo;m interested in at the moment. ðŸ˜„ What&rsquo;s more interesting right now is when I started trying to optimize things.</p><p>Based on the first few emails, the way to go seemed to convert my code to Typed Racket. So the first thing that I did was to swap out the <code>#lang</code> line from <code>#lang racket</code> to <code>#lang typed/racket</code>. Of course when I did that, all hell broke loose with page upon page of errors of the sort:</p><pre style=color:red>Type Checker: Expected Real, but got Any in: x
Type Checker: Expected Vector, but got Any in: g
Type Checker: Expected Number, but got Any in: x
Type Checker: Expected Vector, but got Any in: g
...</pre><p>Yeah&mldr; Basically Racket is telling me that it knows I&rsquo;m trying, but I&rsquo;m going to have to give it a few more (read: any) types before it can help me.</p><p>So I go through and I start typing<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> things. One caveat is that there are at least two ways to assign a type to things in Typed Racket. Either you can declare the types inline, using forms like <code>define:</code> and <code>let:</code> or you can keep the code as it was and add the type signatures with just <code>:</code>.</p><p>As an example, the definition of <code>grad3</code>Â could be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; using inline types</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define:</span> (<span style=color:#a6e22e>grad3</span> : (<span style=color:#a6e22e>Vectorof</span> (<span style=color:#a6e22e>Vectorof</span> Integer)))
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#39;#</span>(<span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>     <span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>) 
</span></span><span style=display:flex><span>     <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>-1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>-1</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; using type annotations</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>:</span> grad3 (<span style=color:#a6e22e>Vectorof</span> (<span style=color:#a6e22e>Vectorof</span> Integer)))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>grad3
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#39;#</span>(<span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>     <span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>) <span style=color:#f92672>#</span>(<span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>) 
</span></span><span style=display:flex><span>     <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>-1</span>) <span style=color:#f92672>#</span>( <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>-1</span>)))
</span></span></code></pre></div><p>Since the only other experience I had with something like this was in Haskell, the latter seemed more natural to me. I later <a href=http://lists.racket-lang.org/users/archive/2013-April/057256.html>asked</a> on the mailing list and <a href=http://lists.racket-lang.org/users/archive/2013-April/057263.html>the answer</a> was basically that either is perfectly valid.</p><p>Going through the rest of the code and adding types was rather straightÂ forward. I knew from previous (minimal) optimization experience in Racket that using <code>Flonum</code> was probably what I wanted to do, so everything essentially became either <code>Integer</code> or <code>Flonum</code>. The mostÂ interestingÂ / relevant type is probably that of the <code>perlin</code> function itself (<code>simplex</code> has the same type):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>:</span> perlin
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>case-&gt;</span> (<span style=color:#a6e22e>Flonum</span> -&gt; Flonum)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>Flonum</span> Flonum -&gt; Flonum)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>Flonum</span> Flonum Flonum -&gt; Flonum)))
</span></span></code></pre></div><p>This is a bit ugly, but essentially what it&rsquo;s saying is that <code>perlin</code> can have multiple types for each of the optional arguments, but it always takes in <code>Flonum</code>s and returns a <code>Flonum</code>. It doesn&rsquo;t seem like there&rsquo;s a way to directly specify optional parameters in Typed Racket (yet), but for the time being, <code>case-></code> gets the job done well enough.</p><p>In addition, we had to add in a bunch of types within the <code>perlin</code>/<code>simplex</code> functions. I probably added more than I needed to, typing every variable that I had, but I figured that if I had to type any of them I might as well go all of the way. So throughout the function, I have lines like these:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>:</span> gi000 Integer) (<span style=color:#a6e22e>:</span> gi001 Integer) (<span style=color:#a6e22e>:</span> gi010 Integer) (<span style=color:#a6e22e>:</span> gi011 Integer)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>:</span> gi100 Integer) (<span style=color:#a6e22e>:</span> gi101 Integer) (<span style=color:#a6e22e>:</span> gi110 Integer) (<span style=color:#a6e22e>:</span> gi111 Integer)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>:</span> n000 Flonum) (<span style=color:#a6e22e>:</span> n001 Flonum) (<span style=color:#a6e22e>:</span> n010 Flonum) (<span style=color:#a6e22e>:</span> n011 Flonum)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>:</span> n100 Flonum) (<span style=color:#a6e22e>:</span> n101 Flonum) (<span style=color:#a6e22e>:</span> n110 Flonum) (<span style=color:#a6e22e>:</span> n111 Flonum)
</span></span></code></pre></div><p>Not particularly pretty, but not too painful either.</p><p>What did get annoying however was after I had everything typed and I still got this particularly pleasant error:</p><pre style=color:red>Type Checker: No function domains matched in function application:
Domains: Flonum Flonum Flonum
         Flonum Flonum
         Flonum
Arguments: Zero</pre><p>It turns out that Racket knows that zero times anything is zero. The problem is that zero times anything is exactly 0, the real, exact, integer version of the number (Actually it has it&rsquo;s own type: <code>Zero</code>). But that&rsquo;s not what we&rsquo;re looking for, we&rsquo;re looking for a <code>Flonum</code>. I could work around it using either the function <code>exact->inexact</code>Â or the function <code>real->double-flonum</code>, but both of those had to be applied in the code using <code>perlin</code>, leaking the implementation details in a rather unsatisfactory way (since I can imagine that many if not all uses of noise would eventually use the point 0, 0).</p><p>Still, it was enough for a first try. I don&rsquo;t have timing results for this on the same machine as the rest, but if you&rsquo;d like to try it out, you can get the code using <a href=https://github.com/jpverkamp/noise/tree/f33f6d7>gitÂ f33f6d7</a>.</p><p>About this time, I got <a href=http://lists.racket-lang.org/users/archive/2013-April/057255.html>another email</a> back that detailed essentially what I&rsquo;d been trying to do, only they had a few tricks that I hadn&rsquo;t been able to find by myself. Specifically:</p><ul><li><a href=http://pre.racket-lang.org/docs/html/images/flomap_title.html>images/flomap</a> has a faster (typed) image generator (<code><a href="http://docs.racket-lang.org/search/index.html?q=build-flomap*">build-flomap*</a></code>
) than <code><a href="http://docs.racket-lang.org/search/index.html?q=picturing-programs">picturing-programs</a></code></li><li><code>case-></code> slows down typechecking (but has no effect on runtime)</li><li><a href=http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._exact-floor))>exact-floor</a> is far faster than using <code><a href="http://docs.racket-lang.org/search/index.html?q=inexact-%3eexact">inexact->exact</a></code>
and <code><a href="http://docs.racket-lang.org/search/index.html?q=floor">floor</a></code></li><li>shadowing (rather than <code>set!</code>) should allow for better optimization, especially with floating point numbers</li><li><code>Real</code> can be used as the type for <code>Real</code> numbers, including the <code>Zero</code> that was causing so much trouble</li></ul><p>Using all of that, I set about a second round of optimizations. Primarily, since Real allowed for <code>Zero</code>, I converted every <code>Flonum</code> to <code>Real</code>, along with the rest of the previously specified changes. Here are the timing results using the typed code using Real for the numerics and generating an image using theÂ <a href=http://pre.racket-lang.org/docs/html/images/flomap_title.html data-pltdoc=x>images/flomap</a>Â library. Between the two of them, we got a substantial boost for both Perlin and simplex noise (<a href=https://github.com/jpverkamp/noise/tree/006faf9>git 006faf9</a>):</p><pre tabindex=0><code> perlin: cpu time: 235 real time: 236 gc time: 15
simplex: cpu time: 147 real time: 147 gc time: 4
</code></pre><p>Overall, it&rsquo;s about 2x faster than the original code, and all for just adding the type annotations.</p><p>The next step suggested to me was to use Racket&rsquo;s <code><a href="http://docs.racket-lang.org/search/index.html?q=Optimization%20Coach">Optimization Coach</a></code>
. Essentially, it&rsquo;s a tool built into DrRacket for use with Typed Racket that will color code your code based on how successful the compiler will be on optimizing your functions. Specifically, it will be green if it can manage to inline your code and avoid boxing/unboxing values and also apply floating point specific functions (where necessary).</p><p>The problem was, running through the code I had, there was a heck of a lot of red&mldr; Running through my code, there was a heck of a lot of red:</p><figure><img src=/embeds/2013/optimization-errors.png></figure><p>Drilling down into the errors (it took a while to realize that right clicking would give more detail), it eventually turned out that converting from <code>Flonum</code> to <code>Real</code> was actually <em>causing</em> more errors than it was solving. Since <code>Real</code> is more generic and includes <code>Integer</code>s as well as <code>Flonum</code>s, it wasn&rsquo;t possible for the compiler to use pure floating point functions although we both knew it wanted to. So back to <code>Flonum</code> we went!<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p>Actually, no. I&rsquo;m not really sure why, but at this point, I decided that I liked <code>Float</code> better than <code>Flonum</code>. It turns out that the two are essentially aliases for one another (which doesn&rsquo;t help when it&rsquo;s not consistent which will appear in error messages), so I could have used either. In the end, I switched to <code>Float</code> though. I think it was mostly because of experience with other languages. <code>Float</code> is a common term, <code>Flonum</code> is less so.</p><p>In any case, my next pass was to turn <code>Real</code>Â <em>back into</em> <code>Float</code>. So it goes. This time though, I made one tweak that would allow the best of both worlds:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>:</span> perlin (<span style=color:#a6e22e>case-&gt;</span> (<span style=color:#a6e22e>Real</span> -&gt; Float)
</span></span><span style=display:flex><span>                  (<span style=color:#a6e22e>Real</span> Real -&gt; Float)
</span></span><span style=display:flex><span>                  (<span style=color:#a6e22e>Real</span> Real Real -&gt; Float)))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>perlin</span> x [y <span style=color:#ae81ff>0.0</span>] [z <span style=color:#ae81ff>0.0</span>])
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>perlin^</span> (<span style=color:#a6e22e>real-&gt;double-flonum</span> x)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>real-&gt;double-flonum</span> y)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>real-&gt;double-flonum</span> z)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>:</span> perlin^ (<span style=color:#a6e22e>Float</span> Float Float -&gt; Float))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>perlin^</span> x y z)
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>)
</span></span></code></pre></div><p>Since I was would only <code>provide</code> <code>perlin</code>, not <code>perlin^</code><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>, I could have a function that accepted any real number but internally use <code>Floats</code> for all of my types.</p><p>I ran the Optimization Coach again and the results were beautiful:</p><figure><img src=/embeds/2013/optimization-better.png></figure><p>Green, beautiful green. I knew there was a reason it was my favorite color. Better yet, all that green is telling me that the compiler should (theoretically) be able to eek out even more speed, yes? Well, here are the timing results for using <code>Float</code> instead of <code>Real</code> and writing the aforementioned wrapper to convert between the two.</p><pre tabindex=0><code> perlin: cpu time: 112 real time: 118 gc time: 23
simplex: cpu time: 106 real time: 110 gc time: 3
</code></pre><p>Yes! More speed!Â We&rsquo;re down to about 1/10th of a second for 65,536 calls to either function. That&rsquo;s none too shabby.</p><p>But finally, I wanted to test how much of that was overhead in generating the image and how much was actually the noise algorithms. So I just wrote a simple nestedÂ <code>for</code> loop to generate the 256x256 calls to Perlin/simplex. At first it was slower. It turns out that even that had to be typed otherwise the untyped Racket code would eat up any meager benefits I&rsquo;d gained. So I added types to my simple test bench as well. Here are the results (<a href=https://github.com/jpverkamp/noise/tree/7445311>gitÂ 7445311</a>):</p><pre tabindex=0><code> perlin: cpu time: 41 real time: 40 gc time: 0
simplex: cpu time: 52 real time: 52 gc time: 2
</code></pre><p>That&rsquo;s none too shabby at all. Actually, if you compare it to theÂ <a title="PDF describing Perlin and simplex noise" href=http://webstaff.itn.liu.se/~stegu/simplexnoise/simplexnoise.pdf>original algorithm</a>Â my code is based on (written in Java, not C as I originally stated) it&rsquo;s well within the same order of magnitude. In the Java code, without generating an image, generating a 256x256 simplex grid takes an average of 30 ms.</p><p>All things considered, I&rsquo;m pretty happy with my results. It is mildly puzzling that up until the very final test case the results for Perlin are always slower than simplex (which is to be expected given the relative runtimes of theÂ algorithms<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>)Â , but in the last case they&rsquo;re exactly the same. If anyone has a good reason for why that might be, I&rsquo;d love to hear it.</p><p>Well, that&rsquo;s all I have. Working with Typed Racket was actually a surprisingly pleasant experience. It reminded me of all of the better parts of <a title=Haskell href=http://www.haskell.org/haskellwiki/Haskell>Haskell</a>, where you can add type annotations to make the compiler work with you rather than against you.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Whee typing vs typing&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>This is all actually mentioned in the Racket <code><a href="http://docs.racket-lang.org/search/index.html?q=documentation%20on%20optimization">documentation on optimization</a></code>
.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Sorry Suzanne, but the hats must live on&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><em>O(n!)</em> for Perlin and <em>O(n<sup>2</sup>)</em> for simplex, where <em>n</em> is the number of dimensions if I understand correctly&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script defer>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script><script defer src=/custom.js></script></body></html>
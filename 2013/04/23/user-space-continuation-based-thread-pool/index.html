<!doctype html><html><head><title>User space continuation-based thread pool â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>User space continuation-based thread pool</h1><div class=entry-meta><span class=entry-date>2013-04-23</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a class=taxonomy-value href=/programming/topics/concurrency>Concurrency</a><a href=https://blog.jverkamp.com/2014/02/16/exploring-parallelism-in-racket-with-sha-512-mining/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/continuations>Continuations</a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/04/25/oblivion/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>I&rsquo;m perhaps a little late to last week&rsquo;sÂ <a title="Reddit: DailyProgrammer" href=http://www.reddit.com/r/dailyprogrammer/>DailyProgrammer</a>Â challenge to <a title="[04/01/13] Challenge #122 [Intermediate] User-Space Threading" href=http://www.reddit.com/r/dailyprogrammer/comments/1ceai7/040113_challenge_122_intermediate_userspace/>implement a user-space threading system</a>, without using any sort of built in thread library, but it just sounded too interesting to pass up.</p><p>The full challenge states that we are to:</p><blockquote><p>Your goal is to implement an <em>efficient</em> and <em>dynamic</em> user-level threading library. You may implement this in any language and on any platform, but you may not use any existing threading code or implementation, such as the Win32 threading code or the UNIX pthreads lib. You may call system functions (such as interrupts and signals), but again cannot defer any thread-specific work to the operating system.</p></blockquote><p>The only two solutions posted thus far use <a title="JavaScript solution" href=http://www.reddit.com/r/dailyprogrammer/comments/1ceai7/040113_challenge_122_intermediate_userspace/c9foc4n>JavaScript&rsquo;s setTimeout method</a> (which arguably is already thread specific functionality) or <a title="Haskell solution" href=http://www.reddit.com/r/dailyprogrammer/comments/1ceai7/040113_challenge_122_intermediate_userspace/c9g27et>Haskell and the &lsquo;free&rsquo; monad</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. For a bit of variety, I&rsquo;ll be using <a href=https://en.wikipedia.org/wiki/continuations>continuations</a>, essentially to implementÂ <a href=https://en.wikipedia.org/wiki/coroutines>coroutines</a>Â with manual scheduling.</p><p>Before we get started, if you&rsquo;d like to follow along, you can do so here:</p><ul><li><a href=https://github.com/jpverkamp/small-projects/blob/master/blog/continuation-thread-pool.rkt>continuation thread pool on GitHub</a></li></ul><p>That being said, essentially, we need two methods:</p><ul><li><code>(threads thunk ...)</code> - takes a series of thunks and runs them in parallel</li><li><code>(yield)</code> - within a thread, turns over control to the next thread in the pool</li></ul><p>Even before that, we&rsquo;re going to want a bit of structure. First, we&rsquo;ll wrap the thread data up in a structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Store the current state of a thread</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-struct</span> thread-state (<span style=color:#a6e22e>continuation</span>) <span style=color:#f92672>#</span>:mutable)
</span></span></code></pre></div><p>All that we&rsquo;re going to save is a continuation. If you haven&rsquo;t looked into continuations, the essential idea is that it&rsquo;s a function that wraps up &rsquo;everything that you need to do next&rsquo; if you were to suspend the current execution of the function. For example (using <code>call/cc</code> as the alias for <code>call-with-current-continuation</code> to capture the continuation):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (+ <span style=color:#ae81ff>1</span> (call/cc (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>k</span>) (+ <span style=color:#ae81ff>2</span> (<span style=color:#a6e22e>k</span> <span style=color:#ae81ff>3</span>)))))
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>
</span></span></code></pre></div><p>Why this works is that <code>call/cc</code> captures <code>(+ 1 ...)</code> as a function. We then later apply that function to 3 for the result of 4, completely ignoring the <code>(+ 2 ...)</code> part. If that makes sense, great! If not&mldr; well, perhaps you should read up a bit more on continuations&mldr; They&rsquo;re an amazingly powerful construct that allows for some remarkably powerful control flow structures. In this case, just know that we can always treat them as a function which can suspend control and later to call it with what we want it to return.</p><p>So essentially, we&rsquo;re going to set up each <code>thread-state</code> with a psuedo-continuation. But we&rsquo;ll get to that in a second. We still haven&rsquo;t set up the data structure for the <code>thread-pool</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Store a collection of threads in a pool</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-struct</span> thread-pool (<span style=color:#a6e22e>all</span> current switch-count) <span style=color:#f92672>#</span>:mutable)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Create a new, empty thread pool</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>make-empty-thread-pool</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>make-thread-pool</span> <span style=color:#f92672>&#39;</span>() <span style=color:#f92672>&#39;</span>() <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Allow for multiple thread pools</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>current-thread-pool 
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>make-parameter</span> (<span style=color:#a6e22e>make-empty-thread-pool</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Get the number of context switches out of the current thread pool</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-switch-count</span> [pool (<span style=color:#a6e22e>current-thread-pool</span>)])
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>thread-pool-switch-count</span> pool))
</span></span></code></pre></div><p>The <code>switch-count</code> isn&rsquo;t strictly necessary, but it will allow us to do some amount of performance evaluation when all is said and done. Other than that, <code>all</code> will hold a list of all of the threads that we&rsquo;re dealing with while <code>current</code> is that same list only advanced to the currently executing thread. So we&rsquo;re not doing anything fancy with thread priorities, although we could easily do so by replacing <code>current</code> with a <a href=https://en.wikipedia.org/wiki/priority%20queue>priority queue</a> rather than a simple list<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>So how do we do all of that? Well, here is <code>threads</code> to create the initial state:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Run a given list of thunks in parallel</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>threads</span> <span style=color:#f92672>.</span> thunks)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>call-with-current-continuation</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>when</span> (null? thunks) (<span style=color:#a6e22e>error</span> <span style=color:#e6db74>&#39;threads</span> <span style=color:#e6db74>&#34;must specify at least one thread&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Unwrap the current pool</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>define </span>pool (<span style=color:#a6e22e>current-thread-pool</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Create the initial thread states</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>define </span>threads
</span></span><span style=display:flex><span>       (map 
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>thunk</span>) (<span style=color:#a6e22e>thread-state</span> (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>_</span>) (<span style=color:#a6e22e>k</span> (<span style=color:#a6e22e>thunk</span>)))))
</span></span><span style=display:flex><span>        thunks))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Store them in the pool</span>
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>set-thread-pool-current!</span> pool (append (<span style=color:#a6e22e>thread-pool-current</span> pool) threads))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>set-thread-pool-all!</span> pool (append (<span style=color:#a6e22e>thread-pool-all</span> pool) threads))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Start the first thread</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>define </span>first-k (<span style=color:#a6e22e>thread-state-continuation</span> (car (<span style=color:#a6e22e>thread-pool-current</span> pool))))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>first-k</span> (<span style=color:#a6e22e>void</span>)))))
</span></span></code></pre></div><p>So basically, we get a thread pool (I&rsquo;ll show you some of the advantages of doing it this way later), create the threads, store them in the thread pool structure, and start the first thread. Everything should be good to go.</p><p>(There&rsquo;s also a sneaky part there where we capture the continuation immediately and us it in each thread. I&rsquo;ll get to that too later.)</p><p>But for everything to work, we also need <code>yield</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Yield control of the current thread to the next thread in the current pool</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>yield</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>call-with-current-continuation</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Unwrap the current pool</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>define </span>pool (<span style=color:#a6e22e>current-thread-pool</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Store the current thread state</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>define </span>thread (car (<span style=color:#a6e22e>thread-pool-current</span> pool)))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>set-thread-state-continuation!</span> thread k)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Advance to the next thread</span>
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>set-thread-pool-current!</span> pool (cdr (<span style=color:#a6e22e>thread-pool-current</span> pool)))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>when</span> (null? (<span style=color:#a6e22e>thread-pool-current</span> pool))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>set-thread-pool-current!</span> pool (<span style=color:#a6e22e>thread-pool-all</span> pool)))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>set-thread-pool-switch-count!</span> pool (+ <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>thread-pool-switch-count</span> pool)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Run that thread</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>define </span>next-k (<span style=color:#a6e22e>thread-state-continuation</span> (car (<span style=color:#a6e22e>thread-pool-current</span> pool))))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>next-k</span> (<span style=color:#a6e22e>void</span>)))))
</span></span></code></pre></div><p>When it is first called, this will capture the continuation for the current thread. The first step that it will do when unwrapping is return from the <code>yield</code> itself, but after that it will hand control back to the other, previous continuations. This is then stored in the first (running) thread&rsquo;s <code>thread-state</code> and then the <code>thread-pool</code> is advanced to the next <code>thread</code>, which is then run just as the first was started in <code>threads</code>.</p><p>So how can we use something like that? Well, let&rsquo;s implement the fairly standard &rsquo;tick tock&rsquo; test for threads:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>tick-tock-test</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>parameterize</span> ([current-thread-pool (<span style=color:#a6e22e>make-empty-thread-pool</span>)])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>threads</span> 
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Keep printing tick</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>lambda </span>()
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;tick\n&#34;</span>)
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>yield</span>)
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>loop</span>)))
</span></span><span style=display:flex><span>     <span style=color:#75715e>; Keep printing tock</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>lambda </span>()
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;tock\n&#34;</span>)
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>yield</span>)
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>loop</span>))))))
</span></span></code></pre></div><p>Run it<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> and you should see something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>tick-tock-test</span>)
</span></span><span style=display:flex><span>tick
</span></span><span style=display:flex><span>tock
</span></span><span style=display:flex><span>tick
</span></span><span style=display:flex><span>tock
</span></span><span style=display:flex><span>tick
</span></span><span style=display:flex><span>tock
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Exactly what we were looking for. But the real strength comes in when you try to do some more interesting examples. For example, let&rsquo;s calculate Fibonacci values in parallel. Remember when I mentioned capturing a continuation in <code>threads</code>? This is when it comes in handy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fibonacci-test</span>)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fib</span> n)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>yield</span>)
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>if </span>(&lt;= n <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          (+ (<span style=color:#a6e22e>fib</span> (- n <span style=color:#ae81ff>1</span>)) (<span style=color:#a6e22e>fib</span> (- n <span style=color:#ae81ff>2</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>parameterize</span> ([current-thread-pool (<span style=color:#a6e22e>make-empty-thread-pool</span>)])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>threads</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>lambda </span>() (list <span style=color:#ae81ff>20</span> (<span style=color:#a6e22e>fib</span> <span style=color:#ae81ff>20</span>)))
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>lambda </span>() (list <span style=color:#ae81ff>10</span> (<span style=color:#a6e22e>fib</span> <span style=color:#ae81ff>10</span>))))))
</span></span></code></pre></div><p>Take a moment and guess what you think that should do.</p><p>In traditional threads, it wouldn&rsquo;t do anything, since threads don&rsquo;t generally return anything. But in this case, the threads have a continuation that will return from <code>threads</code> (the initial one we captured). So whichever thread returns first (and finally gets back to that original continuation) will return a value. So if we test it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fibonacci-test</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&#39;</span>(<span style=color:#ae81ff>10</span> <span style=color:#ae81ff>89</span>)
</span></span></code></pre></div><p>So essentially, we&rsquo;ve implemented the <code>amb</code> operator first described back in a variation on McCarthyâ€™s amb operator for ambiguous choice<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>. It may not be exactly what you&rsquo;re looking for in a threading system, but if that&rsquo;s the case, you can always use a different one. ðŸ˜„ More seriously, if you don&rsquo;t want the <code>thread-pool</code> to exit when the first thread has a value, just don&rsquo;t return.</p><p>As our next test, let&rsquo;s figure out just how efficient it is<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. So we&rsquo;ll use the <code>switch-count</code> functionality we built in earlier:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>timing-test</span>)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>iterations <span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>parameterize</span> ([current-thread-pool (<span style=color:#a6e22e>make-empty-thread-pool</span>)])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>time</span>
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>threads</span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>lambda </span>() 
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>let </span>loop ([i <span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>when</span> (&lt; i iterations)
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>yield</span>)
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>loop</span> (+ i <span style=color:#ae81ff>1</span>)))))))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;~a context switches (target: ~a)\n&#34;</span> 
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>get-switch-count</span>)
</span></span><span style=display:flex><span>            iterations)))
</span></span></code></pre></div><p>So how long does it take to do 1 million switches?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>timing-test</span>)
</span></span><span style=display:flex><span>cpu time: <span style=color:#ae81ff>9479</span> real time: <span style=color:#ae81ff>10969</span> gc time: <span style=color:#ae81ff>2489</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1000000</span> context switches (<span style=color:#a6e22e>target:</span> <span style=color:#ae81ff>1000000</span>)
</span></span></code></pre></div><p>Honestly, that&rsquo;s pretty terrible for a threading system. That works out to ~10 ms per context switch and we&rsquo;re not even doing any other work as of yet. As we found out in a <a href=https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/>previous optimization post</a>, we can do a heck of a lot of relatively complex mathematics in 20 ms, so perhaps we can do better?</p><p>Well, the main problem is the overhead involved in continuations, so we really can&rsquo;t. Each time we use <code>call-with-current-continuation</code>, we have to copy the entire stack and any variables so that we can resume the state. Every time we use it, we have to make another copy, just in case we want to resume that same continuation more than once (it&rsquo;s really quite a powerful construct). There are forms of continuations that we could use instead, limiting either how much we have to remember or how often we can reset to that point, but that&rsquo;s beyond the scope of this post. Perhaps another day.</p><p>If you&rsquo;d like to see all of the code in one place, you can do so here:</p><ul><li><a href=https://github.com/jpverkamp/small-projects/blob/master/blog/continuation-thread-pool.rkt>continuation thread pool on GitHub</a></li></ul><p>That code also contains a series of <code>(module+ test ...)</code> blocks, each of which can be run with <code>raco test continuation-thread-pool.rkt</code>. That&rsquo;s such nice functionality, it&rsquo;s a shame I&rsquo;m just finding out about it now.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I still stand by the saying that <a href=https://en.wikipedia.org/wiki/Monad>monads</a> are black magic&mldr;&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Actually, just replacing the list with a queue would remove the need for both data structures since we could take threads from one end and push them on the other. But queues aren&rsquo;t built in to most Schemes.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>And immediately break it, because infinite loop&mldr;&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>John McCarthy. A Basis for a Mathematical Theory of Computation. In <em>Computer Programming And Formal Systems</em> by P. Braffort and D. Hirschberg (Ed.), 1963.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>That was one of the original requirements after all.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!DOCTYPE html>
<html>
<head>
    <title>
    User space continuation-based thread pool â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">User space continuation-based thread pool</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2013-04-23</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/programming/topics/concurrency">Concurrency</a>
                        <a href="https://blog.jverkamp.com/2014/02/16/exploring-parallelism-in-racket-with-sha-512-mining/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/programming/topics/continuations">Continuations</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/04/25/oblivion/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>I&rsquo;m perhaps a little late to last week&rsquo;sÂ <a title="Reddit: DailyProgrammer" href="http://www.reddit.com/r/dailyprogrammer/">DailyProgrammer</a>Â challenge to <a title="[04/01/13] Challenge #122 [Intermediate] User-Space Threading" href="http://www.reddit.com/r/dailyprogrammer/comments/1ceai7/040113_challenge_122_intermediate_userspace/">implement a user-space threading system</a>, without using any sort of built in thread library, but it just sounded too interesting to pass up.</p>

<p></p>

<p>The full challenge states that we are to:</p>

<blockquote>
<p>Your goal is to implement an <em>efficient</em> and <em>dynamic</em> user-level threading library. You may implement this in any language and on any platform, but you may not use any existing threading code or implementation, such as the Win32 threading code or the UNIX pthreads lib. You may call system functions (such as interrupts and signals), but again cannot defer any thread-specific work to the operating system.</p>
</blockquote>

<p>The only two solutions posted thus far use <a title="JavaScript solution" href="http://www.reddit.com/r/dailyprogrammer/comments/1ceai7/040113_challenge_122_intermediate_userspace/c9foc4n">JavaScript&rsquo;s setTimeout method</a> (which arguably is already thread specific functionality) or <a title="Haskell solution" href="http://www.reddit.com/r/dailyprogrammer/comments/1ceai7/040113_challenge_122_intermediate_userspace/c9g27et">Haskell and the &lsquo;free&rsquo; monad</a><sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>. For a bit of variety, I&rsquo;ll be using <a href="https://en.wikipedia.org/wiki/continuations">continuations</a>, essentially to implementÂ <a href="https://en.wikipedia.org/wiki/coroutines">coroutines</a>Â with manual scheduling.</p>

<p>Before we get started, if you&rsquo;d like to follow along, you can do so here:
- <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/continuation-thread-pool.rkt">continuation thread pool on GitHub</a></p>

<p>That being said, essentially, we need two methods:</p>

<ul>
<li><code>(threads thunk ...)</code> - takes a series of thunks and runs them in parallel</li>
<li><code>(yield)</code> - within a thread, turns over control to the next thread in the pool</li>
</ul>

<p>Even before that, we&rsquo;re going to want a bit of structure. First, we&rsquo;ll wrap the thread data up in a structure:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Store the current state of a thread</span>
(define-struct thread-state (continuation) <span style="color:#f92672">#</span>:mutable)</code></pre></div>
<p>All that we&rsquo;re going to save is a continuation. If you haven&rsquo;t looked into continuations, the essential idea is that it&rsquo;s a function that wraps up &lsquo;everything that you need to do next&rsquo; if you were to suspend the current execution of the function. For example (using <code>call/cc</code> as the alias for <code>call-with-current-continuation</code> to capture the continuation):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (+ <span style="color:#ae81ff">1</span> (call/cc (<span style="color:#66d9ef">lambda </span>(k) (+ <span style="color:#ae81ff">2</span> (k <span style="color:#ae81ff">3</span>)))))
<span style="color:#ae81ff">4</span></code></pre></div>
<p>Why this works is that <code>call/cc</code> captures <code>(+ 1 ...)</code> as a function. We then later apply that function to 3 for the result of 4, completely ignoring the <code>(+ 2 ...)</code> part. If that makes sense, great! If not&hellip; well, perhaps you should read up a bit more on continuations&hellip; They&rsquo;re an amazingly powerful construct that allows for some remarkably powerful control flow structures. In this case, just know that we can always treat them as a function which can suspend control and later to call it with what we want it to return.</p>

<p>So essentially, we&rsquo;re going to set up each <code>thread-state</code> with a psuedo-continuation. But we&rsquo;ll get to that in a second. We still haven&rsquo;t set up the data structure for the <code>thread-pool</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Store a collection of threads in a pool</span>
(define-struct thread-pool (all current switch-count) <span style="color:#f92672">#</span>:mutable)

<span style="color:#75715e">; Create a new, empty thread pool</span>
(<span style="color:#66d9ef">define </span>(make-empty-thread-pool)
  (make-thread-pool <span style="color:#f92672">&#39;</span>() <span style="color:#f92672">&#39;</span>() <span style="color:#ae81ff">0</span>))

<span style="color:#75715e">; Allow for multiple thread pools</span>
(<span style="color:#66d9ef">define </span>current-thread-pool 
  (make-parameter (make-empty-thread-pool)))

<span style="color:#75715e">; Get the number of context switches out of the current thread pool</span>
(<span style="color:#66d9ef">define </span>(get-switch-count [pool (current-thread-pool)])
  (thread-pool-switch-count pool))</code></pre></div>
<p>The <code>switch-count</code> isn&rsquo;t strictly necessary, but it will allow us to do some amount of performance evaluation when all is said and done. Other than that, <code>all</code> will hold a list of all of the threads that we&rsquo;re dealing with while <code>current</code> is that same list only advanced to the currently executing thread. So we&rsquo;re not doing anything fancy with thread priorities, although we could easily do so by replacing <code>current</code> with a <a href="https://en.wikipedia.org/wiki/priority%20queue">priority queue</a> rather than a simple list<sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup>.</p>

<p>So how do we do all of that? Well, here is <code>threads</code> to create the initial state:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Run a given list of thunks in parallel</span>
(<span style="color:#66d9ef">define </span>(threads <span style="color:#f92672">.</span> thunks)
  (call-with-current-continuation
   (<span style="color:#66d9ef">lambda </span>(k)
     (when (null? thunks) (error <span style="color:#e6db74">&#39;threads</span> <span style="color:#e6db74">&#34;must specify at least one thread&#34;</span>))

     <span style="color:#75715e">; Unwrap the current pool</span>
     (<span style="color:#66d9ef">define </span>pool (current-thread-pool))

     <span style="color:#75715e">; Create the initial thread states</span>
     (<span style="color:#66d9ef">define </span>threads
       (map 
        (<span style="color:#66d9ef">lambda </span>(thunk) (thread-state (<span style="color:#66d9ef">lambda </span>(_) (k (thunk)))))
        thunks))

     <span style="color:#75715e">; Store them in the pool</span>
     (set-thread-pool-current! pool (append (thread-pool-current pool) threads))
     (set-thread-pool-all! pool (append (thread-pool-all pool) threads))

     <span style="color:#75715e">; Start the first thread</span>
     (<span style="color:#66d9ef">define </span>first-k (thread-state-continuation (car (thread-pool-current pool))))
     (first-k (void)))))</code></pre></div>
<p>So basically, we get a thread pool (I&rsquo;ll show you some of the advantages of doing it this way later), create the threads, store them in the thread pool structure, and start the first thread. Everything should be good to go.</p>

<p>(There&rsquo;s also a sneaky part there where we capture the continuation immediately and us it in each thread. I&rsquo;ll get to that too later.)</p>

<p>But for everything to work, we also need <code>yield</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Yield control of the current thread to the next thread in the current pool</span>
(<span style="color:#66d9ef">define </span>(yield)
  (call-with-current-continuation
   (<span style="color:#66d9ef">lambda </span>(k)
     <span style="color:#75715e">; Unwrap the current pool</span>
     (<span style="color:#66d9ef">define </span>pool (current-thread-pool))

     <span style="color:#75715e">; Store the current thread state</span>
     (<span style="color:#66d9ef">define </span>thread (car (thread-pool-current pool)))
     (set-thread-state-continuation! thread k)

     <span style="color:#75715e">; Advance to the next thread</span>
     (set-thread-pool-current! pool (cdr (thread-pool-current pool)))
     (when (null? (thread-pool-current pool))
       (set-thread-pool-current! pool (thread-pool-all pool)))
     (set-thread-pool-switch-count! pool (+ <span style="color:#ae81ff">1</span> (thread-pool-switch-count pool)))

     <span style="color:#75715e">; Run that thread</span>
     (<span style="color:#66d9ef">define </span>next-k (thread-state-continuation (car (thread-pool-current pool))))
     (next-k (void)))))</code></pre></div>
<p>When it is first called, this will capture the continuation for the current thread. The first step that it will do when unwrapping is return from the <code>yield</code> itself, but after that it will hand control back to the other, previous continuations. This is then stored in the first (running) thread&rsquo;s <code>thread-state</code> and then the <code>thread-pool</code> is advanced to the next <code>thread</code>, which is then run just as the first was started in <code>threads</code>.</p>

<p>So how can we use something like that? Well, let&rsquo;s implement the fairly standard &lsquo;tick tock&rsquo; test for threads:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#66d9ef">define </span>(tick-tock-test)
  (parameterize ([current-thread-pool (make-empty-thread-pool)])
    (threads 
     <span style="color:#75715e">; Keep printing tick</span>
     (<span style="color:#66d9ef">lambda </span>()
       (<span style="color:#66d9ef">let </span>loop ()
         (printf <span style="color:#e6db74">&#34;tick\n&#34;</span>)
         (yield)
         (loop)))
     <span style="color:#75715e">; Keep printing tock</span>
     (<span style="color:#66d9ef">lambda </span>()
       (<span style="color:#66d9ef">let </span>loop ()
         (printf <span style="color:#e6db74">&#34;tock\n&#34;</span>)
         (yield)
         (loop))))))</code></pre></div>
<p>Run it<sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup> and you should see something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (tick-tock-test)
tick
tock
tick
tock
tick
tock
<span style="color:#f92672">...</span></code></pre></div>
<p>Exactly what we were looking for. But the real strength comes in when you try to do some more interesting examples. For example, let&rsquo;s calculate Fibonacci values in parallel. Remember when I mentioned capturing a continuation in <code>threads</code>? This is when it comes in handy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#66d9ef">define </span>(fibonacci-test)
  (<span style="color:#66d9ef">define </span>(fib n)
      (yield)
      (<span style="color:#66d9ef">if </span>(&lt;= n <span style="color:#ae81ff">1</span>)
          <span style="color:#ae81ff">1</span>
          (+ (fib (- n <span style="color:#ae81ff">1</span>)) (fib (- n <span style="color:#ae81ff">2</span>)))))

  (parameterize ([current-thread-pool (make-empty-thread-pool)])
    (threads
     (<span style="color:#66d9ef">lambda </span>() (list <span style="color:#ae81ff">20</span> (fib <span style="color:#ae81ff">20</span>)))
     (<span style="color:#66d9ef">lambda </span>() (list <span style="color:#ae81ff">10</span> (fib <span style="color:#ae81ff">10</span>))))))</code></pre></div>
<p>Take a moment and guess what you think that should do.</p>

<p>In traditional threads, it wouldn&rsquo;t do anything, since threads don&rsquo;t generally return anything. But in this case, the threads have a continuation that will return from <code>threads</code> (the initial one we captured). So whichever thread returns first (and finally gets back to that original continuation) will return a value. So if we test it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fibonacci-test)
<span style="color:#f92672">&#39;</span>(<span style="color:#ae81ff">10</span> <span style="color:#ae81ff">89</span>)</code></pre></div>
<p>So essentially, we&rsquo;ve implemented the <code>amb</code> operator first described back in a variation on McCarthyâ€™s amb operator for ambiguous choice<sup class="footnote-ref" id="fnref:4"><a rel="footnote" href="#fn:4">4</a></sup>. It may not be exactly what you&rsquo;re looking for in a threading system, but if that&rsquo;s the case, you can always use a different one. ðŸ˜„ More seriously, if you don&rsquo;t want the <code>thread-pool</code> to exit when the first thread has a value, just don&rsquo;t return.</p>

<p>As our next test, let&rsquo;s figure out just how efficient it is<sup class="footnote-ref" id="fnref:5"><a rel="footnote" href="#fn:5">5</a></sup>. So we&rsquo;ll use the <code>switch-count</code> functionality we built in earlier:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#66d9ef">define </span>(timing-test)
  (<span style="color:#66d9ef">define </span>iterations <span style="color:#ae81ff">1000000</span>)

  (parameterize ([current-thread-pool (make-empty-thread-pool)])
    (time
     (threads
      (<span style="color:#66d9ef">lambda </span>() 
        (<span style="color:#66d9ef">let </span>loop ([i <span style="color:#ae81ff">0</span>])
          (when (&lt; i iterations)
            (yield)
            (loop (+ i <span style="color:#ae81ff">1</span>)))))))
    (printf <span style="color:#e6db74">&#34;~a context switches (target: ~a)\n&#34;</span> 
            (get-switch-count)
            iterations)))</code></pre></div>
<p>So how long does it take to do 1 million switches?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (timing-test)
cpu time: <span style="color:#ae81ff">9479</span> real time: <span style="color:#ae81ff">10969</span> gc time: <span style="color:#ae81ff">2489</span>
<span style="color:#ae81ff">1000000</span> context switches (target: <span style="color:#ae81ff">1000000</span>)</code></pre></div>
<p>Honestly, that&rsquo;s pretty terrible for a threading system. That works out to ~10 ms per context switch and we&rsquo;re not even doing any other work as of yet. As we found out in a <a href="https://blog.jverkamp.com/2013/04/16/adventures-in-optimization-re-typed-racket/">previous optimization post</a>, we can do a heck of a lot of relatively complex mathematics in 20 ms, so perhaps we can do better?</p>

<p>Well, the main problem is the overhead involved in continuations, so we really can&rsquo;t. Each time we use <code>call-with-current-continuation</code>, we have to copy the entire stack and any variables so that we can resume the state. Every time we use it, we have to make another copy, just in case we want to resume that same continuation more than once (it&rsquo;s really quite a powerful construct). There are forms of continuations that we could use instead, limiting either how much we have to remember or how often we can reset to that point, but that&rsquo;s beyond the scope of this post. Perhaps another day.</p>

<p>If you&rsquo;d like to see all of the code in one place, you can do so here:
- <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/continuation-thread-pool.rkt">continuation thread pool on GitHub</a></p>

<p>That code also contains a series of <code>(module+ test ...)</code> blocks, each of which can be run with <code>raco test continuation-thread-pool.rkt</code>. That&rsquo;s such nice functionality, it&rsquo;s a shame I&rsquo;m just finding out about it now.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">I still stand by the saying that <a href="https://en.wikipedia.org/wiki/Monad">monads</a> are black magic&hellip;
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">Actually, just replacing the list with a queue would remove the need for both data structures since we could take threads from one end and push them on the other. But queues aren&rsquo;t built in to most Schemes.
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">And immediately break it, because infinite loop&hellip;
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
<li id="fn:4">John McCarthy. A Basis for a Mathematical Theory of Computation. In <em>Computer Programming And Formal Systems</em> by P. Braffort and D. Hirschberg (Ed.), 1963.
 <a class="footnote-return" href="#fnref:4"><sup>[return]</sup></a></li>
<li id="fn:5">That was one of the original requirements after all.
 <a class="footnote-return" href="#fnref:5"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "User space continuation-based thread pool";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2013\/04\/23\/user-space-continuation-based-thread-pool\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

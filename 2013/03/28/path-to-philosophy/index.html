<!doctype html><html>
<head>
<title>Path to philosophy â€“ jverkamp.com</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous>
<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet>
<link rel=stylesheet href=/custom.css defer>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script>
</head>
<body>
<div id=wrapper><header id=page-header role=banner>
<h1><a href=/>JP's Blog</a></h1>
<ul id=page-header-links>
<li>
<a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a>
</li>
<li>
<form action=//www.google.com/search method=get onsubmit="(function(a){a.q.value='site:blog.jverkamp.com '+a.qfront.value})(this)" class="navbar-form navbar-right" role=search _lpchecked=1>
<div class=form-group>
<input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button>
</div>
</form>
</li>
</ul>
<nav id=header-navigation role=navigation class=ribbon>
<ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li>
</ul>
</nav>
</header>
<div id=page-content-wrapper>
<div id=page-content><article>
<header>
<h1 class=entry-title>Path to philosophy</h1>
<div class=entry-meta><span class=entry-date>2013-03-28</span>
</div>
<div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li>
<a class=taxonomy-key href=/programming/languages/>Languages</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/03/17/the-house-on-the-hill-postmortem/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/03/28/writing-a-roguelike-in-racket-day-0/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/03/17/the-house-on-the-hill-postmortem/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2013/04/09/cyclic-equality/ class=next-link></a></li></ul>
</li><li>
<a class=taxonomy-key href=/programming/sources/>Sources</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/02/06/numbers-as-words-in-arbitrary-bases/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/daily-programmer>Daily Programmer</a><a href=https://blog.jverkamp.com/2013/08/21/a-tiny-virtual-machine-in-racket/ class=next-link></a></li></ul>
</li><li>
<a class=taxonomy-key href=/programming/topics/>Topics</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/10/15/chopping-words/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/backtracking>Backtracking</a><a href=https://blog.jverkamp.com/2014/05/02/trigonometric-triangle-trouble/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/graph-theory>Graph Theory</a><a href=https://blog.jverkamp.com/2013/12/23/edges-to-adjacency/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/graphs>Graphs</a><a href=https://blog.jverkamp.com/2013/12/23/edges-to-adjacency/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/wikipedia>Wikipedia</a><a href=https://blog.jverkamp.com/2015/04/17/its-all-greek-to-me/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/02/20/npr-sunday-puzzle/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/word-games>Word Games</a><a href=https://blog.jverkamp.com/2014/02/27/dis/re-emvowelification/ class=next-link></a></li></ul>
</li><li><a class=taxonomy-key href=/programming>programming</a>
<ul>
<li><a href=https://blog.jverkamp.com/2013/03/18/approximating-pi-with-buffons-needle/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/03/28/writing-a-roguelike-in-racket-day-0/ class=next-link>Next</a></ul>
</li><li><a class=taxonomy-key href=/>All Posts</a>
<ul>
<li><a href=https://blog.jverkamp.com/2013/03/18/approximating-pi-with-buffons-needle/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/03/28/writing-a-roguelike-in-racket-day-0/ class=next-link>Next</a></ul>
</li></ul>
</div>
</div>
</header>
<div class=entry-content><p>Yesterday, <a title="Daily programmer sub-reddit" href=http://www.reddit.com/r/dailyprogrammer/>the daily programmer Subreddit</a>Â had <a title="[03/27/13] Challenge #121 [Intermediate] Path to Philosophy" href=http://www.reddit.com/r/dailyprogrammer/comments/1b3ka1/032713_challenge_121_intermediate_path_to/>a post that</a> mirrored a problem I&rsquo;ve often seen before: the idea that if you follow first links ((With some caveats))Â on <a href=https://en.wikipedia.org/wiki/Main%20Page>Wikipedia</a>, you eventually end with <a href=https://en.wikipedia.org/wiki/Philosophy>Philosophy</a>. For example, if you follow the first links from <a href=https://en.wikipedia.org/wiki/Molecule>Molecule</a>, you get the following path:</p>
<blockquote>
<p><a href=https://en.wikipedia.org/wiki/Molecule>Molecule</a> â†’ <a href=https://en.wikipedia.org/wiki/Atom>Atom</a> â†’ <a href=https://en.wikipedia.org/wiki/Matter>Matter</a> â†’ <a href=https://en.wikipedia.org/wiki/Rest%20Mass>Rest Mass</a> â†’ <a href=https://en.wikipedia.org/wiki/Invariant%20Mass>Invariant Mass</a> â†’ <a href=https://en.wikipedia.org/wiki/Energy>Energy</a> â†’ <a href=https://en.wikipedia.org/wiki/Kinetic%20Energy>Kinetic Energy</a> â†’ <a href=https://en.wikipedia.org/wiki/Physics>Physics</a> â†’ <a href=https://en.wikipedia.org/wiki/Natural%20Philosophy>Natural Philosophy</a> â†’ <a href=https://en.wikipedia.org/wiki/Philosophy>Philosophy</a></p>
</blockquote>
<p>I&rsquo;ve followed the paths by hand before, but this is the first time that I&rsquo;ve actually tried to do it in aÂ programmaticÂ manner. It&rsquo;s harder than you might think, but really only because of the crazy number of edge cases involved in correctly parsing either the <a title=MediaWiki href=http://www.mediawiki.org/wiki/MediaWiki>MediaWikiÂ </a>format or the resulting HTML. I eventually got it working though, and here&rsquo;s the result.</p>
<p>First, we want to be able to fetch the pages from Wikipedia. We really want to <a href=https://en.wikipedia.org/wiki/Cache%20%28computing%29>cache</a>these as we go, so that we don&rsquo;t accidentally get rate-limited by Wikipedia&rsquo;s servers (or at the very least to be nicer to them). Here&rsquo;s what I wrote for that part (using the <a title="Wikipedia API" href=http://www.mediawiki.org/wiki/API:Main_page>Wikipedia API</a>) ((If you&rsquo;d like to follow along, here&rsquo;s the code on GitHub:Â <a title="GitHub: Path to philosophy source" href=https://github.com/jpverkamp/small-projects/blob/master/blog/path-to-philosophy.rkt>path to philosophy source</a>)):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme>(<span style=color:#66d9ef>define </span>wikipedia-api-url <span style=color:#e6db74>&#34;http://en.wikipedia.org/w/api.php?format=json&amp;action=query&amp;titles=~a&amp;prop=revisions&amp;rvprop=content&#34;</span>)

<span style=color:#75715e>; Fetch pages from Wikipedia, caching them to disk</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-page</span> title [skip-cache <span style=color:#66d9ef>#f</span>])
  <span style=color:#75715e>; If the file isn&#39;t cached, fetch it</span>
  (<span style=color:#66d9ef>define </span>path (<span style=color:#a6e22e>build-path</span> cache (<span style=color:#a6e22e>format</span> <span style=color:#e6db74>&#34;~a.json&#34;</span> title)))
  (<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>or </span>skip-cache (not (<span style=color:#a6e22e>file-exists?</span> path)))
    (<span style=color:#66d9ef>define </span>url (<span style=color:#a6e22e>string-&gt;url</span> (<span style=color:#a6e22e>format</span> wikipedia-api-url title)))
    (<span style=color:#66d9ef>define </span>http-in (<span style=color:#a6e22e>get-pure-port</span> url <span style=color:#f92672>#</span>:redirections <span style=color:#ae81ff>3</span>))
    (<span style=color:#66d9ef>define </span>response (<span style=color:#a6e22e>port-&gt;string</span> http-in))
    (close-input-port http-in)
    (with-output-to-file path
      (<span style=color:#66d9ef>lambda </span>()
        (display response))))

  <span style=color:#75715e>; Load the file from cache (assume the previous worked)</span>
  (<span style=color:#a6e22e>string-&gt;jsexpr</span> (<span style=color:#a6e22e>file-&gt;string</span> path)))
</code></pre></div><blockquote>
<p><code>UPDATE 2018-07-08</code></p>
</blockquote>
<blockquote>
<p>When fixing the below issue, I also found that I sometimes found pages that contained characters in the names that caused issues. Specifically <code>:</code> which doesn&rsquo;t work on Mac OS and <code>/</code> which doesn&rsquo;t work ever (since it&rsquo;s trying to create a subfolder). To fix it, we just strip out non-alphanumeric characters:</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=color:#75715e>; Fetch pages from Wikipedia, caching them to disk</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-page</span> title [skip-cache <span style=color:#66d9ef>#f</span>])
  <span style=color:#75715e>; If the file isn&#39;t cached, fetch it</span>
  (<span style=color:#66d9ef>define </span>clean-title (<span style=color:#a6e22e>regexp-replace*</span> <span style=color:#f92672>#</span>rx<span style=color:#e6db74>&#34;[^a-zA-Z0-9._-]+&#34;</span> title <span style=color:#e6db74>&#34;-&#34;</span>))
  (<span style=color:#66d9ef>define </span>path (<span style=color:#a6e22e>build-path</span> cache (<span style=color:#a6e22e>format</span> <span style=color:#e6db74>&#34;~a.json&#34;</span> clean-title)))
  <span style=color:#f92672>...</span>
</code></pre></div><p>Basically, where ever your code is running from, it will create / use a subdirectory called <em>cache</em> into which it will dump one file per page, each with the <em><a href=https://en.wikipedia.org/wiki/json>json</a></em>Â extension duplicating whatever content that Wikipedia has returned. Technically, it has the ability to force a refresh, but in practice I just deleted the entire cache folder when I wanted to reset it ((Yes, I know. That kind of defeats the purpose of having a cache in the first place&mldr;)).</p>
<p>Unfortunately, once you have that, it&rsquo;s still in a nice nested structure. So we need to be able to pull out the actual page content. If you use <a title="Racket API: JSON" href=http://pre.racket-lang.org/docs/html/json/index.html>Racket&rsquo;s JSON library</a>, you&rsquo;ll have a nested series of <code><a href="http://docs.racket-lang.org/search/index.html?q=hashes%20">hashes </a></code>
and <code><a href="http://docs.racket-lang.org/search/index.html?q=lists">lists</a></code>
Â that you have to navigate through. It&rsquo;s not quite as nice as <a title="Python JSON" href=http://docs.python.org/2/library/json.html>Python&rsquo;s model</a> ((Which I&rsquo;ve used extensively <a title="Github: jsonq source" href=https://github.com/jpverkamp/jsonq>before</a>. How haven&rsquo;t I written a blog post about that yet?)) but it&rsquo;s not bad. Basically, I figured out the structure by hand and write a function to just ignore anything I didn&rsquo;t care about:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=color:#75715e>; Extract the first page content from a JSON encoded Wikipedia API response</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-first-page-content</span> page)
  (<span style=color:#66d9ef>define </span>page-keys (<span style=color:#a6e22e>hash-keys</span> (<span style=color:#a6e22e>hash-ref</span> (<span style=color:#a6e22e>hash-ref</span> page <span style=color:#e6db74>&#39;query</span>) <span style=color:#e6db74>&#39;pages</span>)))
  (<span style=color:#66d9ef>define </span>content (<span style=color:#a6e22e>hash-ref</span> (<span style=color:#a6e22e>hash-ref</span> (<span style=color:#a6e22e>hash-ref</span> page <span style=color:#e6db74>&#39;query</span>) <span style=color:#e6db74>&#39;pages</span>) (car page-keys)))
  (<span style=color:#a6e22e>hash-ref</span> (car (<span style=color:#a6e22e>hash-ref</span> content <span style=color:#e6db74>&#39;revisions</span>)) <span style=color:#e6db74>&#39;*</span>))
</code></pre></div><blockquote>
<p><code>UPDATE 2018-07-08</code></p>
</blockquote>
<blockquote>
<p>This actually needs a fix. It seems the Wikipedia API will occasionally return &lsquo;missing pages&rsquo;. To fix that, we need to detect those and return empty content for those pages. The backtracking we implement later will take care of skipping those pages.</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=color:#75715e>; Extract the first page content from a JSON encoded Wikipedia API response</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-first-page-content</span> page)
  (<span style=color:#66d9ef>define </span>page-keys (<span style=color:#a6e22e>hash-keys</span> (<span style=color:#a6e22e>hash-ref</span> (<span style=color:#a6e22e>hash-ref</span> page <span style=color:#e6db74>&#39;query</span>) <span style=color:#e6db74>&#39;pages</span>)))
  (<span style=color:#66d9ef>define </span>content (<span style=color:#a6e22e>hash-ref</span> (<span style=color:#a6e22e>hash-ref</span> (<span style=color:#a6e22e>hash-ref</span> page <span style=color:#e6db74>&#39;query</span>) <span style=color:#e6db74>&#39;pages</span>) (car page-keys)))
  (<span style=color:#a6e22e>cond</span>
    [(<span style=color:#a6e22e>hash-has-key?</span> content <span style=color:#e6db74>&#39;missing</span>)
     (<span style=color:#a6e22e>debug-printf</span> <span style=color:#e6db74>&#34;[DEBUG] missing content detected, skipping\n&#34;</span>)
     <span style=color:#e6db74>&#34;&#34;</span>]
    [else
     (<span style=color:#a6e22e>hash-ref</span> (car (<span style=color:#a6e22e>hash-ref</span> content <span style=color:#e6db74>&#39;revisions</span>)) <span style=color:#e6db74>&#39;*</span>)]))
</code></pre></div><p>Now we have the actual content of the page in the original <a title="MediaWiki Syntax" href=http://www.mediawiki.org/wiki/Help:Formatting>MediaWiki syntax</a>. Links will look like this <code>[[target|text]]</code>, so we should just be able to write a simpleÂ <a href=https://en.wikipedia.org/wiki/regular%20expression>regular expression</a> and we&rsquo;ll be golden, right? Well, not so much. There are a number of additional rules that we&rsquo;re supposed to follow:</p>
<ul>
<li>Take the first link in the main body of the page, except:</li>
<li>Ignore links in parentheses</li>
<li>Ignore links in italics</li>
<li>Ignore links to images / files</li>
<li>Ignore links in infoboxes, etc</li>
<li>If a path doesn&rsquo;t work, backtrack and try the second link</li>
</ul>
<p>So that gets a little moreÂ interesting.Â Originally, I tried to do everything with regular expressions. That took a few hours until I realized that no matter how close I was getting, the code was an unholy mess. It turns out that regular expressions areÂ <em>not</em> the tool youÂ wantÂ to use for non-regular languages (anything withÂ nestableÂ tags) ((Yes, I should have known this. I&rsquo;ve taken probably a dozen classes in theory and/or programming languages. But you can actually do a pretty decent hack job of it if you make certain assumptions about your input&mldr;)). In any case, eventually I regained my senses and decided to go for a simple parser instead. All I needed was some way to match (potentially nested) tags with arbitrary delimiters ((MediaWiki uses at single and double square and curly braces. It&rsquo;s a little wild&mldr;)). Here&rsquo;s what I have for that:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme>(<span style=color:#66d9ef>define </span>upper-bound (- (string-length page-content) <span style=color:#ae81ff>1</span>))

<span style=color:#75715e>; Does the string at a given position start with a given text</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>text-at?</span> pos str)
  (<span style=color:#66d9ef>and </span>(&lt;= <span style=color:#ae81ff>0</span> pos upper-bound)
       (&lt;= <span style=color:#ae81ff>0</span> (+ pos (string-length str)) (+ upper-bound <span style=color:#ae81ff>1</span>))
       (equal? str (substring page-content pos (+ pos (string-length str))))))

<span style=color:#75715e>; Return the position right after a closing bracket</span>
<span style=color:#75715e>; Ignore nested pairs</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>find-matching</span> open close start)
  (<span style=color:#66d9ef>let </span>loop ([position start] [nested <span style=color:#ae81ff>0</span>])
    (<span style=color:#66d9ef>define </span>at-opening (<span style=color:#66d9ef>and </span>open (<span style=color:#a6e22e>text-at?</span> position open)))
    (<span style=color:#66d9ef>define </span>at-closing (<span style=color:#66d9ef>and </span>close (<span style=color:#a6e22e>text-at?</span> position close)))
    (<span style=color:#a6e22e>cond</span>
      [(&gt; position upper-bound)
       position]
      [(<span style=color:#66d9ef>and </span>at-closing (= nested <span style=color:#ae81ff>0</span>))
       (+ position <span style=color:#ae81ff>2</span>)]
      [at-closing
       (<span style=color:#a6e22e>loop</span> (+ position <span style=color:#ae81ff>2</span>) (- nested <span style=color:#ae81ff>1</span>))]
      [at-opening
       (<span style=color:#a6e22e>loop</span> (+ position <span style=color:#ae81ff>1</span>) (+ nested <span style=color:#ae81ff>1</span>))]
      [else
       (<span style=color:#a6e22e>loop</span> (+ position <span style=color:#ae81ff>1</span>) nested)])))
</code></pre></div><p>Basically, given a position in the <code>page-content</code> ((It&rsquo;s a free variable here; that&rsquo;s because these are actually nested in the actual main parsing function.)) and the starting / ending delimiters, find the correctly matching end. <code>nesting</code> is used to keep track of how many tested labels we have (mostly useful for <code>{{patterns like this}}</code>). So what do we do with all of that?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=color:#75715e>; Filter out any links in the page that are in paranthesis, italics, or tables</span>
<span style=color:#75715e>; Return a list of all remaining internal links</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>filter-links</span> page-content)
  <span style=color:#f92672>...</span>

  <span style=color:#75715e>; Pull out any links, ignoring certain patterns</span>
  (<span style=color:#66d9ef>define </span>links
    (<span style=color:#66d9ef>let </span>loop ([position <span style=color:#ae81ff>0</span>])
      (<span style=color:#a6e22e>cond</span>
        <span style=color:#75715e>; Done looking</span>
        [(&gt;= position (string-length page-content))
         <span style=color:#f92672>&#39;</span>()]
        <span style=color:#75715e>; Found subcontent {{content}}, ignore it</span>
        [(<span style=color:#a6e22e>text-at?</span> position <span style=color:#e6db74>&#34;{{&#34;</span>)
         (<span style=color:#66d9ef>define </span>end (<span style=color:#a6e22e>find-matching</span> <span style=color:#e6db74>&#34;{{&#34;</span> <span style=color:#e6db74>&#34;}}&#34;</span> (+ position <span style=color:#ae81ff>2</span>)))
         (<span style=color:#a6e22e>loop</span> end)]
        <span style=color:#75715e>; Found bracketed italics content &#39;&#39;content&#39;&#39;, ignore it</span>
        <span style=color:#75715e>; Note: open #f because these can&#39;t next</span>
        [(<span style=color:#a6e22e>text-at?</span> position <span style=color:#e6db74>&#34;&#39;&#39;&#34;</span>)
         (<span style=color:#66d9ef>define </span>end (<span style=color:#a6e22e>find-matching</span> <span style=color:#66d9ef>#f</span> <span style=color:#e6db74>&#34;&#39;&#39;&#34;</span> (+ position <span style=color:#ae81ff>2</span>)))
         (<span style=color:#a6e22e>loop</span> end)]
        <span style=color:#75715e>; Found paranthesis, ignore them</span>
        [(<span style=color:#a6e22e>text-at?</span> position <span style=color:#e6db74>&#34;(&#34;</span>)
         (<span style=color:#66d9ef>define </span>end (<span style=color:#a6e22e>find-matching</span> <span style=color:#e6db74>&#34;(&#34;</span> <span style=color:#e6db74>&#34;)&#34;</span> (+ position <span style=color:#ae81ff>1</span>)))
         (<span style=color:#a6e22e>loop</span> end)]
        <span style=color:#75715e>; Found a File/image block [[File/Image: content]], ignore it</span>
        <span style=color:#75715e>; Note: may contain nested [[links]] we don&#39;t want</span>
        [(<span style=color:#66d9ef>or </span>(<span style=color:#a6e22e>text-at?</span> position <span style=color:#e6db74>&#34;[[File:&#34;</span>)
             (<span style=color:#a6e22e>text-at?</span> position <span style=color:#e6db74>&#34;[[Image:&#34;</span>))
         (<span style=color:#66d9ef>define </span>end (<span style=color:#a6e22e>find-matching</span> <span style=color:#e6db74>&#34;[[&#34;</span> <span style=color:#e6db74>&#34;]]&#34;</span> (+ position <span style=color:#ae81ff>2</span>)))
         (<span style=color:#a6e22e>loop</span> end)]
        <span style=color:#75715e>; Found a link: [[content]], return it</span>
        [(<span style=color:#a6e22e>text-at?</span> position <span style=color:#e6db74>&#34;[[&#34;</span>)
         (<span style=color:#66d9ef>define </span>end (<span style=color:#a6e22e>find-matching</span> <span style=color:#e6db74>&#34;[[&#34;</span> <span style=color:#e6db74>&#34;]]&#34;</span> (+ position <span style=color:#ae81ff>2</span>)))
         (cons (substring page-content position end)
               (<span style=color:#a6e22e>loop</span> end))]
        <span style=color:#75715e>; Otherwise, just cane forward</span>
        [else
         (<span style=color:#a6e22e>loop</span> (+ position <span style=color:#ae81ff>1</span>))])))

  <span style=color:#75715e>; Get just the targets, remove any external links</span>
  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>split-link</span> link) (<span style=color:#a6e22e>string-split</span> link <span style=color:#e6db74>&#34;|&#34;</span>))
  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>remove-brackets</span> link) (substring link <span style=color:#ae81ff>2</span> (- (string-length link) <span style=color:#ae81ff>2</span>)))
  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>not-external?</span> link) (<span style=color:#66d9ef>or </span>(&lt; (string-length link) <span style=color:#ae81ff>4</span>) (not (equal? <span style=color:#e6db74>&#34;http&#34;</span> (substring link <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>4</span>)))))
  (map string-downcase (<span style=color:#a6e22e>filter</span> not-external? (map car (map split-link (map remove-brackets links))))))
</code></pre></div><p>Basically, scan through the file. Anytime we find one of the patterns to remove, find it&rsquo;s close and skip ahead. Anytime we find a link, remember it in the recursion.</p>
<p>At the end, we have a lovely little set of <code>map</code>s and <code>filter</code>s to clean up the links and remove any potential external links. It&rsquo;s things like this that I miss most when I&rsquo;m working in non-functional languages&mldr;</p>
<p>Anyways, now we have all of the pieces. We can put them all together to get the neighbors for any give page:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=color:#75715e>; Get the neighbors to a given article</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-neighbors</span> title)
  (<span style=color:#a6e22e>filter-links</span> (<span style=color:#a6e22e>get-first-page-content</span> (<span style=color:#a6e22e>get-page</span> title))))
</code></pre></div><p>And then it&rsquo;s easy enough to solve the problem. I&rsquo;m actually going to do the general solution first, since we&rsquo;ll have to write it eventually:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=color:#75715e>; Find a path from one page to another, depth first search</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>find-path</span> from to)
  (<span style=color:#66d9ef>set! </span>from (<span style=color:#a6e22e>string-downcase</span> from))
  (<span style=color:#66d9ef>set! </span>to (<span style=color:#a6e22e>string-downcase</span> to))
  (<span style=color:#66d9ef>let </span>loop ([page from] [sofar <span style=color:#f92672>&#39;</span>()])
    (<span style=color:#a6e22e>cond</span>
      [(equal? page to) (list to)]
      [(member page sofar) <span style=color:#66d9ef>#f</span>]
      [else
       <span style=color:#75715e>; Depth first search, try all neighbors</span>
       (<span style=color:#66d9ef>let </span>neighbor-loop ([neighbors (<span style=color:#a6e22e>get-neighbors</span> page)])
         (<span style=color:#a6e22e>cond</span>
           <span style=color:#75715e>; Out of neighbors, this page is useless</span>
           [(null? neighbors) <span style=color:#66d9ef>#f</span>]
           <span style=color:#75715e>; Found a recursive match, build backwards</span>
           [(<span style=color:#a6e22e>loop</span> (car neighbors) (cons page sofar))
            <span style=color:#66d9ef>=&gt; </span>(<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>next</span>) (cons page next))]
           <span style=color:#75715e>; Didn&#39;t find a match, try the next neighbor</span>
           [else
            (<span style=color:#a6e22e>neighbor-loop</span> (cdr neighbors))]))])))
</code></pre></div><p>The smartest part of the code here comes in the <code>neighbor-loop</code>. Here&rsquo;s where we do the backtracking,Â primarilyÂ by that strange looking <code>=></code> in the second <code>cond</code> clause. Basically, that lets you pass the result of the conditional to a function so you can use it without recalculating it. Since anything that&rsquo;s not <code>#f</code> in Scheme (and by extension Racket) is true, this means that the recursive cases that don&rsquo;t work and return <code>#f</code> will fall through to the <code>else</code> case and the rest will call the function with the recursive result as <code>next</code>. Hope thatÂ explanationÂ made some sort of sense, it&rsquo;s a really helpful tool.</p>
<p>And just for the sake of completeness, here&rsquo;s how we get to Philosophy:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=color:#75715e>; Starting at a given page and taking the first link, how long to Philosophy?</span>
(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>-&gt;philosophy</span> start) (<span style=color:#a6e22e>find-path</span> start <span style=color:#e6db74>&#34;philosophy&#34;</span>))
</code></pre></div><p>So how does it actually work in practice?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme>&gt; (<span style=color:#a6e22e>-&gt;philosophy</span> <span style=color:#e6db74>&#34;Molecule&#34;</span>)
<span style=color:#f92672>&#39;</span>(<span style=color:#e6db74>&#34;molecule&#34;</span>
  <span style=color:#e6db74>&#34;atom&#34;</span>
  <span style=color:#e6db74>&#34;matter&#34;</span>
  <span style=color:#e6db74>&#34;rest mass&#34;</span>
  <span style=color:#e6db74>&#34;invariant mass&#34;</span>
  <span style=color:#e6db74>&#34;energy&#34;</span>
  <span style=color:#e6db74>&#34;kinetic energy&#34;</span>
  <span style=color:#e6db74>&#34;physics&#34;</span>
  <span style=color:#e6db74>&#34;natural philosophy&#34;</span>
  <span style=color:#e6db74>&#34;philosophy&#34;</span>)
</code></pre></div><p>I&rsquo;ve got an extra link (rest mass) than the source example, but that&rsquo;s mostly because it&rsquo;s a redirect page. My code will print those out, but the sample apparently does not. But overall, it works out pretty well. Let&rsquo;s try something perhaps a bit more amusing:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme>&gt; (<span style=color:#a6e22e>-&gt;philosophy</span> <span style=color:#e6db74>&#34;Wombat&#34;</span>)
<span style=color:#f92672>&#39;</span>(<span style=color:#e6db74>&#34;wombat&#34;</span>
  <span style=color:#e6db74>&#34;quadruped&#34;</span>
  <span style=color:#e6db74>&#34;quadrupedalism&#34;</span>
  <span style=color:#e6db74>&#34;terrestrial locomotion in animals&#34;</span>
  <span style=color:#e6db74>&#34;terrestrial locomotion&#34;</span>
  <span style=color:#e6db74>&#34;evolution&#34;</span>
  <span style=color:#e6db74>&#34;heredity&#34;</span>
  <span style=color:#e6db74>&#34;phenotypic trait&#34;</span>
  <span style=color:#e6db74>&#34;phenotypic character&#34;</span>
  <span style=color:#e6db74>&#34;phenotype&#34;</span>
  <span style=color:#e6db74>&#34;organism&#34;</span>
  <span style=color:#e6db74>&#34;biology&#34;</span>
  <span style=color:#e6db74>&#34;natural science&#34;</span>
  <span style=color:#e6db74>&#34;science&#34;</span>
  <span style=color:#e6db74>&#34;knowledge&#34;</span>
  <span style=color:#e6db74>&#34;fact&#34;</span>
  <span style=color:#e6db74>&#34;proof (truth)&#34;</span>
  <span style=color:#e6db74>&#34;necessity and sufficiency&#34;</span>
  <span style=color:#e6db74>&#34;logic&#34;</span>
  <span style=color:#e6db74>&#34;reason&#34;</span>
  <span style=color:#e6db74>&#34;consciousness&#34;</span>
  <span style=color:#e6db74>&#34;subjectivity&#34;</span>
  <span style=color:#e6db74>&#34;philosophy&#34;</span>)
</code></pre></div><p>And finally the other example from the original daily programmer challenge:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme>&gt; (<span style=color:#a6e22e>find-path</span> <span style=color:#e6db74>&#34;asperger syndrome&#34;</span> <span style=color:#e6db74>&#34;logic&#34;</span>)
<span style=color:#f92672>&#39;</span>(<span style=color:#e6db74>&#34;asperger syndrome&#34;</span>
  <span style=color:#e6db74>&#34;autism spectrum&#34;</span>
  <span style=color:#e6db74>&#34;pervasive developmental disorder&#34;</span>
  <span style=color:#e6db74>&#34;specific developmental disorder&#34;</span>
  <span style=color:#e6db74>&#34;socialization&#34;</span>
  <span style=color:#e6db74>&#34;sociology&#34;</span>
  <span style=color:#e6db74>&#34;society&#34;</span>
  <span style=color:#e6db74>&#34;interpersonal relationship&#34;</span>
  <span style=color:#e6db74>&#34;inference&#34;</span>
  <span style=color:#e6db74>&#34;formal proof&#34;</span>
  <span style=color:#e6db74>&#34;proposition (philosophy)&#34;</span>
  <span style=color:#e6db74>&#34;proposition&#34;</span>
  <span style=color:#e6db74>&#34;philosophy&#34;</span>
  <span style=color:#e6db74>&#34;reality&#34;</span>
  <span style=color:#e6db74>&#34;being&#34;</span>
  <span style=color:#e6db74>&#34;objectivity (philosophy)&#34;</span>
  <span style=color:#e6db74>&#34;truth&#34;</span>
  <span style=color:#e6db74>&#34;fact&#34;</span>
  <span style=color:#e6db74>&#34;proof (truth)&#34;</span>
  <span style=color:#e6db74>&#34;necessity and sufficiency&#34;</span>
  <span style=color:#e6db74>&#34;logic&#34;</span>)
</code></pre></div><p>The path is a bit different (and longer) than the one given, diverging after <em>pervasive developmental disorder</em>. They went to <em>mental disorder</em> while I went to <em>specific developmental disorder</em>. That&rsquo;s just the nature of Wikipedia. From time to time, people will actually discover the &lsquo;paths to philosophy&rsquo; challenge and purposely switch about links so that it specifically either works faster / doesn&rsquo;t work, but such changes generally get reverted fairly quickly. It&rsquo;s really kind of amazing how Wikipedia has grown to deal with things like that.</p>
<p>In case you were curious, here are the timing differences when using the cache and when not:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme>&gt; (<span style=color:#a6e22e>time</span> (<span style=color:#a6e22e>-&gt;philosophy</span> <span style=color:#e6db74>&#34;Molecule&#34;</span>))
cpu time: <span style=color:#ae81ff>1529</span> real time: <span style=color:#ae81ff>4018</span> gc time: <span style=color:#ae81ff>327</span>
<span style=color:#f92672>...</span>
&gt; (<span style=color:#a6e22e>time</span> (<span style=color:#a6e22e>-&gt;philosophy</span> <span style=color:#e6db74>&#34;Molecule&#34;</span>))
cpu time: <span style=color:#ae81ff>1186</span> real time: <span style=color:#ae81ff>1269</span> gc time: <span style=color:#ae81ff>280</span>
<span style=color:#f92672>...</span>
</code></pre></div><p>It&rsquo;s really not much faster. Most of the time is spent processing the text and looking for links, perhaps only 1/4 to 1/3 is network latency. But still, if you&rsquo;re doing a lot of testing, that saved bandwidth to Wikipedia is probably worth a few fractions of a penny at the very least. ðŸ˜„</p>
<p>And&mldr; that&rsquo;s it. Good to go. Here&rsquo;s the code on GitHub if you&rsquo;d like to see it all in one place: <a title="GitHub: Path to philosophy source" href=https://github.com/jpverkamp/small-projects/blob/master/blog/path-to-philosophy.rkt>path to philosophy source</a></p></div>
</article></div>
</div><footer id=page-footer role=contentinfo>
<nav id=footer-navigation role=navigation class=ribbon>
<ul class=main-navigation>
<li><a href=/archive-by-date/>All posts: By Date</a></li>
<li><a href=/archive-by-tag/>All posts: By Tag</a></li>
<li>
<a href=/atom.xml>
RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li><li>
<a href=/programming/atom.xml>
RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li></ul>
</nav>
<div id=page-footer-content>
<div class=legal>
<p>
All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US>
<img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png>
</a>
</p>
<p>
Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a>
</p>
</div>
</div>
</footer>
</div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script defer>mermaid.initialize({startOnLoad:!0,securityLevel:'loose'})</script>
<script defer src=/custom.js></script>
</body>
</html>
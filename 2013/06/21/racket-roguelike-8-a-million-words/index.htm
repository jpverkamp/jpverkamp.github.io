<!DOCTYPE html>
<html>
<head>
        
        

        <title>Racket Roguelike 8: A million words! | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="http://blog.jverkamp.com/category/archives/2015">2015</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="http://blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Racket Roguelike 8: A million words!</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-06-21"><span class="year">2013</span> <span class="month">June</span> <span class="day">21</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-source/7drl">7DRL</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/games">Games</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project/games/racket-roguelike">Racket Roguelike</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/games/roguelikes">Roguelikes</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>If a picture is worth a thousand words, surely an animated GIF is worth a few more than that. :)</p>
<!--more-->
<p><a href="http://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/boom.gif" data-toggle="lightbox"><img src="http://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/boom.gif" /></a></p>
<p>The short version: I finally figure out how to animation! It's terribly hacky--abusing both mutation on the module level and the Racket GUI event queue--and I really would love to know how to do it better. But for the moment, it works, which means that I can move forward with generating more content and weapons using the framework in future weeks.</p>
<p>So how does it work?</p>
<p>Well, the problem that I had the first few times around all revolved around the Racket GUI event queue not allowing me (rightfully so) to update the GUI while it was still processing. So I had to add in events to draw things. <code><a href="http://docs.racket-lang.org/search/index.html?q=queue-callback">queue-callback</a></code> to the rescue! It's a neat little function that lets you add an arbitrary thunk to the event queue. But I didn't want to make a content generator deal with that directly, so we need an API.</p>
<pre class="scheme"><code>; animate.rkt

(provide animate! set-animate!)

(define (animate! . thunks)
  (void))

(define (set-animate! f)
  (set! animate! f))</code></pre>
<p>The first function will be what we call. The second is the ugliness that I was talking about earlier. Because we want access to the drawing functions, we need to have access to the scope in <code>gui.rkt</code>, but we want to be able to use <code>animate!</code> in any other file. Normally, that would get us circular imports.</p>
<p>So it's ugly. So it goes. What do we end up setting <code>animate!</code> to?</p>
<pre class="scheme"><code>; gui.rkt

; Correctly set the animation function
(set-animate!
 (lambda thunks
   (for-each (lambda (thunk) (thunk)) thunks)
   (send active-screen draw canvas)
   (send frame refresh)
   (yield)))</code></pre>
<p>The first bits are easy enough, we take any number of thunks and then evaluate each of them in turn. Then we have the normal drawing functions. The only new part is the <code><a href="http://docs.racket-lang.org/search/index.html?q=yield">yield</a></code> function which sends control back to the event queue. I'm not entirely sure it's necessary, but the original code didn't work and with <code>yield</code> it does.</p>
<p>With that, now we can animate things. There are a few caveats to keep in mind:</p>
<ul>
        <li>Any code you want to run, you have to wrap in thunks. Otherwise it would be evaluated once, at launch.</li>
        <li>Any changes to the GUI each have to be in their own <code>animate!</code> block, since the screen is only redrawn once per draw.</li>
        <li>The code will run as quickly as possible, so you'll often want to put in a call to <code>sleep</code> to actually make changes visible.</li>
</ul>
<p>So let's take an example in practice (the one in the GIF above): the bomb.</p>
<p>All of this code will go into the act function in exploding-entity, adding to the previous damage code that was already there.</p>
<pre class="scheme"><code>; entities.rkt

; An exploding enemy blows up whenever the player gets close to them
; Otherwise, they cannot move or attack (by default)
(define-thing exploding-enemy enemy
  [(act me world)
   ...

   ; Get the neighboring tiles
   (define neighbors
     (for*/list ([xd (in-range -1 2)]
                 [yd (in-range -1 2)])
       (define loc (+ (thing-get me 'location) (pt xd yd)))
       (send world tile-at (pt-x loc) (pt-y loc))))

   ; Store the original color
   (for ([tile (in-list neighbors)])
     (thing-set! tile 'original-color (thing-get tile 'color))
     (thing-set! tile 'original-character (thing-get tile 'character))
     (thing-set! tile 'character #\*))

   ; Animate through several colors
   (define (random-color) (vector-ref (vector "red" "yellow" "white") (random 3)))
   (for ([i (in-range 10)])
     (animate!
      (lambda ()
        (for ([tile (in-list neighbors)])
          (thing-set! tile 'color (random-color))
          (sleep 1)))))

   ; Clear them
   (animate!
    (lambda ()
      (for ([tile (in-list neighbors)])
        (thing-set! tile 'color (thing-get tile 'original-color))
        (thing-set! tile 'character (thing-get tile 'original-character)))))

   ...</code></pre>
<p>And that's it. Originally, I was storing the colors in the enclosing scope, but then I realized that the <code>thing</code> framework allows attaching arbitrary fields at runtime. So I could just store the original color as needed and then restore it. Just so long as no one else decides to mess with it mid-explosion, it should work just fine.</p>
<p>And that's actually it for this week. It's a short post and rather little final code, but it took more than a little while to get entirely correct. I'm still not thrilled with the hacks it took to get it to work, but it's a start. Perchance next week I'll take the time to actually add a bit more content. :)</p>
<p>As always, if you'd like to see all of the code for this project, you can do so on GitHub: - <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike/tree/day-8">Racket Roguelike - Day 8</a> - <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">Racket Roguelike - Up to date</a></p>
<p>If you'd like to try it yourself, you'll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<pre class="bash"><code>git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-8
git submodule init
git submodule update
racket main.rkt</code></pre>
<p><strong>Edit:</strong></p>
<p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>, and then run the code:</p>
<pre class="bash"><code>raco pkg install github://github.com:jpverkamp/ascii-canvas/master
raco pkg install github://github.com:jpverkamp/noise/master
raco pkg install github://github.com:jpverkamp/thing/master
git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-8
racket main.rkt</code></pre>
<p>For part 9, click here: <a href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath">Racket Roguelike 9: Daedalus' wrath!</a></p>
<div><h3 class="ranking-title">Racket Roguelike</h3><ol><li><a href="http://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-io-and-you">Racket Roguelike 1: A GUI, screens, I/O, and you!</a></li><li><a href="http://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves">Racket Roguelike 2: Infinite caves!</a></li><li><a href="http://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere">Racket Roguelike 3: Rats, rats, everywhere!</a></li><li><a href="http://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters">Racket Roguelike 4: Slightly smarter critters!</a></li><li><a href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my">Racket Roguelike 5: Armors and weapons and potions, oh my!</a></li><li><a href="http://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper">Racket Roguelike 6: Dig deeper!</a></li><li><a href="http://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness">Racket Roguelike 7: Into darkness!</a></li><li><a href="http://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words">Racket Roguelike 8: A million words!</a></li></ol></div>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Racket Roguelike 8: A million words!";
var disqus_url = "http://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/06/14/adventures-in-florida">← Adventures in Florida</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2013/06/23/monsters-university">Monsters University →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus">← Racket Roguelike -- Going on hiatus</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2013/06/26/swap-list-nodes">Swap list nodes →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
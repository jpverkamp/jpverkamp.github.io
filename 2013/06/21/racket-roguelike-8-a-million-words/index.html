<!doctype html><html><head><title>Racket Roguelike 8: A million words! – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.ef050764ff69f3287c89ff655825479dd8304dcd9bc653d1ddd4772a701ad445.js integrity="sha256-7wUHZP9p8yh8if9lWCVHndgwTc2bxlPR3dR3KnAa1EU=" defer></script><script src=/katex_17296078054267651618.min.deed0e78a77391517d530a00324ce7b760ac204134992ef22d36f583615ae498.js integrity="sha256-3u0OeKdzkVF9UwoAMkznt2CsIEE0mS7yLTb1g2Fa5Jg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.bfe50b47c0387e3c3bf97ec5f338bba94f7ccb02f962a4aec8cf0b4d68c8434d.js integrity="sha256-v+ULR8A4fjw7+X7F8zi7qU98ywL5YqSuyM8LTWjIQ00=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.64e42891d651aee0b8cd02ec9227ff271d37bcf06dae985d1acf0eba1623e850.css integrity="sha256-ZOQokdZRruC4zQLskif/Jx03vPBtrphdGs8OuhYj6FA="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.0d2b289fa3451447692959fcee5676b846532fe7ab50ddc4660824c42d4adcd7.css integrity="sha256-DSson6NFFEdpKVn87lZ2uEZTL+erUN3EZggkxC1K3Nc="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.67505d77381ebd82623ab9296c1989c44ec828d867c00296e80e52ef860cac37.css integrity="sha256-Z1BddzgevYJiOrkpbBmJxE7IKNhnwAKW6A5S74YMrDc="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.b60cba31b8c292392a2d336408f8f344e261df78516eb17bcf029173b24a42b5.css integrity="sha256-tgy6MbjCkjkqLTNkCPjzROJh33hRbrF7zwKRc7JKQrU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/home-automation/>Home Automation</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Racket Roguelike 8: A million words!</h1><div class=entry-meta><span class=entry-date>2013-06-21</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/06/26/swap-list-nodes/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/7drl>7DRL</a><a href=https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/games>Games</a><a href=https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/roguelikes>Roguelikes</a><a href=https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/ class=previous-link></a><a class=taxonomy-value href=/series/racket-roguelike>Racket Roguelike</a><a href=https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/06/26/swap-list-nodes/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/photography/2013/2013-06-14-adventures-in-florida/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/06/23/monsters-university/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>If a picture is worth a thousand words, surely an animated GIF is worth a few more than that. &#x1f604;</p><figure><img src=/embeds/2013/boom.gif></figure><p>The short version: I finally figure out how to animation! It&rsquo;s terribly hacky&ndash;abusing both mutation on the module level and the Racket GUI event queue&ndash;and I really would love to know how to do it better. But for the moment, it works, which means that I can move forward with generating more content and weapons using the framework in future weeks.</p><p>So how does it work?</p><p>Well, the problem that I had the first few times around all revolved around the Racket GUI event queue not allowing me (rightfully so) to update the GUI while it was still processing. So I had to add in events to draw things. <code><a href="http://docs.racket-lang.org/search/index.html?q=queue-callback">queue-callback</a></code>
 to the rescue! It&rsquo;s a neat little function that lets you add an arbitrary thunk to the event queue. But I didn&rsquo;t want to make a content generator deal with that directly, so we need an API.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; animate.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>provide</span> animate! set-animate!)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>animate!</span> <span style=color:#f92672>.</span> thunks)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>void</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>set-animate!</span> f)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>set! </span>animate! f))
</span></span></code></pre></div><p>The first function will be what we call. The second is the ugliness that I was talking about earlier. Because we want access to the drawing functions, we need to have access to the scope in <code>gui.rkt</code>, but we want to be able to use <code>animate!</code> in any other file. Normally, that would get us circular imports.</p><p>So it&rsquo;s ugly. So it goes. What do we end up setting <code>animate!</code> to?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; gui.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Correctly set the animation function</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>set-animate!</span>
</span></span><span style=display:flex><span> (<span style=color:#66d9ef>lambda </span>thunks
</span></span><span style=display:flex><span>   (for-each (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>thunk</span>) (<span style=color:#a6e22e>thunk</span>)) thunks)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>send</span> active-screen draw canvas)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>send</span> frame refresh)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>yield</span>)))
</span></span></code></pre></div><p>The first bits are easy enough, we take any number of thunks and then evaluate each of them in turn. Then we have the normal drawing functions. The only new part is the <code><a href="http://docs.racket-lang.org/search/index.html?q=yield">yield</a></code>
 function which sends control back to the event queue. I&rsquo;m not entirely sure it&rsquo;s necessary, but the original code didn&rsquo;t work and with <code>yield</code> it does.</p><p>With that, now we can animate things. There are a few caveats to keep in mind:</p><ul><li>Any code you want to run, you have to wrap in thunks. Otherwise it would be evaluated once, at launch.</li><li>Any changes to the GUI each have to be in their own <code>animate!</code> block, since the screen is only redrawn once per draw.</li><li>The code will run as quickly as possible, so you&rsquo;ll often want to put in a call to <code>sleep</code> to actually make changes visible.</li></ul><p>So let&rsquo;s take an example in practice (the one in the GIF above): the bomb.</p><p>All of this code will go into the act function in exploding-entity, adding to the previous damage code that was already there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; entities.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; An exploding enemy blows up whenever the player gets close to them</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Otherwise, they cannot move or attack (by default)</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> exploding-enemy enemy
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>act</span> me world)
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>; Get the neighboring tiles</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>define </span>neighbors
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>for*/list</span> ([xd (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>2</span>)]
</span></span><span style=display:flex><span>                 [yd (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>-1</span> <span style=color:#ae81ff>2</span>)])
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>loc (+ (<span style=color:#a6e22e>thing-get</span> me <span style=color:#e6db74>&#39;location</span>) (<span style=color:#a6e22e>pt</span> xd yd)))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>send</span> world tile-at (<span style=color:#a6e22e>pt-x</span> loc) (<span style=color:#a6e22e>pt-y</span> loc))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>; Store the original color</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for</span> ([tile (<span style=color:#a6e22e>in-list</span> neighbors)])
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;original-color</span> (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;color</span>))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;original-character</span> (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;character</span>))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;character</span> <span style=color:#e6db74>#\*</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>; Animate through several colors</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>random-color</span>) (vector-ref (vector <span style=color:#e6db74>&#34;red&#34;</span> <span style=color:#e6db74>&#34;yellow&#34;</span> <span style=color:#e6db74>&#34;white&#34;</span>) (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>3</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for</span> ([i (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>10</span>)])
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>animate!</span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>lambda </span>()
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>for</span> ([tile (<span style=color:#a6e22e>in-list</span> neighbors)])
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;color</span> (<span style=color:#a6e22e>random-color</span>))
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>sleep</span> <span style=color:#ae81ff>1</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>; Clear them</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>animate!</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>lambda </span>()
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>for</span> ([tile (<span style=color:#a6e22e>in-list</span> neighbors)])
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;color</span> (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;original-color</span>))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;character</span> (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;original-character</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>And that&rsquo;s it. Originally, I was storing the colors in the enclosing scope, but then I realized that the <code>thing</code> framework allows attaching arbitrary fields at runtime. So I could just store the original color as needed and then restore it. Just so long as no one else decides to mess with it mid-explosion, it should work just fine.</p><p>And that&rsquo;s actually it for this week. It&rsquo;s a short post and rather little final code, but it took more than a little while to get entirely correct. I&rsquo;m still not thrilled with the hacks it took to get it to work, but it&rsquo;s a start. Perchance next week I&rsquo;ll take the time to actually add a bit more content. &#x1f604;</p><p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:</p><ul><li><a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike/tree/day-8>Racket Roguelike - Day 8</a></li><li><a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike>Racket Roguelike - Up to date</a></li></ul><p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href=http://git-scm.com/>Git</a> and <a href=http://racket-lang.org/>Racket</a> and run the following series of commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-8
</span></span><span style=display:flex><span>git submodule init
</span></span><span style=display:flex><span>git submodule update
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p><strong>Edit:</strong></p><p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/ascii-canvas/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/noise/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/thing/master
</span></span><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-8
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p>For part 9, click here: <a href=https://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/>Racket Roguelike 9: Daedalus&rsquo; wrath!</a></p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
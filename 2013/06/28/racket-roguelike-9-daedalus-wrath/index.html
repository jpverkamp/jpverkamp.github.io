<!DOCTYPE html>
<html onclick >
<head>
    <title>Racket Roguelike 9: Daedalus&#39; wrath! â€“ jverkamp.com</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a> *
            <a href="/resume">Resume</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>
    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/maker/">Maker</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Racket Roguelike 9: Daedalus&#39; wrath!</h1>

        <div class="entry-meta"><span class="entry-date">2013-06-28</span>
            </div>

        <div class="entry-taxonomies"><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/26/swap-list-nodes/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/" class="previous-link"></a><a class="taxonomy-value" href="/programming/sources/7drl">7DRL</a><a href="https://blog.jverkamp.com/2013/07/05/racket-roguelike-10-levels-via-automata/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/games">Games</a><a href="https://blog.jverkamp.com/2013/07/05/racket-roguelike-10-levels-via-automata/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/roguelikes">Roguelikes</a><a href="https://blog.jverkamp.com/2013/07/05/racket-roguelike-10-levels-via-automata/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/" class="previous-link"></a><a class="taxonomy-value" href="/series/racket-roguelike">Racket Roguelike</a><a href="https://blog.jverkamp.com/2013/07/05/racket-roguelike-10-levels-via-automata/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/06/26/swap-list-nodes/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/06/28/world-war-z/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</div>
    </header>

	<div class="entry-content"><p>I think by now it&rsquo;s well past time that we got to adding a bit more content. So far, here&rsquo;s what we have (bolded entries we actually used in day 8):</p>
<ul>
<li>entities: <strong>rat</strong>, goblin, <strong>bomb</strong>, bomber goblin</li>
<li>armor: <strong>leather</strong>, chain, plate, enchanted</li>
<li>weapons: <strong>club</strong>, dagger, battle axe, longsword, magic sword</li>
<li>potions: <strong>health potion</strong></li>
<li>coins: <strong>copper</strong>, silver, gold, platinum</li>
<li>levels: <strong>forest</strong>, <strong>caves</strong></li>
</ul>
<p>We can do better than that though!</p>
<p>Let&rsquo;s start with new levels.</p>
<p>First, let&rsquo;s try making something with a bit more structure. For both the forest and the caves, we have nice smooth flowing curves, let&rsquo;s go for some straight lines.</p>
<p>The basic idea is to use the same random number generators but at a different scale. We&rsquo;ll sample the points at every 10 or so tiles. If the sampled region is positive, include it. If not, don&rsquo;t. Sounds simple enough; here&rsquo;s some</p>
<p>First, check if we&rsquo;re in the 3 wide potential halls. We&rsquo;ll take the remainder for ten, if it&rsquo;s 4-6, use it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Guaranteed wall if not x or y = 5 +- 1 (mod 10)</span>
(<span style="color:#66d9ef">define </span>maybe-hall?
  (<span style="color:#66d9ef">or </span>(&lt;= <span style="color:#ae81ff">4</span> (remainder (abs x) <span style="color:#ae81ff">10</span>) <span style="color:#ae81ff">6</span>)
      (&lt;= <span style="color:#ae81ff">4</span> (remainder (abs y) <span style="color:#ae81ff">10</span>) <span style="color:#ae81ff">6</span>)))
</code></pre></div><p>We could have used 0, 1, and 9, but the math is just more complicated.</p>
<p>Next, we want to check if we have an empty space:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Find the endpoints</span>
(<span style="color:#66d9ef">define </span>xlo (floor (/ x <span style="color:#ae81ff">10</span>)))
(<span style="color:#66d9ef">define </span>ylo (floor (/ y <span style="color:#ae81ff">10</span>)))

<span style="color:#75715e">; Calculate if we&#39;d have an open space</span>
(<span style="color:#66d9ef">define </span>good-hall?
  (<span style="color:#66d9ef">or </span>(<span style="color:#66d9ef">and </span>(&gt; (<span style="color:#a6e22e">simplex</span> (* <span style="color:#ae81ff">0.5</span> xlo)       (* <span style="color:#ae81ff">0.5</span> ylo)       seed) <span style="color:#ae81ff">-0.25</span>)
           (&gt; (<span style="color:#a6e22e">simplex</span> (* <span style="color:#ae81ff">0.5</span> (+ xlo <span style="color:#ae81ff">1</span>)) (* <span style="color:#ae81ff">0.5</span> ylo)       seed) <span style="color:#ae81ff">-0.25</span>))
      (<span style="color:#66d9ef">and </span>(&gt; (<span style="color:#a6e22e">simplex</span> (* <span style="color:#ae81ff">0.5</span> xlo)       (* <span style="color:#ae81ff">0.5</span> ylo)       seed) <span style="color:#ae81ff">-0.25</span>)
           (&gt; (<span style="color:#a6e22e">simplex</span> (* <span style="color:#ae81ff">0.5</span> xlo)       (* <span style="color:#ae81ff">0.5</span> (+ ylo <span style="color:#ae81ff">1</span>)) seed) <span style="color:#ae81ff">-0.25</span>))))
</code></pre></div><p>I started with a multiplier at 0.1 and a threshold at 0, but that wasn&rsquo;t giving enough variation, so I increased the scale and lowered the threshold. This seems to give good results, so we&rsquo;ll go with it. Like all of the level generation parameters, it&rsquo;s easy enough though.</p>
<p>Finally, let&rsquo;s make stairs. We&rsquo;ll add an extra empty region around 0x0; otherwise, both tests will have to be positive:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Figure out which case we have</span>
(<span style="color:#a6e22e">cond</span>
  <span style="color:#75715e">; Central section</span>
  [(<span style="color:#66d9ef">and </span>(&lt;= <span style="color:#ae81ff">-3</span> x <span style="color:#ae81ff">3</span>) (&lt;= <span style="color:#ae81ff">-3</span> y <span style="color:#ae81ff">3</span>))
   (<span style="color:#a6e22e">make-thing</span> empty)]
  <span style="color:#75715e">; Guaranteed path</span>
  [(<span style="color:#66d9ef">and </span>maybe-hall? good-hall?)
   (<span style="color:#a6e22e">make-thing</span> empty)]
  <span style="color:#75715e">; Wall</span>
  [else
   (<span style="color:#a6e22e">make-thing</span> wall)])
</code></pre></div><p>But what about stairs? Everyone likes stairs!</p>
<p>First, let&rsquo;s restrict stairs more this time. We&rsquo;ll only put stairs in intersections that have already been generated and even then only in 1/10. How do we do that? First, restrict to the 5x5 points in each 10x10 grid:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Maybe a stairway if both are five</span>
(<span style="color:#66d9ef">define </span>maybe-stairs?
  (= <span style="color:#ae81ff">5</span> (remainder (abs x) <span style="color:#ae81ff">10</span>) (remainder (abs y) <span style="color:#ae81ff">10</span>)))
</code></pre></div><p>Then swap out the middle section of the <code>cond</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Guaranteed path</span>
    [(<span style="color:#66d9ef">and </span>maybe-hall? good-hall?)
     <span style="color:#75715e">; Check for stairs</span>
     (<span style="color:#66d9ef">if </span>(<span style="color:#66d9ef">and </span>maybe-stairs? (zero? (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">10</span>)))
         (<span style="color:#a6e22e">make-thing</span> stairs-down)
         (<span style="color:#a6e22e">make-thing</span> empty))]
</code></pre></div><p>With this, we have a nice maze going on already. Here are a few examples. Start with a wide open world:</p>
<figure>
    <img src="/embeds/2013/1-Into-the-darkness.png"/> 
</figure>

<p>Move a bit and we already have a few nicely squared off choices:</p>
<figure>
    <img src="/embeds/2013/2-Two-choices.png"/> 
</figure>

<p>Go a bit further and now we have a full intersection:</p>
<figure>
    <img src="/embeds/2013/3-Intersection.png"/> 
</figure>

<p>Now we&rsquo;re starting to get blocked off:</p>
<figure>
    <img src="/embeds/2013/4-Blocked-off.png"/> 
</figure>

<p>And finally (after restarting), we find a stairway down:</p>
<figure>
    <img src="/embeds/2013/5-Going-down.png"/> 
</figure>

<p>Okay, that&rsquo;s all well and good. But what about inhabitants? We really need some critters to wonder around in here.</p>
<p>Say we wanted a Minotaur:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#a6e22e">make-thing</span> seeking-enemy
  [name <span style="color:#e6db74">&#34;minotaur&#34;</span>]
  [character <span style="color:#e6db74">#\M</span>]
  [color <span style="color:#e6db74">&#34;brown&#34;</span>])
</code></pre></div><p>Yeah&hellip; that&rsquo;s pretty boring. Honestly, I&rsquo;m not sure what sort of behavior to get them. If you have a good idea, drop a comment.</p>
<p>Better though, how about spiders. What I want is something that leaves behind a massive web. It turns out, between the <code>act</code> event on entities and the <code>on-enter</code> event on tiles, we have everything we need:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#a6e22e">make-thing</span> fleeing-enemy
  [name <span style="color:#e6db74">&#34;spider&#34;</span>]
  [character <span style="color:#e6db74">#\s</span>]
  [color <span style="color:#e6db74">&#34;silver&#34;</span>]
  [(<span style="color:#a6e22e">act</span> me world)
   (<span style="color:#66d9ef">define </span>loc (<span style="color:#a6e22e">thing-get</span> me <span style="color:#e6db74">&#39;location</span>))
   (<span style="color:#66d9ef">define </span>tile (<span style="color:#a6e22e">send</span> world tile-at (<span style="color:#a6e22e">pt-x</span> loc) (<span style="color:#a6e22e">pt-y</span> loc)))

   <span style="color:#75715e">; Try to move</span>
   (<span style="color:#a6e22e">thing-call</span> seeking-enemy <span style="color:#e6db74">&#39;act</span> me world)

   <span style="color:#75715e">; Check if we did (the old location is now empty)</span>
   <span style="color:#75715e">; If so, make that tile a web that fades when walked on</span>
   (<span style="color:#a6e22e">when</span> (null? (<span style="color:#a6e22e">send</span> world get-entities loc))
     (<span style="color:#66d9ef">define </span>old-tile (<span style="color:#a6e22e">make-thing</span> tile))

     (<span style="color:#a6e22e">thing-set!</span> tile <span style="color:#e6db74">&#39;character</span> (integer-&gt;char <span style="color:#ae81ff">206</span>))
     (<span style="color:#a6e22e">thing-set!</span> tile <span style="color:#e6db74">&#39;color</span> <span style="color:#e6db74">&#34;silver&#34;</span>)
     (<span style="color:#a6e22e">thing-set!</span> tile <span style="color:#e6db74">&#39;solid</span> <span style="color:#66d9ef">#t</span>)

     (<span style="color:#a6e22e">thing-set!</span> tile <span style="color:#e6db74">&#39;on-enter</span>
       (<span style="color:#66d9ef">lambda </span>(<span style="color:#a6e22e">entity</span> world)
         (<span style="color:#a6e22e">for</span> ([key (<span style="color:#a6e22e">in-list</span> <span style="color:#f92672">&#39;</span>(character color lighting walkable solid))])
           (<span style="color:#a6e22e">thing-set!</span> tile key (<span style="color:#a6e22e">thing-get</span> old-tile key))
           (<span style="color:#a6e22e">thing-set!</span> tile <span style="color:#e6db74">&#39;on-enter</span> (<span style="color:#66d9ef">lambda </span>_ (<span style="color:#a6e22e">void</span>)))))))])
</code></pre></div><p>That&rsquo;s actually really neat. When the spider leaves a tile, it creates a web. When any entity enters that tile, it wipes it out. It could do all sorts of other things as well, like sticking the player in place, but this seems good for the moment.</p>
<p>So how does it look in practice? Well:</p>
<figure>
    <img src="/embeds/2013/6-Webs-everywhere.png"/> 
</figure>

<p>Personally, I think it looks pretty awesome. And you can walk through them just as expected. All on the first try as well.</p>
<p>Next week, we&rsquo;ll either add some more content or I&rsquo;ll try to add archery (and other usable items). Or perhaps in celebration of the 4th, we&rsquo;ll try for fireworks! We&rsquo;ll see how that goes.</p>
<p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:</p>
<ul>
<li><a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike/tree/day-9">Racket Roguelike - Day 9</a></li>
<li><a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">Racket Roguelike - Up to date</a></li>
</ul>
<p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-9
git submodule init
git submodule update
racket main.rkt
</code></pre></div><p><strong>Edit:</strong></p>
<p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">raco pkg install github://github.com:jpverkamp/ascii-canvas/master
raco pkg install github://github.com:jpverkamp/noise/master
raco pkg install github://github.com:jpverkamp/thing/master
git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-9
racket main.rkt
</code></pre></div><p>For part 10, click here: <a href="https://blog.jverkamp.com/2013/07/05/racket-roguelike-10-levels-via-automata/">Racket Roguelike 10: Levels via automata!</a></p></div>
</article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script src="/custom.js"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
        
        

        <title>Racket Roguelike 9: Daedalus' wrath! | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/tomorrow-night.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Racket Roguelike 9: Daedalus' wrath!</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-06-28"><span class="year">2013</span> <span class="month">June</span> <span class="day">28</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-source/7drl">7DRL</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/games">Games</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/games/roguelikes">Roguelikes</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project/games/racket-roguelike">Racket Roguelike</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>I think by now it's well past time that we got to adding a bit more content. So far, here's what we have (bolded entries we actually used in day 8):</p>
<ul>
        <li>entities: <strong>rat</strong>, goblin, <strong>bomb</strong>, bomber goblin</li>
        <li>armor: <strong>leather</strong>, chain, plate, enchanted</li>
        <li>weapons: <strong>club</strong>, dagger, battle axe, longsword, magic sword</li>
        <li>potions: <strong>health potion</strong></li>
        <li>coins: <strong>copper</strong>, silver, gold, platinum</li>
        <li>levels: <strong>forest</strong>, <strong>caves</strong></li>
</ul>
<p>We can do better than that though!</p>
<!--more-->
<p>Let's start with new levels.</p>
<p>First, let's try making something with a bit more structure. For both the forest and the caves, we have nice smooth flowing curves, let's go for some straight lines.</p>
<p>The basic idea is to use the same random number generators but at a different scale. We'll sample the points at every 10 or so tiles. If the sampled region is positive, include it. If not, don't. Sounds simple enough; here's some</p>
<p>First, check if we're in the 3 wide potential halls. We'll take the remainder for ten, if it's 4-6, use it.</p>
<pre class="scheme"><code>; Guaranteed wall if not x or y = 5 +- 1 (mod 10)
(define maybe-hall?
  (or (&lt;= 4 (remainder (abs x) 10) 6)
      (&lt;= 4 (remainder (abs y) 10) 6)))</code></pre>
<p>We could have used 0, 1, and 9, but the math is just more complicated.</p>
<p>Next, we want to check if we have an empty space:</p>
<pre class="scheme"><code>; Find the endpoints
(define xlo (floor (/ x 10)))
(define ylo (floor (/ y 10)))

; Calculate if we'd have an open space
(define good-hall?
  (or (and (&gt; (simplex (* 0.5 xlo)       (* 0.5 ylo)       seed) -0.25)
           (&gt; (simplex (* 0.5 (+ xlo 1)) (* 0.5 ylo)       seed) -0.25))
      (and (&gt; (simplex (* 0.5 xlo)       (* 0.5 ylo)       seed) -0.25)
           (&gt; (simplex (* 0.5 xlo)       (* 0.5 (+ ylo 1)) seed) -0.25))))</code></pre>
<p>I started with a multiplier at 0.1 and a threshold at 0, but that wasn't giving enough variation, so I increased the scale and lowered the threshold. This seems to give good results, so we'll go with it. Like all of the level generation parameters, it's easy enough though.</p>
<p>Finally, let's make stairs. We'll add an extra empty region around 0x0; otherwise, both tests will have to be positive:</p>
<pre class="scheme"><code>; Figure out which case we have
(cond
  ; Central section
  [(and (&lt;= -3 x 3) (&lt;= -3 y 3))
   (make-thing empty)]
  ; Guaranteed path
  [(and maybe-hall? good-hall?)
   (make-thing empty)]
  ; Wall
  [else
   (make-thing wall)])</code></pre>
<p>But what about stairs? Everyone likes stairs!</p>
<p>First, let's restrict stairs more this time. We'll only put stairs in intersections that have already been generated and even then only in 1/10. How do we do that? First, restrict to the 5x5 points in each 10x10 grid:</p>
<pre class="scheme"><code>; Maybe a stairway if both are five
(define maybe-stairs?
  (= 5 (remainder (abs x) 10) (remainder (abs y) 10)))</code></pre>
<p>Then swap out the middle section of the <code>cond</code>:</p>
<pre class="scheme"><code>; Guaranteed path
    [(and maybe-hall? good-hall?)
     ; Check for stairs
     (if (and maybe-stairs? (zero? (random 10)))
         (make-thing stairs-down)
         (make-thing empty))]</code></pre>
<p>With this, we have a nice maze going on already. Here are a few examples. Start with a wide open world:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/1-Into-the-darkness.png"><img src="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/1-Into-the-darkness.png" /></a></p>
<p>Move a bit and we already have a few nicely squared off choices:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/2-Two-choices.png"><img src="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/2-Two-choices.png" /></a></p>
<p>Go a bit further and now we have a full intersection:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/3-Intersection.png"><img src="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/3-Intersection.png" /></a></p>
<p>Now we're starting to get blocked off:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/4-Blocked-off.png"><img src="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/4-Blocked-off.png" /></a></p>
<p>And finally (after restarting), we find a stairway down:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/5-Going-down.png"><img src="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/5-Going-down.png" /></a></p>
<p>Okay, that's all well and good. But what about inhabitants? We really need some critters to wonder around in here.</p>
<p>Say we wanted a Minotaur:</p>
<pre class="scheme"><code>(make-thing seeking-enemy
  [name "minotaur"]
  [character #\M]
  [color "brown"])</code></pre>
<p>Yeah... that's pretty boring. Honestly, I'm not sure what sort of behavior to get them. If you have a good idea, drop a comment.</p>
<p>Better though, how about spiders. What I want is something that leaves behind a massive web. It turns out, between the <code>act</code> event on entities and the <code>on-enter</code> event on tiles, we have everything we need:</p>
<pre class="scheme"><code>(make-thing fleeing-enemy
  [name "spider"]
  [character #\s]
  [color "silver"]
  [(act me world)
   (define loc (thing-get me 'location))
   (define tile (send world tile-at (pt-x loc) (pt-y loc)))

   ; Try to move
   (thing-call seeking-enemy 'act me world)

   ; Check if we did (the old location is now empty)
   ; If so, make that tile a web that fades when walked on
   (when (null? (send world get-entities loc))
     (define old-tile (make-thing tile))

     (thing-set! tile 'character (integer-&gt;char 206))
     (thing-set! tile 'color "silver")
     (thing-set! tile 'solid #t)

     (thing-set! tile 'on-enter
       (lambda (entity world)
         (for ([key (in-list '(character color lighting walkable solid))])
           (thing-set! tile key (thing-get old-tile key))
           (thing-set! tile 'on-enter (lambda _ (void)))))))])</code></pre>
<p>That's actually really neat. When the spider leaves a tile, it creates a web. When any entity enters that tile, it wipes it out. It could do all sorts of other things as well, like sticking the player in place, but this seems good for the moment.</p>
<p>So how does it look in practice? Well:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/6-Webs-everywhere.png"><img src="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/6-Webs-everywhere.png" /></a></p>
<p>Personally, I think it looks pretty awesome. And you can walk through them just as expected. All on the first try as well.</p>
<p>Next week, we'll either add some more content or I'll try to add archery (and other usable items). Or perhaps in celebration of the 4th, we'll try for fireworks! We'll see how that goes.</p>
<p>As always, if you'd like to see all of the code for this project, you can do so on GitHub: - <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike/tree/day-9">Racket Roguelike - Day 9</a> - <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">Racket Roguelike - Up to date</a></p>
<p>If you'd like to try it yourself, you'll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<pre class="bash"><code>git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-9
git submodule init
git submodule update
racket main.rkt</code></pre>
<p>For part 10, click here: <a href="http://blog.jverkamp.com/2013/07/05/racket-roguelike-10-levels-via-automata">Racket Roguelike 10: Levels via automata!</a></p>
<div><h3 class="ranking-title">Racket Roguelike</h3><ol><li><a href="http://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-io-and-you">Racket Roguelike 1: A GUI, screens, I/O, and you!</a></li><li><a href="http://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves">Racket Roguelike 2: Infinite caves!</a></li><li><a href="http://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere">Racket Roguelike 3: Rats, rats, everywhere!</a></li><li><a href="http://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters">Racket Roguelike 4: Slightly smarter critters!</a></li><li><a href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my">Racket Roguelike 5: Armors and weapons and potions, oh my!</a></li><li><a href="http://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper">Racket Roguelike 6: Dig deeper!</a></li><li><a href="http://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness">Racket Roguelike 7: Into darkness!</a></li><li><a href="http://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words">Racket Roguelike 8: A million words!</a></li><li><a href="http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath">Racket Roguelike 9: Daedalus' wrath!</a></li></ol></div>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Racket Roguelike 9: Daedalus' wrath!";
var disqus_url = "http://blog.jverkamp.com/2013/06/28/racket-roguelike-9-daedalus-wrath/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/06/28/world-war-z">← World War Z</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n">A programming puzzle: f(f(n)) = -n →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/06/26/swap-list-nodes">← Swap list nodes</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2013/06/29/a-programming-puzzle-ffn-n">A programming puzzle: f(f(n)) = -n →</a></li></ul></nav>

                <div class="legal">
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
        
        

        <title>Extending Racket structs to bitfields | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="http://blog.jverkamp.com/category/archives/2015">2015</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="http://blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Extending Racket structs to bitfields</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-09-23"><span class="year">2013</span> <span class="month">Sept</span> <span class="day">23</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-topic/bitfields">Bitfields</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/data-structures">Data Structures</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>Keen eyed observers may have noticed that last Friday when I <a href="http://blog.jverkamp.com/2013/09/20/deploy-racket-libraries-to-planet-2">posted about converting</a> my various Racket libraries to Planet 2 packages, that there was a new package there I haven't otherwise talked about: <a href="http://racket.jverkamp.com/bit-struct/">bit-struct</a>. Today seems like a good time to talk about that. Theoretically, I'll also have another post or two this week showing exactly what I'm doing with it (spoilers: it involves sending on the order of billions of DNS requests<span class="footnote"><sup><a href="#footnote-1">[1]</a></sup></span>).</p>
<!--more-->
<p>If you'd like to go straight to the code, it's available on GitHub: <a href="https://github.com/jpverkamp/bit-struct">jpverkamp/bit-struct</a>. Along with the new Planet 2 packages, I also have documentation now, available here: <a href="http://racket.jverkamp.com/bit-struct/">bit-struct documentation</a>.</p>
<p>The basic idea is we want to take straight forward Racket structs (already rather useful in their own right), limit them to only numeric values, and extend them to convert the structs to bit fields (as RacketÂ <code><a href="http://docs.racket-lang.org/search/index.html?q=bytes">bytes</a></code>) and back. In theory<span class="footnote"><sup><a href="#footnote-2">[2]</a></sup></span>, this will allow interaction with systems that have very specific memory layouts, such as networking packets. As a bit of a spoiler, this should be both completely valid and do exactly what you might expect<span class="footnote"><sup><a href="#footnote-3">[3]</a></sup></span>:</p>
<pre class="scheme"><code>(define-bit-struct dns
  ([id      16]
   [qr      1]  [opcode  4]  [aa      1]  [tc      1]  [rd      1]
   [ra      1]  [z       3]  [rcode   4]
   [qdcount 16]
   [ancount 16]
   [nscount 16]
   [arcount 16]
   [data    _]))</code></pre>
<p>The extra advantage in this case is that (via the magic of macros) three additional functions are also defined:</p>
<ul>
        <li><code>(build-dns #:key val ...)</code> - take any number of keyword arguments matching the struct fields above and create the struct, any unspecified values are set to 0</li>
        <li><code>(dns->bytes data)</code> - convert a struct into a bit field, using the given bit widths</li>
        <li><code>(bytes->dns buffer)</code> - convert a bit field back into a struct, again using the bit widths</li>
</ul>
<p>Here are some more examples:</p>
<pre class="scheme"><code>&gt; (define packet
    (build-dns
     #:id (random 65536)
     #:tc 1
     #:qdcount 1
     #:data
     (bytes-append
      #"\3www\6google\3com\0"
      (bytes 0 1)
      (bytes 0 1))))
&gt; packet
(dns 3202 0 0 0 1 0 0 0 0 1 0 0 0 #"\3www\6google\3com\0\0\1\0\1")
&gt; (dns-&gt;bytes packet)
#"\f\202\2\0\0\1\0\0\0\0\0\0\3www\6google\3com\0\0\1\0\1"
&gt; (bytes-&gt;dns (dns-&gt;bytes packet))
(dns 3202 0 0 0 1 0 0 0 0 1 0 0 0 #"\3www\6google\3com\0\0\1\0\1")</code></pre>
<p>Nice and straight forward. The real question though is what sort of magic did we need to get this all working? Just as useful as having the package itself is the additional experience with a relative complicated macro.</p>
<p>First, we need to introduce some more names. Normally, that isn't particularly straight forward, since we have to bend the rules of <a href="https://en.wikipedia.org/wiki/hygienic_macros">Hygienic macro</a> just a bit. Luckily though, Racket provides the tools to do just that:Â <code><a href="http://docs.racket-lang.org/search/index.html?q=with-syntax">with-syntax</a></code>Â andÂ <code><a href="http://docs.racket-lang.org/search/index.html?q=format-id">format-id</a></code>. Essentially, <code>with-syntax</code> is similar to <code>syntax-case</code> in that it binds more syntax variables. <code>format-id</code> is basically an extension to format that attaches scope to the new <code>id</code> in order to make cleaner error message. Always a plus. :) Here's how all of that looks:</p>
<pre class="scheme"><code>; Bind a struct (and normal functions) plus these new functions:
; build-* takes keyword arguments for parameters (default = 0)
; *-&gt;bytes turns a struct into bytes
; bytes-&gt;* takes bytes and returns a struct
(define-syntax (define-bit-struct stx)
  (syntax-case stx ()
    [(_ struct-name ([name* bits*] ...))
     ; Get some identifiers we'll need
     (with-syntax ([builder-name (format-id stx "build-~a" #'struct-name)]
                   [bytes-&gt;-name (format-id stx "bytes-&gt;~a" #'struct-name)]
                   [-&gt;bytes-name (format-id stx "~a-&gt;bytes" #'struct-name)])
       ...)]))</code></pre>
<p>More or less straight forward. It does require <a href="http://docs.racket-lang.org/reference/stx-patterns.html?q=with-syntax#(form._((lib._racket/private/stxcase-scheme..rkt)._syntax-case))" data-pltdoc="x">syntax-<wbr />case</a>Â rather than <a href="http://docs.racket-lang.org/reference/stx-patterns.html?q=with-syntax#(form._((lib._racket/private/stxcase-scheme..rkt)._syntax-rules))" data-pltdoc="x">syntax-<wbr />rules</a>Â which I normally use (in order to have access to the raw <code>stx</code> to pass to <code>format-id</code>, but other than that, a pretty normal macro. Now each function in turn.</p>
<p>First, <code>build-*</code>.Â This one does the magic of creating a function with dynamic keyword parameters that match whatever fields the struct has. To do that, we need the functionÂ <code><a href="http://docs.racket-lang.org/search/index.html?q=make-keyword-procedure">make-keyword-procedure</a></code>, whichÂ takes a procedure of the formÂ <code>((Listof keys) (Listof values) any ... . -> . any)</code>. So if you define a functionÂ <code>(Î» (keys vals . args) ...)</code>, keys and values are lists of the same length, the first containing the keywords and the latter containing the associated values. You could easily make it into an association list if you wanted just by callingÂ <code>(map list keys vals)</code>Â (or with <code>for</code> as I did below). I did have to convert them though. As given, they are keywords but I wanted symbols. I'm not sure there's a direct way to convert between those two, but it's easy enough via an intermediate string.</p>
<p>In this case, I'm ignoring theÂ <code>rest</code>Â parameter so only keyword parameters are allowed.</p>
<pre class="scheme"><code>; Create the builder function
(define builder-name
  (make-keyword-procedure
   (Î» (keys vals)
      ; Create an association map from the new values
      (define new-values
        (for/list ([k (in-list (map string-&gt;symbol
                                    (map keyword-&gt;string keys)))]
                   [v (in-list vals)])
          (list k v)))

      ; Build a new structure
      (apply
       maker-name
       (for/list ([name (in-list '(name* ...))]
                  [bits (in-list '(bits* ...))])
         (cond
           [(assoc name new-values)
            =&gt; (Î» (kv) (second kv))]
           [(eq? bits '_) #""]
           [else            0]))))))</code></pre>
<p>After we have that association list, we'll use a second loop to create the structure. Since we're inside of the macro, <code>'(name* ...)</code> expands to a list of whatever was in the first position for each argument when <code>define-bit-struct</code> was called. Likewise, bits is a list of the bit widths. With all of that, we can loop across these values. Another neat trick in this code is the use of <code>=></code> in the <code>cond</code>. Essentially, <code>assoc</code> will take the association list we created and query it. If the key is there, it will call the given function, passing the key/value pair as an argument (<code>kv</code>). If it's not there, use the <code>else</code> case to set the value to 0.</p>
<pre class="scheme"><code>; Create the parser function
(define (bytes-&gt;-name buffer)
  ; Set names with parameters (easier than making lots of ids)
  (define name* (make-parameter 0)) ...
  ; Unpack fields into those parameters as integers
  ; _ is different, it stores any remaining bytes
  (define _
    (for/fold ([offset 0])
              ([name (in-list (list name* ...))]
               [bits (in-list '(bits* ...))])
      (cond
        [(number? bits)
         (name (extract-bytes buffer offset (+ offset bits)))
         (+ offset bits)]
        [else
         (name (subbytes buffer (quotient offset 8)))
         offset])))
  ; Create the structure
  (apply
   maker-name
   (for/list ([name (list name* ...)])
     (name))))</code></pre>
<p>For the second function, we want to be able to take a sequence of bytes and pull one of these structures out of it. If we need to get only part of a byte or extend over multiple bytes (both of which happen in the DNS example), the function <code>extract-bytes</code> will do just that:</p>
<pre class="scheme"><code>; Extract bits from a bit field
(define (extract-bytes buffer from [to #f])
  ; Extract the bytes we're interested in
  (define f (quotient from 8))
  (define t (if to
                (let ([q (quotient to 8)])
                  (if (zero? (remainder to 8)) q (+ 1 q)))
                (bytes-length buffer)))
  (define chunk (subbytes buffer f t))
  ; Convert to a base 256 number
  (define numeric
    (for/fold ([total 0])
              ([byte (in-bytes chunk)])
      (+ byte (* total 256))))
  ; Shift off the ends
  (bitwise-and
   (arithmetic-shift numeric
                     (if to
                         (let ([r (remainder to 8)])
                           (if (zero? r) r (- r 8)))
                         0))
   (- (arithmetic-shift 1 (- to from)) 1)))</code></pre>
<p>First, we get just the bytes we're interested in as a list. Then, we convert that to a single number by treating the list as a 'base 256' number. Finally, we use an <code>arithmetic-shift</code> to pull off bits at one end and a <code>bitwise-and</code> with a mask to select only the ones from the other end that we want. The bit twiddling gets a bit complicated here, but once it all works, you don't have to think about it any more--just use it.</p>
<pre class="scheme"><code>; Create the -&gt;bytes function
(define (-&gt;bytes-name data-struct)
  (define data (struct-&gt;vector data-struct))
  (let loop ([bits '(bits* ...)]
             [buffer 0]
             [buffer-bits 0]
             [index 1])
    (cond
      ; Full buffer, transfer it
      [(and (&gt; buffer-bits 0) (zero? (remainder buffer-bits 8)))
       (bytes-append
        (number-&gt;bytes buffer (quotient buffer-bits 8))
        (loop bits 0 0 index))]
      ; Nothing left
      [(null? bits)
       #""]
      ; Current value is bytes, copy directly
      [(eq? (first bits) '_)
       (bytes-append
        (vector-ref data index)
        (loop (rest bits) buffer buffer-bits (+ index 1)))]
      ; Otherwise, add to buffer
      [else
       (loop
        (rest bits)
        (+ (* buffer (arithmetic-shift 1 (first bits)))
           (vector-ref data index))
        (+ buffer-bits (first bits))
        (+ index 1))])))</code></pre>
<p>The third and final function's code is actually fairly similar, in that it has to loop over the names/bit widths. One additional part that it does is that it uses a <code>named let</code> to collect the current offset within a byte. That way we collect partial bytes in a <code>buffer</code> until we have some multiple of 8. Then we use the dual to <code>extract-bytes</code> (<code>number-></code>) to convert back to bytes.</p>
<p>And that's all there is to it. It's certainly not bullet proof just yet (for example, I know that negative values will probably do strange things to it, as will providing keywords that don't exist to <code>build-*</code>), but it's certainly a good first step. It should be useful later this week.</p>
<p>As always, today's code is available on GitHub: <a href="https://github.com/jpverkamp/bit-struct">jpverkamp/bit-struct</a>. This time, there's also documentation available here: <a href="http://racket.jverkamp.com/bit-struct/">bit-struct documentation</a>.</p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol><li><a name="footnote-1"></a>Not to DoSing anyone though (at least not on purpose)</li><li><a name="footnote-2"></a>In practice as well actually; we'll see that later this week</li><li><a name="footnote-3"></a>If what you expect is a struct with the given names and ordered fields each containing the given number of bits</li></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Extending Racket structs to bitfields";
var disqus_url = "http://blog.jverkamp.com/2013/09/23/extending-racket-structs-to-bitfields/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/09/20/deploy-racket-libraries-to-planet-2">â Deploy Racket libraries to Planet 2</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2013/09/25/extending-rackets-dns-capabilities">Extending Racket's DNS capabilities â</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/09/20/deploy-racket-libraries-to-planet-2">â Deploy Racket libraries to Planet 2</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2013/09/25/extending-rackets-dns-capabilities">Extending Racket's DNS capabilities â</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
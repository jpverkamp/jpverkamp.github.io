<!doctype html><html><head><title>Diffie-Hellman Key Exchange – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Diffie-Hellman Key Exchange</h1><div class=entry-meta><span class=entry-date>2013-09-14</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/08/30/visualizing-the-monkey-grid/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/09/19/smallest-consecutive-four-factor-composites/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/08/30/visualizing-the-monkey-grid/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2013/09/19/smallest-consecutive-four-factor-composites/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a class=taxonomy-value href=/programming/topics/asymmetric-encryption>Asymmetric encryption</a></li><li><a class=taxonomy-value href=/programming/topics/key-exchange>Key Exchange</a></li><li><a href=https://blog.jverkamp.com/2013/08/06/authorship-attribution-part-3/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/mathematics>Mathematics</a><a href=https://blog.jverkamp.com/2014/01/14/graph-radius/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2012/12/22/nested-primes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/prime-numbers>Prime Numbers</a><a href=https://blog.jverkamp.com/2013/09/19/smallest-consecutive-four-factor-composites/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/public-key-cryptography>Public-key cryptography</a><a href=https://blog.jverkamp.com/2015/08/10/setting-up-postfix-and-opendkim/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/08/30/visualizing-the-monkey-grid/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/09/19/smallest-consecutive-four-factor-composites/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/09/10/the-mortal-instruments-city-of-bones/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/09/19/smallest-consecutive-four-factor-composites/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Today we&rsquo;re going to be talking about cryptography, specifically <a href=https://en.wikipedia.org/wiki/Diffie-Hellman%20key%20exchange>Diffie-Hellman key exchange</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. The basic idea isn&rsquo;t necessarily to communicate in secret, but rather to establish the information that makes doing so much easier. </p><p>The basic idea behind Diffie-Hellman is actually fairly straightforward. We&rsquo;ll go ahead and let this nice image from <a href=https://en.wikipedia.org/wiki/Diffie-Hellman%20key%20exchange>Wikipedia</a><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> illustrate for us.</p><p>Assume that Alice and Bob wish to establish some secret key. Better yet, they wish to do so such that no eavesdropper (Eve) can figure out what that key is, even if Eve can intercept any communication between Alice and Bob.</p><p>The first step is for Alice and Bob to choose some public piece of information (in this case, yellow paint) and a piece of private information each (red paint for Alice and teal for Bob). They then each mix their private color with the public color. Throughout this process, the assumption is that it is easy to mix paint and that the results for mixing two colors will always be the same, but at the same time it is difficult to separate paints once mixed. It turns out to be true for paint, but also true for <a href=https://en.wikipedia.org/wiki/modular%20exponentiation>modular exponentiation</a> (which we&rsquo;ll get to shortly). In any case, once both have mixed their paint, they&rsquo;ll send their mixed paint buckets to each other.</p><figure><img src=/embeds/2013/dh-1.png></figure><p>For the next step, Alice and Bob each have their private paint and a mix of the other&rsquo;s private paint with the shared public color. If they then mix in their own secret, they get this ugly sort of brown<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. But the secret is, each will have the exact same ugly shade of brown, since they each mixed the same three colors to get it.</p><figure><img src=/embeds/2013/dh-2.png></figure><p>But look back over what was sent. The public information is the shared paint color (yellow) and the two mixed colors (blue and orange). But at no point is either secret color or the final chosen secret shared. What&rsquo;s more, since you can&rsquo;t unmix colors and mixing the two secrets will double the amount of yellow, there&rsquo;s no way to get to that shade of brown from the three pieces of public information. Ergo, Alice and Bob have a (theoretically) secure shared secret.</p><p>How could you use it? Perhaps given a paint color, you can make special goggles that can only see that specific frequency. Then Alice and Bob could write whatever they want in ugly brown on other-nearly-identical-but-not-quite brown and no one (but Bob and Alice) would be able to read it. Who knows. The point is, how do we turn this into code?</p><p>Well, it turns out that the algorithm is just as straight forward:</p><table><thead><tr><th>Alice</th><th></th><th></th><th></th><th><strong>Bob</strong></th><th></th><th></th></tr></thead><tbody><tr><td>Secret</td><td>Public</td><td>Calculates</td><td>Sends</td><td>Calculates</td><td>Public</td><td>Secret</td></tr><tr><td>a</td><td>p, g</td><td></td><td>p,g →</td><td></td><td></td><td>b</td></tr><tr><td>a</td><td>p, g, A</td><td>ga mod p = A</td><td>A →</td><td></td><td>p, g</td><td>b</td></tr><tr><td>a</td><td>p, g, A</td><td></td><td>← B</td><td>gb mod p = B</td><td>p, g, A, B</td><td>b</td></tr><tr><td>a, <strong>s</strong></td><td>p, g, A, B</td><td>Ba mod p = s</td><td></td><td>Ab mod p = s</td><td>p, g, A, B</td><td>b, <strong>s</strong></td></tr></tbody></table><p>We&rsquo;re going to need some math / number theory (specifically, the ability to generate a prime number <em>p</em>, calculating a <a href=https://en.wikipedia.org/wiki/Primitive%20root%20modulo%20n>primitive root</a> <em>g</em>, and then performing <a href=https://en.wikipedia.org/wiki/modular%20exponentiation>modular exponentiation</a>. Luckily, we have the <code><a href="http://docs.racket-lang.org/search/index.html?q=math/number-theory">math/number-theory</a></code>
 module:</p><ul><li><code><a href="http://docs.racket-lang.org/search/index.html?q=prime?">prime?</a></code>
- test if a number is prime</li><li><code><a href="http://docs.racket-lang.org/search/index.html?q=random-prime">random-prime</a></code>
- determine a random prime number within a given range</li><li><code><a href="http://docs.racket-lang.org/search/index.html?q=primitive-roots">primitive-roots</a></code>
- return a list of primitive roots for a prime <em>p</em></li><li><code><a href="http://docs.racket-lang.org/search/index.html?q=with-modulus">with-modulus</a></code>
- functions within this block are performed with this modulus</li><li><code><a href="http://docs.racket-lang.org/search/index.html?q=modexpt">modexpt</a></code>
- perform fast modular exponentiation</li></ul><p>With all of that, we should be good to go. As always, if you&rsquo;d like to do so, you can follow along on GitHub: <a href=https://github.com/jpverkamp/small-projects/tree/master/blog/dh/ target=_blank rel=noopener>jpverkamp/dh</a>.</p><p>To make the code a little more interesting, we&rsquo;re also going to use Racket&rsquo;s <code><a href="http://docs.racket-lang.org/search/index.html?q=TCP%20library">TCP library</a></code>
. We&rsquo;ll create a server and client that will set up the Diffie-Hellman secret key.</p><p>First, we&rsquo;ll create the TCP connection:</p><h3>Client</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>start-dh-client</span> [server-host <span style=color:#e6db74>&#34;localhost&#34;</span>] [server-port <span style=color:#ae81ff>8000</span>])
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Generate an ID for this client</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>dh-debug-id</span> (<span style=color:#a6e22e>format</span> <span style=color:#e6db74>&#34;client ~a&#34;</span> (<span style=color:#a6e22e>random</span> RANGE)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Connect to the DH server</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>from-server</span> to-server)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>tcp-connect</span> server-host server-port))
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span></code></pre></div><h3>Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Create the main server</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>start-dh-server</span> [port <span style=color:#ae81ff>8000</span>])
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Start listening</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>server (<span style=color:#a6e22e>tcp-listen</span> port))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Accept each client in their own thread</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>from-client</span> to-client) (<span style=color:#a6e22e>tcp-accept</span> server))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>current-thread-id</span> (+ <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>current-thread-id</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>thread</span> (<span style=color:#a6e22e>dh-client-thread</span> from-client to-client))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>loop</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>dh-client-thread</span> from-client to-client)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>λ</span> ()
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Store the ID for this client</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>dh-debug-id</span> (<span style=color:#a6e22e>format</span> <span style=color:#e6db74>&#34;client thread ~a&#34;</span> (<span style=color:#a6e22e>current-thread-id</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Read the shared public values</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>p (<span style=color:#a6e22e>recv</span> from-client))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>g (<span style=color:#a6e22e>recv</span> from-client))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Read the secret from A</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>A (<span style=color:#a6e22e>recv</span> from-client))
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Then we&rsquo;ll generate the prime <em>p</em> and primitive root <em>g</em> on the client, sending both to the server (<code>send</code> and <code>recv</code> are just wrappers to add some debugging code and make sure that we send a newline and flush after each message; you can find them in <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/dh/dh-shared.rkt target=_blank rel=noopener>dh-shared.rkt</a>):</p><h3>Client</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Generate and share the public information</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>p (<span style=color:#a6e22e>random-prime</span> RANGE))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>g (<span style=color:#a6e22e>first</span> (<span style=color:#a6e22e>shuffle</span> (<span style=color:#a6e22e>primitive-roots</span> p))))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>send</span> p to-server)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>send</span> g to-server)
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span></code></pre></div><h3>Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Read the shared public values</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>p (<span style=color:#a6e22e>recv</span> from-client))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>g (<span style=color:#a6e22e>recv</span> from-client))
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Then both client and server will generate and use their secrets along with <em>p</em> and <em>g</em>:</p><h3>Client</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Generate my secret integer, send the shared secret to the server</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>a (<span style=color:#a6e22e>random</span> RANGE))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>A (<span style=color:#a6e22e>with-modulus</span> p (<span style=color:#a6e22e>modexpt</span> g a)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>send</span> A to-server)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Get their half of the shared secret</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>B (<span style=color:#a6e22e>recv</span> from-server))
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span></code></pre></div><h3>Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Read the secret from A</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>A (<span style=color:#a6e22e>recv</span> from-client))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Generate my own secret number and send it back</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>b (<span style=color:#a6e22e>random</span> RANGE))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>B (<span style=color:#a6e22e>with-modulus</span> p (<span style=color:#a6e22e>modexpt</span> g b)))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>send</span> B to-client)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Finally, both will calculate the secret:</p><h3>Client</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Calculate the secret</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>s (<span style=color:#a6e22e>with-modulus</span> p (<span style=color:#a6e22e>modexpt</span> B a)))
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span></code></pre></div><h3>Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Generate the shared secret</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>s (<span style=color:#a6e22e>with-modulus</span> p (<span style=color:#a6e22e>modexpt</span> A b)))
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>If all goes well (and there&rsquo;s no reason to think that it wouldn&rsquo;t), both will have the same secret. From here, you can do anything you want with the secret. For example, we could use it for the seed in Racket&rsquo;s <a href=https://en.wikipedia.org/wiki/Pseudorandom%20number%20generator>random number generator</a> and use that with a basic XOR encryption algorithm to talk <a href=https://en.wikipedia.org/wiki/XOR%20encryption>completely securely</a><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> (<code>xor-encode/decode</code> are available in <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/dh/dh-shared.rkt target=_blank rel=noopener>dh-shared.rkt</a>):</p><h3>Client</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Use it to seed the PRNG</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>random-seed</span> s)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Ask the user for input, encode it, send it</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;client: &#34;</span>)
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>message (<span style=color:#a6e22e>read-line</span>))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>send</span> (<span style=color:#a6e22e>xor-encode</span> message) to-server)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Read a response from the server, print it out</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>response (<span style=color:#a6e22e>xor-decode</span> (read from-server)))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;server: ~a\n&#34;</span> response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Loop unless &#39;exit&#39;</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>unless</span> (equal? message <span style=color:#e6db74>&#34;exit&#34;</span>)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>loop</span>)))
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span></code></pre></div><h3>Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Use it to seed the PRNG</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>random-seed</span> s)
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Read a message from the client, print it out</span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>define </span>message (<span style=color:#a6e22e>xor-decode</span> (read from-client)))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;client ~a: ~a\n&#34;</span> (<span style=color:#a6e22e>current-thread-id</span>) message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Respond politely</span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>define </span>response
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>if </span>(equal? message <span style=color:#e6db74>&#34;exit&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Good-bye.&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Hello world.&#34;</span>))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>send</span> (<span style=color:#a6e22e>xor-encode</span> response) to-client)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Loop unless &#39;exit&#39;</span>
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>unless</span> (equal? message <span style=color:#e6db74>&#34;exit&#34;</span>)
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>loop</span>)))
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>After that&rsquo;s all done, clean up the ports we opened and all is well with the world:</p><h3>Client</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Close down the connection</span>
</span></span><span style=display:flex><span>  (close-input-port from-server)
</span></span><span style=display:flex><span>  (close-output-port to-server))
</span></span></code></pre></div><h3>Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Clean up the connection</span>
</span></span><span style=display:flex><span>    (close-input-port from-client)
</span></span><span style=display:flex><span>    (close-output-port to-client)))
</span></span></code></pre></div><p>And that&rsquo;s really all you need. Let&rsquo;s take a look at what each end sees (with <code>(dh-debug-mode #t)</code>, see <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/dh/dh-shared.rkt target=_blank rel=noopener>dh-shared.rkt</a>):</p><h3>Client</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:localhost&gt;): 4391</span>
</span></span><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:localhost&gt;): 3813</span>
</span></span><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:localhost&gt;): 3150</span>
</span></span><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:localhost&gt;): 4132</span>
</span></span><span style=display:flex><span>client: hi
</span></span><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:localhost&gt;): wpfCvQ==</span>
</span></span><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:localhost&gt;): XnzChcKCEC9Tw6oRd8KHBQ==</span>
</span></span><span style=display:flex><span>server: Hello world.
</span></span><span style=display:flex><span>client: exit
</span></span><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:localhost&gt;): wrvDshI3</span>
</span></span><span style=display:flex><span>client <span style=color:#ae81ff>52989</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:localhost&gt;): wqvDuHLDtSbCkgsJw4w=</span>
</span></span><span style=display:flex><span>server: Good-bye.
</span></span></code></pre></div><h3>Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>server listening
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:tcp-accepted&gt;): 4391</span>
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:tcp-accepted&gt;): 3813</span>
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:tcp-accepted&gt;): 3150</span>
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:tcp-accepted&gt;): 4132</span>
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:tcp-accepted&gt;): wpfCvQ==</span>
</span></span><span style=display:flex><span>client 1: hi
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:tcp-accepted&gt;): XnzChcKCEC9Tw6oRd8KHBQ==</span>
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> recv <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;input-port:tcp-accepted&gt;): wrvDshI3</span>
</span></span><span style=display:flex><span>client 1: exit
</span></span><span style=display:flex><span>client thread <span style=color:#ae81ff>1</span> send <span style=color:#f92672>(</span><span style=color:#75715e>#&lt;output-port:tcp-accepted&gt;): wqvDuHLDtSbCkgsJw4w=</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>There you have it. You can see the four pieces of information sent (<em>p</em>, <em>g</em>, <em>A</em>, <em>B</em> in that order for either), but with just those four, I challenge you to decode the messages being sent (granted, you can see them, but still&mldr;). As a note, I <a href=https://en.wikipedia.org/wiki/Base64>Base64</a> encoded the messages so that they would be easier to <code>read</code>, but it&rsquo;s not strictly necessary.</p><p>As always, the source code is available on GitHub: <a href=https://github.com/jpverkamp/small-projects/tree/master/blog/dh/ target=_blank rel=noopener>jpverkamp/dh</a>. Check it out!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Inspired by the <a href=http://programmingpraxis.com/2013/09/12/diffie-hellman-key-exchange/ target=_blank rel=noopener>most recent post</a> from <a href=http://programmingpraxis.com/ target=_blank rel=noopener>Programming Praxis</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Public domain&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Here&rsquo;s where the analogy breaks down somewhat; almost all trios of paint will end up brown&mldr;&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>If Racket&rsquo;s RNG were cryptographically secure (it&rsquo;s not)&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
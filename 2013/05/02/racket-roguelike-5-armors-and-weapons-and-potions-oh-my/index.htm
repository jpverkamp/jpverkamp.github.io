<!DOCTYPE html>
<html>
<head>
        
        

        <title>Racket Roguelike 5: Armors and weapons and potions, oh my! | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/tomorrow-night.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Racket Roguelike 5: Armors and weapons and potions, oh my!</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-05-02"><span class="year">2013</span> <span class="month">May</span> <span class="day">2</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-source/7drl">7DRL</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/games">Games</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/games/roguelikes">Roguelikes</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project/games/racket-roguelike">Racket Roguelike</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>Another week, another step towards building a roguelike in Racket. This week, we're going to build another basic system (like the critters) that can easily be expanded with all sorts of crazy content: items and inventory.</p>
<!--more-->
<p>If you'd like to start at the beginning, click here: <a href="http://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-io-and-you">Racket Roguelike 1: A GUI, screens, I/O, and you!</a></p>
<p>This time around, let's start with the kinds of items that we want to support. As you may have guessed from the post title, we'll start with three: armor, weapons, and potions for boosted attack, defense, and temporary effects in turn.</p>
<p>First, we need a base <code>thing</code> on which we can base all of the rest of the items:</p>
<pre class="scheme"><code>; items.rkt

; All items have:
; - a display char/item if they're on the ground
; - if they're consumed or not (picked up)
; - methods for:
; -- being picked up
; -- being dropped
(define-thing item
  [character #\x]
  [color "white"]
  [consumable #f]
  [category 'unknown]
  [(on-pick-up item entity world)   (void)]
  [(on-drop item entity world) (void)])</code></pre>
<p>First, we have the basic display features all of our items have. Then we have a flag that basically identifies if you can wear an item (<code>(not consumable)</code>) or if you consume it immediately (<code>consumable</code>).</p>
<p>Next, we have a category. Basically, our model will be that you can hold one item of each category at a given time. This way, you can have one kind of armor and one weapon and that's it. That will save us from having to make any sort of complicated inventory, although this same system could be adapted to a more flexible category to maximum count mapping.</p>
<p>Finally, we have two methods. I really do love functional programming when things like this come up. Basically (as should be obvious from the names), the first method will be called when them item is picked up (also when a consumable item is used), the second when it's dropped (never called for consumables).</p>
<p>So how does this work for an armor definition?</p>
<p>Well, we'll start with this:</p>
<pre class="scheme"><code>; items.rkt

; Armor protects the wearer
(define-thing armor item
  [character #\]]
  [defense 0]
  [category 'armor]
  [(on-pick-up item entity world)
   (thing-set! entity 'defense (+ (thing-get entity 'defense)
                                  (thing-get item 'defense)))]
  [(on-drop item entity world)
   (thing-set! entity 'defense (- (thing-get entity 'defense)
                                  (thing-get item 'defense)))])

(define *armors*
  (vector
   (make-thing armor [name "leather"]   [color "brown"]  [defense 1])
   (make-thing armor [name "chain"]     [color "gray"]   [defense 2])
   (make-thing armor [name "plate"]     [color "white"]  [defense 3])
   (make-thing armor [name "enchanted"] [color "purple"] [defense 5])))</code></pre>
<p>Basically, we set the character, category, and behavior in a base thing. Then all the further definitions have to do is override the name, color, and specific value. The behavior will be copied over just fine.</p>
<p>Similarly, we can define weapons (the base definition is the same except using <code>'attack</code> instead of <code>'defense</code>):</p>
<pre class="scheme"><code>; items.rkt

(define *weapons*
  (vector
   (make-thing weapon [name "club"]        [color "brown"]  [attack 1])
   (make-thing weapon [name "dagger"]      [color "gray"]   [attack 2])
   (make-thing weapon [name "battle axe"]  [color "white"]  [attack 3])
   (make-thing weapon [name "longsword"]   [color "white"]  [attack 3])
   (make-thing weapon [name "magic sword"] [color "purple"] [attack 5])))</code></pre>
<p>Finally, we have the actual consumables. Specifically, potions. Right now, there's really only one potion that makes sense, but the framework is more than flexible enough to do just about anything. Perhaps next week I'll start in on mutable terrain. :)</p>
<pre class="scheme"><code>; items.rkt

; Potions are single use and consumed on contact
(define-thing potion item
  [character #\!]
  [category 'potion]
  [consumable #t])

(define *potions*
  (vector
   (make-thing potion
     [name "health potion"]
     [color "red"]
     [(on-pick-up item entity world)
      (thing-set! entity 'health (+ 10 (thing-get entity 'health)))])))</code></pre>
<p>Now all you have to do is walk over a potion and you'll feel much better.</p>
<p>So now we have a bunch of items, how do we tie them into the rest of the framework?</p>
<p>First, we need to be able to store them. Since we eventually want any entity (player or enemy) to hold an item, we'll add the inventory all of the way back at the base <code>entity</code> thing:</p>
<pre class="scheme"><code>; entities.rkt
(define-thing entity
  ...
  [inventory '()])</code></pre>
<p>That will cascade through to all players and enemies.</p>
<p>Next, we need to do the same to tiles on the ground so that we can have items just lying about:</p>
<pre class="scheme"><code>; world.rkt
(define-thing tile
  ...
  [items '()])</code></pre>
<p>Now, we have to actually generate some items lying around. Luckily, we can use almost exactly the same code that we used to generate the wandering monsters. Any time a tile is generated, there's a small chance of generating a random item as well.</p>
<pre class="scheme"><code>; world.rkt

; Sometimes even more rarely, generate some sort of treasure
(when (and (thing-get new-tile 'walkable)
           (&lt; (random 1000) 1))
  (define new-item
    (let ([base (vector-choose-biased (vector-choose-random *all-items*))])
      (make-thing base)))

  (thing-set! new-tile 'items (cons new-item (thing-get new-tile 'items)))))</code></pre>
<p>As we did with the new creatures and tiles, we wrap the items with a call to <code>make-thing</code>, making this item distinct from the base definition. Right now, there's no way to mutate items, but in the future we might want to have durability or some such--this will prevent all swords in the world from breaking when you swing any one of them.</p>
<p>So now we have items in the world, but we still can't see them. So we need to go over to the <code>game-screen</code> and modify the draw routine. Where previously the lowest layer was to draw the tile, now it will draw the tile if there's no item or the first item if there's at least one.</p>
<pre class="scheme"><code>; game-screen.rkt

(define tile (send world get-tile (pt-x x/y) (pt-y x/y)))
(cond
  [(null? (thing-get tile 'items '()))
   (send canvas write
         (thing-get tile 'character)
         xi
         yi
         (thing-get tile 'color))]
  [else
   (send canvas write
         (thing-get (car (thing-get tile 'items)) 'character)
         xi
         yi
         (thing-get (car (thing-get tile 'items)) 'color))]))</code></pre>
<p>It's a bit ugly (so much duplicated code), but for the moment it will work.</p>
<p>Well, now that we're generating them, what does it actually look like?</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/random-items.png"><img src="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/random-items.png" /></a></p>
<p>If you look to the left of the player, there's a nice gray <code>]</code> just sitting there. If I remember the definitions correctly, that's chain armor. If only we could actually pick it up...</p>
<p>(I made the screen a bit larger so we have room for the player inventory to print, which we'll get to shortly. It should still be reasonable on most people's screens.)</p>
<p>Well, for that, we can tie into the movement code. The only time that we could pick up an item is when we walk into it, so it has to be a walkable, unoccupied tile. We want to pick up any items we walk over, drop any items that have the category of one we just picked up, and directly consume and consumables. It's a bit of code, so let's just take a look first:</p>
<pre class="scheme"><code>; world.rkt

; If it's walkable and not occupied, update the location
; Also, pick up any items there, exchanging if types match
[(null? others)
 (thing-set! entity 'location target)

 (define (pick-up item)
   (thing-set! entity 'inventory (cons item (thing-get entity 'inventory)))
   (thing-set! tile 'items (remove item (thing-get tile 'items)))
   (thing-call item 'on-pick-up item entity this))

 (define (drop item)
   (thing-set! entity 'inventory (remove item (thing-get entity 'inventory)))
   (thing-set! tile 'items (cons item (thing-get tile 'items)))
   (thing-call item 'on-drop item entity this))

 (define (consume item)
   (thing-set! tile 'items (remove item (thing-get tile 'items)))
   (thing-call item 'on-pick-up item entity this))

 ; For each item on the ground
 (for ([item (in-list (thing-get tile 'items))])
   ; Remove same typed items from the inventory
   (for ([in-inv (in-list (thing-get entity 'inventory))]
         #:when (eq? (thing-get item 'category)
                     (thing-get in-inv 'category)))
     (drop in-inv))

   ; Pick up or consume the item
   (if (thing-get item 'consumable)
       (consume item)
       (pick-up item)))]</code></pre>
<p>That should be relatively straight forward. And it actually works out great:</p>
<p>Here's another nice bit of chainmail just lying there for us.</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ooh-shiny.png"><img src="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ooh-shiny.png" /></a></p>
<p>Walk right over it to put it on. You can see the armor we're currently wearing in the top left, along with the boost in defense we got (note: Things are totally unbalanced right now. That's a post all to itself.)</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/invincible.png"><img src="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/invincible.png" /></a></p>
<p>Then we wander about a bit more. Hit a few bombs (those things <strong>hurt</strong>!). A bit of a pick-me-up would come in handy about now.</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/think-i-need-that.png"><img src="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/think-i-need-that.png" /></a></p>
<p>Walk over it and drink it up:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ahhh.png"><img src="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ahhh.png" /></a></p>
<p>Everything seems to be working well.</p>
<p>That's all we have today. I'm thinking about doing some line of sight calculations for next week (the screen is getting rather cluttered...). We'll see if I haven't changed my mind by then though. :)</p>
<p>As always, if you'd like to see all of the code for this project, you can do so on GitHub: - <a href="https://github.com/jpverkamp/racket-roguelike/tree/day-5" title="Racket Roguelike on GitHub">Racket Roguelike - Day 5</a> - <a href="https://github.com/jpverkamp/racket-roguelike" title="Racket Roguelike on GitHub">Racket Roguelike - Up to date</a></p>
<p>If you'd like to try it yourself, you'll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<pre class="bash"><code>git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-5
git submodule init
git submodule update
racket main.rkt</code></pre>
<p>For part 6, click here: <a href="http://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper">Racket Roguelike 6: Dig deeper!</a></p>
<div><h3 class="ranking-title">Racket Roguelike</h3><ol><li><a href="http://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-io-and-you">Racket Roguelike 1: A GUI, screens, I/O, and you!</a></li><li><a href="http://blog.jverkamp.com/2013/04/11/racket-roguelike-2-infinite-caves">Racket Roguelike 2: Infinite caves!</a></li><li><a href="http://blog.jverkamp.com/2013/04/18/racket-roguelike-3-rats-rats-everywhere">Racket Roguelike 3: Rats, rats, everywhere!</a></li><li><a href="http://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters">Racket Roguelike 4: Slightly smarter critters!</a></li><li><a href="http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my">Racket Roguelike 5: Armors and weapons and potions, oh my!</a></li></ol></div>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Racket Roguelike 5: Armors and weapons and potions, oh my!";
var disqus_url = "http://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/05/02/jurassic-park-3d">← Jurassic Park (3D!)</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2013/05/06/iron-man-3">Iron Man 3 →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/04/29/vtanks-for-ludum-dare-26">← VTanks for Ludum Dare 26</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper">Racket Roguelike 6: Dig deeper! →</a></li></ul></nav>

                <div class="legal">
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
<!doctype html><html><head><title>Racket Roguelike 5: Armors and weapons and potions, oh my! â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.ef050764ff69f3287c89ff655825479dd8304dcd9bc653d1ddd4772a701ad445.js integrity="sha256-7wUHZP9p8yh8if9lWCVHndgwTc2bxlPR3dR3KnAa1EU=" defer></script><script src=/katex_17296078054267651618.min.deed0e78a77391517d530a00324ce7b760ac204134992ef22d36f583615ae498.js integrity="sha256-3u0OeKdzkVF9UwoAMkznt2CsIEE0mS7yLTb1g2Fa5Jg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.bfe50b47c0387e3c3bf97ec5f338bba94f7ccb02f962a4aec8cf0b4d68c8434d.js integrity="sha256-v+ULR8A4fjw7+X7F8zi7qU98ywL5YqSuyM8LTWjIQ00=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.64e42891d651aee0b8cd02ec9227ff271d37bcf06dae985d1acf0eba1623e850.css integrity="sha256-ZOQokdZRruC4zQLskif/Jx03vPBtrphdGs8OuhYj6FA="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.0d2b289fa3451447692959fcee5676b846532fe7ab50ddc4660824c42d4adcd7.css integrity="sha256-DSson6NFFEdpKVn87lZ2uEZTL+erUN3EZggkxC1K3Nc="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.67505d77381ebd82623ab9296c1989c44ec828d867c00296e80e52ef860cac37.css integrity="sha256-Z1BddzgevYJiOrkpbBmJxE7IKNhnwAKW6A5S74YMrDc="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.b60cba31b8c292392a2d336408f8f344e261df78516eb17bcf029173b24a42b5.css integrity="sha256-tgy6MbjCkjkqLTNkCPjzROJh33hRbrF7zwKRc7JKQrU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/home-automation/>Home Automation</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Racket Roguelike 5: Armors and weapons and potions, oh my!</h1><div class=entry-meta><span class=entry-date>2013-05-02</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/7drl>7DRL</a><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/29/vtanks-for-ludum-dare-26/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/games>Games</a><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/roguelikes>Roguelikes</a><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/04/25/racket-roguelike-4-slightly-smarter-critters/ class=previous-link></a><a class=taxonomy-value href=/series/racket-roguelike>Racket Roguelike</a><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/04/29/vtanks-for-ludum-dare-26/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/05/02/jurassic-park-3d/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Another week, another step towards building a roguelike in Racket. This week, we&rsquo;re going to build another basic system (like the critters) that can easily be expanded with all sorts of crazy content: items and inventory.</p><p>If you&rsquo;d like to start at the beginning, click here: <a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/>Racket Roguelike 1: A GUI, screens, I/O, and you!</a></p><p>This time around, let&rsquo;s start with the kinds of items that we want to support. As you may have guessed from the post title, we&rsquo;ll start with three: armor, weapons, and potions for boosted attack, defense, and temporary effects in turn.</p><p>First, we need a base <code>thing</code> on which we can base all of the rest of the items:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; items.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; All items have:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; - a display char/item if they&#39;re on the ground</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; - if they&#39;re consumed or not (picked up)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; - methods for:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; -- being picked up</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; -- being dropped</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> item
</span></span><span style=display:flex><span>  [character <span style=color:#e6db74>#\x</span>]
</span></span><span style=display:flex><span>  [color <span style=color:#e6db74>&#34;white&#34;</span>]
</span></span><span style=display:flex><span>  [consumable <span style=color:#66d9ef>#f</span>]
</span></span><span style=display:flex><span>  [category <span style=color:#e6db74>&#39;unknown</span>]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>on-pick-up</span> item entity world)   (<span style=color:#a6e22e>void</span>)]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>on-drop</span> item entity world) (<span style=color:#a6e22e>void</span>)])
</span></span></code></pre></div><p>First, we have the basic display features all of our items have. Then we have a flag that basically identifies if you can wear an item (<code>(not consumable)</code>) or if you consume it immediately (<code>consumable</code>).</p><p>Next, we have a category. Basically, our model will be that you can hold one item of each category at a given time. This way, you can have one kind of armor and one weapon and that&rsquo;s it. That will save us from having to make any sort of complicated inventory, although this same system could be adapted to a more flexible category to maximum count mapping.</p><p>Finally, we have two methods. I really do love functional programming when things like this come up. Basically (as should be obvious from the names), the first method will be called when them item is picked up (also when a consumable item is used), the second when it&rsquo;s dropped (never called for consumables).</p><p>So how does this work for an armor definition?</p><p>Well, we&rsquo;ll start with this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; items.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Armor protects the wearer</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> armor item
</span></span><span style=display:flex><span>  [character <span style=color:#e6db74>#\]</span>]
</span></span><span style=display:flex><span>  [defense <span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>  [category <span style=color:#e6db74>&#39;armor</span>]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>on-pick-up</span> item entity world)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-set!</span> entity <span style=color:#e6db74>&#39;defense</span> (+ (<span style=color:#a6e22e>thing-get</span> entity <span style=color:#e6db74>&#39;defense</span>)
</span></span><span style=display:flex><span>                                  (<span style=color:#a6e22e>thing-get</span> item <span style=color:#e6db74>&#39;defense</span>)))]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>on-drop</span> item entity world)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-set!</span> entity <span style=color:#e6db74>&#39;defense</span> (- (<span style=color:#a6e22e>thing-get</span> entity <span style=color:#e6db74>&#39;defense</span>)
</span></span><span style=display:flex><span>                                  (<span style=color:#a6e22e>thing-get</span> item <span style=color:#e6db74>&#39;defense</span>)))])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>*armors*
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>vector</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> armor [name <span style=color:#e6db74>&#34;leather&#34;</span>]   [color <span style=color:#e6db74>&#34;brown&#34;</span>]  [defense <span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> armor [name <span style=color:#e6db74>&#34;chain&#34;</span>]     [color <span style=color:#e6db74>&#34;gray&#34;</span>]   [defense <span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> armor [name <span style=color:#e6db74>&#34;plate&#34;</span>]     [color <span style=color:#e6db74>&#34;white&#34;</span>]  [defense <span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> armor [name <span style=color:#e6db74>&#34;enchanted&#34;</span>] [color <span style=color:#e6db74>&#34;purple&#34;</span>] [defense <span style=color:#ae81ff>5</span>])))
</span></span></code></pre></div><p>Basically, we set the character, category, and behavior in a base thing. Then all the further definitions have to do is override the name, color, and specific value. The behavior will be copied over just fine.</p><p>Similarly, we can define weapons (the base definition is the same except using <code>'attack</code> instead of <code>'defense</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; items.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>*weapons*
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>vector</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> weapon [name <span style=color:#e6db74>&#34;club&#34;</span>]        [color <span style=color:#e6db74>&#34;brown&#34;</span>]  [attack <span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> weapon [name <span style=color:#e6db74>&#34;dagger&#34;</span>]      [color <span style=color:#e6db74>&#34;gray&#34;</span>]   [attack <span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> weapon [name <span style=color:#e6db74>&#34;battle axe&#34;</span>]  [color <span style=color:#e6db74>&#34;white&#34;</span>]  [attack <span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> weapon [name <span style=color:#e6db74>&#34;longsword&#34;</span>]   [color <span style=color:#e6db74>&#34;white&#34;</span>]  [attack <span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> weapon [name <span style=color:#e6db74>&#34;magic sword&#34;</span>] [color <span style=color:#e6db74>&#34;purple&#34;</span>] [attack <span style=color:#ae81ff>5</span>])))
</span></span></code></pre></div><p>Finally, we have the actual consumables. Specifically, potions. Right now, there&rsquo;s really only one potion that makes sense, but the framework is more than flexible enough to do just about anything. Perhaps next week I&rsquo;ll start in on mutable terrain. &#x1f604;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; items.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Potions are single use and consumed on contact</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> potion item
</span></span><span style=display:flex><span>  [character <span style=color:#e6db74>#\!</span>]
</span></span><span style=display:flex><span>  [category <span style=color:#e6db74>&#39;potion</span>]
</span></span><span style=display:flex><span>  [consumable <span style=color:#66d9ef>#t</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>*potions*
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>vector</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>make-thing</span> potion
</span></span><span style=display:flex><span>     [name <span style=color:#e6db74>&#34;health potion&#34;</span>]
</span></span><span style=display:flex><span>     [color <span style=color:#e6db74>&#34;red&#34;</span>]
</span></span><span style=display:flex><span>     [(<span style=color:#a6e22e>on-pick-up</span> item entity world)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>thing-set!</span> entity <span style=color:#e6db74>&#39;health</span> (+ <span style=color:#ae81ff>10</span> (<span style=color:#a6e22e>thing-get</span> entity <span style=color:#e6db74>&#39;health</span>)))])))
</span></span></code></pre></div><p>Now all you have to do is walk over a potion and you&rsquo;ll feel much better.</p><p>So now we have a bunch of items, how do we tie them into the rest of the framework?</p><p>First, we need to be able to store them. Since we eventually want any entity (player or enemy) to hold an item, we&rsquo;ll add the inventory all of the way back at the base <code>entity</code> thing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; entities.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> entity
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  [inventory <span style=color:#f92672>&#39;</span>()])
</span></span></code></pre></div><p>That will cascade through to all players and enemies.</p><p>Next, we need to do the same to tiles on the ground so that we can have items just lying about:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; world.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> tile
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  [items <span style=color:#f92672>&#39;</span>()])
</span></span></code></pre></div><p>Now, we have to actually generate some items lying around. Luckily, we can use almost exactly the same code that we used to generate the wandering monsters. Any time a tile is generated, there&rsquo;s a small chance of generating a random item as well.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; world.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Sometimes even more rarely, generate some sort of treasure</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>and </span>(<span style=color:#a6e22e>thing-get</span> new-tile <span style=color:#e6db74>&#39;walkable</span>)
</span></span><span style=display:flex><span>           (&lt; (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>1000</span>) <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>new-item
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>let </span>([base (<span style=color:#a6e22e>vector-choose-biased</span> (<span style=color:#a6e22e>vector-choose-random</span> *all-items*))])
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>make-thing</span> base)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>thing-set!</span> new-tile <span style=color:#e6db74>&#39;items</span> (cons new-item (<span style=color:#a6e22e>thing-get</span> new-tile <span style=color:#e6db74>&#39;items</span>)))))
</span></span></code></pre></div><p>As we did with the new creatures and tiles, we wrap the items with a call to <code>make-thing</code>, making this item distinct from the base definition. Right now, there&rsquo;s no way to mutate items, but in the future we might want to have durability or some such&ndash;this will prevent all swords in the world from breaking when you swing any one of them.</p><p>So now we have items in the world, but we still can&rsquo;t see them. So we need to go over to the <code>game-screen</code> and modify the draw routine. Where previously the lowest layer was to draw the tile, now it will draw the tile if there&rsquo;s no item or the first item if there&rsquo;s at least one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>tile (<span style=color:#a6e22e>send</span> world get-tile (<span style=color:#a6e22e>pt-x</span> x/y) (<span style=color:#a6e22e>pt-y</span> x/y)))
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>  [(null? (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span> <span style=color:#f92672>&#39;</span>()))
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>send</span> canvas write
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;character</span>)
</span></span><span style=display:flex><span>         xi
</span></span><span style=display:flex><span>         yi
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;color</span>))]
</span></span><span style=display:flex><span>  [else
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>send</span> canvas write
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>thing-get</span> (car (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>)) <span style=color:#e6db74>&#39;character</span>)
</span></span><span style=display:flex><span>         xi
</span></span><span style=display:flex><span>         yi
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>thing-get</span> (car (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>)) <span style=color:#e6db74>&#39;color</span>))]))
</span></span></code></pre></div><p>It&rsquo;s a bit ugly (so much duplicated code), but for the moment it will work.</p><p>Well, now that we&rsquo;re generating them, what does it actually look like?</p><figure><img src=/embeds/2013/random-items.png></figure><p>If you look to the left of the player, there&rsquo;s a nice gray <code>]</code> just sitting there. If I remember the definitions correctly, that&rsquo;s chain armor. If only we could actually pick it up&mldr;</p><p>(I made the screen a bit larger so we have room for the player inventory to print, which we&rsquo;ll get to shortly. It should still be reasonable on most people&rsquo;s screens.)</p><p>Well, for that, we can tie into the movement code. The only time that we could pick up an item is when we walk into it, so it has to be a walkable, unoccupied tile. We want to pick up any items we walk over, drop any items that have the category of one we just picked up, and directly consume and consumables. It&rsquo;s a bit of code, so let&rsquo;s just take a look first:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; world.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; If it&#39;s walkable and not occupied, update the location</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Also, pick up any items there, exchanging if types match</span>
</span></span><span style=display:flex><span>[(null? others)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>thing-set!</span> entity <span style=color:#e6db74>&#39;location</span> target)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>pick-up</span> item)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-set!</span> entity <span style=color:#e6db74>&#39;inventory</span> (cons item (<span style=color:#a6e22e>thing-get</span> entity <span style=color:#e6db74>&#39;inventory</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;items</span> (<span style=color:#a6e22e>remove</span> item (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-call</span> item <span style=color:#e6db74>&#39;on-pick-up</span> item entity this))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>drop</span> item)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-set!</span> entity <span style=color:#e6db74>&#39;inventory</span> (<span style=color:#a6e22e>remove</span> item (<span style=color:#a6e22e>thing-get</span> entity <span style=color:#e6db74>&#39;inventory</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;items</span> (cons item (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-call</span> item <span style=color:#e6db74>&#39;on-drop</span> item entity this))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>consume</span> item)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;items</span> (<span style=color:#a6e22e>remove</span> item (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>thing-call</span> item <span style=color:#e6db74>&#39;on-pick-up</span> item entity this))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>; For each item on the ground</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>for</span> ([item (<span style=color:#a6e22e>in-list</span> (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>))])
</span></span><span style=display:flex><span>   <span style=color:#75715e>; Remove same typed items from the inventory</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for</span> ([in-inv (<span style=color:#a6e22e>in-list</span> (<span style=color:#a6e22e>thing-get</span> entity <span style=color:#e6db74>&#39;inventory</span>))]
</span></span><span style=display:flex><span>         <span style=color:#f92672>#</span>:when (eq? (<span style=color:#a6e22e>thing-get</span> item <span style=color:#e6db74>&#39;category</span>)
</span></span><span style=display:flex><span>                     (<span style=color:#a6e22e>thing-get</span> in-inv <span style=color:#e6db74>&#39;category</span>)))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>drop</span> in-inv))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>; Pick up or consume the item</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>if </span>(<span style=color:#a6e22e>thing-get</span> item <span style=color:#e6db74>&#39;consumable</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>consume</span> item)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>pick-up</span> item)))]
</span></span></code></pre></div><p>That should be relatively straight forward. And it actually works out great:</p><p>Here&rsquo;s another nice bit of chainmail just lying there for us.</p><figure><img src=/embeds/2013/ooh-shiny.png></figure><p>Walk right over it to put it on. You can see the armor we&rsquo;re currently wearing in the top left, along with the boost in defense we got (note: Things are totally unbalanced right now. That&rsquo;s a post all to itself.)</p><figure><img src=/embeds/2013/invincible.png></figure><p>Then we wander about a bit more. Hit a few bombs (those things <strong>hurt</strong>!). A bit of a pick-me-up would come in handy about now.</p><figure><img src=/embeds/2013/think-i-need-that.png></figure><p>Walk over it and drink it up:</p><figure><img src=/embeds/2013/ahhh.png></figure><p>Everything seems to be working well.</p><p>That&rsquo;s all we have today. I&rsquo;m thinking about doing some line of sight calculations for next week (the screen is getting rather cluttered&mldr;). We&rsquo;ll see if I haven&rsquo;t changed my mind by then though. &#x1f604;</p><p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:</p><ul><li><a href=https://github.com/jpverkamp/racket-roguelike/tree/day-5 title="Racket Roguelike on GitHub">Racket Roguelike - Day 5</a></li><li><a href=https://github.com/jpverkamp/racket-roguelike title="Racket Roguelike on GitHub">Racket Roguelike - Up to date</a></li></ul><p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href=http://git-scm.com/>Git</a> and <a href=http://racket-lang.org/>Racket</a> and run the following series of commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-5
</span></span><span style=display:flex><span>git submodule init
</span></span><span style=display:flex><span>git submodule update
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p><strong>Edit:</strong></p><p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/ascii-canvas/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/noise/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/thing/master
</span></span><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-5
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p>For part 6, click here: <a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/>Racket Roguelike 6: Dig deeper!</a></p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
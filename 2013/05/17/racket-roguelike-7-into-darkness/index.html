<!doctype html><html><head><title>Racket Roguelike 7: Into darkness! â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.e0e68b86dea32185ab89b0b9cc01649107cc6b0be3290c8c7b13c716bc0dabfa.css integrity="sha256-4OaLht6jIYWribC5zAFkkQfMawvjKQyMexPHFrwNq/o="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Racket Roguelike 7: Into darkness!</h1><div class=entry-meta><span class=entry-date>2013-05-17</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/7drl>7DRL</a><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/games>Games</a><a href=https://blog.jverkamp.com/2013/05/21/ludum-dare-26-vtanks-results/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/roguelikes>Roguelikes</a><a href=https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=previous-link></a><a class=taxonomy-value href=/series/racket-roguelike>Racket Roguelike</a><a href=https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/05/21/ludum-dare-26-vtanks-results/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/05/16/pain-gain/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/05/18/t-minus-14/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>When I was playing Racket Roguelike earlier this week<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, I realized something: I can see everything. There are no surprises, no mystery, no <em>darkness</em></p><p>Let&rsquo;s fix that.</p><p>(If you&rsquo;d like to start at the beginning, click here: <a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/>Racket Roguelike 1: A GUI, screens, I/O, and you!</a>)</p><p>This week, we want to add a dynamic lighting system to the game. If we were using a pre-built framework (like Doryen&rsquo;s excellent <a href=https://blog.jverkamp.com/2013/03/28/writing-a-roguelike-in-racket-day-0/>AsciiPanel</a> some day}. But that&rsquo;s not the case. Luckily, the framework we&rsquo;ve built already makes lighting relatively easy.</p><p>First, we need some way of representing which tiles should be lit. Technically, we could calculate this on the fly every frame. This isn&rsquo;t actually a terrible way of doing things and might just be more efficient than what we&rsquo;re doing (don&rsquo;t even bother rendering tiles you can&rsquo;t see), but since we want to have a &lsquo;fog of war&rsquo; type system&ndash;where you can see the terrain you&rsquo;ve passed, just not what&rsquo;s there&ndash;that won&rsquo;t quite work.</p><p>Instead, let&rsquo;s add it to the <code>tile</code> definitions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> tile
</span></span><span style=display:flex><span>  [character <span style=color:#e6db74>#\space</span>]
</span></span><span style=display:flex><span>  [color <span style=color:#e6db74>&#34;black&#34;</span>]
</span></span><span style=display:flex><span>  [items <span style=color:#f92672>&#39;</span>()]
</span></span><span style=display:flex><span>  [lighting <span style=color:#e6db74>&#39;dark</span>]    <span style=color:#75715e>; Dark: Invisible; Fog: Only show tile, not NPC or item; Lit: Everything</span>
</span></span><span style=display:flex><span>  [walkable <span style=color:#66d9ef>#f</span>]       <span style=color:#75715e>; Can the player walk on this tile?</span>
</span></span><span style=display:flex><span>  )
</span></span></code></pre></div><p>As it says in the comment, we have a <code>lighting</code> parameter with three possible states:</p><ul><li><code>dark</code> - don&rsquo;t draw the tile</li><li><code>fog</code> - draw the tile, but no items or NPCs in it (used once we see a tile then leave)</li><li><code>lit</code> - draw the tile, items, and NPCs (used when the player is nearby)</li></ul><p>Easy enough. But how do we actually add that to our drawing function? Head over to <em>game-screen.rkt</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>gray-background (<span style=color:#a6e22e>make-object</span> color% <span style=color:#ae81ff>32</span> <span style=color:#ae81ff>32</span> <span style=color:#ae81ff>32</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Draw the tiles around the player</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>for*</span> ([xi (<span style=color:#a6e22e>in-range</span> (<span style=color:#a6e22e>send</span> canvas get-width-in-characters))]
</span></span><span style=display:flex><span>       [yi (<span style=color:#a6e22e>in-range</span> (<span style=color:#a6e22e>send</span> canvas get-height-in-characters))])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>x/y (<span style=color:#a6e22e>recenter</span> canvas (- (<span style=color:#a6e22e>thing-get</span> player <span style=color:#e6db74>&#39;location</span>) (<span style=color:#a6e22e>pt</span> xi yi))))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>tile (<span style=color:#a6e22e>send</span> world tile-at (<span style=color:#a6e22e>pt-x</span> x/y) (<span style=color:#a6e22e>pt-y</span> x/y)))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>lighting (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;lighting</span> <span style=color:#e6db74>&#39;lit</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Draw nothing on dark tiles</span>
</span></span><span style=display:flex><span>    [(eq? lighting <span style=color:#e6db74>&#39;dark</span>)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>void</span>)]
</span></span><span style=display:flex><span>    <span style=color:#75715e>; If it&#39;s in fog, draw with a gray background</span>
</span></span><span style=display:flex><span>    [(eq? lighting <span style=color:#e6db74>&#39;fog</span>)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>send</span> canvas write
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;character</span>)
</span></span><span style=display:flex><span>           xi yi
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;color</span>) gray-background)]
</span></span><span style=display:flex><span>    <span style=color:#75715e>; If it&#39;s lit but there are no items, draw the tile</span>
</span></span><span style=display:flex><span>    [(null? (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span> <span style=color:#f92672>&#39;</span>()))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>send</span> canvas write
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;character</span>)
</span></span><span style=display:flex><span>           xi yi
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;color</span>))]
</span></span><span style=display:flex><span>    <span style=color:#75715e>; If it&#39;s lit and there are items, draw the item</span>
</span></span><span style=display:flex><span>    [else
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>send</span> canvas write
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>thing-get</span> (car (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>)) <span style=color:#e6db74>&#39;character</span>)
</span></span><span style=display:flex><span>           xi yi
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>thing-get</span> (car (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;items</span>)) <span style=color:#e6db74>&#39;color</span>))]))
</span></span></code></pre></div><p>Basically, we draw nothing on dark tiles. This relies on the <code>clear</code> just above this code. If it&rsquo;s foggy, we have a background, defined at the top of the file<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Otherwise, we fall back on the methods that we already had.</p><p>Next, we need to actually calculate this lighting. Essentially, every tile starts dark. Then, if a tile is near to the player, light it up. If it&rsquo;s already lit but no longer near the tile, fade to fog. For now, we&rsquo;re just going to use a simple radius around the player (parameterized below). Here&rsquo;s the new <code>update-lighting</code> function and friends:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; entities.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; game-screen.rkt</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> entity
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  [view-range <span style=color:#ae81ff>5</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Draw the game itself.</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define/override</span> (<span style=color:#a6e22e>draw</span> canvas)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>player (<span style=color:#a6e22e>send</span> world get-player))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>send</span> canvas clear)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Update lighting</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>send</span> world update-lighting)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; world.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Update lighting</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define/public</span> (<span style=color:#a6e22e>update-lighting</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Turn any lit tiles to fog</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Turn any tiles within the player&#39;s view limit to lit</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>player-location (<span style=color:#a6e22e>thing-get</span> player <span style=color:#e6db74>&#39;location</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>player-view (<span style=color:#a6e22e>thing-get</span> player <span style=color:#e6db74>&#39;view-range</span> <span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>for-tile</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>x</span> y tile)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>; Light tiles near the player</span>
</span></span><span style=display:flex><span>       [(&lt;= (<span style=color:#a6e22e>distance</span> player-location (<span style=color:#a6e22e>pt</span> x y)) player-view)
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;lighting</span> <span style=color:#e6db74>&#39;lit</span>)]
</span></span><span style=display:flex><span>       <span style=color:#75715e>; Fog previously lit tiles</span>
</span></span><span style=display:flex><span>       [(eq? <span style=color:#e6db74>&#39;lit</span> (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;lighting</span>))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;lighting</span> <span style=color:#e6db74>&#39;fog</span>)]
</span></span><span style=display:flex><span>       <span style=color:#75715e>; Otherwise do nothing</span>
</span></span><span style=display:flex><span>       ))))
</span></span></code></pre></div><p>For that, we need the <code>for-tile</code> function. You can check it out <a href=https://github.com/jpverkamp/racket-roguelike/blob/master/src/levels.rkt>on GitHub</a>, but essentially it takes a function of the form <code>(lambda (x y tile) ...)</code> and applies it to each tile on the current level. It might<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> get inefficient on more explored levels, but if people keep heading down, we should be good. So in this case, we&rsquo;ll just light the area around the player. How does that look?</p><figure><img src=/embeds/2013/simple-lighting.png></figure><p>Starting out, not too bad. We&rsquo;re out in the middle of a nice grass field like always. Just this time, we can&rsquo;t see much of it. Perhaps it&rsquo;s night time?</p><figure><img src=/embeds/2013/simple-fog.png></figure><p>Wander around a bit until we find a way down. You can see the gray background of the fog. That actually looks pretty nice, particularly as you&rsquo;re moving around.</p><figure><img src=/embeds/2013/into-the-caves.png></figure><p>Okay, now we&rsquo;re into the caves. Let&rsquo;s explore for a bit.</p><figure><img src=/embeds/2013/this-is-a-problem.png></figure><p>Hmm. Well, this is a problem. It turns out&mldr; we can see right through walls. Perhaps we should work on that a bit.</p><p>This is when a pre-built framework would <em>really</em> come in handy. But the algorithm isn&rsquo;t too bad. Essentially, we want <a href=https://en.wikipedia.org/wiki/raycasting>raycasting</a>. We&rsquo;ll start with a series of lines out from the player and light tiles as we go. If we hit something that can&rsquo;t be lit up, stop. Sounds like a nicely recursive function to me!</p><p>Before that, let&rsquo;s modify the tile definitions again. We&rsquo;ll add the <code>solid</code> property. If a tile is <code>solid</code> (like a wall or a tree), you can&rsquo;t see through it. Otherwise (like empty space or over water), you can.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> tile
</span></span><span style=display:flex><span>  [character <span style=color:#e6db74>#\space</span>]
</span></span><span style=display:flex><span>  [color <span style=color:#e6db74>&#34;black&#34;</span>]
</span></span><span style=display:flex><span>  [items <span style=color:#f92672>&#39;</span>()]
</span></span><span style=display:flex><span>  [lighting <span style=color:#e6db74>&#39;dark</span>]    <span style=color:#75715e>; Dark: Invisible; Fog: Only show tile, not NPC or item; Lit: Everything</span>
</span></span><span style=display:flex><span>  [walkable <span style=color:#66d9ef>#f</span>]       <span style=color:#75715e>; Can the player walk on this tile?</span>
</span></span><span style=display:flex><span>  [solid <span style=color:#66d9ef>#f</span>]          <span style=color:#75715e>; Does this tile block light?</span>
</span></span><span style=display:flex><span>  )
</span></span></code></pre></div><p>So how do we write a raycasting function?</p><p>The basic idea<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> is to start with four rays, one in each of the cardinal directions. Give each ray its own direction. Then as we pass each tile, branch out in each direction for a total of three branches per iteration. It&rsquo;s certainly not optimal (we&rsquo;ll light some tiles more than once), but it does look nice.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; world.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Update lighting</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define/public</span> (<span style=color:#a6e22e>update-lighting</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Turn any lit tiles to fog</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>for-tile</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>x</span> y tile)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>       [(eq? <span style=color:#e6db74>&#39;lit</span> (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;lighting</span> <span style=color:#e6db74>&#39;dark</span>))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;lighting</span> <span style=color:#e6db74>&#39;fog</span>)])))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Spread lighting from the player</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; x/y current tile to light</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; xd/yd direction to spread light:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>;  if xd != 0, spread to (x+xd y-1) (x+xd y) (x+xd y+1)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>;  if yd != 0, spread to (x-1 y+yd) (x y+yd) (x-1 y+yd)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; spread is initially set to player&#39;s light radius</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>spread-light</span> x y xd yd spread)
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Light the current tile</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>tile (<span style=color:#a6e22e>get-tile</span> x y))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>thing-set!</span> tile <span style=color:#e6db74>&#39;lighting</span> <span style=color:#e6db74>&#39;lit</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Recur</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Don&#39;t spread pass solid tiles (spread to them though)</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Don&#39;t recur past the spread (vision range) value</span>
</span></span><span style=display:flex><span>      [(<span style=color:#66d9ef>or </span>(&lt;= spread <span style=color:#ae81ff>0</span>) (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;solid</span> <span style=color:#66d9ef>#f</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>void</span>)]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Spread in the x direction</span>
</span></span><span style=display:flex><span>      [(not (= xd <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>spread-light</span> (+ x xd) (- y <span style=color:#ae81ff>1</span>) xd yd (- spread <span style=color:#ae81ff>1.41</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>spread-light</span> (+ x xd) y       xd yd (- spread <span style=color:#ae81ff>1.00</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>spread-light</span> (+ x xd) (+ y <span style=color:#ae81ff>1</span>) xd yd (- spread <span style=color:#ae81ff>1.41</span>))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Spread in the y direction</span>
</span></span><span style=display:flex><span>      [else
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>spread-light</span> (- x <span style=color:#ae81ff>1</span>) (+ y yd) xd yd (- spread <span style=color:#ae81ff>1.41</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>spread-light</span> x       (+ y yd) xd yd (- spread <span style=color:#ae81ff>1.00</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>spread-light</span> (+ x <span style=color:#ae81ff>1</span>) (+ y yd) xd yd (- spread <span style=color:#ae81ff>1.41</span>))]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Spread in the four directions</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>([player-x (<span style=color:#a6e22e>pt-x</span> (<span style=color:#a6e22e>thing-get</span> player <span style=color:#e6db74>&#39;location</span>))]
</span></span><span style=display:flex><span>        [player-y (<span style=color:#a6e22e>pt-y</span> (<span style=color:#a6e22e>thing-get</span> player <span style=color:#e6db74>&#39;location</span>))]
</span></span><span style=display:flex><span>        [player-v (<span style=color:#a6e22e>thing-get</span> player <span style=color:#e6db74>&#39;view-range</span> <span style=color:#ae81ff>5</span>)])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>spread-light</span> player-x player-y <span style=color:#ae81ff>-1</span>  <span style=color:#ae81ff>0</span> player-v)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>spread-light</span> player-x player-y  <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span> player-v)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>spread-light</span> player-x player-y  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>-1</span> player-v)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>spread-light</span> player-x player-y  <span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>1</span> player-v)))
</span></span></code></pre></div><p>Hopefully that all makes sense. One sneaky trick is reducing the <code>spread</code> by 1 on the orthogonal moves and 1.41 (roughly <span class=latex-inline>sqrt(2)</span>
) on the diagonals. This will give us a nice circle.</p><p>Let&rsquo;s see what an effect that has on the game:</p><figure><img src=/embeds/2013/nice-circle.png></figure><p>Starting out, we have a nice circle. So far, it looks pretty much the same as it did last time.</p><figure><img src=/embeds/2013/trees-cast-shadows.png></figure><p>Shadows! I can&rsquo;t tell you how excited this makes me. ðŸ˜„</p><figure><img src=/embeds/2013/over-troubled-waters.png></figure><p>And it works perfectly with water as well. We can see over the water, but we can&rsquo;t walk through it.</p><figure><img src=/embeds/2013/missing-something.png></figure><p>Unfortunately though, I haven&rsquo;t had any luck yet finding a staircase&mldr;</p><figure><img src=/embeds/2013/no-more-xray-vision.png></figure><p>Finally, we&rsquo;re down a level. It&rsquo;s nice to see<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>: no more x-ray vision! It does look a bit weird to have all the nice thin walls around, but it looks a lot better once you get used to it.</p><figure><img src=/embeds/2013/there-are-rats.png></figure><p>Theoretically, the player shouldn&rsquo;t be able to hear updates from entities that aren&rsquo;t visible. That would actually be pretty easy to implement (just check for the lighting in the logging function), but for the moment, I like the atmosphere it gives.</p><figure><img src=/embeds/2013/still-no-rats.png></figure><p>All that time wandering about and I still haven&rsquo;t actually found any of those rats to fight. I wanted to show that it won&rsquo;t draw them unless they&rsquo;re in a lit area. Sigh. So it goes.</p><p>Well, that&rsquo;s all we have for today. It&rsquo;s kind of amazing how much difference so few lines can make<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>.</p><p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:</p><ul><li><a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike/tree/day-7>Racket Roguelike - Day 7</a></li><li><a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike>Racket Roguelike - Up to date</a></li></ul><p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href=http://git-scm.com/>Git</a> and <a href=http://racket-lang.org/>Racket</a> and run the following series of commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-7
</span></span><span style=display:flex><span>git submodule init
</span></span><span style=display:flex><span>git submodule update
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p><strong>Edit:</strong></p><p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/ascii-canvas/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/noise/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/thing/master
</span></span><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-7
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p>For part 8, click here: <a href=https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/>Racket Roguelike 8: A million words!</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Always a good sign when you find yourself actually playing your own game&mldr;&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>And defined only once to save just a bit on performance; we&rsquo;re going to have to look at that soon&mldr;&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Read: will&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Which may or may not be the standard way of doing it&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Believe it or not, pun not intended&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>According to the git diff, 26 lines removed and 111 added&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
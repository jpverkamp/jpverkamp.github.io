<!DOCTYPE html>
<html>
<head>
    <title>
    Racket Roguelike 7: Into darkness! â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Racket Roguelike 7: Into darkness!</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2013-05-17</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/sources/7drl">7DRL</a>
                        <a href="https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/games">Games</a>
                        <a href="https://blog.jverkamp.com/2013/05/21/ludum-dare-26-vtanks-results/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/roguelikes">Roguelikes</a>
                        <a href="https://blog.jverkamp.com/2013/05/24/racket-roguelike-going-on-hiatus/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/series/racket-roguelike">Racket Roguelike</a>
                        <a href="https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/05/10/racket-roguelike-6-dig-deeper/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/05/21/ludum-dare-26-vtanks-results/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/05/16/pain-gain/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/05/18/t-minus-14/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>When I was playing Racket Roguelike earlier this week<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>, I realized something: I can see everything. There are no surprises, no mystery, no <em>darkness</em></p>

<p>Let&rsquo;s fix that.</p>

<p>(If you&rsquo;d like to start at the beginning, click here: <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/">Racket Roguelike 1: A GUI, screens, I/O, and you!</a>)</p>

<p>This week, we want to add a dynamic lighting system to the game. If we were using a pre-built framework (like Doryen&rsquo;s excellent <a href="https://blog.jverkamp.com/2013/03/28/writing-a-roguelike-in-racket-day-0/">AsciiPanel</a> some day}. But that&rsquo;s not the case. Luckily, the framework we&rsquo;ve built already makes lighting relatively easy.</p>

<p>First, we need some way of representing which tiles should be lit. Technically, we could calculate this on the fly every frame. This isn&rsquo;t actually a terrible way of doing things and might just be more efficient than what we&rsquo;re doing (don&rsquo;t even bother rendering tiles you can&rsquo;t see), but since we want to have a &lsquo;fog of war&rsquo; type system&ndash;where you can see the terrain you&rsquo;ve passed, just not what&rsquo;s there&ndash;that won&rsquo;t quite work.</p>

<p>Instead, let&rsquo;s add it to the <code>tile</code> definitions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

(define-thing tile
  [character <span style="color:#e6db74">#\space</span>]
  [color <span style="color:#e6db74">&#34;black&#34;</span>]
  [items <span style="color:#f92672">&#39;</span>()]
  [lighting <span style="color:#e6db74">&#39;dark</span>]    <span style="color:#75715e">; Dark: Invisible; Fog: Only show tile, not NPC or item; Lit: Everything</span>
  [walkable <span style="color:#66d9ef">#f</span>]       <span style="color:#75715e">; Can the player walk on this tile?</span>
  )</code></pre></div>
<p>As it says in the comment, we have a <code>lighting</code> parameter with three possible states:</p>

<ul>
<li><code>dark</code> - don&rsquo;t draw the tile</li>
<li><code>fog</code> - draw the tile, but no items or NPCs in it (used once we see a tile then leave)</li>
<li><code>lit</code> - draw the tile, items, and NPCs (used when the player is nearby)</li>
</ul>

<p>Easy enough. But how do we actually add that to our drawing function? Head over to <em>game-screen.rkt</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; game-screen.rkt</span>

(<span style="color:#66d9ef">define </span>gray-background (make-object color% <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">32</span>))

<span style="color:#f92672">...</span>

<span style="color:#75715e">; Draw the tiles around the player</span>
(for* ([xi (in-range (send canvas get-width-in-characters))]
       [yi (in-range (send canvas get-height-in-characters))])
  (<span style="color:#66d9ef">define </span>x/y (recenter canvas (- (thing-get player <span style="color:#e6db74">&#39;location</span>) (pt xi yi))))
  (<span style="color:#66d9ef">define </span>tile (send world tile-at (pt-x x/y) (pt-y x/y)))
  (<span style="color:#66d9ef">define </span>lighting (thing-get tile <span style="color:#e6db74">&#39;lighting</span> <span style="color:#e6db74">&#39;lit</span>))
  (cond
    <span style="color:#75715e">; Draw nothing on dark tiles</span>
    [(eq? lighting <span style="color:#e6db74">&#39;dark</span>)
     (void)]
    <span style="color:#75715e">; If it&#39;s in fog, draw with a gray background</span>
    [(eq? lighting <span style="color:#e6db74">&#39;fog</span>)
     (send canvas write
           (thing-get tile <span style="color:#e6db74">&#39;character</span>)
           xi yi
           (thing-get tile <span style="color:#e6db74">&#39;color</span>) gray-background)]
    <span style="color:#75715e">; If it&#39;s lit but there are no items, draw the tile</span>
    [(null? (thing-get tile <span style="color:#e6db74">&#39;items</span> <span style="color:#f92672">&#39;</span>()))
     (send canvas write
           (thing-get tile <span style="color:#e6db74">&#39;character</span>)
           xi yi
           (thing-get tile <span style="color:#e6db74">&#39;color</span>))]
    <span style="color:#75715e">; If it&#39;s lit and there are items, draw the item</span>
    [else
     (send canvas write
           (thing-get (car (thing-get tile <span style="color:#e6db74">&#39;items</span>)) <span style="color:#e6db74">&#39;character</span>)
           xi yi
           (thing-get (car (thing-get tile <span style="color:#e6db74">&#39;items</span>)) <span style="color:#e6db74">&#39;color</span>))]))</code></pre></div>
<p>Basically, we draw nothing on dark tiles. This relies on the <code>clear</code> just above this code. If it&rsquo;s foggy, we have a background, defined at the top of the file<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>. Otherwise, we fall back on the methods that we already had.</p>

<p>Next, we need to actually calculate this lighting. Essentially, every tile starts dark. Then, if a tile is near to the player, light it up. If it&rsquo;s already lit but no longer near the tile, fade to fog. For now, we&rsquo;re just going to use a simple radius around the player (parameterized below). Here&rsquo;s the new <code>update-lighting</code> function and friends:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; entities.rkt</span>

<span style="color:#75715e">; game-screen.rkt</span>
(define-thing entity
  <span style="color:#f92672">...</span>
  [view-range <span style="color:#ae81ff">5</span>])

<span style="color:#75715e">; Draw the game itself.</span>
(define/override (draw canvas)
  (<span style="color:#66d9ef">define </span>player (send world get-player))
  (send canvas clear)

  <span style="color:#75715e">; Update lighting</span>
  (send world update-lighting)

  <span style="color:#f92672">...</span>)

<span style="color:#75715e">; world.rkt</span>

<span style="color:#75715e">; Update lighting</span>
(define/public (update-lighting)
  <span style="color:#75715e">; Turn any lit tiles to fog</span>
  <span style="color:#75715e">; Turn any tiles within the player&#39;s view limit to lit</span>
  (<span style="color:#66d9ef">define </span>player-location (thing-get player <span style="color:#e6db74">&#39;location</span>))
  (<span style="color:#66d9ef">define </span>player-view (thing-get player <span style="color:#e6db74">&#39;view-range</span> <span style="color:#ae81ff">5</span>))
  (for-tile
   (<span style="color:#66d9ef">lambda </span>(x y tile)
     (cond
       <span style="color:#75715e">; Light tiles near the player</span>
       [(&lt;= (distance player-location (pt x y)) player-view)
        (thing-set! tile <span style="color:#e6db74">&#39;lighting</span> <span style="color:#e6db74">&#39;lit</span>)]
       <span style="color:#75715e">; Fog previously lit tiles</span>
       [(eq? <span style="color:#e6db74">&#39;lit</span> (thing-get tile <span style="color:#e6db74">&#39;lighting</span>))
        (thing-set! tile <span style="color:#e6db74">&#39;lighting</span> <span style="color:#e6db74">&#39;fog</span>)]
       <span style="color:#75715e">; Otherwise do nothing</span>
       ))))</code></pre></div>
<p>For that, we need the <code>for-tile</code> function. You can check it out <a href="https://github.com/jpverkamp/racket-roguelike/blob/master/src/levels.rkt">on GitHub</a>, but essentially it takes a function of the form <code>(lambda (x y tile) ...)</code> and applies it to each tile on the current level. It might<sup class="footnote-ref" id="fnref:3"><a href="#fn:3">3</a></sup> get inefficient on more explored levels, but if people keep heading down, we should be good. So in this case, we&rsquo;ll just light the area around the player. How does that look?</p>

<figure>
    <img src="/embeds/2013/simple-lighting.png"/> 
</figure>


<p>Starting out, not too bad. We&rsquo;re out in the middle of a nice grass field like always. Just this time, we can&rsquo;t see much of it. Perhaps it&rsquo;s night time?</p>

<figure>
    <img src="/embeds/2013/simple-fog.png"/> 
</figure>


<p>Wander around a bit until we find a way down. You can see the gray background of the fog. That actually looks pretty nice, particularly as you&rsquo;re moving around.</p>

<figure>
    <img src="/embeds/2013/into-the-caves.png"/> 
</figure>


<p>Okay, now we&rsquo;re into the caves. Let&rsquo;s explore for a bit.</p>

<figure>
    <img src="/embeds/2013/this-is-a-problem.png"/> 
</figure>


<p>Hmm. Well, this is a problem. It turns out&hellip; we can see right through walls. Perhaps we should work on that a bit.</p>

<p>This is when a pre-built framework would <em>really</em> come in handy. But the algorithm isn&rsquo;t too bad. Essentially, we want <a href="https://en.wikipedia.org/wiki/raycasting">raycasting</a>. We&rsquo;ll start with a series of lines out from the player and light tiles as we go. If we hit something that can&rsquo;t be lit up, stop. Sounds like a nicely recursive function to me!</p>

<p>Before that, let&rsquo;s modify the tile definitions again. We&rsquo;ll add the <code>solid</code> property. If a tile is <code>solid</code> (like a wall or a tree), you can&rsquo;t see through it. Otherwise (like empty space or over water), you can.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

(define-thing tile
  [character <span style="color:#e6db74">#\space</span>]
  [color <span style="color:#e6db74">&#34;black&#34;</span>]
  [items <span style="color:#f92672">&#39;</span>()]
  [lighting <span style="color:#e6db74">&#39;dark</span>]    <span style="color:#75715e">; Dark: Invisible; Fog: Only show tile, not NPC or item; Lit: Everything</span>
  [walkable <span style="color:#66d9ef">#f</span>]       <span style="color:#75715e">; Can the player walk on this tile?</span>
  [solid <span style="color:#66d9ef">#f</span>]          <span style="color:#75715e">; Does this tile block light?</span>
  )</code></pre></div>
<p>So how do we write a raycasting function?</p>

<p>The basic idea<sup class="footnote-ref" id="fnref:4"><a href="#fn:4">4</a></sup> is to start with four rays, one in each of the cardinal directions. Give each ray its own direction. Then as we pass each tile, branch out in each direction for a total of three branches per iteration. It&rsquo;s certainly not optimal (we&rsquo;ll light some tiles more than once), but it does look nice.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

<span style="color:#75715e">; Update lighting</span>
(define/public (update-lighting)
  <span style="color:#75715e">; Turn any lit tiles to fog</span>
  (for-tile
   (<span style="color:#66d9ef">lambda </span>(x y tile)
     (cond
       [(eq? <span style="color:#e6db74">&#39;lit</span> (thing-get tile <span style="color:#e6db74">&#39;lighting</span> <span style="color:#e6db74">&#39;dark</span>))
        (thing-set! tile <span style="color:#e6db74">&#39;lighting</span> <span style="color:#e6db74">&#39;fog</span>)])))

  <span style="color:#75715e">; Spread lighting from the player</span>
  <span style="color:#75715e">; x/y current tile to light</span>
  <span style="color:#75715e">; xd/yd direction to spread light:</span>
  <span style="color:#75715e">;  if xd != 0, spread to (x+xd y-1) (x+xd y) (x+xd y+1)</span>
  <span style="color:#75715e">;  if yd != 0, spread to (x-1 y+yd) (x y+yd) (x-1 y+yd)</span>
  <span style="color:#75715e">; spread is initially set to player&#39;s light radius</span>
  (<span style="color:#66d9ef">define </span>(spread-light x y xd yd spread)
    <span style="color:#75715e">; Light the current tile</span>
    (<span style="color:#66d9ef">define </span>tile (get-tile x y))
    (thing-set! tile <span style="color:#e6db74">&#39;lighting</span> <span style="color:#e6db74">&#39;lit</span>)

    <span style="color:#75715e">; Recur</span>
    (cond
      <span style="color:#75715e">; Don&#39;t spread pass solid tiles (spread to them though)</span>
      <span style="color:#75715e">; Don&#39;t recur past the spread (vision range) value</span>
      [(<span style="color:#66d9ef">or </span>(&lt;= spread <span style="color:#ae81ff">0</span>) (thing-get tile <span style="color:#e6db74">&#39;solid</span> <span style="color:#66d9ef">#f</span>))
       (void)]
      <span style="color:#75715e">; Spread in the x direction</span>
      [(not (= xd <span style="color:#ae81ff">0</span>))
       (spread-light (+ x xd) (- y <span style="color:#ae81ff">1</span>) xd yd (- spread <span style="color:#ae81ff">1.41</span>))
       (spread-light (+ x xd) y       xd yd (- spread <span style="color:#ae81ff">1.00</span>))
       (spread-light (+ x xd) (+ y <span style="color:#ae81ff">1</span>) xd yd (- spread <span style="color:#ae81ff">1.41</span>))]
      <span style="color:#75715e">; Spread in the y direction</span>
      [else
       (spread-light (- x <span style="color:#ae81ff">1</span>) (+ y yd) xd yd (- spread <span style="color:#ae81ff">1.41</span>))
       (spread-light x       (+ y yd) xd yd (- spread <span style="color:#ae81ff">1.00</span>))
       (spread-light (+ x <span style="color:#ae81ff">1</span>) (+ y yd) xd yd (- spread <span style="color:#ae81ff">1.41</span>))]))

  <span style="color:#75715e">; Spread in the four directions</span>
  (<span style="color:#66d9ef">let </span>([player-x (pt-x (thing-get player <span style="color:#e6db74">&#39;location</span>))]
        [player-y (pt-y (thing-get player <span style="color:#e6db74">&#39;location</span>))]
        [player-v (thing-get player <span style="color:#e6db74">&#39;view-range</span> <span style="color:#ae81ff">5</span>)])
    (spread-light player-x player-y <span style="color:#ae81ff">-1</span>  <span style="color:#ae81ff">0</span> player-v)
    (spread-light player-x player-y  <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> player-v)
    (spread-light player-x player-y  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">-1</span> player-v)
    (spread-light player-x player-y  <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span> player-v)))</code></pre></div>
<p>Hopefully that all makes sense. One sneaky trick is reducing the <code>spread</code> by 1 on the orthogonal moves and 1.41 (roughly <span class="latex-inline">sqrt(2)</span>
) on the diagonals. This will give us a nice circle.</p>

<p>Let&rsquo;s see what an effect that has on the game:</p>

<figure>
    <img src="/embeds/2013/nice-circle.png"/> 
</figure>


<p>Starting out, we have a nice circle. So far, it looks pretty much the same as it did last time.</p>

<figure>
    <img src="/embeds/2013/trees-cast-shadows.png"/> 
</figure>


<p>Shadows! I can&rsquo;t tell you how excited this makes me. ðŸ˜„</p>

<figure>
    <img src="/embeds/2013/over-troubled-waters.png"/> 
</figure>


<p>And it works perfectly with water as well. We can see over the water, but we can&rsquo;t walk through it.</p>

<figure>
    <img src="/embeds/2013/missing-something.png"/> 
</figure>


<p>Unfortunately though, I haven&rsquo;t had any luck yet finding a staircase&hellip;</p>

<figure>
    <img src="/embeds/2013/no-more-xray-vision.png"/> 
</figure>


<p>Finally, we&rsquo;re down a level. It&rsquo;s nice to see<sup class="footnote-ref" id="fnref:5"><a href="#fn:5">5</a></sup>: no more x-ray vision! It does look a bit weird to have all the nice thin walls around, but it looks a lot better once you get used to it.</p>

<figure>
    <img src="/embeds/2013/there-are-rats.png"/> 
</figure>


<p>Theoretically, the player shouldn&rsquo;t be able to hear updates from entities that aren&rsquo;t visible. That would actually be pretty easy to implement (just check for the lighting in the logging function), but for the moment, I like the atmosphere it gives.</p>

<figure>
    <img src="/embeds/2013/still-no-rats.png"/> 
</figure>


<p>All that time wandering about and I still haven&rsquo;t actually found any of those rats to fight. I wanted to show that it won&rsquo;t draw them unless they&rsquo;re in a lit area. Sigh. So it goes.</p>

<p>Well, that&rsquo;s all we have for today. It&rsquo;s kind of amazing how much difference so few lines can make<sup class="footnote-ref" id="fnref:6"><a href="#fn:6">6</a></sup>.</p>

<p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:
- <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike/tree/day-7">Racket Roguelike - Day 7</a>
- <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">Racket Roguelike - Up to date</a></p>

<p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-7
git submodule init
git submodule update
racket main.rkt</code></pre></div>
<p><strong>Edit:</strong></p>

<p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">raco pkg install github://github.com:jpverkamp/ascii-canvas/master
raco pkg install github://github.com:jpverkamp/noise/master
raco pkg install github://github.com:jpverkamp/thing/master
git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-7
racket main.rkt</code></pre></div>
<p>For part 8, click here: <a href="https://blog.jverkamp.com/2013/06/21/racket-roguelike-8-a-million-words/">Racket Roguelike 8: A million words!</a></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Always a good sign when you find yourself actually playing your own game&hellip;
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">And defined only once to save just a bit on performance; we&rsquo;re going to have to look at that soon&hellip;
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">Read: will
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
<li id="fn:4">Which may or may not be the standard way of doing it
 <a class="footnote-return" href="#fnref:4"><sup>[return]</sup></a></li>
<li id="fn:5">Believe it or not, pun not intended
 <a class="footnote-return" href="#fnref:5"><sup>[return]</sup></a></li>
<li id="fn:6">According to the git diff, 26 lines removed and 111 added
 <a class="footnote-return" href="#fnref:6"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Racket Roguelike 7: Into darkness!";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2013\/05\/17\/racket-roguelike-7-into-darkness\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

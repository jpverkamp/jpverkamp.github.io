<!DOCTYPE html>
<html onclick >
<head>
    <title>Racket Roguelike 6: Dig deeper! â€“ jverkamp.com</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a> *
            <a href="/resume">Resume</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>
    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Racket Roguelike 6: Dig deeper!</h1>

        <div class="entry-meta"><span class="entry-date">2013-05-10</span>
            </div>

        <div class="entry-taxonomies"><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/" class="previous-link"></a><a class="taxonomy-value" href="/programming/sources/7drl">7DRL</a><a href="https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/games">Games</a><a href="https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/roguelikes">Roguelikes</a><a href="https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/" class="previous-link"></a><a class="taxonomy-value" href="/series/racket-roguelike">Racket Roguelike</a><a href="https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2013/05/06/iron-man-3/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2013/05/16/pain-gain/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</div>
    </header>

	<div class="entry-content"><blockquote>
<p>Moria&hellip; You fear to go into those mines. The dwarves delved too greedily and too deep. You know what they awoke in the darkness of Khazad-dum&hellip; shadow and flame.
&ndash; Saruman, Lord of the Rings</p>
</blockquote>

<p>Today, we dig too deep.</p>

<p>(If you&rsquo;d like to start at the beginning, click here: <a href="https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/">Racket Roguelike 1: A GUI, screens, I/O, and you!</a>)</p>

<p>Essentially, what we&rsquo;re going to do today is to tear out that placeholder we had for level generation and add a proper abstracted level generation script. With that, we might as well add the ability to generate a bunch of levels and just dig deeper and deeper.</p>

<p>Okay, so what&rsquo;s first? Well, the current code for level generation is in that huge, ugly <code>get-tile</code> function in <code>world.rkt</code>. Instead, let&rsquo;s make a new file: <code>levels.rkt</code>. This will have all of the level generation code. So what&rsquo;s first? Let&rsquo;s pull out the code generation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

<span style="color:#75715e">; Generate a simple cave with water and trees</span>
(<span style="color:#66d9ef">define </span>(shallow-cave x y)
  (<span style="color:#66d9ef">define </span>wall?  (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y) <span style="color:#ae81ff">0</span>)         <span style="color:#ae81ff">0</span>))
  (<span style="color:#66d9ef">define </span>water? (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) <span style="color:#ae81ff">0</span>         (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
  (<span style="color:#66d9ef">define </span>tree?  (&gt; (simplex <span style="color:#ae81ff">0</span>         (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
  (cond
    [wall?  (make-thing wall)]
    [water? (make-thing water)]
    [tree?  (make-thing tree)]
    [<span style="color:#66d9ef">else </span>  (make-thing empty)]))</code></pre></div>
<p>This will represent the first few levels under the ground, with the same basic cave systems we&rsquo;ve been using forever. There&rsquo;s on problem with that&ndash;it turns out that using the noise functions is both a time saver and will be our undoing. Since the function always returns the same values, given the same arguments, every level of our cave system will be identical. Not something we want (at least not for the caves).</p>

<p>The fix?</p>

<p>Add another parameter!</p>

<p>Technically, there are two ways that we could do this:</p>

<ul>
<li>Add a z-coordinate that corresponds to depth. This feels like some nice parallelism, but it means that every single time we play the game, the caves will be the same. Sub-optimal for a roguelike.</li>
<li>Add a random seed that is set once per level. This will generate levels random (albeit consistently within a single playthrough), so this is the option we want.</li>
</ul>

<p>This actually turns out to be really easy to implement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

<span style="color:#75715e">; Generate a simple cave with water and trees</span>
(<span style="color:#66d9ef">define </span>(shallow-cave seed x y)
  (<span style="color:#66d9ef">define </span>wall?  (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y) seed)      <span style="color:#ae81ff">0</span>))
  (<span style="color:#66d9ef">define </span>water? (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) seed      (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
  (<span style="color:#66d9ef">define </span>tree?  (&gt; (simplex seed      (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
  (cond
    [wall?  (make-thing wall)]
    [water? (make-thing water)]
    [tree?  (make-thing tree)]
    [<span style="color:#66d9ef">else </span>  (make-thing empty)]))</code></pre></div>
<p>Now we&rsquo;ll get all sorts of interesting levels. For example:</p>

<figure>
    <img src="/embeds/2013/cave-1.png"/> 
</figure>


<figure>
    <img src="/embeds/2013/cave-2.png"/> 
</figure>


<p>(Yes, there are only rats and basic gear. I&rsquo;ll get to that in a second.)</p>

<p>So we can make caves, just like we always have, but what about other sorts of terrain? Well, all we have to do is copy/paste/tweak. Let&rsquo;s say instead of caves and walls, we want grassland (but still with trees and small ponds). We&rsquo;d get something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

(define-thing grass tile
  [character <span style="color:#e6db74">#\.</span>]
  [color <span style="color:#e6db74">&#34;green&#34;</span>]
  [walkable <span style="color:#66d9ef">#t</span>])

<span style="color:#75715e">; The surface level with grass, water, and trees</span>
(<span style="color:#66d9ef">define </span>(surface seed x y)
  (<span style="color:#66d9ef">define </span>water? (&gt; (simplex (* <span style="color:#ae81ff">0.1</span> x) seed      (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
  (<span style="color:#66d9ef">define </span>tree?  (&gt; (simplex seed      (* <span style="color:#ae81ff">0.1</span> x) (* <span style="color:#ae81ff">0.1</span> y)) <span style="color:#ae81ff">0.5</span>))
  (cond
    [water? (make-thing water)]
    [tree?  (make-thing tree)]
    [<span style="color:#66d9ef">else </span>  (make-thing grass)]))</code></pre></div>
<figure>
    <img src="/embeds/2013/grassland.png"/> 
</figure>


<p>We can easily tune this to make any sorts of levels. Even better, we don&rsquo;t necessary need to use the noise functions. We could theoretically make levels based on something like <a href="https://en.wikipedia.org/wiki/cellular%20automaton">cellular automaton</a> or even scripted levels (perhaps loaded from external files?). All we have to do is be able to generate a specific tile when asked and our framework will generate the rest. Speaking of which, how do we tie this into the previous <code>get-tile</code> function?</p>

<p>Well, we need a bit of abstraction first. First, how do we want to represent z-levels? Theoretically, we could use the same hash that we&rsquo;ve been using, only using <code>(list x y z)</code> instead of <code>(list x y)</code>. But keeping all of that in one hash seems like a recipe for trouble, so instead, we&rsquo;ll store a hash of hashes. Each outer hash will be indexed by depth, the inner by the point. Then we can have a local variable referring to just the current level.</p>

<p>While we&rsquo;re at it, let&rsquo;s all refactor some other code. We need to store the <code>seed</code> that I mentioned earlier for each level. In addition, we want to store the generation functions for tiles (and later NPCs and items). Finally, so we don&rsquo;t have an ever-growing list of NPCs all acting each tick, let&rsquo;s move the NPC lists into the level. In the end, something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

<span style="color:#75715e">; Level defintions</span>
<span style="color:#75715e">; tile-gen : x y -&gt; tile</span>
<span style="color:#75715e">; npc-gen  : x y -&gt; npc or #f</span>
<span style="color:#75715e">; item-gen : x y -&gt; item or #f</span>
(define-struct level-definition (tile-gen npc-gen item-gen))

<span style="color:#75715e">; All levels</span>
<span style="color:#75715e">; (pt x y) : tile</span>
<span style="color:#75715e">; &#39;npcs    : list of npcs</span>
<span style="color:#75715e">; &#39;gen     ; level definition (see above)</span>
<span style="color:#75715e">; &#39;seed    ; a random seed [0,1) generated once per level</span>
(<span style="color:#66d9ef">define </span>levels (make-hasheq))
(<span style="color:#66d9ef">define </span>current-depth (make-parameter <span style="color:#ae81ff">0</span>))

<span style="color:#75715e">; Generate a new level (if it doesn&#39;t already exist)</span>
(<span style="color:#66d9ef">define </span>(get-level depth)
  (unless (hash-has-key? levels depth)
    (<span style="color:#66d9ef">define </span>level (make-hash))
    (hash-set! level <span style="color:#e6db74">&#39;seed</span> (random))
    (hash-set! level <span style="color:#e6db74">&#39;npcs</span> <span style="color:#f92672">&#39;</span>())
    (hash-set! level <span style="color:#e6db74">&#39;gen</span>
      (cond
        [(= depth <span style="color:#ae81ff">0</span>)
         (level-definition surface nothing nothing)]
        [else
         (level-definition shallow-cave rats-only base-items)]))
    (hash-set! levels depth level))
  (hash-ref levels depth))</code></pre></div>
<p>With this, <code>get-level</code> mirrors <code>get-tile</code>. If a level doesn&rsquo;t currently exist, it will generate a new one. In this case, we have our two generation functions. If the level is 0 (the ground level), use the grassland generator. If it&rsquo;s less than that, for now always generate caves. There are a few other generators (<code>nothing</code>, <code>rats-only</code>, and <code>base-items</code>) but I&rsquo;ll get to those in a moment. (You can get a pretty good hint for what those will be by looking at the <code>level-definition</code> struct.)</p>

<p>With this, we have what we need to rebuild the <code>get-tile</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

<span style="color:#75715e">; Fetch a tile</span>
(<span style="color:#66d9ef">define </span>(get-tile x y)
  (<span style="color:#66d9ef">define </span>current-level (get-level (current-depth)))
  (<span style="color:#66d9ef">define </span>seed (hash-ref current-level <span style="color:#e6db74">&#39;seed</span>))

  <span style="color:#75715e">; If the tile doesn&#39;t already exist, generate it</span>
  (unless (hash-has-key? current-level (pt x y))
    <span style="color:#75715e">; Get the new tile</span>
    (<span style="color:#66d9ef">define </span>new-tile ((level-definition-tile-gen (hash-ref current-level <span style="color:#e6db74">&#39;gen</span>)) seed x y))
    (hash-set! current-level (pt x y) new-tile)

    <span style="color:#75715e">; NPCs and items are only on walkable tiles</span>
    (when (thing-get new-tile <span style="color:#e6db74">&#39;walkable</span>)
      <span style="color:#75715e">; (Potentially) generate a new npc</span>
      (<span style="color:#66d9ef">define </span>new-npc ((level-definition-npc-gen (hash-ref current-level <span style="color:#e6db74">&#39;gen</span>)) seed x y))
      (when (<span style="color:#66d9ef">and </span>(not (void? new-npc)) new-npc)
        (<span style="color:#66d9ef">let </span>([new-npc (make-thing new-npc [location (pt x y)])])
          (hash-set! current-level <span style="color:#e6db74">&#39;npcs</span> (cons new-npc (hash-ref current-level <span style="color:#e6db74">&#39;npcs</span>)))))

      <span style="color:#75715e">; (Potentially) generate a new item for that tile</span>
      <span style="color:#75715e">; Do not generate an item if there already is one (generated by the tile generation routine)</span>
      (when (null? (thing-get new-tile <span style="color:#e6db74">&#39;items</span> <span style="color:#f92672">&#39;</span>()))
        (<span style="color:#66d9ef">define </span>new-item ((level-definition-item-gen (hash-ref current-level <span style="color:#e6db74">&#39;gen</span>)) seed x y))
        (when (<span style="color:#66d9ef">and </span>(not (void? new-item)) new-item)
          (<span style="color:#66d9ef">let </span>([new-item (make-thing new-item)])
            (thing-set! new-tile <span style="color:#e6db74">&#39;items</span> (cons new-item (thing-get new-tile <span style="color:#e6db74">&#39;items</span>))))))))

  <span style="color:#75715e">; Return the tile (newly generated or not)</span>
  (hash-ref current-level (pt x y)))</code></pre></div>
<p>It has the same structure it always did, but now it&rsquo;s nicely abstracted. The first chunk just generates a tile using the generation functions we defined earlier (<code>surface</code> and <code>shallow-caves</code>). The code to do that <code>((level-definition-tile-gen (hash-ref current-level 'gen)) seed x y)</code> is a bit ugly, but it works well enough.</p>

<p>After that (if and only if we have a <code>walkable</code> tile), try to generate an NPC. The NPC generation functions are going to look exactly like the tile functions, except the return entities rather than tiles and can return either <code>void</code> or <code>#f</code> if there&rsquo;s no NPC in that location. So if we just want an empty world, we can always return <code>#f</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

<span style="color:#75715e">; No NPCs (also works for items)</span>
(<span style="color:#66d9ef">define </span>(nothing seed x y) <span style="color:#66d9ef">#f</span>)</code></pre></div>
<p>If we want a world full of rats (roughly 1% of the time):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

<span style="color:#75715e">; Look up a thing from a vector by &#39;name</span>
(<span style="color:#66d9ef">define </span>(lookup vec name)
  (let/ec return
    (for ([thing vec]
          <span style="color:#f92672">#</span>:when (equal? name (thing-get thing <span style="color:#e6db74">&#39;name</span> <span style="color:#66d9ef">#f</span>)))
      (return thing))
    (return <span style="color:#66d9ef">#f</span>)))

<span style="color:#75715e">; Rats. All of the rats.</span>
(<span style="color:#66d9ef">define </span>(rats-only seed x y)
  (when (zero? (random <span style="color:#ae81ff">100</span>))
    (lookup *entities* <span style="color:#e6db74">&#34;rat&#34;</span>)))</code></pre></div>
<p>The lookup function is so I can reuse those vectors of things I&rsquo;ve been defining in <code>entities.rkt</code> and <code>items.rkt</code>. Basically, it finds the first <code>thing</code> with the given <code>'name</code> field.</p>

<p>Items work much the same way. If we want just the basic tier of items, we can do this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

<span style="color:#75715e">; Only basic items</span>
(<span style="color:#66d9ef">define </span>(base-items seed x y)
  (when (zero? (random <span style="color:#ae81ff">100</span>))
    (<span style="color:#66d9ef">case </span>(random <span style="color:#ae81ff">4</span>)
      [(<span style="color:#ae81ff">0</span>) (lookup *armors* <span style="color:#e6db74">&#34;leather&#34;</span>)]
      [(<span style="color:#ae81ff">1</span>) (lookup *weapons* <span style="color:#e6db74">&#34;club&#34;</span>)]
      [(<span style="color:#ae81ff">2</span>) (lookup *potions* <span style="color:#e6db74">&#34;health potion&#34;</span>)]
      [(<span style="color:#ae81ff">3</span>) (lookup *coins* <span style="color:#e6db74">&#34;copper coin&#34;</span>)])))</code></pre></div>
<p>(I added a new kind of item: <code>stackable</code>. Rather than replacing other items of a given type, they stack with them, combining quantities. Coins are currently the only stackable and at the moment, they&rsquo;re completely worthless. But it&rsquo;s a neat proof of concept. Check out the code <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">on GitHub</a> for more details.)</p>

<p>Okay. That&rsquo;s basically everything to actually generate the levels. But we still have two fairly big problems:</p>

<ul>
<li>How does this hook up to the code we already have?</li>
<li>How do we get to different levels?</li>
</ul>

<p>For the first problem, we need to tweak <code>world.rkt</code>. Essentially, we renamed the <code>get-tile</code> function as <code>tile-at</code> and just wrapped <code>get-tile</code> from <code>levels.rkt</code>. Likewise with <code>update</code> and <code>update-npcs</code>. It&rsquo;s pretty straight forward, check out the code <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">on GitHub</a> for more details.</p>

<p>The more interesting challenge is getting to different levels. The traditional way to do that in roguelikes is stairs. So we need a new tile type. But right now, we don&rsquo;t have a way to attach events to tiles. So we&rsquo;ll do both at once. Now, any tile can have an (optional) <code>on-enter</code> event, much like the <code>on-pickup</code> and <code>on-drop</code> events on items. Something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; levels.rkt</span>

(define-thing stairs-up tile
  [character <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">\</span>&lt;]
  [color <span style="color:#e6db74">&#34;gold&#34;</span>]
  [walkable <span style="color:#66d9ef">#t</span>]
  [(on-enter entity world)
   (when (eq? (send world get-player) entity)
     (ascend)
     (hash-set! (get-level (current-depth))
                (thing-get (send world get-player) <span style="color:#e6db74">&#39;location</span>)
                (make-thing stairs-up)))])</code></pre></div>
<p><code>stairs-up</code> will be much the same. Essentially, when the player enters a tile (the <code>when</code> keeps those pesky rats from using the stairs for the time being), they will call <code>ascend</code> which just sets the <code>current-depth</code> variable we defined earlier to one higher, which is all we would need, since the next rendering step will call <code>get-tile</code> which in turn calls <code>get-level</code>. Since there is no level yet (unless we leave the level and come back), a new one will be generated. That&rsquo;s the beauty of the lazy tile generation setup we&rsquo;re using.</p>

<p>The final chunk is particularly amusing. Basically, when you code up the stairs, it will generate the matching stairs on the next level. This isn&rsquo;t perfect, since if you go back to a level you&rsquo;ve already been on, the stairs will appear from nowhere. For now, we&rsquo;ll consider this a &lsquo;feature&rsquo;. Hidden stairs. ðŸ˜„ Another problem is that there&rsquo;s nothing stopping the stairs from popping up in the middle of a wall. Since stairs on only triggered by entering them, that will be game over. Clearly sub-optmimal, but that&rsquo;s something we can save for later.</p>

<p>Speaking of which, how do we implement <code>on-enter</code>? Well, that&rsquo;s where the <code>try-move</code> function in <code>world.rkt</code> comes in. Find the one place where the player can move (where the target is <code>walkable</code> and not otherwise occupied) and add this code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; world.rkt</span>

<span style="color:#75715e">; Look for an on-enter item</span>
(<span style="color:#66d9ef">define </span>on-enter (thing-get tile <span style="color:#e6db74">&#39;on-enter</span> <span style="color:#66d9ef">#f</span>))
(when on-enter
  (on-enter entity this))</code></pre></div>
<p>And that&rsquo;s all we need. Bam, z-levels. And it should be really easy to add more level definitions with all sorts of varied properties. One of these weeks (soon probably), I should actually work on balancing and adding a bunch of new content. That will be the last step for making a full game. But really, we&rsquo;re basically there. All we really need still to have a game is more content and a way to win (It&rsquo;s perfectly possible to lose right now, but winning? Not so much).</p>

<p>Before we go, how about a few more screenshots with stairs and all?</p>

<figure>
    <img src="/embeds/2013/1-all-peaceful.png"/> 
</figure>


<p>Starting out, we&rsquo;re in a nice peaceful field. All we really have to do is find some stairs (or wander off into infinity (and beyond!)).</p>

<figure>
    <img src="/embeds/2013/2-going-down.png"/> 
</figure>


<p>Found some stairs. Down we go!</p>

<figure>
    <img src="/embeds/2013/3-into-the-caves.png"/> 
</figure>


<p>A nice little cavern. There are rats south and east and one of those nice new coins up north.</p>

<figure>
    <img src="/embeds/2013/4-got-a-coin-killed-a-rat.png"/> 
</figure>


<p>Here we&rsquo;ve grabbed the coin up north and killed the rat over by the potion. The coins have values based on the &ldquo;gold standard&rdquo; (1 gold = 10 silver = 100 copper, yay D&amp;D!), so it&rsquo;s really not much. But since they don&rsquo;t do anything anyways, it&rsquo;s as good as gold!</p>

<p>Let&rsquo;s try heading back up. Remember that other set of stairs? What happens if we take those?</p>

<figure>
    <img src="/embeds/2013/5-up-down-wall.png"/> 
</figure>


<p>Oops. Yeah, I really should fix that. Now I&rsquo;m in the middle of a wall and thus stuck. I really should add a way to manually trigger <code>on-enter</code> actions. We&rsquo;ll see how that goes.</p>

<p>Well, that&rsquo;s it for today. It&rsquo;s really starting to look like a game now. ðŸ˜„</p>

<p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:
- <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike/tree/day-6">Racket Roguelike - Day 6</a>
- <a title="Racket Roguelike on GitHub" href="https://github.com/jpverkamp/racket-roguelike">Racket Roguelike - Up to date</a></p>

<p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href="http://git-scm.com/">Git</a> and <a href="http://racket-lang.org/">Racket</a> and run the following series of commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-6
git submodule init
git submodule update
racket main.rkt</code></pre></div>
<p><strong>Edit:</strong></p>

<p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">raco pkg install github://github.com:jpverkamp/ascii-canvas/master
raco pkg install github://github.com:jpverkamp/noise/master
raco pkg install github://github.com:jpverkamp/thing/master
git clone git://github.com/jpverkamp/racket-roguelike.git
cd racket-roguelike
git checkout day-6
racket main.rkt</code></pre></div>
<p>(Note: Sorry I&rsquo;m a day late this week. Life&rsquo;s been crazy between conference deadlines and getting married. One of these days I&rsquo;ll actually actually write one of these posts ahead of time&hellip; Or not.)</p>

<p>For part 7, click here: <a href="https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/">Racket Roguelike 7: Into Darkness!</a></p></div>
</article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script src="/custom.js"></script>
</body>
</html>

<!doctype html><html><head><title>Racket Roguelike 6: Dig deeper! â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.1a5fbab1ecff843d4ee6e936243fb06066197cd8c9357883d791333ce6001f3b.css integrity="sha256-Gl+6sez/hD1O5uk2JD+wYGYZfNjJNXiD15EzPOYAHzs="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Racket Roguelike 6: Dig deeper!</h1><div class=entry-meta><span class=entry-date>2013-05-10</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/7drl>7DRL</a><a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/games>Games</a><a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/roguelikes>Roguelikes</a><a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ class=previous-link></a><a class=taxonomy-value href=/series/racket-roguelike>Racket Roguelike</a><a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/05/02/racket-roguelike-5-armors-and-weapons-and-potions-oh-my/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/05/16/pain-gain/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><blockquote><p>Moria&mldr; You fear to go into those mines. The dwarves delved too greedily and too deep. You know what they awoke in the darkness of Khazad-dum&mldr; shadow and flame.
&ndash; Saruman, Lord of the Rings</p></blockquote><p>Today, we dig too deep.</p><p>(If you&rsquo;d like to start at the beginning, click here: <a href=https://blog.jverkamp.com/2013/04/04/racket-roguelike-1-a-gui-screens-i/o-and-you/>Racket Roguelike 1: A GUI, screens, I/O, and you!</a>)</p><p>Essentially, what we&rsquo;re going to do today is to tear out that placeholder we had for level generation and add a proper abstracted level generation script. With that, we might as well add the ability to generate a bunch of levels and just dig deeper and deeper.</p><p>Okay, so what&rsquo;s first? Well, the current code for level generation is in that huge, ugly <code>get-tile</code> function in <code>world.rkt</code>. Instead, let&rsquo;s make a new file: <code>levels.rkt</code>. This will have all of the level generation code. So what&rsquo;s first? Let&rsquo;s pull out the code generation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Generate a simple cave with water and trees</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>shallow-cave</span> x y)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>wall?  (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y) <span style=color:#ae81ff>0</span>)         <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>water? (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) <span style=color:#ae81ff>0</span>         (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>tree?  (&gt; (<span style=color:#a6e22e>simplex</span> <span style=color:#ae81ff>0</span>         (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    [wall?  (<span style=color:#a6e22e>make-thing</span> wall)]
</span></span><span style=display:flex><span>    [water? (<span style=color:#a6e22e>make-thing</span> water)]
</span></span><span style=display:flex><span>    [tree?  (<span style=color:#a6e22e>make-thing</span> tree)]
</span></span><span style=display:flex><span>    [<span style=color:#66d9ef>else </span>  (<span style=color:#a6e22e>make-thing</span> empty)]))
</span></span></code></pre></div><p>This will represent the first few levels under the ground, with the same basic cave systems we&rsquo;ve been using forever. There&rsquo;s on problem with that&ndash;it turns out that using the noise functions is both a time saver and will be our undoing. Since the function always returns the same values, given the same arguments, every level of our cave system will be identical. Not something we want (at least not for the caves).</p><p>The fix?</p><p>Add another parameter!</p><p>Technically, there are two ways that we could do this:</p><ul><li>Add a z-coordinate that corresponds to depth. This feels like some nice parallelism, but it means that every single time we play the game, the caves will be the same. Sub-optimal for a roguelike.</li><li>Add a random seed that is set once per level. This will generate levels random (albeit consistently within a single playthrough), so this is the option we want.</li></ul><p>This actually turns out to be really easy to implement:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Generate a simple cave with water and trees</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>shallow-cave</span> seed x y)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>wall?  (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y) seed)      <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>water? (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) seed      (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>tree?  (&gt; (<span style=color:#a6e22e>simplex</span> seed      (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    [wall?  (<span style=color:#a6e22e>make-thing</span> wall)]
</span></span><span style=display:flex><span>    [water? (<span style=color:#a6e22e>make-thing</span> water)]
</span></span><span style=display:flex><span>    [tree?  (<span style=color:#a6e22e>make-thing</span> tree)]
</span></span><span style=display:flex><span>    [<span style=color:#66d9ef>else </span>  (<span style=color:#a6e22e>make-thing</span> empty)]))
</span></span></code></pre></div><p>Now we&rsquo;ll get all sorts of interesting levels. For example:</p><figure><img src=/embeds/2013/cave-1.png></figure><figure><img src=/embeds/2013/cave-2.png></figure><p>(Yes, there are only rats and basic gear. I&rsquo;ll get to that in a second.)</p><p>So we can make caves, just like we always have, but what about other sorts of terrain? Well, all we have to do is copy/paste/tweak. Let&rsquo;s say instead of caves and walls, we want grassland (but still with trees and small ponds). We&rsquo;d get something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> grass tile
</span></span><span style=display:flex><span>  [character <span style=color:#e6db74>#\.</span>]
</span></span><span style=display:flex><span>  [color <span style=color:#e6db74>&#34;green&#34;</span>]
</span></span><span style=display:flex><span>  [walkable <span style=color:#66d9ef>#t</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; The surface level with grass, water, and trees</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>surface</span> seed x y)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>water? (&gt; (<span style=color:#a6e22e>simplex</span> (* <span style=color:#ae81ff>0.1</span> x) seed      (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>tree?  (&gt; (<span style=color:#a6e22e>simplex</span> seed      (* <span style=color:#ae81ff>0.1</span> x) (* <span style=color:#ae81ff>0.1</span> y)) <span style=color:#ae81ff>0.5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    [water? (<span style=color:#a6e22e>make-thing</span> water)]
</span></span><span style=display:flex><span>    [tree?  (<span style=color:#a6e22e>make-thing</span> tree)]
</span></span><span style=display:flex><span>    [<span style=color:#66d9ef>else </span>  (<span style=color:#a6e22e>make-thing</span> grass)]))
</span></span></code></pre></div><figure><img src=/embeds/2013/grassland.png></figure><p>We can easily tune this to make any sorts of levels. Even better, we don&rsquo;t necessary need to use the noise functions. We could theoretically make levels based on something like <a href=https://en.wikipedia.org/wiki/cellular%20automaton>cellular automaton</a> or even scripted levels (perhaps loaded from external files?). All we have to do is be able to generate a specific tile when asked and our framework will generate the rest. Speaking of which, how do we tie this into the previous <code>get-tile</code> function?</p><p>Well, we need a bit of abstraction first. First, how do we want to represent z-levels? Theoretically, we could use the same hash that we&rsquo;ve been using, only using <code>(list x y z)</code> instead of <code>(list x y)</code>. But keeping all of that in one hash seems like a recipe for trouble, so instead, we&rsquo;ll store a hash of hashes. Each outer hash will be indexed by depth, the inner by the point. Then we can have a local variable referring to just the current level.</p><p>While we&rsquo;re at it, let&rsquo;s all refactor some other code. We need to store the <code>seed</code> that I mentioned earlier for each level. In addition, we want to store the generation functions for tiles (and later NPCs and items). Finally, so we don&rsquo;t have an ever-growing list of NPCs all acting each tick, let&rsquo;s move the NPC lists into the level. In the end, something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Level defintions</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; tile-gen : x y -&gt; tile</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; npc-gen  : x y -&gt; npc or #f</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; item-gen : x y -&gt; item or #f</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-struct</span> level-definition (<span style=color:#a6e22e>tile-gen</span> npc-gen item-gen))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; All levels</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; (pt x y) : tile</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; &#39;npcs    : list of npcs</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; &#39;gen     ; level definition (see above)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; &#39;seed    ; a random seed [0,1) generated once per level</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>levels (<span style=color:#a6e22e>make-hasheq</span>))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>current-depth (<span style=color:#a6e22e>make-parameter</span> <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Generate a new level (if it doesn&#39;t already exist)</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-level</span> depth)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>unless</span> (<span style=color:#a6e22e>hash-has-key?</span> levels depth)
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>level (<span style=color:#a6e22e>make-hash</span>))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>hash-set!</span> level <span style=color:#e6db74>&#39;seed</span> (<span style=color:#a6e22e>random</span>))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>hash-set!</span> level <span style=color:#e6db74>&#39;npcs</span> <span style=color:#f92672>&#39;</span>())
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>hash-set!</span> level <span style=color:#e6db74>&#39;gen</span>
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>        [(= depth <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>level-definition</span> surface nothing nothing)]
</span></span><span style=display:flex><span>        [else
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>level-definition</span> shallow-cave rats-only base-items)]))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>hash-set!</span> levels depth level))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>hash-ref</span> levels depth))
</span></span></code></pre></div><p>With this, <code>get-level</code> mirrors <code>get-tile</code>. If a level doesn&rsquo;t currently exist, it will generate a new one. In this case, we have our two generation functions. If the level is 0 (the ground level), use the grassland generator. If it&rsquo;s less than that, for now always generate caves. There are a few other generators (<code>nothing</code>, <code>rats-only</code>, and <code>base-items</code>) but I&rsquo;ll get to those in a moment. (You can get a pretty good hint for what those will be by looking at the <code>level-definition</code> struct.)</p><p>With this, we have what we need to rebuild the <code>get-tile</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Fetch a tile</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>get-tile</span> x y)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>current-level (<span style=color:#a6e22e>get-level</span> (<span style=color:#a6e22e>current-depth</span>)))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>seed (<span style=color:#a6e22e>hash-ref</span> current-level <span style=color:#e6db74>&#39;seed</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; If the tile doesn&#39;t already exist, generate it</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>unless</span> (<span style=color:#a6e22e>hash-has-key?</span> current-level (<span style=color:#a6e22e>pt</span> x y))
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Get the new tile</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>new-tile ((<span style=color:#a6e22e>level-definition-tile-gen</span> (<span style=color:#a6e22e>hash-ref</span> current-level <span style=color:#e6db74>&#39;gen</span>)) seed x y))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>hash-set!</span> current-level (<span style=color:#a6e22e>pt</span> x y) new-tile)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; NPCs and items are only on walkable tiles</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>when</span> (<span style=color:#a6e22e>thing-get</span> new-tile <span style=color:#e6db74>&#39;walkable</span>)
</span></span><span style=display:flex><span>      <span style=color:#75715e>; (Potentially) generate a new npc</span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>define </span>new-npc ((<span style=color:#a6e22e>level-definition-npc-gen</span> (<span style=color:#a6e22e>hash-ref</span> current-level <span style=color:#e6db74>&#39;gen</span>)) seed x y))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>and </span>(not (<span style=color:#a6e22e>void?</span> new-npc)) new-npc)
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>let </span>([new-npc (<span style=color:#a6e22e>make-thing</span> new-npc [location (<span style=color:#a6e22e>pt</span> x y)])])
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>hash-set!</span> current-level <span style=color:#e6db74>&#39;npcs</span> (cons new-npc (<span style=color:#a6e22e>hash-ref</span> current-level <span style=color:#e6db74>&#39;npcs</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; (Potentially) generate a new item for that tile</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Do not generate an item if there already is one (generated by the tile generation routine)</span>
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>when</span> (null? (<span style=color:#a6e22e>thing-get</span> new-tile <span style=color:#e6db74>&#39;items</span> <span style=color:#f92672>&#39;</span>()))
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>define </span>new-item ((<span style=color:#a6e22e>level-definition-item-gen</span> (<span style=color:#a6e22e>hash-ref</span> current-level <span style=color:#e6db74>&#39;gen</span>)) seed x y))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>and </span>(not (<span style=color:#a6e22e>void?</span> new-item)) new-item)
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>let </span>([new-item (<span style=color:#a6e22e>make-thing</span> new-item)])
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>thing-set!</span> new-tile <span style=color:#e6db74>&#39;items</span> (cons new-item (<span style=color:#a6e22e>thing-get</span> new-tile <span style=color:#e6db74>&#39;items</span>))))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Return the tile (newly generated or not)</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>hash-ref</span> current-level (<span style=color:#a6e22e>pt</span> x y)))
</span></span></code></pre></div><p>It has the same structure it always did, but now it&rsquo;s nicely abstracted. The first chunk just generates a tile using the generation functions we defined earlier (<code>surface</code> and <code>shallow-caves</code>). The code to do that <code>((level-definition-tile-gen (hash-ref current-level 'gen)) seed x y)</code> is a bit ugly, but it works well enough.</p><p>After that (if and only if we have a <code>walkable</code> tile), try to generate an NPC. The NPC generation functions are going to look exactly like the tile functions, except the return entities rather than tiles and can return either <code>void</code> or <code>#f</code> if there&rsquo;s no NPC in that location. So if we just want an empty world, we can always return <code>#f</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; No NPCs (also works for items)</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>nothing</span> seed x y) <span style=color:#66d9ef>#f</span>)
</span></span></code></pre></div><p>If we want a world full of rats (roughly 1% of the time):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Look up a thing from a vector by &#39;name</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>lookup</span> vec name)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>let/ec</span> return
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>for</span> ([thing vec]
</span></span><span style=display:flex><span>          <span style=color:#f92672>#</span>:when (equal? name (<span style=color:#a6e22e>thing-get</span> thing <span style=color:#e6db74>&#39;name</span> <span style=color:#66d9ef>#f</span>)))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>return</span> thing))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>return</span> <span style=color:#66d9ef>#f</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Rats. All of the rats.</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>rats-only</span> seed x y)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (zero? (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>lookup</span> *entities* <span style=color:#e6db74>&#34;rat&#34;</span>)))
</span></span></code></pre></div><p>The lookup function is so I can reuse those vectors of things I&rsquo;ve been defining in <code>entities.rkt</code> and <code>items.rkt</code>. Basically, it finds the first <code>thing</code> with the given <code>'name</code> field.</p><p>Items work much the same way. If we want just the basic tier of items, we can do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Only basic items</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>base-items</span> seed x y)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (zero? (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>      [(<span style=color:#ae81ff>0</span>) (<span style=color:#a6e22e>lookup</span> *armors* <span style=color:#e6db74>&#34;leather&#34;</span>)]
</span></span><span style=display:flex><span>      [(<span style=color:#ae81ff>1</span>) (<span style=color:#a6e22e>lookup</span> *weapons* <span style=color:#e6db74>&#34;club&#34;</span>)]
</span></span><span style=display:flex><span>      [(<span style=color:#ae81ff>2</span>) (<span style=color:#a6e22e>lookup</span> *potions* <span style=color:#e6db74>&#34;health potion&#34;</span>)]
</span></span><span style=display:flex><span>      [(<span style=color:#ae81ff>3</span>) (<span style=color:#a6e22e>lookup</span> *coins* <span style=color:#e6db74>&#34;copper coin&#34;</span>)])))
</span></span></code></pre></div><p>(I added a new kind of item: <code>stackable</code>. Rather than replacing other items of a given type, they stack with them, combining quantities. Coins are currently the only stackable and at the moment, they&rsquo;re completely worthless. But it&rsquo;s a neat proof of concept. Check out the code <a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike>on GitHub</a> for more details.)</p><p>Okay. That&rsquo;s basically everything to actually generate the levels. But we still have two fairly big problems:</p><ul><li>How does this hook up to the code we already have?</li><li>How do we get to different levels?</li></ul><p>For the first problem, we need to tweak <code>world.rkt</code>. Essentially, we renamed the <code>get-tile</code> function as <code>tile-at</code> and just wrapped <code>get-tile</code> from <code>levels.rkt</code>. Likewise with <code>update</code> and <code>update-npcs</code>. It&rsquo;s pretty straight forward, check out the code <a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike>on GitHub</a> for more details.</p><p>The more interesting challenge is getting to different levels. The traditional way to do that in roguelikes is stairs. So we need a new tile type. But right now, we don&rsquo;t have a way to attach events to tiles. So we&rsquo;ll do both at once. Now, any tile can have an (optional) <code>on-enter</code> event, much like the <code>on-pickup</code> and <code>on-drop</code> events on items. Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; levels.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-thing</span> stairs-up tile
</span></span><span style=display:flex><span>  [character <span style=color:#e6db74>#\&lt;</span>]
</span></span><span style=display:flex><span>  [color <span style=color:#e6db74>&#34;gold&#34;</span>]
</span></span><span style=display:flex><span>  [walkable <span style=color:#66d9ef>#t</span>]
</span></span><span style=display:flex><span>  [(<span style=color:#a6e22e>on-enter</span> entity world)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>when</span> (eq? (<span style=color:#a6e22e>send</span> world get-player) entity)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>ascend</span>)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>hash-set!</span> (<span style=color:#a6e22e>get-level</span> (<span style=color:#a6e22e>current-depth</span>))
</span></span><span style=display:flex><span>                (<span style=color:#a6e22e>thing-get</span> (<span style=color:#a6e22e>send</span> world get-player) <span style=color:#e6db74>&#39;location</span>)
</span></span><span style=display:flex><span>                (<span style=color:#a6e22e>make-thing</span> stairs-up)))])
</span></span></code></pre></div><p><code>stairs-up</code> will be much the same. Essentially, when the player enters a tile (the <code>when</code> keeps those pesky rats from using the stairs for the time being), they will call <code>ascend</code> which just sets the <code>current-depth</code> variable we defined earlier to one higher, which is all we would need, since the next rendering step will call <code>get-tile</code> which in turn calls <code>get-level</code>. Since there is no level yet (unless we leave the level and come back), a new one will be generated. That&rsquo;s the beauty of the lazy tile generation setup we&rsquo;re using.</p><p>The final chunk is particularly amusing. Basically, when you code up the stairs, it will generate the matching stairs on the next level. This isn&rsquo;t perfect, since if you go back to a level you&rsquo;ve already been on, the stairs will appear from nowhere. For now, we&rsquo;ll consider this a &lsquo;feature&rsquo;. Hidden stairs. ðŸ˜„ Another problem is that there&rsquo;s nothing stopping the stairs from popping up in the middle of a wall. Since stairs on only triggered by entering them, that will be game over. Clearly sub-optmimal, but that&rsquo;s something we can save for later.</p><p>Speaking of which, how do we implement <code>on-enter</code>? Well, that&rsquo;s where the <code>try-move</code> function in <code>world.rkt</code> comes in. Find the one place where the player can move (where the target is <code>walkable</code> and not otherwise occupied) and add this code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; world.rkt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Look for an on-enter item</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>on-enter (<span style=color:#a6e22e>thing-get</span> tile <span style=color:#e6db74>&#39;on-enter</span> <span style=color:#66d9ef>#f</span>))
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>when</span> on-enter
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>on-enter</span> entity this))
</span></span></code></pre></div><p>And that&rsquo;s all we need. Bam, z-levels. And it should be really easy to add more level definitions with all sorts of varied properties. One of these weeks (soon probably), I should actually work on balancing and adding a bunch of new content. That will be the last step for making a full game. But really, we&rsquo;re basically there. All we really need still to have a game is more content and a way to win (It&rsquo;s perfectly possible to lose right now, but winning? Not so much).</p><p>Before we go, how about a few more screenshots with stairs and all?</p><figure><img src=/embeds/2013/1-all-peaceful.png></figure><p>Starting out, we&rsquo;re in a nice peaceful field. All we really have to do is find some stairs (or wander off into infinity (and beyond!)).</p><figure><img src=/embeds/2013/2-going-down.png></figure><p>Found some stairs. Down we go!</p><figure><img src=/embeds/2013/3-into-the-caves.png></figure><p>A nice little cavern. There are rats south and east and one of those nice new coins up north.</p><figure><img src=/embeds/2013/4-got-a-coin-killed-a-rat.png></figure><p>Here we&rsquo;ve grabbed the coin up north and killed the rat over by the potion. The coins have values based on the &ldquo;gold standard&rdquo; (1 gold = 10 silver = 100 copper, yay D&amp;D!), so it&rsquo;s really not much. But since they don&rsquo;t do anything anyways, it&rsquo;s as good as gold!</p><p>Let&rsquo;s try heading back up. Remember that other set of stairs? What happens if we take those?</p><figure><img src=/embeds/2013/5-up-down-wall.png></figure><p>Oops. Yeah, I really should fix that. Now I&rsquo;m in the middle of a wall and thus stuck. I really should add a way to manually trigger <code>on-enter</code> actions. We&rsquo;ll see how that goes.</p><p>Well, that&rsquo;s it for today. It&rsquo;s really starting to look like a game now. ðŸ˜„</p><p>As always, if you&rsquo;d like to see all of the code for this project, you can do so on GitHub:</p><ul><li><a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike/tree/day-6>Racket Roguelike - Day 6</a></li><li><a title="Racket Roguelike on GitHub" href=https://github.com/jpverkamp/racket-roguelike>Racket Roguelike - Up to date</a></li></ul><p>If you&rsquo;d like to try it yourself, you&rsquo;ll need to have both <a href=http://git-scm.com/>Git</a> and <a href=http://racket-lang.org/>Racket</a> and run the following series of commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-6
</span></span><span style=display:flex><span>git submodule init
</span></span><span style=display:flex><span>git submodule update
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p><strong>Edit:</strong></p><p>It seems that the submodules wondered off at some point. Instead, you can install the three libraries this uses directly using <code><a href="http://docs.racket-lang.org/search/index.html?q=pkg">pkg</a></code>
, and then run the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/ascii-canvas/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/noise/master
</span></span><span style=display:flex><span>raco pkg install github://github.com:jpverkamp/thing/master
</span></span><span style=display:flex><span>git clone git://github.com/jpverkamp/racket-roguelike.git
</span></span><span style=display:flex><span>cd racket-roguelike
</span></span><span style=display:flex><span>git checkout day-6
</span></span><span style=display:flex><span>racket main.rkt
</span></span></code></pre></div><p>(Note: Sorry I&rsquo;m a day late this week. Life&rsquo;s been crazy between conference deadlines and getting married. One of these days I&rsquo;ll actually actually write one of these posts ahead of time&mldr; Or not.)</p><p>For part 7, click here: <a href=https://blog.jverkamp.com/2013/05/17/racket-roguelike-7-into-darkness/>Racket Roguelike 7: Into Darkness!</a></p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
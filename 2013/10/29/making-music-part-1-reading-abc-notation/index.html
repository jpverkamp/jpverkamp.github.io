<!doctype html><html><head><title>Making music, part 1: Reading ABC notation â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="><link rel=stylesheet href=/main.min.2dfe13db7d2a586897d92d224a9dd8392b5abf84b4587e14bc4ede772802dc14.css integrity="sha256-Lf4T230qWGiX2S0iSp3YOStav4S0WH4UvE7edygC3BQ="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Making music, part 1: Reading ABC notation</h1><div class=entry-meta><span class=entry-date>2013-10-29</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/10/09/functions-as-lists/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/10/09/functions-as-lists/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a class=taxonomy-value href=/programming/topics/abc-notation>ABC Notation</a><a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/audio>Audio</a><a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/lexing>Lexing</a><a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/music>Music</a><a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/parsing>Parsing</a><a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/10/09/functions-as-lists/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/11/07/making-music-part-2-taking-shape/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/10/12/don-jon/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/11/03/gravity/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>It&rsquo;s been a bit since I&rsquo;ve had time to post<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, but I&rsquo;ve got an interesting new project that I&rsquo;ve been working on. It&rsquo;s a bit more complicated, ergo spread out over a few posts, but those tend to be the more interesting posts anyway, eh?</p><p>The basic idea is that I want to be able to write and play music in Racket. One end goal would be to make a library available for the C211 class to give them something else to work with (in addition to &lt;a href="//blog.jverkamp.com"/wombat-ide/c211-image-api/">images</a> and &lt;a href="//blog.jverkamp.com"/wombat-ide/c211-turtle-api/">turtles</a>). To that end, here&rsquo;s my current plan of attack<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p><ul><li>Write a <a href=https://en.wikipedia.org/wiki/Lexical%20analysis>lexer</a> for <a href=https://en.wikipedia.org/wiki/ABC%20notation>ABC notation</a> to turn raw text into a list of tokens</li><li>Write a parser to turn those tokens into a song (for example dealing with the interactions between key signature/accidentals and meter/note duration)</li><li>Use the <a href=http://pkg.racket-lang.org/#%5Brsound%5D>rsound</a> library on <a href=http://pkg.racket-lang.org/>Planet2 / pkg</a> to play back individuals notes and chords</li><li>Tie it all together to play a parsed song in ABC notation using the rsound library</li><li><em>(maybe)</em>: Use the rsound library to save ABC files as WAV audio</li><li><em>(maybe)</em>: Figure out the format and save ABC files as MIDI</li><li><em>(maybe)</em>: Render songs as music sheets/li></li></ul><p>Sounds like fun! Let&rsquo;s get started.</p><p>First, we need to build a lexer. I&rsquo;ve seen Racket&rsquo;s <code><a href="http://docs.racket-lang.org/search/index.html?q=parser-tools/lex">parser-tools/lex</a></code>
module before, but I&rsquo;ve never had the chance to try it out. No time like the present.</p><p>The format for creating a lexer looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>lexer</span> [trigger action-expr] <span style=color:#f92672>...</span>)
</span></span></code></pre></div><p>You have a series of trigger / action pairs. For each of the triggers, you have a regular expression written as s-expressions. One such extension that looks a lot like the standard regex patterns we all known and love is <code><a href="http://docs.racket-lang.org/search/index.html?q=parser-tools/lex-sre">parser-tools/lex-sre</a></code>
. With that you could write something like this to match simple mathematical expressions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>require</span> parser-tools/lex
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>prefix-in</span> : parser-tools/lex-sre))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>math-lexer
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>lexer</span> 
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>:+</span> numeric) (string-&gt;number lexeme)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\+</span> <span style=color:#e6db74>&#39;PLUS</span>]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\*</span> <span style=color:#e6db74>&#39;TIMES</span>]
</span></span><span style=display:flex><span>   [whitespace   (<span style=color:#a6e22e>math-lexer</span> input-port)]))
</span></span></code></pre></div><p>There are a few interesting things here:</p><ul><li>The <code>lex-sre</code> module is prefixed with <code>:</code>. Since it exports functions like <code>*</code> and <code>+</code>, this prevents conflicts with Racket&rsquo;s operators of the same name(s).</li><li>In the first line, we match one or more digits. Several character identifiers (such as <code>numeric</code> are pre-defined.</li><li>On that same line, we use on of the built in identifiers bound within the action parts: lexeme. This is the string that was matched by the trigger.</li><li>The next two lines are simple tokens. If you had more information you could use a &lsquo;heavier&rsquo; data structure (I&rsquo;ll be doing this later).</li><li>The last line matches against any whitespace character. We just want to ignore it, so we use another variable defined for us (input-port) to recursively call the lexer and move ahead.</li></ul><p>Once you have all of this, <code>math-lexer</code> is a function that takes a single parameter: an input port. It will then read off a single token. To make it read more than one, you need a fairly simple wrapper:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>lex</span> lexer in)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>for/list</span> ([token (<span style=color:#a6e22e>in-port</span> lexer in)]
</span></span><span style=display:flex><span>             <span style=color:#f92672>#</span>:break (eq? token <span style=color:#e6db74>&#39;eof</span>))
</span></span><span style=display:flex><span>    token))
</span></span></code></pre></div><p>This says to read until we get an <code>'eof</code> (provided by <code>lexer</code> by default), wrapping everything into a list. Here&rsquo;s it in action:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>call-with-input-string</span> <span style=color:#e6db74>&#34;8 + 7 * 6 + 5&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>curry</span> lex math-lexer))
</span></span><span style=display:flex><span><span style=color:#f92672>&#39;</span>(<span style=color:#ae81ff>8</span> PLUS <span style=color:#ae81ff>7</span> TIMES <span style=color:#ae81ff>6</span> PLUS <span style=color:#ae81ff>5</span>)
</span></span></code></pre></div><p>All <code>curry</code> does is provide the first argument (the lexer) and returning a function that takes only the input port (which <code>call-with-input-string</code>) expects. With this basic framework, we should be able to build some rather complicated constructs.</p><p>All right, let&rsquo;s get to ABC notation. For the next bit, I&rsquo;m just going to show each lexer pattern in turn with a short explanation between each. You can see the entire code <a href=https://github.com/jpverkamp/abc/>here</a> or just copy paste them into a lexer body (like the example above) to try them out yourself.</p><p>To see what we&rsquo;re dealing with, here&rsquo;s a sample ABC file for Greensleeves:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>X</span>:<span style=color:#a6e22e>0994</span>
</span></span><span style=display:flex><span><span style=color:#f92672>T</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;Green Sleeves&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>C</span>:<span style=color:#a6e22e>Unattributed</span>
</span></span><span style=display:flex><span><span style=color:#f92672>B</span>:<span style=color:#a6e22e>O</span><span style=color:#e6db74>&#39;Neill&#39;</span><span style=color:#f92672>s</span> <span style=color:#f92672>Music</span> <span style=color:#f92672>Of</span> <span style=color:#f92672>Ireland</span> <span style=color:#f92672>(</span><span style=color:#f92672>The</span> <span style=color:#f92672>1850</span><span style=color:#f92672>)</span> <span style=color:#f92672>Lyon</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>Healy</span><span style=color:#f92672>,</span> <span style=color:#f92672>Chicago</span><span style=color:#f92672>,</span> <span style=color:#f92672>1903</span> <span style=color:#f92672>edition</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Z</span>:<span style=color:#a6e22e>FROM</span> <span style=color:#f92672>O</span><span style=color:#e6db74>&#39;NEILL&#39;</span><span style=color:#f92672>S</span> <span style=color:#f92672>TO</span> <span style=color:#f92672>NOTEWORTHY</span><span style=color:#f92672>,</span> <span style=color:#f92672>FROM</span> <span style=color:#f92672>NOTEWORTHY</span> <span style=color:#f92672>TO</span> <span style=color:#f92672>ABC</span><span style=color:#f92672>,</span> <span style=color:#f92672>MIDI</span> <span style=color:#f92672>AND</span> .<span style=color:#a6e22e>TXT</span> <span style=color:#f92672>BY</span> <span style=color:#f92672>VINCE</span> <span style=color:#f92672>BRENNAN</span> <span style=color:#f92672>July</span> <span style=color:#f92672>2003</span> <span style=color:#f92672>(</span><span style=color:#f92672>HTTP</span><span style=color:#f92672>://</span><span style=color:#f92672>WWW</span>.<span style=color:#a6e22e>SOSYOURMOM</span>.<span style=color:#a6e22e>COM</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>I</span>:<span style=color:#a6e22e>abc2nwc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>M</span>:<span style=color:#a6e22e>6</span><span style=color:#f92672>/</span><span style=color:#f92672>8</span>
</span></span><span style=display:flex><span><span style=color:#f92672>L</span>:<span style=color:#a6e22e>1</span><span style=color:#f92672>/</span><span style=color:#f92672>8</span>
</span></span><span style=display:flex><span><span style=color:#f92672>K</span>:<span style=color:#a6e22e>C</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>A</span><span style=color:#f92672>/</span><span style=color:#f92672>2B</span><span style=color:#f92672>/</span><span style=color:#f92672>2</span><span style=color:#f92672>|</span><span style=color:#f92672>c2</span><span style=color:#f92672>)</span><span style=color:#f92672>c</span> <span style=color:#f92672>cde</span><span style=color:#f92672>|</span><span style=color:#f92672>dBG</span> <span style=color:#f92672>GAB</span><span style=color:#f92672>|</span><span style=color:#f92672>cBA</span> <span style=color:#f92672>ABc</span><span style=color:#f92672>|</span><span style=color:#f92672>BGE</span> <span style=color:#f92672>E2</span><span style=color:#f92672>(</span><span style=color:#f92672>A</span><span style=color:#f92672>/</span><span style=color:#f92672>2B</span><span style=color:#f92672>/</span><span style=color:#f92672>2</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>c2</span><span style=color:#f92672>)</span><span style=color:#f92672>c</span> <span style=color:#f92672>cde</span><span style=color:#f92672>|</span><span style=color:#f92672>dBG</span> <span style=color:#f92672>GAB</span><span style=color:#f92672>|</span><span style=color:#f92672>cBA</span> <span style=color:#f92672>GE</span><span style=color:#f92672>^</span><span style=color:#f92672>G</span><span style=color:#f92672>|</span><span style=color:#f92672>A3A2</span><span style=color:#f92672>:|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|:(</span><span style=color:#f92672>e</span><span style=color:#f92672>/</span><span style=color:#f92672>2</span><span style=color:#f92672>^</span><span style=color:#f92672>f</span><span style=color:#f92672>/</span><span style=color:#f92672>2</span><span style=color:#f92672>|</span><span style=color:#f92672>g</span><span style=color:#f92672>)</span><span style=color:#f92672>ag</span> <span style=color:#f92672>gfe</span><span style=color:#f92672>|</span><span style=color:#f92672>dBG</span> <span style=color:#f92672>GBd</span><span style=color:#f92672>|</span><span style=color:#f92672>aba</span> <span style=color:#f92672>aba</span><span style=color:#f92672>|</span><span style=color:#f92672>gee</span> <span style=color:#f92672>e2</span><span style=color:#f92672>(</span><span style=color:#f92672>e</span><span style=color:#f92672>/</span><span style=color:#f92672>2</span><span style=color:#f92672>^</span><span style=color:#f92672>f</span><span style=color:#f92672>/</span><span style=color:#f92672>2</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>g</span><span style=color:#f92672>)</span><span style=color:#f92672>ag</span> <span style=color:#f92672>gfe</span><span style=color:#f92672>|</span><span style=color:#f92672>dBG</span> <span style=color:#f92672>GAB</span><span style=color:#f92672>|</span><span style=color:#f92672>cBA</span> <span style=color:#f92672>GE</span><span style=color:#f92672>^</span><span style=color:#f92672>G</span><span style=color:#f92672>|</span><span style=color:#f92672>A3A2</span><span style=color:#f92672>:|</span>
</span></span></code></pre></div><p>The first thing to note is a series of character + colon + text lines at the beginning. These form the header section of the piece and include such information as the <em>T</em>title, <em>C</em>omposer, <em>M</em>eter (time signature), <em>K</em>ey, and default note <em>L</em>ength. For the moment, we&rsquo;re not going to try to parse the information we need out of these, just recognize them and wrap them up in a struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Header lines / inline headers</span>
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>:or</span> (<span style=color:#a6e22e>::</span> (<span style=color:#a6e22e>:/</span> <span style=color:#e6db74>&#34;AZ&#34;</span>) <span style=color:#e6db74>#\:</span> (<span style=color:#a6e22e>:*</span> whitespace) (<span style=color:#a6e22e>:*</span> (<span style=color:#a6e22e>:~</span> <span style=color:#e6db74>#\newline</span>)) (<span style=color:#a6e22e>:*</span> whitespace) (<span style=color:#a6e22e>:?</span> <span style=color:#e6db74>#\newline</span>))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>::</span> <span style=color:#e6db74>#\[</span> (<span style=color:#a6e22e>:/</span> <span style=color:#e6db74>&#34;AZ&#34;</span>) <span style=color:#e6db74>#\:</span> (<span style=color:#a6e22e>:*</span> whitespace) (<span style=color:#a6e22e>:*</span> (<span style=color:#a6e22e>:~</span> <span style=color:#e6db74>#\]</span>)) (<span style=color:#a6e22e>:*</span> whitespace) <span style=color:#e6db74>#\]</span>))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>token-header</span> lexeme)]
</span></span></code></pre></div><p>Originally I was pulling these apart here as well, but that&rsquo;s really the job of the parser, so I&rsquo;ll just go back to lexing them now. For that matter, I could have lexed the header keys and values differently, but I do think they should be treated as a single unit. As a side note, you might be wondering where <code>token-header</code> came from. It actually comes from the <code><a href="http://docs.racket-lang.org/search/index.html?q=define-tokens">define-tokens</a></code>
function in <code>parser-tools/lex</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>define-tokens</span> abc 
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>header</span> pitch duration text comment ending))
</span></span></code></pre></div><p>Each of these tokens will be a structure with a <code>token-id</code> (set by the name, so <code>header</code>, <code>pitch</code>, etc. and <code>token-value</code>. For these, I&rsquo;ll just be using the string values that we parse. We can make more sense of them later this week with the parser. In addition to these tokens, we also have a set of &rsquo;empty&rsquo; tokens&ndash;simpler tokens without any variation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>define-empty-tokens</span> abc-empty
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>tie</span>
</span></span><span style=display:flex><span>   chord-start chord-end
</span></span><span style=display:flex><span>   slur-start slur-end
</span></span><span style=display:flex><span>   grace-start grace-end
</span></span><span style=display:flex><span>   rest long-rest 
</span></span><span style=display:flex><span>   bar double-bar double-bar-start double-bar-end 
</span></span><span style=display:flex><span>   repeat-start repeat-end repeat-end-start
</span></span><span style=display:flex><span>   break linebreak))
</span></span></code></pre></div><p>So what does it look like to parse these headers?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (call-with-input-file <span style=color:#e6db74>&#34;greensleeves.abc&#34;</span> (<span style=color:#a6e22e>curry</span> lex abc-lexer))
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;header</span> <span style=color:#e6db74>&#34;X:0994\n&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;header</span> <span style=color:#e6db74>&#34;T:\&#34;Green Sleeves\&#34;\n&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;header</span> <span style=color:#e6db74>&#34;C:Unattributed\n&#34;</span>)
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>)
</span></span></code></pre></div><p>Looks sensible thus far.</p><p>As you may have noticed though, there were actually two options in the header definition. On continued for a whole line, the other was in square brackets. It turns out that the latter is for changing things like the meter or key signature within a song. I&rsquo;m sure there are other uses, but those again we can deal with as we parse various songs.</p><p>After the headers, the next target is notes. Notes are relatively straight forward and can have up to three parts: accidentals, pitch, and octave. The accidental is <code>^</code> or <code>^^</code> for sharps and double sharps and likewise <code>_</code> or <code>__</code> for flats. Naturals are <code>=</code>. The pitch is just a letter <code>a-g</code> or <code>A-G</code> (capital letters <code>C-B</code> start at middle C while lower case <code>c-b</code> are the octave below that. If you want more range, each <code>'</code> at the end will raise an octave and each <code>,</code> will lower it.</p><p>Here are a few example notes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>C = middle C
</span></span><span style=display:flex><span>^f = f sharp below middle C
</span></span><span style=display:flex><span>_b,, = b flat three octaves below middle C
</span></span><span style=display:flex><span>^^E<span style=color:#e6db74>&#39;,</span> = e double sharp (<span style=color:#a6e22e>so</span> f sharp) just above middle C, the comma <span style=color:#66d9ef>and </span>apostrophe cancel out
</span></span></code></pre></div><p>There are a lot of combinations that don&rsquo;t really make much sense, but then again there are a lot of &mldr; interesting &mldr; composers out there that use them. So we&rsquo;re better off safe than sorry. Here&rsquo;s how I&rsquo;m lexing these:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Pitches</span>
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>::</span> (<span style=color:#a6e22e>:?</span> (<span style=color:#a6e22e>:or</span> <span style=color:#e6db74>&#34;^^&#34;</span> <span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#e6db74>&#34;__&#34;</span> <span style=color:#e6db74>&#34;_&#34;</span> <span style=color:#e6db74>&#34;=&#34;</span>))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>:/</span> <span style=color:#e6db74>&#34;agAG&#34;</span>)
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>:*</span> (<span style=color:#a6e22e>:or</span> <span style=color:#e6db74>&#34;&#39;&#34;</span> <span style=color:#e6db74>&#34;,&#34;</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>token-pitch</span> lexeme)]
</span></span></code></pre></div><p>Straight forward enough. It will be interesting to parse these when we get that far, but it shouldn&rsquo;t be too hard. Especially because at that point we&rsquo;ll have context information so we can also take into account the keysignature.</p><p>After that, we&rsquo;re almost through the complicated cases. Next, we have timing information. Essentially, the <code>L</code>ength header sets the default length for notes, but a song made of a single length wouldn&rsquo;t be very interesting, now would it<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>? So after any pitch, we can have a length. This will consist essentially of any rational number (fraction):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Timing information</span>
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>:or</span> (<span style=color:#a6e22e>::</span> (<span style=color:#a6e22e>:+</span> numeric) (<span style=color:#a6e22e>:+</span> <span style=color:#e6db74>#\/</span>) (<span style=color:#a6e22e>:+</span> numeric))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>::</span> (<span style=color:#a6e22e>:+</span> <span style=color:#e6db74>#\/</span>) (<span style=color:#a6e22e>:+</span> numeric))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>:+</span> numeric)
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>:+</span> <span style=color:#e6db74>#\/</span>))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>token-duration</span> lexeme)]
</span></span></code></pre></div><p>Here there are several parts. You can write a full fraction like <code>1/2</code> to get a note half as long as the duration or you can write a whole number like <code>2</code> to get one twice as long. Alternatively, you can leave out the first number for a fraction, just so long as you want 1 over something (so <code>1/2</code> could be written as <code>/2</code>). Even better, if you want to just write a slash, it&rsquo;s equivalent to <code>1/2</code>. Two slashes is <code>1/4</code>.</p><p>With these, we should be able to lex note/duration pairs (I&rsquo;ll do the definition of the bar lines soon):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>call-with-input-string</span> <span style=color:#e6db74>&#34;A/2B/2|c2&#34;</span> (<span style=color:#a6e22e>curry</span> lex abc-lexer))
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;pitch</span> <span style=color:#e6db74>&#34;A&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;duration</span> <span style=color:#e6db74>&#34;/2&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;pitch</span> <span style=color:#e6db74>&#34;B&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;duration</span> <span style=color:#e6db74>&#34;/2&#34;</span>)
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;bar</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;pitch</span> <span style=color:#e6db74>&#34;c&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;duration</span> <span style=color:#e6db74>&#34;2&#34;</span>))
</span></span></code></pre></div><p>We&rsquo;ll put the pitch/duration pairs back together in the next step.</p><p>Now we&rsquo;ve got the hard stuff out of the way, most of what&rsquo;s left is single character or short strings. For example, we have bar lines. These are almost as simple as the above, but since each has it&rsquo;s own meaning we&rsquo;ll wrap them up in a structure. I may change this when I get to parsing if it&rsquo;s not working out, but it makes sense for the time being.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Bar lines</span>
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>&#34;||&#34;</span> (<span style=color:#a6e22e>token-double-bar</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>&#34;[|&#34;</span> (<span style=color:#a6e22e>token-double-bar-start</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>&#34;|]&#34;</span> (<span style=color:#a6e22e>token-double-bar-end</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>&#34;|:&#34;</span> (<span style=color:#a6e22e>token-repeat-start</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>&#34;:|&#34;</span> (<span style=color:#a6e22e>token-repeat-end</span>)]
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>:or</span> <span style=color:#e6db74>&#34;:|:&#34;</span> <span style=color:#e6db74>&#34;::&#34;</span>) (<span style=color:#a6e22e>token-repeat-end-start</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>&#34;|&#34;</span>  (<span style=color:#a6e22e>token-bar</span>)]
</span></span></code></pre></div><p>After that, we have chords, slurs, and grace notes in square bracket, parentheses, and curvy brackets respectively. Also dashes as ties and z (lower or capital) as various rests. Since none of these is associated with additional information, we&rsquo;ll just use straight forward symbols:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Simple tokens</span>
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\-</span> (<span style=color:#a6e22e>token-tie</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\[</span> (<span style=color:#a6e22e>token-chord-start</span>)] [<span style=color:#e6db74>#\]</span> (<span style=color:#a6e22e>token-chord-end</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\(</span> (<span style=color:#a6e22e>token-slur-start</span>)]  [<span style=color:#e6db74>#\)</span> (<span style=color:#a6e22e>token-slur-end</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\{</span> (<span style=color:#a6e22e>token-grace-start</span>)] [<span style=color:#e6db74>#\}</span> (<span style=color:#a6e22e>token-grace-end</span>)]
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\z</span> (<span style=color:#a6e22e>token-rest</span>)]        [<span style=color:#e6db74>#\Z</span> (<span style=color:#a6e22e>token-long-rest</span>)]
</span></span></code></pre></div><p>We&rsquo;re going to have to pair the various brackets at some point (read: in the parser), but this is all we need in a lexer.</p><p>Finally, we have notes or chord marks for a guitar which will be placed with the song when rendered but that we can mostly ignore. These are in the same format that double quoted strings are in just about every language, so they&rsquo;re pretty easy to parse:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Text / guitar chords</span>
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>::</span> <span style=color:#e6db74>#\&#34;</span> (<span style=color:#a6e22e>:*</span> (<span style=color:#a6e22e>:or</span> (<span style=color:#a6e22e>::</span> <span style=color:#e6db74>#\\</span> any-char) (<span style=color:#a6e22e>:~</span> <span style=color:#e6db74>#\&#34;</span>))) <span style=color:#e6db74>#\&#34;</span>)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>token-text</span> (<span style=color:#a6e22e>string-trim</span> lexeme <span style=color:#e6db74>&#34;\&#34;&#34;</span>))]
</span></span></code></pre></div><p>Next we have comments. ABC notation allows for line comments which have the same format as any other, using <code>%</code> as the comment character and running to the end of the line. The closing newline is optional since we may have a comment at the end of the file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Line comments</span>
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>::</span> <span style=color:#e6db74>#\%</span> (<span style=color:#a6e22e>:*</span> (<span style=color:#a6e22e>:~</span> <span style=color:#e6db74>#\newline</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>token-comment</span> lexeme)]
</span></span></code></pre></div><p>And finally whitespace. In the math example we could just ignore this. Here we could as well if we were just playing music, but it&rsquo;s possible that I may try to render the music as well (and then the breaks matter). So we&rsquo;ll leave it in the lexer and ignore it sometimes later. One caveat is that if there&rsquo;s a <code>\</code> at the end of a line, we should treat it as a normal break rather than a linebreak (for formatting purposes). That may be important later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Whitespace breaks notes sharing a bar (\ continues lines, so treat as a normal break)</span>
</span></span><span style=display:flex><span>   [(<span style=color:#a6e22e>:or</span> (<span style=color:#a6e22e>::</span> <span style=color:#e6db74>#\\</span> (<span style=color:#a6e22e>:*</span> whitespace))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>:+</span> whitespace))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>abc-lexer</span> input-port)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>; Newlines break lines in output as well (unless escaped with \, see above)</span>
</span></span><span style=display:flex><span>   [<span style=color:#e6db74>#\newline</span> (<span style=color:#a6e22e>token-linebreak</span>)]))
</span></span></code></pre></div><p>And that&rsquo;s all we need. This is enough to lex the Greensleeves example we had above:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (call-with-input-file <span style=color:#e6db74>&#34;greensleeves.abc&#34;</span> (<span style=color:#a6e22e>curry</span> lex abc-lexer))
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;header</span> <span style=color:#e6db74>&#34;X:0994\n&#34;</span>)
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;header</span> <span style=color:#e6db74>&#34;K:C\n&#34;</span>)
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;slur-start</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;pitch</span> <span style=color:#e6db74>&#34;A&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;duration</span> <span style=color:#e6db74>&#34;/2&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;pitch</span> <span style=color:#e6db74>&#34;B&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;duration</span> <span style=color:#e6db74>&#34;/2&#34;</span>)
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;bar</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;bar</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;pitch</span> <span style=color:#e6db74>&#34;A&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;duration</span> <span style=color:#e6db74>&#34;3&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;pitch</span> <span style=color:#e6db74>&#34;A&#34;</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>token</span> <span style=color:#e6db74>&#39;duration</span> <span style=color:#e6db74>&#34;2&#34;</span>)
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;repeat-end</span>)
</span></span></code></pre></div><p>Looks like something we can work with! Later this week (if all goes well), I&rsquo;ll work on a parser that can turn those notes and timings along with the headers into an actual sequence of notes to play.</p><p>As always, the entire code for this project is / will be available on GitHub: <a href=https://github.com/jpverkamp/abc/>jpverkamp / abc</a>. If you check it out between now and when I next post, you might even get a sneak peak at the parser<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>. ðŸ˜„</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Moving across the country will do that&mldr;&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Although it&rsquo;s been said &ldquo;no battle plan survives contact with the enemy&rdquo; &ndash; <a href=https://en.wikipedia.org/wiki/Helmuth%20von%20Moltke%20the%20Elder>Helmuth von Moltke</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Yes, I&rsquo;m sure there are many, many counter examples&mldr;&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Assuming of course that I don&rsquo;t write it the night before as I&rsquo;m wont to do&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!DOCTYPE html>
<html>
<head>
        
        

        <title>Sorting via splay heap | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/tomorrow-night.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://jpverkamp.github.io"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://jpverkamp.github.io/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://jpverkamp.github.io/category/archives/2004">2004</a></li><li><a href="http://jpverkamp.github.io/category/archives/2005">2005</a></li><li><a href="http://jpverkamp.github.io/category/archives/2006">2006</a></li><li><a href="http://jpverkamp.github.io/category/archives/2007">2007</a></li><li><a href="http://jpverkamp.github.io/category/archives/2008">2008</a></li><li><a href="http://jpverkamp.github.io/category/archives/2009">2009</a></li><li><a href="http://jpverkamp.github.io/category/archives/2010">2010</a></li><li><a href="http://jpverkamp.github.io/category/archives/2011">2011</a></li><li><a href="http://jpverkamp.github.io/category/archives/2012">2012</a></li><li><a href="http://jpverkamp.github.io/category/archives/2013">2013</a></li><li><a href="http://jpverkamp.github.io/category/archives/2014">2014</a></li></ul></li><li class="dropdown"><a href="http://jpverkamp.github.io/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://jpverkamp.github.io/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://jpverkamp.github.io/category/other/cooking">Cooking</a></li><li><a href="http://jpverkamp.github.io/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://jpverkamp.github.io/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://jpverkamp.github.io/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://jpverkamp.github.io/category/photography/photosets">Photosets</a></li><li><a href="http://jpverkamp.github.io/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://jpverkamp.github.io/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://jpverkamp.github.io/category/programming/by-language">By Language</a></li><li><a href="http://jpverkamp.github.io/category/programming/by-project">By Project</a></li><li><a href="http://jpverkamp.github.io/category/programming/by-source">By Source</a></li><li><a href="http://jpverkamp.github.io/category/programming/by-topic">By Topic</a></li><li><a href="http://jpverkamp.github.io/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://jpverkamp.github.io/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://jpverkamp.github.io/category/research/by-topic">By Topic</a></li><li><a href="http://jpverkamp.github.io/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://jpverkamp.github.io/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://jpverkamp.github.io/category/writing/by-genre">By Genre</a></li><li><a href="http://jpverkamp.github.io/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://jpverkamp.github.io/category/writing/novels">Novels</a></li><li><a href="http://jpverkamp.github.io/category/writing/other">Other</a></li><li><a href="http://jpverkamp.github.io/category/writing/short-stories">Short Stories</a></li></ul></li></ul>

      <!--
      <form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>
      </form>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Sorting via splay heap</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-01-23"><span class="year">2013</span> <span class="month">Jan</span> <span class="day">23</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://jpverkamp.github.io/category/programming/by-topic/data-structures">Data Structures</a></li><li><a href="http://jpverkamp.github.io/category/programming/by-source/programming-praxis">Programming Praxis</a></li><li><a href="http://jpverkamp.github.io/category/programming">Programming</a></li><li><a href="http://jpverkamp.github.io/category/programming/by-topic/algorithms/sorting">Sorting</a></li><li><a href="http://jpverkamp.github.io/category/programming/by-language/scheme">Scheme</a></li><li><a href="http://jpverkamp.github.io/category/programming/by-language/racket">Racket</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p><a href="http://programmingpraxis.com/2013/01/22/splay-heaps/" title="Splay Heap">Yesterday's post</a> from Programming Praxis gives a new (or at least different) vantage point on one of the most common problems in Computer Science: sorting. Today, we're going to implement a data structure known as a <a href="https://en.wikipedia.org/wiki/splay_heap">splay heap</a> and use that to perform a <a href="https://en.wikipedia.org/wiki/heapsort">heapsort</a>.</p>
<!--more-->
<p>This was actually pretty complicated to get working, mostly as there are so many details to get right that are a bit rough in a functional language. Generally, heaps are implemented using a mutable array, flipping values as necessary. But where's the fun in that?</p>
<p>If you'd like to follow along, you can download the full source <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap.rkt" title="Splay heap source on GitHub">here</a>. Essentially, there are three functions that we want to write: <code>insert</code>, <code>first</code>, and <code>rest</code>.</p>
<p>So how does it look?</p>
<p>Well, first we need a few structures. We're going to use a <code>node</code> structure for the tree and a <code>heap</code> structure to wrap it all up, including the comparator:</p>
<pre class="scheme"><code>; splay heap nodes
(define-struct node (value left right) #:transparent)

(define empty-node (node (void) #f #f))
(define (empty-node? node) (and (node? node) (void? (node-value node))))

; the entire heap, store comparator
(define-struct heap (root &lt;) #:transparent)</code></pre>
<p>Good to go. There's one unfortunate aspect in that we want to export <code>make-hash</code>, but we only want to specify the comparator. That's not too bad though, we can do that with <code>provide</code> and <code>rename-out</code>.</p>
<p>Next, we want to start with the hardest bit of code: inserting a new value into the heap.</p>
<p>To <code>insert</code>, the basic idea is to recursively partition the tree (in a manner similar to <a href="https://en.wikipedia.org/wiki/quicksort">quicksort</a>) into a subtree with items smaller than the new value and a subtree larger. The trick though is when you go left twice (towards the smallest nodes, which we want to access quickly) you want to rotate the tree to make that lookup quicker. This will give us an <a href="https://en.wikipedia.org/wiki/amortized_runtime">Amortized analysis</a> (the runtime over many repeated runs of the algorithm) of O(n log n), on the same order as the other best sorting algorithms (<a href="https://en.wikipedia.org/wiki/quicksort">quicksort</a> / <a href="https://en.wikipedia.org/wiki/mergesort">mergesort</a>).</p>
<pre class="scheme"><code>; insert a value into a splay heap
(define (insert heap pivot)
  (define &lt; (heap-&lt; heap))

  ; split a node into a tree of &lt; nodes and non &lt; nodes
  (define (partition node)
    (cond
      ; no values
      [(empty-node? node)
       (values empty-node empty-node)]
      ; new node will go left
      [(&lt; pivot (node-value node))
       (cond
         ; and there&#039;s nothing the other way
         [(empty-node? (node-left node))
          (values empty-node node)]
         ; right than right
         [(&lt; pivot (node-value (node-left node)))
          (define-values (left right)
            (partition (node-left (node-left node))))
          (values left
                  (make-node (node-value (node-left node))
                             right
                             (make-node (node-value node)
                                        (node-right (node-left node))
                                        (node-right node))))]
         ; right then left
         [else
          (define-values (left right)
            (partition (node-right (node-left node))))
          (values (make-node (node-value (node-left node))
                             (node-left (node-left node))
                             left)
                  (make-node (node-value node)
                             right
                             (node-right node)))])]
      ; new node will go right
      [else
       (cond
         ; and there&#039;s nothing there
         [(empty-node? (node-right node))
          (values node empty-node)]
         ; right than right
         [(&lt; pivot (node-value (node-right node)))
          (define-values (left right)
            (partition (node-left (node-right node))))
          (values (make-node (node-value node)
                             (node-left node)
                             left)
                  (make-node (node-value (node-right node))
                             right
                             (node-right (node-right node))))]
         ; right than left
         ; this is the rotation case
         [else
          (define-values (left right)
            (partition (node-right (node-right node))))
          (values (make-node (node-value (node-right node))
                             (make-node (node-value node)
                                        (node-left node)
                                        (node-left (node-right node)))
                             left)
                  right)])]))

  ; insert the node
  (define-values (left right)
    (partition (heap-root heap)))

  (make-heap (make-node pivot left right) &lt;))</code></pre>
<p>That's a fair bit of code, but hopefully it's commented well enough to follow. In the inner define (that actual <code>partition</code> function), we're returning two <code>value</code>s: a heap of smaller values and a heap of larger values. The most interesting case of that is the left than left case where the rotation I mentioned earlier takes place.</p>
<p>Moving on, we have the <code>first</code> and <code>rest</code> functions. We'll start with <code>first</code>. Since we know the heap (and each sub-heap by extension) has all smaller values down the left side, we just have to keep recurring left until we can't anymore. That will be the minimum value. And since we're not actually changing anything, the code is straight forward:</p>
<pre class="scheme"><code>; get the smallest node from the heap
(define (first heap)
  (let loop ([node (heap-root heap)])
    (cond
      [(empty-node? node)
       (error 'first "empty heap")]
      [(empty-node? (node-left node))
       (node-value node)]
      [else
       (loop (node-left node))])))</code></pre>
<p>Finally, what do we need to do to get everything but the minimum value?</p>
<pre class="scheme"><code>; get the heap without the smallest node
(define (rest heap)
  (make-heap
   (let loop ([node (heap-root heap)])
     (cond
       [(empty-node? node)
        (error 'rest "empty heap")]
       [(empty-node? (node-left node))
        (node-right node)]
       [(empty-node? (node-left (node-left node)))
        (make-node (node-value node)
                   (node-right (node-left node))
                   (node-right node))]
       ; left than left
       ; this is the rotation case
       [else
        (make-node (node-value (node-left node))
                   (loop (node-left (node-left node)))
                   (make-node (node-value node)
                              (node-right (node-left node))
                              (node-right node)))]))</code></pre>
<p>Now we need to test it to make sure everything is working. How else, but to write the actual <code>heapsort</code> code. Essentially, insert each item into a heap in turn, then pull each back out. Because of the <a href="https://en.wikipedia.org/wiki/amortized_runtime">Amortized analysis</a>, this should be fast.</p>
<pre class="scheme"><code>; sort using a heap
(define (heapsort ls &lt;)
  (let loop ([ls ls] [heap (make-heap empty-node &lt;)])
    (if (null? ls)
        (let loop ([heap heap])
          (if (empty? heap)
              &#039;()
              (cons (first heap) (loop (rest heap)))))
        (loop (cdr ls) (insert heap (car ls))))))</code></pre>
<p>And testing it out:</p>
<pre class="scheme"><code>; randomized testing
(require rackunit)
(for ([i (in-range 100)])
  (define ls (for/list ([i 20]) (random 100)))
  (check-equal? (heapsort ls &lt;) (sort ls &lt;)))</code></pre>
<p>Everything succeeds. You can easily test it with other comparison functions and random data sources, but there's no reason that it shouldn't work.</p>
<p>And there you have it. Personally, I'm not sure why you'd actually use such a data structure, particularly since other sorting algorithms are just as fast and easier to implement in a functional environment. But perhaps there is a case I just haven't seen yet.</p>
<p>If you'd like to download today's source code, you can do so here: - <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap.rkt" title="Splay heap source on GitHub">splay heap</a></p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Sorting via splay heap";
var disqus_url = "http://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://jpverkamp.github.io/2013/01/23/django-unchained">← Django Unchained</a></li><li><a href="http://jpverkamp.github.io/category/archives">Archives</a></li><li><a href="http://jpverkamp.github.io/2013/01/24/splay-heaps-redux-imperative-model">Splay heaps redux--imperative model →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://jpverkamp.github.io/2013/01/20/triangle-trilemma">← Triangle Trilemma</a></li><li><a href="http://jpverkamp.github.io/category/programming">Programming</a></li><li><a href="http://jpverkamp.github.io/2013/01/24/splay-heaps-redux-imperative-model">Splay heaps redux--imperative model →</a></li></ul></nav>

                <div class="legal">
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
        
        

        <title>Gregorian/Mayan conversion | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Gregorian/Mayan conversion</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-01-25"><span class="year">2013</span> <span class="month">Jan</span> <span class="day">25</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-source/daily-programmer">Daily Programmer</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>It may be 1 uinal, 15 kin too late for the new baktun, but I've got some neat code to convert back and forth between the <a href="https://en.wikipedia.org/wiki/Gregorian_calendar">Gregorian calendar</a> and the <a href="https://en.wikipedia.org/wiki/Mayan_calendar">Mayan calendar</a>. It's based on a challenge on a post on the <a title="Daily Programmer Challenge #117 [Intermediate] Mayan Long Count" href="http://www.reddit.com/r/dailyprogrammer/comments/16obmx/011613_challenge_117_intermediate_mayan_long_count/">/r/dailyprogrammer subreddit</a>. As one might expect, the goal is to be able to take a year, month, and day in the Gregorian calendar and return the equivalent Mayan Long Count corresponding to that date. As a bonus (which of course I had to do :)), do the opposite and do it without using built in date functions. <!--more--></p>
<p>To start out, we want a structure for each (if you'd like, you can follow along <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/mayan-conversion.rkt" title="Mayan conversion on GitHub">here</a>):</p>
<pre class="scheme"><code>; date structures
(define-struct gregorian (year month day) #:transparent)
(define-struct mayan (baktun katun tun uinal kin) #:transparent)</code></pre>
<p>Then, we'll need a few helpers. Particularly, we want a function that can calculate leap years and a list of days per month (ignoring any 29 day February for the time being).</p>
<pre class="scheme"><code>; test if a year is a leap year
(define (leap-year? year)
  (or (and (divisible? year 4)
           (not (divisible? year 100)))
      (divisible? year 400)))

; days per month
(define days/month '#(31 28 31 30 31 31 30 31 30 31 30 31))</code></pre>
<p>Now we're ready to go. Eventually, we want to write the functions <code>gregorian->mayan</code> and <code>mayan->gregorian</code>, but it would be a bit of a pain to convert directly. So instead, we'll convert via the number of days since 1 January 1970. That will give us the functions <code>gregorian->days</code>, <code>days->gregorian</code>, <code>mayan->days</code>, and <code>days->mayan</code>. The <code>gregorian</code> functions are a bit more complicated, so we'll start with those.</p>
<p>First, <code>gregorian->days</code>. It's a bit sneaky, but it's a closed form solution. Basically, we need to know if we're before or after 0-day and if we're before or after February (for the leap years). After that, it's mostly a matter of mathy goodness.</p>
<pre class="scheme"><code>; convert from gregorian to days since 1 jan 1970
(define (gregorian-&gt;days date)
  ; a date after 1 jan 1970?
  (define go-&gt; (&gt;= (gregorian-year date) 1970))

  ; are we after February?
  (define feb+ (&gt; (gregorian-month date) 2))

  ; range for leap years to test
  (define leap-range
    (list
     (if go-&gt; 1970 (+ (gregorian-year date) (if feb+ 0 1)))
     (if go-&gt; (+ (gregorian-year date) (if feb+ 1 0)) 1971)))

  (+ ; add year
     (* 365 (- (gregorian-year date) (if go-&gt; 1970 1969)))
     ; add month
     (* (if go-&gt; 1 -1)
        (apply + ((if go-&gt; take drop) days/month (- (gregorian-month date) 1))))
     ; add day
     (- (gregorian-day date) 1)
     ; deal with leap years
     (for/sum ([year (apply in-range leap-range)])
       (if (leap-year? year) (if go-&gt; 1 -1) 0))))</code></pre>
<p>The <code>for/sum</code> is the most potentially problematic point I think. I feel like there should be a non-looped solution to that, but this worked well enough (and it took long enough to get some of the other details working). In yet another tiny error that nevertheless took forever to track down, I originally had the second <code>(if feb+ ...)</code> the same as the first. Needless to say, that sent a few things sideways.</p>
<p>Next, we want to be able to invert that function. I couldn't work out a clean closed form for this one, so I just loop, first setting the year, then the month, then the day. It's a bit longer and I couldn't combine the forwards and backwards code, but it works well enough.</p>
<pre class="scheme"><code>; convert from days since 1 jan 1970 to gregorian date
(define (days-&gt;gregorian days)
  (cond
    ; work forward from 1 jan 1970
    [(&gt; days 0)
     (let loop ([days days] [year 1970] [month 1] [day 1])
       (define d/y (if (leap-year? year) 366 365))
       (define d/m (if (and (leap-year? year) (= month 2))
                       29
                       (list-ref days/month (- month 1))))
       (cond
         [(&gt;= days d/y)
          (loop (- days d/y) (+ year 1) month day)]
         [(&gt;= days d/m)
          (loop (- days d/m) year (+ month 1) day)]
         [else
          (make-gregorian year month (+ day days))]))]
    ; work backwards from 1 jan 1970
    [(&lt; days 0)
     (let loop ([days (- (abs days) 1)] [year 1969] [month 12] [day 31])
       (define d/y (if (leap-year? year) 366 365))
       (define d/m (if (and (leap-year? year) (= month 2))
                       29
                       (list-ref days/month (- month 1))))
       (cond
         [(&gt;= days d/y)
          (loop (- days d/y) (- year 1) month day)]
         [(&gt;= days d/m)
          (loop (- days d/m) year (- month 1) (list-ref days/month (- month 2)))]
         [else
          (make-gregorian year month (- d/m days))]))]
    ; that was easy
    [else
     (make-gregorian 1970 1 1)]))</code></pre>
<p>Now that the two hard functions are out of the way, we get the easy ones. <code>mayan->days</code> is almost trivial, just a matter of multiplying each value by the correct multiple. Likewise, <code>days->mayan</code> works by repeated division (with remainder). I'd never before used the <code>define-values</code> / <code>quotient/remainder</code> pattern before, but it works really well.</p>
<pre class="scheme"><code>; convert from mayan to days since 1 jan 1970
(define (mayan-&gt;days date)
  (+ -1856305
     (mayan-kin date)
     (* 20 (mayan-uinal date))
     (* 20 18 (mayan-tun date))
     (* 20 18 20 (mayan-katun date))
     (* 20 18 20 20 (mayan-baktun date))))

; convert from days since 1 jan 1970 to a mayan date
(define (days-&gt;mayan days)
  (define-values (baktun baktun-days) (quotient/remainder (+ days 1856305) (* 20 18 20 20)))
  (define-values (katun katun-days) (quotient/remainder baktun-days (* 20 18 20)))
  (define-values (tun tun-days) (quotient/remainder katun-days (* 20 18)))
  (define-values (uinal kin) (quotient/remainder tun-days 20))
  (make-mayan baktun katun tun uinal kin))</code></pre>
<p>After that, it's just a matter of wiring them together:</p>
<pre class="scheme"><code>; convert from gregorian to mayan
(define (gregorian-&gt;mayan date)
  (days-&gt;mayan (gregorian-&gt;days date)))

; convert from mayan to gregorian
(define (mayan-&gt;gregorian date)
  (days-&gt;gregorian (mayan-&gt;days date)))</code></pre>
<p>I love it when everything comes together like that. :)</p>
<p>Of course, we want to make sure to do some testing:</p>
<pre class="scheme"><code>; do some testing
(require rackunit)
(for ([test (in-list '((( 741  6 28)  -448705 ( 9 15 10  0  0))
                       ((1900  1  1)  -25567  (12 14  5  6 18))
                       ((1969  5 17)  -229    (12 17 15 13 16))
                       ((1970  1  1)   0      (12 17 16  7  5))
                       ((1970 10  1)   273    (12 17 17  2 18))
                       ((1987 10  1)   6482   (12 18 14  7  7))
                       ((1989  1 17)   6956   (12 18 15 13  1))
                       ((2012 12 21)   15695  (13  0  0  0  0))
                       ((2013  1 25)   15730  (13  0  0  1 15))))])

  (define g (apply make-gregorian (car test)))
  (define d (cadr test))
  (define m (apply make-mayan (caddr test)))

  (check-equal? (gregorian-&gt;days g) d)
  (check-equal? (days-&gt;gregorian d) g)
  (check-equal? (days-&gt;gregorian (gregorian-&gt;days g)) g)

  (check-equal? (mayan-&gt;days m) d)
  (check-equal? (days-&gt;mayan d) m)
  (check-equal? (days-&gt;mayan (mayan-&gt;days m)) m)

  (check-equal? (gregorian-&gt;mayan g) m)
  (check-equal? (mayan-&gt;gregorian m) g))</code></pre>
<p>Interestingly, it was 21 December 2012 that was the only case broken before I fixed the error in <code>days->gregorian</code>. So much for the end of the world...</p>
<p>This was actually a really neat program to work through. I'm glad that I stumbled across the <a title="Daily Programmer Challenge #117 [Intermediate] Mayan Long Count" href="http://www.reddit.com/r/dailyprogrammer/comments/16obmx/011613_challenge_117_intermediate_mayan_long_count/">Daily Programmer</a> challenges. With an easy problem each Monday, an intermediate one each Wednesday (like this one), and a hard one each Friday, there are more than enough interesting problems to keep me busy for quite a while.</p>
<p>As always, if you'd like to download the entire code, you can do so here: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/mayan-conversion.rkt" title="Mayan conversion on GitHub">Mayan conversion source</a></p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Gregorian/Mayan conversion";
var disqus_url = "http://blog.jverkamp.com/2013/01/25/gregorian-and-mayan-dates/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/01/24/splay-heaps-redux-imperative-model">← Splay heaps redux--imperative model</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2013/01/25/an-optimal-alphabetizing-cipher">An optimal alphabetizing cipher →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2013/01/24/splay-heaps-redux-imperative-model">← Splay heaps redux--imperative model</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2013/01/25/an-optimal-alphabetizing-cipher">An optimal alphabetizing cipher →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
<!doctype html><html><head><title>Splay heaps redux-imperative model â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.ef050764ff69f3287c89ff655825479dd8304dcd9bc653d1ddd4772a701ad445.js integrity="sha256-7wUHZP9p8yh8if9lWCVHndgwTc2bxlPR3dR3KnAa1EU=" defer></script><script src=/katex_17296078054267651618.min.deed0e78a77391517d530a00324ce7b760ac204134992ef22d36f583615ae498.js integrity="sha256-3u0OeKdzkVF9UwoAMkznt2CsIEE0mS7yLTb1g2Fa5Jg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.bfe50b47c0387e3c3bf97ec5f338bba94f7ccb02f962a4aec8cf0b4d68c8434d.js integrity="sha256-v+ULR8A4fjw7+X7F8zi7qU98ywL5YqSuyM8LTWjIQ00=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.64e42891d651aee0b8cd02ec9227ff271d37bcf06dae985d1acf0eba1623e850.css integrity="sha256-ZOQokdZRruC4zQLskif/Jx03vPBtrphdGs8OuhYj6FA="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.0d2b289fa3451447692959fcee5676b846532fe7ab50ddc4660824c42d4adcd7.css integrity="sha256-DSson6NFFEdpKVn87lZ2uEZTL+erUN3EZggkxC1K3Nc="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.67505d77381ebd82623ab9296c1989c44ec828d867c00296e80e52ef860cac37.css integrity="sha256-Z1BddzgevYJiOrkpbBmJxE7IKNhnwAKW6A5S74YMrDc="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.b60cba31b8c292392a2d336408f8f344e261df78516eb17bcf029173b24a42b5.css integrity="sha256-tgy6MbjCkjkqLTNkCPjzROJh33hRbrF7zwKRc7JKQrU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/home-automation/>Home Automation</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Splay heaps redux-imperative model</h1><div class=entry-meta><span class=entry-date>2013-01-24</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/programming-praxis>Programming Praxis</a><a href=https://blog.jverkamp.com/2013/02/06/the-147-puzzle/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2013/04/09/cyclic-equality/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/sorting>Sorting</a><a href=https://blog.jverkamp.com/2013/02/13/predecessor-and-successor-in-a-binary-search-tree/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>I did say in <a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/>yesterday&rsquo;s comments</a> that I would try re-implementing splay heaps using an imperative model with an array (Scheme&rsquo;s <code>vector</code>) as the back end rather than a functional one with trees. Well, here is is.</p><p>The first change is an obvious one. We need a new data structure (if you&rsquo;d like, you can follow along <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap-array.rkt title="Splay heap on GitHub">here</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; wrap a heap in a struct</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-struct</span> heap (<span style=color:#a6e22e>data</span> size &lt;) 
</span></span><span style=display:flex><span>  <span style=color:#f92672>#</span>:transparent
</span></span><span style=display:flex><span>  <span style=color:#f92672>#</span>:mutable)
</span></span></code></pre></div><p><code>data</code> is a vector which we&rsquo;ll occasionally have to rebuilt, <code>size</code> is the number of elements stored in the vector (not necessarily the size of the vector), and <code>&lt;</code> is the comparator. This time, we need to make sure that the structure is <code>mutable</code> so we get functions like <code>set-heap-data!</code> and friends.</p><p>The next thing we need is a helper function to grow the internal vector. Since Scheme vectors have a static size, each time we outgrow it we need to create a new larger vector and copy over the old values. Taking a page from the <a href=http://hg.openjdk.java.net/jdk6/jdk6-gate/jdk/file/b139627f7bc3/src/share/classes/java/util/PriorityQueue.java title="OpenJDK PriorityQueue">OpenJDK implementation of a PriorityQueue</a>, we will double the internal vector size each time up until we reach 64 and only grow by 150% after that. Here&rsquo;s the function for that.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; grow a heap</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; if it&#39;s small, double in size; otherwise 1.5x</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>grow!</span> heap)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>old-size (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>new-size (* old-size (<span style=color:#66d9ef>if </span>(&lt; old-size <span style=color:#ae81ff>64</span>) <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span>/2)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>set-heap-data!</span>
</span></span><span style=display:flex><span>   heap
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for/vector</span> ([i (<span style=color:#a6e22e>in-range</span> new-size)])
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>and </span>(&lt; i old-size)
</span></span><span style=display:flex><span>          (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) i)))))
</span></span></code></pre></div><p>Next, we&rsquo;d want to work on <code>push!</code> (which was previously <code>insert</code>), but before that, we need two more helper functions: <code>shift-up!</code> and <code>shift-down!</code>. The basic idea is that even if we&rsquo;re using a vector, it still has the structure of a tree. Instead of inexplicably storing the relationships though, we store the children at indices <em>2n+1</em> and <em>2n+2</em>. For example, this tree is equivalent to this array:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>   /   <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> / <span style=color:#960050;background-color:#1e0010>\</span>   /
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><table><thead><tr><th>0</th><th>1 = parent</th><th>2</th><th>3 = left</th><th>4 = right</th><th>5</th></tr></thead><tbody></tbody></table><p>To be a heap, we need the property that each value in the heap is less than either of its two children (recursively). So the example above is also a valid heap. <code>sift-up!</code> and <code>sift-down!</code> are how we will maintain that relationship when inserting or removing an element.</p><p>First, <code>sift-up!</code>. <code>sift-up!</code> will start at the bottom of the tree. In the example above, we would insert a new element where the 6 would be. We then repeatedly exchange the node with its parent until it&rsquo;s smaller. The rest of the heap does not need to be altered. Say we are adding the value -1 to the tree:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>   /   <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> / <span style=color:#960050;background-color:#1e0010>\</span>   / <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>-1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>   /   <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>    <span style=color:#ae81ff>-1</span>
</span></span><span style=display:flex><span> / <span style=color:#960050;background-color:#1e0010>\</span>   / <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>   <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>-1</span>
</span></span><span style=display:flex><span>   /   <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> / <span style=color:#960050;background-color:#1e0010>\</span>   / <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>   <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>In Racket terms, we have:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; re-sift the heap upwards</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>sift-up!</span> heap index value)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>parent (<span style=color:#a6e22e>arithmetic-shift</span> (+ <span style=color:#ae81ff>-1</span> index) <span style=color:#ae81ff>-1</span>))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; at the top, we have to stop here</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; or the parent is already smaller</span>
</span></span><span style=display:flex><span>    [(<span style=color:#66d9ef>or </span>(= index <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         (not ((<span style=color:#a6e22e>heap-&lt;</span> heap) value (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) parent))))
</span></span><span style=display:flex><span>     (vector-set! (<span style=color:#a6e22e>heap-data</span> heap) index value)]
</span></span><span style=display:flex><span>    <span style=color:#75715e>; otherwise sift, move the parent down and recur</span>
</span></span><span style=display:flex><span>    [else
</span></span><span style=display:flex><span>     (vector-set! (<span style=color:#a6e22e>heap-data</span> heap) 
</span></span><span style=display:flex><span>                  index 
</span></span><span style=display:flex><span>                  (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) parent))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>sift-up!</span> heap parent value)]))
</span></span></code></pre></div><p>There was actually a rather sneaky bug in this function that haunted me right up until the end. It only rarely manifested itself, but broke all sorts of things. Curses for off by one errors!</p><p>In any case, the next function is the inverse of <code>shift-up!</code>&ndash;<code>shift-down!</code>. This time, we start at the top of the tree and exchange with the smaller node that&rsquo;s still larger than the new value. Here&rsquo;s an example (using the actual algorithm for <code>pop!</code> where the root is replaced with the last value in the array):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>   /   <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> / <span style=color:#960050;background-color:#1e0010>\</span>   /
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>   /   <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> / <span style=color:#960050;background-color:#1e0010>\</span>   / 
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>There are a few sneakier parts of the algorithm, but I finally managed to work it all out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; re-sift the heap downwards</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>sift-down!</span> heap index value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>left (+ <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>arithmetic-shift</span> index <span style=color:#ae81ff>1</span>)))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>right (+ <span style=color:#ae81ff>1</span> left))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; we&#39;re out in the branches or smaller than children</span>
</span></span><span style=display:flex><span>    [(<span style=color:#66d9ef>and </span>(<span style=color:#66d9ef>or </span>(&gt;= left (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>              ((<span style=color:#a6e22e>heap-=</span> right (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>              ((<span style=color:#a6e22e>heap-=</span> right (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>              ((<span style=color:#a6e22e>heap-&lt;</span> heap) value (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) left)))
</span></span><span style=display:flex><span>         ((<span style=color:#a6e22e>heap-&lt;</span> heap) (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) left)
</span></span><span style=display:flex><span>                        (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) right)))
</span></span><span style=display:flex><span>     (vector-set! (<span style=color:#a6e22e>heap-data</span> heap)
</span></span><span style=display:flex><span>                  index
</span></span><span style=display:flex><span>                  (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) left))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>sift-down!</span> heap left value)]
</span></span><span style=display:flex><span>    <span style=color:#75715e>; otherwise, recur to the right</span>
</span></span><span style=display:flex><span>    [else
</span></span><span style=display:flex><span>     (vector-set! (<span style=color:#a6e22e>heap-data</span> heap)
</span></span><span style=display:flex><span>                  index
</span></span><span style=display:flex><span>                  (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) right))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>sift-down!</span> heap right value)]))
</span></span></code></pre></div><p>It&rsquo;s still not completely clean, but this is the most complicated function in the new version and I think it&rsquo;s still a bit easier to read than the functional version from yesterday. Perhaps that&rsquo;s just me though.</p><p>Now that we have both shifting functions, we can easily write <code>push!</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; insert an item into a heap</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>push!</span> heap value)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (= (<span style=color:#a6e22e>heap-size</span> heap) (vector-length (<span style=color:#a6e22e>heap-data</span> heap)))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>grow!</span> heap))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>size (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>set-heap-size!</span> heap (+ <span style=color:#ae81ff>1</span> size))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>if </span>(= <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>      (vector-set! (<span style=color:#a6e22e>heap-data</span> heap) <span style=color:#ae81ff>0</span> value)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>sift-up!</span> heap size value)))
</span></span></code></pre></div><p>It&rsquo;s a simple matter of growing the heap if necessary and shifting the element downwards from the top. That way we have the new item and the heap&rsquo;s properties are maintained.</p><p>Likewise, we have enough to write the inverse function <code>pop!</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; pop! the minimum element in a heap (and return it)</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>pop!</span> heap)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (= <span style=color:#ae81ff>0</span> (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>error</span> <span style=color:#e6db74>&#39;pop!</span> <span style=color:#e6db74>&#34;empty heap&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>result (<span style=color:#a6e22e>peek</span> heap))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>last (vector-ref (<span style=color:#a6e22e>heap-data</span> heap) (+ <span style=color:#ae81ff>-1</span> (<span style=color:#a6e22e>heap-size</span> heap))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>set-heap-size!</span> heap (+ <span style=color:#ae81ff>-1</span> (<span style=color:#a6e22e>heap-size</span> heap)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>unless</span> (zero? (<span style=color:#a6e22e>heap-size</span> heap))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>sift-down!</span> heap <span style=color:#ae81ff>0</span> last))
</span></span><span style=display:flex><span>  (vector-set! (<span style=color:#a6e22e>heap-data</span> heap) (<span style=color:#a6e22e>heap-size</span> heap) <span style=color:#66d9ef>#f</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  result)
</span></span></code></pre></div><p>Like I mentioned earlier, the algorithm is to pull off the smallest item. After that&rsquo;s been done, the last item in the array (the rightmost on the lowest layer of the tree) is put at the top and it gets sifted back downwards until the heap is fixed. Because nothing other than one path down the tree is modified either way, that means that both <code>push!</code> and <code>pop!</code> have O(log n) runtime.</p><p>And that&rsquo;s (almost) actually everything. The <code>heapsort</code> function has to be modified slightly in order to account for the functional algorithm, but that&rsquo;s an easy enough change:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; sort a list using a heap</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>heapsort</span> ls &lt;)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>heap (<span style=color:#a6e22e>new-heap</span> &lt;))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>loop ([ls ls])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>unless</span> (null? ls)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>push!</span> heap (car ls))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>loop</span> (cdr ls))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>if </span>(<span style=color:#a6e22e>empty?</span> heap)
</span></span><span style=display:flex><span>        &amp;<span style=color:#f92672>#</span><span style=color:#ae81ff>039</span><span style=color:#75715e>;()</span>
</span></span><span style=display:flex><span>        (cons (<span style=color:#a6e22e>pop!</span> heap) (<span style=color:#a6e22e>loop</span>)))))
</span></span></code></pre></div><p>Test it with the same code as last time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; randomized testing</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>require</span> rackunit)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>for</span> ([i (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>100</span>)])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>ls (<span style=color:#a6e22e>for/list</span> ([i <span style=color:#ae81ff>20</span>]) (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>100</span>)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>check-equal?</span> (<span style=color:#a6e22e>heapsort</span> ls &lt;) (<span style=color:#a6e22e>sort</span> ls &lt;)))
</span></span></code></pre></div><p>Everything works out well enough. It took a while to track down said earlier sneaky error (I thought it was in <code>shift-down!</code> but it was actually in <code>shift-up!</code>), but it was an interesting exercise to see how different it was.</p><p>If you&rsquo;d like to download today&rsquo;s code, you can do so here:</p><ul><li><a href=https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap-array.rkt title="Splay heap on GitHub">splay heap source</a></li></ul></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!DOCTYPE html>
<html>
<head>
    <title>
    Splay heaps redux-imperative model â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Splay heaps redux-imperative model</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2013-01-24</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a>
                        <a href="https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/sources/programming-praxis">Programming Praxis</a>
                        <a href="https://blog.jverkamp.com/2013/02/06/the-147-puzzle/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/data-structures">Data Structures</a>
                        <a href="https://blog.jverkamp.com/2013/04/09/cyclic-equality/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/sorting">Sorting</a>
                        <a href="https://blog.jverkamp.com/2013/02/13/predecessor-and-successor-in-a-binary-search-tree/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2013/01/25/gregorian/mayan-conversion/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>I did say in <a href="https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/">yesterday&rsquo;s comments</a> that I would try re-implementing splay heaps using an imperative model with an array (Scheme&rsquo;s <code>vector</code>) as the back end rather than a functional one with trees. Well, here is is.</p>

<p>The first change is an obvious one. We need a new data structure (if you&rsquo;d like, you can follow along <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap-array.rkt" title="Splay heap on GitHub">here</a>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; wrap a heap in a struct</span>
(define-struct heap (data size &lt;) 
  <span style="color:#f92672">#</span>:transparent
  <span style="color:#f92672">#</span>:mutable)</code></pre></div>
<p><code>data</code> is a vector which we&rsquo;ll occasionally have to rebuilt, <code>size</code> is the number of elements stored in the vector (not necessarily the size of the vector), and <code>&lt;</code> is the comparator. This time, we need to make sure that the structure is <code>mutable</code> so we get functions like <code>set-heap-data!</code> and friends.</p>

<p>The next thing we need is a helper function to grow the internal vector. Since Scheme vectors have a static size, each time we outgrow it we need to create a new larger vector and copy over the old values. Taking a page from the <a href="http://hg.openjdk.java.net/jdk6/jdk6-gate/jdk/file/b139627f7bc3/src/share/classes/java/util/PriorityQueue.java" title="OpenJDK PriorityQueue">OpenJDK implementation of a PriorityQueue</a>, we will double the internal vector size each time up until we reach 64 and only grow by 150% after that. Here&rsquo;s the function for that.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; grow a heap</span>
<span style="color:#75715e">; if it&#39;s small, double in size; otherwise 1.5x</span>
(<span style="color:#66d9ef">define </span>(grow! heap)
  (<span style="color:#66d9ef">define </span>old-size (heap-size heap))
  (<span style="color:#66d9ef">define </span>new-size (* old-size (<span style="color:#66d9ef">if </span>(&lt; old-size <span style="color:#ae81ff">64</span>) <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span>/2)))
  (set-heap-data!
   heap
   (for/vector ([i (in-range new-size)])
     (<span style="color:#66d9ef">and </span>(&lt; i old-size)
          (vector-ref (heap-data heap) i)))))</code></pre></div>
<p>Next, we&rsquo;d want to work on <code>push!</code> (which was previously <code>insert</code>), but before that, we need two more helper functions: <code>shift-up!</code> and <code>shift-down!</code>. The basic idea is that even if we&rsquo;re using a vector, it still has the structure of a tree. Instead of inexplicably storing the relationships though, we store the children at indices <em>2n+1</em> and <em>2n+2</em>. For example, this tree is equivalent to this array:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#ae81ff">0</span>
   /   <span style="color:#960050;background-color:#1e0010">\</span>
  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">2</span>
 / <span style="color:#960050;background-color:#1e0010">\</span>   /
<span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span></code></pre></div>
<table>
<thead>
<tr>
<th>0</th>
<th>1 = parent</th>
<th>2</th>
<th>3 = left</th>
<th>4 = right</th>
<th>5</th>
</tr>
</thead>

<tbody>
</tbody>
</table>

<p>To be a heap, we need the property that each value in the heap is less than either of its two children (recursively). So the example above is also a valid heap. <code>sift-up!</code> and <code>sift-down!</code> are how we will maintain that relationship when inserting or removing an element.</p>

<p>First, <code>sift-up!</code>. <code>sift-up!</code> will start at the bottom of the tree. In the example above, we would insert a new element where the 6 would be. We then repeatedly exchange the node with its parent until it&rsquo;s smaller. The rest of the heap does not need to be altered. Say we are adding the value -1 to the tree:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#ae81ff">0</span>
   /   <span style="color:#960050;background-color:#1e0010">\</span>
  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">2</span>
 / <span style="color:#960050;background-color:#1e0010">\</span>   / <span style="color:#960050;background-color:#1e0010">\</span>
<span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span>  <span style="color:#ae81ff">-1</span>

     <span style="color:#ae81ff">0</span>
   /   <span style="color:#960050;background-color:#1e0010">\</span>
  <span style="color:#ae81ff">1</span>    <span style="color:#ae81ff">-1</span>
 / <span style="color:#960050;background-color:#1e0010">\</span>   / <span style="color:#960050;background-color:#1e0010">\</span>
<span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">2</span>

    <span style="color:#ae81ff">-1</span>
   /   <span style="color:#960050;background-color:#1e0010">\</span>
  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">0</span>
 / <span style="color:#960050;background-color:#1e0010">\</span>   / <span style="color:#960050;background-color:#1e0010">\</span>
<span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">2</span></code></pre></div>
<p>In Racket terms, we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; re-sift the heap upwards</span>
(<span style="color:#66d9ef">define </span>(sift-up! heap index value)
  (<span style="color:#66d9ef">define </span>parent (arithmetic-shift (+ <span style="color:#ae81ff">-1</span> index) <span style="color:#ae81ff">-1</span>))
  (cond
    <span style="color:#75715e">; at the top, we have to stop here</span>
    <span style="color:#75715e">; or the parent is already smaller</span>
    [(<span style="color:#66d9ef">or </span>(= index <span style="color:#ae81ff">0</span>)
         (not ((heap-&lt; heap) value (vector-ref (heap-data heap) parent))))
     (vector-set! (heap-data heap) index value)]
    <span style="color:#75715e">; otherwise sift, move the parent down and recur</span>
    [else
     (vector-set! (heap-data heap) 
                  index 
                  (vector-ref (heap-data heap) parent))
     (sift-up! heap parent value)]))</code></pre></div>
<p>There was actually a rather sneaky bug in this function that haunted me right up until the end. It only rarely manifested itself, but broke all sorts of things. Curses for off by one errors!</p>

<p>In any case, the next function is the inverse of <code>shift-up!</code>&ndash;<code>shift-down!</code>. This time, we start at the top of the tree and exchange with the smaller node that&rsquo;s still larger than the new value. Here&rsquo;s an example (using the actual algorithm for <code>pop!</code> where the root is replaced with the last value in the array):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#ae81ff">2</span>
   /   <span style="color:#960050;background-color:#1e0010">\</span>
  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">0</span>
 / <span style="color:#960050;background-color:#1e0010">\</span>   /
<span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span> 

     <span style="color:#ae81ff">0</span>
   /   <span style="color:#960050;background-color:#1e0010">\</span>
  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">2</span>
 / <span style="color:#960050;background-color:#1e0010">\</span>   / 
<span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span></code></pre></div>
<p>There are a few sneakier parts of the algorithm, but I finally managed to work it all out:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; re-sift the heap downwards</span>
(<span style="color:#66d9ef">define </span>(sift-down! heap index value)

  (<span style="color:#66d9ef">define </span>left (+ <span style="color:#ae81ff">1</span> (arithmetic-shift index <span style="color:#ae81ff">1</span>)))
  (<span style="color:#66d9ef">define </span>right (+ <span style="color:#ae81ff">1</span> left))

  (cond
    <span style="color:#75715e">; we&#39;re out in the branches or smaller than children</span>
    [(<span style="color:#66d9ef">and </span>(<span style="color:#66d9ef">or </span>(&gt;= left (heap-size heap))
              ((heap-= right (heap-size heap))
              ((heap-= right (heap-size heap))
              ((heap-&lt; heap) value (vector-ref (heap-data heap) left)))
         ((heap-&lt; heap) (vector-ref (heap-data heap) left)
                        (vector-ref (heap-data heap) right)))
     (vector-set! (heap-data heap)
                  index
                  (vector-ref (heap-data heap) left))
     (sift-down! heap left value)]
    <span style="color:#75715e">; otherwise, recur to the right</span>
    [else
     (vector-set! (heap-data heap)
                  index
                  (vector-ref (heap-data heap) right))
     (sift-down! heap right value)]))</code></pre></div>
<p>It&rsquo;s still not completely clean, but this is the most complicated function in the new version and I think it&rsquo;s still a bit easier to read than the functional version from yesterday. Perhaps that&rsquo;s just me though.</p>

<p>Now that we have both shifting functions, we can easily write <code>push!</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; insert an item into a heap</span>
(<span style="color:#66d9ef">define </span>(push! heap value)
  (when (= (heap-size heap) (vector-length (heap-data heap)))
    (grow! heap))

  (<span style="color:#66d9ef">define </span>size (heap-size heap))
  (set-heap-size! heap (+ <span style="color:#ae81ff">1</span> size))

  (<span style="color:#66d9ef">if </span>(= <span style="color:#ae81ff">1</span> (heap-size heap))
      (vector-set! (heap-data heap) <span style="color:#ae81ff">0</span> value)
      (sift-up! heap size value)))</code></pre></div>
<p>It&rsquo;s a simple matter of growing the heap if necessary and shifting the element downwards from the top. That way we have the new item and the heap&rsquo;s properties are maintained.</p>

<p>Likewise, we have enough to write the inverse function <code>pop!</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; pop! the minimum element in a heap (and return it)</span>
(<span style="color:#66d9ef">define </span>(pop! heap)
  (when (= <span style="color:#ae81ff">0</span> (heap-size heap))
    (error <span style="color:#e6db74">&#39;pop!</span> <span style="color:#e6db74">&#34;empty heap&#34;</span>))

  (<span style="color:#66d9ef">define </span>result (peek heap))
  (<span style="color:#66d9ef">define </span>last (vector-ref (heap-data heap) (+ <span style="color:#ae81ff">-1</span> (heap-size heap))))

  (set-heap-size! heap (+ <span style="color:#ae81ff">-1</span> (heap-size heap)))
  (unless (zero? (heap-size heap))
    (sift-down! heap <span style="color:#ae81ff">0</span> last))
  (vector-set! (heap-data heap) (heap-size heap) <span style="color:#66d9ef">#f</span>)

  result)</code></pre></div>
<p>Like I mentioned earlier, the algorithm is to pull off the smallest item. After that&rsquo;s been done, the last item in the array (the rightmost on the lowest layer of the tree) is put at the top and it gets sifted back downwards until the heap is fixed. Because nothing other than one path down the tree is modified either way, that means that both <code>push!</code> and <code>pop!</code> have O(log n) runtime.</p>

<p>And that&rsquo;s (almost) actually everything. The <code>heapsort</code> function has to be modified slightly in order to account for the functional algorithm, but that&rsquo;s an easy enough change:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; sort a list using a heap</span>
(<span style="color:#66d9ef">define </span>(heapsort ls &lt;)
  (<span style="color:#66d9ef">define </span>heap (new-heap &lt;))

  (<span style="color:#66d9ef">let </span>loop ([ls ls])
    (unless (null? ls)
      (push! heap (car ls))
      (loop (cdr ls))))

  (<span style="color:#66d9ef">let </span>loop ()
    (<span style="color:#66d9ef">if </span>(empty? heap)
        &amp;<span style="color:#f92672">#</span><span style="color:#ae81ff">039</span><span style="color:#75715e">;()</span>
        (cons (pop! heap) (loop)))))</code></pre></div>
<p>Test it with the same code as last time:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; randomized testing</span>
(require rackunit)
(for ([i (in-range <span style="color:#ae81ff">100</span>)])
  (<span style="color:#66d9ef">define </span>ls (for/list ([i <span style="color:#ae81ff">20</span>]) (random <span style="color:#ae81ff">100</span>)))
  (check-equal? (heapsort ls &lt;) (sort ls &lt;)))</code></pre></div>
<p>Everything works out well enough. It took a while to track down said earlier sneaky error (I thought it was in <code>shift-down!</code> but it was actually in <code>shift-up!</code>), but it was an interesting exercise to see how different it was.</p>

<p>If you&rsquo;d like to download today&rsquo;s code, you can do so here:
- <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap-array.rkt" title="Splay heap on GitHub">splay heap source</a></p>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Splay heaps redux-imperative model";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2013\/01\/24\/splay-heaps-redux-imperative-model\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

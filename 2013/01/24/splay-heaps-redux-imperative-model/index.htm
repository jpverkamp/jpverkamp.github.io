<!DOCTYPE html>
<html>
<head>
        
        

        <title>Splay heaps redux--imperative model | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" defer></script>
        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js" defer></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" defer />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" defer />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" defer></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" defer />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js" defer></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js" defer></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" defer />
        <script src="/highlight/highlight.pack.js" defer></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" defer />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js" defer ></script>

        <!-- Pretty pretty fonts -->
        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Calligraffitti" defer />

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" defer />
        <script src="/custom.js" defer></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="//blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="//blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="//blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="//blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="//blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="//blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="//blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="//blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="//blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="//blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="//blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="//blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="//blog.jverkamp.com/category/archives/2015">2015</a></li><li><a href="//blog.jverkamp.com/category/archives/2016">2016</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="//blog.jverkamp.com/category/other/book-reviews">Book Reviews</a></li><li><a href="//blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="//blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="//blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="//blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="//blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="//blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="//blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="//blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="//blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="//blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="//blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="//blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="//blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="//blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="//blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="//blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="//blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="//www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Splay heaps redux--imperative model</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2013-01-24"><span class="year">2013</span> <span class="month">Jan</span> <span class="day">24</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="//blog.jverkamp.com/category/programming/by-topic/data-structures">Data Structures</a></li><li><a href="//blog.jverkamp.com/category/programming">Programming</a></li><li><a href="//blog.jverkamp.com/category/programming/by-source/programming-praxis">Programming Praxis</a></li><li><a href="//blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="//blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li><li><a href="//blog.jverkamp.com/category/programming/by-topic/algorithms/sorting">Sorting</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>I did say in <a href="//blog.jverkamp.com/2013/01/23/sorting-via-splay-heap">yesterday's comments</a> that I would try re-implementing splay heaps using an imperative model with an array (Scheme's <code>vector</code>) as the back end rather than a functional one with trees. Well, here is is.</p>
<!--more-->
<p>The first change is an obvious one. We need a new data structure (if you'd like, you can follow along <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap-array.rkt" title="Splay heap on GitHub">here</a>):</p>
<pre class="scheme"><code>; wrap a heap in a struct
(define-struct heap (data size &lt;)
  #:transparent
  #:mutable)</code></pre>
<p><code>data</code> is a vector which we'll occasionally have to rebuilt, <code>size</code> is the number of elements stored in the vector (not necessarily the size of the vector), and <code><</code> is the comparator. This time, we need to make sure that the structure is <code>mutable</code> so we get functions like <code>set-heap-data!</code> and friends.</p>
<p>The next thing we need is a helper function to grow the internal vector. Since Scheme vectors have a static size, each time we outgrow it we need to create a new larger vector and copy over the old values. Taking a page from the <a href="http://hg.openjdk.java.net/jdk6/jdk6-gate/jdk/file/b139627f7bc3/src/share/classes/java/util/PriorityQueue.java" title="OpenJDK PriorityQueue">OpenJDK implementation of a PriorityQueue</a>, we will double the internal vector size each time up until we reach 64 and only grow by 150% after that. Here's the function for that.</p>
<pre class="scheme"><code>; grow a heap
; if it's small, double in size; otherwise 1.5x
(define (grow! heap)
  (define old-size (heap-size heap))
  (define new-size (* old-size (if (&lt; old-size 64) 2 3/2)))
  (set-heap-data!
   heap
   (for/vector ([i (in-range new-size)])
     (and (&lt; i old-size)
          (vector-ref (heap-data heap) i)))))</code></pre>
<p>Next, we'd want to work on <code>push!</code> (which was previously <code>insert</code>), but before that, we need two more helper functions: <code>shift-up!</code> and <code>shift-down!</code>. The basic idea is that even if we're using a vector, it still has the structure of a tree. Instead of inexplicably storing the relationships though, we store the children at indices <em>2n+1</em> and <em>2n+2</em>. For example, this tree is equivalent to this array:</p>
<pre class="scheme"><code>     0
   /   \
  1     2
 / \   /
3   4 5</code></pre>
<table class="table table-striped">
<tr>
<td>0</td>
<td>1 = parent</td>
<td>2</td>
<td>3 = left</td>
<td>4 = right</td>
<td>5</td>
</tr>
</table>
<p>To be a heap, we need the property that each value in the heap is less than either of its two children (recursively). So the example above is also a valid heap. <code>sift-up!</code> and <code>sift-down!</code> are how we will maintain that relationship when inserting or removing an element.</p>
<p>First, <code>sift-up!</code>. <code>sift-up!</code> will start at the bottom of the tree. In the example above, we would insert a new element where the 6 would be. We then repeatedly exchange the node with its parent until it's smaller. The rest of the heap does not need to be altered. Say we are adding the value -1 to the tree:</p>
<pre class="scheme"><code>     0
   /   \
  1     2
 / \   / \
3   4 5  -1

     0
   /   \
  1    -1
 / \   / \
3   4 5   2

    -1
   /   \
  1     0
 / \   / \
3   4 5   2</code></pre>
<p>In Racket terms, we have:</p>
<pre class="scheme"><code>; re-sift the heap upwards
(define (sift-up! heap index value)
  (define parent (arithmetic-shift (+ -1 index) -1))
  (cond
    ; at the top, we have to stop here
    ; or the parent is already smaller
    [(or (= index 0)
         (not ((heap-&lt; heap) value (vector-ref (heap-data heap) parent))))
     (vector-set! (heap-data heap) index value)]
    ; otherwise sift, move the parent down and recur
    [else
     (vector-set! (heap-data heap)
                  index
                  (vector-ref (heap-data heap) parent))
     (sift-up! heap parent value)]))</code></pre>
<p>There was actually a rather sneaky bug in this function that haunted me right up until the end. It only rarely manifested itself, but broke all sorts of things. Curses for off by one errors!</p>
<p>In any case, the next function is the inverse of <code>shift-up!</code>--<code>shift-down!</code>. This time, we start at the top of the tree and exchange with the smaller node that's still larger than the new value. Here's an example (using the actual algorithm for <code>pop!</code> where the root is replaced with the last value in the array):</p>
<pre class="scheme"><code>     2
   /   \
  1     0
 / \   /
3   4 5

     0
   /   \
  1     2
 / \   /
3   4 5</code></pre>
<p>There are a few sneakier parts of the algorithm, but I finally managed to work it all out:</p>
<pre class="scheme"><code>; re-sift the heap downwards
(define (sift-down! heap index value)

  (define left (+ 1 (arithmetic-shift index 1)))
  (define right (+ 1 left))

  (cond
    ; we're out in the branches or smaller than children
    [(and (or (&gt;= left (heap-size heap))
              ((heap-= right (heap-size heap))
              ((heap-= right (heap-size heap))
              ((heap-&lt; heap) value (vector-ref (heap-data heap) left)))
         ((heap-&lt; heap) (vector-ref (heap-data heap) left)
                        (vector-ref (heap-data heap) right)))
     (vector-set! (heap-data heap)
                  index
                  (vector-ref (heap-data heap) left))
     (sift-down! heap left value)]
    ; otherwise, recur to the right
    [else
     (vector-set! (heap-data heap)
                  index
                  (vector-ref (heap-data heap) right))
     (sift-down! heap right value)]))</code></pre>
<p>It's still not completely clean, but this is the most complicated function in the new version and I think it's still a bit easier to read than the functional version from yesterday. Perhaps that's just me though.</p>
<p>Now that we have both shifting functions, we can easily write <code>push!</code>:</p>
<pre class="scheme"><code>; insert an item into a heap
(define (push! heap value)
  (when (= (heap-size heap) (vector-length (heap-data heap)))
    (grow! heap))

  (define size (heap-size heap))
  (set-heap-size! heap (+ 1 size))

  (if (= 1 (heap-size heap))
      (vector-set! (heap-data heap) 0 value)
      (sift-up! heap size value)))</code></pre>
<p>It's a simple matter of growing the heap if necessary and shifting the element downwards from the top. That way we have the new item and the heap's properties are maintained.</p>
<p>Likewise, we have enough to write the inverse function <code>pop!</code>:</p>
<pre class="scheme"><code>; pop! the minimum element in a heap (and return it)
(define (pop! heap)
  (when (= 0 (heap-size heap))
    (error 'pop! "empty heap"))

  (define result (peek heap))
  (define last (vector-ref (heap-data heap) (+ -1 (heap-size heap))))

  (set-heap-size! heap (+ -1 (heap-size heap)))
  (unless (zero? (heap-size heap))
    (sift-down! heap 0 last))
  (vector-set! (heap-data heap) (heap-size heap) #f)

  result)</code></pre>
<p>Like I mentioned earlier, the algorithm is to pull off the smallest item. After that's been done, the last item in the array (the rightmost on the lowest layer of the tree) is put at the top and it gets sifted back downwards until the heap is fixed. Because nothing other than one path down the tree is modified either way, that means that both <code>push!</code> and <code>pop!</code> have O(log n) runtime.</p>
<p>And that's (almost) actually everything. The <code>heapsort</code> function has to be modified slightly in order to account for the functional algorithm, but that's an easy enough change:</p>
<pre class="scheme"><code>; sort a list using a heap
(define (heapsort ls &lt;)
  (define heap (new-heap &lt;))

  (let loop ([ls ls])
    (unless (null? ls)
      (push! heap (car ls))
      (loop (cdr ls))))

  (let loop ()
    (if (empty? heap)
        &#039;()
        (cons (pop! heap) (loop)))))</code></pre>
<p>Test it with the same code as last time:</p>
<pre class="scheme"><code>; randomized testing
(require rackunit)
(for ([i (in-range 100)])
  (define ls (for/list ([i 20]) (random 100)))
  (check-equal? (heapsort ls &lt;) (sort ls &lt;)))</code></pre>
<p>Everything works out well enough. It took a while to track down said earlier sneaky error (I thought it was in <code>shift-down!</code> but it was actually in <code>shift-up!</code>), but it was an interesting exercise to see how different it was.</p>
<p>If you'd like to download today's code, you can do so here: - <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/splay-heap-array.rkt" title="Splay heap on GitHub">splay heap source</a></p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Splay heaps redux--imperative model";
var disqus_url = "http://blog.jverkamp.com/2013/01/24/splay-heaps-redux-imperative-model/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="//blog.jverkamp.com/2013/01/23/sorting-via-splay-heap">← Sorting via splay heap</a></li><li><a href="//blog.jverkamp.com/category/archives">Archives</a></li><li><a href="//blog.jverkamp.com/2013/01/25/gregorian-and-mayan-dates">Gregorian/Mayan conversion →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="//blog.jverkamp.com/2013/01/23/sorting-via-splay-heap">← Sorting via splay heap</a></li><li><a href="//blog.jverkamp.com/category/programming">Programming</a></li><li><a href="//blog.jverkamp.com/2013/01/25/gregorian-and-mayan-dates">Gregorian/Mayan conversion →</a></li></ul></nav>

                <div class="legal">
                        <a href="//blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="//blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.defer=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
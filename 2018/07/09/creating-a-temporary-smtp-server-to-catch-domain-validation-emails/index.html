<!doctype html><html><head><title>Creating a temporary SMTP server to 'catch' domain validation emails â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet><link rel=stylesheet href=/custom.css defer><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Creating a temporary SMTP server to 'catch' domain validation emails</h1><div class=entry-meta><span class=entry-date>2018-07-09</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2015/04/01/parsing-aws-instance-data-with-jq/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/bash>Bash</a><a href=https://blog.jverkamp.com/2019/04/27/tiny-helper-scripts-for-command-line-mysql/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2018/03/12/generating-zone-files-from-route53/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2018/03/12/generating-zone-files-from-route53/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/dns>DNS</a><a href=https://blog.jverkamp.com/2020/06/30/ssrf-protection-in-rails/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2016/01/02/inlining-plaintext-attachments-in-gmail/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/email>Email</a><a href=https://blog.jverkamp.com/2020/06/10/observation-server/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/smtp>SMTP</a><a href=https://blog.jverkamp.com/2020/06/10/observation-server/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2018/04/01/deep-dreams-with-fish-and-docker/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2018/07/02/the-blood-mirror/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/07/11/the-fires-of-heaven/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>One problem that has come up a time or two is dealing with email-based domain validation (specifically in this case for the issuance of TLS certificates) on domains that aren&rsquo;t actually configured to receive email. Yes, in a perfect world, it would be easier to switch to DNS-based validation (since we have to have control of the DNS for the domain, we need it later), but let&rsquo;s just assume that&rsquo;s not an option. So, how do we &lsquo;catch&rsquo; the activation email so we can prove we can receive email on that domain?</p><p>Basic plan of attack:</p><ul><li>Set up or otherwise have a server with a public IP that we can run python on</li><li>Run Python&rsquo;s built in SMTP server to catch emails</li><li>Change DNS so that emails sent to the given domain will go to that server</li><li>Capture the activation email, use the link to validate our domain</li></ul><h1 id=set-up-a-server-with-a-public-ip>Set up a server with a public IP</h1><p>I&rsquo;m going to skip over this case, since it depends on your specific setup. In our case, we&rsquo;re based in AWS, so I just requested a new <code>t2.nano</code> in a public part of our VPC.</p><h1 id=run-pythons-built-in-smtp-server-to-catch-emails>Run Python&rsquo;s built in SMTP server to catch emails</h1><p>For this part, we could instead have run something more heavyweight&ndash;a full SMTP server. But that&rsquo;s exactly what I&rsquo;m trying to avoid. I&rsquo;ve had to configure those before, it&rsquo;s not the hardest thing I&rsquo;ve ever done, but there are more than enough fiddly bits that I don&rsquo;t want to mess with them. Especially when running the debug server is so easy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo python -m smtpd -n -c DebuggingServer 0.0.0.0:25
</span></span></code></pre></div><p>Since we&rsquo;re binding to port 25 (the standard SMTP port), we do need <code>sudo</code> (or to otherwise have root permissions). In theory, we could route a different port at a different level, but for that you&rsquo;d need to have elevated permissions in AWS (or whatever system you&rsquo;re using), so somewhere you&rsquo;re going to just have to assume you have elevated permissions.</p><p>And that&rsquo;s it. You now have a working SMTP server.</p><h1 id=optional-test-that-the-smtp-server-is-working>[optional] Test that the SMTP server is working</h1><p>You can test it with TELNET in another prompt (on another machine):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ telnet <span style=color:#f92672>{</span>ip<span style=color:#f92672>}</span> <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; MAIL FROM:<span style=color:#f92672>{</span>your email address, does not actually matter<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>&lt; <span style=color:#ae81ff>250</span> Ok
</span></span><span style=display:flex><span>&gt; RCPT TO:webmaster@<span style=color:#f92672>{</span>domain<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>&lt; <span style=color:#ae81ff>250</span> Ok
</span></span><span style=display:flex><span>&gt; DATA
</span></span><span style=display:flex><span>&gt; Hello world
</span></span><span style=display:flex><span>&gt; .
</span></span><span style=display:flex><span>&lt; <span style=color:#ae81ff>250</span> Ok
</span></span></code></pre></div><p>If you go back to the still open terminal running the debug SMTP server, you should see the message you just sent in the console:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>---------- MESSAGE FOLLOWS ----------
</span></span><span style=display:flex><span>Hello world
</span></span><span style=display:flex><span>------------ END MESSAGE ------------
</span></span></code></pre></div><p>One downside, it only writes to standard out. If you want to assume you&rsquo;ll only get a few messages (the activation emails), this is fine. But if you manage to get any spam (and eventually you will), it might be more handy to send the output to a file as well. Normally, you could just use <code>tee</code>, but it seems that this particular library buffers output fairly agressively. No problem. <code>stdbuf</code> to the rescue!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo stdbuf -oL python -m smtpd -n -c DebuggingServer 0.0.0.0:25 | tee mail.log
</span></span></code></pre></div><h1 id=updatecreate-dns-records>Update/create DNS records</h1><p>Now that we have the new SMTP server, we have to tell the world that it can receive email on behalf of our domain. To do that, we need to create a pair of DNS records:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>MX {domain} 10 smtp.{domain}
</span></span><span style=display:flex><span>A smtp.{domain} {ip}
</span></span></code></pre></div><p>&lsquo;Why can&rsquo;t you just put the IP address directly in the <code>MX</code> record?&rsquo; you might say. Well, it turns out that the powers that be that set up DNS decided that MX records should resolve to a name and be independent of IPs directly. So they&rsquo;re almost always paired with an <code>A</code> or <code>CNAME</code> (and then an <code>A</code>) record.</p><h1 id=optional-verify-that-the-dns-is-set-up-correctly>[optional] Verify that the DNS is set up correctly</h1><p>In order to make sure that the DNS changes are propagating correctly, you can test at the command line with <code>dig</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dig <span style=color:#f92672>{</span>domain<span style=color:#f92672>}</span> MX +short
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span> smtp.<span style=color:#f92672>{</span>domain<span style=color:#f92672>}</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ dig smtp.<span style=color:#f92672>{</span>domain<span style=color:#f92672>}</span> +short
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>IP<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>If you&rsquo;re really thorough, you could also <code>telnet</code> again here, this time to the new domain name <code>smtp.{domain}</code> or even send a test email using your everyday email client. Couldn&rsquo;t hurt. Everything is set up so that could work now.</p><h1 id=catch-the-validation-email>Catch the validation email</h1><p>Now that email is set up, all that&rsquo;s left is to tell whatever system you&rsquo;re trying to validate your domain to that they should (re)send validation email. It&rsquo;s possible it was waiting to be sent (it was in my case), but if you resend, it should show up more quickly. Then watch the logs on the debug server to see it arrive. You may have to scroll up past an HTML formatted section, but most validation emails should have both an HTML section and a plain text section. Copy that link and you&rsquo;re golden.</p><p>And that&rsquo;s it. Validation email without having to configure a &lsquo;real&rsquo; SMTP server. You definitely want to clean up when you&rsquo;re done, removing the new DNS entries, shutting down the server, and (optionally) shutting down the instance that was running it. It&rsquo;s a debug server. Not the sort of thing you want to leave exposed to the public internet. And if you need it again in a year&rsquo;s time to validate the domain again&mldr; well, come right on back to this post. ðŸ˜„</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script defer src=/custom.js></script></body></html>
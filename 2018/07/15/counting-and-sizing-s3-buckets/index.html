<!DOCTYPE html>
<html>
<head>
    <title>Counting and Sizing S3 Buckets â€“ jverkamp.com</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Counting and Sizing S3 Buckets</h1>

        <div class="entry-meta"><span class="entry-date">2018-07-15</span>
            </div><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2018/07/09/creating-a-temporary-smtp-server-to-catch-domain-validation-emails/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/python">Python</a><a href="https://blog.jverkamp.com/2018/12/01/advent-of-code-2018/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2018/03/12/generating-zone-files-from-route53/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/aws">AWS</a><a href="https://blog.jverkamp.com/2019/01/04/listing-and-downloading-s3-versions/" class="next-link"></a></li><li><a class="taxonomy-value" href="/programming/topics/aws-cloudwatch">AWS CloudWatch</a></li><li><a class="taxonomy-value" href="/programming/topics/aws-s3">AWS S3</a><a href="https://blog.jverkamp.com/2019/01/04/listing-and-downloading-s3-versions/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2018/07/09/creating-a-temporary-smtp-server-to-catch-domain-validation-emails/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2018/07/18/adding-hsts-to-redirects-in-apache/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2018/07/11/the-fires-of-heaven/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2018/07/18/adding-hsts-to-redirects-in-apache/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</header>

	<div class="entry-content"><p>A long time ago in a galaxy far far away, I wrote up a script that I used to take an <a href="https://aws.amazon.com/s3/">AWS S3</a> bucket and count how many objects there were in the bucket and calculate its total size. While you could get some of this information from billing reports, there just wasn&rsquo;t a good way to get it other than that at the time. The only way you could do it was to&hellip; iterate through the entire bucket, summing as you go. If you have buckets with millions (or more) objects, this could take a while.</p>

<p>Basically:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">conn <span style="color:#f92672">=</span> boto<span style="color:#f92672">.</span>connect_s3()
<span style="color:#66d9ef">for</span> bucket <span style="color:#f92672">in</span> sorted(conn<span style="color:#f92672">.</span>get_all_buckets()):
    <span style="color:#66d9ef">try</span>:
        total_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        total_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        start <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now()

        <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> bucket<span style="color:#f92672">.</span>list_versions():
            <span style="color:#75715e"># Skip deleted files</span>
            <span style="color:#66d9ef">if</span> isinstance(key, boto<span style="color:#f92672">.</span>s3<span style="color:#f92672">.</span>deletemarker<span style="color:#f92672">.</span>DeleteMarker):
                <span style="color:#66d9ef">continue</span>

            size <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>size
            total_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            total_size <span style="color:#f92672">+=</span> size

        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;-- {count} files, {size}, {time} to calculate&#39;</span><span style="color:#f92672">.</span>format(
            count <span style="color:#f92672">=</span> total_count,
            size <span style="color:#f92672">=</span> humanize<span style="color:#f92672">.</span>naturalsize(total_size),
            time <span style="color:#f92672">=</span> humanize<span style="color:#f92672">.</span>naturaltime(datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now() <span style="color:#f92672">-</span> start)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; ago&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
        ))</code></pre></div>
<p>Luckily, AWS later introduced <a href="https://aws.amazon.com/cloudwatch/">CloudWatch</a> which has exactly the metrics I need to do this quickly. So rather than a script that takes days to run (and isn&rsquo;t exactly cheap, each access costs a fraction of a penny and I had to make a lot of them), we can make a handful of calls and have the entire output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">import</span> boto3
<span style="color:#f92672">import</span> datetime

regions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;us-east-1&#39;</span>, <span style="color:#e6db74">&#39;us-west-2&#39;</span>]
measurable_metrics <span style="color:#f92672">=</span> [
    (<span style="color:#e6db74">&#39;BucketSizeBytes&#39;</span>, <span style="color:#e6db74">&#39;StandardStorage&#39;</span>),
    (<span style="color:#e6db74">&#39;NumberOfObjects&#39;</span>, <span style="color:#e6db74">&#39;AllStorageTypes&#39;</span>),
]

s3 <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#39;s3&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cw</span>(region, cws <span style="color:#f92672">=</span> {}):
    <span style="color:#e6db74">&#39;&#39;&#39;Caching Cloudwatch accessor by region.&#39;&#39;&#39;</span>

    <span style="color:#66d9ef">if</span> region <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> cws:
        cws[region] <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;cloudwatch&#39;</span>, region_name <span style="color:#f92672">=</span> region)

    <span style="color:#66d9ef">return</span> cws[region]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bucket_stats</span>(name, date):
    <span style="color:#e6db74">&#39;&#39;&#39;Get the number object count and size of a bucket on a given date.&#39;&#39;&#39;</span>

    results <span style="color:#f92672">=</span> {}

    <span style="color:#66d9ef">for</span> metric_name, storage_type <span style="color:#f92672">in</span> measurable_metrics:
        <span style="color:#66d9ef">for</span> region <span style="color:#f92672">in</span> regions:
            metrics <span style="color:#f92672">=</span> cw(region)<span style="color:#f92672">.</span>get_metric_statistics(
                Namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;AWS/S3&#39;</span>,
                MetricName <span style="color:#f92672">=</span> metric_name,
                StartTime <span style="color:#f92672">=</span> date <span style="color:#f92672">-</span> datetime<span style="color:#f92672">.</span>timedelta(days <span style="color:#f92672">=</span> <span style="color:#ae81ff">365</span>),
                EndTime <span style="color:#f92672">=</span> date,
                Period <span style="color:#f92672">=</span> <span style="color:#ae81ff">86400</span>,
                Statistics <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Average&#39;</span>],
                Dimensions <span style="color:#f92672">=</span> [
                    {<span style="color:#e6db74">&#39;Name&#39;</span>: <span style="color:#e6db74">&#39;BucketName&#39;</span>, <span style="color:#e6db74">&#39;Value&#39;</span>: name},
                    {<span style="color:#e6db74">&#39;Name&#39;</span>: <span style="color:#e6db74">&#39;StorageType&#39;</span>, <span style="color:#e6db74">&#39;Value&#39;</span>: storage_type},
                ],
            )

            <span style="color:#66d9ef">if</span> metrics[<span style="color:#e6db74">&#39;Datapoints&#39;</span>]:
                results[metric_name] <span style="color:#f92672">=</span> sorted(metrics[<span style="color:#e6db74">&#39;Datapoints&#39;</span>], key <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> row: row[<span style="color:#e6db74">&#39;Timestamp&#39;</span>])[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#e6db74">&#39;Average&#39;</span>]
                results[<span style="color:#e6db74">&#39;region&#39;</span>] <span style="color:#f92672">=</span> region
                <span style="color:#66d9ef">continue</span>

    <span style="color:#66d9ef">return</span> results

date <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>utcnow()<span style="color:#f92672">.</span>replace(hour <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, minute <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, second <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, microsecond <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;region&#39;</span>, <span style="color:#e6db74">&#39;bytes&#39;</span>, <span style="color:#e6db74">&#39;objects&#39;</span>, sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">for</span> bucket <span style="color:#f92672">in</span> sorted(s3<span style="color:#f92672">.</span>buckets<span style="color:#f92672">.</span>all(), key <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> bucket: bucket<span style="color:#f92672">.</span>name):
    results <span style="color:#f92672">=</span> bucket_stats(bucket<span style="color:#f92672">.</span>name, date)
    <span style="color:#66d9ef">print</span>(bucket<span style="color:#f92672">.</span>name, results<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;region&#39;</span>), int(results<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;BucketSizeBytes&#39;</span>, <span style="color:#ae81ff">0</span>)), int(results<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;NumberOfObjects&#39;</span>, <span style="color:#ae81ff">0</span>)), sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>)</code></pre></div>
<p>Even better, you can use this to get this information at any time or even over time, to find fast growing buckets. All of this information is directly available in the CloudWatch console, but some things are difficult to do in that particular interface (or were last I looked, it&rsquo;s been a few months), so it&rsquo;s always nice to be able to export your information.</p>

<p>The script also generalizes fairly well to other CloudWatch stats. It would require a bit of tweaking (for example changing the <code>Dimensions</code> parameter along with the <code>measurable_metrics</code> array), but it&rsquo;s entirely doable. Perhaps I&rsquo;ll post a few of the modifications I&rsquo;ve made some day.</p></div>
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Counting and Sizing S3 Buckets";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2018\/07\/15\/counting-and-sizing-s3-buckets\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div></article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>
</body>
</html>

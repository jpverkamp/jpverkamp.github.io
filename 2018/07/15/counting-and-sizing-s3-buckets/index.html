<!doctype html><html><head><title>Counting and Sizing S3 Buckets â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.82ab51144325fae71ddbca46269a80c63b28bdab6be6b01aa9ec638c013748e6.js integrity="sha256-gqtRFEMl+ucd28pGJpqAxjsovatr5rAaqexjjAE3SOY=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="><link rel=stylesheet href=/main.min.5cb1123af6f7b30230b5393c75ce8864dee1f2dcd12b5c4d5cfc0bf351a34476.css integrity="sha256-XLESOvb3swIwtTk8dc6IZN7h8tzRK1xNXPwL81GjRHY="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Counting and Sizing S3 Buckets</h1><div class=entry-meta><span class=entry-date>2018-07-15</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2018/07/09/creating-a-temporary-smtp-server-to-catch-domain-validation-emails/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2018/12/01/advent-of-code-2018/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2018/03/12/generating-zone-files-from-route53/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/aws>AWS</a><a href=https://blog.jverkamp.com/2019/01/04/listing-and-downloading-s3-versions/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/aws-cloudwatch>AWS CloudWatch</a></li><li><a class=taxonomy-value href=/programming/topics/aws-s3>AWS S3</a><a href=https://blog.jverkamp.com/2019/01/04/listing-and-downloading-s3-versions/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2018/07/09/creating-a-temporary-smtp-server-to-catch-domain-validation-emails/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/07/18/adding-hsts-to-redirects-in-apache/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2018/07/11/the-fires-of-heaven/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/07/18/adding-hsts-to-redirects-in-apache/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>A long time ago in a galaxy far far away, I wrote up a script that I used to take an <a href=https://aws.amazon.com/s3/>AWS S3</a> bucket and count how many objects there were in the bucket and calculate its total size. While you could get some of this information from billing reports, there just wasn&rsquo;t a good way to get it other than that at the time. The only way you could do it was to&mldr; iterate through the entire bucket, summing as you go. If you have buckets with millions (or more) objects, this could take a while.</p><p>Basically:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>conn <span style=color:#f92672>=</span> boto<span style=color:#f92672>.</span>connect_s3()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> bucket <span style=color:#f92672>in</span> sorted(conn<span style=color:#f92672>.</span>get_all_buckets()):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        total_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        total_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        start <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key <span style=color:#f92672>in</span> bucket<span style=color:#f92672>.</span>list_versions():
</span></span><span style=display:flex><span>            <span style=color:#75715e># Skip deleted files</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(key, boto<span style=color:#f92672>.</span>s3<span style=color:#f92672>.</span>deletemarker<span style=color:#f92672>.</span>DeleteMarker):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            size <span style=color:#f92672>=</span> key<span style=color:#f92672>.</span>size
</span></span><span style=display:flex><span>            total_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            total_size <span style=color:#f92672>+=</span> size
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;-- </span><span style=color:#e6db74>{count}</span><span style=color:#e6db74> files, </span><span style=color:#e6db74>{size}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{time}</span><span style=color:#e6db74> to calculate&#39;</span><span style=color:#f92672>.</span>format(
</span></span><span style=display:flex><span>            count <span style=color:#f92672>=</span> total_count,
</span></span><span style=display:flex><span>            size <span style=color:#f92672>=</span> humanize<span style=color:#f92672>.</span>naturalsize(total_size),
</span></span><span style=display:flex><span>            time <span style=color:#f92672>=</span> humanize<span style=color:#f92672>.</span>naturaltime(datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> start)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39; ago&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>        ))
</span></span></code></pre></div><p>Luckily, AWS later introduced <a href=https://aws.amazon.com/cloudwatch/>CloudWatch</a> which has exactly the metrics I need to do this quickly. So rather than a script that takes days to run (and isn&rsquo;t exactly cheap, each access costs a fraction of a penny and I had to make a lot of them), we can make a handful of calls and have the entire output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> boto3
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>regions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;us-east-1&#39;</span>, <span style=color:#e6db74>&#39;us-west-2&#39;</span>]
</span></span><span style=display:flex><span>measurable_metrics <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    (<span style=color:#e6db74>&#39;BucketSizeBytes&#39;</span>, <span style=color:#e6db74>&#39;StandardStorage&#39;</span>),
</span></span><span style=display:flex><span>    (<span style=color:#e6db74>&#39;NumberOfObjects&#39;</span>, <span style=color:#e6db74>&#39;AllStorageTypes&#39;</span>),
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s3 <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>resource(<span style=color:#e6db74>&#39;s3&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cw</span>(region, cws <span style=color:#f92672>=</span> {}):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Caching Cloudwatch accessor by region.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> region <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> cws:
</span></span><span style=display:flex><span>        cws[region] <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;cloudwatch&#39;</span>, region_name <span style=color:#f92672>=</span> region)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cws[region]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bucket_stats</span>(name, date):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Get the number object count and size of a bucket on a given date.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> metric_name, storage_type <span style=color:#f92672>in</span> measurable_metrics:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> region <span style=color:#f92672>in</span> regions:
</span></span><span style=display:flex><span>            metrics <span style=color:#f92672>=</span> cw(region)<span style=color:#f92672>.</span>get_metric_statistics(
</span></span><span style=display:flex><span>                Namespace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;AWS/S3&#39;</span>,
</span></span><span style=display:flex><span>                MetricName <span style=color:#f92672>=</span> metric_name,
</span></span><span style=display:flex><span>                StartTime <span style=color:#f92672>=</span> date <span style=color:#f92672>-</span> datetime<span style=color:#f92672>.</span>timedelta(days <span style=color:#f92672>=</span> <span style=color:#ae81ff>365</span>),
</span></span><span style=display:flex><span>                EndTime <span style=color:#f92672>=</span> date,
</span></span><span style=display:flex><span>                Period <span style=color:#f92672>=</span> <span style=color:#ae81ff>86400</span>,
</span></span><span style=display:flex><span>                Statistics <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;Average&#39;</span>],
</span></span><span style=display:flex><span>                Dimensions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>                    {<span style=color:#e6db74>&#39;Name&#39;</span>: <span style=color:#e6db74>&#39;BucketName&#39;</span>, <span style=color:#e6db74>&#39;Value&#39;</span>: name},
</span></span><span style=display:flex><span>                    {<span style=color:#e6db74>&#39;Name&#39;</span>: <span style=color:#e6db74>&#39;StorageType&#39;</span>, <span style=color:#e6db74>&#39;Value&#39;</span>: storage_type},
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> metrics[<span style=color:#e6db74>&#39;Datapoints&#39;</span>]:
</span></span><span style=display:flex><span>                results[metric_name] <span style=color:#f92672>=</span> sorted(metrics[<span style=color:#e6db74>&#39;Datapoints&#39;</span>], key <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> row: row[<span style=color:#e6db74>&#39;Timestamp&#39;</span>])[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>][<span style=color:#e6db74>&#39;Average&#39;</span>]
</span></span><span style=display:flex><span>                results[<span style=color:#e6db74>&#39;region&#39;</span>] <span style=color:#f92672>=</span> region
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> results
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>date <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcnow()<span style=color:#f92672>.</span>replace(hour <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, minute <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, second <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, microsecond <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#e6db74>&#39;region&#39;</span>, <span style=color:#e6db74>&#39;bytes&#39;</span>, <span style=color:#e6db74>&#39;objects&#39;</span>, sep <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> bucket <span style=color:#f92672>in</span> sorted(s3<span style=color:#f92672>.</span>buckets<span style=color:#f92672>.</span>all(), key <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> bucket: bucket<span style=color:#f92672>.</span>name):
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> bucket_stats(bucket<span style=color:#f92672>.</span>name, date)
</span></span><span style=display:flex><span>    print(bucket<span style=color:#f92672>.</span>name, results<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;region&#39;</span>), int(results<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;BucketSizeBytes&#39;</span>, <span style=color:#ae81ff>0</span>)), int(results<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;NumberOfObjects&#39;</span>, <span style=color:#ae81ff>0</span>)), sep <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>&#39;</span>)
</span></span></code></pre></div><p>Even better, you can use this to get this information at any time or even over time, to find fast growing buckets. All of this information is directly available in the CloudWatch console, but some things are difficult to do in that particular interface (or were last I looked, it&rsquo;s been a few months), so it&rsquo;s always nice to be able to export your information.</p><p>The script also generalizes fairly well to other CloudWatch stats. It would require a bit of tweaking (for example changing the <code>Dimensions</code> parameter along with the <code>measurable_metrics</code> array), but it&rsquo;s entirely doable. Perhaps I&rsquo;ll post a few of the modifications I&rsquo;ve made some day.</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!doctype html><html><head><title>Adding HSTS to Redirects in Apache â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.e0e68b86dea32185ab89b0b9cc01649107cc6b0be3290c8c7b13c716bc0dabfa.css integrity="sha256-4OaLht6jIYWribC5zAFkkQfMawvjKQyMexPHFrwNq/o="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Adding HSTS to Redirects in Apache</h1><div class=entry-meta><span class=entry-date>2018-07-18</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a class=taxonomy-value href=/programming/topics/apache>Apache</a></li><li><a href=https://blog.jverkamp.com/2018/02/15/automatic-self-signed-https-for-local-development/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/https>HTTPS</a><a href=https://blog.jverkamp.com/2023/03/27/wildcard-lets-encrypt-certificates-with-nginx-proxy-manager-and-cloudflare/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/09/26/simple-localstorage-notepad/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/07/19/lord-of-chaos/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>TLDR:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#75715e># Use &#39;always&#39; so headers are also set for non-2XX and unset to avoid duplicates</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;IfModule</span> <span style=color:#e6db74>headers_module</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	header unset Strict-Transport-Security
</span></span><span style=display:flex><span>	header always set Strict-Transport-Security <span style=color:#e6db74>&#34;max-age=16070400; includeSubDomains;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/IfModule&gt;</span>
</span></span></code></pre></div><p>Slightly<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> longer version:</p><p><a href=https://www.eff.org/https-everywhere>HTTPS everywhere</a> is a worthwhile goal. Even when you have traffic that isn&rsquo;t super interesting or sensitive by itself, the fact that you&rsquo;re encrypting it makes traffic that really does need to be encrypted safer against tools that grab all of the encrypted traffic they can to decrypt later if/when possible.</p><p>One of the downsides of using HTTPS though is that without certain things in place, many users will still type <code>domain.com</code> in their address bar from time to time, completely missing out on the <code>https://</code>. While you can immediately redirect them, that very first request is a risk, since if a <a href=https://en.wikipedia.org/wiki/man-in-the-middle%20attack>man-in-the-middle attack</a> happens to catch that request, they can downgrade the entire connection.</p><p>Enter <a href=https://en.wikipedia.org/wiki/HTTP%20Strict%20Transport%20Security>HTTP Strict Transport Security</a> (HSTS). It&rsquo;s a HTTP header that you can send on the first <code>HTTPS</code> connection you establish with a compatible client. Once you&rsquo;ve done that, any further requests (until the header&rsquo;s TTL expires without being renewed) will be sent to <code>https://</code> no matter what the user types. Which solves the first request problem for all sessions&mldr; but it still doesn&rsquo;t fix the very first time you have to get the header. So how do you fix that?</p><p><a href=https://hstspreload.org/>HSTS Preload lists</a>.</p><p>Both Firefox and Chrome allow you to submit your domain to be preloaded into a built in HSTS list. Once this is set up, even the very first request to your domain (and any subdomains, if you configure that) will be automatically sent to <code>https://</code>. Nice.</p><p>One interesting bit that has developed on the HSTS preload lists though is that it&rsquo;s actually Chrome that maintains the &lsquo;core&rsquo; HSTS preload list. Firefox and <a href=https://www.torproject.org/>the Tor project</a> both derive their lists from Chrome&rsquo;s. Which leads us to the weird gotcha that I ran into recently: in order for Firefox to preload a domain, it has to be present in Chrome&rsquo;s list and it has to return the HSTS header (with a sufficiently long TTL). Pretty straight forward, no?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I <span style=color:#e6db74>&#39;https://example.com&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>301</span>
</span></span><span style=display:flex><span>date: ...
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>iso-8859-1
</span></span><span style=display:flex><span>location: https://www.example.com/
</span></span><span style=display:flex><span>server: Apache
</span></span></code></pre></div><p>Hmm. So the problem is that we have a redirect on the bare domain that redirects to <code>www</code>. We can fix that in the Apache configs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#f92672>&lt;IfModule</span> <span style=color:#e6db74>headers_module</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>header set Strict-Transport-Security <span style=color:#e6db74>&#34;max-age=16070400; includeSubDomains;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/IfModule&gt;</span>
</span></span></code></pre></div><p>Reload and we should be good to go.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I <span style=color:#e6db74>&#39;https://example.com&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>301</span>
</span></span><span style=display:flex><span>date: ...
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>iso-8859-1
</span></span><span style=display:flex><span>location: https://www.example.com/
</span></span><span style=display:flex><span>server: Apache
</span></span></code></pre></div><p>Hmm. That didn&rsquo;t work as well as I would have hoped. Did a bit more reading and it turns out that Apache won&rsquo;t actually set headers on non-2XX responses by default. You need to specify an additional option:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#75715e># Use &#39;always&#39; so headers are also set for non-2XX</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;IfModule</span> <span style=color:#e6db74>headers_module</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	header always set Strict-Transport-Security <span style=color:#e6db74>&#34;max-age=16070400; includeSubDomains;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/IfModule&gt;</span>
</span></span></code></pre></div><p>Try again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I <span style=color:#e6db74>&#39;https://example.com&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>301</span>
</span></span><span style=display:flex><span>date: ...
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>iso-8859-1
</span></span><span style=display:flex><span>location: https://www.example.com/
</span></span><span style=display:flex><span>server: Apache
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span>16070400; includeSubDomains;
</span></span></code></pre></div><p>That&rsquo;s exactly what I was looking for. But now we have another problem. The application itself is actually still configured to send the HSTS header on normal requests that make it past the Apache layer. So when I make a normal request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I <span style=color:#e6db74>&#39;https://www.example.com&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>date: ...
</span></span><span style=display:flex><span>content-type: text/html
</span></span><span style=display:flex><span>server: Apache
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span>16070400; includeSubDomains
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span>16070400; includeSubDomains;
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Which isn&rsquo;t exactly the end of the world, but I&rsquo;d rather it be a bit cleaner. Enter <code>unset</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#75715e># Use &#39;always&#39; so headers are also set for non-2XX and unset to avoid duplicates</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;IfModule</span> <span style=color:#e6db74>headers_module</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	header unset Strict-Transport-Security
</span></span><span style=display:flex><span>	header always set Strict-Transport-Security <span style=color:#e6db74>&#34;max-age=16070400; includeSubDomains;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/IfModule&gt;</span>
</span></span></code></pre></div><p>This will first remove the old header the application is setting and then add one of our own.</p><p>One more try:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I <span style=color:#e6db74>&#39;https://www.example.com&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>date: ...
</span></span><span style=display:flex><span>content-type: text/html
</span></span><span style=display:flex><span>server: Apache
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span>16070400; includeSubDomains;
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Golden. One final downside is that we also still send the header over <code>http://</code>, but it doesn&rsquo;t actually hurt anything to do this, it will just be ignored. But the entire point is to properly configured preload lists, so I&rsquo;m not overly concerned.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Long blog post for what amounts to two config lines. But it took me a bit of Google-fu to figure out why it wasn&rsquo;t working in the first place, so if this saves even one person the time it took me, it will be worth it.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!DOCTYPE html>
<html>
<head>
    <title>
    Adding HSTS to Redirects in Apache â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Adding HSTS to Redirects in Apache</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2018-07-18</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/programming/topics/apache">Apache</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2018/02/15/automatic-self-signed-https-for-local-development/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/https">HTTPS</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2018/09/26/simple-localstorage-notepad/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2018/07/19/lord-of-chaos/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>TLDR:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#75715e"># Use &#39;always&#39; so headers are also set for non-2XX and unset to avoid duplicates</span>
<span style="color:#f92672">&lt;IfModule</span> <span style="color:#e6db74">headers_module</span><span style="color:#f92672">&gt;</span>
	header unset Strict-Transport-Security
	header always set Strict-Transport-Security <span style="color:#e6db74">&#34;max-age=16070400; includeSubDomains;&#34;</span>
<span style="color:#f92672">&lt;/IfModule&gt;</span></code></pre></div>
<p>Slightly<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup> longer version:</p>

<p><a href="https://www.eff.org/https-everywhere">HTTPS everywhere</a> is a worthwhile goal. Even when you have traffic that isn&rsquo;t super interesting or sensitive by itself, the fact that you&rsquo;re encrypting it makes traffic that really does need to be encrypted safer against tools that grab all of the encrypted traffic they can to decrypt later if/when possible.</p>

<p>One of the downsides of using HTTPS though is that without certain things in place, many users will still type <code>domain.com</code> in their address bar from time to time, completely missing out on the <code>https://</code>. While you can immediately redirect them, that very first request is a risk, since if a <a href="https://en.wikipedia.org/wiki/man-in-the-middle%20attack">man-in-the-middle attack</a> happens to catch that request, they can downgrade the entire connection.</p>

<p>Enter <a href="https://en.wikipedia.org/wiki/HTTP%20Strict%20Transport%20Security">HTTP Strict Transport Security</a> (HSTS). It&rsquo;s a HTTP header that you can send on the first <code>HTTPS</code> connection you establish with a compatible client. Once you&rsquo;ve done that, any further requests (until the header&rsquo;s TTL expires without being renewed) will be sent to <code>https://</code> no matter what the user types. Which solves the first request problem for all sessions&hellip; but it still doesn&rsquo;t fix the very first time you have to get the header. So how do you fix that?</p>

<p><a href="https://hstspreload.org/">HSTS Preload lists</a>.</p>

<p>Both Firefox and Chrome allow you to submit your domain to be preloaded into a built in HSTS list. Once this is set up, even the very first request to your domain (and any subdomains, if you configure that) will be automatically sent to <code>https://</code>. Nice.</p>

<p>One interesting bit that has developed on the HSTS preload lists though is that it&rsquo;s actually Chrome that maintains the &lsquo;core&rsquo; HSTS preload list. Firefox and <a href="https://www.torproject.org/">the Tor project</a> both derive their lists from Chrome&rsquo;s. Which leads us to the weird gotcha that I ran into recently: in order for Firefox to preload a domain, it has to be present in Chrome&rsquo;s list and it has to return the HSTS header (with a sufficiently long TTL). Pretty straight forward, no?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -I <span style="color:#e6db74">&#39;https://example.com&#39;</span>

HTTP/2 <span style="color:#ae81ff">301</span>
date: ...
content-type: text/html; charset<span style="color:#f92672">=</span>iso-8859-1
location: https://www.example.com/
server: Apache</code></pre></div>
<p>Hmm. So the problem is that we have a redirect on the bare domain that redirects to <code>www</code>. We can fix that in the Apache configs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#f92672">&lt;IfModule</span> <span style="color:#e6db74">headers_module</span><span style="color:#f92672">&gt;</span>
header set Strict-Transport-Security <span style="color:#e6db74">&#34;max-age=16070400; includeSubDomains;&#34;</span>
<span style="color:#f92672">&lt;/IfModule&gt;</span></code></pre></div>
<p>Reload and we should be good to go.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -I <span style="color:#e6db74">&#39;https://example.com&#39;</span>

HTTP/2 <span style="color:#ae81ff">301</span>
date: ...
content-type: text/html; charset<span style="color:#f92672">=</span>iso-8859-1
location: https://www.example.com/
server: Apache</code></pre></div>
<p>Hmm. That didn&rsquo;t work as well as I would have hoped. Did a bit more reading and it turns out that Apache won&rsquo;t actually set headers on non-2XX responses by default. You need to specify an additional option:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#75715e"># Use &#39;always&#39; so headers are also set for non-2XX</span>
<span style="color:#f92672">&lt;IfModule</span> <span style="color:#e6db74">headers_module</span><span style="color:#f92672">&gt;</span>
	header always set Strict-Transport-Security <span style="color:#e6db74">&#34;max-age=16070400; includeSubDomains;&#34;</span>
<span style="color:#f92672">&lt;/IfModule&gt;</span></code></pre></div>
<p>Try again:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -I <span style="color:#e6db74">&#39;https://example.com&#39;</span>

HTTP/2 <span style="color:#ae81ff">301</span>
date: ...
content-type: text/html; charset<span style="color:#f92672">=</span>iso-8859-1
location: https://www.example.com/
server: Apache
strict-transport-security: max-age<span style="color:#f92672">=</span><span style="color:#ae81ff">16070400</span>; includeSubDomains;</code></pre></div>
<p>That&rsquo;s exactly what I was looking for. But now we have another problem. The application itself is actually still configured to send the HSTS header on normal requests that make it past the Apache layer. So when I make a normal request:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -I <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>

HTTP/2 <span style="color:#ae81ff">200</span>
date: ...
content-type: text/html
server: Apache
strict-transport-security: max-age<span style="color:#f92672">=</span><span style="color:#ae81ff">16070400</span>; includeSubDomains
strict-transport-security: max-age<span style="color:#f92672">=</span><span style="color:#ae81ff">16070400</span>; includeSubDomains;
...</code></pre></div>
<p>Which isn&rsquo;t exactly the end of the world, but I&rsquo;d rather it be a bit cleaner. Enter <code>unset</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#75715e"># Use &#39;always&#39; so headers are also set for non-2XX and unset to avoid duplicates</span>
<span style="color:#f92672">&lt;IfModule</span> <span style="color:#e6db74">headers_module</span><span style="color:#f92672">&gt;</span>
	header unset Strict-Transport-Security
	header always set Strict-Transport-Security <span style="color:#e6db74">&#34;max-age=16070400; includeSubDomains;&#34;</span>
<span style="color:#f92672">&lt;/IfModule&gt;</span></code></pre></div>
<p>This will first remove the old header the application is setting and then add one of our own.</p>

<p>One more try:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -I <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>

HTTP/2 <span style="color:#ae81ff">200</span>
date: ...
content-type: text/html
server: Apache
strict-transport-security: max-age<span style="color:#f92672">=</span><span style="color:#ae81ff">16070400</span>; includeSubDomains;
...</code></pre></div>
<p>Golden. One final downside is that we also still send the header over <code>http://</code>, but it doesn&rsquo;t actually hurt anything to do this, it will just be ignored. But the entire point is to properly configured preload lists, so I&rsquo;m not overly concerned.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Long blog post for what amounts to two config lines. But it took me a bit of Google-fu to figure out why it wasn&rsquo;t working in the first place, so if this saves even one person the time it took me, it will be worth it.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Adding HSTS to Redirects in Apache";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2018\/07\/18\/adding-hsts-to-redirects-in-apache\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

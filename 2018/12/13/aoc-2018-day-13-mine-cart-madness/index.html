<!DOCTYPE html>
<html>
<head>
    <title>
    AoC 2018 Day 13: Mine Cart Madness – jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">AoC 2018 Day 13: Mine Cart Madness</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2018-12-13</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2018/12/12/aoc-2018-day-12-fat-cellular-automaton/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2018/12/14/aoc-2018-day-14-functionally-circular-elfs/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2018/12/12/aoc-2018-day-12-fat-cellular-automaton/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/sources/advent-of-code">Advent of Code</a>
                        <a href="https://blog.jverkamp.com/2018/12/14/aoc-2018-day-14-functionally-circular-elfs/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2018/12/12/aoc-2018-day-12-fat-cellular-automaton/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/series/advent-of-code-2018">Advent of Code 2018</a>
                        <a href="https://blog.jverkamp.com/2018/12/14/aoc-2018-day-14-functionally-circular-elfs/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2018/12/12/aoc-2018-day-12-fat-cellular-automaton/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2018/12/14/aoc-2018-day-14-functionally-circular-elfs/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2018/12/12/aoc-2018-day-12-fat-cellular-automaton/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2018/12/14/aoc-2018-day-14-functionally-circular-elfs/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<h3 id="source-mine-cart-madness-https-adventofcode-com-2018-day-13">Source: <a href="https://adventofcode.com/2018/day/13">Mine Cart Madness</a></h3>

<blockquote>
<p><strong>Part 1:</strong> Load a minecart track that looks like this:</p>

<pre><code>/-&gt;-\        
|   |  /----\
| /-+--+-\  |
| | |  | v  |
\-+-/  \-+--/
  \------/
</code></pre>

<p>Assuming minecarts follow the tracks and alternate turning left, going straight, and turning right on each intersection (<code>+</code>), where does the first collision occur?</p>

<p>NOTE: Update carts top to bottom, left to right. Carts can collide mid update.</p>
</blockquote>

<p>Okay. It&rsquo;s an interesting data format problem mostly. And we have to deal a bit with not being imperative, in particular when we&rsquo;re doing the updates, since having collisions happen halfway through an update is not so great. Let&rsquo;s load it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">(<span style="color:#66d9ef">struct</span> point (x y) <span style="color:#66d9ef">#:transparent</span>)
(<span style="color:#66d9ef">struct</span> cart (location velocity next-turn) <span style="color:#66d9ef">#:transparent</span>)
(<span style="color:#66d9ef">struct</span> track (data carts top-left bottom-right) <span style="color:#66d9ef">#:transparent</span>)</code></pre></div>
<p>The goal will be to load the tracks into a hash of <code>point</code> to character (so I know how the track turns / intersects) and separately store the carts. I&rsquo;ll want to process the track after the initial load to replace carts with their underlying track and get the initial velocity as well. Finally, <code>next-turn</code> will always start as <code>'left</code>, but we&rsquo;ll deal with that later.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Read a track from the current-input</span>
(<span style="color:#66d9ef">define</span> (read-track [in (current-input-port)])
  <span style="color:#75715e">; Read the raw data</span>
  (<span style="color:#66d9ef">define</span> raw-data
    (<span style="color:#66d9ef">for/fold</span> ([track (hash)])
              ([line (in-lines in)]
               [y (in-naturals)])
      (<span style="color:#66d9ef">for/fold</span> ([track track])
                ([c (in-string line)]
                 [x (in-naturals)]
                 <span style="color:#66d9ef">#:unless</span> (equal? c <span style="color:#e6db74">#\space</span>))
        (hash-set track (point x y) c))))

  <span style="color:#75715e">; For each cart character, track to underlying track and current velocity</span>
  (<span style="color:#66d9ef">define</span> cart-track-data
    (hash <span style="color:#e6db74">#\&gt;</span> (list <span style="color:#e6db74">#\-</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>)
          <span style="color:#e6db74">#\&lt;</span> (list <span style="color:#e6db74">#\-</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">0</span>)
          <span style="color:#e6db74">#\^</span> (list <span style="color:#e6db74">#\|</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">-1</span>)
          <span style="color:#e6db74">#\v</span> (list <span style="color:#e6db74">#\|</span> <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>)))

  <span style="color:#75715e">; Determine where the carts are</span>
  (<span style="color:#66d9ef">define-values</span> (data carts)
    (<span style="color:#66d9ef">for*/fold</span> ([data raw-data]
                [carts (list)])
               ([(p c) (in-hash raw-data)]
                [ctd (in-value (hash-ref cart-track-data c <span style="color:#66d9ef">#f</span>))]
                <span style="color:#66d9ef">#:when</span> ctd)
      (values
       <span style="color:#75715e">; Overwrite the track point with the underlying track</span>
       (hash-set data p (first ctd))
       <span style="color:#75715e">; Store the cart position and velocity</span>
       (list* (cart p (point (second ctd) (third ctd)) <span style="color:#f92672">&#39;</span><span style="color:#e6db74">left</span>) carts))))

  <span style="color:#75715e">; Determine the bounds for the track</span>
  (<span style="color:#66d9ef">define-values</span> (min-x max-x min-y max-y)
    (<span style="color:#66d9ef">for/fold</span> ([min-x <span style="color:#66d9ef">#f</span>] [max-x <span style="color:#66d9ef">#f</span>] [min-y <span style="color:#66d9ef">#f</span>] [max-y <span style="color:#66d9ef">#f</span>])
              ([(p c) (in-hash data)])
      (values (min (<span style="color:#66d9ef">or</span> min-x (point-x p)) (point-x p))
              (max (<span style="color:#66d9ef">or</span> max-x (point-x p)) (point-x p))
              (min (<span style="color:#66d9ef">or</span> min-y (point-y p)) (point-y p))
              (max (<span style="color:#66d9ef">or</span> max-y (point-y p)) (point-y p)))))

  <span style="color:#75715e">; Finally create the track structure</span>
  (track data
         carts
         (point min-x min-y)
         (point max-x max-y)))</code></pre></div>
<p>It&rsquo;s a bit complicated and it turns out that the only reason that I need the bounds is to display the tracks for debug reasons, which amuses me somewhat. But we have it, so let&rsquo;s use it. Speaking of display, here&rsquo;s a function to take those bounds and write out what the current track looks like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Helper function to display a track</span>
(<span style="color:#66d9ef">define</span> (display-track m)
  (<span style="color:#66d9ef">for</span> ([y (in-range (point-y (track-top-left m)) (add1 (point-y (track-bottom-right m))))])
    (<span style="color:#66d9ef">for</span> ([x (in-range (point-x (track-top-left m)) (add1 (point-x (track-bottom-right m))))])
      (<span style="color:#66d9ef">cond</span>
        [(<span style="color:#66d9ef">for/first</span> ([c (in-list (track-carts m))]
                     <span style="color:#66d9ef">#:when</span> (equal? (cart-location c) (point x y)))
           c)
         <span style="color:#66d9ef">=&gt;</span> (<span style="color:#66d9ef">λ</span> (c)
              (display
               (<span style="color:#66d9ef">match</span> (cart-velocity c)
                 [(point <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>) <span style="color:#e6db74">#\v</span>]
                 [(point <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">-1</span>) <span style="color:#e6db74">#\^</span>]
                 [(point  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>) <span style="color:#e6db74">#\&gt;</span>]
                 [(point <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">0</span>) <span style="color:#e6db74">#\&lt;</span>])))]
        [<span style="color:#66d9ef">else</span>
         (display (hash-ref (track-data m) (point x y) <span style="color:#e6db74">#\.</span>))]))
    (newline)))</code></pre></div>
<p>Helpful for debugging. <code><a href="http://docs.racket-lang.org/search/index.html?q=match">match</a></code>
 is lovely.</p>

<p>Okay, next we want a function to update a single <code>cart</code>. We&rsquo;ll use this next to update each cart in turn. This got tricky. Initially, I was checking the carts against the <code>track</code> data (to check for collisions), but that doesn&rsquo;t work, since we can have a cart collide against another one after both have already moved. The only way I&rsquo;ve seen to track that is to specify the current cart locations to the <code>update-cart</code> function. There really should be a more elegant way to do this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Update a cart by one tick</span>
<span style="color:#75715e">; Return the new cart; but if it collided raise the cart as an exception insteadcurrent-frame</span>
<span style="color:#75715e">; c* Is a running updated list of carts, since collisions can happen with already moved carts</span>
(<span style="color:#66d9ef">define</span> (update-cart m c c*)
  (<span style="color:#66d9ef">match-define</span> (cart (point x y) (point vx vy) rotation) c)

  (<span style="color:#66d9ef">define</span> new-location (point (+ x vx) (+ y vy)))

  (<span style="color:#66d9ef">define-values</span> (new-velocity new-rotation)
    (<span style="color:#66d9ef">case</span> (hash-ref (track-data m) new-location)
      [(<span style="color:#e6db74">#\/</span>) (values (point (- vy) (- vx)) rotation)]
      [(<span style="color:#e6db74">#\\</span>) (values (point vy vx) rotation)]
      [(<span style="color:#e6db74">#\+</span>)
       (<span style="color:#66d9ef">case</span> rotation
         [(left)     (values (point vy (- vx)) <span style="color:#f92672">&#39;</span><span style="color:#e6db74">straight</span>)]
         [(straight) (values (point vx vy)     <span style="color:#f92672">&#39;</span><span style="color:#e6db74">right</span>)]
         [(right)    (values (point (- vy) vx) <span style="color:#f92672">&#39;</span><span style="color:#e6db74">left</span>)])]
      [<span style="color:#66d9ef">else</span>  (values (point vx vy) rotation)]))

  (<span style="color:#66d9ef">define</span> updated-cart (cart new-location new-velocity new-rotation))

  <span style="color:#75715e">; Check for collisions</span>
  (<span style="color:#66d9ef">for</span> ([c (in-list c*)]
        <span style="color:#66d9ef">#:when</span> (equal? new-location (cart-location c)))
    (raise updated-cart))

  updated-cart)</code></pre></div>
<p>One thing that I actually enjoy here is that I&rsquo;m using <code><a href="http://docs.racket-lang.org/search/index.html?q=exception">exception</a></code>
 handling to deal with the collisions. The function itself only deals with returning the updated cart. If there&rsquo;s a collision, we&rsquo;ll <code><a href="http://docs.racket-lang.org/search/index.html?q=raise">raise</a></code>
 the cart that caused the problem in order to catch it via <code><a href="http://docs.racket-lang.org/search/index.html?q=with-handlers">with-handlers</a></code>
 later.</p>

<p>I&rsquo;m also pretty proud of the rotation code. There are a few other ways you can do this, for example with matrix multiplication or hard coding each case. But I worked it out on paper and it turns out that you flip x and y and negate one or the other. (It&rsquo;s a symptom of the aforementioned matrix multiplication.)</p>

<p>In any case, we can now update the entire track:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Update a track by one tick</span>
<span style="color:#75715e">; If two carts collide, an exception will be raised, catch it and return the cart</span>
(<span style="color:#66d9ef">define</span> (update-track m)
  <span style="color:#75715e">; Update carts, has to be done oddly since they can collide half way through an update</span>
  <span style="color:#75715e">; Otherwise, remove the third argument from update-cart and use:</span>
  <span style="color:#75715e">;   (map (curry update-cart m) (sort (track-carts m) cart-location-&lt;?))</span>
  (<span style="color:#66d9ef">define</span> updated-carts
    (<span style="color:#66d9ef">let</span> loop ([done <span style="color:#f92672">&#39;</span>()]
               [todo (sort (track-carts m) cart-location-&lt;?)])
      (<span style="color:#66d9ef">cond</span>
        [(null? todo) done]
        [<span style="color:#66d9ef">else</span>
         <span style="color:#75715e">; TODO: Make this more efficient than using append</span>
         (loop (list* (update-cart m (first todo) (append done todo)) done)
               (rest todo))])))

  (track (track-data m)
         updated-carts
         (track-top-left m)
         (track-bottom-right m)))</code></pre></div>
<p>As the comment notes, I wish we could have done all the carts at a time. But that would lead to carts skipping past each other in cases like this: <code>-&gt;--&lt;-</code>. So it goes.</p>

<p>Now we can take it one step more and run the simulation until we get a collision. Because we&rsquo;re using exceptions and we haven&rsquo;t caught them yet:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Run a track until collision, return the cart that collided</span>
(<span style="color:#66d9ef">define</span> (update-track-until-collision m)
  (<span style="color:#66d9ef">with-handlers</span> ([cart? identity])
    (<span style="color:#66d9ef">let</span> loop ([m m])
      (loop (update-track m)))))

<span style="color:#75715e">; Run the main program</span>
(printf <span style="color:#e6db74">&#34;[part1]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
(<span style="color:#66d9ef">define</span> input (read-track))
(update-track-until-collision input)</code></pre></div>
<p>That&rsquo;s fun.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat input.txt | racket mine-cart-madness.rkt

<span style="color:#f92672">[</span>part1<span style="color:#f92672">]</span>
<span style="color:#f92672">(</span>cart <span style="color:#f92672">(</span>point <span style="color:#ae81ff">118</span> <span style="color:#ae81ff">66</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>point <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>straight<span style="color:#f92672">)</span></code></pre></div>
<p>Whee!</p>

<blockquote>
<p><strong>Part 2:</strong> Instead of ending the simulation, removing carts that crash into one another. What is the location of the final remaining cart?</p>
</blockquote>

<p>This time around, the <code>updated-carts</code> function will be caught immediately in this function, triggering the removal of the cart that was removed (with the <code>(rest todo</code>) and all other carts at the same location (<code>remove-by-location</code>). Voila:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Update a track by one tick</span>
<span style="color:#75715e">; If two carts collide, remove those two carts and contiue updating</span>
(<span style="color:#66d9ef">define</span> (update-track/remove-collisions m)
  <span style="color:#75715e">; Helper to remove carts at a given location from a list</span>
  (<span style="color:#66d9ef">define</span> (remove-by-location carts location)
    (<span style="color:#66d9ef">for/list</span> ([c (in-list carts)]
               <span style="color:#66d9ef">#:unless</span> (equal? (cart-location c) location))
      c))

  <span style="color:#75715e">; Calculate the new list of carts, some might collide</span>
  (<span style="color:#66d9ef">define</span> updated-carts
    (<span style="color:#66d9ef">let</span> loop ([done <span style="color:#f92672">&#39;</span>()]
               [todo (sort (track-carts m) cart-location-&lt;?)])
      (<span style="color:#66d9ef">cond</span>
        [(null? todo) done]
        [<span style="color:#66d9ef">else</span>
         (<span style="color:#66d9ef">with-handlers</span>
             <span style="color:#75715e">; Case where carts collided</span>
             <span style="color:#75715e">; Remove that cart + all other carts with that coordinate from both lists</span>
             ([cart? (<span style="color:#66d9ef">λ</span> (c)
                       (loop (remove-by-location done (cart-location c))
                             (remove-by-location (rest todo) (cart-location c))))])
           <span style="color:#75715e">; Otherwise</span>
           (loop (list* (update-cart m (first todo) (append done todo)) done)
                 (rest todo)))])))

  (track (track-data m)
         updated-carts
         (track-top-left m)
         (track-bottom-right m)))</code></pre></div>
<p>The wrapper function to run until there is only one cart is only slightly longer:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Run a track until there is only one cart left, removing carts that collide</span>
(<span style="color:#66d9ef">define</span> (update-track-until-singleton m)
  (<span style="color:#66d9ef">let</span> loop ([m m])
    (<span style="color:#66d9ef">cond</span>
      [(&lt;= (length (track-carts m)) <span style="color:#ae81ff">1</span>)
       (first (track-carts m))]
      [<span style="color:#66d9ef">else</span>
       (loop (update-track/remove-collisions m))])))

<span style="color:#75715e">; Run the main program again</span>
(printf <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[part2]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
(current-frame <span style="color:#ae81ff">0</span>)
(update-track-until-singleton input)</code></pre></div>
<p>Shiny:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket">$ cat input.txt <span style="color:#960050;background-color:#1e0010">|</span> racket mine-cart-madness.rkt

[part1]
(cart (point <span style="color:#ae81ff">118</span> <span style="color:#ae81ff">66</span>) (point <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&#39;</span><span style="color:#e6db74">straight</span>)

[part2]
(cart (point <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">129</span>) (point <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&#39;</span><span style="color:#e6db74">right</span>)</code></pre></div>
<p>As a bonus, I made a function that can render the simulation to a picture!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-racket" data-lang="racket"><span style="color:#75715e">; Helper function to render a map as a frame to an image with ASCII graphics</span>
(<span style="color:#66d9ef">define</span> (render-frame m <span style="color:#66d9ef">prefix</span>)
  (<span style="color:#66d9ef">match-define</span> (track data carts (point left top) (point right bottom)) m)
  (printf <span style="color:#e6db74">&#34;rendering frame ~a:~a</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">prefix</span> (current-frame))
  (<span style="color:#66d9ef">send</span>
   (flomap-&gt;bitmap
    (build-flomap*
     <span style="color:#ae81ff">3</span> (add1 (- right left)) (add1 (- bottom top))
     (<span style="color:#66d9ef">λ</span> (x y)
       (<span style="color:#66d9ef">cond</span>
         <span style="color:#75715e">; Carts are red</span>
         [(<span style="color:#66d9ef">for/first</span> ([c (in-list carts)]
                      <span style="color:#66d9ef">#:when</span> (equal? (point x y) (cart-location c)))
            c)
          (vector <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>)]
         <span style="color:#75715e">; Tracks are white</span>
         [(hash-ref data (point x y) <span style="color:#66d9ef">#f</span>)
          (vector <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>)]
         <span style="color:#75715e">; Background is black</span>
         [<span style="color:#66d9ef">else</span>
          (vector <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>)]))))
   save-file
   (~a <span style="color:#e6db74">&#34;frame-&#34;</span> <span style="color:#66d9ef">prefix</span> <span style="color:#e6db74">&#34;-&#34;</span> (~a (current-frame) <span style="color:#66d9ef">#:min-width</span> <span style="color:#ae81ff">4</span> <span style="color:#66d9ef">#:left-pad-string</span> <span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#66d9ef">#:align</span> <span style="color:#f92672">&#39;</span><span style="color:#e6db74">right</span>) <span style="color:#e6db74">&#34;.png&#34;</span>)
   <span style="color:#f92672">&#39;</span><span style="color:#e6db74">png</span>)
  (current-frame (add1 (current-frame))))</code></pre></div>
<p>Pretty pictures!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat input.txt | racket mine-cart-madness.rkt --debug-frames
...

$ convert frame-collision-*.png -interpolate Nearest -filter point -resize <span style="color:#ae81ff">200</span>% aoc-13-minecart.gif</code></pre></div>
<figure>
    <img src="/embeds/2018/aoc-13-minecart.gif"/> 
</figure>


<p>Not super helpful at this scale, but pretty.</p>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "AoC 2018 Day 13: Mine Cart Madness";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2018\/12\/13\/aoc-2018-day-13-mine-cart-madness\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

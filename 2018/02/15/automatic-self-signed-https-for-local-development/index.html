<!doctype html><html><head><title>Automatic self-signed HTTPS for local development â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.82ab51144325fae71ddbca46269a80c63b28bdab6be6b01aa9ec638c013748e6.js integrity="sha256-gqtRFEMl+ucd28pGJpqAxjsovatr5rAaqexjjAE3SOY=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="><link rel=stylesheet href=/main.min.21cc0ec02bdbc197a68cb2e246e6db6d9df556ba2994084c55a6f8b6713e604d.css integrity="sha256-IcwOwCvbwZemjLLiRubbbZ31VroplAhMVab4tnE+YE0="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Automatic self-signed HTTPS for local development</h1><div class=entry-meta><span class=entry-date>2018-02-15</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2018/01/23/running-local-proxies/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/docker>Docker</a><a href=https://blog.jverkamp.com/2018/04/01/deep-dreams-with-fish-and-docker/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/https>HTTPS</a><a href=https://blog.jverkamp.com/2018/07/18/adding-hsts-to-redirects-in-apache/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2016/02/26/audiobooks-to-podcasts/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/nginx>nginx</a></li><li><a href=https://blog.jverkamp.com/2017/12/18/ssh-config-proxycommand-tricks/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/proxies>Proxies</a></li><li><a href=https://blog.jverkamp.com/2015/04/14/a-quick-look-at-rc4/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/tls>TLS</a></li><li><a href=https://blog.jverkamp.com/2016/02/26/audiobooks-to-podcasts/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/web-development>Web Development</a><a href=https://blog.jverkamp.com/2022/02/01/a-simple-flask-logging/echo-server/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2018/01/12/making-fish-shell-smile/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/03/12/generating-zone-files-from-route53/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2018/02/15/words-of-radiance/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/03/02/oathbringer/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>From time to time when doing web development, you need to test something related to HTTPS. In some cases, the application you&rsquo;re writing already supports HTTPS natively and that&rsquo;s no problem. But more often (and probably better, in my opinion) is the case when you have another service (be it an AWS ELB or an nginx layer) that will terminate the HTTPS connection for you so your application doesn&rsquo;t have to know how to speak HTTPS.</p><p>In those cases, how can you test functionality that specifically interacts with HTTPS?</p><p>Today I will show you <code>autohttps</code>, a thin nginx proxy using Docker and a <a href=https://en.wikipedia.org/wiki/self%20signed%20certificate>self signed certificate</a> to automatically create an HTTPS proxy in front of your application.</p><h1 id=setting-up-nginx>Setting up nginx</h1><p>First, we need an nginx config file that will listen for HTTPS, terminate the encryption, and then talk over HTTP to the backend connection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_protocols</span> <span style=color:#e6db74>TLSv1</span> <span style=color:#e6db74>TLSv1.1</span> <span style=color:#e6db74>TLSv1.2</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>/etc/nginx/ssl/nginx.cert</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>/etc/nginx/ssl/nginx.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-Proto</span> $scheme;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://localhost:80</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_read_timeout</span> <span style=color:#ae81ff>90</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>First, we create an nginx <code>server</code> block that listens to the standard HTTPS port (443) and is expecting encrypted communication (<code>ssl</code>)<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Then, we make sure <code>SSL</code> is on and tell it where we can find a certificate pair&ndash;we&rsquo;ll generate this in the next step.</p><p>After that, we want to redirect all traffic with a <code>location /</code> block. We&rsquo;re going to pass along the <code>host</code> header from the host and then set a couple of expected headers. In particularly the <code>X-Forwarded-Proto</code> header is often used by applications to determine if they need to be forwarding HTTP connections to HTTPS (since the application itself would otherwise not know that the client thinks we&rsquo;re speaking HTTPS, since all it sees is HTTP).</p><p>Finally, we&rsquo;ll pass the connections along to the local web server running on the standard HTTP port: 80 (we&rsquo;ll parameterize this in a bit).</p><h1 id=setting-up-docker>Setting up docker</h1><p>Next, we&rsquo;re going to use Docker in order to turn that configuration file into an actual nginx instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ubuntu:16.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y nginx openssl<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p /etc/nginx/ssl/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> openssl req <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -x509 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -subj <span style=color:#e6db74>&#34;/C=US/ST=Denial/L=Nowhere/O=Dis&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -nodes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -days <span style=color:#ae81ff>365</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -newkey rsa:2048 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -keyout /etc/nginx/ssl/nginx.key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -out /etc/nginx/ssl/nginx.cert<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> nginx.conf /etc/nginx/sites-enabled/default<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> tail -f /var/log/nginx/*<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>We&rsquo;re starting with <code>Ubuntu 16.04</code> mostly since that&rsquo;s the current LTS version. I could use something more lightweight, but I&rsquo;m most familiar with how Ubuntu works. Next, we&rsquo;ll install nginx and openssl, the two components we need to make this actually work.</p><p>After that, we need to set up a certificate. This is actually most of the work of this application, the correct parameters that <code>openssl</code> needs in order to make a valid (enough) certificate. This one will last for one year (<code>-days 365</code>) and is baked into the image so if you go longer than that, you&rsquo;ll have to regenerate the certificate. If this becomes a problem, that could be run in the <code>CMD</code> step intead.</p><p>And that&rsquo;s really all we need. We can already use it for what I need:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker build -t autohttps .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sending build context to Docker daemon  3.584kB
</span></span><span style=display:flex><span>Step 1/7 : FROM ubuntu:16.04
</span></span><span style=display:flex><span> ---&gt; 2a4cca5ac898
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Successfully built f962bea5f236
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker run --rm -it -p 443:443 autohttps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Go to <code>https://localhost/</code> and we should have a glorious error page telling us we&rsquo;re using a self-signed cert&mldr;</p><p>Except it doesn&rsquo;t work.</p><p>Because Docker is running in a container, the <code>localhost</code> that&rsquo;s in the nginx config file is actually the Docker container. So it can&rsquo;t see a service running on the host or in another container. In order to work around that, we need to know what the host thinks it&rsquo;s IP address is. There are a few different ways to do that, but we&rsquo;re going ahead and use the relatively cross platform way: Python:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>local_ip <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>gethostbyname(socket<span style=color:#f92672>.</span>gethostname())
</span></span></code></pre></div><p>We have to tweak one line of the nginx config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>proxy_pass</span> <span style=color:#e6db74>http://dockerhost:80</span>;
</span></span></code></pre></div><p>And then we can then pass that into the Docker container on run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;docker run --rm -it --add-host=dockerhost:</span><span style=color:#e6db74>{</span>local_ip<span style=color:#e6db74>}</span><span style=color:#e6db74> -p 443:443 autohttps&#39;</span>)
</span></span></code></pre></div><p>That command will add the IP that we found into the Docker container&rsquo;s hosts file so that when you would go to <code>http://dockerhost</code> in the container, you&rsquo;ll get the given IP without having to resolve it.</p><p>And that actually works. You get a nice warning page:</p><figure><img src=/embeds/2018/connection-not-private.png></figure><p>But if you click <code>Advanced</code> and <code>Proceed to localhost (unsafe)</code>, you get your server&rsquo;s content over HTTPS. Neat.</p><h1 id=custom-ports>Custom ports</h1><p>One final thing I&rsquo;d like to do is make the IP customizable (otherwise you need superuser permissions in order to bind something to ports 80 or 443). We&rsquo;ll wrap everything up in a neat Python script and do just that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>arg_parser <span style=color:#f92672>=</span> argparse<span style=color:#f92672>.</span>ArgumentParser(<span style=color:#e6db74>&#39;Automatically map an HTTP port to HTTPS with a self signed certificate&#39;</span>)
</span></span><span style=display:flex><span>arg_parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--http-port&#39;</span>, type <span style=color:#f92672>=</span> int, default <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>, help <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;The port your HTTP server is listening on&#39;</span>)
</span></span><span style=display:flex><span>arg_parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--https-port&#39;</span>, type <span style=color:#f92672>=</span> int, default <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>, help <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;The port your HTTPS server should listen on&#39;</span>)
</span></span><span style=display:flex><span>arg_parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--rebuild&#39;</span>, action <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;store_true&#39;</span>, help <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Force the container to rebuild&#39;</span>)
</span></span><span style=display:flex><span>args <span style=color:#f92672>=</span> arg_parser<span style=color:#f92672>.</span>parse_args()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>local_ip <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>gethostbyname(socket<span style=color:#f92672>.</span>gethostname())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_dockerfile</span>(fout):
</span></span><span style=display:flex><span>    fout<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>FROM ubuntu:16.04
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RUN apt-get update </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>    &amp;&amp; apt-get install -y nginx openssl
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RUN mkdir -p /etc/nginx/ssl/ </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>    &amp;&amp; openssl req </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>            -x509 </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>            -subj &#34;/C=US/ST=Denial/L=Nowhere/O=Dis&#34; </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>            -nodes </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>            -days 365 </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>            -newkey rsa:2048 </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>            -keyout /etc/nginx/ssl/nginx.key </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>            -out /etc/nginx/ssl/nginx.cert
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ADD nginx.conf /etc/nginx/sites-enabled/default
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ENV HTTP_PORT 80
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ENV HTTPS_PORT 443
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CMD sed -i -e &#34;s/HTTP_PORT/$HTTP_PORT/; s/HTTPS_PORT/$HTTPS_PORT/&#34; /etc/nginx/sites-enabled/default </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>    &amp;&amp; nginx </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>    &amp;&amp; tail -f /var/log/nginx/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_nginx_config</span>(fout):
</span></span><span style=display:flex><span>    fout<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>server {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    listen HTTPS_PORT ssl;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl on;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl_certificate /etc/nginx/ssl/nginx.cert;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssl_certificate_key /etc/nginx/ssl/nginx.key;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    location / {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        proxy_set_header Host $host;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        proxy_set_header X-Real-IP $remote_addr;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        proxy_set_header X-Forwarded-Proto $scheme;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        proxy_pass http://dockerhost:HTTP_PORT;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        proxy_read_timeout 90;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>build</span>():
</span></span><span style=display:flex><span>    temp_directory <span style=color:#f92672>=</span> tempfile<span style=color:#f92672>.</span>mkdtemp()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(temp_directory, <span style=color:#e6db74>&#39;Dockerfile&#39;</span>), <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> fout:
</span></span><span style=display:flex><span>        write_dockerfile(fout)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(temp_directory, <span style=color:#e6db74>&#39;nginx.conf&#39;</span>), <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> fout:
</span></span><span style=display:flex><span>        write_nginx_config(fout)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    subprocess<span style=color:#f92672>.</span>check_call(<span style=color:#e6db74>&#39;docker build -t autohttps .&#39;</span>, shell <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>, cwd <span style=color:#f92672>=</span> temp_directory)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    shutil<span style=color:#f92672>.</span>rmtree(temp_directory)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>():
</span></span><span style=display:flex><span>    subprocess<span style=color:#f92672>.</span>check_call(<span style=color:#e6db74>&#39;docker run --rm -it -e HTTP_PORT=</span><span style=color:#e6db74>{http}</span><span style=color:#e6db74> -e HTTPS_PORT=</span><span style=color:#e6db74>{https}</span><span style=color:#e6db74> --add-host=dockerhost:</span><span style=color:#e6db74>{ip}</span><span style=color:#e6db74> -p </span><span style=color:#e6db74>{https}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{https}</span><span style=color:#e6db74> autohttps&#39;</span><span style=color:#f92672>.</span>format(
</span></span><span style=display:flex><span>        http <span style=color:#f92672>=</span> args<span style=color:#f92672>.</span>http_port,
</span></span><span style=display:flex><span>        https <span style=color:#f92672>=</span> args<span style=color:#f92672>.</span>https_port,
</span></span><span style=display:flex><span>        ip <span style=color:#f92672>=</span> local_ip,
</span></span><span style=display:flex><span>    ), shell <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>rebuild:
</span></span><span style=display:flex><span>    build()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>run()
</span></span></code></pre></div><p>The main interesting bit here is the changed nginx config (the ports are now just HTTP_PORT and HTTPS_PORT) and a Docker run line that will replace those:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sed -i -e <span style=color:#e6db74>&#34;s/HTTP_PORT/</span>$HTTP_PORT<span style=color:#e6db74>/; s/HTTPS_PORT/</span>$HTTPS_PORT<span style=color:#e6db74>/&#34;</span> /etc/nginx/sites-enabled/default
</span></span></code></pre></div><p>Now we can map arbitrary ports and rebuild the container if/when things change:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ autohttps --https-port <span style=color:#ae81ff>445</span> --http-port <span style=color:#ae81ff>8000</span>
</span></span></code></pre></div><p>That will make <code>https://localhost:445</code> work and serve whatever is running on 8000. You can even run more than one of these at once if you have multiple applications you&rsquo;re testing. Neat. Also, it even works if the other application is running in a docker container as well, so long as you&rsquo;ve exposed the port so it can be seen from the localhost<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>It&rsquo;s all wrapped up in my dotfiles: <a href=https://github.com/jpverkamp/dotfiles/blob/master/bin/autohttps>autohttps</a> (that&rsquo;s why the Dockerfile and nginx config are in the Python script rather than separate files). Give it a try and let me know what you think.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://en.wikipedia.org/wiki/SSL>SSL</a> is the older protocol that later became <a href=https://en.wikipedia.org/wiki/TLS>TLS</a>. In modern applications, there is really no reason that you should actually support SSL or even TLS 1.0, but in many cases people will use the two terms interchangably.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Alternatively, you could put the two containers on the same Docker network, but I haven&rsquo;t had a need to do that yet.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
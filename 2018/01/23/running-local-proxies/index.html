<!doctype html><html><head><title>Running local proxies â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script defer src=/jquery_6894410585563545744.min.cc1cade18c999752b7befe111634889dca8d89b24923775954ecebc68c54fcd3.js integrity="sha256-zByt4YyZl1K3vv4RFjSIncqNibJJI3dZVOzrxoxU/NM="></script>
<script defer src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg="></script>
<script defer src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM="></script>
<script defer src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY="></script>
<script defer src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90="></script>
<script defer src=/custom.js></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="></script><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="></script><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="></script><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="></script><link rel=stylesheet href=/custom.css><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Running local proxies</h1><div class=entry-meta><span class=entry-date>2018-01-23</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/11/15/clock-drift-in-docker-containers/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/docker>Docker</a><a href=https://blog.jverkamp.com/2018/02/15/automatic-self-signed-https-for-local-development/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/ssh>SSH</a></li><li><a class=taxonomy-value href=/programming/topics/tor>Tor</a></li></ul></li><li><a class=taxonomy-key href=/other>other</a><ul><li><a href=https://blog.jverkamp.com/2017/12/10/migrating-to-hugo/ class=previous-link>Prev</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2018/01/23/the-fifth-elephant/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2018/01/26/the-hand-of-oberon/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>As I&rsquo;ve mentioned a couple of times recently<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, I have set a handful of different things on my local machines to make remote development a bit easier. This time around, I have two more to add to that list:</p><ul><li>Setting up a local SOCKS proxy with SSH</li><li>Setting up a local TOR proxy for testing / more anonymous browsing</li><li>Configuring your browser to use these proxies for some/all traffic</li></ul><p>In both cases, I have these running on an always-on server that I use for various projects just like this. It could just as easily be set up to run on a <a href=https://www.raspberrypi.org/>Raspberry Pi</a> or on your local machine.</p><h2 id=setting-up-a-socks-proxy>Setting up a SOCKS proxy</h2><p>First, let&rsquo;s set up a <code>SOCKS5</code> proxy. That&rsquo;s actually enough for most purposes, but if you really need an HTTP/HTTPS proxy, we can use <a href=https://www.irif.fr/~jch/software/polipo/>Polipo</a><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> on top of that.</p><p>To set up an SSH <code>SOCKS5</code> / <code>DynamicProxy</code>, the easiest way I&rsquo;ve found is to add it to your SSH config:</p><pre tabindex=0><code class=language-ssh data-lang=ssh>Host workproxy
    HostName bastion.example.com
    User jp
    Port 6622
    DynamicForward 7769
</code></pre><p>In this case, <code>bastion.example.com</code> is running SSH on port 6622, which we are connection to. We&rsquo;re then setting up the local port <code>7769</code> to accept incoming connections on the <code>SOCKS5</code> protocol. Then you open the tunnel with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh workproxy
</span></span></code></pre></div><p>The SSH connection has to stay open in order to use the proxy, so it&rsquo;s best if you run it in a <a href=https://github.com/tmux/tmux/wiki>tmux</a> or <a href=https://www.gnu.org/software/screen/>screen</a> session (I prefer tmux personally). You could also use something like <a href=http://www.debianadmin.com/autossh-automatically-restart-ssh-sessions-and-tunnels.html>autossh</a> to automatically restart it, but thus far, I&rsquo;ve not particularly found it necessary.</p><h2 id=adding-an-httphttps-proxy>Adding an HTTP/HTTPS proxy</h2><p>In most cases, that&rsquo;s all you need.</p><p>When I first set this up, I also wanted to be able to use an HTTP/HTTPS proxy, which meant that I wanted to use something like <a href=https://www.irif.fr/~jch/software/polipo/>Polipo</a><sup id=fnref1:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. Apparently though, in the face of pervasive HTTPS traffic, Polipo has is no longer being maintained. I actually learned this as I was writing the post. TIL.</p><p>In any case, the set up I had for Polipo was:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ polipo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    socksProxyType<span style=color:#f92672>=</span>socks5 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    socksParentProxy<span style=color:#f92672>=</span>192.168.0.50:7769  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    proxyPort<span style=color:#f92672>=</span><span style=color:#ae81ff>7770</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    proxyAddress<span style=color:#f92672>=</span>::0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    allowedClients<span style=color:#f92672>=</span>192.168.0.0/24 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    logFile<span style=color:#f92672>=</span>/dev/stdout <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    logLevel<span style=color:#f92672>=</span>0xFF
</span></span></code></pre></div><p><code>socksProxyType</code> tells it that we&rsquo;re going to use an SSH <code>DynamicTunnel</code> proxy and <code>socksParentProxy</code> tells Polipo where it is. <code>proxyPort</code> is where the new Polipo proxy will be listening, while <code>proxyAddress</code> is necessary so that hosts on other machines can here it as well (this could be far more restrictive, but I&rsquo;m using my router to prevent external traffic to that port, so I don&rsquo;t have to limit this). <code>allowedClients</code> lets other hosts on the same network connect and the last two options are just for logging.</p><p>That&rsquo;s really it. Set the <code>HTTP_PROXY</code> / <code>HTTPS_PROXY</code> environment variables (possibly with <a href=https://blog.jverkamp.com/2017/12/13/dynamic-automatic-proxies/>Dynamic Automatic Proxies</a> ðŸ˜„) and many things will automatically use it. That&rsquo;s actually why I still have Polipo still running despite the deprecation warning. It does what I need it to do, in particularly when using the AWS CLI and/or the Python <a href=http://docs.python-requests.org/en/master/>requests</a> library, which both accept HTTP/HTTPS proxies, but not SOCKS5.</p><p>If/when I can figure out how to configure those to use SOCKS5<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>, I can stop running Polipo, but until then, this works.</p><h2 id=setting-up-a-tor-proxy>Setting up a TOR proxy</h2><p>Next up, we can use a TOR proxy. If you absolutely need a guarantee that none of your traffic is going to leak your identity (for any number of reasons), this is probably not the way you want to go. If that&rsquo;s the case, you should at least be running the <a href=https://www.torproject.org/projects/torbrowser.html.en>Tor Browser</a>. Or even better yet, run <a href=https://tails.boum.org/>Tails</a> in a <a href=https://en.wikipedia.org/wiki/virtual%20machine>virtual machine</a> on a <a href=https://en.wikipedia.org/wiki/burner%20laptop>burner laptop</a>.</p><p>However, if you&rsquo;re just looking for a basic / better than nothing level of anonymity&ndash;which I generally use for testing things that should be restricted to internal networks or behave differently on externals ones.</p><p>In order to do this, you could either set up Tor yourself (which isn&rsquo;t that bad, but is a bit more involved) or you could just use <a href=https://github.com/dperson/torproxy>this</a> <a href=https://www.docker.com/>Docker</a> image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it -p 8118:8118 -p 9050:9050 -d dperson/torproxy
</span></span></code></pre></div><p>That&rsquo;s it. It exposes a SOCKS5 proxy that routes to the TOR network on port 9050. That&rsquo;s it. If you wanted, you could put Polipo in front of it same as above for an HTTP/HTTPS proxy, but I haven&rsquo;t needed to.</p><h2 id=configuring-your-browser>Configuring your browser</h2><p>Finally, we want to be able to use a browser to actually use these proxies. <a href=https://blog.jverkamp.com/2013/05/18/firefox-vs-chrome/>Since 2013</a>, I&rsquo;ve been using Chrome. For proxying, <a href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif?hl=en">Proxy SwitchyOmega</a> works pretty well.</p><p>In order to use the SSH proxy, we set the host and port and then set the protocol to SOCKS5:</p><figure><img src=/embeds/2018/proxy-switchyomega-ssh.png></figure><p>Likewise for TOR:</p><figure><img src=/embeds/2018/proxy-switchyomega-tor.png></figure><p>One thing that I particularly enjoy about Proxy SwitchOmega is the ability to dynamically choose proxies based on hostname. For example, if I wanted to visit a <a href=https://en.wikipedia.org/wiki/.onion>.onion</a> domain (only available via Tor), I could set up a rule like this:</p><figure><img src=/embeds/2018/proxy-switchyomega-onion.png></figure><p>That way, normal traffic will not be proxied, but if I tried to go to <a href=https://facebookcorewwwi.onion/>https://facebookcorewwwi.onion/</a> (for example)<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>, it will automatically use my Tor proxy.</p><p>Neat.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://blog.jverkamp.com/2017/12/13/dynamic-automatic-proxies/>Dynamic Automatic Proxies</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://blog.jverkamp.com/2017/12/18/ssh-config-proxycommand-tricks/>SSH Config ProxyCommand Tricks</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Which is apparently no longer being maintained? I had no idea. It works for what I&rsquo;m using it for though?&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>It might be easy, I honestly haven&rsquo;t tried since Polipo just worksâ„¢.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Yup. Facebook via HTTPS via a Tor hidden service.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/other/atom.xml>RSS: other<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
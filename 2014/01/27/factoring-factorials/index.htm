<!DOCTYPE html>
<html>
<head>
        
        

        <title>Factoring factorials | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Factoring factorials</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2014-01-27"><span class="year">2014</span> <span class="month">Jan</span> <span class="day">27</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-topic/mathematics">Mathematics</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/mathematics/prime-numbers">Prime Numbers</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/number-theory">Number Theory</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/mathematics/factorials">Factorials</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>There was <a href="http://programmingpraxis.com/2014/01/24/factoring-factorials/">a new post</a> on Programming Praxis a few days ago that seemed pretty neat:</p>
<blockquote>Given a positive integer n, compute the prime factorization, including multiplicities, of n! = 1 · 2 · … · n. You should be able to handle very large n, which means that you should not compute the factorial before computing the factors, as the intermediate result will be extremely large.</blockquote>
<!--more-->
<p>The simple solution would be to directly use the <code><a href="http://docs.racket-lang.org/search/index.html?q=math/number-theory">math/number-theory</a></code> module:</p>
<pre class="scheme"><code>(require math/number-theory)
(define (factor-factorial n)
  (factorize (factorial n)))</code></pre>
<p>Quick to write and not terribly slow to run either:</p>
<pre class="scheme"><code>&gt; (time (factor-factorial 10))
cpu time: 0 real time: 0 gc time: 0
'((2 8) (3 4) (5 2) (7 1))

&gt; (time (factor-factorial 100))
...
cpu time: 359 real time: 356 gc time: 233

&gt; (time (factor-factorial 250))
...
cpu time: 4071 real time: 4111 gc time: 2243</code></pre>
<p>As hinted at in the problem statement though, we can do better.</p>
<p>First of all, we don't have to recalculate factors. We're going to be calculating a lot of factors, each of which depends on others in turn. So let's take a hint from <a href="https://en.wikipedia.org/wiki/dynamic_programming">dynamic programming</a> and <a href="https://en.wikipedia.org/wiki/memoization">memoization</a> and keep a hash around of all the values we've factored thus far. Something like this:</p>
<pre class="scheme"><code>; Memoized version of prime factorization
(splicing-let ([cache (make-hash)])
  (hash-set! cache 1 (hash 1 1))
  (hash-set! cache 2 (hash 2 1))
  (define (prime-factors n)
    (hash-ref!
     cache n
     (thunk
       (or
        (for/first ([i (in-range 2 (add1 (sqrt n)))]
                    #:when (zero? (remainder n i)))
          (merge-hashes (prime-factors i) (prime-factors (/ n i))))
        (hash n 1))))))</code></pre>
<p>There are a few neat pieces in that, which help a bit to make it more concise. First, <code><a href="http://docs.racket-lang.org/search/index.html?q=splicing-let">splicing-let</a></code> from <code><a href="http://docs.racket-lang.org/search/index.html?q=racket/splicing">racket/splicing</a></code>. Basically, it's like a <code>let</code> in that the binding (the <code>cache</code>) is only visible within it's body, but unlike that, any <code>define</code> or similar form within it is at the outer scope. So we can call <code>prime-factors</code> even though we aren't in the let. Technically, this code would have done roughly the same thing:</p>
<pre class="scheme"><code>(define prime-factors
  (let ([cache (make-hash)])
    (λ (n)
      ...)))</code></pre>
<p>But I've never particularly cared for that form. It's always seemed a bit ugly to me to split up the function name and actual definition (the λ) like that, even if it is a bit more clear how the scope goes. Either way works, however.</p>
<p>The next neat part is the use of <code><a href="http://docs.racket-lang.org/search/index.html?q=hash-ref!">hash-ref!</a></code>. I wish I'd known about that years ago, but I can definitely use it now. Basically, it combines a <code>hash-ref</code> with a default value that is actually stored in the hash if it didn't previously exist. So it saves us the effort of checking first and updating if something is missing then returning.</p>
<p>Finally, we have the <code><a href="http://docs.racket-lang.org/search/index.html?q=for/first">for/first</a></code> form. Basically, it's a <code>for</code> looping macro, but it will stop immediately the first time the body is executed. In this case, we'll run up from 2 to the square root, looking for any divisor. But since we're using <code>for/first</code>, it will short circuit with the first divisor and use the cache to avoid recalculating the same factors over and over again.</p>
<p>The final piece is <code>merge-hashes</code>. This isn't actually part of Racket, we'll have to write it ourselves:</p>
<pre class="scheme"><code>; Combine two hashes with numeric values by adding the values
(define (merge-hashes h1 h2)
  (define h (hash-copy h1))
  (for ([(k v) (in-hash h2)])
    (hash-update! h k (curry + v) 0))
  h)</code></pre>
<p>Here's another neat hash function I wish I'd known about: <code><a href="http://docs.racket-lang.org/search/index.html?q=hash-update!">hash-update!</a></code>. Basically, you give it a key and update function. That update function is given the value at the key and gives back the new value to store. If the key doesn't exist, it uses the default. One note is that apparently the default value is passed to the update function as well. That certainly caused an interesting bug to track down... Oh, and the <code><a href="http://docs.racket-lang.org/search/index.html?q=curry">curry</a></code>:</p>
<pre class="scheme"><code>(curry + v)
&lt;=&gt;
(λ (var) (+ var v))</code></pre>
<p>It's a trick that I picked up when playing with <a href="http://www.haskell.org/haskellwiki/Haskell">Haskell</a>. It's pretty much necessary there (every function is curried), but it's kind of neat to use in Racket. It saves a few λs at the very least.</p>
<p>Well, now we can factor things quickly. The next trick will be to speed up factoring factors. We don't want to actually calculate the factorial first, so instead we'll build up the factor list as we go:</p>
<pre class="scheme"><code>; Factor n! without actually calculating the factorial first
(define (factor-factorial n)
  (for/fold ([factors (hash)]) ([i (in-range 2 (+ n 1))])
    (merge-hashes factors (prime-factors i))))</code></pre>
<p><code><a href="http://docs.racket-lang.org/search/index.html?q=for/fold">for/fold</a></code>, in this case, takes one or more accumulators (the hash) and one or more normal <code>for</code> terms. Each body will update the accumulators. Basically, it's the generic form that could be used to build all of the other for macros. Same as <code>fold</code> can be used to build rather a lot of other recursive functions.</p>
<p>And there we have it. A quick printing function (code on <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/factoring-factorials.rkt">GitHub</a>) and we can compare to the naïve solution:</p>
<pre class="scheme"><code>&gt; (time (print-factor-list (factor-factorial 10)))
2^8 + 3^4 + 5^2 + 7^1
cpu time: 0 real time: 3 gc time: 0

&gt; (time (print-factor-list (factor-factorial 100)))
...
cpu time: 0 real time: 1 gc time: 0

&gt; (time (print-factor-list (factor-factorial 250)))
...
cpu time: 0 real time: 2 gc time: 0</code></pre>
<p>...</p>
<p>...</p>
<p>Yup.</p>
<p>That's faster. That's a lot faster.</p>
<pre class="scheme"><code>&gt; (time (length (hash-keys (factor-factorial 10000))))
cpu time: 1123 real time: 1134 gc time: 1015
1229</code></pre>
<p>So there are 1229 unique prime factors of 10,000! (which we can check with <a href="http://www.wolframalpha.com/input/?i=prime+factors+of+10000%21">Wolfram Alpha</a>, the number of factors is at the bottom). What's even better is that most of that time actually goes into the <code>length</code> and <code>hash-keys</code> functions. If you run just the <code>factor-factorial</code> function:</p>
<pre class="scheme"><code>&gt; (time (begin (factor-factorial 10000) (void)))
cpu time: 187 real time: 181 gc time: 47</code></pre>
<p>Shiny.</p>
<p>If you'd like to check out the entire code, you can do so on GitHub: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/factoring-factorials.rkt">factor-factorial.rkt</a></p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Factoring factorials";
var disqus_url = "http://blog.jverkamp.com/2014/01/27/factoring-factorials/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2014/01/15/graph-coloring">← Graph coloring</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2014/02/15/the-lego-movie">The Lego Movie →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2014/01/15/graph-coloring">← Graph coloring</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2014/02/16/exploring-parallelism-in-racket-with-sha-512-mining">Exploring parallelism in Racket with SHA-512 mining →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
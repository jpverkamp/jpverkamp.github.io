<!DOCTYPE html>
<html>
<head>
        
        

        <title>CSRF protection injection with jQuery and Zend | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Pretty pretty fonts -->
        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Calligraffitti" />

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="http://blog.jverkamp.com/category/archives/2015">2015</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/book-reviews">Book Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="http://blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">CSRF protection injection with jQuery and Zend</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2014-01-13"><span class="year">2014</span> <span class="month">Jan</span> <span class="day">13</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-language/javascript">JavaScript</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/php">PHP</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/security">Security</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/web-development">Web Development</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/php/zend">Zend</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/javascript/jquery">jQuery</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p><a href="https://en.wikipedia.org/wiki/Cross-site_request forgery">Csrf</a> attacks are among the most common vulnerabilities against websites, listed as <a href="https://www.owasp.org/index.php/Top_10_2013-A8-Cross-Site_Request_Forgery_(CSRF)">number 8</a> on <a href="https://www.owasp.org/index.php/Top_10_2013-Top_10">OWASP's 2013 Top 10 list</a>.</p>
<!--more-->
<p>A CSRF attack involves an attacker identifying some state changing URL within a web application. Say, for example, that you have a website where you can change a user's nickname like this:</p>
<pre class="html"><code>POST /change-nickname.php

new-nickname=...</code></pre>
<p>In that case, an attacker could copy the URL, edit the new nickname field, and send you a link via IM. So long as you're already logged into the site, when you click the link, the browser will helpfully send along your session information to the server and your username is changed.</p>
<p>How can you fix that though? You need the browser to automatically send session information since HTTP is a stateless protocol. Without that, it's much more difficult to maintain long running sessions.</p>
<p>What we really need is some bit of information that the client will send along with requests if they come from our server, but that won't be sent along if the user just clicks on a random link. You could do this by sending along a random token, stored in the session:</p>
<pre class="php"><code>// change-nickname.php
&lt;?php
session_start();

// Choose a CSRF token if one hasn't already been assigned, tokens are unique to each user
if (!isset($_SESSION['csrf-token'])) {
    $_SESSION['csrf-token'] = base64_encode(openssl_random_pseudo_bytes(4));
}

// Check if the user is trying to update the page
if (isset($_POST['new-nickname'])) {
    // Validate the CSRF token
    if (isset($_POST['csrf-token']) && $_POST['csrf-token'] == $_SESSION['csrf_token']) {
        { ... logic to change nickname ... }
    } else {
        { ... logic to log CSRF validation failures ... }
    }
}

// Otherwise, send the update nickname form
} else {
?&gt;
&lt;form method="POST" action="/change-nickname.php"&gt;
    &lt;input type="hidden" name="csrf-token" value="&lt;?= $_SESSION['csrf-token'] ?&gt;" /&gt;
    &lt;input name="new-nickname" /&gt;
    &lt;input type="submit" /&gt;
&lt;/form&gt;
&lt;?php
}
?&gt;</code></pre>
<p>This way, we'll send the CSRF token with the page and the client will automatically send it back--but only if they use our form. If the attacker could guess the session token, they could of course send it along as well, but assuming that we're using HTTPS for communication and a random (enough) token, this shouldn't be possible.</p>
<p>So this works. But what if you have a much larger code base? Do you really want to embed the CSRF token in every single form that you make? And what if you're using Ajax requests? It turns out that there's a much more elegant solution.</p>
<p>What we want to do is use jQuery to inject CSRF tokens into every request and every form. Then on the PHP end, we'll use Zend's plugin framework to check every post request for this token. That way, every bit of code you write is automatically protected and the protection is centralized if you ever have to make a change. Sounds good, yes?</p>
<p>First, the jQuery. We'll still need a bit of PHP to send the CSRF token from the server to the client. Something like this:</p>
<pre class="php"><code>// index.php
&lt;script type="text/javascript"&gt;
csrf_token = '&lt;?= $_SESSION['csrf-token']; ?&gt;';
&lt;/script&gt;</code></pre>
<p>Yes, it's a global variable, but you could wrap that up in whatever other JavaScript objects you are already creating easily enough.</p>
<p>After that, we want to hook into all jQuery Ajax requests. The <code>ajaxPrefilter</code> function will do exactly what we want. It's called before any call to <code>$.ajax</code>, including functions that use it, such as <code>$.post</code> and friends.</p>
<pre class="javascript"><code>$.ajaxPrefilter(function(options) {
    if (options.type === 'POST') {
        options.data = options.data || {};
        options.data['csrf-token'] = csrf_token;
    }
});</code></pre>
<p>That will add an additional field to any POST request. It doesn't protect against other types (such as GET), but that should be easy enough to change.</p>
<p>For the other half (forms that don't use Ajax, as in the original example), we need to get a little more sneaky. What we want is to add a event listener for form submits that will globally trigger on any form--even those that are added dynamically. Luckily, jQuery's <code>on</code> has exactly what we need:</p>
<pre class="javascript"><code>$(document).on('submit', 'form'), function(evt) {
    var form = $(e.target);
    if (form.attr('action') && form.attr('action').toUpperCase() === 'POST') {
        form.not(':has(input#csrf-token)').append(
            '&lt;input type="hidden" id="csrf-token" name="csrf-token" value="' + csrf_token + '" /&gt;'
        );
    }
});</code></pre>
<p>One note for both of these methods is that they will add the CSRF token to <em>every</em> request, even those that are going to other sites. For the increasingly common practice of mashups, this won't be quite what you want, but it shouldn't be difficult to add.</p>
<p>On the server side, we want to write a <code>Zend_Controller_Plugin_Abstract</code>, specifically the <code>preDispatch</code> function. Like the <code>ajaxPrefilter</code> function, this can be used to apply to <em>all</em> requests, globally enabling CSRF protection. We'll want something like this:</p>
<pre class="php"><code>// CSRFPlugin.php
&lt;?php
class CSRFPlugin extends Zend_Controller_Plugin_Abstract {
    public function preDispatch(Zend_Controller_Request_Abstract $request) {
        if (request-&gt;getMethod() == 'POST') {
            if (!isset($_POST['csrf-token']) || $_POST['csrf-token'] != $_SESSION['csrf-token']) {
                { ... logic to log CSRF validation failures ... }
                exit(); // Stop the request from processing
            }
        }
   }
}
?&gt;

// index.php
&lt;?php
Zend_Controller_Front::getInstance()-&gt;registerPlugin(new CSRFPlugin());
?&gt;</code></pre>
<p>And that's all you need. Of course, in practice you'd likely want to more tightly integrate this with your own code base (use structures that you're already creating / hooking into error reporting frameworks / better filtering for requests that need or don't need CSRF protection), but at least it's a start.</p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "CSRF protection injection with jQuery and Zend";
var disqus_url = "http://blog.jverkamp.com/2014/01/13/csrf-protection-injection-with-jquery-and-zend/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2014/01/11/chapter-20-the-morning-after">← Chapter 20 -- The Morning After</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2014/01/14/graph-radius">Graph radius →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2014/01/03/overlapping-circles">← Overlapping circles</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2014/01/14/graph-radius">Graph radius →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
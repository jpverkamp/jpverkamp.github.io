<!doctype html><html><head><title>What the (be)fungeâ€½ â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet><link rel=stylesheet href=/custom.css defer><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>What the (be)fungeâ€½</h1><div class=entry-meta><span class=entry-date>2014-06-10</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2014/06/11/call-stack-bracket-matcher/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2014/06/11/call-stack-bracket-matcher/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/12/31/parallel-bf/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/esolangs>Esolangs</a><a href=https://blog.jverkamp.com/2017/12/25/aoc-2017-day-25-turing/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2014/06/11/call-stack-bracket-matcher/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2014/06/08/x-men-days-of-future-past/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2014/06/11/call-stack-bracket-matcher/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Here&rsquo;s a fun little bit of code for you:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>55*4*v    _   v
</span></span><span style=display:flex><span>v   &lt;&gt;:1-:^
</span></span><span style=display:flex><span>    |:&lt;$      &lt;    ,*48 &lt;
</span></span><span style=display:flex><span>    @&gt;0<span style=color:#e6db74>&#34;zzif&#34;</span>&gt;:#,_$      v
</span></span><span style=display:flex><span>&gt;:3%!|    &gt;0<span style=color:#e6db74>&#34;zzub&#34;</span>&gt;:#,_$^
</span></span><span style=display:flex><span>     &gt;:5%!|
</span></span><span style=display:flex><span>v <span style=color:#e6db74>&#34;buzz&#34;</span>0&lt;&gt;:.           ^
</span></span><span style=display:flex><span>         |!%5:           &lt;
</span></span><span style=display:flex><span>&gt;:#,_   $&gt;              ^
</span></span></code></pre></div><p>Gibberish you say? No! <a href=https://en.wikipedia.org/wiki/Befunge>Befuge</a>!</p><p>More specifically:</p><blockquote><p>Befunge is a stack-based, reflective, esoteric programming language. It differs from conventional languages in that programs are arranged on a two-dimensional grid. &ldquo;Arrow&rdquo; instructions direct the control flow to the left, right, up or down, and loops are constructed by sending the control flow in a cycle. It has been described as &ldquo;a cross between Forth and Lemmings.&rdquo;</p></blockquote><p>&ndash; <a href=https://en.wikipedia.org/wiki/Befunge>Wikipedia</a></p><p>There&rsquo;s not much of a write up this time, since pretty much the entire code is the state machine that actually drives the language. We&rsquo;ll go ahead and assume that we have a whole suite of helper functions (see <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/befunge.rkt>GitHub</a> for details):</p><ul><li><code>wrapped-vector-ref</code> - <code>vector-ref </code>where indexes out of bounds wrap</li><li><code>wrapped-vector-set!</code> - likewise for <code>vector-set!</code></li><li><code>grid-ref</code> - ref for a vector of vectors, using wrapping</li><li><code>grid-set!</code> - set! for a vector of vectors</li><li><code>read-befunge</code> - read a befunge program from input</li><li><code>write-befunge</code> - write a befunge grid out for debugging</li></ul><p>Next, we have the state of the machine. I&rsquo;ll store it in a parameter, so we can access it from a number of helper functions (up in a bit):</p><h3 id=state-functions>State functions</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Befunge state</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> state (<span style=color:#a6e22e>x</span> y facing stack grid running) <span style=color:#f92672>#</span>:transparent <span style=color:#f92672>#</span>:mutable)
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>current-state (<span style=color:#a6e22e>make-parameter</span> <span style=color:#66d9ef>#f</span>))
</span></span></code></pre></div><p>Next, said helpers to manipulate the stack, move the pointer, and get the current character. All of them are safe to use even if there is no current state, they just won&rsquo;t do anything.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Stack maniuplation. Pop 0 on an empty stack</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>pop!</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (<span style=color:#a6e22e>current-state</span>)
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>stack (<span style=color:#a6e22e>state-stack</span> (<span style=color:#a6e22e>current-state</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>if </span>(null? stack)
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>begin0</span>
</span></span><span style=display:flex><span>          (car stack)
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>set-state-stack!</span> (<span style=color:#a6e22e>current-state</span>) (cdr stack))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>push!</span> v)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (<span style=color:#a6e22e>current-state</span>)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>set-state-stack!</span> (<span style=color:#a6e22e>current-state</span>) (cons v (<span style=color:#a6e22e>state-stack</span> (<span style=color:#a6e22e>current-state</span>))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Move in the current direction</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>move!</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (<span style=color:#a6e22e>current-state</span>)
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>state-facing</span> (<span style=color:#a6e22e>current-state</span>))
</span></span><span style=display:flex><span>      [(<span style=color:#a6e22e>right</span>) (<span style=color:#a6e22e>set-state-x!</span> (<span style=color:#a6e22e>current-state</span>) (+ (<span style=color:#a6e22e>state-x</span> (<span style=color:#a6e22e>current-state</span>)) <span style=color:#ae81ff>1</span>))]
</span></span><span style=display:flex><span>      [(<span style=color:#a6e22e>left</span>)  (<span style=color:#a6e22e>set-state-x!</span> (<span style=color:#a6e22e>current-state</span>) (- (<span style=color:#a6e22e>state-x</span> (<span style=color:#a6e22e>current-state</span>)) <span style=color:#ae81ff>1</span>))]
</span></span><span style=display:flex><span>      [(<span style=color:#a6e22e>down</span>)  (<span style=color:#a6e22e>set-state-y!</span> (<span style=color:#a6e22e>current-state</span>) (+ (<span style=color:#a6e22e>state-y</span> (<span style=color:#a6e22e>current-state</span>)) <span style=color:#ae81ff>1</span>))]
</span></span><span style=display:flex><span>      [(<span style=color:#a6e22e>up</span>)    (<span style=color:#a6e22e>set-state-y!</span> (<span style=color:#a6e22e>current-state</span>) (- (<span style=color:#a6e22e>state-y</span> (<span style=color:#a6e22e>current-state</span>)) <span style=color:#ae81ff>1</span>))])))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Get the current character from the state</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>grid-@</span>)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>if </span>(<span style=color:#a6e22e>current-state</span>)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>grid-ref</span> (<span style=color:#a6e22e>state-grid</span> (<span style=color:#a6e22e>current-state</span>)) 
</span></span><span style=display:flex><span>                (<span style=color:#a6e22e>state-x</span> (<span style=color:#a6e22e>current-state</span>)) 
</span></span><span style=display:flex><span>                (<span style=color:#a6e22e>state-y</span> (<span style=color:#a6e22e>current-state</span>)))
</span></span><span style=display:flex><span>      <span style=color:#e6db74>#\space</span>))
</span></span></code></pre></div><h3 id=stepper>Stepper</h3><p>Now it&rsquo;s just a literal translation of the instructions into state transitions. I&rsquo;ll have one function to advance the state to make it easier to make a debugging rendering function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Advance the befunge program to the next step</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>step!</span>)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>and </span>(<span style=color:#a6e22e>current-state</span>) (<span style=color:#a6e22e>state-running</span> (<span style=color:#a6e22e>current-state</span>)))
</span></span><span style=display:flex><span>    <span style=color:#75715e>; Decode the next instruction</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>define </span>cmd (<span style=color:#a6e22e>grid-@</span>))
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>case </span>cmd
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Push this number on the stack</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\0</span> <span style=color:#e6db74>#\1</span> <span style=color:#e6db74>#\2</span> <span style=color:#e6db74>#\3</span> <span style=color:#e6db74>#\4</span> <span style=color:#e6db74>#\5</span> <span style=color:#e6db74>#\6</span> <span style=color:#e6db74>#\7</span> <span style=color:#e6db74>#\8</span> <span style=color:#e6db74>#\9</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> (string-&gt;number (string cmd)))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Addition: Pop a and b, then push a+b</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Subtraction: Pop a and b, then push b-a</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Multiplication: Pop a and b, then push a*b</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Integer division: Pop a and b, then push b/a, rounded down. If a is zero, ask the user what result they want.[dubious â€“ discuss]</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Modulo: Pop a and b, then push the remainder of the integer division of b/a. If a is zero, ask the user what result they want.[dubious â€“ discuss]</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Greater than: Pop a and b, then push 1 if b&gt;a, otherwise zero.</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\+</span> <span style=color:#e6db74>#\-</span> <span style=color:#e6db74>#\*</span> <span style=color:#e6db74>#\/</span> <span style=color:#e6db74>#\%</span> <span style=color:#e6db74>#\`</span>)
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>a (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>b (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>op (cdr (assoc cmd <span style=color:#f92672>`</span>((<span style=color:#e6db74>#\+</span> <span style=color:#f92672>.</span> <span style=color:#f92672>,</span>+) 
</span></span><span style=display:flex><span>                                    (<span style=color:#e6db74>#\-</span> <span style=color:#f92672>.</span> <span style=color:#f92672>,</span>-) 
</span></span><span style=display:flex><span>                                    (<span style=color:#e6db74>#\*</span> <span style=color:#f92672>.</span> <span style=color:#f92672>,</span>*)
</span></span><span style=display:flex><span>                                    (<span style=color:#e6db74>#\/</span> <span style=color:#f92672>.</span> <span style=color:#f92672>,</span>quotient) 
</span></span><span style=display:flex><span>                                    (<span style=color:#e6db74>#\%</span> <span style=color:#f92672>.</span> <span style=color:#f92672>,</span>remainder)
</span></span><span style=display:flex><span>                                    (<span style=color:#e6db74>#\`</span> <span style=color:#f92672>.</span> <span style=color:#f92672>,</span>(<span style=color:#a6e22e>Î»</span> (<span style=color:#a6e22e>b</span> a) (<span style=color:#66d9ef>if </span>(&gt; b a) <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>)))))))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> (<span style=color:#a6e22e>op</span> b a))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Logical NOT: Pop a value. If the value is zero, push 1; otherwise, push zero.</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\!</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> (<span style=color:#66d9ef>if </span>(zero? (<span style=color:#a6e22e>pop!</span>)) <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Change direction</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\&gt;</span> <span style=color:#e6db74>#\&lt;</span> <span style=color:#e6db74>#\^</span> <span style=color:#e6db74>#\v</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>set-state-facing!</span> (<span style=color:#a6e22e>current-state</span>) (cdr (assoc cmd <span style=color:#f92672>`</span>((<span style=color:#e6db74>#\&gt;</span> <span style=color:#f92672>.</span> right) 
</span></span><span style=display:flex><span>                                                            (<span style=color:#e6db74>#\&lt;</span> <span style=color:#f92672>.</span> left) 
</span></span><span style=display:flex><span>                                                            (<span style=color:#e6db74>#\^</span> <span style=color:#f92672>.</span> up) 
</span></span><span style=display:flex><span>                                                            (<span style=color:#e6db74>#\v</span> <span style=color:#f92672>.</span> down)))))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Start moving in a random cardinal direction</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\?</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>set-state-facing!</span> (<span style=color:#a6e22e>current-state</span>) (list-ref <span style=color:#f92672>`</span>(<span style=color:#a6e22e>right</span> left up down) (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>4</span>)))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Pop a value; move right if value=0, left otherwise</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\_</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>set-state-facing!</span> (<span style=color:#a6e22e>current-state</span>) (<span style=color:#66d9ef>if </span>(zero? (<span style=color:#a6e22e>pop!</span>)) <span style=color:#e6db74>&#39;right</span> <span style=color:#e6db74>&#39;left</span>))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Pop a value; move down if value=0, up otherwise</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\|</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>set-state-facing!</span> (<span style=color:#a6e22e>current-state</span>) (<span style=color:#66d9ef>if </span>(zero? (<span style=color:#a6e22e>pop!</span>)) <span style=color:#e6db74>&#39;down</span> <span style=color:#e6db74>&#39;up</span>))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Start string mode: push each character&#39;s ASCII value all the way up to the next &#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Note: uses one fuel</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\q</span>uote) <span style=color:#75715e>; (should be a quote character but that breaks syntax highlighting)</span>
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>move!</span>)
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define </span>c (<span style=color:#a6e22e>grid-@</span>))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>when</span> (not (equal? c <span style=color:#e6db74>#\q</span>uote)) <span style=color:#75715e>; ditto</span>
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>push!</span> (char-&gt;integer c))
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>loop</span>)))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Duplicate value on top of the stack</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\ðŸ˜„</span>
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>v (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> v)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> v)]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Swap two values on top of the stack</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\\</span>)
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>a (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>b (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> a)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> b)]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Pop value from the stack and discard it</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\$</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>pop!</span>)]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Pop value and output as an integer</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\.</span>)
</span></span><span style=display:flex><span>       (display (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (display <span style=color:#e6db74>&#34; &#34;</span>)]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Pop value and output as ASCII character</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\,</span>)
</span></span><span style=display:flex><span>       (display (integer-&gt;char (<span style=color:#a6e22e>pop!</span>)))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Trampoline: Skip next cell</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\#</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>move!</span>)]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; A &#34;put&#34; call (a way to store a value for later use).</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Pop y, x and v, then change the character at the position (x,y)</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; in the program to the character with ASCII value v</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\p</span>)
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>y (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>x (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>v (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>grid-set!</span> (<span style=color:#a6e22e>state-grid</span> (<span style=color:#a6e22e>current-state</span>))
</span></span><span style=display:flex><span>                  x y 
</span></span><span style=display:flex><span>                  (<span style=color:#a6e22e>with-handlers</span> ([exn? (<span style=color:#a6e22e>Î»</span> _ v)])
</span></span><span style=display:flex><span>                    (integer-&gt;char v)))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; A &#34;get&#34; call (a way to retrieve data in storage). </span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Pop y and x, then push ASCII value of the character at that position in the program</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\g</span>)
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>y (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>x (<span style=color:#a6e22e>pop!</span>))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>v (<span style=color:#a6e22e>grid-@</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> (<span style=color:#66d9ef>if </span>(number? v) v (char-&gt;integer v)))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Ask user for a number and push it</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\&amp;</span>)
</span></span><span style=display:flex><span>       (display <span style=color:#e6db74>&#34;Enter a number: &#34;</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> (<span style=color:#a6e22e>read</span>))]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Ask user for a character and push its ASCII value</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\~</span>)
</span></span><span style=display:flex><span>       (display <span style=color:#e6db74>&#34;Enter a character: &#34;</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>push!</span> (<span style=color:#a6e22e>read-char</span>))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>newline</span>)]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; End program</span>
</span></span><span style=display:flex><span>      [(<span style=color:#e6db74>#\@</span>)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>set-state-running!</span> (<span style=color:#a6e22e>current-state</span>) <span style=color:#66d9ef>#f</span>)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>move!</span>)))
</span></span></code></pre></div><p>There are a few interesting cases:</p><ul><li><code>#\"</code> - nested loop to read the rest of a string (counts as one &lsquo;step&rsquo;)</li><li><code>#\\#</code> - one <code>move!</code> is called here, the next at the end of the function</li><li><code>#\p</code> - we&rsquo;re extending support out to the full <a href=https://en.wikipedia.org/wiki/Unicode>Unicode</a> character set, but not every integer represents a code point, so for those store the number instead</li><li><code>#\@</code> - trust that the caller will actually check the <code>state-running</code> parameter</li></ul><h3 id=main-loop>Main loop</h3><p>Around that, we need a loop that just keeps calling <code>step!</code> until <code>state-running</code> is false. Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Run a befunge program</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>run-befunge</span> [input   (<span style=color:#a6e22e>current-input-port</span>)] 
</span></span><span style=display:flex><span>                     <span style=color:#f92672>#</span>:debug  [debug <span style=color:#66d9ef>#f</span>] 
</span></span><span style=display:flex><span>                     <span style=color:#f92672>#</span>:fuel   [fuel +inf<span style=color:#f92672>.</span><span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Load the grid</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>grid
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>      [(input-port? input) (<span style=color:#a6e22e>read-befunge</span> input)]
</span></span><span style=display:flex><span>      [(string? input) (<span style=color:#a6e22e>call-with-input-string</span> input read-befunge)]
</span></span><span style=display:flex><span>      [(vector? input) input]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Set up initial state (x y facing stack grid running)</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>parameterize</span> ([current-state (<span style=color:#a6e22e>state</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#e6db74>&#39;right</span> <span style=color:#f92672>&#39;</span>() grid <span style=color:#66d9ef>#t</span>)])
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>let </span>loop ([step <span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>when</span> (<span style=color:#66d9ef>and </span>(<span style=color:#a6e22e>state-running</span> (<span style=color:#a6e22e>current-state</span>))
</span></span><span style=display:flex><span>                 (&lt; step fuel))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>when</span> debug
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>write-befunge</span> (<span style=color:#a6e22e>state-grid</span> (<span style=color:#a6e22e>current-state</span>)))
</span></span><span style=display:flex><span>          (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;~a x ~a, ~a\nstack: ~a\n\n&#34;</span> 
</span></span><span style=display:flex><span>                  (<span style=color:#a6e22e>state-x</span> (<span style=color:#a6e22e>current-state</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#a6e22e>state-y</span> (<span style=color:#a6e22e>current-state</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#a6e22e>state-facing</span> (<span style=color:#a6e22e>current-state</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#a6e22e>state-stack</span> (<span style=color:#a6e22e>current-state</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>step!</span>)
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>loop</span> (+ step <span style=color:#ae81ff>1</span>))))))
</span></span></code></pre></div><p>I went ahead and stuck in a debug view (which will print out the grid, cursor, and stack on each step) and a limited fuel on the case that we don&rsquo;t want to accidently run a program for forever.</p><h3 id=examples>Examples</h3><p>And that&rsquo;s all we need. Let&rsquo;s test it with a few sample programs:</p><h4 id=hello-world-wikipedia>Hello World (Wikipedia)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>run-befunge</span>)
</span></span><span style=display:flex><span>&gt;              v <span style=color:#75715e>; hello world</span>
</span></span><span style=display:flex><span>v  <span style=color:#f92672>,,,,,</span><span style=color:#e6db74>&#34;Hello&#34;</span>&lt; <span style=color:#75715e>; source: wikipedia</span>
</span></span><span style=display:flex><span>&gt;48*,          v
</span></span><span style=display:flex><span>v,,,,,,<span style=color:#e6db74>&#34;World!&#34;</span>&lt;
</span></span><span style=display:flex><span>&gt;25*,@
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hello World!
</span></span></code></pre></div><h4 id=hello-world-wikipedia-1>Hello World (Wikipedia)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>run-befunge</span>)
</span></span><span style=display:flex><span>&gt;25*<span style=color:#e6db74>&#34;!dlrow ,olleH&#34;</span>:v  <span style=color:#75715e>; hello world v2</span>
</span></span><span style=display:flex><span>                 v:,_@ <span style=color:#75715e>; source: wikipedia</span>
</span></span><span style=display:flex><span>                 &gt;  ^ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hello, world!
</span></span></code></pre></div><h4 id=fizz-buzz-rosettacode>Fizz Buzz (RosettaCode)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>run-befunge</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>55</span>*4*v    _   v            <span style=color:#75715e>; fizz buzz</span>
</span></span><span style=display:flex><span>v   &lt;&gt;:1-:^                <span style=color:#75715e>; source: rosettacode</span>
</span></span><span style=display:flex><span>    |:&lt;$      &lt;    <span style=color:#f92672>,</span>*48 &lt;  
</span></span><span style=display:flex><span>    @&gt;0<span style=color:#e6db74>&#34;zzif&#34;</span>&gt;:<span style=color:#f92672>#,</span>_$      v 
</span></span><span style=display:flex><span>&gt;:3%!|    &gt;0<span style=color:#e6db74>&#34;zzub&#34;</span>&gt;:<span style=color:#f92672>#,</span>_$^  
</span></span><span style=display:flex><span>     &gt;:5%!|                
</span></span><span style=display:flex><span>v <span style=color:#e6db74>&#34;buzz&#34;</span><span style=color:#ae81ff>0</span>&lt;&gt;:<span style=color:#f92672>.</span>           ^  
</span></span><span style=display:flex><span>         |!%5:           &lt; 
</span></span><span style=display:flex><span>&gt;:<span style=color:#f92672>#,</span>_   $&gt;              ^
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>2</span>  fizz <span style=color:#ae81ff>4</span>  buzz fizz <span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>8</span>  fizz buzz <span style=color:#ae81ff>11</span>  fizz <span style=color:#ae81ff>13</span>  <span style=color:#ae81ff>14</span>  fizzbuzz <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>17</span>  fizz <span style=color:#ae81ff>19</span>  buzz fizz <span style=color:#ae81ff>22</span>  <span style=color:#ae81ff>23</span>  fizz buzz <span style=color:#ae81ff>26</span>  fizz <span style=color:#ae81ff>28</span>  <span style=color:#ae81ff>29</span>  fizzbuzz <span style=color:#ae81ff>31</span>  <span style=color:#ae81ff>32</span>  fizz <span style=color:#ae81ff>34</span>  buzz fizz <span style=color:#ae81ff>37</span>  <span style=color:#ae81ff>38</span>  fizz buzz <span style=color:#ae81ff>41</span>  fizz <span style=color:#ae81ff>43</span>  <span style=color:#ae81ff>44</span>  fizzbuzz <span style=color:#ae81ff>46</span>  <span style=color:#ae81ff>47</span>  fizz <span style=color:#ae81ff>49</span>  buzz fizz <span style=color:#ae81ff>52</span>  <span style=color:#ae81ff>53</span>  fizz buzz <span style=color:#ae81ff>56</span>  fizz <span style=color:#ae81ff>58</span>  <span style=color:#ae81ff>59</span>  fizzbuzz <span style=color:#ae81ff>61</span>  <span style=color:#ae81ff>62</span>  fizz <span style=color:#ae81ff>64</span>  buzz fizz <span style=color:#ae81ff>67</span>  <span style=color:#ae81ff>68</span>  fizz buzz <span style=color:#ae81ff>71</span>  fizz <span style=color:#ae81ff>73</span>  <span style=color:#ae81ff>74</span>  fizzbuzz <span style=color:#ae81ff>76</span>  <span style=color:#ae81ff>77</span>  fizz <span style=color:#ae81ff>79</span>  buzz fizz <span style=color:#ae81ff>82</span>  <span style=color:#ae81ff>83</span>  fizz buzz <span style=color:#ae81ff>86</span>  fizz <span style=color:#ae81ff>88</span>  <span style=color:#ae81ff>89</span>  fizzbuzz <span style=color:#ae81ff>91</span>  <span style=color:#ae81ff>92</span>  fizz <span style=color:#ae81ff>94</span>  buzz fizz <span style=color:#ae81ff>97</span>  <span style=color:#ae81ff>98</span>  fizz buzz
</span></span></code></pre></div><h4 id=random-digit-generator-wikipedia>Random digit generator (Wikipedia)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>run-befunge</span> <span style=color:#f92672>#</span>:fuel <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>v&gt;&gt;&gt;&gt;<span style=color:#f92672>.</span> <span style=color:#75715e>; random digit generator</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>12345</span> <span style=color:#75715e>; source: wikipedia</span>
</span></span><span style=display:flex><span> ^?^
</span></span><span style=display:flex><span>&gt; ? ?^
</span></span><span style=display:flex><span> v?v
</span></span><span style=display:flex><span>v6789&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>Looks pretty good from here!</p><h3 id=pretty-pretty-pictures>Pretty pretty pictures</h3><p>One last trick, let&rsquo;s do much the same that we did a <a href=https://blog.jverkamp.com/2014/05/28/quadtree-image-compression/>bit ago</a> and make a rendering function:</p><h4 id=hello-world-wikipedia-2>Hello World (Wikipedia)</h4><figure><img src=/embeds/2014/hello-world.gif></figure><h4 id=random-digit-generator-wikipedia-1>Random digit generator (Wikipedia)</h4><figure><img src=/embeds/2014/random.gif></figure><h4 id=fizz-buzz-rosettacode-1>Fizz Buzz (RosettaCode)</h4><p>(Limited to 10 in interest of time)</p><figure><img src=/embeds/2014/fizz-buzz.gif></figure><p>And that&rsquo;s it. Check out the full source on GitHub: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/befunge.rkt>befunge.rkt</a></p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script defer>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script><script defer src=/custom.js></script></body></html>
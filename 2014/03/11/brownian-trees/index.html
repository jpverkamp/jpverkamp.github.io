<!DOCTYPE html>
<html onclick >
<head>
    <title>Brownian trees – jverkamp.com</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a> *
            <a href="/resume">Resume</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>
    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/maker/">Maker</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Brownian trees</h1>

        <div class="entry-meta"><span class="entry-date">2014-03-11</span>
            </div>

        <div class="entry-taxonomies"><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2014/02/27/dis/re-emvowelification/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2014/03/12/caesar-cipher/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2014/02/27/dis/re-emvowelification/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a><a href="https://blog.jverkamp.com/2014/03/12/caesar-cipher/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/11/30/twitter-puddle/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/cellular-automata">Cellular Automata</a><a href="https://blog.jverkamp.com/2014/08/07/langtons-ant/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/11/30/twitter-puddle/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/graphics">Graphics</a><a href="https://blog.jverkamp.com/2014/05/28/quadtree-image-compression/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2013/11/30/twitter-puddle/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/procedural-content">Procedural Content</a><a href="https://blog.jverkamp.com/2014/08/07/langtons-ant/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2014/02/27/dis/re-emvowelification/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/trees">Trees</a><a href="https://blog.jverkamp.com/2014/06/17/factor-trees/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2014/02/27/dis/re-emvowelification/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2014/03/12/caesar-cipher/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2014/02/27/dis/re-emvowelification/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2014/03/12/caesar-cipher/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</div>
    </header>

	<div class="entry-content"><p>Pretty pretty picture time<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>:</p>
<figure>
    <img src="/embeds/2014/brownian-tree.png"/> 
</figure>

<p>The basic idea here is that of a <a href="https://en.wikipedia.org/wiki/Brownian%20Tree">Brownian Tree</a>:</p>
<blockquote>
<p>A Brownian tree is built with these steps: first, a &ldquo;seed&rdquo; is placed somewhere on the screen. Then, a particle is placed in a random position of the screen, and moved randomly until it bumps against the seed. The particle is left there, and another particle is placed in a random position and moved until it bumps against the seed or any previous particle, and so on.</p>
</blockquote>
<blockquote>
<p>&ndash; Wikipedia</p>
</blockquote>
<p>In this case, we&rsquo;re going to put the seed point in the center and drop points in from the outside. There are a number of other parameters we can tweak, but we&rsquo;ll get to each of those in turn.</p>
<p>First, we need to come up with a basic structure for the code. Luckily, the <code><a href="http://docs.racket-lang.org/search/index.html?q=big-bang">big-bang</a></code>
 function will do exactly what we want. All we have to do it write something for the <code>on-tick</code> and <code>on-draw</code> clauses.</p>
<p>Okay, next step. What sort of data structure are we going to use?</p>
<p>Well, we need to know how big the world is. And we need to have a bunch of dots moving constantly inwards, so how about something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#a6e22e">struct</span> point (<span style="color:#a6e22e">x</span> y) <span style="color:#f92672">#</span>:transparent)
(<span style="color:#a6e22e">struct</span> world (<span style="color:#a6e22e">radius</span> points drip) <span style="color:#f92672">#</span>:transparent)
</code></pre></div><p>I went ahead and separated out the point that is currently falling inwards as the <code>drip</code>, although we could also have had that as the first of the list in <code>points</code>. Either works.</p>
<p>Okay, so next we want a function that takes in one of these world structures and returns the next step in the simulation. In this case, the drip should either move inwards or freeze in place if it meets another nearby point. Perhaps something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Either randomly move the drip or create a new one</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">update</span> w)
  <span style="color:#75715e">; Always try to move the drip first</span>
  (<span style="color:#66d9ef">define </span>new-drip
    (<span style="color:#a6e22e">point</span> (+ (<span style="color:#a6e22e">point-x</span> (<span style="color:#a6e22e">world-drip</span> w)) (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">-1</span>)
           (+ (<span style="color:#a6e22e">point-y</span> (<span style="color:#a6e22e">world-drip</span> w)) (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">-1</span>)))

  (<span style="color:#a6e22e">cond</span>
    <span style="color:#75715e">; If it&#39;s adjacent to any current point, freeze it and generate a new drip</span>
    [(<span style="color:#a6e22e">ormap</span> (<span style="color:#a6e22e">λ</span> (<span style="color:#a6e22e">pt</span>) (&lt;= (<span style="color:#a6e22e">δ</span> new-drip pt) (<span style="color:#a6e22e">current-spacing</span>)))
            (<span style="color:#a6e22e">world-points</span> w))

     (<span style="color:#a6e22e">world</span> (<span style="color:#a6e22e">world-radius</span> w)
            (cons new-drip (<span style="color:#a6e22e">world-points</span> w))
            (<span style="color:#a6e22e">random-point</span> (<span style="color:#a6e22e">world-radius</span> w)))]
    <span style="color:#75715e">; Otherwise, just use the new drip</span>
    [else
     (<span style="color:#a6e22e">world</span> (<span style="color:#a6e22e">world-radius</span> w)
            (<span style="color:#a6e22e">world-points</span> w)
            new-drip)]))
</code></pre></div><p>As the comments say, we&rsquo;ll start by moving the point. Then, we can check if the <code>new-drip</code> is adjacent to any neighboring point by calculating the distance to each with <code>δ</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Distance formula</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">δ</span> pt1 pt2)
  (sqrt (+ (<span style="color:#a6e22e">sqr</span> (- (<span style="color:#a6e22e">point-x</span> pt1) (<span style="color:#a6e22e">point-x</span> pt2)))
           (<span style="color:#a6e22e">sqr</span> (- (<span style="color:#a6e22e">point-y</span> pt1) (<span style="color:#a6e22e">point-y</span> pt2))))))
</code></pre></div><p>Furthermore, because we&rsquo;re using <code>ormap</code>, as soon as we have any matching point, the check will short circuit. If we wanted to write it in a potentially more &lsquo;Rackety&rsquo; style, we could instead have written the condition with <code><a href="http://docs.racket-lang.org/search/index.html?q=for/first">for/first</a></code>
:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#a6e22e">for/first</span> ([pt (<span style="color:#a6e22e">in-list</span> (<span style="color:#a6e22e">world-points</span> w))]
            <span style="color:#f92672">#</span>:when (&lt;= (<span style="color:#a6e22e">δ</span> new-drip pt) (<span style="color:#a6e22e">current-spacing</span>)))
  <span style="color:#66d9ef">#t</span>)
</code></pre></div><p>The last bit is the <code>random-point</code> function. Since we&rsquo;re dealing with a circle, it will be easiest to generate the points in <a href="https://en.wikipedia.org/wiki/polar%20coordinates">polar coordinates</a> and then converting them to <a href="https://en.wikipedia.org/wiki/Cartesian%20coordinates">Cartesian coordinates</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Generate a new random point on the border of a given circle</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">random-point</span> r)
  (<span style="color:#66d9ef">define </span>θ (* <span style="color:#ae81ff">2</span> pi (<span style="color:#a6e22e">random</span>)))
  (<span style="color:#a6e22e">point</span> (inexact-&gt;exact (truncate (* r (cos θ))))
         (inexact-&gt;exact (truncate (* r (sin θ))))))
</code></pre></div><p>If you wanted to generate points within the circle as well, rather than just on the edge, you could randomly generate <code>(define r^ (* (random) r))</code>. I think generating them on the borders works better though.</p>
<p>Well, that was straight forward enough&gt; Hopefully the drawing function will be as quick?</p>
<p>For this, we&rsquo;re going to take advantage of the <code><a href="http://docs.racket-lang.org/search/index.html?q=circle">circle</a></code>
 and <code><a href="http://docs.racket-lang.org/search/index.html?q=overlay/offset">overlay/offset</a></code>
 functions, both from <code><a href="http://docs.racket-lang.org/search/index.html?q=2htdp/image">2htdp/image</a></code>
. The former will create a circular image (either for the background or for the points themselves) and the latter will draw the latter on the former (nicely centering them for a convenient axis system).</p>
<p>Something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Draw the current points in an image</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">draw</span> w)
  (<span style="color:#a6e22e">for/fold</span> ([img (<span style="color:#a6e22e">circle</span> (<span style="color:#a6e22e">world-radius</span> w) <span style="color:#e6db74">&#34;outline&#34;</span> <span style="color:#e6db74">&#34;black&#34;</span>)])
            ([pt (<span style="color:#a6e22e">in-list</span> (cons (<span style="color:#a6e22e">world-drip</span> w)
                                (<span style="color:#a6e22e">world-points</span> w)))])
    (<span style="color:#a6e22e">overlay/offset</span> (<span style="color:#a6e22e">outlined-circle</span> <span style="color:#ae81ff">0.5</span> <span style="color:#e6db74">&#34;black&#34;</span>)
                    (<span style="color:#a6e22e">point-x</span> pt)
                    (<span style="color:#a6e22e">point-y</span> pt)
                    img)))
</code></pre></div><p>I really like the <code><a href="http://docs.racket-lang.org/search/index.html?q=for/fold">for/fold</a></code>
 macro. The first block starts with the loop state (the background circle). The second controls the loop (the drip and then each point in turn). The third/body draws the point with the next loop acting as the <code>img</code> the next time around.</p>
<p>Now, the beauty of this structure becomes apparent. With the <code><a href="http://docs.racket-lang.org/search/index.html?q=big-bang">big-bang</a></code>
 function from <code><a href="http://docs.racket-lang.org/search/index.html?q=2htpd/universe">2htpd/universe</a></code>
, all we have to do is create an initial world and the <code>update</code>/<code>draw</code> functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">brownian-tree</span> radius)
  (<span style="color:#a6e22e">big-bang</span> (<span style="color:#a6e22e">world</span> radius <span style="color:#f92672">&#39;</span>() (<span style="color:#a6e22e">point</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>))
    (<span style="color:#a6e22e">on-tick</span> update)
    (<span style="color:#a6e22e">on-draw</span> draw)))
</code></pre></div><p>Let&rsquo;s give it a try:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (<span style="color:#a6e22e">brownian-tree</span> <span style="color:#ae81ff">25</span>)
</code></pre></div><figure>
    <img src="/embeds/2014/brownian-initial.png"/> 
</figure>

<p>Yeah, that&rsquo;s tiny. Perhaps as the first tweak, we should introduce a scaling parameter to the world. The nice thing about the <code>update</code>/<code>draw</code> split is that we can keep the simulation unscaled and only scale in <code>draw</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#a6e22e">struct</span> world (<span style="color:#a6e22e">radius</span> scale points drip) <span style="color:#f92672">#</span>:transparent)

<span style="color:#75715e">; Draw the current points in an image</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">draw</span> w)
  (<span style="color:#a6e22e">for/fold</span> ([img (<span style="color:#a6e22e">circle</span> (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">world-radius</span> w)) <span style="color:#e6db74">&#34;outline&#34;</span> <span style="color:#e6db74">&#34;black&#34;</span>)])
            ([pt (<span style="color:#a6e22e">in-list</span> (cons (<span style="color:#a6e22e">world-drip</span> w)
                                (<span style="color:#a6e22e">world-points</span> w)))])
    (<span style="color:#a6e22e">overlay/offset</span> (<span style="color:#a6e22e">outlined-circle</span> (/ (<span style="color:#a6e22e">world-scale</span> w) <span style="color:#ae81ff">2</span>) <span style="color:#e6db74">&#34;black&#34;</span>)
                    (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-x</span> pt))
                    (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-y</span> pt))
                    img)))

(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">brownian-tree</span> radius <span style="color:#f92672">#</span>:scale [scale <span style="color:#ae81ff">1.0</span>])
  (<span style="color:#a6e22e">big-bang</span> (<span style="color:#a6e22e">world</span> radius scale <span style="color:#f92672">&#39;</span>() (<span style="color:#a6e22e">point</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>))
    (<span style="color:#a6e22e">on-tick</span> update)
    (<span style="color:#a6e22e">on-draw</span> draw)))
</code></pre></div><p>Optional keyword parameters, just because&hellip;</p>
<p>With that, we can make some much more reasonably sized images:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (<span style="color:#a6e22e">brownian-tree</span> <span style="color:#ae81ff">25</span> <span style="color:#f92672">#</span>:scale <span style="color:#ae81ff">5.0</span>)
</code></pre></div><figure>
    <img src="/embeds/2014/brownian-scaled.png"/> 
</figure>

<p>What&rsquo;s the next thing we could tweak? How about a bit more color?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#a6e22e">struct</span> point (<span style="color:#a6e22e">x</span> y c) <span style="color:#f92672">#</span>:transparent)

<span style="color:#75715e">; Generate a new random point on the border of a given circle</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">random-point</span> r)
  (<span style="color:#66d9ef">define </span>θ (* <span style="color:#ae81ff">2</span> pi (<span style="color:#a6e22e">random</span>)))
  (<span style="color:#a6e22e">point</span> (inexact-&gt;exact (truncate (* r (cos θ))))
         (inexact-&gt;exact (truncate (* r (sin θ))))
         (vector-ref colors (<span style="color:#a6e22e">random</span> (vector-length colors)))))

<span style="color:#75715e">; Draw the current points in an image</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">draw</span> w)
  (<span style="color:#a6e22e">for/fold</span> ([img (<span style="color:#a6e22e">circle</span> (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">world-radius</span> w)) <span style="color:#e6db74">&#34;outline&#34;</span> <span style="color:#e6db74">&#34;black&#34;</span>)])
            ([pt (<span style="color:#a6e22e">in-list</span> (cons (<span style="color:#a6e22e">world-drip</span> w)
                                (<span style="color:#a6e22e">world-points</span> w)))])
    (<span style="color:#a6e22e">overlay/offset</span> (<span style="color:#a6e22e">outlined-circle</span> (/ (<span style="color:#a6e22e">world-scale</span> w) <span style="color:#ae81ff">2</span>) (<span style="color:#a6e22e">point-c</span> pt))
                    (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-x</span> pt))
                    (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-y</span> pt))
                    img)))

(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">brownian-tree</span> radius <span style="color:#f92672">#</span>:scale [scale <span style="color:#ae81ff">1.0</span>])
  (<span style="color:#66d9ef">define </span>origin (<span style="color:#a6e22e">point</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#34;black&#34;</span>))
  (<span style="color:#a6e22e">big-bang</span> (<span style="color:#a6e22e">world</span> radius scale (list origin) (<span style="color:#a6e22e">random-point</span> radius))
    (<span style="color:#a6e22e">on-tick</span> update)
    (<span style="color:#a6e22e">on-draw</span> draw)))
</code></pre></div><p>That&rsquo;s actually enough to generate the image from the header:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (<span style="color:#a6e22e">brownian-tree</span> <span style="color:#ae81ff">25</span> <span style="color:#f92672">#</span>:scale <span style="color:#ae81ff">5.0</span>)
</code></pre></div><figure>
    <img src="/embeds/2014/brownian-tree.png"/> 
</figure>

<p>There are two things that you should have noticed though&ndash;although one isn&rsquo;t particularly obvious unless you&rsquo;re following along:</p>
<ul>
<li>The grid structure tends to align on the vertical and horizontal axes</li>
<li>It takes forever for the points to fall inwards and join the tree</li>
</ul>
<p>How can we deal with that?</p>
<p>Well for the first, think back to the update function we wrote. All we really used was a grid update that added ±1 to each point and a distance function <code>δ</code>. There&rsquo;s nothing in particular that would stop us from moving with real coordinates instead. To make the transition easier, let&rsquo;s factor out this &lsquo;<code>wiggle</code>&rsquo; function into two different options:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#66d9ef">define </span>current-wiggle-real? (<span style="color:#a6e22e">make-parameter</span> <span style="color:#66d9ef">#f</span>))
(<span style="color:#66d9ef">define </span>current-inward-bias (<span style="color:#a6e22e">make-parameter</span> <span style="color:#ae81ff">0.5</span>))

<span style="color:#75715e">; Wiggle a point closer to the origin, sticking to the unit grid</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">wiggle:grid</span> pt)
  (<span style="color:#66d9ef">let </span>([max-d (<span style="color:#a6e22e">δ</span> origin pt)])
    (<span style="color:#66d9ef">let </span>loop ()
      (<span style="color:#66d9ef">define </span>xδ? (zero? (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">2</span>)))
      (<span style="color:#66d9ef">define </span>new-pt
        (<span style="color:#a6e22e">point</span> (<span style="color:#66d9ef">if </span>xδ? (+ (<span style="color:#a6e22e">point-x</span> pt) (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">-1</span>) (<span style="color:#a6e22e">point-x</span> pt))
               (<span style="color:#66d9ef">if </span>xδ? (<span style="color:#a6e22e">point-y</span> pt) (+ (<span style="color:#a6e22e">point-y</span> pt) (<span style="color:#a6e22e">random</span> <span style="color:#ae81ff">3</span>) <span style="color:#ae81ff">-1</span>))
               (<span style="color:#a6e22e">point-c</span> pt)))
      (<span style="color:#66d9ef">if </span>(<span style="color:#66d9ef">or </span>(&lt;= (<span style="color:#a6e22e">δ</span> origin new-pt) max-d) (&lt; (<span style="color:#a6e22e">current-inward-bias</span>) (<span style="color:#a6e22e">random</span>)))
          new-pt
          (<span style="color:#a6e22e">loop</span>)))))

<span style="color:#75715e">; Wiggle a point closer to the origin, returning any new point within the unit circle</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">wiggle:real</span> pt)
  (<span style="color:#66d9ef">let </span>([max-d (<span style="color:#a6e22e">δ</span> origin pt)])
    (<span style="color:#66d9ef">let </span>loop ()
      (<span style="color:#66d9ef">define </span>θ (* <span style="color:#ae81ff">2</span> pi (<span style="color:#a6e22e">random</span>)))
      (<span style="color:#66d9ef">define </span>new-pt
        (<span style="color:#a6e22e">point</span> (+ (<span style="color:#a6e22e">point-x</span> pt) (cos θ))
               (+ (<span style="color:#a6e22e">point-y</span> pt) (sin θ))
               (<span style="color:#a6e22e">point-c</span> pt)))
      (<span style="color:#66d9ef">if </span>(<span style="color:#66d9ef">or </span>(&lt;= (<span style="color:#a6e22e">δ</span> origin new-pt) max-d) (&lt; (<span style="color:#a6e22e">current-inward-bias</span>) (<span style="color:#a6e22e">random</span>)))
          new-pt
          (<span style="color:#a6e22e">loop</span>)))))

<span style="color:#75715e">; Either randomly move the drip or create a new one</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">update</span> w)
  <span style="color:#75715e">; Always try to move the drip first</span>
  (<span style="color:#66d9ef">define </span>new-drip
    ((<span style="color:#66d9ef">if </span>(<span style="color:#a6e22e">current-wiggle-real?</span>) wiggle:real wiggle:grid)
     (<span style="color:#a6e22e">world-drip</span> w)))

  <span style="color:#f92672">...</span>)

(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">brownian-tree</span> radius
                       <span style="color:#f92672">#</span>:scale     [scale <span style="color:#ae81ff">1.0</span>]
                       <span style="color:#f92672">#</span>:spacing   [spacing <span style="color:#ae81ff">1</span>]
                       <span style="color:#f92672">#</span>:real-mode [real-mode? <span style="color:#66d9ef">#f</span>])
  (<span style="color:#a6e22e">parameterize</span> ([current-wiggle-real? real-mode?]
                 [current-spacing spacing])
    (<span style="color:#66d9ef">define </span>origin (<span style="color:#a6e22e">point</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#34;black&#34;</span>))
    (<span style="color:#a6e22e">big-bang</span> (<span style="color:#a6e22e">world</span> radius scale (list origin) (<span style="color:#a6e22e">random-point</span> radius))
      (<span style="color:#a6e22e">on-tick</span> update)
      (<span style="color:#a6e22e">on-draw</span> draw))))
</code></pre></div><p>While we&rsquo;re at it, I made another tweak for the second issue above. Did you notice? <code>current-inward-bias</code>? Basically, a random percent of the number, we might move outwards, but otherwise we&rsquo;re guaranteed (via checking the <code>δ</code> to the <code>origin</code>) to move inwards. This should speed up the simulation&ndash;while at the same time adding enough parameters to get all sorts of interesting variants:</p>
<table class="table table-striped"><tr><td>bias</td><td>1.0</td><td>0.5</td><td>0.25</td></tr>
<tr><td>grid</td><td>
<figure>
    <img src="/embeds/2014/brownian-grid-full.png"/> 
</figure>

</td><td>
<figure>
    <img src="/embeds/2014/brownian-grid-half.png"/> 
</figure>

</td><td>
<figure>
    <img src="/embeds/2014/brownian-grid-quarter.png"/> 
</figure>

</td></tr><tr><td>real</td><td>
<figure>
    <img src="/embeds/2014/brownian-real-full.png"/> 
</figure>

</td><td>
<figure>
    <img src="/embeds/2014/brownian-real-half.png"/> 
</figure>

</td><td>
<figure>
    <img src="/embeds/2014/brownian-real-quarter.png"/> 
</figure>

</td></tr><table class="table table-striped">
<p>It&rsquo;s interesting how different the two modes are. While grid mode aligns on the axes with higher inward bias, real mode makes more compact images as the points are more likely to skip past one another.</p>
<p>That&rsquo;s about all we have time for, although there are all sorts of additional tweaks that we could still make. For example, what about tweaking the distance at which we consider a collision?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (<span style="color:#a6e22e">brownian-tree</span> <span style="color:#ae81ff">25</span>
                 <span style="color:#f92672">#</span>:scale <span style="color:#ae81ff">2.5</span>
                 <span style="color:#f92672">#</span>:real-mode <span style="color:#66d9ef">#t</span>
                 <span style="color:#f92672">#</span>:spacing (* <span style="color:#ae81ff">2</span> (sqrt <span style="color:#ae81ff">2</span>))
                 <span style="color:#f92672">#</span>:bias <span style="color:#ae81ff">0.5</span>
                 <span style="color:#f92672">#</span>:fast-mode <span style="color:#66d9ef">#t</span>)
</code></pre></div><figure>
    <img src="/embeds/2014/brownian-spaced-out.png"/> 
</figure>

<p>What&rsquo;s that you say? I haven&rsquo;t explained <code>#:fast-mode</code>?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Faster version of update that loops until the new point freeze into place</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">fast-update</span> w)
  (<span style="color:#66d9ef">let </span>loop ([w^ w])
    (<span style="color:#66d9ef">if </span>(eq? (<span style="color:#a6e22e">world-points</span> w) (<span style="color:#a6e22e">world-points</span> w^))
        (<span style="color:#a6e22e">loop</span> (<span style="color:#a6e22e">update</span> w^))
        w^)))

<span style="color:#75715e">; Run the full simulation, returning the resulting image</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">brownian-tree</span> radius
                       <span style="color:#f92672">#</span>:scale     [scale <span style="color:#ae81ff">1.0</span>]
                       <span style="color:#f92672">#</span>:bias      [bias <span style="color:#ae81ff">0.5</span>]
                       <span style="color:#f92672">#</span>:spacing   [spacing <span style="color:#ae81ff">1</span>]
                       <span style="color:#f92672">#</span>:fast-mode [fast-mode? <span style="color:#66d9ef">#f</span>]
                       <span style="color:#f92672">#</span>:real-mode [real-mode? <span style="color:#66d9ef">#f</span>])
  (<span style="color:#a6e22e">parameterize</span> ([current-wiggle-real? real-mode?]
                 [current-spacing spacing]
                 [current-inward-bias bias])
    (<span style="color:#66d9ef">define </span>initial-world (<span style="color:#a6e22e">world</span> radius scale (list origin) (<span style="color:#a6e22e">random-point</span> radius)))
    (<span style="color:#66d9ef">define </span>draw (<span style="color:#a6e22e">make-cached-draw</span> initial-world))
    (<span style="color:#a6e22e">draw</span>
     (<span style="color:#a6e22e">big-bang</span> initial-world
       (<span style="color:#a6e22e">on-tick</span> (<span style="color:#66d9ef">if </span>fast-mode? fast-update update))
       (<span style="color:#a6e22e">to-draw</span> draw)))))
</code></pre></div><p>Basically, don&rsquo;t show every step. Run the simulation until a particle &lsquo;sticks&rsquo; and <em>then</em> update<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<p>What? <code>make-cached-draw</code>?</p>
<p>Well, think about it. Every time we were calling <code>draw</code>, we were redrawing the entire image from scratch. But once a point freezes in place, we should never have to draw it again. We can take advantage of this to radically speed up our drawing function (particularly once we have hundreds or even thousands of points):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Create a cached draw function for a particular world</span>
(<span style="color:#66d9ef">define </span>(<span style="color:#a6e22e">make-cached-draw</span> initial-world)
  (<span style="color:#66d9ef">let </span>([cache-key <span style="color:#f92672">&#39;</span>()] [cache-val (<span style="color:#a6e22e">circle</span> (* (<span style="color:#a6e22e">world-scale</span> initial-world) (<span style="color:#a6e22e">world-radius</span> initial-world)) <span style="color:#e6db74">&#34;outline&#34;</span> <span style="color:#e6db74">&#34;black&#34;</span>)])
    (<span style="color:#a6e22e">λ</span> (<span style="color:#a6e22e">w</span>)
      <span style="color:#75715e">; If we have at least one new point, add all new points to the cached image</span>
      (<span style="color:#a6e22e">when</span> (not (eq? cache-key (<span style="color:#a6e22e">world-points</span> w)))
        (<span style="color:#66d9ef">set! </span>cache-val
          (<span style="color:#a6e22e">for/fold</span> ([img cache-val]) ([pt (<span style="color:#a6e22e">in-list</span> (<span style="color:#a6e22e">world-points</span> w))]
                                       <span style="color:#f92672">#</span>:break (member pt cache-key))
            (<span style="color:#a6e22e">overlay/offset</span> (<span style="color:#a6e22e">outlined-circle</span> (/ (<span style="color:#a6e22e">world-scale</span> w) <span style="color:#ae81ff">2</span>) (<span style="color:#a6e22e">point-c</span> pt))
                            (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-x</span> pt))
                            (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-y</span> pt))
                            img)))
        (<span style="color:#66d9ef">set! </span>cache-key (<span style="color:#a6e22e">world-points</span> w)))
      <span style="color:#75715e">; Add the drip (never cached)</span>
      (<span style="color:#a6e22e">overlay/offset</span> (<span style="color:#a6e22e">outlined-circle</span> (/ (<span style="color:#a6e22e">world-scale</span> w) <span style="color:#ae81ff">2</span>) (<span style="color:#a6e22e">point-c</span> (<span style="color:#a6e22e">world-drip</span> w)))
                      (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-x</span> (<span style="color:#a6e22e">world-drip</span> w)))
                      (* (<span style="color:#a6e22e">world-scale</span> w) (<span style="color:#a6e22e">point-y</span> (<span style="color:#a6e22e">world-drip</span> w)))
                      cache-val))))
</code></pre></div><p>It&rsquo;s a little more complicated, but the basic idea should be pretty straight forward. If given an exact subset of the points we&rsquo;ve already drawn, directly return that image. Since we&rsquo;re actually returning the same list (with potentially more points in front), <code>eq?</code> does exactly what we want here.</p>
<p>And there you have it. Brownian trees, in <a href="https://en.wikipedia.org/wiki/Brownian%20motion">motion</a>.</p>
<p>If you&rsquo;d like to see all of the code in one place, you can do so here: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/brownian-tree.rkt">Brownian tree on GitHub</a></p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>For some definition of &lsquo;pretty&rsquo; <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Yes. I&rsquo;ve been using that this entire post. It turns out that waiting for hundreds of particles to randomly drift takes too long&hellip; <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>
</article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script src="/custom.js"></script>
</body>
</html>

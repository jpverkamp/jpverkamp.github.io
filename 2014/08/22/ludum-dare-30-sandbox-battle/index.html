<!DOCTYPE html>
<html onclick >
<head>
    <title>Ludum Dare 30: Sandbox Battle â€“ jverkamp.com</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a> *
            <a href="/resume">Resume</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>
    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/maker/">Maker</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Ludum Dare 30: Sandbox Battle</h1>

        <div class="entry-meta"><span class="entry-date">2014-08-22</span>
            </div>

        <div class="entry-taxonomies"><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/03/18/approximating-pi-with-buffons-needle/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/html">HTML</a><a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2014/01/13/csrf-protection-injection-with-jquery-and-zend/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/javascript">JavaScript</a><a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2013/05/21/ludum-dare-26-vtanks-results/" class="previous-link"></a><a class="taxonomy-value" href="/programming/sources/ludum-dare">Ludum Dare</a><a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2014/08/07/langtons-ant/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/cellular-automata">Cellular Automata</a><a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2014/07/10/cracker-barrel-peg-game-part-3/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/games">Games</a><a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values"><li><a class="taxonomy-value" href="/series/ludum-dare-30">Ludum Dare 30</a><a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2014/08/21/chess-puzzles-1-get-moving/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2014/08/21/chess-puzzles-1-get-moving/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-hints-of-a-game/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</div>
    </header>

	<div class="entry-content"><p>And here we are again. <a href="https://blog.jverkamp.com/2013/05/21/ludum-dare-26-vtanks-results/">Ludum Dare</a>. Taken directly from their about page&hellip;</p>
<blockquote>
<p>Ludum Dare is a regular accelerated game development Event.  Participants develop games from scratch in a weekend, based on a theme suggested by community.</p>
</blockquote>
<p>More specifically, the goal is to make a game from scratch in 48 hours. You&rsquo;re allowed to use publicly available frameworks and code libraries, but no art or other assets. Previously, I missed the original start time. So although I made my game in 48 hours, it didn&rsquo;t qualify. This time around, I&rsquo;m starting on time.</p>
<p>The theme this time is <a href="http://www.ludumdare.com/compo/2014/08/16/ludum-dare-30-theme-voting-begins/">Connected Worlds</a>. I like that a lot more than many of the previous themes, so let&rsquo;s see what ideas we can come up with.</p>
<p>Taking about an hour at the start of the compo to both work out and think, I ended up basically going in two directions:</p>
<ul>
<li>A <a href="https://en.wikipedia.org/wiki/falling%20sand">falling sand</a> style game, only with discrete &lsquo;bubbles&rsquo; with different particles / physics</li>
<li>A <a href="https://en.wikipedia.org/wiki/puzzle%20platformer">Platform_game#Puzzle_platformers</a> based around portals that split you into two realities you play at the same time</li>
</ul>
<p>Of the two, the second has the advantages of 1) actually sounding like a game (that&rsquo;s always been my problem with falling sand style simulations) and 2) being much easier to code. I&rsquo;ve worked on falling sand style games before (<a href="https://blog.jverkamp.com/2010/02/06/sandbox-its-alive/">Sandbox</a>) and they take a lot of tuning to get reasonable performance. Certainly worth doing&hellip; but not the best idea for a 48 hour time window.</p>
<p>So of course I&rsquo;m going with option A. ðŸ˜„</p>
<p>About 6 hours in, and so far this is what I have:</p>
<figure>
    <img src="/embeds/2014/screenshot.png"/> 
</figure>

<hr>
<p>Real-life demo! (Click run, then try dragging the boxes around)</p>
<p><canvas id="frame1" width="100" height="100"></canvas>
<canvas id="frame2" width="100" height="100"></canvas>
<canvas id="frame3" width="100" height="100"></canvas></p>
<p><button id="runGame" type="button">Run!</button></p>
<style>
canvas { border: 1px solid black; }
</style>
<script>
$(function() {
  var maxFrames = 10000;

  // Assign an index to each canvas so we can order them
  $('canvas').each(function(index, canvas) {
     $(canvas).attr('data-index', index);
  });

  // Keep a list of the current z-ordering of the canvases
  var ordering = [];
  $('canvas').each(function(i) { ordering.push(i); });

  // Make them draggable, on drag udate the index
  $('canvas').draggable({
      stack: '*',
      drag: function(event, ui) {

      },
      stop: function(event, ui) {
          var i = parseInt($(event.target).attr('data-index'));
          var index = ordering.indexOf(i);
          ordering.splice(index, 1);
          ordering.unshift(i);
      }
  });

  var make2DArray = function(width, height, def) {
      var array = new Array(width);
      for (var x = 0; x < width; x++) {
          array[x] = new Array(height);
          for (var y = 0; y < height; y++) {
              array[x][y] = def;
          }
      }
      return array;
  }

  var update = function(data, buffer, width, height) {
      // Clear the buffer
      for (var x = 0; x < width; x++) {
          for (var y = 0; y < height; y++) {
              buffer[x][y] = 0;
          }
      }

      // Update the buffer with falling cells
      var r = 0, xt = 0, yt = 0;
      for (var y = height - 1; y >= 0; y--) {
          for (var x = 0; x < width; x++) {
              // Skip empty cells
              if (data[x][y] == 0) continue;
              xt = x;
              yt = y;

              // Determine which way it's going to fall
              r = Math.random();
              if (r < 0.5) { // Straight down
                  if (y > 0 && buffer[x][y - 1] == 0) { xt = x; yt = y - 1; }
              } else if (r < 0.7) { // Down left
                  if (x > 0 && y > 0 && buffer[x - 1][y - 1] == 0) { xt = x - 1; yt = y - 1; }
              } else if (r < 0.9) { // Down right
                  if (x < width - 1 && y > 1 && buffer[x + 1][y - 1] == 0) { xt = x + 1; yt = y - 1; }
              } else if (r < 0.95) { // Straight left
                  if (x > 0 && buffer[x - 1][y] == 0) { xt = x - 1; yt = y; }
              } else { // Straight right
                  if (x < width - 1 && buffer[x + 1][y] == 0) { xt = x + 1; yt = y; }
              }

              if (data[xt][yt] != 0) { xt = x; yt = y; }

              // Update the buffer
              buffer[xt][yt] = data[x][y];
          }
      }
  }

  var allData = {};

  var animate = function(frameIndex, frame) {
      var start = new Date().getTime();

      var frame_ctx = frame.getContext('2d');
      frame_ctx.imageSmoothingEnabled = false;

      var width = frame.width;
      var height = frame.height;

      var data = make2DArray(width, height, 0);
      var buffer = make2DArray(width, height, 0);
      var temp;
      var i = 0, r = 0, g = 0, b = 0, a = 0;

      allData[frameIndex] = data;

      var imageData = frame_ctx.createImageData(width, height);

      var count = 0;
      var tick = function() {
          // Debug: For add a pixel
          data[width / 2][height - 1] = frameIndex + 1;

          // Update from data to buffer; swap the arrays for the next iteration
          update(data, buffer, width, height);
          temp = data;
          data = buffer;
          buffer = temp;

          // Detect overlapping buffers, if so swap randomly
          $('canvas').each(function(otherIndex, other) {
              // If we're comparing to ourself, we'll always overlap, skip
              if (frame == other) return;

              /*
              // We only want to run this once, so only for the frame on top
              // If we see the frame first, we're golden (break out of the loop)
              // If we see the other first, we're in the wrong order (stop processing)
              for (var i = 0; i < ordering.length; i++) {
                  if (ordering[i] == frameIndex) break;
                  if (ordering[i] == otherIndex) return;
              }
              */

              // If the two canvases don't overlap, don't look at them
              var frameBounds = frame.getBoundingClientRect();
              var otherBounds = other.getBoundingClientRect();
              if (frameBounds.right < otherBounds.left ||
                  frameBounds.left > otherBounds.right ||
                  frameBounds.bottom < otherBounds.top ||
                  frameBounds.top > otherBounds.bottom) {
                  return;
              }

              // We only want this once, so give priority to whichever frame is 'lower' on the screen
              if (frameBounds.top < otherBounds.top) return;

              // TODO: Find the actual offset rather than looping over an entire image
              var otherX, otherY, temp;
              for (var frameY = 0; frameY < height; frameY++) {
                  for (var frameX = 0; frameX < width; frameX++) {
                      otherX = Math.floor(frameBounds.left - otherBounds.left + frameX);
                      otherY = Math.floor(otherBounds.top - frameBounds.top + frameY);

                      if (0 <= otherX && otherX < width && 0 <= otherY && otherY < height) {
                          if (allData[frameIndex][frameX][frameY] == 0
                              /* && allData[otherIndex][otherX][otherY] != 0*/) {
                              temp = allData[frameIndex][frameX][frameY];
                              allData[frameIndex][frameX][frameY] = allData[otherIndex][otherX][otherY];
                              allData[otherIndex][otherX][otherY] = temp;
                          }
                      }
                  }
              }
          });

          // Render to the image data
          for (var y = 0; y < height; y++) {
              for (var x = 0; x < width; x++) {
                  i = x + (height - y) * width;

                  r = g = b = 0;
                  a = 255;

                  if (data[x][y] == 0) {
                      a = 0;
                  } else if (data[x][y] == 1) {
                      b = 255;
                  } else if (data[x][y] == 2) {
                      r = 255;
                  } else if (data[x][y] == 3) {
                      g = 255;
                  }

                  imageData.data[i * 4 + 0] = r;
                  imageData.data[i * 4 + 1] = g;
                  imageData.data[i * 4 + 2] = b;
                  imageData.data[i * 4 + 3] = a;
              }
          }

          // Copy back to the GUI
          frame_ctx.putImageData(imageData, 0, 0);

          if (count < maxFrames) {
              count += 1;
              setTimeout(tick, 0);
          } else {
              end = new Date().getTime();
              console.log(
                  maxFrames + ' frames in ' +
                  (end - start) + ' ms = ' +
                  (maxFrames / ((end - start) / 1000)) + ' fps'
              );
          }
      }
      tick();
  }

  $('#runGame').click(function() {
    console.log('starting...');
    $('canvas').each(animate);
  });
});
</script>
<p>You can click and drag the blocks around and the sand will from from box to box. At first, I was trying to figure out goals where you could&ndash;for example&ndash;use water in one box to put out fire in another. But right at the end, I had an even better idea (hopefully not just the long day talking): SANDBOX BATTLE! Basically, some sort of multiplayer / AI madness, where you are trying to steal the other box&rsquo;s sand before they can steal yours&hellip; I&rsquo;m going to have to think about that&hellip;</p>
<p>Anyways, here are some of the interesting bits (in JavaScript for once!):</p>
<p>First, the core of the whole thing, the update function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">update</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">buffer</span>, <span style="color:#a6e22e">width</span>, <span style="color:#a6e22e">height</span>) {
    <span style="color:#75715e">// Clear the buffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">width</span>; <span style="color:#a6e22e">x</span><span style="color:#f92672">++</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">y</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">height</span>; <span style="color:#a6e22e">y</span><span style="color:#f92672">++</span>) {
            <span style="color:#a6e22e">buffer</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        }
    }

    <span style="color:#75715e">// Update the buffer with falling cells
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">height</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">y</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">y</span><span style="color:#f92672">--</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">width</span>; <span style="color:#a6e22e">x</span><span style="color:#f92672">++</span>) {
            <span style="color:#75715e">// Skip empty cells
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">continue</span>;
            <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span>;
            <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y</span>;

            <span style="color:#75715e">// Determine which way it&#39;s going to fall
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">random</span>();
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.5</span>) { <span style="color:#75715e">// Straight down
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">y</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">buffer</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span>; <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; }
            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.7</span>) { <span style="color:#75715e">// Down left
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">buffer</span>[<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>][<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; }
            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.9</span>) { <span style="color:#75715e">// Down right
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">width</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">buffer</span>[<span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>][<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; }
            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.95</span>) { <span style="color:#75715e">// Straight left
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">buffer</span>[<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y</span>; }
            } <span style="color:#66d9ef">else</span> { <span style="color:#75715e">// Straight right
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">width</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">buffer</span>[<span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y</span>; }
            }

            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">xt</span>][<span style="color:#a6e22e">yt</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">xt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span>; <span style="color:#a6e22e">yt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y</span>; }

            <span style="color:#75715e">// Update the buffer
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">buffer</span>[<span style="color:#a6e22e">xt</span>][<span style="color:#a6e22e">yt</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span>];
        }
    }
}
</code></pre></div><p>The basic idea is two have two data arrays: <code>data</code> and <code>buffer</code>. We will trust the rest of the code to swap them the other way and spend all of the effort in this function creating buffer as the next frame. Specifically, we&rsquo;re going to loop through all of the tiles from bottom to top (because sand falls) then left to right. For each particle (non-<code>0</code> space), there are five possibilities:</p>
<ul>
<li>50% chance of trying to move directly down</li>
<li>20% chance of trying to move down and left, 20% down and right</li>
<li>5% chance each of moving directly left or right</li>
</ul>
<p>Sounds pretty good. It&rsquo;s the same sort of code I&rsquo;ve written rather a lot of times&hellip; This time around, we&rsquo;re not going to do any optimizations. We&rsquo;ll deal with that later if we have time.</p>
<p>Next, we have to deal with the <code>tick</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tick</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
    <span style="color:#75715e">// Debug: Add a pixel
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">width</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>][<span style="color:#a6e22e">height</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">frameIndex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;

    <span style="color:#75715e">// Update from data to buffer; swap the arrays for the next iteration
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">buffer</span>, <span style="color:#a6e22e">width</span>, <span style="color:#a6e22e">height</span>);
    <span style="color:#a6e22e">temp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>;
    <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buffer</span>;
    <span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp</span>;

    <span style="color:#75715e">// Detect overlapping buffers, if so swap randomly
</span><span style="color:#75715e"></span>    ...

    <span style="color:#75715e">// Render to the image data
</span><span style="color:#75715e"></span>    ...
}
</code></pre></div><p>So we start with pixels dumping in from the ceiling and we update the world. We have space for two more functions: copying between worlds (pretty much the core idea of the game ðŸ˜„) and rendering. Let&rsquo;s look at the latter first.</p>
<p>In order to render quickly, I&rsquo;m going to use the <code>canvas</code> element&rsquo;s context&rsquo;s <code>createImageData</code> and <code>putImageData</code> to write data directly into the image. That will be a lot faster than setting pixels individually, especially since we&rsquo;re going to be changing rather a lot of pixels at the indiviual level. So&hellip; rendering:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Render to the image data
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">y</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">height</span>; <span style="color:#a6e22e">y</span><span style="color:#f92672">++</span>) {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">x</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">width</span>; <span style="color:#a6e22e">x</span><span style="color:#f92672">++</span>) {
        <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">height</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">y</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">width</span>;

        <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">g</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;

        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
            <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
            <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">x</span>][<span style="color:#a6e22e">y</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) {
            <span style="color:#a6e22e">g</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;
        }

        <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">r</span>;
        <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">g</span>;
        <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span>;
        <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>;

    }
}

<span style="color:#75715e">// Copy back to the GUI
</span><span style="color:#75715e"></span><span style="color:#a6e22e">frame_ctx</span>.<span style="color:#a6e22e">putImageData</span>(<span style="color:#a6e22e">imageData</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</code></pre></div><p>We&rsquo;ve previously set up <code>imageData</code> using <code>createImageData</code> (we only have to do this once and then can reuse that same memory) and the <code>frame_ctx</code> as the context object of the canvas.</p>
<p>One interesting part that I changed right before this writeup was the transparency of empty cells. That way the page will shine through. I&rsquo;m not entirely sure that&rsquo;s what I want, but it&rsquo;s an interesting effect, so I&rsquo;ll leave it for the time being.</p>
<p>And then last but not least, the combination function. This one is honestly kind of weird:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Detect overlapping buffers, if so swap randomly
</span><span style="color:#75715e"></span><span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;canvas&#39;</span>).<span style="color:#a6e22e">each</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">otherIndex</span>, <span style="color:#a6e22e">other</span>) {
    <span style="color:#75715e">// If we&#39;re comparing to ourself, we&#39;ll always overlap, skip
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">frame</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">other</span>) <span style="color:#66d9ef">return</span>;

    <span style="color:#75715e">// If the two canvases don&#39;t overlap, don&#39;t look at them
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">frameBounds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">getBoundingClientRect</span>();
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">otherBounds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">other</span>.<span style="color:#a6e22e">getBoundingClientRect</span>();
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">frameBounds</span>.<span style="color:#a6e22e">right</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">otherBounds</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">||</span>
        <span style="color:#a6e22e">frameBounds</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">otherBounds</span>.<span style="color:#a6e22e">right</span> <span style="color:#f92672">||</span>
        <span style="color:#a6e22e">frameBounds</span>.<span style="color:#a6e22e">bottom</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">otherBounds</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">||</span>
        <span style="color:#a6e22e">frameBounds</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">otherBounds</span>.<span style="color:#a6e22e">bottom</span>) {
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#75715e">// We only want this once, so give priority to whichever frame is &#39;lower&#39; on the screen
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">frameBounds</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">otherBounds</span>.<span style="color:#a6e22e">top</span>) <span style="color:#66d9ef">return</span>;

    <span style="color:#75715e">// TODO: Find the actual offset rather than looping over an entire image
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">otherX</span>, <span style="color:#a6e22e">otherY</span>, <span style="color:#a6e22e">temp</span>;
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">frameY</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">frameY</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">height</span>; <span style="color:#a6e22e">frameY</span><span style="color:#f92672">++</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">frameX</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">frameX</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">width</span>; <span style="color:#a6e22e">frameX</span><span style="color:#f92672">++</span>) {
            <span style="color:#a6e22e">otherX</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">frameBounds</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">otherBounds</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">frameX</span>;
            <span style="color:#a6e22e">otherY</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">otherBounds</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">frameBounds</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">frameY</span>;

            <span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">otherX</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">otherX</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">width</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">otherY</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">otherY</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">height</span>) {
                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">allData</span>[<span style="color:#a6e22e">frameIndex</span>][<span style="color:#a6e22e">frameX</span>][<span style="color:#a6e22e">frameY</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> ) {
                    <span style="color:#a6e22e">temp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">allData</span>[<span style="color:#a6e22e">frameIndex</span>][<span style="color:#a6e22e">frameX</span>][<span style="color:#a6e22e">frameY</span>];
                    <span style="color:#a6e22e">allData</span>[<span style="color:#a6e22e">frameIndex</span>][<span style="color:#a6e22e">frameX</span>][<span style="color:#a6e22e">frameY</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">allData</span>[<span style="color:#a6e22e">otherIndex</span>][<span style="color:#a6e22e">otherX</span>][<span style="color:#a6e22e">otherY</span>];
                    <span style="color:#a6e22e">allData</span>[<span style="color:#a6e22e">otherIndex</span>][<span style="color:#a6e22e">otherX</span>][<span style="color:#a6e22e">otherY</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp</span>;
                }
            }
        }
    }
});
</code></pre></div><p>Theoretically the comments should be enough, but if not, the basic idea is to first find if we have two overlapping regions (the <code>frameIndex</code> and <code>otherIndex</code> will make more sense if you look at the full code). If you have one, then loop over the shared region and copy pixels to the lower of the two boxes. I&rsquo;m going to have to figure out a better rule for that. I tried using z-index, but that didn&rsquo;t work much better&hellip; Essentially, we need to be able to move particles from one box to another, but we need to be careful to neither lose nor duplicate particles. There are a number of weird edges cases (as I&rsquo;m sure you&rsquo;ve found if you played with the simulation).</p>
<p>And, that&rsquo;s it. I have until 5pm Pacific on Sunday. I&rsquo;m actually feeling pretty good about this. The best plan is to have a playable game after 24 hours and to spend the second day on polish. I&rsquo;m not sure if I&rsquo;ll quite hit that&hellip; but maybe!</p>
<p>If you&rsquo;d like to see the entire source (warning: ugly) and potentially spoilers, check it out here: <a href="https://github.com/jpverkamp/sandbox-battle">jpverkamp/sandbox-battle</a></p></div>
</article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script src="/custom.js"></script>
</body>
</html>

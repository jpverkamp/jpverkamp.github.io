<!DOCTYPE html>
<html>
<head>
    <title>Updating dotfiles â€“ jverkamp.com</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">Updating dotfiles</h1>

        <div class="entry-meta"><span class="entry-date">2014-08-04</span>
            </div><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2014/08/01/slowcat/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/python">Python</a><a href="https://blog.jverkamp.com/2015/02/26/ts-timestamping-stdout/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2014/08/01/slowcat/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/dotfiles">Dotfiles</a><a href="https://blog.jverkamp.com/2014/09/03/removing-large-files-from-git-history/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2014/08/01/slowcat/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/open-source">Open Source</a><a href="https://blog.jverkamp.com/2014/09/03/removing-large-files-from-git-history/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2014/08/01/slowcat/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/unix">Unix</a><a href="https://blog.jverkamp.com/2014/09/03/removing-large-files-from-git-history/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2014/08/01/slowcat/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2014/08/07/langtons-ant/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2014/08/01/slowcat/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2014/08/05/guardians-of-the-galaxy/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</header>

	<div class="entry-content"><p>After all of these updates to my <a href="https://blog.jverkamp.com/2015/02/11/update-dotfiles-encryption/">dotfiles</a>, I finally want something that I can use to keep them up to date. For that, let&rsquo;s write a quick script that can do just that.</p>

<p>First, we&rsquo;ll use the GitHub API to determine the most recent version of all of the files in the dotfiles repo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">api_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://api.github.com/repos/jpverkamp/dotfiles/git/trees/master?recursive=1&#39;</span>
api_in <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>urlopen(api_url)
api <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(api_in<span style="color:#f92672">.</span>read())
api_in<span style="color:#f92672">.</span>close()</code></pre></div>
<p>You&rsquo;ll of course have to specify your own url if you decide to use this script.</p>

<p>Next, we need something that can calculate a hash from a file on the local file system that matches the format the GitHub api returns. That way, we can use that hash to determine if files have changed, rather than having to download each file to diff them.</p>

<p>Luckily, GitHub user <a href="https://github.com/msabramo">msabramo</a> has a gist with exactly what I need: <a href="https://gist.github.com/msabramo/763200">https://gist.github.com/msabramo/763200</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>

<span style="color:#f92672">from</span> sys <span style="color:#f92672">import</span> argv
<span style="color:#f92672">from</span> hashlib <span style="color:#f92672">import</span> sha1
<span style="color:#f92672">from</span> cStringIO <span style="color:#f92672">import</span> StringIO

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">githash</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>buf <span style="color:#f92672">=</span> StringIO()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self, data):
        self<span style="color:#f92672">.</span>buf<span style="color:#f92672">.</span>write(data)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hexdigest</span>(self):
        data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>buf<span style="color:#f92672">.</span>getvalue()
        h <span style="color:#f92672">=</span> sha1()
        h<span style="color:#f92672">.</span>update(<span style="color:#e6db74">&#34;blob </span><span style="color:#e6db74">%u</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> len(data))
        h<span style="color:#f92672">.</span>update(data)

        <span style="color:#66d9ef">return</span> h<span style="color:#f92672">.</span>hexdigest()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">githash_data</span>(data):
    h <span style="color:#f92672">=</span> githash()
    h<span style="color:#f92672">.</span>update(data)
    <span style="color:#66d9ef">return</span> h<span style="color:#f92672">.</span>hexdigest()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">githash_fileobj</span>(fileobj):
    <span style="color:#66d9ef">return</span> githash_data(fileobj<span style="color:#f92672">.</span>read())


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#66d9ef">for</span> filename <span style="color:#f92672">in</span> argv[<span style="color:#ae81ff">1</span>:]:
        fileobj <span style="color:#f92672">=</span> file(filename)
        <span style="color:#66d9ef">print</span>(githash_fileobj(fileobj))</code></pre></div>
<p>Next, we&rsquo;ll iterate through the list fo filesignoreing a few specific files that we never want to update:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">for</span> file <span style="color:#f92672">in</span> api[<span style="color:#e6db74">&#39;tree&#39;</span>]:
    path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(<span style="color:#e6db74">&#39;~/.&#39;</span> <span style="color:#f92672">+</span> file[<span style="color:#e6db74">&#39;path&#39;</span>])

    <span style="color:#75715e"># Skip double dots, those are things like gitignore</span>
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;..&#39;</span> <span style="color:#f92672">in</span> path <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;README.md&#39;</span> <span style="color:#f92672">in</span> path <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;install.py&#39;</span> <span style="color:#f92672">in</span> path:
        <span style="color:#66d9ef">continue</span>

    <span style="color:#75715e"># Skip local directories that already exist</span>
    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(path) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path):
        <span style="color:#66d9ef">continue</span>

    <span style="color:#f92672">...</span></code></pre></div>
<p>After that, we&rsquo;ll calculate file hashes using the borrowed code above. Unfortunately, we don&rsquo;t know what sort of line endings we might have in the repo vs. locally, so we have to try all three possible combinations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Calculate current file hashes; we generate three to deal with cross platform line endings</span>
    current_hashes <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(path) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(path):
        <span style="color:#66d9ef">with</span> open(path, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> fin:
            content <span style="color:#f92672">=</span> fin<span style="color:#f92672">.</span>read()
            current_hashes<span style="color:#f92672">.</span>append(githash_data(content))
            current_hashes<span style="color:#f92672">.</span>append(githash_data(content<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)))
            current_hashes<span style="color:#f92672">.</span>append(githash_data(content<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)))</code></pre></div>
<p>At this point, I&rsquo;m not entirely sure that I shouldn&rsquo;t have just diffed the files locally&hellip;</p>

<p>Next, the interactive part: ask the user if they want to download the new file (<code>y</code>), skip it (<code>n</code>), show a diff (<code>d</code>), or quit (<code>q</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># If we don&#39;t have the most up to date file, ask the user what to do</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> file[<span style="color:#e6db74">&#39;sha&#39;</span>] <span style="color:#f92672">in</span> current_hashes:
        <span style="color:#66d9ef">while</span> True:
            choice <span style="color:#f92672">=</span> raw_input(<span style="color:#e6db74">&#39;{0} needs an update, download? &#39;</span><span style="color:#f92672">.</span>format(path))</code></pre></div>
<p>The interesting cases are downloading the file and showing a diff. For the former:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Download the current file</span>
        <span style="color:#66d9ef">if</span> choice <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;y&#39;</span>:
            file_in <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>urlopen(file[<span style="color:#e6db74">&#39;url&#39;</span>])
            remote_js <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(file_in<span style="color:#f92672">.</span>read())
            remote_content <span style="color:#f92672">=</span> decode_file(remote_js)
            file_in<span style="color:#f92672">.</span>close()

            <span style="color:#66d9ef">with</span> open(path, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> file_out:
                file_out<span style="color:#f92672">.</span>write(remote_content)

            <span style="color:#66d9ef">break</span></code></pre></div>
<p>Basically, download the file and write it out as a binary locally. Opening the local file as &lsquo;wb&rsquo; mode means that Python won&rsquo;t try to guess what we mean when it comes to things like line endings.</p>

<p>Next, diff. Luckily, Python has a built in library for diffs<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Display a diff</span>
        <span style="color:#66d9ef">elif</span> choice <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;d&#39;</span>:

            <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(path) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(path):
                file_in <span style="color:#f92672">=</span> urllib2<span style="color:#f92672">.</span>urlopen(file[<span style="color:#e6db74">&#39;url&#39;</span>])
                remote_js <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(file_in<span style="color:#f92672">.</span>read())
                <span style="color:#66d9ef">if</span> remote_js[<span style="color:#e6db74">&#39;encoding&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;base64&#39;</span>:
                    remote_content <span style="color:#f92672">=</span> decode_file(remote_js)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
                <span style="color:#66d9ef">else</span>:
                    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Cannot diff, unknown content type: &#39;</span> <span style="color:#f92672">+</span> remote_js[<span style="color:#e6db74">&#39;encoding&#39;</span>])
                    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
                file_in<span style="color:#f92672">.</span>close()

                <span style="color:#66d9ef">with</span> open(path, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> file_in:
                    local_content <span style="color:#f92672">=</span> file_in<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)

                <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> difflib<span style="color:#f92672">.</span>context_diff(local_content, remote_content):
                    <span style="color:#66d9ef">print</span>(line)

            <span style="color:#66d9ef">elif</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path):
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{0} is a directory&#39;</span><span style="color:#f92672">.</span>format(path))
            <span style="color:#66d9ef">else</span>:
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{0} is new&#39;</span><span style="color:#f92672">.</span>format(path))</code></pre></div>
<p>And that&rsquo;s pretty much it. There&rsquo;s an else block that will print out any files that are skipped. It works surprisingly well. Technically, we can even use this in place of my original <code>install.py</code> script.</p>

<p>Along with the rest of my <a href="https://blog.jverkamp.com/2015/02/11/update-dotfiles-encryption/">dotfiles</a>, this script is available on GitHub: <a href="https://github.com/jpverkamp/dotfiles/blob/master/bin/update-dotfiles">update-dotfiles</a>.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">What <em>doesn&rsquo;t</em> it have?
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div></div>
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Updating dotfiles";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2014\/08\/04\/updating-dotfiles\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div></article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>
</body>
</html>

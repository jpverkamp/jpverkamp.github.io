<!DOCTYPE html>
<html>
<head>
    <title>
    Ludum Dare 30: Hints of a game â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Ludum Dare 30: Hints of a game</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2014-08-23</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/html">HTML</a>
                        <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/javascript">JavaScript</a>
                        <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/sources/ludum-dare">Ludum Dare</a>
                        <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/cellular-automata">Cellular Automata</a>
                        <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/games">Games</a>
                        <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/series/">Series</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/series/ludum-dare-30">Ludum Dare 30</a>
                        <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2014/08/22/ludum-dare-30-sandbox-battle/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2014/08/23/ludum-dare-30-24-hours/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>We&rsquo;re getting there. 18 hours in and I have the first hints of what might actually be a game&hellip;</p>

<p></p>


<figure >
    
        <img src="/embeds/2014/screenshot.png" />
    
    
</figure>


<p>(I&rsquo;ll include a demo at the bottom of the post)</p>

<p>Basically, I went with allowing each box to be controlled individually by the keyboard. There will be some problems with having that many people on the keyboard at once, but we&rsquo;ll deal with that later (if we can).</p>

<p>One additional thing I wanted (and mostly figured out) is somewhat &lsquo;loose&rsquo; controls. Basically, rather than explicitly dealing with moving only when a key is down, we&rsquo;ll accelerate when the key is down, preserving velocity even after  keys are raised. There will be some small amount of friction as well, to make sure that eventually pieces will slow down.</p>

<p>It&rsquo;s actually not too hard to implement a system like this:</p>

<p>First, load in the keybindings from the interface you can see in the screenshot above:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Load key bindings
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">loadKeyBindings</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
  <span style="color:#a6e22e">keys</span> <span style="color:#f92672">=</span> {};

  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;Loading key bindings...&#39;</span>);

  <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#controls table&#39;</span>).<span style="color:#a6e22e">each</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">eli</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">player</span> <span style="color:#f92672">=</span> parseInt(<span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">eli</span>).<span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;data-player&#39;</span>));

    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;loading controls for player &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">player</span>);

    <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">eli</span>).<span style="color:#a6e22e">find</span>(<span style="color:#e6db74">&#39;input&#39;</span>).<span style="color:#a6e22e">each</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">elj</span>) {
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">command</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">elj</span>).<span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;name&#39;</span>);
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">elj</span>).<span style="color:#a6e22e">val</span>();

      <span style="color:#a6e22e">keys</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [<span style="color:#a6e22e">player</span>, <span style="color:#a6e22e">command</span>, <span style="color:#66d9ef">false</span>];
    });
  });
};</code></pre></div>
<p>This will put everything into the <code>key</code> array, indexed by key name and storing the player it refers to, the direction you are going (one of <code>left</code>, <code>right</code>, <code>up</code>, or <code>down</code>), and if that key is currently active (pressed down). If I can, I may add additional key bindings (such as rotation or powerups), otherwise, that&rsquo;s pretty good for the moment.</p>

<p>Next, we&rsquo;ll add a function to tell when keys are active:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">onkey</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">event</span>) {
  <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">keyCode</span>) {
    <span style="color:#66d9ef">case</span>  <span style="color:#ae81ff">37</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;LEFT&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span>  <span style="color:#ae81ff">38</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;UP&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span>  <span style="color:#ae81ff">39</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;RIGHT&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span>  <span style="color:#ae81ff">40</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DOWN&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span>  <span style="color:#ae81ff">97</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM1&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span>  <span style="color:#ae81ff">98</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM2&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span>  <span style="color:#ae81ff">99</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM3&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM4&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">101</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM5&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">102</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM6&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">103</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM7&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">104</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM8&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">105</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NUM9&#39;</span>; <span style="color:#66d9ef">break</span>;
    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> String.<span style="color:#a6e22e">fromCharCode</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">keyCode</span>).<span style="color:#a6e22e">toUpperCase</span>();
  }

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">keys</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;keydown&#39;</span>) {
      <span style="color:#a6e22e">keys</span>[<span style="color:#a6e22e">key</span>][<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;keyup&#39;</span>) {
      <span style="color:#a6e22e">keys</span>[<span style="color:#a6e22e">key</span>][<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
    }
  }
};</code></pre></div>
<p>Longer than I wanted, but it correctly deals with both the numpad and arrow keys, which is kind of necessary if you want to support 4 human players all at the same time. Perhaps I&rsquo;ll implement AIs, but until I do, we&rsquo;re going to have to allow for a bunch of players&hellip;</p>

<p>Okay, so what do we do with all of this information? Well, just like before, we have a <code>tick</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tick</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">event</span>) {
  <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">each</span>(<span style="color:#a6e22e">keys</span>, <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">el</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">player</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">el</span>[<span style="color:#ae81ff">0</span>];
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">command</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">el</span>[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">active</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">el</span>[<span style="color:#ae81ff">2</span>];

    <span style="color:#a6e22e">$game</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#tiles&#39;</span>);
    <span style="color:#a6e22e">$tile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#tiles *[data-player=&#34;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">player</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;]&#39;</span>);

    <span style="color:#75715e">// Update velocity
</span><span style="color:#75715e"></span>    ...

    <span style="color:#75715e">// Use friction to slow each box down over time
</span><span style="color:#75715e"></span>    ...

    <span style="color:#75715e">// Cap velocity so we don&#39;t go too fast
</span><span style="color:#75715e"></span>    ...

    <span style="color:#75715e">// Update the current position based on velocity
</span><span style="color:#75715e"></span>    ...

    <span style="color:#75715e">// Bounce off the edges of the screen
</span><span style="color:#75715e"></span>    ...

    <span style="color:#75715e">// Finally, update the position
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">$tile</span>.<span style="color:#a6e22e">css</span>({<span style="color:#e6db74">&#39;top&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">top</span>, <span style="color:#e6db74">&#39;left&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">left</span>});
  });

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">running</span>) {
    <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">tick</span>, <span style="color:#ae81ff">1000</span><span style="color:#960050;background-color:#1e0010">/30);</span>
  }
};</code></pre></div>
<p>Oof. That&rsquo;s a heck of a function. Luckily, the individual parts aren&rsquo;t <em>that</em> bad. First, we want to update the velocity. This is where the <code>active</code> parameter (the third in each key definition) comes into play:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Update velocity
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">active</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">command</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;up&#39;</span>) {
    <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-=</span> <span style="color:#a6e22e">PER_TICK_ACCELERATION</span>;
  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">command</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;down&#39;</span>) {
    <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">PER_TICK_ACCELERATION</span>;
  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">command</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;left&#39;</span>) {
    <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-=</span> <span style="color:#a6e22e">PER_TICK_ACCELERATION</span>;
  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">command</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;right&#39;</span>) {
    <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">PER_TICK_ACCELERATION</span>;
  }
}</code></pre></div>
<p>That&rsquo;s simple enough. As before, we have to decide that <code>up</code> and <code>down</code> are inverted (they almost always are when it comes to computers), but once you&rsquo;ve decided that&rsquo;s easy enough.</p>

<p>Now, outside of that black, the next thing we&rsquo;ll do is apply friction. This way the boxes will slow down over time, forcing players both to pay attention and to let them bounce around like madmen.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Use friction to slow each box down over time
</span><span style="color:#75715e">// If we&#39;re close enough to zero that friction will accelerate us, just stop
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">PER_TICK_FRICTION</span>) {
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
} <span style="color:#66d9ef">else</span> {
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+=</span> (<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">PER_TICK_FRICTION</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">PER_TICK_FRICTION</span>);
}

<span style="color:#66d9ef">if</span> (Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">PER_TICK_FRICTION</span>) {
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
} <span style="color:#66d9ef">else</span> {
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> (<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">PER_TICK_FRICTION</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">PER_TICK_FRICTION</span>);
}

<span style="color:#75715e">// Cap velcity so we don&#39;t go too fast
</span><span style="color:#75715e"></span><span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">VELOCITY_CAP</span>, Math.<span style="color:#a6e22e">max</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">VELOCITY_CAP</span>, <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>]));
<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">VELOCITY_CAP</span>, Math.<span style="color:#a6e22e">max</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">VELOCITY_CAP</span>, <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>]));</code></pre></div>
<p>Also at the end there, we make sure we don&rsquo;t keep accelerating indefinitely. That both helps keep the game a little easier to play and prevents edge cases (such as moving further in one tick than we&rsquo;re allowed).</p>

<p>Next, we can finally update the position:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Update the current position based on velocity
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$tile</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">offsetLeft</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>];
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$tile</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">offsetTop</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>];

<span style="color:#75715e">// Bounce off the edges of the screen
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">left</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
  <span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>]);
} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">left</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">$game</span>.<span style="color:#a6e22e">width</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">$tile</span>.<span style="color:#a6e22e">width</span>()) {
  <span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$game</span>.<span style="color:#a6e22e">width</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">$tile</span>.<span style="color:#a6e22e">width</span>();
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">0</span>]);
}

<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">top</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
  <span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>]);
} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">top</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">$game</span>.<span style="color:#a6e22e">height</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">$tile</span>.<span style="color:#a6e22e">height</span>()) {
  <span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span>  <span style="color:#a6e22e">$game</span>.<span style="color:#a6e22e">height</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">$tile</span>.<span style="color:#a6e22e">height</span>();
  <span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">abs</span>(<span style="color:#a6e22e">vel</span>[<span style="color:#a6e22e">player</span>][<span style="color:#ae81ff">1</span>]);
}</code></pre></div>
<p>Once again, we want to clip the positions. This time though, we&rsquo;re actually going to use the velocities we have rather than zeroing them out. Instead: bounce! It&rsquo;s nice, because it makes the game feel more &lsquo;realistic&rsquo; (for some definitions of the word).</p>

<p>And that&rsquo;s about it. With that, we can have the boxes moving around and interacting as they did last night. We&rsquo;re actually starting to get a game going here. One other tweak is the control code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tiles</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Tiles</span>();
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">controls</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Controls</span>();

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">MS_PER_GAME</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>;
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">startTime</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>();
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">running</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;

<span style="color:#a6e22e">$</span>(<span style="color:#66d9ef">function</span>() {
  <span style="color:#a6e22e">controls</span>.<span style="color:#a6e22e">run</span>();
});

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">tick</span>() {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">soFar</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">startTime</span>;
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">remainingSec</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">floor</span>((<span style="color:#a6e22e">MS_PER_GAME</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">soFar</span>) <span style="color:#960050;background-color:#1e0010">/ 1000);</span>

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">remainingSec</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#tiles #countdown&#39;</span>).<span style="color:#a6e22e">text</span>(<span style="color:#a6e22e">remainingSec</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; sec remaining&#39;</span>);
  } <span style="color:#66d9ef">else</span> {
    <span style="color:#a6e22e">stop</span>();
  }

  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">running</span>) {
    <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">tick</span>, <span style="color:#ae81ff">1000</span><span style="color:#960050;background-color:#1e0010">/30);</span>
  }
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>() {
  <span style="color:#a6e22e">tiles</span>.<span style="color:#a6e22e">run</span>();
  <span style="color:#a6e22e">controls</span>.<span style="color:#a6e22e">run</span>();

  <span style="color:#a6e22e">startTime</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>();
  <span style="color:#a6e22e">running</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
  <span style="color:#a6e22e">tick</span>();

  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">stop</span>() {
  <span style="color:#a6e22e">tiles</span>.<span style="color:#a6e22e">stop</span>();
  <span style="color:#a6e22e">controls</span>.<span style="color:#a6e22e">stop</span>();

  <span style="color:#a6e22e">startTime</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">MS_PER_GAME</span>;
  <span style="color:#a6e22e">running</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
  <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;#tiles #countdown&#39;</span>).<span style="color:#a6e22e">text</span>(<span style="color:#e6db74">&#39;game over&#39;</span>);

  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
}</code></pre></div>
<p>Technically, it&rsquo;s not a gameloop, since everything is done asynchronously via <code>setTimeout</code> (and make <strong>absolutely sure</strong> that you don&rsquo;t use <code>setInterval</code>&hellip;), but it&rsquo;s close enough. What this does give us though is a strict time before the game ends. Otherwise, the boxes will eventually fill up, and where&rsquo;s the fun in that? (Although that might be an interesting alternative end condition).</p>

<p>After that, all I have to figure out is scoring. And I have another 6 hours until the one day mark. If I can make it by then, I&rsquo;ll feel pretty good&ndash;and can use all of the rest of the time for polish. I&rsquo;m thinking some simple music, sound effects, a title screen (initial letters in sand?). Of course, I still have to figure out the scoring algorithm..</p>

<p>Same as yesterday, the entire source (warning: still ugly) if available on GitHub: <a href="https://github.com/jpverkamp/sandbox-battle">jpverkamp/sandbox-battle</a></p>

<hr />

<p>Demo:</p>

<style>
#controls table {
  border: 1px solid black;
  display: inline-block;
  margin: 1em;
  padding: 0.5em;
  border-radius: 0.5em;

}

#controls table td {
  padding: 0.1em;
}

#controls table td:first-child {
  text-align: right;
}

#controls table input {
  width: 50px;
  text-align: center;
}

#tiles {
  position: relative;
  width: 600px;
  height: 400px;
  background: black;
  border: 1px solid black;
}

#tiles canvas {
  position: absolute;
  border: 1px solid black;
}

#tiles canvas[data-player="0"] { border: 1px solid blue; }
#tiles canvas[data-player="1"] { border: 1px solid red; }
#tiles canvas[data-player="2"] { border: 1px solid green; }
#tiles canvas[data-player="3"] { border: 1px solid hotPink; }

#tiles #countdown {
  color: white;
}
</style>

<script>
function Tiles() {
  var running = false;
  var allData = {};
  var ordering = [];

  // Assign an index to each canvas so we can order them
  $('canvas').each(function(index, canvas) {
     $(canvas).attr('data-index', index);
  });

  // Keep a list of the current z-ordering of the canvases
  $('canvas').each(function(i) { ordering.push(i); });

  // Make them draggable, on drag udate the index
  $('canvas').draggable({
      stack: '*',
      drag: function(event, ui) {

      },
      stop: function(event, ui) {
          var i = parseInt($(event.target).attr('data-index'));
          var index = ordering.indexOf(i);
          ordering.splice(index, 1);
          ordering.unshift(i);
      }
  });

  // Make a 2D array initialized all to a given valu
  var make2DArray = function(width, height, def) {
      var array = new Array(width);
      for (var x = 0; x < width; x++) {
          array[x] = new Array(height);
          for (var y = 0; y < height; y++) {
              array[x][y] = def;
          }
      }
      return array;
  }

  // Update the given grid
  var update = function(data, buffer, width, height) {
      // Clear the buffer
      for (var x = 0; x < width; x++) {
          for (var y = 0; y < height; y++) {
              buffer[x][y] = 0;
          }
      }

      // Update the buffer with falling cells
      var r = 0, xt = 0, yt = 0;
      for (var y = height - 1; y >= 0; y--) {
          for (var x = 0; x < width; x++) {
              // Skip empty cells
              if (data[x][y] == 0) continue;
              xt = x;
              yt = y;

              // Determine which way it's going to fall
              r = Math.random();
              if (r < 0.5) { // Straight down
                  if (y > 0 && buffer[x][y - 1] == 0) { xt = x; yt = y - 1; }
              } else if (r < 0.7) { // Down left
                  if (x > 0 && y > 0 && buffer[x - 1][y - 1] == 0) { xt = x - 1; yt = y - 1; }
              } else if (r < 0.9) { // Down right
                  if (x < width - 1 && y > 1 && buffer[x + 1][y - 1] == 0) { xt = x + 1; yt = y - 1; }
              } else if (r < 0.95) { // Straight left
                  if (x > 0 && buffer[x - 1][y] == 0) { xt = x - 1; yt = y; }
              } else { // Straight right
                  if (x < width - 1 && buffer[x + 1][y] == 0) { xt = x + 1; yt = y; }
              }

              if (data[xt][yt] != 0) { xt = x; yt = y; }

              // Update the buffer
              buffer[xt][yt] = data[x][y];
          }
      }
  }

  // Animate a given frame
  var animate = function(frameIndex, frame) {
      var start = new Date().getTime();

      var frame_ctx = frame.getContext('2d');
      frame_ctx.imageSmoothingEnabled = false;

      var width = frame.width;
      var height = frame.height;

      var data = make2DArray(width, height, 0);
      var buffer = make2DArray(width, height, 0);
      var temp;
      var i = 0, r = 0, g = 0, b = 0, a = 0;

      allData[frameIndex] = data;
      var imageData = frame_ctx.createImageData(width, height);

      var tick = function() {
          // Debug: For add a pixel
          data[width / 2][height - 1] = frameIndex + 1;

          // Update from data to buffer; swap the arrays for the next iteration
          update(data, buffer, width, height);
          temp = data;
          data = buffer;
          buffer = temp;

          // Detect overlapping buffers, if so swap randomly
          $('canvas').each(function(otherIndex, other) {
              // If we're comparing to ourself, we'll always overlap, skip
              if (frame == other) return;

              // If the two canvases don't overlap, don't look at them
              var frameBounds = frame.getBoundingClientRect();
              var otherBounds = other.getBoundingClientRect();
              if (frameBounds.right < otherBounds.left ||
                  frameBounds.left > otherBounds.right ||
                  frameBounds.bottom < otherBounds.top ||
                  frameBounds.top > otherBounds.bottom) {
                  return;
              }

              // We only want this once, so give priority to whichever frame is 'lower' on the screen
              if (frameBounds.top < otherBounds.top) return;

              // Bail out if we haven't loaded the data yet
              if (!(frameIndex in allData && otherIndex in allData)) {
                return;
              }

              // TODO: Find the actual offset rather than looping over an entire image
              var otherX, otherY, temp;
              for (var frameY = 0; frameY < height; frameY++) {
                  for (var frameX = 0; frameX < width; frameX++) {
                      otherX = Math.floor(frameBounds.left - otherBounds.left + frameX);
                      otherY = Math.floor(otherBounds.top - frameBounds.top + frameY);

                      if (0 <= otherX && otherX < width && 0 <= otherY && otherY < height) {
                          if (allData[frameIndex][frameX][frameY] == 0
                              /* && allData[otherIndex][otherX][otherY] != 0*/) {
                              temp = allData[frameIndex][frameX][frameY];
                              allData[frameIndex][frameX][frameY] = allData[otherIndex][otherX][otherY];
                              allData[otherIndex][otherX][otherY] = temp;
                          }
                      }
                  }
              }
          });

          // Render to the image data
          for (var y = 0; y < height; y++) {
              for (var x = 0; x < width; x++) {
                  i = x + (height - y) * width;

                  r = g = b = 0;
                  a = 255;

                  if (data[x][y] == 0) {
                    a = 0;
                  } else if (data[x][y] == 1) {
                    b = 255;
                  } else if (data[x][y] == 2) {
                    r = 255;
                  } else if (data[x][y] == 3) {
                    g = 255;
                  } else if (data[x][y] == 4) {
                    r = 246;
                    g = 96;
                    b = 171;
                  }

                  imageData.data[i * 4 + 0] = r;
                  imageData.data[i * 4 + 1] = g;
                  imageData.data[i * 4 + 2] = b;
                  imageData.data[i * 4 + 3] = a;
              }
          }

          // Copy back to the GUI
          frame_ctx.putImageData(imageData, 0, 0);

          if (running) {
              setTimeout(tick, 1000/60);
          }
      }
      tick();
  };

  this.run = function() {
    running = true;
    $('canvas').each(animate);
  };

  this.stop = function() {
    running = false;
  };
};

function Controls() {
  var keys = {};
  var running = false;
  var PER_TICK_ACCELERATION = 0.1;
  var PER_TICK_FRICTION = 0.01;
  var VELOCITY_CAP = 10;

  var vel = {};

  // Load key bindings
  var loadKeyBindings = function() {
    keys = {};

    console.log('Loading key bindings...');

    $('#controls table').each(function(i, eli) {
      var player = parseInt($(eli).attr('data-player'));

      console.log('loading controls for player ' + player);

      $(eli).find('input').each(function(j, elj) {
        var command = $(elj).attr('name');
        var key = $(elj).val();

        keys[key] = [player, command, false];
      });
    });
  };

  var onkey = function(event) {
    switch (event.keyCode) {
      case  37: key = 'LEFT'; break;
      case  38: key = 'UP'; break;
      case  39: key = 'RIGHT'; break;
      case  40: key = 'DOWN'; break;
      case  97: key = 'NUM1'; break;
      case  98: key = 'NUM2'; break;
      case  99: key = 'NUM3'; break;
      case 100: key = 'NUM4'; break;
      case 101: key = 'NUM5'; break;
      case 102: key = 'NUM6'; break;
      case 103: key = 'NUM7'; break;
      case 104: key = 'NUM8'; break;
      case 105: key = 'NUM9'; break;
      default: key = String.fromCharCode(event.keyCode).toUpperCase();
    }

    if (key in keys) {
      if (event.type == 'keydown') {
        keys[key][2] = true;
      } else if (event.type == 'keyup') {
        keys[key][2] = false;
      }
    }
  };

  var tick = function(event) {
    $.each(keys, function(i, el) {
      var player = el[0];
      var command = el[1];
      var active = el[2];

      $game = $('#tiles');
      $tile = $('#tiles *[data-player="' + player + '"]');

      // Update velocity
      if (active) {
        if (command == 'up') {
          vel[player][1] -= PER_TICK_ACCELERATION;
        } else if (command == 'down') {
          vel[player][1] += PER_TICK_ACCELERATION;
        } else if (command == 'left') {
          vel[player][0] -= PER_TICK_ACCELERATION;
        } else if (command == 'right') {
          vel[player][0] += PER_TICK_ACCELERATION;
        }
      }

      // Use friction to slow each box down over time
      // If we're close enough to zero that friction will accelerate us, just stop
      if (Math.abs(vel[player][0]) < PER_TICK_FRICTION) {
        vel[player][0] = 0;
      } else {
        vel[player][0] += (vel[player][0] > 0 ? -PER_TICK_FRICTION : PER_TICK_FRICTION);
      }

      if (Math.abs(vel[player][1]) < PER_TICK_FRICTION) {
        vel[player][1] = 0;
      } else {
        vel[player][1] += (vel[player][1] > 0 ? -PER_TICK_FRICTION : PER_TICK_FRICTION);
      }

      // Cap velocity so we don't go too fast
      vel[player][0] = Math.min(VELOCITY_CAP, Math.max(-VELOCITY_CAP, vel[player][0]));
      vel[player][1] = Math.min(VELOCITY_CAP, Math.max(-VELOCITY_CAP, vel[player][1]));

      // Update the current position based on velocity
      var left = $tile[0].offsetLeft + vel[player][0];
      var top = $tile[0].offsetTop + vel[player][1];

      // Bounce off the edges of the screen
      if (left < 0) {
        left = 0;
        vel[player][0] = Math.abs(vel[player][0]);
      } else if (left > $game.width() - $tile.width()) {
        left = $game.width() - $tile.width();
        vel[player][0] = -1 * Math.abs(vel[player][0]);
      }

      if (top < 0) {
        top = 0;
        vel[player][1] = Math.abs(vel[player][1]);
      } else if (top > $game.height() - $tile.height()) {
        top =  $game.height() - $tile.height();
        vel[player][1] = -1 * Math.abs(vel[player][1]);
      }

      // Finally, update the position
      $tile.css({'top': top, 'left': left});
    });

    if (running) {
      setTimeout(tick, 1000/30);
    }
  };

  this.run = function() {
    // Reload keybindings in case they've changed
    loadKeyBindings();

    // Initialize velocities to zero
    $game = $('#tiles');
    $('#tiles canvas').each(function(i, eli) {
      vel[i] = [0, 0];
      $(eli).css({
        top: Math.random() * ($game.height() - $(eli).height()),
        left: Math.random() * ($game.width() - $(eli).width())
      });
    });

    // Add keybindings, we can use the same function since it can check type
    $(document).unbind('keydown').bind('keydown', onkey);
    $(document).unbind('keyup').bind('keyup', onkey);

    running = true;
    tick();
  }

  this.stop = function() {
    running = false;

    $(document).unbind('keydown');
    $(document).unbind('keyup');
  }
};

var tiles = new Tiles();
var controls = new Controls();

var MS_PER_GAME = 60 * 1000;
var startTime = new Date().getTime();
var running = true;

$(function() {
  controls.run();
});

function tick() {
  var soFar = new Date().getTime() - startTime;
  var remainingSec = Math.floor((MS_PER_GAME - soFar) / 1000);

  if (remainingSec > 0) {
    $('#tiles #countdown').text(remainingSec + ' sec remaining');
  } else {
    stop();
  }

  if (running) {
    setTimeout(tick, 1000/30);
  }
}

function run() {
  tiles.run();
  controls.run();

  startTime = new Date().getTime();
  running = true;
  tick();

  return false;
}

function stop() {
  tiles.stop();
  controls.stop();

  startTime = new Date().getTime() - MS_PER_GAME;
  running = false;
  $('#tiles #countdown').text('game over');

  return false;
}
</script>

<table>
<thead>
<tr>
<th>Player 1 - Blue</th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>Up</td>
<td></td>
</tr>

<tr>
<td>Left</td>
<td></td>
</tr>

<tr>
<td>Right</td>
<td></td>
</tr>

<tr>
<td>Down</td>
<td></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th>Player 2 - Red</th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>Up</td>
<td></td>
</tr>

<tr>
<td>Left</td>
<td></td>
</tr>

<tr>
<td>Right</td>
<td></td>
</tr>

<tr>
<td>Down</td>
<td></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th>Player 3 - Green</th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>Up</td>
<td></td>
</tr>

<tr>
<td>Left</td>
<td></td>
</tr>

<tr>
<td>Right</td>
<td></td>
</tr>

<tr>
<td>Down</td>
<td></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th>Player 4 - Pink</th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>Up</td>
<td></td>
</tr>

<tr>
<td>Left</td>
<td></td>
</tr>

<tr>
<td>Right</td>
<td></td>
</tr>

<tr>
<td>Down</td>
<td></td>
</tr>
</tbody>
</table>

<p>[ <a href="javascript:run()">Run!</a> ]
  [ <a href="javascript:stop()">Stop!</a> ]</p>

<p><div id="tiles">
    <p id="countdown"></p>
    <canvas data-player="0" width="100" height="100"></canvas>
    <canvas data-player="1" width="100" height="100"></canvas>
    <canvas data-player="2" width="100" height="100"></canvas>
    <canvas data-player="3" width="100" height="100"></canvas></p>

<p></div></p>

<hr />

<p>I&rsquo;m sure there are bugs&hellip; And I&rsquo;m working on it right at the moment. If you have any questions or comments though, feel free to drop me a line below.</p>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Ludum Dare 30: Hints of a game";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2014\/08\/23\/ludum-dare-30-hints-of-a-game\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

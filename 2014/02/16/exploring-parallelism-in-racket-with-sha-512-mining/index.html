<!DOCTYPE html>
<html>
<head>
    <title>
    Exploring parallelism in Racket with SHA-512 mining – jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Exploring parallelism in Racket with SHA-512 mining</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2014-02-16</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/01/27/factoring-factorials/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2014/02/27/crossing-hands/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/01/27/factoring-factorials/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a>
                        <a href="https://blog.jverkamp.com/2014/02/27/crossing-hands/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/programming/topics/bitcoin">Bitcoin</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/04/23/user-space-continuation-based-thread-pool/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/concurrency">Concurrency</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2013/02/06/numbers-as-words-in-arbitrary-bases/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/dictionary">Dictionary</a>
                        <a href="https://blog.jverkamp.com/2014/02/27/dis/re-emvowelification/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/programming/topics/hashes">Hashes</a>
                        <a href="https://blog.jverkamp.com/2016/12/05/aoc-2016-day-5-password-cracker/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/01/27/factoring-factorials/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/mathematics">Mathematics</a>
                        <a href="https://blog.jverkamp.com/2014/02/27/crossing-hands/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    

                    
                    

                    <li>
                        
                        <a class="taxonomy-value" href="/programming/topics/parallelism">Parallelism</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2014/02/07/command-line-user-agent-parsing/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2014/02/27/crossing-hands/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2014/02/15/the-lego-movie/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2014/02/27/crossing-hands/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>While I&rsquo;ve been getting a fair few programming exercises from Reddit&rsquo;s <a href="http://www.reddit.com/r/dailyprogrammer">/r/dailyprogrammer</a>, more recently I&rsquo;ve started following a few other sub-Reddits, such as <a href="http://www.reddit.com/r/programming">/r/programming</a> and <a href="http://www.reddit.com/r/netsec">/r/netsec</a>. While browsing the former, I came across this intriguing gem of a problem: <a tabindex="1" href="http://www.h11e.com/">HashChallenge: can you find the lowest value SHA-512 hash?</a></p>

<p></p>

<p>The basic idea is simple. Find the input string <em>s</em> such that the output SHA-512 hash is minimized. As an an example,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;Hello world&#34;</span> | shasum -a <span style="color:#ae81ff">512</span>
81381f1dacd4824a6c503fd070577630...

$ echo <span style="color:#e6db74">&#34;Even better&#34;</span> | shasum -a <span style="color:#ae81ff">512</span>
77d8af6911952994e2d9597e6962ada1...</code></pre></div>
<p>Of course, these aren&rsquo;t that great. At the very least we should be looking for hashes with a few leading zeros. Not to mention that this is something that should be downright trivial to automate. Let&rsquo;s start with a straight forward Racket script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Mine for the lowest SHA-512 we can find</span>
(<span style="color:#66d9ef">define </span>(mine)
  (<span style="color:#66d9ef">define </span>alphabet <span style="color:#e6db74">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890&#34;</span>)
  (<span style="color:#66d9ef">define </span>hashes-tried <span style="color:#ae81ff">0</span>)
  (<span style="color:#66d9ef">define </span>start-time (current-inexact-milliseconds))

  <span style="color:#75715e">; Store best values</span>
  (<span style="color:#66d9ef">define </span>best-str <span style="color:#66d9ef">#f</span>)
  (<span style="color:#66d9ef">define </span>best-hash <span style="color:#66d9ef">#f</span>)

  <span style="color:#75715e">; Generate random values one at a time</span>
    (<span style="color:#66d9ef">let </span>loop ()
      (<span style="color:#66d9ef">define </span>str   (random-string <span style="color:#ae81ff">16</span>))
      (<span style="color:#66d9ef">define </span>bytes (string-&gt;bytes/utf-8 str))
      (<span style="color:#66d9ef">define </span>hash  (bytes-&gt;hex-string (sha512 bytes)))

      (<span style="color:#66d9ef">set! </span>hashes-tried (+ <span style="color:#ae81ff">1</span> hashes-tried))
      (when (<span style="color:#66d9ef">or </span>(not best-hash) (string&lt;? hash best-hash))
        (<span style="color:#66d9ef">set! </span>best-str str)
        (<span style="color:#66d9ef">set! </span>best-hash hash)
        (print-timing <span style="color:#e6db74">&#39;main</span> hashes-tried (/ (- (current-inexact-milliseconds) start-time) <span style="color:#ae81ff">1000</span>) best-str best-hash))

      (loop)))</code></pre></div>
<p>There are a few helper functions there (<code>random-string</code> and <code>print-timing</code>, you can see them in the full code on GitHub: <a href="https://github.com/jpverkamp/small-projects/tree/master/blog/mine-sha512">github/jpverkamp</a>), but those should be straight forward. The hashing itself is done with Greg Hendershott&rsquo;s <a href="https://github.com/greghendershott/sha/tree/master"><code>sha</code> library for Racket</a>, available via the new <a href="http://pkg.racket-lang.org/#[sha]">package manager</a>.</p>

<p>So, how does that do?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ racket mine-sha512.rkt
main: 4ZRZ6R5eQO4GItzK -&gt; 50ce827050c31fd0... <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span>.0 h @ <span style="color:#ae81ff">1</span>.0 kh/s<span style="color:#f92672">)</span>
main: bGzP1aAnXjDEJ5tS -&gt; 2a8e1803b7ac4b57... <span style="color:#f92672">(</span><span style="color:#ae81ff">16</span>.0 h @ <span style="color:#ae81ff">16</span>.0 kh/s<span style="color:#f92672">)</span>
main: 9IXIWuGDepUUSubp -&gt; 048e4b1b9ae2e893... <span style="color:#f92672">(</span><span style="color:#ae81ff">20</span>.0 h @ <span style="color:#ae81ff">20</span>.0 kh/s<span style="color:#f92672">)</span>
main: nwVB9KFI0ieHm0n4 -&gt; 007704acb8e01bcf... <span style="color:#f92672">(</span><span style="color:#ae81ff">105</span>.0 h @ <span style="color:#ae81ff">52</span>.5 kh/s<span style="color:#f92672">)</span>
main: WeQFXLb3UhwyaHRr -&gt; 000b17576f358405... <span style="color:#f92672">(</span><span style="color:#ae81ff">364</span>.0 h @ <span style="color:#ae81ff">91</span>.0 kh/s<span style="color:#f92672">)</span>
main: D19naE3qFtrKT6Lt -&gt; 000707066075fce0... <span style="color:#f92672">(</span><span style="color:#ae81ff">6</span>.0 kh @ <span style="color:#ae81ff">100</span>.7 kh/s<span style="color:#f92672">)</span>
main: 4PQKs7crKnQTBjfs -&gt; 00018fe9e134c366... <span style="color:#f92672">(</span><span style="color:#ae81ff">11</span>.7 kh @ <span style="color:#ae81ff">113</span>.6 kh/s<span style="color:#f92672">)</span>
main: NZS717BXvT0ErzSR -&gt; 0000ed34ec5c0222... <span style="color:#f92672">(</span><span style="color:#ae81ff">120</span>.5 kh @ <span style="color:#ae81ff">131</span>.1 kh/s<span style="color:#f92672">)</span>
main: 3QuXbtG0xlRaDKqV -&gt; 000005fb0ac4a407... <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span>.7 Mh @ <span style="color:#ae81ff">133</span>.2 kh/s<span style="color:#f92672">)</span></code></pre></div>
<p>Since it only prints a line when it finds a new best hash, output can be a little chaotic at best, but at the very least this gives us a pretty good baseline. We managed to find a hash with 5 leading zeros and are running at about 133.2 kh/s. Nowhere near what most ASIC bitcoin miners <a href="https://en.bitcoin.it/wiki/Mining_hardware_comparison#ASIC">claim to be able to do</a><sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>, but not terrible for a pure CPU miner.</p>

<p>Let&rsquo;s do better.</p>

<p>The next idea would be to use Racket&rsquo;s threads. Going in to it, I already know that this isn&rsquo;t going to buy us much<sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup>, but it&rsquo;s an easy enough tweak.</p>

<p>First, pull out the <code>hashes-tried</code>, <code>best-str</code>, and <code>best-hash</code> variables so all threads can access them. Then, create a wrapper function that will fire off the right number of threads:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Mine with multiple threads concurrently</span>
(<span style="color:#66d9ef">define </span>(mine-all thread-count)
  (<span style="color:#66d9ef">define </span>threads
    (for/list ([i (in-range thread-count)])
      (thread (thunk (mine i)))))
  (map thread-wait threads))</code></pre></div>
<p>This way we also get to know which thread found the new best value (although strictly speaking that&rsquo;s not necessary):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ racket mine-sha512-threads.rkt <span style="color:#ae81ff">8</span>
<span style="color:#ae81ff">7</span>: OsultHDT905n5mmo -&gt; c0b8ad26ae6472f8... <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span>.0 h @ <span style="color:#ae81ff">62</span>.5 h/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">7</span>: pEyhYUxIM74peJxi -&gt; 13c7391822e728c3... <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span>.0 h @ <span style="color:#ae81ff">187</span>.5 h/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">7</span>: jPMHHOwwJeGe7bqF -&gt; 0045856cdcfbe797... <span style="color:#f92672">(</span><span style="color:#ae81ff">10</span>.0 h @ <span style="color:#ae81ff">625</span>.0 h/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">7</span>: TE2nEcH10rcWefsn -&gt; 003e888a92cd8809... <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span>.0 kh @ <span style="color:#ae81ff">43</span>.7 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">7</span>: WTGTqrOpl2x1Czi1 -&gt; 0024448bf70a1247... <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span>.1 kh @ <span style="color:#ae81ff">49</span>.5 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">6</span>: EMhqI5ngPwiQr4gK -&gt; 000ae12edd827730... <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span>.8 kh @ <span style="color:#ae81ff">78</span>.0 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">5</span>: Gftv6FPZwVF4xTct -&gt; 000031b56d17483b... <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span>.8 kh @ <span style="color:#ae81ff">88</span>.7 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">1</span>: gDNLGB6Dzlp9YVBj -&gt; 00002a7fd4a81c8d... <span style="color:#f92672">(</span><span style="color:#ae81ff">287</span>.5 kh @ <span style="color:#ae81ff">143</span>.2 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">1</span>: G0F4FLKwPNbUzQGO -&gt; 0000117e20b56196... <span style="color:#f92672">(</span><span style="color:#ae81ff">646</span>.2 kh @ <span style="color:#ae81ff">144</span>.6 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: 0hmB7jnocqRMuSxu -&gt; 00000a1a4b05d9b7... <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span>.9 Mh @ <span style="color:#ae81ff">144</span>.8 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">7</span>: PM59fjq5g2huYTEN -&gt; 000004cb6fd3fe14... <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span>.8 Mh @ <span style="color:#ae81ff">143</span>.8 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">4</span>: 4WzSTKXi540JlyJL -&gt; 000004713d42ec3b... <span style="color:#f92672">(</span><span style="color:#ae81ff">5</span>.1 Mh @ <span style="color:#ae81ff">143</span>.7 kh/s<span style="color:#f92672">)</span></code></pre></div>
<p>So we have a slight speed up. I guess that&rsquo;s something. The problem is that we&rsquo;re still actually only running in a single process on a single processor. With four cores, that&rsquo;s something of a waste. Unfortunately though, we aren&rsquo;t going to be able to do much better than that with threads. We need something a little more powerful:</p>

<code><a href="http://docs.racket-lang.org/search/index.html?q=Places">Places</a></code>


<p>The basic idea of places is:</p>

<blockquote>
<p><code><a href="http://docs.racket-lang.org/search/index.html?q=Places">Places</a></code>
 enable the development of parallel programs that take advantage of machines with multiple processors, cores, or hardware threads.</p>
</blockquote>

<p>Sounds like exactly what we want. Unfortunately, that extra power comes with a bit of extra cost. No longer can we share variables directly between the various threads of the program, but rather now we have to communicate explicitly, using <code><a href="http://docs.racket-lang.org/search/index.html?q=place%20channels">place channels</a></code>
. The basic idea I have is to split the work up into <em>n</em> places. For each place, run two threads: a hashing thread and a feedback thread. The hashing thread is pretty much the mining function we&rsquo;ve seen all along.</p>

<p>The feedback thread, on the other hand, will periodically send messages back to the main program relaying how much progress we&rsquo;ve made and any new hashes we&rsquo;ve found. Then, the main program can compare that to the other place&rsquo;s results and update with the overall best hash.</p>

<p>Starting with the new mining function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Create a place that will mine for new low hashes</span>
(<span style="color:#66d9ef">define </span>(mine id)
  (place me
    <span style="color:#75715e">; Local best values</span>
    (<span style="color:#66d9ef">define </span>hashes-tried <span style="color:#ae81ff">0</span>)
    (<span style="color:#66d9ef">define </span>best-str <span style="color:#66d9ef">#f</span>)
    (<span style="color:#66d9ef">define </span>best-hash <span style="color:#66d9ef">#f</span>)

    <span style="color:#75715e">; Thread to periodically send back new best values</span>
    (thread
      (thunk
        (<span style="color:#66d9ef">let </span>loop ()
          (place-channel-put me hashes-tried)
          (place-channel-put me best-str)
          (place-channel-put me best-hash)
          (sleep (* (random) <span style="color:#ae81ff">10.0</span>))
          (loop))))

    <span style="color:#75715e">; Look for new values</span>
    <span style="color:#f92672">...</span>))</code></pre></div>
<p>Fairly straight forward. The macro <code>place</code> at the top actually handles all of the work of creating a new place. <code>me</code> will be used to identify the automatically created channel we use a bit later to send messages on. Each time we send messages, we send three values: how many hashes this place has personally tried and the best string/hash pair. So of course, the main program will have to be listening for these three values from each place in turn:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Run multiple mining places in parallel and sync between them</span>
(<span style="color:#66d9ef">define </span>(mine-all thread-count)
  <span style="color:#75715e">; Global best values</span>
  (<span style="color:#66d9ef">define </span>start-time (current-inexact-milliseconds))
  (<span style="color:#66d9ef">define </span>best-str <span style="color:#66d9ef">#f</span>)
  (<span style="color:#66d9ef">define </span>best-hash <span style="color:#66d9ef">#f</span>)

  <span style="color:#75715e">; Create places</span>
  (<span style="color:#66d9ef">define </span>places
    (for/list ([i (in-range thread-count)])
      (mine i)))

  <span style="color:#75715e">; Loop through those, getting their best values in time</span>
  (<span style="color:#66d9ef">let </span>loop ()
    (for ([id (in-naturals)]
          [p (in-list places)])
      (<span style="color:#66d9ef">define </span>hashes-tried (place-channel-get p))
      (<span style="color:#66d9ef">define </span>str (place-channel-get p))
      (<span style="color:#66d9ef">define </span>hash (place-channel-get p))

      (when (<span style="color:#66d9ef">or </span>(not best-hash) (<span style="color:#66d9ef">and </span>hash (string&lt;? hash best-hash)))
        (<span style="color:#66d9ef">define </span>estimated-hashes (* hashes-tried thread-count))
        (<span style="color:#66d9ef">set! </span>best-str str)
        (<span style="color:#66d9ef">set! </span>best-hash hash)
        (print-timing id estimated-hashes (/ (- (current-inexact-milliseconds) start-time) <span style="color:#ae81ff">1000</span>) best-str best-hash)))
    (loop)))</code></pre></div>
<p>There is a potential inefficiency here, in that we go round robin through the places asking each in turn for their best hash. Because they wait a random amount of time (up to 10 seconds) between reports, it could be a bit before we actually report a new lowest hash<sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup>. In fact, it may even be out of date by then. Still, it&rsquo;s a reasonable enough count, especially if you&rsquo;re going to be running the program for a while.</p>

<p>So with that being said, the first thing to try would be a single place. Theoretically, that should give us the same performance as the original program (maybe minus a bit for the channel):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ racket mine-sha512-places.rkt <span style="color:#ae81ff">1</span>
<span style="color:#ae81ff">0</span>: 38H0DQxOWh0swGlq -&gt; 000581b5f1373c77... <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span>.1 kh @ <span style="color:#ae81ff">5</span>.4 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: TZdL5yWiiMb6WFVV -&gt; 00006cc7dac2d460... <span style="color:#f92672">(</span><span style="color:#ae81ff">252</span>.4 kh @ <span style="color:#ae81ff">116</span>.6 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: 0AnndUtx0XmNfX9a -&gt; 00000893ee217109... <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span>.3 Mh @ <span style="color:#ae81ff">136</span>.5 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: bGh0LDfnwCiSIb95 -&gt; 000001e204acff0c... <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span>.4 Mh @ <span style="color:#ae81ff">140</span>.2 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: JoWy6CXotik87OWh -&gt; 0000010fe4646f6f... <span style="color:#f92672">(</span><span style="color:#ae81ff">6</span>.5 Mh @ <span style="color:#ae81ff">140</span>.7 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: iS6rIH4kClxc0SdF -&gt; 000000ecdcc2cc1e... <span style="color:#f92672">(</span><span style="color:#ae81ff">16</span>.0 Mh @ <span style="color:#ae81ff">141</span>.3 kh/s<span style="color:#f92672">)</span></code></pre></div>
<p>Well that&rsquo;s not bad at all. If anything, it&rsquo;s a little faster<sup class="footnote-ref" id="fnref:4"><a rel="footnote" href="#fn:4">4</a></sup>.</p>

<p>Now, let&rsquo;s really let it go. I have 4 cores, so let&rsquo;s try 4 places:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ racket mine-sha512-places.rkt <span style="color:#ae81ff">4</span>
<span style="color:#ae81ff">0</span>: J1vkvS8s1WJJ7CUt -&gt; 003abedaf7fcdab7... <span style="color:#f92672">(</span><span style="color:#ae81ff">13</span>.2 kh @ <span style="color:#ae81ff">27</span>.6 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">1</span>: 383Xt0hLlAl0JZWO -&gt; 00098c00746f1807... <span style="color:#f92672">(</span><span style="color:#ae81ff">11</span>.5 kh @ <span style="color:#ae81ff">24</span>.0 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: 7EmH4gk7T2aecSph -&gt; 0000060d3d0f9ddf... <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span>.7 Mh @ <span style="color:#ae81ff">505</span>.7 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: XxeeMSUlYWPzrUh1 -&gt; 00000494b2eccdbf... <span style="color:#f92672">(</span><span style="color:#ae81ff">5</span>.5 Mh @ <span style="color:#ae81ff">519</span>.9 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">3</span>: 7a5MD2k0uILVj8aB -&gt; 000002037fce01ec... <span style="color:#f92672">(</span><span style="color:#ae81ff">7</span>.2 Mh @ <span style="color:#ae81ff">520</span>.5 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">1</span>: A3HTACsXRI5QkwWU -&gt; 000001de799bfeaa... <span style="color:#f92672">(</span><span style="color:#ae81ff">31</span>.9 Mh @ <span style="color:#ae81ff">529</span>.1 kh/s<span style="color:#f92672">)</span></code></pre></div>
<p>That&rsquo;s a lot more like it. And at a roughly 3.75x speedup over a single place, pretty much exactly what <a href="https://en.wikipedia.org/wiki/Amdal%27s%20law">Amdal&#39;s law</a> would expect we&rsquo;d be able to get in speedup. If we try it with 8, we don&rsquo;t do any better (a brief spike, but overall it&rsquo;s actually worse):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ racket mine-sha512-places.rkt <span style="color:#ae81ff">8</span>
<span style="color:#ae81ff">0</span>: JRxl4puWgUCIBvZ1 -&gt; 00016f513c85da0e... <span style="color:#f92672">(</span><span style="color:#ae81ff">49</span>.6 kh @ <span style="color:#ae81ff">54</span>.8 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">4</span>: LU5sj3zJmG30w4O3 -&gt; 000026edd66b3458... <span style="color:#f92672">(</span><span style="color:#ae81ff">13</span>.4 kh @ <span style="color:#ae81ff">11</span>.0 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">1</span>: AvFOADpeY1vn0q5z -&gt; 000018a5d4019643... <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span>.0 Mh @ <span style="color:#ae81ff">247</span>.9 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">2</span>: wyIvWO5nYh7MgbTR -&gt; 00000658bae50546... <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span>.6 Mh @ <span style="color:#ae81ff">452</span>.7 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">7</span>: ekrIcXa8CVmXKmVr -&gt; 000004e231c16d72... <span style="color:#f92672">(</span><span style="color:#ae81ff">5</span>.1 Mh @ <span style="color:#ae81ff">168</span>.4 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">1</span>: 1mTOnp0weetWHLbp -&gt; 00000270cab144e8... <span style="color:#f92672">(</span><span style="color:#ae81ff">24</span>.0 Mh @ <span style="color:#ae81ff">736</span>.0 kh/s<span style="color:#f92672">)</span>
<span style="color:#ae81ff">0</span>: 7GG6p6sK1e4EvbzV -&gt; 0000013d126816a5... <span style="color:#f92672">(</span><span style="color:#ae81ff">34</span>.2 Mh @ <span style="color:#ae81ff">459</span>.2 kh/s<span style="color:#f92672">)</span></code></pre></div>
<p>Of course that&rsquo;s still nothing on the record hashes so far. In the contest running <a href="http://www.h11e.com/">here</a>, the best as of my writing is <code>0000000003aeefb5...</code> A bit of a way to go, that.
Still, it&rsquo;s an interesting problem&ndash;and a nice excuse to learn a little more about places and channels in Racket. I&rsquo;ve used them before, but I think they made a little more sense this time around.</p>

<p>If you&rsquo;d like to see the entire code for today&rsquo;s post, it&rsquo;s on GitHub: <a href="https://github.com/jpverkamp/small-projects/tree/master/blog/mine-sha512">github/jpverkamp</a></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Those are generally measured in Mh/s
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">Threads give us <a href="https://en.wikipedia.org/wiki/Concurrency%20%28computer%20science%29">concurrency</a> in Racket, not <a href="https://en.wikipedia.org/wiki/Parallel%20computing">parallelism</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">Averaging 5 seconds times the number of places in fact
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
<li id="fn:4">Which is probably just an artifact of the timing. There&rsquo;s no particular reason this code should actually be faster.
 <a class="footnote-return" href="#fnref:4"><sup>[return]</sup></a></li>
</ol>
</div>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Exploring parallelism in Racket with SHA-512 mining";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2014\/02\/16\/exploring-parallelism-in-racket-with-sha-512-mining\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

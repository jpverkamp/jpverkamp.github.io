<!DOCTYPE html>
<html>
<head>
    <title>
    Fractal Invaders â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Fractal Invaders</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2014-09-16</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/09/15/look-and-say/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/racket">Racket</a>
                        <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/09/15/look-and-say/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a>
                        <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2012/09/10/fun-with-turtle-graphics-and-stars/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/fractals">Fractals</a>
                        <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/09/14/procedural-invaders/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/games">Games</a>
                        <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/09/14/procedural-invaders/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/graphics">Graphics</a>
                        <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2014/09/14/procedural-invaders/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/topics/procedural-content">Procedural Content</a>
                        <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link"></a>
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2014/09/15/look-and-say/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2014/09/15/look-and-say/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2014/09/17/invader-fractals/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>Today&rsquo;s post is a follow up to Sunday&rsquo;s post <a href="https://blog.jverkamp.com/2014/09/14/procedural-invaders/">Procedural Invaders</a>. This time around, we&rsquo;re going to work through two different space filling algorithms in order to eventually generate something like this:</p>

<figure>
    <img src="/embeds/2014/fractal-invaders-100x100.png"/> 
</figure>


<p>But before we get to that image, let&rsquo;s start with where I was Sunday. We had something that looked like this:</p>

<figure>
    <img src="/embeds/2014/random-invaders.png"/> 
</figure>


<p>That was my first take at a fractal invader algorithm, and in that case there really wasn&rsquo;t anything to do with fractals at all. The basic algorithm for that was simple:</p>

<ul>
<li>Choose a random location and size for an invader</li>
<li>If the new invader does not collide with any previous invader, place it</li>
<li>Go to step 1</li>
</ul>

<p>If we failed 100 times in a row to place an invader, we made the assumption that the space was empty and bailed out. It actually worked well enough. You got to see a bunch of invaders of different sizes, all together on the map. Unfortunately though, it didn&rsquo;t work particularly well for filling the entire space, which is really what I was after. (If you&rsquo;d like you can see the code for that on GitHub in Sunday&rsquo;s code: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/procedural-invaders.rkt">procedural-invaders.rkt</a>).</p>

<p>After that though, I took a step back. How can we actually fill the space? More specifically, how can we use recursion / fractals to efficiently fill the space? Well, what we really need is actually really similar to another previous post of mine: <a href="https://blog.jverkamp.com/2014/05/28/quadtree-image-compression/">Quadtree image compression</a>.</p>

<p>Basically, here&rsquo;s the new algorithm:</p>

<ul>
<li>Given a rectangular region, choose a random location and size for an invader</li>
<li>Recursively divide the remaining space into four sections: one above, one to the right, one below, and one to the left of the new invader</li>
<li>If any region is small enough for only a single invader, place it and stop (base case)</li>
<li>For each other region, start again at step 1</li>
</ul>

<p>The main odd step there is step 2 above. How can we split a region into five subregions (the center being square) like that? Well, we could do something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">| R
      | i
 Top  | g
______| h
   |  | t
 L |__|____
 e |
 f | Bottom
 t |</code></pre></div>
<p>Making sure that you have all of the regions set up exactly right gets a little bit complicated, but if you draw a nice diagram, it should be fairly straight forward to make sure that you always generate this structure. And that&rsquo;s exactly what we have here:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(struct rect (t l w h) <span style="color:#f92672">#</span>:transparent)
(struct node (bounds value-bounds value children) <span style="color:#f92672">#</span>:transparent)

<span style="color:#75715e">; Create the recursive fractal structure</span>
(<span style="color:#66d9ef">define </span>(made-fractal width height random-node)
  (<span style="color:#66d9ef">let </span>loop ([t <span style="color:#ae81ff">0</span>] [l <span style="color:#ae81ff">0</span>] [w width] [h height])
    (cond
      <span style="color:#75715e">; The next node is too small, do not place it</span>
      [(<span style="color:#66d9ef">or </span>(&lt;= w <span style="color:#ae81ff">0</span>) (&lt;= h <span style="color:#ae81ff">0</span>) (&gt;= t height) (&gt;= l width))
       <span style="color:#66d9ef">#f</span>]
      <span style="color:#75715e">; Create a child node; recur four times as so:</span>
      <span style="color:#75715e">;  T  |</span>
      <span style="color:#75715e">; __  |</span>
      <span style="color:#75715e">;   XX R</span>
      <span style="color:#75715e">; L XX__</span>
      <span style="color:#75715e">;   |</span>
      <span style="color:#75715e">;   | B</span>
      [else
       (<span style="color:#66d9ef">define </span>s (<span style="color:#66d9ef">if </span>(= (min w h) <span style="color:#ae81ff">1</span>) <span style="color:#ae81ff">1</span> (+ <span style="color:#ae81ff">1</span> (random (min w h)))))
       (<span style="color:#66d9ef">define </span>x (<span style="color:#66d9ef">if </span>(= w s)         <span style="color:#ae81ff">0</span> (random (- w s))))
       (<span style="color:#66d9ef">define </span>y (<span style="color:#66d9ef">if </span>(= h s)         <span style="color:#ae81ff">0</span> (random (- h s))))
       (node (rect t       l       w h) <span style="color:#75715e">; Bounds of this node</span>
             (rect (+ t y) (+ l x) s s) <span style="color:#75715e">; Bounds of the value within this node</span>
             (random-node)              <span style="color:#75715e">; The value of this node</span>
             (list (loop t         l         (+ x s)   y        )
                   (loop t         (+ l x s) (- w x s) (+ y s)  )
                   (loop (+ t y s) (+ l x)   (- w x)   (- h y s))
                   (loop (+ t y)   l         x         (- h y)  )))])))</code></pre></div>
<p>Essentially, we want to create a nested structure made out of <code>node</code> structs. For each node, we have two bounding boxes, one for the entire recursive structure and one just for the central image (which in turn defines the four children). Then we have a value which I&rsquo;ve already parameterized here as the <code>random-node</code> parameter and finally four children (ordered top, right, bottom, left, although it really doesn&rsquo;t matter).</p>

<p>What&rsquo;s neat about this is that the exact same code could theoretically be used for other structures. Say if we wanted 8 children for each of the orthagonal or diagonal directions. Just add more to the <code>node-children</code> list.</p>

<p>There are a few edge cases to watch out for that I did spend rather a while working out. For example, the base case deals with cases where either <code>w</code> or <code>h</code> is less than zero, but it also deals when we go off the right or bottom edge of the region. Likewise, we have to check if we only have exactly 1 square left in either width or height (which would mean we cannot generate an interesting random size) or if we only have exactly enough room for one shape.</p>

<p>After that, it&rsquo;s just a matter of getting the parameters right for the recursive calls. Let&rsquo;s try one out:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (make-fractal <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">3</span> (const <span style="color:#66d9ef">#t</span>))
(node
 (rect <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">3</span>)
 (rect <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">3</span>)
 <span style="color:#66d9ef">#t</span>
 (list
  <span style="color:#66d9ef">#f</span>
  (node
   (rect <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">3</span>)
   (rect <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>)
   <span style="color:#66d9ef">#t</span>
   (list
    (node (rect <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>) (rect <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">#t</span> <span style="color:#f92672">&#39;</span>(<span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span>))
    <span style="color:#66d9ef">#f</span>
    (node (rect <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>) (rect <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">#t</span> <span style="color:#f92672">&#39;</span>(<span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span> <span style="color:#66d9ef">#f</span>))
    <span style="color:#66d9ef">#f</span>))
  <span style="color:#66d9ef">#f</span>
  <span style="color:#66d9ef">#f</span>))</code></pre></div>
<p>If you take each of those in order, you have the regions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">AAAB
AAAC
AAAD</code></pre></div>
<p>So we generated a 3x3 region first and then filled in the rest with 1x1s. Of course that&rsquo;s not very nice to visualize. Let&rsquo;s make something a little prettier:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#66d9ef">define </span>(in? bounds x y)
  (match-define (rect t l w h) bounds)
  (<span style="color:#66d9ef">and </span>(&lt;= l x (+ l w <span style="color:#ae81ff">-1</span>))
       (&lt;= t y (+ t h <span style="color:#ae81ff">-1</span>))))

<span style="color:#75715e">; Render a fractal image</span>
(<span style="color:#66d9ef">define </span>(fractal-image
         width height
         <span style="color:#f92672">#</span>:random-color [random-color (thunk (vector (random) (random) (random)))])

  (<span style="color:#66d9ef">define </span>root (make-fractal width height random-color))

  (flomap-&gt;bitmap
   (build-flomap*
    <span style="color:#ae81ff">3</span> width height
    (Î» (x y)
      (<span style="color:#66d9ef">let </span>loop ([node root])
        (cond
          [(in? (node-value-bounds node) x y) (node-value node)]
          [else
           (for*/first ([child (in-list (node-children node))]
                        <span style="color:#f92672">#</span>:when (<span style="color:#66d9ef">and </span>child (in? (node-bounds child) x y)))
             (loop child))]))))))</code></pre></div>
<p>That&rsquo;s surprisingly simple, but then again most of the work was already done in setting up the structure. The most complicated bit here is that we have two different usages of the <code>in?</code> function:</p>

<ul>
<li><code>(in? (node-value-bounds node) x y)</code> - checks if the current point is in the current node&rsquo;s value box (the inner box); if that&rsquo;s the case, this is our base case</li>
<li><code>(in? (node-bounds child) x y)</code> - if this is true for any of the child node&rsquo;s outer box; if that&rsquo;s true we know that our value is somewhere in that subtree</li>
</ul>

<p>That&rsquo;s all we need to make some pretty neat images, just changing how we generate colors:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-image <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">200</span>)</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-image-random.png"/> 
</figure>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-image <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">200</span> <span style="color:#f92672">#</span>:random-color (thunk (<span style="color:#66d9ef">let </span>([g (random)]) (vector g g g))))</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-image-gray.png"/> 
</figure>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-image <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">200</span>
                 <span style="color:#f92672">#</span>:random-color (thunk
                                  (<span style="color:#66d9ef">case </span>(random <span style="color:#ae81ff">3</span>)
                                    [(<span style="color:#ae81ff">0</span>) (vector (random) <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>)]
                                    [(<span style="color:#ae81ff">1</span>) (vector <span style="color:#ae81ff">0</span> (random) <span style="color:#ae81ff">0</span>)]
                                    [(<span style="color:#ae81ff">2</span>) (vector <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> (random))])))</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-image-rgb.png"/> 
</figure>


<p>Which, honestly, would be a pretty neat post all by itself. But wasn&rsquo;t the entire point of this to made a fractal out of the <a href="https://blog.jverkamp.com/2014/09/14/procedural-invaders/">procedural invaders</a>?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; Render a fractal image made of invaders!</span>
(<span style="color:#66d9ef">define </span>(fractal-invaders width height <span style="color:#f92672">#</span>:highlights? [highlights? <span style="color:#66d9ef">#f</span>])
  (<span style="color:#66d9ef">define </span>(random-invader)
    (flomap-add-margin
     (<span style="color:#66d9ef">if </span>highlights?
         (procedural-invader/highlight (random <span style="color:#ae81ff">524288</span>))
         (procedural-invader (random <span style="color:#ae81ff">32768</span>)))
     <span style="color:#ae81ff">1</span>))

  (<span style="color:#66d9ef">define </span>root (make-fractal (quotient width <span style="color:#ae81ff">7</span>)
                             (quotient height <span style="color:#ae81ff">7</span>)
                             random-invader))

  (flomap-&gt;bitmap
   (build-flomap*
    (<span style="color:#66d9ef">if </span>highlights? <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span>) width height
    (Î» (x y)
      <span style="color:#75715e">; Correct for coordinates within the node</span>
      (<span style="color:#66d9ef">define </span>nx (quotient x <span style="color:#ae81ff">7</span>))
      (<span style="color:#66d9ef">define </span>ny (quotient y <span style="color:#ae81ff">7</span>))

      (<span style="color:#66d9ef">let </span>loop ([n root])
        (cond
          [(in? (node-value-bounds n) nx ny)
           <span style="color:#75715e">; Calculate coordinates within the image</span>
           (match-define (node _ (rect t l s _) img _) n)
           (<span style="color:#66d9ef">define </span>ix (quotient (- x (* <span style="color:#ae81ff">7</span> l)) s))
           (<span style="color:#66d9ef">define </span>iy (quotient (- y (* <span style="color:#ae81ff">7</span> t)) s))
           (flomap-ref* img ix iy)]
          [else
           (or
            (for*/first ([child (in-list (node-children n))]
                         <span style="color:#f92672">#</span>:when (<span style="color:#66d9ef">and </span>child (in? (node-bounds child) nx ny)))
              (loop child))
            (<span style="color:#66d9ef">if </span>highlights? <span style="color:#f92672">&#39;#</span>(<span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&#39;#</span>(<span style="color:#ae81ff">1</span>)))]))))))</code></pre></div>
<p>Okay, this code isn&rsquo;t quite as nice. Mostly, that&rsquo;s because of a simplifying requirement that I started with: we&rsquo;re going to be working with a grid where each &lsquo;pixel&rsquo; is a single minimal size invader. With a 1 pixel margin, that means that our minimum image size is 7x7 (thus the 7s scattered throughout the code).</p>

<p>Unfortunately, that does make our base case a little more complicated, since we&rsquo;re working with two different coordinate systems: image coordinates <code>x</code> and <code>y</code> and fractal coordinates <code>nx</code> and <code>ny</code>. Still, add in some offsets by 7 and a bit of padding down at the end (for images not divisible by 7) and off we go:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-invaders <span style="color:#ae81ff">100</span> <span style="color:#ae81ff">100</span>)</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-invaders-100x100.png"/> 
</figure>


<p>It also works great for larger images:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-invaders <span style="color:#ae81ff">400</span> <span style="color:#ae81ff">200</span>)</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-invaders-400x200.png"/> 
</figure>


<p>It even supports highlights:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-invaders <span style="color:#ae81ff">400</span> <span style="color:#ae81ff">200</span> <span style="color:#f92672">#</span>:highlights? <span style="color:#66d9ef">#t</span>)</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-invaders-400x200-highlights.png"/> 
</figure>


<p>Now that&rsquo;s what I&rsquo;m talking about. Unfortunately, the process is still somewhat random:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-invaders <span style="color:#ae81ff">100</span> <span style="color:#ae81ff">100</span>)</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-invaders-100x100-big.png"/> 
</figure>


<p>Sometimes the first random image is a little on the annoyingly large size. Off the top of my head, there are two ways to deal with it: either add an option parameter that controls the maximum size of a block or just keep generating images until you get what you are looking for.</p>

<p>Guess which solution I prefer? ðŸ˜„</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">(<span style="color:#66d9ef">define </span>(fractal-invaders <span style="color:#f92672">...</span> <span style="color:#f92672">#</span>:maximum-invader-size [max-size <span style="color:#66d9ef">#f</span>])
  <span style="color:#f92672">...</span>
  (<span style="color:#66d9ef">define </span>root
    (make-fractal
     (quotient width <span style="color:#ae81ff">7</span>)
     (quotient height <span style="color:#ae81ff">7</span>)
     random-invader
     <span style="color:#f92672">#</span>:maximum-block-size (<span style="color:#66d9ef">and </span>max-size (/ max-size <span style="color:#ae81ff">7</span>))))
  <span style="color:#f92672">...</span>)

(<span style="color:#66d9ef">define </span>(make-fractal width height random-node <span style="color:#f92672">#</span>:maximum-block-size [max-size <span style="color:#66d9ef">#f</span>])
  <span style="color:#f92672">...</span>
      [else
       (<span style="color:#66d9ef">define </span>s
         (<span style="color:#66d9ef">let </span>loop ()
           (<span style="color:#66d9ef">define </span>s (<span style="color:#66d9ef">if </span>(= (min w h) <span style="color:#ae81ff">1</span>) <span style="color:#ae81ff">1</span> (+ <span style="color:#ae81ff">1</span> (random (min w h)))))
           (cond
             [(<span style="color:#66d9ef">or </span>(not max-size) (&lt; s max-size)) s]
             [<span style="color:#66d9ef">else </span>(loop)])))
       <span style="color:#f92672">...</span>])</code></pre></div>
<p>Simple!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (fractal-invaders <span style="color:#ae81ff">400</span> <span style="color:#ae81ff">200</span> <span style="color:#f92672">#</span>:highlights? <span style="color:#66d9ef">#t</span> <span style="color:#f92672">#</span>:maximum-invader-size <span style="color:#ae81ff">25</span>)</code></pre></div>
<figure>
    <img src="/embeds/2014/fractal-invaders-400x200-max-25.png"/> 
</figure>


<p>Beautiful!</p>

<p>I wonder what other sort of images I could make with a fractal space filling algorithm like this? ðŸ˜‡</p>

<p>As always, today&rsquo;s code is available on GitHub. Check it out: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/fractal-invaders.rkt">fractal-invaders.rkt</a> (Requires <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/procedural-invaders.rkt">procedural-invaders.rkt</a> to run.)</p>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Fractal Invaders";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2014\/09\/16\/fractal-invaders\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

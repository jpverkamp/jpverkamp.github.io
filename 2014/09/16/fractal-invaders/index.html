<!doctype html><html><head><title>Fractal Invaders â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet><link rel=stylesheet href=/custom.css defer><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Fractal Invaders</h1><div class=entry-meta><span class=entry-date>2014-09-16</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2014/09/15/look-and-say/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/09/15/look-and-say/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/09/10/fun-with-turtle-graphics-and-stars/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/fractals>Fractals</a><a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/09/14/procedural-invaders/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/games>Games</a><a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/09/14/procedural-invaders/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/graphics>Graphics</a><a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/09/14/procedural-invaders/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/procedural-content>Procedural Content</a><a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2014/09/15/look-and-say/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2014/09/15/look-and-say/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2014/09/17/invader-fractals/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Today&rsquo;s post is a follow up to Sunday&rsquo;s post <a href=https://blog.jverkamp.com/2014/09/14/procedural-invaders/>Procedural Invaders</a>. This time around, we&rsquo;re going to work through two different space filling algorithms in order to eventually generate something like this:</p><figure><img src=/embeds/2014/fractal-invaders-100x100.png></figure><p>But before we get to that image, let&rsquo;s start with where I was Sunday. We had something that looked like this:</p><figure><img src=/embeds/2014/random-invaders.png></figure><p>That was my first take at a fractal invader algorithm, and in that case there really wasn&rsquo;t anything to do with fractals at all. The basic algorithm for that was simple:</p><ul><li>Choose a random location and size for an invader</li><li>If the new invader does not collide with any previous invader, place it</li><li>Go to step 1</li></ul><p>If we failed 100 times in a row to place an invader, we made the assumption that the space was empty and bailed out. It actually worked well enough. You got to see a bunch of invaders of different sizes, all together on the map. Unfortunately though, it didn&rsquo;t work particularly well for filling the entire space, which is really what I was after. (If you&rsquo;d like you can see the code for that on GitHub in Sunday&rsquo;s code: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/procedural-invaders.rkt>procedural-invaders.rkt</a>).</p><p>After that though, I took a step back. How can we actually fill the space? More specifically, how can we use recursion / fractals to efficiently fill the space? Well, what we really need is actually really similar to another previous post of mine: <a href=https://blog.jverkamp.com/2014/05/28/quadtree-image-compression/>Quadtree image compression</a>.</p><p>Basically, here&rsquo;s the new algorithm:</p><ul><li>Given a rectangular region, choose a random location and size for an invader</li><li>Recursively divide the remaining space into four sections: one above, one to the right, one below, and one to the left of the new invader</li><li>If any region is small enough for only a single invader, place it and stop (base case)</li><li>For each other region, start again at step 1</li></ul><p>The main odd step there is step 2 above. How can we split a region into five subregions (the center being square) like that? Well, we could do something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>| R
</span></span><span style=display:flex><span>      | i
</span></span><span style=display:flex><span> Top  | g
</span></span><span style=display:flex><span>______| h
</span></span><span style=display:flex><span>   |  | t
</span></span><span style=display:flex><span> L |__|____
</span></span><span style=display:flex><span> e |
</span></span><span style=display:flex><span> f | Bottom
</span></span><span style=display:flex><span> t |
</span></span></code></pre></div><p>Making sure that you have all of the regions set up exactly right gets a little bit complicated, but if you draw a nice diagram, it should be fairly straight forward to make sure that you always generate this structure. And that&rsquo;s exactly what we have here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> rect (<span style=color:#a6e22e>t</span> l w h) <span style=color:#f92672>#</span>:transparent)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> node (<span style=color:#a6e22e>bounds</span> value-bounds value children) <span style=color:#f92672>#</span>:transparent)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Create the recursive fractal structure</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>made-fractal</span> width height random-node)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>loop ([t <span style=color:#ae81ff>0</span>] [l <span style=color:#ae81ff>0</span>] [w width] [h height])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; The next node is too small, do not place it</span>
</span></span><span style=display:flex><span>      [(<span style=color:#66d9ef>or </span>(&lt;= w <span style=color:#ae81ff>0</span>) (&lt;= h <span style=color:#ae81ff>0</span>) (&gt;= t height) (&gt;= l width))
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>#f</span>]
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Create a child node; recur four times as so:</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>;  T  |</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; __  |</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>;   XX R</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>; L XX__</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>;   |</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>;   | B</span>
</span></span><span style=display:flex><span>      [else
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>s (<span style=color:#66d9ef>if </span>(= (min w h) <span style=color:#ae81ff>1</span>) <span style=color:#ae81ff>1</span> (+ <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>random</span> (min w h)))))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>x (<span style=color:#66d9ef>if </span>(= w s)         <span style=color:#ae81ff>0</span> (<span style=color:#a6e22e>random</span> (- w s))))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>y (<span style=color:#66d9ef>if </span>(= h s)         <span style=color:#ae81ff>0</span> (<span style=color:#a6e22e>random</span> (- h s))))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>node</span> (<span style=color:#a6e22e>rect</span> t       l       w h) <span style=color:#75715e>; Bounds of this node</span>
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>rect</span> (+ t y) (+ l x) s s) <span style=color:#75715e>; Bounds of the value within this node</span>
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>random-node</span>)              <span style=color:#75715e>; The value of this node</span>
</span></span><span style=display:flex><span>             (list (<span style=color:#a6e22e>loop</span> t         l         (+ x s)   y        )
</span></span><span style=display:flex><span>                   (<span style=color:#a6e22e>loop</span> t         (+ l x s) (- w x s) (+ y s)  )
</span></span><span style=display:flex><span>                   (<span style=color:#a6e22e>loop</span> (+ t y s) (+ l x)   (- w x)   (- h y s))
</span></span><span style=display:flex><span>                   (<span style=color:#a6e22e>loop</span> (+ t y)   l         x         (- h y)  )))])))
</span></span></code></pre></div><p>Essentially, we want to create a nested structure made out of <code>node</code> structs. For each node, we have two bounding boxes, one for the entire recursive structure and one just for the central image (which in turn defines the four children). Then we have a value which I&rsquo;ve already parameterized here as the <code>random-node</code> parameter and finally four children (ordered top, right, bottom, left, although it really doesn&rsquo;t matter).</p><p>What&rsquo;s neat about this is that the exact same code could theoretically be used for other structures. Say if we wanted 8 children for each of the orthagonal or diagonal directions. Just add more to the <code>node-children</code> list.</p><p>There are a few edge cases to watch out for that I did spend rather a while working out. For example, the base case deals with cases where either <code>w</code> or <code>h</code> is less than zero, but it also deals when we go off the right or bottom edge of the region. Likewise, we have to check if we only have exactly 1 square left in either width or height (which would mean we cannot generate an interesting random size) or if we only have exactly enough room for one shape.</p><p>After that, it&rsquo;s just a matter of getting the parameters right for the recursive calls. Let&rsquo;s try one out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>make-fractal</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>3</span> (<span style=color:#a6e22e>const</span> <span style=color:#66d9ef>#t</span>))
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>#t</span>
</span></span><span style=display:flex><span> (<span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>#f</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>#t</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>node</span> (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>) (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>#t</span> <span style=color:#f92672>&#39;</span>(<span style=color:#66d9ef>#f</span> <span style=color:#66d9ef>#f</span> <span style=color:#66d9ef>#f</span> <span style=color:#66d9ef>#f</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>#f</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>node</span> (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>) (<span style=color:#a6e22e>rect</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>#t</span> <span style=color:#f92672>&#39;</span>(<span style=color:#66d9ef>#f</span> <span style=color:#66d9ef>#f</span> <span style=color:#66d9ef>#f</span> <span style=color:#66d9ef>#f</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>#f</span>))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>#f</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>#f</span>))
</span></span></code></pre></div><p>If you take each of those in order, you have the regions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>AAAB
</span></span><span style=display:flex><span>AAAC
</span></span><span style=display:flex><span>AAAD
</span></span></code></pre></div><p>So we generated a 3x3 region first and then filled in the rest with 1x1s. Of course that&rsquo;s not very nice to visualize. Let&rsquo;s make something a little prettier:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>in?</span> bounds x y)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>match-define</span> (<span style=color:#a6e22e>rect</span> t l w h) bounds)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>and </span>(&lt;= l x (+ l w <span style=color:#ae81ff>-1</span>))
</span></span><span style=display:flex><span>       (&lt;= t y (+ t h <span style=color:#ae81ff>-1</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Render a fractal image</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fractal-image</span>
</span></span><span style=display:flex><span>         width height
</span></span><span style=display:flex><span>         <span style=color:#f92672>#</span>:random-color [random-color (<span style=color:#a6e22e>thunk</span> (vector (<span style=color:#a6e22e>random</span>) (<span style=color:#a6e22e>random</span>) (<span style=color:#a6e22e>random</span>)))])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>root (<span style=color:#a6e22e>make-fractal</span> width height random-color))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>flomap-&gt;bitmap</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>build-flomap*</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>3</span> width height
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>Î»</span> (<span style=color:#a6e22e>x</span> y)
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>let </span>loop ([node root])
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>          [(<span style=color:#a6e22e>in?</span> (<span style=color:#a6e22e>node-value-bounds</span> node) x y) (<span style=color:#a6e22e>node-value</span> node)]
</span></span><span style=display:flex><span>          [else
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>for*/first</span> ([child (<span style=color:#a6e22e>in-list</span> (<span style=color:#a6e22e>node-children</span> node))]
</span></span><span style=display:flex><span>                        <span style=color:#f92672>#</span>:when (<span style=color:#66d9ef>and </span>child (<span style=color:#a6e22e>in?</span> (<span style=color:#a6e22e>node-bounds</span> child) x y)))
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>loop</span> child))]))))))
</span></span></code></pre></div><p>That&rsquo;s surprisingly simple, but then again most of the work was already done in setting up the structure. The most complicated bit here is that we have two different usages of the <code>in?</code> function:</p><ul><li><code>(in? (node-value-bounds node) x y)</code> - checks if the current point is in the current node&rsquo;s value box (the inner box); if that&rsquo;s the case, this is our base case</li><li><code>(in? (node-bounds child) x y)</code> - if this is true for any of the child node&rsquo;s outer box; if that&rsquo;s true we know that our value is somewhere in that subtree</li></ul><p>That&rsquo;s all we need to make some pretty neat images, just changing how we generate colors:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-image</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>200</span>)
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-image-random.png></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-image</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>#</span>:random-color (<span style=color:#a6e22e>thunk</span> (<span style=color:#66d9ef>let </span>([g (<span style=color:#a6e22e>random</span>)]) (vector g g g))))
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-image-gray.png></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-image</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>                 <span style=color:#f92672>#</span>:random-color (<span style=color:#a6e22e>thunk</span>
</span></span><span style=display:flex><span>                                  (<span style=color:#66d9ef>case </span>(<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>                                    [(<span style=color:#ae81ff>0</span>) (vector (<span style=color:#a6e22e>random</span>) <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>)]
</span></span><span style=display:flex><span>                                    [(<span style=color:#ae81ff>1</span>) (vector <span style=color:#ae81ff>0</span> (<span style=color:#a6e22e>random</span>) <span style=color:#ae81ff>0</span>)]
</span></span><span style=display:flex><span>                                    [(<span style=color:#ae81ff>2</span>) (vector <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> (<span style=color:#a6e22e>random</span>))])))
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-image-rgb.png></figure><p>Which, honestly, would be a pretty neat post all by itself. But wasn&rsquo;t the entire point of this to made a fractal out of the <a href=https://blog.jverkamp.com/2014/09/14/procedural-invaders/>procedural invaders</a>?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Render a fractal image made of invaders!</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fractal-invaders</span> width height <span style=color:#f92672>#</span>:highlights? [highlights? <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>random-invader</span>)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>flomap-add-margin</span>
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>if </span>highlights?
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>procedural-invader/highlight</span> (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>524288</span>))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>procedural-invader</span> (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>32768</span>)))
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>root (<span style=color:#a6e22e>make-fractal</span> (quotient width <span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>                             (quotient height <span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>                             random-invader))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>flomap-&gt;bitmap</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>build-flomap*</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>if </span>highlights? <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span>) width height
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>Î»</span> (<span style=color:#a6e22e>x</span> y)
</span></span><span style=display:flex><span>      <span style=color:#75715e>; Correct for coordinates within the node</span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>define </span>nx (quotient x <span style=color:#ae81ff>7</span>))
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>define </span>ny (quotient y <span style=color:#ae81ff>7</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>let </span>loop ([n root])
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>          [(<span style=color:#a6e22e>in?</span> (<span style=color:#a6e22e>node-value-bounds</span> n) nx ny)
</span></span><span style=display:flex><span>           <span style=color:#75715e>; Calculate coordinates within the image</span>
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>match-define</span> (<span style=color:#a6e22e>node</span> _ (<span style=color:#a6e22e>rect</span> t l s _) img _) n)
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>define </span>ix (quotient (- x (* <span style=color:#ae81ff>7</span> l)) s))
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>define </span>iy (quotient (- y (* <span style=color:#ae81ff>7</span> t)) s))
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>flomap-ref*</span> img ix iy)]
</span></span><span style=display:flex><span>          [else
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>or</span>
</span></span><span style=display:flex><span>            (<span style=color:#a6e22e>for*/first</span> ([child (<span style=color:#a6e22e>in-list</span> (<span style=color:#a6e22e>node-children</span> n))]
</span></span><span style=display:flex><span>                         <span style=color:#f92672>#</span>:when (<span style=color:#66d9ef>and </span>child (<span style=color:#a6e22e>in?</span> (<span style=color:#a6e22e>node-bounds</span> child) nx ny)))
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>loop</span> child))
</span></span><span style=display:flex><span>            (<span style=color:#66d9ef>if </span>highlights? <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span>)))]))))))
</span></span></code></pre></div><p>Okay, this code isn&rsquo;t quite as nice. Mostly, that&rsquo;s because of a simplifying requirement that I started with: we&rsquo;re going to be working with a grid where each &lsquo;pixel&rsquo; is a single minimal size invader. With a 1 pixel margin, that means that our minimum image size is 7x7 (thus the 7s scattered throughout the code).</p><p>Unfortunately, that does make our base case a little more complicated, since we&rsquo;re working with two different coordinate systems: image coordinates <code>x</code> and <code>y</code> and fractal coordinates <code>nx</code> and <code>ny</code>. Still, add in some offsets by 7 and a bit of padding down at the end (for images not divisible by 7) and off we go:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-invaders</span> <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>100</span>)
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-invaders-100x100.png></figure><p>It also works great for larger images:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-invaders</span> <span style=color:#ae81ff>400</span> <span style=color:#ae81ff>200</span>)
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-invaders-400x200.png></figure><p>It even supports highlights:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-invaders</span> <span style=color:#ae81ff>400</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>#</span>:highlights? <span style=color:#66d9ef>#t</span>)
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-invaders-400x200-highlights.png></figure><p>Now that&rsquo;s what I&rsquo;m talking about. Unfortunately, the process is still somewhat random:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-invaders</span> <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>100</span>)
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-invaders-100x100-big.png></figure><p>Sometimes the first random image is a little on the annoyingly large size. Off the top of my head, there are two ways to deal with it: either add an option parameter that controls the maximum size of a block or just keep generating images until you get what you are looking for.</p><p>Guess which solution I prefer? ðŸ˜„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fractal-invaders</span> <span style=color:#f92672>...</span> <span style=color:#f92672>#</span>:maximum-invader-size [max-size <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>root
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>make-fractal</span>
</span></span><span style=display:flex><span>     (quotient width <span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>     (quotient height <span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>     random-invader
</span></span><span style=display:flex><span>     <span style=color:#f92672>#</span>:maximum-block-size (<span style=color:#66d9ef>and </span>max-size (/ max-size <span style=color:#ae81ff>7</span>))))
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>make-fractal</span> width height random-node <span style=color:#f92672>#</span>:maximum-block-size [max-size <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>      [else
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>s
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>let </span>loop ()
</span></span><span style=display:flex><span>           (<span style=color:#66d9ef>define </span>s (<span style=color:#66d9ef>if </span>(= (min w h) <span style=color:#ae81ff>1</span>) <span style=color:#ae81ff>1</span> (+ <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>random</span> (min w h)))))
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>             [(<span style=color:#66d9ef>or </span>(not max-size) (&lt; s max-size)) s]
</span></span><span style=display:flex><span>             [<span style=color:#66d9ef>else </span>(<span style=color:#a6e22e>loop</span>)])))
</span></span><span style=display:flex><span>       <span style=color:#f92672>...</span>])
</span></span></code></pre></div><p>Simple!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>fractal-invaders</span> <span style=color:#ae81ff>400</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>#</span>:highlights? <span style=color:#66d9ef>#t</span> <span style=color:#f92672>#</span>:maximum-invader-size <span style=color:#ae81ff>25</span>)
</span></span></code></pre></div><figure><img src=/embeds/2014/fractal-invaders-400x200-max-25.png></figure><p>Beautiful!</p><p>I wonder what other sort of images I could make with a fractal space filling algorithm like this? ðŸ˜‡</p><p>As always, today&rsquo;s code is available on GitHub. Check it out: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/fractal-invaders.rkt>fractal-invaders.rkt</a> (Requires <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/procedural-invaders.rkt>procedural-invaders.rkt</a> to run.)</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script defer src=/custom.js></script></body></html>
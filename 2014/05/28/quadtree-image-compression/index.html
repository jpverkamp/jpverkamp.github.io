<!doctype html><html><head><title>Quadtree image compression – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.a8e11addf4349ee2ca5045f7f3cbf1febbf2c3a2840be2143ea69539c10f8c7f.js integrity="sha256-qOEa3fQ0nuLKUEX388vx/rvyw6KEC+IUPqaVOcEPjH8=" defer></script><script src=/katex_17296078054267651618.min.4a06464d8d6f8358d8896de62b53b5a89205d335dfd8c5b6b27edd7c039ae9d8.js integrity="sha256-SgZGTY1vg1jYiW3mK1O1qJIF0zXf2MW2sn7dfAOa6dg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.a17078917a4403310cd19178939257b706fb5e1da76167c9f4a6d2123c9d59c4.js integrity="sha256-oXB4kXpEAzEM0ZF4k5JXtwb7Xh2nYWfJ9KbSEjydWcQ=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.7420a1602c62a85d4b50881c1d8ce42f72c049dc2b097d440696425d6e54bb1e.css integrity="sha256-dCChYCxiqF1LUIgcHYzkL3LASdwrCX1EBpZCXW5Uux4="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.5ff4b87c40715a96119d8b5f34d971604fc65ab18f4870fd8da6ede9fd1e6188.css integrity="sha256-X/S4fEBxWpYRnYtfNNlxYE/GWrGPSHD9jabt6f0eYYg="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/home-automation/>Automation</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Quadtree image compression</h1><div class=entry-meta><span class=entry-date>2014-05-28</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2014/05/23/amicable-chains/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/05/23/amicable-chains/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2014/01/15/graph-coloring/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2014/06/17/factor-trees/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2014/03/11/brownian-trees/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/graphics>Graphics</a><a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2014/05/23/amicable-chains/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2014/05/23/amicable-chains/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2014/05/30/braille-unicode-pixelation/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>About two weeks ago, I came across a post via <a href=http://www.reddit.com/r/programming/>/r/programming</a>: <a href=http://www.reddit.com/r/programming/comments/25ptrk/quadtree_art/>Quadtree Art</a><sup><a href=https://github.com/fogleman/Quads>(src)</a></sup>. In a sentence, the goal is to recursively divide an image into a quadtree, at each step expanding the current node with the largest internal variance.</p><p>More specifically, the algorithm is as follows:</p><ul><li>Given an image <span class=latex-inline>\mathbb{I}</span></li><li>Split the image into four subimages, <span class=latex-inline>\mathbb{I}_1</span>
- <span class=latex-inline>\mathbb{I}_4</span></li><li>For each current node <span class=latex-inline>\mathbb{I}_i</span>
, calculate the median color <span class=latex-inline>\mathbb{A}_i</span>
and error <span class=latex-inline>\mathbb{E}_i = \sum \begin{vmatrix} \mathbb{I}(x,y) - \mathbb{A}_i \end{vmatrix}</span></li><li>Find the subimage with the largest error, split it into four further subimages</li><li>Repeat from step 3</li></ul><p>And if you can do all of that, you can get some pretty neat images:</p><figure><img src=/embeds/2014/pipes-stage1000.jpg></figure><p>But how do we turn that into code?</p><h2 id=quadtrees>Quadtrees</h2><p>Well, first we have to take a step back. We need some way of representing a quadtree. Perhaps a structure something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> quadtree (<span style=color:#a6e22e>top-left</span> top-right bottom-left bottom-right) <span style=color:#f92672>#</span>:transparent)
</span></span></code></pre></div><p>Then, each node will either be a further <code>quadtree</code> or a leaf (any sort of value). If we wanted to have a quadtree of numbers:</p><pre tabindex=0><code>1   | 2 3
    | 4 5
----+-----
6   | 7 8 
    | 9 0
</code></pre><p>We could do so like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#66d9ef>define </span>qt (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>) <span style=color:#ae81ff>6</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>0</span>)))
</span></span><span style=display:flex><span>&gt; qt
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>) <span style=color:#ae81ff>6</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>0</span>))
</span></span></code></pre></div><p>Recursive data structures at their finest &#x1f604;.</p><p>The next thing we want is a trio of helper functions: <code>quadtree-map</code>, <code>quadtree-reduce</code>, and <code>quadtree-ref</code>. In order, these will apply a function to each node in a quadtree, collapse a quadtree by replacing the structure of the tree with a function (I&rsquo;ll show an example later), or find a specific point within the quad tree.</p><p>First, map:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Map a function over the nodes in a quadtree</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>quadtree-map</span> f qt)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>quadtree?</span> qt)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>quadtree</span>
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>quadtree-map</span> f (<span style=color:#a6e22e>quadtree-top-left</span> qt))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>quadtree-map</span> f (<span style=color:#a6e22e>quadtree-top-right</span> qt))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>quadtree-map</span> f (<span style=color:#a6e22e>quadtree-bottom-left</span> qt))
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>quadtree-map</span> f (<span style=color:#a6e22e>quadtree-bottom-right</span> qt)))]
</span></span><span style=display:flex><span>    [<span style=color:#66d9ef>else </span>(<span style=color:#a6e22e>f</span> qt)]))
</span></span></code></pre></div><p>Easy enough. Saw we want the square of each value in the previous quadtree:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>quadtree-map</span> sqr qt)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>25</span>) <span style=color:#ae81ff>36</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>81</span> <span style=color:#ae81ff>0</span>))
</span></span></code></pre></div><p>Next, <code>quadtree-reduce</code>. To think about this one, look at the structure of a quadtree in the above example. Each <code>quadtree</code> call looks an awful lot like a function call. That&rsquo;s really all that a <code>reduce</code> is, is swapping out the call for another function. Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Reduce all nodes in a quadtree</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>quadtree-reduce</span> f qt)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>quadtree?</span> qt)
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>f</span> (<span style=color:#a6e22e>quadtree-reduce</span> f (<span style=color:#a6e22e>quadtree-top-left</span> qt))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>quadtree-reduce</span> f (<span style=color:#a6e22e>quadtree-top-right</span> qt))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>quadtree-reduce</span> f (<span style=color:#a6e22e>quadtree-bottom-left</span> qt))
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>quadtree-reduce</span> f (<span style=color:#a6e22e>quadtree-bottom-right</span> qt)))]
</span></span><span style=display:flex><span>    [<span style=color:#66d9ef>else </span>qt]))
</span></span></code></pre></div><p>So to add all of the nodes together:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>quadtree-reduce</span> + qt)
</span></span><span style=display:flex><span><span style=color:#ae81ff>45</span>
</span></span><span style=display:flex><span>&gt; qt
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>) <span style=color:#ae81ff>6</span> (<span style=color:#a6e22e>quadtree</span> <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>&gt; (+ <span style=color:#ae81ff>1</span> (+ <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>) <span style=color:#ae81ff>6</span> (+ <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>45</span>
</span></span></code></pre></div><p>Or always take the top right node:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>quadtree-reduce</span> (<span style=color:#a6e22e>λ</span> (<span style=color:#a6e22e>tl</span> tr bl br) tr) qt)
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>And finally, reference a specific point. This is the first time that we&rsquo;re dealing with quadtrees as a representation of space. Think of a space, saw 16 meters square. If you take the top right, you have from 0-8 on the y and 8-16 on the x. Take the top left of that and you have 0-4 on the y and 8-12 on the x.</p><p>In code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> region (<span style=color:#a6e22e>top</span> left width height) <span style=color:#f92672>#</span>:transparent)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Recur to a given point within a quadtree</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>quadtree-ref</span> qt width height x y <span style=color:#f92672>#</span>:return-region [return-region? <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>loop ([qt qt] [r (<span style=color:#a6e22e>region</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> width height)])
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>cond </span>
</span></span><span style=display:flex><span>      [(<span style=color:#a6e22e>quadtree?</span> qt)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>match-define</span> (<span style=color:#a6e22e>region</span> top left width height) r)
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>x-mid (+ left (quotient width <span style=color:#ae81ff>2</span>)))
</span></span><span style=display:flex><span>       (<span style=color:#66d9ef>define </span>y-mid (+ top  (quotient height <span style=color:#ae81ff>2</span>)))
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>match</span> (list (<span style=color:#66d9ef>if </span>(&lt; y y-mid) <span style=color:#e6db74>&#39;top</span> <span style=color:#e6db74>&#39;bottom</span>)
</span></span><span style=display:flex><span>                    (<span style=color:#66d9ef>if </span>(&lt; x x-mid) <span style=color:#e6db74>&#39;left</span> <span style=color:#e6db74>&#39;right</span>))
</span></span><span style=display:flex><span>         [<span style=color:#f92672>&#39;</span>(top    left)  (<span style=color:#a6e22e>loop</span> (<span style=color:#a6e22e>quadtree-top-left</span>     qt) (<span style=color:#a6e22e>region</span> top   left  (quotient width <span style=color:#ae81ff>2</span>) (quotient height <span style=color:#ae81ff>2</span>)))]
</span></span><span style=display:flex><span>         [<span style=color:#f92672>&#39;</span>(bottom left)  (<span style=color:#a6e22e>loop</span> (<span style=color:#a6e22e>quadtree-bottom-left</span>  qt) (<span style=color:#a6e22e>region</span> y-mid left  (quotient width <span style=color:#ae81ff>2</span>) (quotient height <span style=color:#ae81ff>2</span>)))]
</span></span><span style=display:flex><span>         [<span style=color:#f92672>&#39;</span>(top    right) (<span style=color:#a6e22e>loop</span> (<span style=color:#a6e22e>quadtree-top-right</span>    qt) (<span style=color:#a6e22e>region</span> top   x-mid (quotient width <span style=color:#ae81ff>2</span>) (quotient height <span style=color:#ae81ff>2</span>)))]
</span></span><span style=display:flex><span>         [<span style=color:#f92672>&#39;</span>(bottom right) (<span style=color:#a6e22e>loop</span> (<span style=color:#a6e22e>quadtree-bottom-right</span> qt) (<span style=color:#a6e22e>region</span> y-mid x-mid (quotient width <span style=color:#ae81ff>2</span>) (quotient height <span style=color:#ae81ff>2</span>)))])]
</span></span><span style=display:flex><span>      [return-region? r]
</span></span><span style=display:flex><span>      [<span style=color:#66d9ef>else </span>qt])))
</span></span></code></pre></div><p>It&rsquo;s a bit more complicated, but should be straight forward enough to read. Perhaps the most interesting part is the use of <code><a href="http://docs.racket-lang.org/search/index.html?q=match-define">match-define</a></code>
. Given a struct (such as a <code>region</code>), it can automatically destructure it. Much easier than a whole series of <code>define</code>s.</p><p>Whew.</p><h2 id=rendering-quadtrees>Rendering quadtrees</h2><p>Next, we need to actually turn one of these quadtrees back to an image. It turns out though, that that part is really easy. If we have a quadtree where each node is either recursive or a color (represented as a 4 vector of ARGB), you can render it as such:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Render a tree where each node is either a quadtree or a vector (color)</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>render-quadtree</span> qt width height)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>flomap-&gt;bitmap</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>build-flomap*</span> 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>4</span> width height
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>λ</span> (<span style=color:#a6e22e>x</span> y) (<span style=color:#a6e22e>quadtree-ref</span> qt width height x y)))))
</span></span></code></pre></div><p>As an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>render-quadtree</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>quadtree</span> <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>quadtree</span> <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>             <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>quadtree</span> <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&#39;#</span>(<span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>)))
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>100</span>)
</span></span></code></pre></div><figure><img src=/embeds/2014/sample-quadtree.png></figure><h2 id=loading-images-as-quadtrees>Loading images as quadtrees</h2><p>Okay, next step. Loading an image. What we want for an image is the original (so we can calculate the error) and a quadtree storing both average colors for each region (which will be rendered) and the error (so we do not have to recalculate them). Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> qtnode (<span style=color:#a6e22e>region</span> color error) <span style=color:#f92672>#</span>:transparent)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>struct</span> qtimage (<span style=color:#a6e22e>flomap</span> nodes))
</span></span></code></pre></div><p>(<code>qtimage</code> is not <code>#:transparent</code> since the <code>flomap</code> would display every single value&mldr; That takes a while to print out.)</p><p>That being said, when we first load an image, we&rsquo;re only going to have a single node representing the entire image. Still, we need an average and an error. So let&rsquo;s write that function first. Using the <code><a href="http://docs.racket-lang.org/search/index.html?q=median">median</a></code>
function from <code><a href="http://docs.racket-lang.org/search/index.html?q=math/statistics">math/statistics</a></code>
, we can find a good representation (another option would be the average). After that, we sum the difference along all channels (note: make sure to use <code>for*/sum</code> here, rather than <code>for/sum</code>&mldr;)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Calculate the average color within a region</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>region-node</span> fm r)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>match-define</span> (<span style=color:#a6e22e>region</span> top left width height) r)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>med
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>for/vector</span> ([k (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>4</span>)])
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>with-handlers</span> ([exn? (<span style=color:#a6e22e>λ</span> _ (<span style=color:#a6e22e>flomap-ref</span> fm k left top))])
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>median</span> &lt; (<span style=color:#a6e22e>for/list</span> ([x (<span style=color:#a6e22e>in-range</span> left (+ left width))]
</span></span><span style=display:flex><span>                             [y (<span style=color:#a6e22e>in-range</span> top (+ top height))])
</span></span><span style=display:flex><span>                    (<span style=color:#a6e22e>flomap-ref</span> fm k x y))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>err
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>for*/sum</span> ([k (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>4</span>)]
</span></span><span style=display:flex><span>               [x (<span style=color:#a6e22e>in-range</span> left (+ left width))]
</span></span><span style=display:flex><span>               [y (<span style=color:#a6e22e>in-range</span> top (+ top height))])
</span></span><span style=display:flex><span>      (abs (- (<span style=color:#a6e22e>flomap-ref</span> fm k x y) (vector-ref med k)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>qtnode</span> r med err))
</span></span></code></pre></div><p>Then you can load an image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Load an image in preparation for quadtree splitting</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>load-image</span> path)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>fm (<span style=color:#a6e22e>bitmap-&gt;flomap</span> (<span style=color:#a6e22e>read-bitmap</span> path)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>width</span> height) (<span style=color:#a6e22e>flomap-size</span> fm))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>r (<span style=color:#a6e22e>region</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> width height))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>node (<span style=color:#a6e22e>region-node</span> fm r))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>qtimage</span> fm node))
</span></span></code></pre></div><p>If we want to turn right around and render this image back out, we can do so by pulling out the color part of the quadtree nodes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Render an image</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>render-image</span> img)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>width</span> height) (<span style=color:#a6e22e>flomap-size</span> (<span style=color:#a6e22e>qtimage-flomap</span> img)))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>render-quadtree</span> (<span style=color:#a6e22e>quadtree-map</span> qtnode-color (<span style=color:#a6e22e>qtimage-nodes</span> img)) width height))
</span></span></code></pre></div><p>Given <code>pipes.jpg</code>:</p><figure><img src=/embeds/2014/pipes.jpg></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>render-image</span> (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;pipes.jpg&#34;</span>))
</span></span></code></pre></div><figure><img src=/embeds/2014/pipes-stage1.jpg></figure><p>Not much to look at yet. We need to start splitting&mldr;</p><h2 id=splitting-quadtree-images>Splitting quadtree images</h2><p>A lot of the hard work has already been done. What&rsquo;s left is two parts:</p><ul><li>Find the region with the largest error</li><li>Replace that node with four subnodes, calculating the median color and error for each</li></ul><p>Translated to code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Given an image, split the region with the highest error</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>split-image</span> img)
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Find the maximum error</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>max-error-node
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>quadtree-reduce</span> 
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>λ</span> ns (car (<span style=color:#a6e22e>sort</span> ns (<span style=color:#a6e22e>λ</span> (<span style=color:#a6e22e>na</span> nb) (&gt; (<span style=color:#a6e22e>qtnode-error</span> na) (<span style=color:#a6e22e>qtnode-error</span> nb))))))
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>qtimage-nodes</span> img)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Replace nodes with that error with their child nodes, calculating those errors</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>fm (<span style=color:#a6e22e>qtimage-flomap</span> img))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>qtimage</span> 
</span></span><span style=display:flex><span>   fm
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>quadtree-map</span> 
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>λ</span> (<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>        [(eq? node max-error-node)
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>match-define</span> (<span style=color:#a6e22e>region</span> t l w h) (<span style=color:#a6e22e>qtnode-region</span> node))
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define </span>w/2 (quotient w <span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>         (<span style=color:#66d9ef>define </span>h/2 (quotient h <span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>         (<span style=color:#a6e22e>quadtree</span>
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>let </span>([r (<span style=color:#a6e22e>region</span> t         l         w/2 h/2)]) (<span style=color:#a6e22e>region-node</span> fm r))
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>let </span>([r (<span style=color:#a6e22e>region</span> t         (+ l w/2) w/2 h/2)]) (<span style=color:#a6e22e>region-node</span> fm r))
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>let </span>([r (<span style=color:#a6e22e>region</span> (+ t h/2) l         w/2 h/2)]) (<span style=color:#a6e22e>region-node</span> fm r))
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>let </span>([r (<span style=color:#a6e22e>region</span> (+ t h/2) (+ l w/2) w/2 h/2)]) (<span style=color:#a6e22e>region-node</span> fm r)))]
</span></span><span style=display:flex><span>        [<span style=color:#66d9ef>else </span>node]))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>qtimage-nodes</span> img))))
</span></span></code></pre></div><p>The splitting code is a little ugly and could probably be factored out entirely into a <code>region</code> module all its own. So it goes. What&rsquo;s nice though is that we already have the <code>region-node</code> function, which will give us the color and error for a subnode.</p><p>Trying a few splits:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>render-image</span> (<span style=color:#a6e22e>split-image</span> (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;pipes.jpg&#34;</span>)))
</span></span></code></pre></div><figure><img src=/embeds/2014/pipes-stage2.jpg></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>render-image</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for/fold</span> ([img (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;pipes.jpg&#34;</span>)]) ([i (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>5</span>)])
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>split-image</span> img)))
</span></span></code></pre></div><figure><img src=/embeds/2014/pipes-stage5.jpg></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>render-image</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for/fold</span> ([img (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;pipes.jpg&#34;</span>)]) ([i (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>1000</span>)])
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>split-image</span> img)))
</span></span></code></pre></div><figure><img src=/embeds/2014/pipes-stage1000.jpg></figure><p>That&rsquo;s really starting to look good&mldr; But what if we want to watch the compression live?</p><h2 id=rendering-compression>Rendering compression</h2><p>This is one of the things I really like about Racket. It really is &ldquo;batteries included&rdquo;. In this case, we have a pre-built framework for updating and rendering images: <code><a href="http://docs.racket-lang.org/search/index.html?q=big-bang">big-bang</a></code>
from <code><a href="http://docs.racket-lang.org/search/index.html?q=2htdp/universe">2htdp/universe</a></code>
(among others). All we have to do is pass it an updating and drawing function (<code>render?</code> will allow us to save a GIF):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; Progressively compress an image</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>compress</span> img)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>width</span> height) (<span style=color:#a6e22e>flomap-size</span> (<span style=color:#a6e22e>qtimage-flomap</span> img)))
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>define </span>base-scene (<span style=color:#a6e22e>empty-scene</span> width height))
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>big-bang</span> img
</span></span><span style=display:flex><span>    [on-tick split-image]
</span></span><span style=display:flex><span>    [to-draw (<span style=color:#a6e22e>λ</span> (<span style=color:#a6e22e>img</span>) (<span style=color:#a6e22e>place-image</span> (<span style=color:#a6e22e>render-image</span> img) (/ width <span style=color:#ae81ff>2</span>) (/ height <span style=color:#ae81ff>2</span>) base-scene))]
</span></span><span style=display:flex><span>    [record? <span style=color:#66d9ef>#t</span>]))
</span></span></code></pre></div><p>Bam:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>compress</span> (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;pipes.jpg&#34;</span>))
</span></span></code></pre></div><figure><img src=/embeds/2014/pipes.gif></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>compress</span> (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;bigen.jpg&#34;</span>))
</span></span></code></pre></div><figure><img src=/embeds/2014/bigben.gif></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>compress</span> (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;chess.jpg&#34;</span>))
</span></span></code></pre></div><figure><img src=/embeds/2014/chess.gif></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>compress</span> (<span style=color:#a6e22e>load-image</span> <span style=color:#e6db74>&#34;flower.jpg&#34;</span>))
</span></span></code></pre></div><figure><img src=/embeds/2014/flower.gif></figure><p>And there you have it. I really like digging into alternative ways of representing data, particularly images. If you have any questions/comments, feel free to drop me a line below. Otherwise, the code is on GitHub as always: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/quadtree-compression.rkt>quadtree-compression.rkt</a>.</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!DOCTYPE html>
<html>
<head>
        
        

        <title>Phone networks | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/tomorrow-night.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Phone networks</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2014-05-21"><span class="year">2014</span> <span class="month">May</span> <span class="day">21</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-source/daily-programmer">Daily Programmer</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/data-structures/graphs">Graphs</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>Another day, <a href="http://www.reddit.com/r/dailyprogrammer/comments/25576s/592014_challenge_161_hard_phone_network/">another challenge from /r/dailyprogrammer</a>. It's almost two weeks old now, but I've just now had a chance to get around it.</p>
<blockquote>Your company has built its own telephone network. This allows all your remote locations to talk to each other. It is your job to implement the program to establish calls between locations.</blockquote>
<!--more-->
<h2>Problem description</h2>
<p>Basically, this is an exercise in graph theory. Given a weighted graph (in this case representing locations in our call network and the maximum bandwidth between locations), route a series of calls between the nodes. There's an aspect of optimization to it as well, although if you cannot see the future, there's only so much you can do to be able to guess what future calls you'll have to route.</p>
<p>As stated in the problem, our input will be given by a list of source, destination, weight triples. Something like this:</p>
<pre>A B 2
A C 2
B C 2
B D 2
C E 1
D E 2
D G 1
E F 2
F G 2
</pre>
<p>Unusually for an /r/dailyprogrammer challenge, there isn't an indication for how many records we have to read. Instead, there will be a blank line at the end of the section. Still, that's easy enough to deal with. Something like this:</p>
<pre class="scheme"><code>; Read a phone network as a weighted undirect graph, form {from} {to} {weight}
(define (read-network [in (current-input-port)])
  (define g (weighted-graph/directed '()))
  (for ([line (in-lines in)]
        #:break (equal? line ""))
    (match-define (list from to weight) (string-split line))
    (add-edge! g from to (string-&gt;number weight))
    (add-edge! g to from (string-&gt;number weight)))

  g)</code></pre>
<p>(We're using stchang's <a href="http://blog.jverkamp.com/2014/01/14/graph-radius">[1]</a><a href="http://blog.jverkamp.com/2014/01/15/graph-coloring">[2]</a>.)</p>
<p>After that, we'll have a series of calls to route:</p>
<pre>A G
A G
C E
G D
D E
A B
A D</pre>
<p>In this case, each call will be a pair of nodes, the source and the destination (although routes are not directional). Since we're reading to the end of the file and only reading two parts, the code is much cleaner.</p>
<pre class="scheme"><code>; Read a sequential list of calls formatted as {from} {to}
(define (read-calls [in (current-input-port)])
  (for/list ([line (in-lines in)])
    (string-split line)))</code></pre>
<p>So we've gotten the problem read in, now all that's left is solving it. :)</p>
<h2>Routing calls</h2>
<p>First things first, what are we going to return? Eventually, I need to have a list of paths (one for each call) or a failure if we couldn't route a particular call. In addition, I want to keep the current network at each step, to help with debugging. So perhaps something like this:</p>
<pre class="scheme"><code>; Each step of a solution will have
; - the current graph (before routing)
; - the call being made
; - the found route (or #f)
(struct step (graph call route) #:transparent)</code></pre>
<p>Other than that, the algorithm is straight forward. For each call, find a route. If we find a route, reduce the bandwidth on each node. If not, report failed and leave the network alone.</p>
<p>Technically, finding the paths is interesting in and of itself. There are a number of algorithms, depending on which route you're looking for. One of particular interest is <a href="https://en.wikipedia.org/wiki/Dijkstra's_algorithm">Dijkstra's algorithm</a>, which already has an implementation of sorts in the library I'm using. One thing that it doesn't do; however, is route from one node to another, it actually does far more, routing from one node to all others (a natural result of running Dijkstra's algorithm anyways). So we need a function that will extract a single path from that result:</p>
<pre class="scheme"><code>; Specialization of the graph library to find a single path using dijkstra's
(define (dijkstra-path graph from to)
  (define-values (_ preds)
    (dijkstra graph from))

  (let loop ([to to] [path '()])
    (cond
      [(equal? from to)
       (cons to path)]
      [(hash-ref preds to #f)
       =&gt; (λ (next)
            (loop next (cons to path)))]
      [else
       #f])))</code></pre>
<p>Using the <code>=></code> form of <code>cond</code>, we can return the path if there is one, or immediately short circuit with no path if we ever fail. Additionally, using an accumulator (<code>path</code>), means that the list is naturally in the order we want, where it would have been reversed in the more 'natural' recursive form.</p>
<p>That's basically everything we need. Given functions to read in the data and a path finder for each step, we can solve the entire call set:</p>
<pre class="scheme"><code>; Given a phone network and sequence of calls, place as many as possible
(define (solve [in (current-input-port)])
  (define network (read-network in))
  (define calls (read-calls in))

  ; Try to route each call in turn
  ; Take the shortest path possible using dijkstra's algorithm for routing
  (for/list ([call (in-list calls)])
    (match-define (list from to) call)
    (cond
      ; We can find a path; write it and update the network
      [(dijkstra-path network from to)
       =&gt; (λ (path)
            (begin0
              (step (graph-copy network) call path)
              (let loop ([path path])
                (match path
                  ; As long as there are at least two nodes:
                  ; - Calculate the new edge weight
                  ; - Remove the current edge (no way to directly update)
                  ; - If new weight is not zero, add the new edges
                  [(list-rest from to rest)
                   (define weight (- (edge-weight network from to) 1))
                   (remove-edge! network from to)
                   (remove-edge! network to from)
                   (when (&gt; weight 0)
                     (add-edge! network from to weight)
                     (add-edge! network to from weight))
                   (loop rest)]
                  [any (void)]))))]
      ; No path; print failure and leave the network
      [else
       (step (graph-copy network) call #f)])))</code></pre>
<p>Honestly, adding and removing the nodes is the largest part of the code. Perhaps I should add in an <code>edit-weight!</code> function. Anyways, this gives us a simple enough way to solve the problems given:</p>
<pre class="scheme"><code>&gt; (with-input-from-string "A B 1
B C 2
C D 2
D E 2
E F 2
F G 2
G A 2
E H 1
H D 1

A C
A D
A D
F D
B D
B D
B E
C F" solve)
(list
 (step #&lt;weighted-graph&gt; '("A" "C") '("A" "B" "C"))
 (step #&lt;weighted-graph&gt; '("A" "D") '("A" "G" "F" "E" "D"))
 (step #&lt;weighted-graph&gt; '("A" "D") '("A" "G" "F" "E" "D"))
 (step #&lt;weighted-graph&gt; '("F" "D") #f)
 (step #&lt;weighted-graph&gt; '("B" "D") '("B" "C" "D"))
 (step #&lt;weighted-graph&gt; '("B" "D") '("B" "C" "D"))
 (step #&lt;weighted-graph&gt; '("B" "E") #f)
 (step #&lt;weighted-graph&gt; '("C" "F") #f))</code></pre>
<p>So for this case, we could only route 5 of the 8 calls. Oops. It turns out there's a solution that routes 6 of them, but only if you can see the future and purposely don't route one of the early further apart calls.</p>
<p>Well, that's all well and good, but how about some visualization?</p>
<h2>Visualizing output</h2>
<p>My goal is going to be to write out a 'solution directory'. First, we need a summary file (actually writing out the solution the problem asked for):</p>
<pre class="scheme"><code>; Write a solution to a directory
(define (write-solution steps output-directory)
  ; Make sure the output directory exists (files will be overwritten)
  (when (not (directory-exists? output-directory))
    (make-directory output-directory))

  ; First generate a summary file
  (with-output-to-file (build-path output-directory "summary.txt")
    (thunk
      (for ([i (in-naturals 1)]
            [each (in-list steps)])

        (match-define (step network call path) each)
        (match-define (list from to) call)

        (printf "~a -&gt; ~a ... ~a\n"
                from
                to
                (or path "failed")))))

  ...)</code></pre>
<p>Straight foward enough. The only interesting piece is writing either the path <code>or</code> "failed", which we can get away with because <code>or</code> short circuits. Easy enough.</p>
<p>Next, display the networks:</p>
<pre class="scheme"><code>...

; Generate a graph for each step
(for ([i (in-naturals 1)]
      [each (in-list steps)])

  (match-define (step network call path) each)

  ; Generate a coloring with distinct colors for path
  (define colors
    (for/hash ([node (in-vertices network)])
      (values node (cond
                     [(equal? node (first path)) 1]
                     [(equal? node (last path))  2]
                     [(member node path)         3]
                     [else                       0]))))

  ; Paramaterize each step filename so we can make dots and images
  (define (filename ext)
    (format "~a.~a"
            (~a i #:min-width 2 #:align 'right #:pad-string "0")
            ext))

  ; Write the dot file
  (with-output-to-file (build-path output-directory (filename "dot"))
    #:exists 'replace
    (thunk
      (display (graphviz network #:colors colors))))

  ; Use the dot file to generate an image
  (system (format "neato -Tpng ~a &gt; ~a"
                  (build-path output-directory (filename "dot"))
                  (build-path output-directory (filename "png"))))))</code></pre>
<p>It's a bit complicated looking, but really there are four parts. First, we generate a coloring. A <a href="http://blog.jverkamp.com/2014/01/15/graph-coloring">little while ago</a> I made the function that would successfully display a coloring, so for that we need to create a hash of vertex labels to integers. In this case, we'll have distinct colors for the source (green), path (purple), destination (cyan), and unrelated nodes (red). Something like this:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2014/05/21/phone-networks/01.png"><img src="http://blog.jverkamp.com/2014/05/21/phone-networks/01.png" /></a></p>
<p></p>
<p>The next part generates a filename generating function (so we can parameterize over the extension). Straight forward, we just want to make sure we have two digits so they'll sort correctly, thus the use of <code>~a</code> (I wish there were a shorter way to do this).</p>
<p>After that, write out the file generated by the <code>graphviz</code> function, then call <code>neato</code> on my local system to generate the image. From that, we get a nice series of images:</p>
<pre>summary.txt:
A -> G ... (A B D G)
A -> G ... (A C E F G)
C -> E ... (C E)
G -> D ... (G F E D)
D -> E ... (D E)
A -> B ... (A B)
A -> D ... (A C B D)</pre>
<p>[gallery link="file" columns="3" orderby="title"]</p>
<p>Yay graphs!</p>
<p>And that's it for today. If you want to see the entire code all in one place, you can do so on GitHub as always: <a href="https://github.com/jpverkamp/small-projects/blob/master/blog/phone-network.rkt">phone-network.rkt</a></p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Phone networks";
var disqus_url = "http://blog.jverkamp.com/2014/05/21/phone-networks/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2014/05/19/novel-compression">← Novel compression</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2014/05/23/amicable-chains">Amicable chains →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2014/05/19/novel-compression">← Novel compression</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2014/05/23/amicable-chains">Amicable chains →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
<!doctype html><html><head><title>Genuary 2026.13: Self Portrait â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.a8e11addf4349ee2ca5045f7f3cbf1febbf2c3a2840be2143ea69539c10f8c7f.js integrity="sha256-qOEa3fQ0nuLKUEX388vx/rvyw6KEC+IUPqaVOcEPjH8=" defer></script><script src=/katex_17296078054267651618.min.4a06464d8d6f8358d8896de62b53b5a89205d335dfd8c5b6b27edd7c039ae9d8.js integrity="sha256-SgZGTY1vg1jYiW3mK1O1qJIF0zXf2MW2sn7dfAOa6dg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.a17078917a4403310cd19178939257b706fb5e1da76167c9f4a6d2123c9d59c4.js integrity="sha256-oXB4kXpEAzEM0ZF4k5JXtwb7Xh2nYWfJ9KbSEjydWcQ=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.7420a1602c62a85d4b50881c1d8ce42f72c049dc2b097d440696425d6e54bb1e.css integrity="sha256-dCChYCxiqF1LUIgcHYzkL3LASdwrCX1EBpZCXW5Uux4="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.5ff4b87c40715a96119d8b5f34d971604fc65ab18f4870fd8da6ede9fd1e6188.css integrity="sha256-X/S4fEBxWpYRnYtfNNlxYE/GWrGPSHD9jabt6f0eYYg="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/home-automation/>Automation</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Genuary 2026.13: Self Portrait</h1><div class=entry-meta><span class=entry-date>2026-01-13</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2026/01/12/genuary-2026.12-boxes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/generative-art>Generative Art</a><a href=https://blog.jverkamp.com/2026/01/14/genuary-2026.14-fits-perfectly/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2026/01/12/genuary-2026.12-boxes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/procedural-content>Procedural Content</a><a href=https://blog.jverkamp.com/2026/01/14/genuary-2026.14-fits-perfectly/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2026/01/12/genuary-2026.12-boxes/ class=previous-link></a><a class=taxonomy-value href=/series/genuary-2026>Genuary 2026</a><a href=https://blog.jverkamp.com/2026/01/14/genuary-2026.14-fits-perfectly/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2026/01/12/genuary-2026.12-boxes/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2026/01/14/genuary-2026.14-fits-perfectly/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2026/01/12/genuary-2026.12-boxes/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2026/01/14/genuary-2026.14-fits-perfectly/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><figure class=cover-image><img src=gen26.13.png></figure><h2 id=13-self-portrait>13) Self Portrait</h2><p>That was surprisingly fun.</p><p>Basically, it will take recursively divide the picture over time. Each time, it will find the node with the largest error (real image color compared to the current random color) and split it in 4, assigning each to the nearest random color from our palette.</p><ul><li><code>colors</code> controls how many maximum (random) colors will be chosen</li><li><code>edges</code> will draw the boxes of the tree</li><li><code>minimumBlock</code> is the size at which it won&rsquo;t split any more</li><li><code>resetAfter</code> will generate new colors even this many frames</li><li><code>evenSplit</code> will split each box into exactly 4; if this is off, each axis will randomly be 25-75%</li><li><code>weightErrorBySize</code> will split small boxes earlier; with this off, larger boxes have more error because they are larger</li></ul><p>If you don&rsquo;t want to look at me any more, turning off <code>selfPortraitMode</code> will load an image from <a href=https://picsum.dev/ target=_blank rel=noopener>picsum.dev</a>.</p><div class=tab><button id=iframedemo class="tablinks default" data-tabset=d8ee onclick='changeTab(event,"d8ee","iframedemo")'>Demo</button>
<button id=defaultscript class=tablinks data-tabset=d8ee onclick='changeTab(event,"d8ee","defaultscript")'>Script</button></div><div class=tabcontent data-tabset=d8ee id=iframedemo><iframe marginwidth=0 width=660 height=506.00000000000006 frameborder=0 srcdoc='
            
<html>
<head>
<script src="https://blog.jverkamp.com/p5.min_5364076176882696478.min.03e58eac22b37cd98b545eab49e3c890d99eecac6d1cbe8a3880fade45bb09ff.js"></script><script src="https://blog.jverkamp.com/quicksettings_5902975354937418934.min.dbab3b4814bc1161ccdfe3780ee5adc04c40a6ecbb9c4f081c437d4cca0fe56a.js"></script><script src="https://blog.jverkamp.com/p5.gui_266292142240667823.min.5aca091ab81f7b1e9d8c792eeff5e79f6d36cdbe86e6b7d7256271bfebbce865.js"></script>

    <style>canvas { border: 1px solid black; border-radius: 1em; }</style>
</head>
<body>

            <script>

            
                
let gui;
let params = {
  colors: 10, colorsMin: 2, colorsMax: 256,
  edges: false,
  minimumBlock: 3, minimumBlockMin: 1, minimumBlockMax: 10,
  selfPortraitMode: true,
  resetAfter: 1000, resetAfterMin: 10, resetAfterMax: 10000,
  evenSplit: false,
  weightErrorBySize: true,
};

let portraitImage;
let randomImage;
let currentImage;

let colors = [];

let tree;

let lastParams;
let lastReset = 0;

function preload() {
  console.log(&#39;Loading...&#39;);

  portraitImage = loadImage("jp.png");
  randomImage = loadImage("https://picsum.photos/400");

  if (params.selfPortraitMode) {
    currentImage = portraitImage;
  } else {
    currentImage = randomImage;
  }
  
  console.log("done");
}

function oldSetup() {
  createCanvas(400, 400);
  
  gui = createGuiPanel("params");
  gui.addObject(params);
  gui.setPosition(420, 0);
}

// Calculate the average r, g, b over a region of the currentImage
function averageColor(x, y, w, h) {
  let sumr = 0, sumg = 0, sumb = 0, count = 0;

  for (let xi = 0; xi < w; xi++) {
    for (let yi = 0; yi < h; yi++) {
      const px = x + xi;
      const py = y + yi;

      const idx = (px + py * currentImage.width) * 4;

      sumr += currentImage.pixels[idx + 0];
      sumg += currentImage.pixels[idx + 1];
      sumb += currentImage.pixels[idx + 2];
      count++;
    }
  }

  return [
    floor(sumr / count),
    floor(sumg / count),
    floor(sumb / count),
  ];
}

// How far is a region of currentImage from the given r, g, b
// Normalize based on region size
function totalError(x, y, w, h, r, g, b) {
  let error = 0;

  for (let xi = 0; xi < w; xi++) {
    for (let yi = 0; yi < h; yi++) {
      const px = x + xi;
      const py = y + yi;

      const idx = (px + py * currentImage.width) * 4;

      error += Math.abs(r - currentImage.pixels[idx + 0]);
      error += Math.abs(g - currentImage.pixels[idx + 1]);
      error += Math.abs(b - currentImage.pixels[idx + 2]);
    }
  }

  if (params.weightErrorBySize) {
    return error / (w * h);
  } else {
    return error;
  }
}

// Find the closest color in colors to r, g, b
function closestColor(r, g, b) {
  let best = null;
  let bestDist = Infinity;

  for (const c of colors) {
    const dr = c[0] - r;
    const dg = c[1] - g;
    const db = c[2] - b;

    const dist = dr * dr + dg * dg + db * db; // squared distance

    if (dist < bestDist) {
      bestDist = dist;
      best = c;
    }
  }

  return best;
}

// Given a tree, recursively find the largest error value in the tree
function findMaximumError(tree) {
  if (tree.type === &#39;leaf&#39;) {
    return tree.error;
  }

  let maxError = -Infinity;

  for (const child of tree.children) {
    const e = findMaximumError(child);
    if (e > maxError) {
      maxError = e;
    }
  }

  return maxError;
}

// Given an error value (that exists in the tree (see above))
// Find the node that error is at and split it
function splitAtError(tree, error) {
  if (tree.type === &#39;leaf&#39; && tree.error === error) {
    const { x, y, w, h } = tree;

    let hw = Math.floor(w / 2);
    let hh = Math.floor(h / 2);
    if (!params.evenSplit) {
      hw = Math.floor(w * (0.25 + random() / 2));
      hh = Math.floor(h * (0.25 + random() / 2));
    }

    tree.type = &#39;branch&#39;;
    tree.children = [
      makeLeaf(x,        y,        hw,     hh),     // TL
      makeLeaf(x + hw,   y,        w - hw, hh),     // TR
      makeLeaf(x,        y + hh,   hw,     h - hh), // BL
      makeLeaf(x + hw,   y + hh,   w - hw, h - hh)  // BR
    ];

    return true;
  }

  if (tree.type === &#39;branch&#39;) {
    for (const child of tree.children) {
      if (splitAtError(child, error)) {
        return true;
      }
    }
  }

  return false;
}

// Helper function to make a leaf node of a region
// Find the closest color to the region&#39;s average, that&#39;s the color
// And error is how far that color is from &#39;perfect&#39;
function makeLeaf(x, y, w, h) {
  let [ar, ag, ab] = averageColor(x, y, w, h);
  let [r, g, b] = closestColor(ar, ag, ab);
  let err = totalError(x, y, w, h, r, g, b);

  if (w <= params.minimumBlock || h <= params.minimumBlock) {
    err = 0;
  }
  
  return {
    type: &#39;leaf&#39;,
    x, y, w, h,
    r, g, b,
    error: err
  };
}

// Draw the current tree structure recursively
function drawTree(tree) {
  if (tree.type == &#39;leaf&#39;) {
    fill(tree.r, tree.g, tree.b);
    rect(tree.x, tree.y, tree.w, tree.h);
  } else {
    for (let child of tree.children) {
      drawTree(child);
    }
  }
}

function draw() {
  if (frameCount - lastReset > params.resetAfter) {
    colors = [];
    tree = undefined;
    lastReset = frameCount;
  }
  
  if (params.edges) {
    stroke("black");
  } else {
    noStroke();
  }
  
  while (colors.length > params.colors) { colors.shift(); }
  while (colors.length < params.colors) { 
    colors.push([
      floor(random(256)),
      floor(random(256)),
      floor(random(256))
    ]);
  }
  
  if (lastParams == undefined || Object.keys(params).some(k => params[k] !== lastParams[k])) {
    
    if (lastParams != undefined && params.selfPortraitMode != lastParams.selfPortraitMode) {
      if (params.selfPortraitMode) {
        currentImage = portraitImage;
      } else {
        currentImage = randomImage;
      }
    }
    
    lastReset = frameCount;
    tree = undefined;
    lastParams = {...params};
  }

  currentImage.loadPixels();

  if (tree == undefined) {
    tree = makeLeaf(0, 0, width, height);
  } else {
    let error = findMaximumError(tree);
    splitAtError(tree, error);
  }
  
  drawTree(tree);
}

            

            const START_PAUSED = false;

            
function setup() {
    // Store a copy of the original params
    const defaultParams = typeof params !== "undefined" ? { ...params } : {};
    window.defaultParams = defaultParams; // Store for use in updateQueryParameters

    if (typeof params !== "undefined") {
        const urlParams = new URLSearchParams(parent.window.location.search);
        let hasQueryParams = false;
        
        for (const key in params) {
            if (urlParams.has(key)) {
                hasQueryParams = true;
                break;
            }
        }

        // Load from query parameters if present
        // Fallback to legacy hash fragment
        if (hasQueryParams) {
            for (const key in params) {
                if (urlParams.has(key)) {
                    const value = urlParams.get(key);
                    // Parse the value based on the type of the default param
                    if (typeof defaultParams[key] === &#39;boolean&#39;) {
                        params[key] = value === &#39;true&#39;;
                    } else if (typeof defaultParams[key] === &#39;number&#39;) {
                        params[key] = parseFloat(value);
                    } else {
                        params[key] = value;
                    }
                }
            }
        } else if (parent.location.hash) {
            try {
                var settings = JSON.parse(atob(parent.location.hash.substring(1)));
                Object.keys(params).forEach((key) => params[key] = key in settings ? settings[key] : params[key]);
            } catch(ex) {
            }
        }
    }

    oldSetup();
    if (START_PAUSED) {
        noLoop();
    }

    createButton("play/pause").mousePressed(() => {
        if (isLooping()) {
            noLoop();
        } else {
            loop();
        }
    });

    createButton("step").mousePressed(() => {
        noLoop();
        draw();
    });

    createButton("save").mousePressed(() => {
        saveCanvas(&#39;photo&#39;, &#39;png&#39;)
    });

    createButton("clear").mousePressed(() => {
        if (typeof reset !== &#39;undefined&#39;) {
            reset();
        } else {
            clear();
        }
    });

    createButton("reload").mousePressed(() => {
        window.location.reload();
    });

    if (typeof params !== "undefined") {
        createButton("default").mousePressed(() => {
            // Load without query parameters to re-default
            parent.window.location.href = parent.window.location.pathname;
        });

        /*
        createButton("randomize").mousePressed(() => {
            // Grab all inputs inside the GUI container
            const guiContainer = document.querySelector(&#39;.qs_main&#39;); 
            if (!guiContainer) return;

            const inputs = guiContainer.querySelectorAll(&#39;input&#39;);
            let i = 0;

            for (const key in params) {
                const el = inputs[i++];
                if (!el) continue;

                if (el.type === "checkbox") {
                    el.checked = Math.random() < 0.5;
                    params[key] = el.checked;
                } else if (el.type === "range") {
                    const min = parseFloat(el.min);
                    const max = parseFloat(el.max);
                    const step = parseFloat(el.step) || 1;
                    const rangeSteps = Math.floor((max - min) / step);
                    const randomStep = Math.floor(Math.random() * (rangeSteps + 1));
                    const value = min + randomStep * step;
                    el.value = value;
                    params[key] = value;
                } else if (el.tagName.toLowerCase() === "select") {
                    const options = el.options;
                    const randomIndex = Math.floor(Math.random() * options.length);
                    el.selectedIndex = randomIndex;
                    params[key] = options[randomIndex].value;
                } else {
                    console.warn("Unsupported input type for randomization: " + el.type);
                }

                // Trigger input event to update the GUI and callbacks
                el.dispatchEvent(new Event(&#39;input&#39;, { bubbles: true }));
            }

            // Save the random state to hash
            parent.location.hash = btoa(JSON.stringify(params));
        });
        */
    }

    if (typeof params !== "undefined") {
        for (var el of document.querySelectorAll(&#39;input&#39;)) {
            if (el.id && el.id.startsWith(&#39;qs_&#39;)) {
                el.addEventListener(&#39;change&#39;, () => {
                    updateQueryParameters();
                });
            }
        }
    }
}

function updateQueryParameters() {
    if (typeof params === "undefined") return;
    
    const defaultParams = typeof window.defaultParams !== "undefined" ? window.defaultParams : {};
    const urlParams = new URLSearchParams();
    
    // Only add parameters that differ from the default
    for (const key in params) {
        const value = params[key];
        if (JSON.stringify(value) !== JSON.stringify(defaultParams[key])) {
            urlParams.set(key, value);
        }
    }
    
    // Update URL without saving to history
    const newUrl = urlParams.toString() ? 
        parent.window.location.pathname + &#39;?&#39; + urlParams.toString() :
        parent.window.location.pathname;
    parent.window.history.replaceState({}, &#39;&#39;, newUrl);
}

            </script>
            
<noscript>To display this p5.js sketch, JavaScript must be enabled.</noscript>
</body>
</html>

        '></iframe></div><div class=tabcontent data-tabset=d8ee id=defaultscript><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>gui</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>colors</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10</span>, <span style=color:#a6e22e>colorsMin</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>colorsMax</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>256</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>edges</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>minimumBlock</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>minimumBlockMin</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>minimumBlockMax</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>selfPortraitMode</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resetAfter</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1000</span>, <span style=color:#a6e22e>resetAfterMin</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10</span>, <span style=color:#a6e22e>resetAfterMax</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10000</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>evenSplit</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>weightErrorBySize</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>portraitImage</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>randomImage</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>currentImage</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>colors</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>tree</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lastParams</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lastReset</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>preload</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Loading...&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>portraitImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>loadImage</span>(<span style=color:#e6db74>&#34;jp.png&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>randomImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>loadImage</span>(<span style=color:#e6db74>&#34;https://picsum.photos/400&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>selfPortraitMode</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>portraitImage</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>randomImage</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;done&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createCanvas</span>(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>400</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>gui</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createGuiPanel</span>(<span style=color:#e6db74>&#34;params&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>gui</span>.<span style=color:#a6e22e>addObject</span>(<span style=color:#a6e22e>params</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>gui</span>.<span style=color:#a6e22e>setPosition</span>(<span style=color:#ae81ff>420</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Calculate the average r, g, b over a region of the currentImage
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>averageColor</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>sumr</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>sumg</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>sumb</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>count</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>xi</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>xi</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>w</span>; <span style=color:#a6e22e>xi</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>yi</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>yi</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>h</span>; <span style=color:#a6e22e>yi</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>px</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>xi</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>py</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>yi</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>idx</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>px</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>py</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>width</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sumr</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>pixels</span>[<span style=color:#a6e22e>idx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sumg</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>pixels</span>[<span style=color:#a6e22e>idx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sumb</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>pixels</span>[<span style=color:#a6e22e>idx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> [
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>sumr</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>count</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>sumg</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>count</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>sumb</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>count</span>),
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// How far is a region of currentImage from the given r, g, b
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Normalize based on region size
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>totalError</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>b</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>error</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>xi</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>xi</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>w</span>; <span style=color:#a6e22e>xi</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>yi</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>yi</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>h</span>; <span style=color:#a6e22e>yi</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>px</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>xi</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>py</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>yi</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>idx</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>px</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>py</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>width</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span> <span style=color:#f92672>+=</span> Math.<span style=color:#a6e22e>abs</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>pixels</span>[<span style=color:#a6e22e>idx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span> <span style=color:#f92672>+=</span> Math.<span style=color:#a6e22e>abs</span>(<span style=color:#a6e22e>g</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>pixels</span>[<span style=color:#a6e22e>idx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span> <span style=color:#f92672>+=</span> Math.<span style=color:#a6e22e>abs</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>pixels</span>[<span style=color:#a6e22e>idx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>weightErrorBySize</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>error</span> <span style=color:#f92672>/</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>h</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Find the closest color in colors to r, g, b
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>closestColor</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>b</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>best</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>bestDist</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Infinity</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>c</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>colors</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dr</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>r</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>g</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>b</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dist</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>dr</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>dg</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>dg</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>db</span>; <span style=color:#75715e>// squared distance
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>dist</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>bestDist</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bestDist</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dist</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>best</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>best</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Given a tree, recursively find the largest error value in the tree
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>findMaximumError</span>(<span style=color:#a6e22e>tree</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;leaf&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>maxError</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#66d9ef>Infinity</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>child</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>children</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findMaximumError</span>(<span style=color:#a6e22e>child</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>maxError</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>maxError</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>maxError</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Given an error value (that exists in the tree (see above))
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Find the node that error is at and split it
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>splitAtError</span>(<span style=color:#a6e22e>tree</span>, <span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;leaf&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>error</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>tree</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hw</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>w</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hh</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>h</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>evenSplit</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hw</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>0.25</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>random</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hh</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>0.25</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>random</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;branch&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>makeLeaf</span>(<span style=color:#a6e22e>x</span>,        <span style=color:#a6e22e>y</span>,        <span style=color:#a6e22e>hw</span>,     <span style=color:#a6e22e>hh</span>),     <span style=color:#75715e>// TL
</span></span></span><span style=display:flex><span>      <span style=color:#a6e22e>makeLeaf</span>(<span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>hw</span>,   <span style=color:#a6e22e>y</span>,        <span style=color:#a6e22e>w</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>hw</span>, <span style=color:#a6e22e>hh</span>),     <span style=color:#75715e>// TR
</span></span></span><span style=display:flex><span>      <span style=color:#a6e22e>makeLeaf</span>(<span style=color:#a6e22e>x</span>,        <span style=color:#a6e22e>y</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>hh</span>,   <span style=color:#a6e22e>hw</span>,     <span style=color:#a6e22e>h</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>hh</span>), <span style=color:#75715e>// BL
</span></span></span><span style=display:flex><span>      <span style=color:#a6e22e>makeLeaf</span>(<span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>hw</span>,   <span style=color:#a6e22e>y</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>hh</span>,   <span style=color:#a6e22e>w</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>hw</span>, <span style=color:#a6e22e>h</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>hh</span>)  <span style=color:#75715e>// BR
</span></span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;branch&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>child</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>children</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>splitAtError</span>(<span style=color:#a6e22e>child</span>, <span style=color:#a6e22e>error</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Helper function to make a leaf node of a region
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Find the closest color to the region&#39;s average, that&#39;s the color
</span></span></span><span style=display:flex><span><span style=color:#75715e>// And error is how far that color is from &#39;perfect&#39;
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>makeLeaf</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> [<span style=color:#a6e22e>ar</span>, <span style=color:#a6e22e>ag</span>, <span style=color:#a6e22e>ab</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>averageColor</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> [<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>b</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>closestColor</span>(<span style=color:#a6e22e>ar</span>, <span style=color:#a6e22e>ag</span>, <span style=color:#a6e22e>ab</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>totalError</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>b</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>minimumBlock</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>h</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>minimumBlock</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;leaf&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>b</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Draw the current tree structure recursively
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>drawTree</span>(<span style=color:#a6e22e>tree</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;leaf&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fill</span>(<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>b</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rect</span>(<span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>h</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>child</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>tree</span>.<span style=color:#a6e22e>children</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>drawTree</span>(<span style=color:#a6e22e>child</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>draw</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>frameCount</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lastReset</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>resetAfter</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>colors</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tree</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastReset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>frameCount</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>edges</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stroke</span>(<span style=color:#e6db74>&#34;black&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>noStroke</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>colors</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>colors</span>) { <span style=color:#a6e22e>colors</span>.<span style=color:#a6e22e>shift</span>(); }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>colors</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>colors</span>) { 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>colors</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>random</span>(<span style=color:#ae81ff>256</span>)),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>random</span>(<span style=color:#ae81ff>256</span>)),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>random</span>(<span style=color:#ae81ff>256</span>))
</span></span><span style=display:flex><span>    ]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>lastParams</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>||</span> Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>params</span>).<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>k</span> =&gt; <span style=color:#a6e22e>params</span>[<span style=color:#a6e22e>k</span>] <span style=color:#f92672>!==</span> <span style=color:#a6e22e>lastParams</span>[<span style=color:#a6e22e>k</span>])) {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>lastParams</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>selfPortraitMode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>lastParams</span>.<span style=color:#a6e22e>selfPortraitMode</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>selfPortraitMode</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>currentImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>portraitImage</span>;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>currentImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>randomImage</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastReset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>frameCount</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tree</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastParams</span> <span style=color:#f92672>=</span> {...<span style=color:#a6e22e>params</span>};
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>currentImage</span>.<span style=color:#a6e22e>loadPixels</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tree</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tree</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>makeLeaf</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>error</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findMaximumError</span>(<span style=color:#a6e22e>tree</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>splitAtError</span>(<span style=color:#a6e22e>tree</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>drawTree</span>(<span style=color:#a6e22e>tree</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=ranking><h3 class=title>Posts in <a href=/series/genuary-2026/>Genuary 2026</a>:</h3><div class=content><ul><li><a href=https://blog.jverkamp.com/2026/01/18/genuary-2026.18-unexpected-paths/>Genuary 2026.18: Unexpected paths</a></li><li><a href=https://blog.jverkamp.com/2026/01/17/genuary-2026.17-wallpaper-groups/>Genuary 2026.17: Wallpaper Groups</a></li><li><a href=https://blog.jverkamp.com/2026/01/16/genuary-2026.16-order-vs-disorder/>Genuary 2026.16: Order vs Disorder</a></li><li><a href=https://blog.jverkamp.com/2026/01/15/genuary-2026.15-invisible-object/>Genuary 2026.15: Invisible Object</a></li><li><a href=https://blog.jverkamp.com/2026/01/14/genuary-2026.14-fits-perfectly/>Genuary 2026.14: Fits Perfectly</a></li><li><a href=https://blog.jverkamp.com/2026/01/13/genuary-2026.13-self-portrait/>Genuary 2026.13: Self Portrait</a></li><li><a href=https://blog.jverkamp.com/2026/01/12/genuary-2026.12-boxes/>Genuary 2026.12: Boxes</a></li><li><a href=https://blog.jverkamp.com/2026/01/11/genuary-2026.11-quine/>Genuary 2026.11: Quine</a></li><li><a href=https://blog.jverkamp.com/2026/01/10/genuary-2026.10-polar-coordinates/>Genuary 2026.10: Polar coordinates</a></li><li><a href=https://blog.jverkamp.com/2026/01/09/genuary-2026.09-cellular-automata/>Genuary 2026.09: Cellular automata</a></li><li><a href=https://blog.jverkamp.com/2026/01/08/genuary-2026.08-a-city/>Genuary 2026.08: A city</a></li><li><a href=https://blog.jverkamp.com/2026/01/07/genuary-2026.07-boolean-algebra/>Genuary 2026.07: Boolean algebra</a></li><li><a href=https://blog.jverkamp.com/2026/01/06/genuary-2026.06-lights-on/off/>Genuary 2026.06: Lights on/off</a></li><li><a href=https://blog.jverkamp.com/2026/01/05/genuary-2026.05-write-genuary/>Genuary 2026.05: Write 'genuary'</a></li><li><a href=https://blog.jverkamp.com/2026/01/04/genuary-2026.04-lowres/>Genuary 2026.04: lowres</a></li><li><a href=https://blog.jverkamp.com/2026/01/03/genuary-2026.03-fibonacci-forever/>Genuary 2026.03: Fibonacci forever</a></li><li><a href=https://blog.jverkamp.com/2026/01/02/genuary-2026.02-twelve-principles-of-animation/>Genuary 2026.02: Twelve principles of animation</a></li><li><a href=https://blog.jverkamp.com/2026/01/01/genuary-2026.01-one-color-one-shape/>Genuary 2026.01: One color, one shape</a></li></ul></div></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!DOCTYPE html>
<html>
<head>
        
        

        <title>Parallel BF | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Pretty pretty fonts -->
        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Calligraffitti" />

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="http://blog.jverkamp.com/category/archives/2015">2015</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/book-reviews">Book Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="http://blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Parallel BF</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2012-12-31"><span class="year">2012</span> <span class="month">Dec</span> <span class="day">31</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-language/brainf-k">Brainf**k</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/esolangs">Esolangs</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source/plt-games">PLT Games</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/programming-languages">Programming Languages</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>Getting a bit close to the deadline, but I think I have something that's pretty interesting. Basically, it's the same BF interpreter that I wrote about <a href="http://blog.jverkamp.com/2012/12/30/a-brainfk-interpreter">yesterday</a> with four additional commands:</p>
<table class="table table-striped">
<tr><td>&amp;</td><td>Spawn a new thread; set the current cell to 0 in the parent and 1 in the child</td></tr>
<tr><td>~</td><td>Kill the current thread</td></tr>
<tr><td>!</td><td>Send a ping on the channel specified by the current cell</td></tr>
<tr><td>?</td><td>Wait for a ping on the channel specified by the current cell</td></tr>
</table>
<!--more-->
<p>Originally, the idea was the keep the threads in sync, running only a single step on each in turn, but in the end I decided just to directly go with Racket's <code>thread</code>s both for ease of implementation and because it more closely matches what I'm actually trying to do.</p>
<p>If you'd like to see full source code, you can do so <a href="https://github.com/jpverkamp/pbf/blob/master/pbf.rkt" title="GitHub: pbf">on GitHub</a>. Otherwise, here are the new sections:</p>
<p>First, we have the new instruction <code>&amp;</code> that is designed to spawn a new thread:</p>
<pre class="scheme"><code>; spawn a new thread, set current cell to 0 in the parent and non-0 in the child
[(#\&)
 ; spawn the child process
 (thread
  (lambda () (step (+ pc 1) tape-left 1 tape-right)))

 ; step the parent process
 (step (+ pc 1) tape-left 0 tape-right)]</code></pre>
<p>That's one thing that I like about the provided <code>thread</code>s, all you have to do is pass it a thunk and it does the rest. So we'll spawn one process in a separate thread with 1 in the current cell and take a step while at the same time taking a step in the original thread. And that's it! The built in functionality will handle everything else for us.</p>
<p>Next, how do we kill off threads? That's even easier. Since we have the large <code>case</code> statement that's dealing with processing the input, all we have to do is break out of it (by returning <code>void</code> in this case):</p>
<pre class="scheme"><code>; kill the current thread
[(#\~)
 (void)]</code></pre>
<p>Now for the communication between threads. Optimally, I'd like to have something that could actually send messages, but I couldn't figure out a good way to do that while only having a single variable at a time. Perhaps I could just send/receive the current cell? We'll see.</p>
<p>In any case, the model that I settled on is useful for synchronizing the threads. Basically, you can send a ping with <code>!</code> or wait for one with <code>?</code>.</p>
<p>But how does that work? First we need the channels of communication. I used a shared mutable hash:</p>
<pre class="scheme"><code>; control communication on channels
(define channels (make-hash))

; send a ping on a given channel
(define (ping i)
  (hash-set! channels i #t))

; wait for a ping on a given channel
; current a spinlock :(
(define (pong i)
  (let loop ()
    (if (hash-ref channels i #f)
        (hash-remove! channels i)
        (loop))))</code></pre>
<p>This way <code>pong</code> will block until it receives a message from another thread. there are some potential issues in that <code>pong</code> isn't actually atomic so you could have two threads receive the same ping or not, non-deterministically. But that's half the fun of a Turing Tarpit isn't it? <img alt="smile" class="emoji" src="/emoji/smile.svg" /></p>
<p>With that, the code for <code>!</code> and <code>?</code> is straight forward:</p>
<pre class="scheme"><code>; send a ping on a given channel
[(#\!)
 (ping tape-cell)
 (step (+ pc 1) tape-left tape-cell tape-right)]

; receive a ping on a given channel
[(#\?)
 (pong tape-cell)
 (step (+ pc 1) tape-left tape-cell tape-right)]</code></pre>
<p>And that's all there is to it. Now you can BF in parallel!</p>
<p>But what's it actually useful for?</p>
<p>Well, consider this example:</p>
<pre class="java"><code>&[     spawn thread 1 (echo +1)
 +     set cell 0 to 1 (to ID the thread)
 &gt;&gt;+   set cell 2 to 1
 &lt;,    read into cell 1
 [     while not EOF:
  +.    add 1 and echo
  &gt;+!   set cell 2 to 2 and send a ping on 2
  -?    set cell 2 to 1 and wait for a ping on 1
  &lt;,    read into cell 1
 ]
 ~     kill this thread
]

&[     spawn thread 2
 ++    set cell 0 to 2 (to ID the thread)
 &gt;&gt;++? set cell 2 to 2 and wait for a ping on 2
 &lt;,    read into cell 1
 [     while not EOF:
  -.    sub 1 and echo
  &gt;-!   set cell 2 to 1 and send a ping on 1
  +?    set cell 2 to 2 and wait for a ping on 2
  &lt;,    read into cell 1
 ]
 ~     kill this thread
]</code></pre>
<p>What this will actually do is act as a close cousin to the cat program from yesterday. Instead of a single thread though, here we spawn two. The first will read input and add one to it before echoing. The second will subtract one. Using <code>!</code> and <code>?</code>, we'll make sure to alternate between the two. Yes, this could easily have been written without threads, but it was a good test to make sure I had everything working.</p>
<p>Here's an example:</p>
<pre class="scheme"><code>&gt; (current-i/o-mode 'numeric)
&gt; (pbf (file-&gt;string "split-cat.pbf"))
2 4 6 8 10
3 3 7 7 11</code></pre>
<p>Even more fun, how about Hello World done in parallel? Essentially, we can have one thread for upper case letters, one for lower case, and one for the rest. That way we can move around and get everything read all at the same time:</p>
<pre class="java"><code>the goal:
 thread 0 outputs 'H' and sends 1
 on 1 thread 1 outputs 'ello' and sends 2
 on 2 thread 2 outputs ' ' and sends 3
 on 3 thread 0 outputs 'W' and sends 4
 on 4 thread 1 outputs 'orld' and sends 5
 on 5 thread 2 outputs bang

&[-         spawn thread 0 (for H and W)
 &gt;          go to cell 1
 +++++++++  set cell 1 to 9
 [          loop while cell 1 is not 0:
  &lt;++++++++  add 8 to cell 0
  &gt;-         subtract 1 from cell 1
 ]
 &lt;.         output cell 0 (9 * 8 = 72 = 'H')
 &gt;+!        send a ping on 1
 ++         set cell 2 to 3
 [          loop while cell 1 is not 0:
  &lt;+++++     add 5 to cell 0
  &gt;-         subtract 1 from cell 1
 ]
 +++?      wait for a ping on 3
 &lt;.        output cell 0 (72 + 3 * 5 = 87 = 'W')
 &gt;+!        send a ping on 4
 ~          kill this thread
]

&[-         spawn thread 1 (for 'ello' and 'orld')
 &gt;+++++
  +++++     add 10 to cell 1
 [          while cell 1 is not 0:
  &lt;+++++
   +++++    add 10 to cell 0
  &gt;-        subtract 1 from cell 1
 ]
 &lt;+         add 1 to cell 0
 &gt;+?        wait for a ping on 1
 &lt;.         output cell 0 (10 * 10 + 1 = 101 = 'e')
 ++++++..   add 7 to cell 0 (for 108 = 'l') and output twice
 +++.       add 3 to cell 0 (for 111 = 'o') and output
 &gt;+!        send a ping on 2
 ++?        wait for a ping on 4
 &lt;.         output cell 0 ('o')
 +++.       add 3 and output (114 = 'r')
 ------.    subtract 6 and output (108 = 'l')
 --------.  subtract 8 and output (100 = 'd')
 &gt;+!        send a ping on 5
 ~          kill this thread
]

&[-         spawn thread 2 (for ' ' and bang)
 &gt;++++      set cell 1 to 4
 [          while cell 1 is not 0:
  &lt;++++++++  add 8 to cell 0
  &gt;-         subtract 1 from cell 1
 ]
 ++?        wait for a ping on 2
 &lt;.         output cell 0 (4 * 8 = 32 = ' ')
 &gt;+!        send a ping on 3
 &lt;+         add 1 to cell 0
 &gt;++?       wait for a ping on 5
 &lt;.         output cell 0 (32 + 1 = 33 = '!')
 ~          kill this thread
]</code></pre>
<p>Check it out:</p>
<pre class="scheme"><code>&gt;(current-i/o-mode 'unicode)
&gt; (pbf (file-&gt;string "hello.pbf"))
Hello World!</code></pre>
<p>And that's that. You can see the entire project on GitHub <a href="https://github.com/jpverkamp/pbf" title="GitHub: jpverkamp/pbf">here</a> or the competition from <a href="http://www.pltgames.com/competition/2012/12" title="PLT Games Competition December 2012">PLT Games here</a>.</p>
<p>This was actually pretty fun. I think I'm going to have to try a few other variants in the future.</p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Parallel BF";
var disqus_url = "http://blog.jverkamp.com/2012/12/31/parallel-bf/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2012/12/31/confession-day-60">← Confession - Day 60</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2013/01/02/confession-day-61">Confession - Day 61 →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2012/12/30/a-brainfk-interpreter">← A Brainf**k Interpreter</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2013/01/02/happy-new-year">Happy New Year →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
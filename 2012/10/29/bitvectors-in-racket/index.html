<!DOCTYPE html>
<html>
<head>
    <title>
    Bitvectors in Racket â€“ jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Bitvectors in Racket</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2012-10-29</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2012/10/27/pythagorean-triples/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2012/10/31/pandigital-sums/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2012/10/28/starfall/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2012/10/30/argo/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>A bit shorter on time today, so I&rsquo;ve just got a quick library that I worked out to solve another problem (I&rsquo;ll post it later this week when it&rsquo;s actually working). Basically, when you need to store a heck of a lot of binary flags and don&rsquo;t want to waste space, the best way to do it would be as one long list of bits. It&rsquo;s really easy to do in a language like C, but how can you do it in Racket?</p>

<p>Well, it turns out it&rsquo;s not that much more difficult. You just have to know where to look. Let&rsquo;s start with creating the bytevector. Basically, we need one byte for every eight bits we want to store in the vector. Easy enough:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; create a bitvector</span>
(<span style="color:#66d9ef">define </span>(make-bitvector size [default <span style="color:#66d9ef">#f</span>])
  (make-bytes (ceiling (/ size <span style="color:#ae81ff">8</span>)) (<span style="color:#66d9ef">if </span>default <span style="color:#f92672">#</span>xff <span style="color:#f92672">#</span>x00)))</code></pre></div>
<p>Easy enough, although printing them out isn&rsquo;t too pretty at the moment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (make-bitvector <span style="color:#ae81ff">20</span>)
<span style="color:#f92672">#</span><span style="color:#e6db74">&#34;\0\0\0&#34;</span>

&gt; (make-bitvector <span style="color:#ae81ff">20</span> <span style="color:#66d9ef">#t</span>)
<span style="color:#f92672">#</span><span style="color:#e6db74">&#34;\377\377\377&#34;</span></code></pre></div>
<p>We&rsquo;ll work on that in a bit. First, how can we pull out a bit from a bitvector? To do that, you need to know a few functions (<code>bitwise-and</code> and <code>arithmetic-shift</code> to start with). As an example, consider the case where you have the bit pattern <code>0001000101</code> and want to pull out the bit at index <code>4</code>.</p>

<p>First, get the correct byte:</p>

<pre><code>/      \ /      \
00010001 01------
   /\
   ||
</code></pre>

<p>Next, get the correct bit. This is where the <code>arithmetic-shift</code> comes in. Essentially, it&rsquo;s a much faster way of calculating powers of two. So <code>(arithmetic-shift 1 4) = 16 = 00001000</code>.</p>

<pre><code>/      \
00010001 &lt;- bitvector
00001000 &lt;- mask
00000000 &lt;- result (0 is #f, anything else is #t)
</code></pre>

<p>After that, we actually have what we&rsquo;d need to display bitvectors. I just wrote a simple method that will loop over a bitvector and turn it to a string of 1s and 0s. Since we aren&rsquo;t storing the size with the bitvector, you need to specify it here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; used to print out a bitvector</span>
<span style="color:#75715e">; the size is necessary to avoid printing the extra bits</span>
(<span style="color:#66d9ef">define </span>(bitvector-&gt;string bv size)
  (list-&gt;string
   (for/list ([i (in-range size)])
     (<span style="color:#66d9ef">if </span>(bitvector-ref bv i) <span style="color:#e6db74">#\1</span> <span style="color:#e6db74">#\0</span>))))</code></pre></div>
<p>The next step is to be able to set bits. The easy part is finding the bit that we want to set. We can do the same thing as before. The more complicated part is setting the bits correctly. Setting a bit to 1 isn&rsquo;t too hard. You just need to <code>or</code> (or rather <code>bitwise-ior</code>) with the correctly shifted bit. So to see that 4th index:</p>

<pre><code>/      \
00010001 &lt;- bitvector
00001000 &lt;- mask
00011001 &lt;- updated bitvector
</code></pre>

<p>Setting a zero is a bit more complicated. Essentially, you want to and with all of the bits <em>except</em> the one to set to zero. You can do this by <code>xor</code>ing the 1 from the previous case with <code>0xFF</code>:</p>

<pre><code>00001000 &lt;- mask
11111111 &lt;- 0xFF
11110111 &lt;- xor'ed

/      \
00010001 &lt;- bitvector
11110111 &lt;- xor'ed mask
00010001 &lt;- updated bitvector
</code></pre>

<p>To turn this all into code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; set a value in a bit vector</span>
(<span style="color:#66d9ef">define </span>(bitvector-set! bv i v)
  (bytes-set!
   bv
   (quotient i <span style="color:#ae81ff">8</span>)
   (cond
     [v
      <span style="color:#75715e">; set the value by or&#39;ing with 1</span>
      (bitwise-ior (bytes-ref bv (quotient i <span style="color:#ae81ff">8</span>))
                   (arithmetic-shift <span style="color:#ae81ff">1</span> (remainder i <span style="color:#ae81ff">8</span>)))]
     [else
      <span style="color:#75715e">; unset the value by anding with all 1s but a 0 at the interesting point</span>
      (bitwise-and (bytes-ref bv (quotient i <span style="color:#ae81ff">8</span>))
                   (bitwise-xor <span style="color:#f92672">#</span>xFF
                                (arithmetic-shift <span style="color:#ae81ff">1</span> (remainder i <span style="color:#ae81ff">8</span>))))])))</code></pre></div>
<p>A bit uglier than I&rsquo;d like, workable. Let&rsquo;s try it out:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (<span style="color:#66d9ef">define </span>bv (make-bitvector <span style="color:#ae81ff">20</span>))

&gt; (bitvector-&gt;string bv <span style="color:#ae81ff">20</span>)
<span style="color:#e6db74">&#34;00000000000000000000&#34;</span>

&gt; (bitvector-set! bv <span style="color:#ae81ff">4</span> <span style="color:#66d9ef">#t</span>)
&gt; (bitvector-set! bv <span style="color:#ae81ff">8</span> <span style="color:#66d9ef">#t</span>)
&gt; (bitvector-set! bv <span style="color:#ae81ff">9</span> <span style="color:#66d9ef">#t</span>)
&gt; (bitvector-set! bv <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">#t</span>)

&gt; (bitvector-&gt;string bv <span style="color:#ae81ff">20</span>)
<span style="color:#e6db74">&#34;00001000111000000000&#34;</span>

&gt; (bitvector-ref bv <span style="color:#ae81ff">7</span>)
<span style="color:#66d9ef">#f</span>

&gt; (bitvector-ref bv <span style="color:#ae81ff">8</span>)
<span style="color:#66d9ef">#t</span></code></pre></div>
<p>All good. I did make one more helpful method to just toggle a bit. This could have been done directly with an <code>xor</code>, but it was easy enough to define in terms of <code>bitvector-ref</code> and <code>bitvector-set!</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; shortcut to toggle a bit in a bitvector</span>
(<span style="color:#66d9ef">define </span>(bitvector-toggle! bv i)
  (bitvector-set! bv i (not (bitvector-ref bv i))))</code></pre></div>
<p>And that&rsquo;s all there is to it. I&rsquo;ve uploaded the code here: <a href="https://github.com/jpverkamp/small-projects/blob/master/racket-libraries/bitvector.rkt" title="bitvector source">bitvector source</a></p>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Bitvectors in Racket";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2012\/10\/29\/bitvectors-in-racket\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

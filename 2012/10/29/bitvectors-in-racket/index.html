<!doctype html><html><head><title>Bitvectors in Racket â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js defer></script>
<script src=/custom.min.9bb1a6d1e0b58ced38df246e4479317e4561461cfabab31b36fbc36035186214.js defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css><link rel=stylesheet href=/custom.min.3bcba67844fc4a76aa7c1947a1fcf14cddaf8e9e0f1e734fde0fa219416f058d.css></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Bitvectors in Racket</h1><div class=entry-meta><span class=entry-date>2012-10-29</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/10/27/pythagorean-triples/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2012/10/31/pandigital-sums/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2012/10/27/pythagorean-triples/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2012/10/31/pandigital-sums/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/10/20/memoization-in-racket/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2013/01/23/sorting-via-splay-heap/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2012/10/27/pythagorean-triples/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/10/31/pandigital-sums/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2012/10/28/starfall/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/10/30/argo/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>A bit shorter on time today, so I&rsquo;ve just got a quick library that I worked out to solve another problem (I&rsquo;ll post it later this week when it&rsquo;s actually working). Basically, when you need to store a heck of a lot of binary flags and don&rsquo;t want to waste space, the best way to do it would be as one long list of bits. It&rsquo;s really easy to do in a language like C, but how can you do it in Racket?</p><p>Well, it turns out it&rsquo;s not that much more difficult. You just have to know where to look. Let&rsquo;s start with creating the bytevector. Basically, we need one byte for every eight bits we want to store in the vector. Easy enough:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; create a bitvector</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>make-bitvector</span> size [default <span style=color:#66d9ef>#f</span>])
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>make-bytes</span> (ceiling (/ size <span style=color:#ae81ff>8</span>)) (<span style=color:#66d9ef>if </span>default <span style=color:#f92672>#</span>xff <span style=color:#f92672>#</span>x00)))
</span></span></code></pre></div><p>Easy enough, although printing them out isn&rsquo;t too pretty at the moment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>make-bitvector</span> <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>#</span><span style=color:#e6db74>&#34;\0\0\0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>make-bitvector</span> <span style=color:#ae81ff>20</span> <span style=color:#66d9ef>#t</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>#</span><span style=color:#e6db74>&#34;\377\377\377&#34;</span>
</span></span></code></pre></div><p>We&rsquo;ll work on that in a bit. First, how can we pull out a bit from a bitvector? To do that, you need to know a few functions (<code>bitwise-and</code> and <code>arithmetic-shift</code> to start with). As an example, consider the case where you have the bit pattern <code>0001000101</code> and want to pull out the bit at index <code>4</code>.</p><p>First, get the correct byte:</p><pre tabindex=0><code>/      \ /      \
00010001 01------
   /\
   ||
</code></pre><p>Next, get the correct bit. This is where the <code>arithmetic-shift</code> comes in. Essentially, it&rsquo;s a much faster way of calculating powers of two. So <code>(arithmetic-shift 1 4) = 16 = 00001000</code>.</p><pre tabindex=0><code>/      \
00010001 &lt;- bitvector
00001000 &lt;- mask
00000000 &lt;- result (0 is #f, anything else is #t)
</code></pre><p>After that, we actually have what we&rsquo;d need to display bitvectors. I just wrote a simple method that will loop over a bitvector and turn it to a string of 1s and 0s. Since we aren&rsquo;t storing the size with the bitvector, you need to specify it here.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; used to print out a bitvector</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; the size is necessary to avoid printing the extra bits</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>bitvector-&gt;string</span> bv size)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>list-&gt;string</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>for/list</span> ([i (<span style=color:#a6e22e>in-range</span> size)])
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>if </span>(<span style=color:#a6e22e>bitvector-ref</span> bv i) <span style=color:#e6db74>#\1</span> <span style=color:#e6db74>#\0</span>))))
</span></span></code></pre></div><p>The next step is to be able to set bits. The easy part is finding the bit that we want to set. We can do the same thing as before. The more complicated part is setting the bits correctly. Setting a bit to 1 isn&rsquo;t too hard. You just need to <code>or</code> (or rather <code>bitwise-ior</code>) with the correctly shifted bit. So to see that 4th index:</p><pre tabindex=0><code>/      \
00010001 &lt;- bitvector
00001000 &lt;- mask
00011001 &lt;- updated bitvector
</code></pre><p>Setting a zero is a bit more complicated. Essentially, you want to and with all of the bits <em>except</em> the one to set to zero. You can do this by <code>xor</code>ing the 1 from the previous case with <code>0xFF</code>:</p><pre tabindex=0><code>00001000 &lt;- mask
11111111 &lt;- 0xFF
11110111 &lt;- xor&#39;ed

/      \
00010001 &lt;- bitvector
11110111 &lt;- xor&#39;ed mask
00010001 &lt;- updated bitvector
</code></pre><p>To turn this all into code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; set a value in a bit vector</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>bitvector-set!</span> bv i v)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>bytes-set!</span>
</span></span><span style=display:flex><span>   bv
</span></span><span style=display:flex><span>   (quotient i <span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>     [v
</span></span><span style=display:flex><span>      <span style=color:#75715e>; set the value by or&#39;ing with 1</span>
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>bitwise-ior</span> (<span style=color:#a6e22e>bytes-ref</span> bv (quotient i <span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>                   (<span style=color:#a6e22e>arithmetic-shift</span> <span style=color:#ae81ff>1</span> (remainder i <span style=color:#ae81ff>8</span>)))]
</span></span><span style=display:flex><span>     [else
</span></span><span style=display:flex><span>      <span style=color:#75715e>; unset the value by anding with all 1s but a 0 at the interesting point</span>
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>bitwise-and</span> (<span style=color:#a6e22e>bytes-ref</span> bv (quotient i <span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>                   (<span style=color:#a6e22e>bitwise-xor</span> <span style=color:#f92672>#</span>xFF
</span></span><span style=display:flex><span>                                (<span style=color:#a6e22e>arithmetic-shift</span> <span style=color:#ae81ff>1</span> (remainder i <span style=color:#ae81ff>8</span>))))])))
</span></span></code></pre></div><p>A bit uglier than I&rsquo;d like, workable. Let&rsquo;s try it out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#66d9ef>define </span>bv (<span style=color:#a6e22e>make-bitvector</span> <span style=color:#ae81ff>20</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-&gt;string</span> bv <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;00000000000000000000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-set!</span> bv <span style=color:#ae81ff>4</span> <span style=color:#66d9ef>#t</span>)
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-set!</span> bv <span style=color:#ae81ff>8</span> <span style=color:#66d9ef>#t</span>)
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-set!</span> bv <span style=color:#ae81ff>9</span> <span style=color:#66d9ef>#t</span>)
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-set!</span> bv <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>#t</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-&gt;string</span> bv <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;00001000111000000000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-ref</span> bv <span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>#f</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; (<span style=color:#a6e22e>bitvector-ref</span> bv <span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>#t</span>
</span></span></code></pre></div><p>All good. I did make one more helpful method to just toggle a bit. This could have been done directly with an <code>xor</code>, but it was easy enough to define in terms of <code>bitvector-ref</code> and <code>bitvector-set!</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; shortcut to toggle a bit in a bitvector</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>bitvector-toggle!</span> bv i)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>bitvector-set!</span> bv i (not (<span style=color:#a6e22e>bitvector-ref</span> bv i))))
</span></span></code></pre></div><p>And that&rsquo;s all there is to it. I&rsquo;ve uploaded the code here: <a href=https://github.com/jpverkamp/small-projects/blob/master/racket-libraries/bitvector.rkt title="bitvector source">bitvector source</a></p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!doctype html><html>
<head>
<title>Determining country by IP â€“ jverkamp.com</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous>
<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet>
<link rel=stylesheet href=/custom.css defer>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script>
</head>
<body>
<div id=wrapper><header id=page-header role=banner>
<h1><a href=/>JP's Blog</a></h1>
<ul id=page-header-links>
<li>
<a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a>
</li>
<li>
<form action=//www.google.com/search method=get onsubmit="(function(a){a.q.value='site:blog.jverkamp.com '+a.qfront.value})(this)" class="navbar-form navbar-right" role=search _lpchecked=1>
<div class=form-group>
<input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button>
</div>
</form>
</li>
</ul>
<nav id=header-navigation role=navigation class=ribbon>
<ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li>
</ul>
</nav>
</header>
<div id=page-content-wrapper>
<div id=page-content><article>
<header>
<h1 class=entry-title>Determining country by IP</h1>
<div class=entry-meta><span class=entry-date>2012-10-24</span>
</div>
<div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li>
<a class=taxonomy-key href=/programming/languages/>Languages</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/10/06/generated-html-index/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2012/10/25/determining-country-by-latitude/longitude/ class=next-link></a></li></ul>
</li><li><a class=taxonomy-key href=/programming>programming</a>
<ul>
<li><a href=https://blog.jverkamp.com/2012/10/22/prime-partitions-ii-the-listing/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/10/25/determining-country-by-latitude/longitude/ class=next-link>Next</a></ul>
</li><li><a class=taxonomy-key href=/>All Posts</a>
<ul>
<li><a href=https://blog.jverkamp.com/2012/10/24/hotel-transylvania/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/10/25/determining-country-by-latitude/longitude/ class=next-link>Next</a></ul>
</li></ul>
</div>
</div>
</header>
<div class=entry-content><p>In my line of research, it&rsquo;s often useful to be able to identify where a country is using just it&rsquo;s IP address. I&rsquo;ve done it a few different ways over the years, but the simplest I&rsquo;ve found is using the <a href=http://www.maxmind.com/en/geolite title="MaxMind GeoLite Country">MaxMind GeoLite Country database</a> directly. To speed such lookups, I&rsquo;ve written a simple Python script that can run a whole series of such queries for you.</p>
<p>Basically, the MaxMind &ldquo;database&rdquo; is a CSV file that contains the first and last IP in each range, those same IPs as an integer value, and then country code and country containing that IP range. So it&rsquo;s a simple matter to load all of the IPs into a list containing (first, last, country) tuples (using the integer versions to make comparisons quicker):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>ipdb <span style=color:#f92672>=</span> []
<span style=color:#66d9ef>with</span> open(ip_file, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> fin:
    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> fin:
        parts <span style=color:#f92672>=</span> [part<span style=color:#f92672>.</span>strip(<span style=color:#e6db74>&#39;&#34;&#39;</span>) <span style=color:#66d9ef>for</span> part <span style=color:#f92672>in</span> line<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;,&#39;</span>)]
        <span style=color:#66d9ef>if</span> len(parts) <span style=color:#f92672>==</span> <span style=color:#ae81ff>6</span>:
            from_ip, to_ip, from_int, to_int, cc, country <span style=color:#f92672>=</span> parts
            ipdb<span style=color:#f92672>.</span>append((itn(from_int), int(to_int), country))
</code></pre></div><p>After that, it&rsquo;s a simple matter of scanning through input files. I added the ability to read stdin as a file as well by specifying the file &lsquo;-&rsquo; to match other Unix scripts.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>for</span> file <span style=color:#f92672>in</span> files:
    <span style=color:#66d9ef>if</span> file <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;-&#39;</span>:
        fin <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>stdin
    <span style=color:#66d9ef>else</span>:
        fin <span style=color:#f92672>=</span> open(file, <span style=color:#e6db74>&#39;r&#39;</span>)

    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> fin:
        ip <span style=color:#f92672>=</span> line<span style=color:#f92672>.</span>strip()
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ip: <span style=color:#66d9ef>continue</span>

        ip_int <span style=color:#f92672>=</span> ip_to_int(ip)
        answer <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
        <span style=color:#66d9ef>for</span> from_int, to_int, country <span style=color:#f92672>in</span> ipdb:
            <span style=color:#66d9ef>if</span> from_int <span style=color:#f92672>&lt;=</span> ip_int <span style=color:#f92672>&lt;=</span> to_int:
                answer <span style=color:#f92672>=</span> country
                <span style=color:#66d9ef>break</span>

        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> batch_mode:
            print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>,</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> (ip, answer))

        countries[answer] <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>

    fin<span style=color:#f92672>.</span>close()
</code></pre></div><p>And that&rsquo;s it. I could use a more intelligent data structure for the IP ranges, but honestly, it runs quickly enough. Perhaps sometime in the future.</p>
<p>Here are a few cases of the script in action (using the default &lsquo;GeoIPCountryWhois.csv&rsquo; in the same directory, using randomly generated IPs):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>~</span> <span style=color:#f92672>./</span>country<span style=color:#f92672>-</span>by<span style=color:#f92672>-</span>ip<span style=color:#f92672>.</span>py ips<span style=color:#f92672>.</span>txt

<span style=color:#ae81ff>242.73.117.31</span>,<span style=color:#66d9ef>None</span>
<span style=color:#ae81ff>148.132.51.11</span>,United States
<span style=color:#ae81ff>187.59.146.126</span>,Brazil
<span style=color:#ae81ff>155.152.27.52</span>,United States
<span style=color:#ae81ff>108.110.155.43</span>,United States
<span style=color:#ae81ff>175.147.205.217</span>,China
<span style=color:#ae81ff>222.68.15.191</span>,China
<span style=color:#ae81ff>35.184.64.198</span>,United States
<span style=color:#ae81ff>207.141.97.197</span>,United States
<span style=color:#ae81ff>154.254.107.40</span>,<span style=color:#66d9ef>None</span>

<span style=color:#f92672>~</span> <span style=color:#f92672>./</span>country<span style=color:#f92672>-</span>by<span style=color:#f92672>-</span>ip<span style=color:#f92672>.</span>py <span style=color:#f92672>--</span>batch ips<span style=color:#f92672>.</span>txt

<span style=color:#66d9ef>None</span>,<span style=color:#ae81ff>2</span>
Brazil,<span style=color:#ae81ff>1</span>
China,<span style=color:#ae81ff>2</span>
United States,<span style=color:#ae81ff>5</span>
</code></pre></div><p>And that&rsquo;s all there is to it. Hope someone out there finds it useful, I sure did.</p>
<p>If you&rsquo;d like to download the entire source (with the setup and command line processing included), you can do so here: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/country-by-ip.py title="Country by IP source">country-by-ip source</a>.</p></div>
</article></div>
</div><footer id=page-footer role=contentinfo>
<nav id=footer-navigation role=navigation class=ribbon>
<ul class=main-navigation>
<li><a href=/archive-by-date/>All posts: By Date</a></li>
<li><a href=/archive-by-tag/>All posts: By Tag</a></li>
<li>
<a href=/atom.xml>
RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li><li>
<a href=/programming/atom.xml>
RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li></ul>
</nav>
<div id=page-footer-content>
<div class=legal>
<p>
All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US>
<img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png>
</a>
</p>
<p>
Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a>
</p>
</div>
</div>
</footer>
</div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script src=/custom.js></script>
</body>
</html>
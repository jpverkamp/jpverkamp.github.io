<!DOCTYPE html>
<html>
<head>
        
        

        <title>The Evolution Of Flibs | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/tomorrow-night.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li></ul></li></ul>

      <!--
      <form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>
      </form>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">The Evolution Of Flibs</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2012-10-18"><span class="year">2012</span> <span class="month">Oct</span> <span class="day">18</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/by-source/programming-praxis">Programming Praxis</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/scheme">Scheme</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/racket">Racket</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic/algorithms/genetic-algorithms">Genetic Algorithms</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>In the past, I absolutely loved messing around with <a href="https://en.wikipedia.org/wiki/genetic_algorithms">Genetic algorithm</a>. The idea of bringing the power of natural selection to bear to solve all manner of problems just appeals to me for some reason. So when I came across a puzzle on on Programming Praxis called <a href="http://programmingpraxis.com/2012/07/13/the-evolution-of-flibs/">The Evolution of Flibs</a>, I just knew that I had to give it a shot.</p>
<!--more-->
<p>The basic idea isn't so complicated, although since what we're evolving is a <a href="https://en.wikipedia.org/wiki/finite_automaton">finite automaton</a>, you'll probably need a bit of a background in each.</p>
<p>If you want to follow along, you can download the code here: <a href='https://github.com/jpverkamp/small-projects/blob/master/blog/flibs.rkt'>flibs source code</a></p>
<p>The eventual goal will be--given a binary sequence--to evolve a finite state machine that will recognize the sequence and output the same, offset by one. So if we're given the sequence <code>010011010011</code>, the solution will output something like this: <code>001001101001</code>.</p>
<p>So what do we need to do this? First, we need a way to represent the finite automaton. We're just going to directly go with what they suggested in the post and build machines with three states. So for example, this would be a valid machine:</p>
<table class="table table-striped">
<tr><td></td><td colspan="2">Input 0</td><td colspan="2">Input 1</td></tr>
<tr><td>A</td><td>1</td><td>B</td><td>1</td><td>C</td></tr>
<tr><td>B</td><td>0</td><td>C</td><td>0</td><td>B</td></tr>
<tr><td>C</td><td>1</td><td>A</td><td>0</td><td>A</td></tr>
</table>
<p>Which is equivalent to this diagram:</p>
<p><a data-toggle="lightbox" href="http://blog.jverkamp.com/2012/10/18/the-evolution-of-flibs/FSA-diagram.png"><img src="http://blog.jverkamp.com/2012/10/18/the-evolution-of-flibs/FSA-diagram.png" /></a></p>
<p>So how can we represent this in code? I went with a vector just writing straight across the rows and then down the columns. So the chart represented above then becomes this vector:</p>
<pre class="scheme"><code>'#(1 B 1 C 0 C 0 B 1 A 0 A)</code></pre>
<p>Given a flib and an input (also represented as a vector), how do we generate the output?</p>
<pre class="scheme"><code>; run a flib on a given input
(define (run-flib flib input)
  ; turn a state into a number
  (define (f s) (case s [(A) 0] [(B) 1] [(C) 2]))

  ; initial state
  (define state 'A)

  ; loop over the flip, update state and report output
  (for/vector ([this input])
    (let ([next (vector-ref flib (+ (* (f state) 4) (* this 2) 1))]
          [output (vector-ref flib (+ (* (f state) 4) (* this 2)))])
      (set! state next)
      output)))</code></pre>
<p>Basically, keep a mutable state starting at <code>A</code>. At each tick, pull apart the rows in the vector structure from above to get the output for the current state and input, along with the next input. Each enough, but still nothing like a genetic algorithm.</p>
<p>The general idea of the algorithm is to generate a random initial population then repeatedly mutate and breed those individuals until the population improves enough to find an optimal solution. So the first thing we need is a way to generate random flibs. Easy enough with <code>for/vector</code>:</p>
<pre class="scheme"><code>; generate a random flib
; a flib is a state machine of the form
;   0  1
; A 1B 1C
; B 0C 0B
; C 1A 0A =&gt; 1B1C0C0B1A0A
(define (random-flib)
  (for/vector ([i 12])
    (if (even? i)
        (random 2)
        (vector-ref '#(A B C) (random 3)))))</code></pre>
<p>After that, we need to calculate the fitness of each individual in the population. The strongest individuals will survive, the weaker ones will die off. So here's a function that will take an flib and an input vector, run the flib using the function above, and then measure the difference (offset by 1 as noted above).</p>
<pre class="scheme"><code>; score a flib by calculating it's output, shifting one right
; and counting differences
(define (score-flib flib input)
  (define output (run-flib flib input))
  (- 1.0 (/ (for/sum ([i (- (vector-length input) 1)])
              (abs (- (vector-ref input (+ i 1))
                      (vector-ref output i))))
            (- (vector-length input) 1))))</code></pre>
<p>That's enough to tell us which the stronger individuals are, but how do we use that to improve the population? Two different ways. First, we want to be able to take two individuals together and "breed" them. In the example given, they suggested breeding the strongest and weakest individual and using that to replace the weakest, but there are many possible strategies. The one I went for was to remove the lowest (given) number from a population and then breeding surviving members at random to get back to the original population size. We'll see that later in the <code>run</code> function.</p>
<pre class="scheme"><code>; breed two flibs by selecting a crossover point and merging input
(define (breed flib1 flib2)
  (define @"@" (random (vector-length flib1)))
  (for/vector ([i (vector-length flib1)]
               [c1 flib1]
               [c2 flib2])
    (if (&lt; i @"@") c1 c2)))</code></pre>
<p>The other option for advancement will mostly be used to break out of local optimums. With just crossovers, eventually a population is likely to stagnate as the individuals become too similar. So here we'll occasionally mutate an flib by randomly tweaking one of the genes therein.</p>
<pre class="scheme"><code>; mutate a flib by random altering one character
(define (mutate flib)
  (define @"@" (random (vector-length flib)))
  (for/vector ([i (vector-length flib)]
               [c flib])
    (if (= @"@" i)
        (if (symbol? c)
            (vector-ref '#(A B C) (random 3))
            (random 2))
        c)))</code></pre>
<p>And with that, we're as good as done. I added a few more functions to help, for example to turn a string into a vector like the ones we want, which you can here: <a href='https://github.com/jpverkamp/small-projects/blob/master/blog/flibs.rkt'>flibs source code</a>. And without further ado, here's the main function:</p>
<pre class="scheme"><code>; use a genetic algorithm to find a perfect flib
(define (run input
             [pool-size 12]  ; number of flibs to breed
             [kill-off 2]    ; remove the lowest this many flibs each generation
                             ;   refill by breeding two random surviving flibs
             [mutate-% 0.1]) ; mutate this percentage of flibs each generation

  ; sort a pool by a given criteria
  (define (sort-pool pool)
    (sort
     pool
     (lambda (p1 p2) (&gt; (car p1) (car p2)))))

  ; iterate until we have a winner
  (let loop ([pool (sort-pool
                    (for/list ([i pool-size])
                      (let ([flib (random-flib)])
                        (list (score-flib flib input) flib))))]
             [high-score 0])

    ; find a new maximum
    (define new-max (&gt; (caar pool) high-score))
    (define next-high-score (if new-max (caar pool) high-score))
    (define high-flib (cadar pool))

    ; display progress
    (when new-max
      (printf "new best flib: ~s scoring ~s\n" high-flib next-high-score))

    ; loop (or not)
    (if (&lt; next-high-score 1)
        (loop
         ; kill off and replace the lowest performing flibs for the new pool
         (sort-pool
          (append
           ; add new flibs by breeding the old ones
           (for/list ([i kill-off])
             (let ([flib1 (cadr (list-ref pool (- pool-size kill-off)))]
                   [flib2 (cadr (list-ref pool (- pool-size kill-off)))])
               (let ([flib3 (breed flib1 flib2)])
                 (list (score-flib flib3 input) flib3))))
           ; randomly mutate surviving flibs the given percent of the time
           (for/list ([sflib (drop (reverse pool) kill-off)])
             (if (&lt; (random) mutate-%)
                 (let ([f (mutate (cadr sflib))])
                   (list (score-flib f input) f))
                 sflib))))
         next-high-score)

        high-flib)))</code></pre>
<p>Hopefully it should be pretty self explanatory, particularly with the comments I've included, but there are definitely some more interesting bits. For example, the <code>pool</code> is going to be maintained as a list of pairs. Each pair has the score of an flib and then the flib in question to make sorting easier (without recalculating the score whenever we want to sort).</p>
<p>The next interesting part is the loop. Each iteration, we'll have a sorted list, so we'll check for the highest scoring flib currently in the pool. If it's better than what we've seen, print that out and remember it. Otherwise, just keep going.</p>
<p>The bulk of work of updating the generation takes place in the recursive call to <code>loop</code>. We'll use <code>drop</code> to remove the weakest parts of the population (after a <code>reverse</code> so that they're at the front of the list) and then append on the newly bred members with their randomly selected parents.</p>
<p>And that's actually all there is to it. Here's an example of running it:</p>
<pre class="scheme"><code>&gt; (run (string-&gt;input (repeat-string "010011" 5)))
new best flib: #(1 C 1 C 1 B 1 A 1 A 0 A) scoring 0.8275862068965517
new best flib: #(1 B 1 A 0 C 0 B 1 A 0 A) scoring 0.8620689655172413
new best flib: #(1 A 1 C 1 B 0 C 0 A 0 B) scoring 0.9655172413793104
new best flib: #(1 C 0 A 0 C 1 A 1 B 0 B) scoring 1.0
'#(1 C 0 A 0 C 1 A 1 B 0 B)</code></pre>
<p>Not the same machine we had above, but they both represent the string. If we run the same thing again, we're likely to get another equivalent result:</p>
<pre class="scheme"><code>&gt; (run (string-&gt;input (repeat-string "010011" 5)))
new best flib: #(1 C 0 C 1 B 0 B 1 A 1 C) scoring 0.6551724137931034
new best flib: #(1 C 1 A 1 C 0 B 1 A 0 A) scoring 0.6896551724137932
new best flib: #(1 A 1 B 0 A 0 A 0 A 1 B) scoring 0.8275862068965517
new best flib: #(1 C 1 C 0 C 1 B 1 A 0 B) scoring 0.8620689655172413
new best flib: #(1 B 0 C 1 A 1 C 0 A 0 B) scoring 0.9655172413793104
new best flib: #(1 A 0 C 1 B 1 C 0 B 0 A) scoring 1.0
'#(1 A 0 C 1 B 1 C 0 B 0 A)</code></pre>
<p>Alternatively, we can tweak the other parameters. Say we wanted a larger population with a 1/5 killoff rate and twice the mutation rate:</p>
<pre class="scheme"><code>&gt; (run (string-&gt;input (repeat-string "010011" 5)) 25 5 0.2)
new best flib: #(1 A 0 C 0 B 0 A 0 A 1 A) scoring 0.6896551724137932
new best flib: #(0 C 1 C 1 C 1 C 1 A 0 A) scoring 0.8275862068965517
new best flib: #(0 C 0 A 1 A 0 B 1 C 1 B) scoring 0.8620689655172413
new best flib: #(0 B 1 C 1 A 0 A 1 B 0 C) scoring 0.9655172413793104
new best flib: #(1 A 0 B 0 C 0 A 1 C 1 B) scoring 1.0
'#(1 A 0 B 0 C 0 A 1 C 1 B)</code></pre>
<p>That's one of the fun parts about genetic algorithms is tuning the parameters. Any given problem can have vastly different sets of optimal parameters.</p>
<p>In any case, that's all I have for now. I've started working on a version that will generalize to any string (with only three states, this can only recognize strings with a limited length), but progress is proving rocky. We'll see how it goes.</p>
<p>If you would like the source code, you can get it here: <a href='https://github.com/jpverkamp/small-projects/blob/master/blog/flibs.rkt'>flibs source code</a></p>
<p>If you have any questions or comments, drop me a line below.</p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "The Evolution Of Flibs";
var disqus_url = "http://blog.jverkamp.com/2012/10/18/the-evolution-of-flibs/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2012/10/17/rule-30-rng">← Rule 30 RNG</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2012/10/19/a-sea-of-stars-ch-16-collision">A Sea of Stars - Ch. 16 - Collision →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2012/10/17/rule-30-rng">← Rule 30 RNG</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2012/10/20/memoization-in-racket">Memoization in Racket →</a></li></ul></nav>

                <div class="legal">
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
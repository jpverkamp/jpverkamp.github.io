<!doctype html><html><head><title>OpenID - Part 2 – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js defer></script>
<script src=/custom.min.9bb1a6d1e0b58ced38df246e4479317e4561461cfabab31b36fbc36035186214.js defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css><link rel=stylesheet href=/custom.min.3bcba67844fc4a76aa7c1947a1fcf14cddaf8e9e0f1e734fde0fa219416f058d.css></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>OpenID - Part 2</h1><div class=entry-meta><span class=entry-date>2012-07-20</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/07/19/adventures-in-openid-land/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/css>CSS</a></li><li><a href=https://blog.jverkamp.com/2012/07/19/adventures-in-openid-land/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/html>HTML</a><a href=https://blog.jverkamp.com/2012/09/26/line-art-with-an-html5-canvas/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2012/07/19/adventures-in-openid-land/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/php>PHP</a><a href=https://blog.jverkamp.com/2014/01/13/csrf-protection-injection-with-jquery-and-zend/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/07/19/adventures-in-openid-land/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/web-development>Web Development</a><a href=https://blog.jverkamp.com/2012/09/26/line-art-with-an-html5-canvas/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2012/07/19/adventures-in-openid-land/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/08/17/the-loneliest-number.../ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2012/07/19/adventures-in-openid-land/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/07/23/the-amazing-spider-man/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>I <a href=https://blog.jverkamp.com/2012/07/19/adventures-in-openid-land/>wrote yesterday </a>about getting OpenID up and running, but when I played with the code a bit more today, I realized that something funny was going on. Yahoo worked exactly as I expected, when I clicked on the link for the first time, it would take me to the Yahoo login page and then to a page to grant the proper permissions. All well and good. The same with Google.</p><p>But when I logged out of the app and tried to log back in, Google would show the same authentication screen each time. Granted, it was working so far as getting the authentication that I wanted from it, but it was still a little frustrating having to go through that step each time. And if it was frustrating for me, I could only imagine how bad it would be for any users down the line. The strangest part was that it worked fine when I was just getting the identity, but not when I also requested the email.</p><p>I ended up spending about two hours (twice as long as getting everything set up in the first place) fruitlessly searching for something that would tell me what was going on, but I kept bouncing around on the same few StackOverflow <a title="LightOpenID forbidden when redirecting back" href=http://stackoverflow.com/questions/4696234/lightopenid-forbidden-when-redirecting-back>[1]</a> <a title="Log-in the user with LightOpenID" href=http://stackoverflow.com/questions/3995011/log-in-the-user-with-lightopenid>[2]</a> and Google App Engine <a title="Using Federated Authentication via OpenID in Google App Engine" href=https://developers.google.com/appengine/articles/openid>[1]</a> pages, none of which were particularly helpful to my particular case.</p><p>Finally, the query &lsquo;<a title="Google Query for 'openid &#34;remember this approval&#34; not working'" href='http://www.google.com/search?q=openid+"remember+this+approval"+not+working'>openid &ldquo;remember this approval&rdquo; not working</a>&rsquo; led me to <a title='"Remember this approval" being asked every auth ' href=https://groups.google.com/forum/?fromgroups#!topic/google-federated-login-api/yvJ2tmdtr00>this 2009 discussion</a> on Google Groups (with almost that exact same subject line). The final response, which was only sent to the entire list &ldquo;because the answer may have general interest&rdquo;, has this little gem in it:</p><p>I think the problem here is that you are not setting any value for &ldquo;openid.realm&rdquo;. As such, we are inferring the realm as the &ldquo;openid.return_to&rdquo; (as we should, per the OpenID spec). The problem is that your return_to includes some random number, so it is unique to each request. So basically, there is no fixed handle that allow us to use in storing the user&rsquo;s preferences.</p><p>Interesting.</p><p>After a few more minutes search and <a title="What should I set REALM to, using LightOpenID, for Google url's to remain consistent, for storage in my database?" href=http://stackoverflow.com/questions/5453156/what-should-i-set-realm-to-using-lightopenid-for-google-urls-to-remain-consis>another relevant StackOverflow post</a> (I really should get more involved with that site, it&rsquo;s an amazing resource for programmers), I realize that I had to set the LightOpenID realm to something consistent and relevant:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>realm</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://example.com/&#39;</span>;
</span></span></code></pre></div><p>Bam. Now it works. It&rsquo;s always amazing when you spend hours working on a one line fix. Hopefully if anyone has this particular problem in the future, there&rsquo;s now one more post on the Internet about how to fix it.</p><p>For anyone interested, here is the complete code that I&rsquo;m using for OpenID now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>session_start</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$openid <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LightOpenID</span>(<span style=color:#e6db74>&#39;http://example.com/&#39;</span>);
</span></span><span style=display:flex><span>$openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>realm</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://example.com/&#39;</span>;
</span></span><span style=display:flex><span>$openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>required</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#39;contact/email&#39;</span>);
</span></span><span style=display:flex><span>$openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>returnURL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://example.com/&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Login via google
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>isset</span>($_POST[<span style=color:#e6db74>&#39;login-google&#39;</span>])) {
</span></span><span style=display:flex><span>        $_SESSION[<span style=color:#e6db74>&#39;provider&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Google&#39;</span>;
</span></span><span style=display:flex><span>        $openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>identity</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://www.google.com/accounts/o8/id&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#39;Location: &#39;</span> <span style=color:#f92672>.</span> $openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>authUrl</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// We&#39;re returning from a login attempt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>elseif</span> ($openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>validate</span>()) {
</span></span><span style=display:flex><span>	$attrs <span style=color:#f92672>=</span> $openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getAttributes</span>();
</span></span><span style=display:flex><span>	$_SESSION[<span style=color:#e6db74>&#39;id&#39;</span>] <span style=color:#f92672>=</span> $attrs[<span style=color:#e6db74>&#39;contact/email&#39;</span>];
</span></span><span style=display:flex><span>        $_SESSION[<span style=color:#e6db74>&#39;openid&#39;</span>] <span style=color:#f92672>=</span> $openid<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>identity</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
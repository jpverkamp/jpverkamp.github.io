<!doctype html><html><head><title>One Billion Primes - Segmented Sieve – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.a8e11addf4349ee2ca5045f7f3cbf1febbf2c3a2840be2143ea69539c10f8c7f.js integrity="sha256-qOEa3fQ0nuLKUEX388vx/rvyw6KEC+IUPqaVOcEPjH8=" defer></script><script src=/katex_17296078054267651618.min.4a06464d8d6f8358d8896de62b53b5a89205d335dfd8c5b6b27edd7c039ae9d8.js integrity="sha256-SgZGTY1vg1jYiW3mK1O1qJIF0zXf2MW2sn7dfAOa6dg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.a17078917a4403310cd19178939257b706fb5e1da76167c9f4a6d2123c9d59c4.js integrity="sha256-oXB4kXpEAzEM0ZF4k5JXtwb7Xh2nYWfJ9KbSEjydWcQ=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.7420a1602c62a85d4b50881c1d8ce42f72c049dc2b097d440696425d6e54bb1e.css integrity="sha256-dCChYCxiqF1LUIgcHYzkL3LASdwrCX1EBpZCXW5Uux4="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.61064b3964637440ee1c28e577377fcf238ddc5939020ef8b3c3cae543898111.css integrity="sha256-YQZLOWRjdEDuHCjldzd/zyON3Fk5Ag74s8PK5UOJgRE="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/home-automation/>Home Automation</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>One Billion Primes - Segmented Sieve</h1><div class=entry-meta><span class=entry-date>2012-11-29</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/racket>Racket</a><a href=https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/programming-praxis>Programming Praxis</a><a href=https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/11/08/project-euler-5/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/mathematics>Mathematics</a><a href=https://blog.jverkamp.com/2012/12/14/narcissistic-numbers/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2012/11/01/the-sum-of-the-first-billion-primes/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/prime-numbers>Prime Numbers</a><a href=https://blog.jverkamp.com/2012/12/22/nested-primes/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2012/11/29/confession-day-29/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/12/01/confession-day-30/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>After a <a href=https://blog.jverkamp.com/2012/11/01/the-sum-of-the-first-billion-primes/>sum of the first billion primes</a> post (originally from <a title="Programming Praxis: The Sum Of The First Billion Primes" href=http://programmingpraxis.com/2012/09/11/the-sum-of-the-first-billion-primes/>Programming Praxis</a>), I decided to finally write a segmented version of the <a href=https://en.wikipedia.org/wiki/Sieve%20of%20Eratosthenes>Sieve of Eratosthenes</a>.</p><p>Basically, the idea is not to make a sieve for the entire 23 billion numbers that you&rsquo;ll be summing, instead just make a sieve for the first square root of them. This is guaranteed to contain all of the primes you will need to divide by for the rest of the list. After that, just reuse that same vector over and over again until you&rsquo;ve counted enough primes. This should definitely help with the memory issues I was having and should also be much faster (we can take better advantage of memory caches).</p><p>If you&rsquo;d like to follow along, the entire code is available on <a title="GitHub: Segmented billion primes source" href=https://github.com/jpverkamp/small-projects/blob/master/blog/billion-primes-segmented.rkt>GitHub</a>.</p><p>First we need to create the initial sieve. This code is nearly identical to the original sieve code except we&rsquo;re only sieving up to the square root of the upper bound on the nth prime.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; sieve up to sqrt of the estimated high prime</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>define-values</span> (<span style=color:#a6e22e>lo</span> hi) (<span style=color:#a6e22e>guess-nth-prime</span> n))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>sieve-size (+ <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>integer-sqrt</span> hi)))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>sieve (make-vector sieve-size <span style=color:#66d9ef>#t</span>))
</span></span><span style=display:flex><span>(vector-set! sieve <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>#f</span>)
</span></span><span style=display:flex><span>(vector-set! sieve <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>#f</span>)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>for*</span> ([i (<span style=color:#a6e22e>in-range</span> <span style=color:#ae81ff>2</span> sieve-size)]
</span></span><span style=display:flex><span>       <span style=color:#f92672>#</span>:when (vector-ref sieve i)
</span></span><span style=display:flex><span>       [j (<span style=color:#a6e22e>in-range</span> (* i i) sieve-size i)])
</span></span><span style=display:flex><span>  (vector-set! sieve j <span style=color:#66d9ef>#f</span>))
</span></span></code></pre></div><p>And then we can turn that directly into a list of primes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; create a list of just those primes</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>primes
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>for/list</span> ([i (<span style=color:#a6e22e>in-naturals</span>)]
</span></span><span style=display:flex><span>             [p? (<span style=color:#a6e22e>in-vector</span> sieve)]
</span></span><span style=display:flex><span>             <span style=color:#f92672>#</span>:when p?)
</span></span><span style=display:flex><span>    i))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>sum (apply + primes))
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>cnt (length primes))
</span></span></code></pre></div><p>The next step starts the loop that will segment and sum the primes. First, code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span><span style=color:#75715e>; reuse the sieve in blocks until we&#39;ve found enough</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>loop ([lo sieve-size])
</span></span><span style=display:flex><span>    <span style=color:#75715e>; clear the vector</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>for</span> ([i (<span style=color:#a6e22e>in-range</span> sieve-size)]) (vector-set! sieve i <span style=color:#66d9ef>#t</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; remove all multiples of candidate primes</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>for*</span> ([p (<span style=color:#a6e22e>in-list</span> primes)]
</span></span><span style=display:flex><span>           [i (<span style=color:#a6e22e>in-range</span> (<span style=color:#66d9ef>if </span>(<span style=color:#a6e22e>divides?</span> lo p) <span style=color:#ae81ff>0</span> (- p (<span style=color:#a6e22e>mod</span> lo p))) sieve-size p)])
</span></span><span style=display:flex><span>      (vector-set! sieve i <span style=color:#66d9ef>#f</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; add new primes to sum and count</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>for</span> ([i (<span style=color:#a6e22e>in-range</span> lo (+ lo sieve-size))]
</span></span><span style=display:flex><span>          [p? (<span style=color:#a6e22e>in-vector</span> sieve)]
</span></span><span style=display:flex><span>          <span style=color:#f92672>#</span>:when (<span style=color:#66d9ef>and </span>p? (&lt; cnt n)))
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>set! </span>sum (+ sum i))
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>set! </span>cnt (+ cnt <span style=color:#ae81ff>1</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; if we&#39;re done, return the result, otherwise loop</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>if </span>(= cnt n)
</span></span><span style=display:flex><span>        sum
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>loop</span> (+ lo sieve-size)))))
</span></span></code></pre></div><p>As mentioned, we have to start by clearing out the previous values. After that, we want to remove candidates. This is a bit tricky as this segment doesn&rsquo;t necessarily (actually doesn&rsquo;t often) start at a multiple of each prime, so you have to find the first one. That&rsquo;s what the <code>(if (divides? lo p) 0 (- p (mod lo p)))</code> bit does.</p><p>Then, you simply go through this segment and add all of the primes into our running total. There&rsquo;s a bit of inefficiency here as we loop through the rest of the segment even when we hit our count, but I think that&rsquo;s actually acceptable. The next version of Racket will have a <code>#:break</code> parameter in <code>for</code> which would help in this case, but as it is, we&rsquo;re not losing much.</p><p>And there you have it. This should be everything we need to sum primes with a segmented sieve. Let&rsquo;s try it out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>&gt; (<span style=color:#a6e22e>for</span> ([n (<span style=color:#a6e22e>in-list</span> <span style=color:#f92672>&#39;</span>(<span style=color:#ae81ff>10000</span> <span style=color:#ae81ff>20000</span> <span style=color:#ae81ff>30000</span>))])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;~s:\n&#34;</span> n)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;~s\n\n&#34;</span> (<span style=color:#a6e22e>time</span> (<span style=color:#a6e22e>sum-primes</span> n))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>10000</span>:
</span></span><span style=display:flex><span>cpu time: <span style=color:#ae81ff>7</span> real time: <span style=color:#ae81ff>8</span> gc time: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>496165411</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1000000</span>:
</span></span><span style=display:flex><span>cpu time: <span style=color:#ae81ff>897</span> real time: <span style=color:#ae81ff>894</span> gc time: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7472966967499</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1000000000</span>:
</span></span><span style=display:flex><span>cpu time: <span style=color:#ae81ff>1512636</span> real time: <span style=color:#ae81ff>1510899</span> gc time: <span style=color:#ae81ff>3836</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>11138479445180240497</span>
</span></span></code></pre></div><p>Yes, you read that right. It only took a bit under half an hour (25 minutes 12 seconds) to sum the first billion primes where previously it had taken 2 hours 42 minutes for the Sieve of Eratosthenes and 1 hour 28 minutes for the Sieve of Atkin. It turns out that paying a bit of attention to memory access isn&rsquo;t necessarily a bad thing. &#x1f604;</p><p>If you&rsquo;d like to check out / download the entire code, you can do so here:</p><ul><li><a title="GitHub: Segmented billion primes source" href=https://github.com/jpverkamp/small-projects/blob/master/blog/billion-primes-segmented.rkt>segmented version</a></li><li><a title="GitHub billion primes source" href=https://github.com/jpverkamp/small-projects/blob/master/blog/billion-primes.rkt>original version</a></li></ul></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
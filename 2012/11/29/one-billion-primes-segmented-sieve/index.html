<!DOCTYPE html>
<html onclick >
<head>
    <title>One Billion Primes - Segmented Sieve – jverkamp.com</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"><link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css" integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous" />

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper"><header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a> *
            <a href="/resume">Resume</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>
    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation"><li><a href="https://blog.jverkamp.com/programming/">Programming</a></li><li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li><li><a href="https://blog.jverkamp.com/photography/">Photography</a></li><li><a href="https://blog.jverkamp.com/writing/">Writing</a></li><li><a href="https://blog.jverkamp.com/research/">Research</a></li><li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>
<div id="page-content-wrapper">
            <div id="page-content"><article>
	<header>
		<h1 class="entry-title">One Billion Primes - Segmented Sieve</h1>

        <div class="entry-meta"><span class="entry-date">2012-11-29</span>
            </div>

        <div class="entry-taxonomies"><div class="entry-tags"><ul class="taxonomy-keys"><li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/racket">Racket</a><a href="https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/" class="previous-link"></a><a class="taxonomy-value" href="/programming/languages/scheme">Scheme</a><a href="https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/sources/">Sources</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/" class="previous-link"></a><a class="taxonomy-value" href="/programming/sources/programming-praxis">Programming Praxis</a><a href="https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/" class="next-link"></a></li></ul>
        </li><li>
            <a class="taxonomy-key" href="/programming/topics/">Topics</a>
            <ul class="taxonomy-values"><li><a href="https://blog.jverkamp.com/2012/11/08/project-euler-5/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/mathematics">Mathematics</a><a href="https://blog.jverkamp.com/2012/12/14/narcissistic-numbers/" class="next-link"></a></li><li><a href="https://blog.jverkamp.com/2012/11/01/the-sum-of-the-first-billion-primes/" class="previous-link"></a><a class="taxonomy-value" href="/programming/topics/prime-numbers">Prime Numbers</a><a href="https://blog.jverkamp.com/2012/12/22/nested-primes/" class="next-link"></a></li></ul>
        </li><li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2012/11/21/list-algorithms-and-efficiency/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2012/12/10/numbers-of-wirth/" class="next-link">Next</a></ul>
        </li><li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li><a href="https://blog.jverkamp.com/2012/11/29/confession-day-29/" class="previous-link">Prev</a>
                <a href="https://blog.jverkamp.com/2012/12/01/confession-day-30/" class="next-link">Next</a></ul>
        </li></ul>
</div>
</div>
    </header>

	<div class="entry-content"><p>After a <a href="https://blog.jverkamp.com/2012/11/01/the-sum-of-the-first-billion-primes/">sum of the first billion primes</a> post (originally from <a title="Programming Praxis: The Sum Of The First Billion Primes" href="http://programmingpraxis.com/2012/09/11/the-sum-of-the-first-billion-primes/">Programming Praxis</a>), I decided to finally write a segmented version of the <a href="https://en.wikipedia.org/wiki/Sieve%20of%20Eratosthenes">Sieve of Eratosthenes</a>.</p>

<p>Basically, the idea is not to make a sieve for the entire 23 billion numbers that you&rsquo;ll be summing, instead just make a sieve for the first square root of them. This is guaranteed to contain all of the primes you will need to divide by for the rest of the list. After that, just reuse that same vector over and over again until you&rsquo;ve counted enough primes. This should definitely help with the memory issues I was having and should also be much faster (we can take better advantage of memory caches).</p>

<p>If you&rsquo;d like to follow along, the entire code is available on <a title="GitHub: Segmented billion primes source" href="https://github.com/jpverkamp/small-projects/blob/master/blog/billion-primes-segmented.rkt">GitHub</a>.</p>

<p>First we need to create the initial sieve. This code is nearly identical to the original sieve code except we&rsquo;re only sieving up to the square root of the upper bound on the nth prime.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; sieve up to sqrt of the estimated high prime</span>
(define-values (lo hi) (guess-nth-prime n))
(<span style="color:#66d9ef">define </span>sieve-size (+ <span style="color:#ae81ff">1</span> (integer-sqrt hi)))
(<span style="color:#66d9ef">define </span>sieve (make-vector sieve-size <span style="color:#66d9ef">#t</span>))
(vector-set! sieve <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">#f</span>)
(vector-set! sieve <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">#f</span>)
(for* ([i (in-range <span style="color:#ae81ff">2</span> sieve-size)]
       <span style="color:#f92672">#</span>:when (vector-ref sieve i)
       [j (in-range (* i i) sieve-size i)])
  (vector-set! sieve j <span style="color:#66d9ef">#f</span>))</code></pre></div>
<p>And then we can turn that directly into a list of primes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; create a list of just those primes</span>
(<span style="color:#66d9ef">define </span>primes
  (for/list ([i (in-naturals)]
             [p? (in-vector sieve)]
             <span style="color:#f92672">#</span>:when p?)
    i))
(<span style="color:#66d9ef">define </span>sum (apply + primes))
(<span style="color:#66d9ef">define </span>cnt (length primes))</code></pre></div>
<p>The next step starts the loop that will segment and sum the primes. First, code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme"><span style="color:#75715e">; reuse the sieve in blocks until we&#39;ve found enough</span>
  (<span style="color:#66d9ef">let </span>loop ([lo sieve-size])
    <span style="color:#75715e">; clear the vector</span>
    (for ([i (in-range sieve-size)]) (vector-set! sieve i <span style="color:#66d9ef">#t</span>))

    <span style="color:#75715e">; remove all multiples of candidate primes</span>
    (for* ([p (in-list primes)]
           [i (in-range (<span style="color:#66d9ef">if </span>(divides? lo p) <span style="color:#ae81ff">0</span> (- p (mod lo p))) sieve-size p)])
      (vector-set! sieve i <span style="color:#66d9ef">#f</span>))

    <span style="color:#75715e">; add new primes to sum and count</span>
    (for ([i (in-range lo (+ lo sieve-size))]
          [p? (in-vector sieve)]
          <span style="color:#f92672">#</span>:when (<span style="color:#66d9ef">and </span>p? (&lt; cnt n)))
      (<span style="color:#66d9ef">set! </span>sum (+ sum i))
      (<span style="color:#66d9ef">set! </span>cnt (+ cnt <span style="color:#ae81ff">1</span>)))

    <span style="color:#75715e">; if we&#39;re done, return the result, otherwise loop</span>
    (<span style="color:#66d9ef">if </span>(= cnt n)
        sum
        (loop (+ lo sieve-size)))))</code></pre></div>
<p>As mentioned, we have to start by clearing out the previous values. After that, we want to remove candidates. This is a bit tricky as this segment doesn&rsquo;t necessarily (actually doesn&rsquo;t often) start at a multiple of each prime, so you have to find the first one. That&rsquo;s what the <code>(if (divides? lo p) 0 (- p (mod lo p)))</code> bit does.</p>

<p>Then, you simply go through this segment and add all of the primes into our running total. There&rsquo;s a bit of inefficiency here as we loop through the rest of the segment even when we hit our count, but I think that&rsquo;s actually acceptable. The next version of Racket will have a <code>#:break</code> parameter in <code>for</code> which would help in this case, but as it is, we&rsquo;re not losing much.</p>

<p>And there you have it. This should be everything we need to sum primes with a segmented sieve. Let&rsquo;s try it out:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scheme" data-lang="scheme">&gt; (for ([n (in-list <span style="color:#f92672">&#39;</span>(<span style="color:#ae81ff">10000</span> <span style="color:#ae81ff">20000</span> <span style="color:#ae81ff">30000</span>))])
    (printf <span style="color:#e6db74">&#34;~s:\n&#34;</span> n)
    (printf <span style="color:#e6db74">&#34;~s\n\n&#34;</span> (time (sum-primes n))))

<span style="color:#ae81ff">10000</span>:
cpu time: <span style="color:#ae81ff">7</span> real time: <span style="color:#ae81ff">8</span> gc time: <span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">496165411</span>

<span style="color:#ae81ff">1000000</span>:
cpu time: <span style="color:#ae81ff">897</span> real time: <span style="color:#ae81ff">894</span> gc time: <span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">7472966967499</span>

<span style="color:#ae81ff">1000000000</span>:
cpu time: <span style="color:#ae81ff">1512636</span> real time: <span style="color:#ae81ff">1510899</span> gc time: <span style="color:#ae81ff">3836</span>
<span style="color:#ae81ff">11138479445180240497</span></code></pre></div>
<p>Yes, you read that right. It only took a bit under half an hour (25 minutes 12 seconds) to sum the first billion primes where previously it had taken 2 hours 42 minutes for the Sieve of Eratosthenes and 1 hour 28 minutes for the Sieve of Atkin. It turns out that paying a bit of attention to memory access isn&rsquo;t necessarily a bad thing. 😄</p>

<p>If you&rsquo;d like to check out / download the entire code, you can do so here:
- <a title="GitHub: Segmented billion primes source" href="https://github.com/jpverkamp/small-projects/blob/master/blog/billion-primes-segmented.rkt">segmented version</a>
- <a title="GitHub billion primes source" href="https://github.com/jpverkamp/small-projects/blob/master/blog/billion-primes.rkt">original version</a></p></div>
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "One Billion Primes - Segmented Sieve";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2012\/11\/29\/one-billion-primes-segmented-sieve\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div></article></div>
        </div><footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li><li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li></ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>
</div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js" integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="/custom.js" defer></script>
</body>
</html>

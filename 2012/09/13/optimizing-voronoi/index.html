<!doctype html><html><head><title>Optimizing Voronoi â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/auto-render_2152414756166376840.min.45ae2f6b03d0c7b867df0a6cb7d43215ec78369998685a5748c5b12f502321f2.js integrity="sha256-Ra4vawPQx7hn3wpst9QyFex4NpmYaFpXSMWxL1AjIfI=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.d99288811f82c16d031e4f6c01e50e18aeccbb9968db7c625a21660aef059ef5.css integrity="sha256-2ZKIgR+CwW0DHk9sAeUOGK7Mu5lo23xiWiFmCu8FnvU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Optimizing Voronoi</h1><div class=entry-meta><span class=entry-date>2012-09-13</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2012/09/10/fun-with-turtle-graphics-and-stars/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/java>Java</a><a href=https://blog.jverkamp.com/2013/01/06/wombat-ide-its-alive-bug-fixes/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2012/09/10/fun-with-turtle-graphics-and-stars/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/scheme>Scheme</a><a href=https://blog.jverkamp.com/2012/09/15/expanding-l-systems/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2012/09/10/fun-with-turtle-graphics-and-stars/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/09/15/expanding-l-systems/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2012/09/11/a-sea-of-stars-ch.-5-confession/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2012/09/14/a-sea-of-stars-ch.-6-greetings/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>Starting with my <a href=https://blog.jverkamp.com/2012/09/09/generating-voronoi-diagrams/>previous post</a> on Voronoi diagrams, I felt that I could do better. Sure, the code works well enough but it&rsquo;s almost painfully slow. So let&rsquo;s see if we can optimize it a bit.</p><p>First, here&rsquo;s the original code for comparison:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fill</span> dist rs cs pts cls)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>make-image</span> rs cs
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>r</span> c)
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>cadar</span>
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>sort</span>
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>pc1</span> pc2) (&lt; (car pc1) (car pc2)))
</span></span><span style=display:flex><span>          (map (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>pt</span> cl)
</span></span><span style=display:flex><span>                 (list (<span style=color:#a6e22e>dist</span> (list r c) pt) cl))
</span></span><span style=display:flex><span>            pts cls))))))
</span></span></code></pre></div><p>Basically, for each pixel in the new image we go through and build up a list of distance/color pairs for every reference point, then we sort them, then we choose the first one. But sorting introduces at least an <code>O(n log n)</code> cost that we really don&rsquo;t have to pay. So instead of sorting, why don&rsquo;t we keep track of the minimum distance/color as we go?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fill-fast</span> dist rs cs pts cls)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>make-image</span> rs cs
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>r</span> c)
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>let </span>([rc (list r c)])
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>let </span>loop ([min-d (<span style=color:#a6e22e>dist</span> (car pts) rc)]
</span></span><span style=display:flex><span>                   [min-cl (car cls)]
</span></span><span style=display:flex><span>                   [pts (cdr pts)]
</span></span><span style=display:flex><span>                   [cls (cdr cls)])
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>if </span>(null? pts)
</span></span><span style=display:flex><span>              min-cl
</span></span><span style=display:flex><span>              (<span style=color:#66d9ef>let </span>([new-d (<span style=color:#a6e22e>dist</span> (car pts) rc)])
</span></span><span style=display:flex><span>                (<span style=color:#66d9ef>if </span>(&lt; new-d min-d)
</span></span><span style=display:flex><span>                    (<span style=color:#a6e22e>loop</span> new-d (car cls) (cdr pts) (cdr cls))
</span></span><span style=display:flex><span>                    (<span style=color:#a6e22e>loop</span> min-d min-cl (cdr pts) (cdr cls))))))))))
</span></span></code></pre></div><p>Makes sense, but when you&rsquo;re doing straight forward recursion like that, you always should wonder if the code could be written more cleanly with a fold. It turns out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fill-fold</span> dist rs cs pts cls)
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>make-image</span> rs cs
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>r</span> c)
</span></span><span style=display:flex><span>      (<span style=color:#66d9ef>let </span>([rc (list r c)])
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>fold-left</span>
</span></span><span style=display:flex><span>          (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>min-d/cl</span> pt cl)
</span></span><span style=display:flex><span>            (<span style=color:#66d9ef>let </span>([new-d (<span style=color:#a6e22e>dist</span> (car pts) rc)])
</span></span><span style=display:flex><span>              (<span style=color:#66d9ef>if </span>(&lt; new-d (car min-d/cl))
</span></span><span style=display:flex><span>                  (list new-d cl)
</span></span><span style=display:flex><span>                  min-d/cl)))
</span></span><span style=display:flex><span>          (list (<span style=color:#a6e22e>dist</span> (car pts) rc) (car cls))
</span></span><span style=display:flex><span>          (cdr pts)
</span></span><span style=display:flex><span>          (cdr cls))))))
</span></span></code></pre></div><p>Okay, so perhaps it&rsquo;s not necessarily more clean as I ended up wrapping/unwrapping a pair with the distance and color over and over again, but it&rsquo;s still relatively straight forward. While I was at it, I also wrote a version for <code>fill-fold-right</code> that used <code>fold-right</code> instead of <code>fold-left</code> (which also required reordering the arguments as <code>(pt cl min-d/cl)</code>).</p><p>While I was at it, I also wrote a new distance function. <code>expt</code> can handle any exponent so likely can&rsquo;t do the same optimizations that a simple squaring function could do and at the same time, it shouldn&rsquo;t actually be necessary to do the square root as that won&rsquo;t effect the relative ordering of points for anything with a distance over 1 (all of them). So here we have a faster distance function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>fast-distance</span> p1 p2)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>([x (- (car p1) (car p2))]
</span></span><span style=display:flex><span>        [y (- (cadr p1) (cadr p2))])
</span></span><span style=display:flex><span>    (+ (* x x) (* y y))))
</span></span></code></pre></div><p>Enough with the code, let&rsquo;s see how it worked! To simplify testing, I wrote a timing macro and a simple test running framework:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scheme data-lang=scheme><span style=display:flex><span>(<span style=color:#66d9ef>define-syntax </span>timed
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>syntax-rules </span>(<span style=color:#a6e22e>as</span>)
</span></span><span style=display:flex><span>    [(<span style=color:#a6e22e>_</span> as name bodies <span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>     (<span style=color:#66d9ef>let* </span>([beg (<span style=color:#a6e22e>cpu-time</span>)]
</span></span><span style=display:flex><span>            [res (<span style=color:#66d9ef>begin </span>bodies <span style=color:#f92672>...</span>)])
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>printf</span> <span style=color:#e6db74>&#34;~a: ~a ms\n&#34;</span> name (- (<span style=color:#a6e22e>cpu-time</span>) beg))
</span></span><span style=display:flex><span>       res)]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>random-color</span>) (<span style=color:#a6e22e>color</span> (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>256</span>) (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>256</span>) (<span style=color:#a6e22e>random</span> <span style=color:#ae81ff>256</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>define </span>(<span style=color:#a6e22e>test</span> rs cs n)
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let* </span>([pts (map (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>_</span>) (list (<span style=color:#a6e22e>random</span> rs) (<span style=color:#a6e22e>random</span> cs))) (<span style=color:#a6e22e>iota</span> n))]
</span></span><span style=display:flex><span>         [cls (map (<span style=color:#66d9ef>lambda </span>(<span style=color:#a6e22e>_</span>) (<span style=color:#a6e22e>random-color</span>)) (<span style=color:#a6e22e>iota</span> n))])
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;original&#34;</span> (<span style=color:#a6e22e>fill</span> distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;faster&#34;</span> (<span style=color:#a6e22e>fill-fast</span> distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;folded (left)&#34;</span> (<span style=color:#a6e22e>fill-fold</span> distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;folded (right)&#34;</span> (<span style=color:#a6e22e>fill-fold-right</span> distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;original w/ fast dist&#34;</span> (<span style=color:#a6e22e>fill</span> fast-distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;faster w/ fast dist&#34;</span> (<span style=color:#a6e22e>fill-fast</span> fast-distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;folded (left) w/ fast dist&#34;</span> (<span style=color:#a6e22e>fill-fold</span> fast-distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>timed</span> as <span style=color:#e6db74>&#34;folded (right) w/ fast dist&#34;</span> (<span style=color:#a6e22e>fill-fold-right</span> fast-distance rs cs pts cls))
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>void</span>)))
</span></span></code></pre></div><p>Let&rsquo;s see what it says, shall we?</p><pre tabindex=0><code>~ (test 256 256 16)
original: 1844 ms
faster: 1829 ms
folded (left): 1522 ms
folded (right): 1498 ms
original w/ fast dist: 1494 ms
faster w/ fast dist: 1439 ms
folded (left) w/ fast dist: 1081 ms
folded (right) w/ fast dist: 1072 ms
</code></pre><p>Interesting&mldr; It turns out that the &ldquo;faster&rdquo; fold that I was working on really isn&rsquo;t that much faster at all. Folding (which essentially does the same thing but allows for more optimization) is even faster yet. Yet really it&rsquo;s the faster distance function that saves the day. The best code with the slower distance function is still faster than the worst code with the fastest distance function. It turns out that when you&rsquo;re trying to tune code, the primitives you&rsquo;re working with really matter.</p><p>Here&rsquo;s another much larger test set:</p><pre tabindex=0><code>~ (test 1024 1024 128)
original: 270476 ms
faster: 193126 ms
folded (left): 154777 ms
folded (right): 151224 ms
original w/ fast dist: 220065 ms
faster w/ fast dist: 141528 ms
folded (left) w/ fast dist: 98143 ms
folded (right) w/ fast dist: 95932 ms
</code></pre><p>This time at least the faster function is actually a decent bit faster, although the folded ones continue to dominate. Again though, the faster distance function made a much bigger splash.</p><p>As a last note, it&rsquo;s a little unfortunate that this code is even as slow as it is now. It shouldn&rsquo;t take even a second to generate a 256x256 Voronoi diagram, that sort of thing should take perhaps tens of milliseconds, if that. Mostly, it&rsquo;s due to the <a href=https://blog.jverkamp.com/2011/08/27/wombat-ide-c211-tree-and-image-libraries/>C211 image library</a>. It&rsquo;s designed so that the library code can be both easy to read and portable (<a href=https://blog.jverkamp.com/2012/02/23/wombat-ide-scheme/java-interop/>calling between Scheme and Java</a> for the strengths of each). Both unfortunately mean that the library is slower than I&rsquo;d like. Optimally, I&rsquo;d work on making it faster, but that&rsquo;s a post for another day.</p><p>If you&rsquo;d like to download the source code, you can do so here: <a href=https://github.com/jpverkamp/small-projects/blob/master/blog/find-in-pi.rkt title="voronoi source">voronoi source</a></p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
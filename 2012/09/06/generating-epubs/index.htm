<!DOCTYPE html>
<html>
<head>
        
        

        <title>Generating epubs | jverkamp.com | John-Paul Verkamp</title>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/3.0.3a/ekko-lightbox.min.js"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

        <!-- Highlight.js for syntax highlighting -->
        <link rel="stylesheet" href="/highlight/styles/obsidian.css" />
        <script src="/highlight/highlight.pack.js"></script>

        <!-- MathJax for LaTeX support -->
        <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- nanoGallery for Flickr Galleries -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

        <!-- Any custom CSS or JS that I've written; this should be kept minimal -->
        <link rel="stylesheet" href="/custom.css" />
        <script src="/custom.js"></script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="http://blog.jverkamp.com/feed/" />
</head>
<body>
        <header class="container">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.jverkamp.com"><span style="color: green;">jv</span>erkamp.com</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"><li class="dropdown"><a href="http://blog.jverkamp.com/category/archives" class="dropdown-toggle">Archives<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/archives/2004">2004</a></li><li><a href="http://blog.jverkamp.com/category/archives/2005">2005</a></li><li><a href="http://blog.jverkamp.com/category/archives/2006">2006</a></li><li><a href="http://blog.jverkamp.com/category/archives/2007">2007</a></li><li><a href="http://blog.jverkamp.com/category/archives/2008">2008</a></li><li><a href="http://blog.jverkamp.com/category/archives/2009">2009</a></li><li><a href="http://blog.jverkamp.com/category/archives/2010">2010</a></li><li><a href="http://blog.jverkamp.com/category/archives/2011">2011</a></li><li><a href="http://blog.jverkamp.com/category/archives/2012">2012</a></li><li><a href="http://blog.jverkamp.com/category/archives/2013">2013</a></li><li><a href="http://blog.jverkamp.com/category/archives/2014">2014</a></li><li><a href="http://blog.jverkamp.com/category/archives/2015">2015</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/other" class="dropdown-toggle">Other<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/other/board-game-reviews">Board Game Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/book-reviews">Book Reviews</a></li><li><a href="http://blog.jverkamp.com/category/other/cooking">Cooking</a></li><li><a href="http://blog.jverkamp.com/category/other/movie-reviews">Movie Reviews</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/photography" class="dropdown-toggle">Photography<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/photography/dp-challenge">DP Challenge</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosets">Photosets</a></li><li><a href="http://blog.jverkamp.com/category/photography/photosynth">Photosynth</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/programming" class="dropdown-toggle">Programming<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/programming/by-language">By Language</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-project">By Project</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-source">By Source</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/research" class="dropdown-toggle">Research<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/research/by-topic">By Topic</a></li><li><a href="http://blog.jverkamp.com/category/research/publications">Publications</a></li></ul></li><li class="dropdown"><a href="http://blog.jverkamp.com/category/writing" class="dropdown-toggle">Writing<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="http://blog.jverkamp.com/category/writing/by-genre">By Genre</a></li><li><a href="http://blog.jverkamp.com/category/writing/ideas">Ideas</a></li><li><a href="http://blog.jverkamp.com/category/writing/nanowrimo">NaNoWriMo</a></li><li><a href="http://blog.jverkamp.com/category/writing/novels">Novels</a></li><li><a href="http://blog.jverkamp.com/category/writing/other">Other</a></li><li><a href="http://blog.jverkamp.com/category/writing/short-stories">Short Stories</a></li><li><a href="http://blog.jverkamp.com/category/writing/writing-excuses">Writing Excuses</a></li></ul></li></ul>

      <form action="http://www.google.com/search" method="get" onSubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input name="q" type="hidden" />
          <input name="qfront" type="text" class="form-control" placeholder="Search" />
          <button type="submit" class="btn btn-default" value="Search">Search</button>
        </p>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
        </header>

        <article class="container">
                <header>
                        <h1 class="entry-title">Generating epubs</h1>

                        <div class="entry-meta">
                                <span class="posted-on"><time class="entry-date" datetime="2012-09-06"><span class="year">2012</span> <span class="month">Sept</span> <span class="day">6</span></time></span>
                                <span class="tags"><ul class="tag-list list-inline"><li><a href="http://blog.jverkamp.com/category/programming/libraries">Libraries</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/category/programming/by-language/python">Python</a></li></ul></span>
                        </div>

                        <hr />
                </header>
                <div class="entry-content">
                        <p>As <a href="http://blog.jverkamp.com/2012/08/28/so-ive-been-writing">I've previously noted</a>, I've been writing a fair bit recently. Everything that I write is stored in a series of plain text files (actually <a href="http://daringfireball.net/projects/markdown/" title="Markdown">Markdown</a>, but only really using italicized blocks and headers), something like this:</p>
<!--more-->
<pre>┌ ☺ <span style="color: purple;">verkampj</span>@<span style="color: #ffcc00;">minty</span> <span style="color: green;">~/Writing/Novels/A Sea of Stars</span>
└ ls -1

01 - Liftoff.txt
02 - Borealis.txt
03 - Inspection.txt
04 - Troubleshooting.txt
...</pre>
<p>As a side note, that's what my ZSH prompt looks like. I'm actually really happy with how I've (finally) gotten everything set up, so perhaps I'll post those some day. <span style="color: #ffcc00;">Minty</span> is my laptop's name, based on <a href="http://linuxmint.com/" title="Linux Mint">Linux Mint</a> (although amusingly I'm using a different OS now).</p>
<p>Theoretically, it should be easy enough to turn this into an ebook, so that's exactly what I've written. You can get the entire script <a href='https://github.com/jpverkamp/small-projects/blob/master/scripts/make-epub.py'>here</a> and it requires the <a href="https://code.google.com/p/python-markdown2/" title="Python: Markdown2">Markdown2</a> and <a href="https://code.google.com/p/python-epub-builder/" title="Python library: Epub builder">Epub Builder</a> libraries for Python to be installed.</p>
<p>Here are some of the more interesting bits of the code. First, set up the ebook:</p>
<pre class="python"><code># Start an epub
book = EpubBook()
book.setTitle(title)
book.addCreator('JP Verkamp')
book.addTitlePage()
book.addTocPage()</code></pre>
<p>After that, we need to go through each of the files. Assume that there are Markdown headers (<code>#</code> and <code>##</code>) in the files, either nested one or two levels deep. If there's only one level of headers, those become chapters. If there are two, the first level become parts and the second become chapters. This is also where the content gets Markdown'd into what will actually be display to the user, so if I wanted to add any extensions, this is where it would go.</p>
<pre class="python"><code># Run through the files and find the sections
levels = []
sections = []
buffer = ''
index = '1'
header = ''
min_depth = False
for file in files(path):
  lines = skip_bom(open(file, 'r').read()).split('\n')
  for line in lines:
         if line.startswith('#'):
                if header:
                   buffer = ''.join([c for c in buffer if ord(c) &lt; 128])
                   sections.append((index, header, buffer))

                buffer = line

                pounds, header = line.split(' ', 1)
                depth = pounds.count('#')

                if not min_depth or depth &lt; min_depth:
                   min_depth = depth

                if depth == len(levels):
                   levels[-1] += 1
                elif depth &lt; len(levels):
                   levels = levels[:depth]
                   levels[-1] += 1
                else:
                   while depth &gt; len(levels):
                          levels.append(1)

                index = '.'.join([str(s) for s in levels])
         else:
                buffer += line + '\n'
if buffer:
  buffer = ''.join([c for c in buffer if ord(c) &lt; 128])
  sections.append((index, header, buffer))</code></pre>
<p>Next we've got to actually add the contents to the ebook:</p>
<pre class="python"><code># Generate the book contents
i = 0
for index, header, content in sections:
  print('%s = %s' % (index, header))
  i += 1
  item = book.addHtml('', '%04d.html' % i, html(header, markdown(content)))
  book.addSpineItem(item)
  book.addTocMapNode(item.destPath, header, index.count('.') + 1)</code></pre>
<p>And the finally, create the actual file:</p>
<pre class="python"><code># Create the book
book.createBook(temp)
EpubBook.createArchive(temp, target)</code></pre>
<p>If all goes according to plan, you should have an epub now:</p>
<pre>┌ ☺ <span style="color: purple;">verkampj</span>@<span style="color: #ffcc00;">minty</span> <span style="color: green;">~/Writing/Novels/A Sea of Stars</span>
└ make-epub

Source: /home/verkampj/Dropbox/PlainText/Writing/Novels/A Sea of Stars
Target: A Sea of Stars.epub
  Temp: /tmp/tmphyZfcm

1 = Liftoff
2 = *Borealis*
3 = Inspection
4 = Troubleshooting
...

┌ ☺ <span style="color: purple;">verkampj</span>@<span style="color: #ffcc00;">minty</span> <span style="color: green;">~/Writing/Novels/A Sea of Stars</span>
└ ls -1 *.epub

A Sea of Stars.epub</pre>
<p>Good to go! You can get the entire script <a href='https://github.com/jpverkamp/small-projects/blob/master/scripts/make-epub.py'>here</a>.</p>
                </div>
                <div class="entry-footnotes">
                        <div id="footnotes"><ol></ol></div>
                </div>

                <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = "jverkamp";
var disqus_title = "Generating epubs";
var disqus_url = "http://blog.jverkamp.com/2012/09/06/generating-epubs/";
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>

        <footer class="container" role="contentinfo">
                <nav class="navbar navbar-default" role="navigation"><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2012/09/05/backing-up-google-reader">← Backing up Google Reader / Calendar</a></li><li><a href="http://blog.jverkamp.com/category/archives">Archives</a></li><li><a href="http://blog.jverkamp.com/2012/09/07/a-sea-of-stars-ch-4-troubleshooting">A Sea of Stars - Ch. 4 - Troubleshooting →</a></li></ul><ul class="nav navbar-nav nav-justified"><li><a href="http://blog.jverkamp.com/2012/09/05/backing-up-google-reader">← Backing up Google Reader / Calendar</a></li><li><a href="http://blog.jverkamp.com/category/programming">Programming</a></li><li><a href="http://blog.jverkamp.com/2012/09/08/the-first-two-problems">The First Two Problems →</a></li></ul></nav>

                <div class="legal">
                        <a href="http://blog.jverkamp.com/feed/atom.xml">feed <img style="border: 0;" src="http://blog.jverkamp.com/rss.png" /></a><br />
                        All posts unless otherwise mentioned are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a><br />
                        Any source code unless otherwise mentioned is licensed under the <a href="http://directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
                </div>
        </footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53688146-1', 'auto');
ga('send', 'pageview');
</script>
</body>
</html>
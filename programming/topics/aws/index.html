<!DOCTYPE html>
<html>
<head>
    <title>jverkamp.com</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li>
            <a href="https://twitter.com/jpverkamp">Twitter</a> *
            <a href="https://github.com/jpverkamp">GitHub</a> *
            <a href="https://www.flickr.com/photos/jpverkamp">Flickr</a>
        </li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
    <div class="entry-content">
        
    </div>

    

    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2019/01/04/listing-and-downloading-s3-versions/" class="clearfix">Listing and Downloading S3 Versions</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2019-01-04</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>Today I found the need to look through all old versions of a file in S3 that had versioning turned on. You can do it through the AWS Console, but I prefer command line tools. You can do it with <a href="https://aws.amazon.com/cli/">awscli</a>, but the flags are long and I can never quite remember them. So let&rsquo;s write up a quick script using <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a> (and as a bonus, try out <a href="https://click.palletsprojects.com/en/7.x/">click</a>)!</p>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/" class="clearfix">Counting and Sizing S3 Buckets</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2018-07-15</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>A long time ago in a galaxy far far away, I wrote up a script that I used to take an <a href="https://aws.amazon.com/s3/">AWS S3</a> bucket and count how many objects there were in the bucket and calculate its total size. While you could get some of this information from billing reports, there just wasn&rsquo;t a good way to get it other than that at the time. The only way you could do it was to&hellip; iterate through the entire bucket, summing as you go. If you have buckets with millions (or more) objects, this could take a while.</p>

<p>Basically:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">conn <span style="color:#f92672">=</span> boto<span style="color:#f92672">.</span>connect_s3()
<span style="color:#66d9ef">for</span> bucket <span style="color:#f92672">in</span> sorted(conn<span style="color:#f92672">.</span>get_all_buckets()):
    <span style="color:#66d9ef">try</span>:
        total_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        total_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        start <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now()

        <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> bucket<span style="color:#f92672">.</span>list_versions():
            <span style="color:#75715e"># Skip deleted files</span>
            <span style="color:#66d9ef">if</span> isinstance(key, boto<span style="color:#f92672">.</span>s3<span style="color:#f92672">.</span>deletemarker<span style="color:#f92672">.</span>DeleteMarker):
                <span style="color:#66d9ef">continue</span>

            size <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>size
            total_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            total_size <span style="color:#f92672">+=</span> size

        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;-- {count} files, {size}, {time} to calculate&#39;</span><span style="color:#f92672">.</span>format(
            count <span style="color:#f92672">=</span> total_count,
            size <span style="color:#f92672">=</span> humanize<span style="color:#f92672">.</span>naturalsize(total_size),
            time <span style="color:#f92672">=</span> humanize<span style="color:#f92672">.</span>naturaltime(datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now() <span style="color:#f92672">-</span> start)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; ago&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
        ))</code></pre></div>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2018/03/12/generating-zone-files-from-route53/" class="clearfix">Generating zone files from Route53</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2018-03-12</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>Recently I found myself wanting to do some analysis on all of our DNS entires stored in AWS&rsquo;s Route53 for security reasons (specifically to prevent subdomain takeover attacks, I&rsquo;ll probably write that up soon). In doing so, I realized that while Route53 has the ability to import a <a href="https://en.wikipedia.org/wiki/zone%20file">zone file</a>, it&rsquo;s not possible to export one.</p>

<p>To some extent, this makes sense. Since Route53 supports ALIAS records (which can automatically determine their values based on other AWS products, such as an ELB changing its public IP) and those aren&rsquo;t actually &lsquo;real&rsquo; DNS entries, things will get confused. But I don&rsquo;t currently intend to re-import these zone files, just use them. So let&rsquo;s see what we can do.</p>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2017/12/18/ssh-config-proxycommand-tricks/" class="clearfix">SSH Config ProxyCommand Tricks</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2017-12-18</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>Working in security/operations in the tech industry, I use <a href="https://en.wikipedia.org/wiki/SSH">SSH</a> a lot. To various different machines (some with hostnames, some without), using various different users and keys, and often (as was the case in my <a href="https://blog.jverkamp.com/2017/12/13/dynamic-automatic-proxies/">previous post</a>) via a <a href="https://en.wikipedia.org/wiki/bastion%20host">bastion host</a>. Over the years, I&rsquo;ve collected a number of SSH tricks that make my life easier.</p>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2017/11/15/clock-drift-in-docker-containers/" class="clearfix">Clock drift in Docker containers</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2017-11-15</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>I was working on a docker container which uses the aws cli to mess around with some autoscaling groups when I got a somewhat strange error:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">A client error <span style="color:#f92672">(</span>SignatureDoesNotMatch<span style="color:#f92672">)</span> occurred when calling the DescribeAutoScalingGroups operation: Signature not yet current: 20171115T012426Z is still later than 20171115T012420Z <span style="color:#f92672">(</span>20171115T011920Z + <span style="color:#ae81ff">5</span> min.<span style="color:#f92672">)</span></code></pre></div>
<p>Hmm.</p>

<p>Are the clocks off?</p>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2015/10/30/finding-ec2-instances-by-tag/" class="clearfix">Finding EC2 instances by tag</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2015-10-30</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>Another script similar to my previous post about <a href="https://blog.jverkamp.com/2015/07/22/finding-aws-iam-users-by-access-key/">Finding AWS IAM users by access key</a>. This time, we want to do much the same thing for EC2 instances by tag.</p>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2015/07/22/finding-aws-iam-users-by-access-key/" class="clearfix">Finding AWS IAM users by access key</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2015-07-22</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>Every once in a while<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>, I find myself with an <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSGettingStartedGuide/AWSCredentials.html">AWS access key</a> and need to figure out who in the world it belongs to. Unfortunately, so far as I&rsquo;ve been able to find, there&rsquo;s no way to directly do this in either the <a href="https://aws.amazon.com/console/">AWS console</a> or with the <a href="https://aws.amazon.com/cli/">AWS api</a>.</p>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/" class="clearfix">Configuring Websockets behind an AWS ELB</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2015-07-20</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>Recently at work, we were trying to get an application that uses <a href="https://en.wikipedia.org/wiki/websockets">websockets</a> working on an <a href="https://aws.amazon.com/">AWS</a> instance behind an <a href="https://aws.amazon.com/elasticloadbalancing/">ELB (load balancer)</a> and <a href="http://nginx.org/">nginx</a> on the instance.</p>

<p>If you&rsquo;re either not using a secure connection or handling the cryptography on the instance (either in nginx or Flask), it works right out of the box. But if you want the ELB to handle TLS termination it doesn&rsquo;t work nearly as well&hellip; Luckily, after a bit of fiddling, I got it working.</p>

<p><strong>Update 2018-05-31:</strong> A much easier solution, <a href="just use an ALB">https://aws.amazon.com/blogs/aws/new-aws-application-load-balancer/</a>:</p>

<blockquote>
<p><strong>WebSocket</strong> allows you to set up long-standing TCP connections between your client and your server. This is a more efficient alternative to the old-school method which involved HTTP connections that were held open with a “heartbeat” for very long periods of time. WebSocket is great for mobile devices and can be used to deliver stock quotes, sports scores, and other dynamic data while minimizing power consumption. ALB provides native support for WebSocket via the <code>ws://</code> and <code>wss://</code> protocols.</p>
</blockquote>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2015/04/03/performance-problems-with-flask-and-docker/" class="clearfix">Performance problems with Flask and Docker</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2015-04-03</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>I had an interesting problem recently on a project I was working on. It&rsquo;s a simple <a href="http://flask.pocoo.org/">Flask</a>-based webapp, designed to be deployed to <a href="https://aws.amazon.com/">AWS</a> using <a href="https://www.docker.com/">Docker</a>. The application worked just fine when I was running it locally, but as soon as I pushed the docker container&hellip;</p>

<p>Latency spikes. Bad enough that the application was failing AWS&rsquo;s healthy host checks, cycling in and out of existence<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>:</p>

<figure>
    <img src="/embeds/2015/health-check.png"/> 
</figure>
    	</div>

        
        <hr />
    </article>
    
    
    
    <article class="li">
    	<header>
    		<h1 class="entry-title">
                <a href="https://blog.jverkamp.com/2015/04/01/parsing-aws-instance-data-with-jq/" class="clearfix">Parsing AWS instance data with jq</a>
            </h1>

    		<div class="entry-meta">
                
                <span class="entry-date">2015-04-01</span>
                
                
    		</div>
    	</header>
    	<div class="entry-content">
            <p>Semi-random amusing code snippet of the day:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws ec2 describe-instances | jq <span style="color:#e6db74">&lt;&lt; EOF
</span><span style="color:#e6db74">    .[][].Instances[]
</span><span style="color:#e6db74">    | select(.Tags[]?.Value == &#34;production&#34;)
</span><span style="color:#e6db74">    | .PrivateIpAddress
</span><span style="color:#e6db74">EOF</span></code></pre></div>
    	</div>

        
        
    </article>
    
    

    <nav id="pagination-navigation" role="navigation">
        

    </nav>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/topics/atom.xml">
                    RSS: programming/topics<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

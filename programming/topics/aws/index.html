<!doctype html><html><head><title>jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.e0e68b86dea32185ab89b0b9cc01649107cc6b0be3290c8c7b13c716bc0dabfa.css integrity="sha256-4OaLht6jIYWribC5zAFkkQfMawvjKQyMexPHFrwNq/o="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><div class=entry-content></div><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2020/08/11/extending-my-ec2-script/ class=clearfix>Extending my EC2 script</a></h1><div class=entry-meta><span class=entry-date>2020-08-11</span></div></header><div class=entry-content><p>Another quick post.</p><p>What feels like a lifetime ago, I <a href=https://blog.jverkamp.com/2015/10/30/finding-ec2-instances-by-tag/>wrote a post</a> about finding <code>ec2</code> instances by name. I honestly use that script just about every day, mostly for automatically finding instances to SSH to (a la <a href=https://blog.jverkamp.com/2017/12/18/ssh-config-proxycommand-tricks/>SSH config tricks</a>). But there are a few other quick things I&rsquo;ve done with it:</p><ul><li><code>ec2-script</code> - Run a script on all instances of a given name</li><li><code>ec2-disk</code> - A specialization of <code>ec2-script</code> to check main disk usage</li><li><code>terminate</code> - A script that I use with <code>ec2</code> to terminate instances from the command line</li><li><code>ec2-cycle</code> - Slow cycle a given set of <code>ec2</code> instances by terminating so many per minute</li></ul><p>All of which are included in my <a href=https://github.com/jpverkamp/dotfiles/tree/master/bin target=_blank rel=noopener>dotfiles</a>.</p><p><a href=/2020/08/11/extending-my-ec2-script/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2019/04/30/forcing-secure-cookies-behind-an-elb-in-ruby/rails/ class=clearfix>Forcing Secure Cookies Behind an ELB in Ruby/Rails</a></h1><div class=entry-meta><span class=entry-date>2019-04-30</span></div></header><div class=entry-content><p>As part of general security good practices, you should always (whenever possible):</p><ul><li>use HTTPS to serve all requests</li><li>serve redirects to upgrade HTTP requests to HTTPS</li><li>set session cookies to <code>secure</code> and <code>http_only</code></li><li>enable HTTP Strict Transport Security (<code>HSTS</code>)</li></ul><p><a href=/2019/04/30/forcing-secure-cookies-behind-an-elb-in-ruby/rails/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2019/01/04/listing-and-downloading-s3-versions/ class=clearfix>Listing and Downloading S3 Versions</a></h1><div class=entry-meta><span class=entry-date>2019-01-04</span></div></header><div class=entry-content><p>Today I found the need to look through all old versions of a file in S3 that had versioning turned on. You can do it through the AWS Console, but I prefer command line tools. You can do it with <a href=https://aws.amazon.com/cli/ target=_blank rel=noopener>awscli</a>, but the flags are long and I can never quite remember them. So let&rsquo;s write up a quick script using <a href=https://boto3.amazonaws.com/v1/documentation/api/latest/index.html target=_blank rel=noopener>boto3</a> (and as a bonus, try out <a href=https://click.palletsprojects.com/en/7.x/ target=_blank rel=noopener>click</a>)!</p><p><a href=/2019/01/04/listing-and-downloading-s3-versions/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2018/07/15/counting-and-sizing-s3-buckets/ class=clearfix>Counting and Sizing S3 Buckets</a></h1><div class=entry-meta><span class=entry-date>2018-07-15</span></div></header><div class=entry-content><p>A long time ago in a galaxy far far away, I wrote up a script that I used to take an <a href=https://aws.amazon.com/s3/ target=_blank rel=noopener>AWS S3</a> bucket and count how many objects there were in the bucket and calculate its total size. While you could get some of this information from billing reports, there just wasn&rsquo;t a good way to get it other than that at the time. The only way you could do it was to&mldr; iterate through the entire bucket, summing as you go. If you have buckets with millions (or more) objects, this could take a while.</p><p>Basically:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>conn <span style=color:#f92672>=</span> boto<span style=color:#f92672>.</span>connect_s3()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> bucket <span style=color:#f92672>in</span> sorted(conn<span style=color:#f92672>.</span>get_all_buckets()):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        total_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        total_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        start <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key <span style=color:#f92672>in</span> bucket<span style=color:#f92672>.</span>list_versions():
</span></span><span style=display:flex><span>            <span style=color:#75715e># Skip deleted files</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(key, boto<span style=color:#f92672>.</span>s3<span style=color:#f92672>.</span>deletemarker<span style=color:#f92672>.</span>DeleteMarker):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            size <span style=color:#f92672>=</span> key<span style=color:#f92672>.</span>size
</span></span><span style=display:flex><span>            total_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            total_size <span style=color:#f92672>+=</span> size
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;-- </span><span style=color:#e6db74>{count}</span><span style=color:#e6db74> files, </span><span style=color:#e6db74>{size}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{time}</span><span style=color:#e6db74> to calculate&#39;</span><span style=color:#f92672>.</span>format(
</span></span><span style=display:flex><span>            count <span style=color:#f92672>=</span> total_count,
</span></span><span style=display:flex><span>            size <span style=color:#f92672>=</span> humanize<span style=color:#f92672>.</span>naturalsize(total_size),
</span></span><span style=display:flex><span>            time <span style=color:#f92672>=</span> humanize<span style=color:#f92672>.</span>naturaltime(datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> start)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39; ago&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>        ))
</span></span></code></pre></div><p><a href=/2018/07/15/counting-and-sizing-s3-buckets/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2018/03/12/generating-zone-files-from-route53/ class=clearfix>Generating zone files from Route53</a></h1><div class=entry-meta><span class=entry-date>2018-03-12</span></div></header><div class=entry-content><p>Recently I found myself wanting to do some analysis on all of our DNS entires stored in AWS&rsquo;s Route53 for security reasons (specifically to prevent subdomain takeover attacks, I&rsquo;ll probably write that up soon). In doing so, I realized that while Route53 has the ability to import a <a href=https://en.wikipedia.org/wiki/zone%20file>zone file</a>, it&rsquo;s not possible to export one.</p><p>To some extent, this makes sense. Since Route53 supports ALIAS records (which can automatically determine their values based on other AWS products, such as an ELB changing its public IP) and those aren&rsquo;t actually &lsquo;real&rsquo; DNS entries, things will get confused. But I don&rsquo;t currently intend to re-import these zone files, just use them. So let&rsquo;s see what we can do.</p><p><a href=/2018/03/12/generating-zone-files-from-route53/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2017/12/18/ssh-config-proxycommand-tricks/ class=clearfix>SSH Config ProxyCommand Tricks</a></h1><div class=entry-meta><span class=entry-date>2017-12-18</span></div></header><div class=entry-content><p>Working in security/operations in the tech industry, I use <a href=https://en.wikipedia.org/wiki/SSH>SSH</a> a lot. To various different machines (some with hostnames, some without), using various different users and keys, and often (as was the case in my <a href=https://blog.jverkamp.com/2017/12/13/dynamic-automatic-proxies/>previous post</a>) via a <a href=https://en.wikipedia.org/wiki/bastion%20host>bastion host</a>. Over the years, I&rsquo;ve collected a number of SSH tricks that make my life easier.</p><p><a href=/2017/12/18/ssh-config-proxycommand-tricks/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2017/11/15/clock-drift-in-docker-containers/ class=clearfix>Clock drift in Docker containers</a></h1><div class=entry-meta><span class=entry-date>2017-11-15</span></div></header><div class=entry-content><p>I was working on a docker container which uses the aws cli to mess around with some autoscaling groups when I got a somewhat strange error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>A client error <span style=color:#f92672>(</span>SignatureDoesNotMatch<span style=color:#f92672>)</span> occurred when calling the DescribeAutoScalingGroups operation: Signature not yet current: 20171115T012426Z is still later than 20171115T012420Z <span style=color:#f92672>(</span>20171115T011920Z + <span style=color:#ae81ff>5</span> min.<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Hmm.</p><p>Are the clocks off?</p><p><a href=/2017/11/15/clock-drift-in-docker-containers/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2015/10/30/finding-ec2-instances-by-tag/ class=clearfix>Finding EC2 instances by tag</a></h1><div class=entry-meta><span class=entry-date>2015-10-30</span></div></header><div class=entry-content><p>Another script similar to my previous post about <a href=https://blog.jverkamp.com/2015/07/22/finding-aws-iam-users-by-access-key/>Finding AWS IAM users by access key</a>. This time, we want to do much the same thing for EC2 instances by tag.</p><p><a href=/2015/10/30/finding-ec2-instances-by-tag/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2015/07/22/finding-aws-iam-users-by-access-key/ class=clearfix>Finding AWS IAM users by access key</a></h1><div class=entry-meta><span class=entry-date>2015-07-22</span></div></header><div class=entry-content><p>Every once in a while<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, I find myself with an <a href=https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSGettingStartedGuide/AWSCredentials.html>AWS access key</a> and need to figure out who in the world it belongs to. Unfortunately, so far as I&rsquo;ve been able to find, there&rsquo;s no way to directly do this in either the <a href=https://aws.amazon.com/console/>AWS console</a> or with the <a href=https://aws.amazon.com/cli/>AWS api</a>.</p><p><a href=/2015/07/22/finding-aws-iam-users-by-access-key/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2015/07/20/configuring-websockets-behind-an-aws-elb/ class=clearfix>Configuring Websockets behind an AWS ELB</a></h1><div class=entry-meta><span class=entry-date>2015-07-20</span></div></header><div class=entry-content><p>Recently at work, we were trying to get an application that uses <a href=https://en.wikipedia.org/wiki/websockets>websockets</a> working on an <a href=https://aws.amazon.com/>AWS</a> instance behind an <a href=https://aws.amazon.com/elasticloadbalancing/>ELB (load balancer)</a> and <a href=http://nginx.org/>nginx</a> on the instance.</p><p>If you&rsquo;re either not using a secure connection or handling the cryptography on the instance (either in nginx or Flask), it works right out of the box. But if you want the ELB to handle TLS termination it doesn&rsquo;t work nearly as well&mldr; Luckily, after a bit of fiddling, I got it working.</p><p><strong>Update 2018-05-31:</strong> A much easier solution, [https://aws.amazon.com/blogs/aws/new-aws-application-load-balancer/](just use an ALB):</p><blockquote><p><strong>WebSocket</strong> allows you to set up long-standing TCP connections between your client and your server. This is a more efficient alternative to the old-school method which involved HTTP connections that were held open with a “heartbeat” for very long periods of time. WebSocket is great for mobile devices and can be used to deliver stock quotes, sports scores, and other dynamic data while minimizing power consumption. ALB provides native support for WebSocket via the <code>ws://</code> and <code>wss://</code> protocols.</p></blockquote><p><a href=/2015/07/20/configuring-websockets-behind-an-aws-elb/>read more...</a></p></div><hr></article><nav id=pagination-navigation role=navigation><ul class="pagination pagination-default"><li class="page-item disabled"><a aria-disabled=true aria-label=First class=page-link role=button tabindex=-1><span aria-hidden=true>&#171;&#171;</span></a></li><li class="page-item disabled"><a aria-disabled=true aria-label=Previous class=page-link role=button tabindex=-1><span aria-hidden=true>&#171;</span></a></li><li class="page-item active"><a aria-current=page aria-label="Page 1" class=page-link role=button>1</a></li><li class=page-item><a href=/programming/topics/aws/page/2/ aria-label="Page 2" class=page-link role=button>2</a></li><li class=page-item><a href=/programming/topics/aws/page/2/ aria-label=Next class=page-link role=button><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/programming/topics/aws/page/2/ aria-label=Last class=page-link role=button><span aria-hidden=true>&#187;&#187;</span></a></li></ul></nav></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/topics/atom.xml>RSS: programming/topics<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
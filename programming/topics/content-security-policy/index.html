<!doctype html><html><head><title>Programming, Topic:
Content Security Policy - jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.ef050764ff69f3287c89ff655825479dd8304dcd9bc653d1ddd4772a701ad445.js integrity="sha256-7wUHZP9p8yh8if9lWCVHndgwTc2bxlPR3dR3KnAa1EU=" defer></script><script src=/katex_17296078054267651618.min.deed0e78a77391517d530a00324ce7b760ac204134992ef22d36f583615ae498.js integrity="sha256-3u0OeKdzkVF9UwoAMkznt2CsIEE0mS7yLTb1g2Fa5Jg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.bfe50b47c0387e3c3bf97ec5f338bba94f7ccb02f962a4aec8cf0b4d68c8434d.js integrity="sha256-v+ULR8A4fjw7+X7F8zi7qU98ywL5YqSuyM8LTWjIQ00=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.64e42891d651aee0b8cd02ec9227ff271d37bcf06dae985d1acf0eba1623e850.css integrity="sha256-ZOQokdZRruC4zQLskif/Jx03vPBtrphdGs8OuhYj6FA="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.0d2b289fa3451447692959fcee5676b846532fe7ab50ddc4660824c42d4adcd7.css integrity="sha256-DSson6NFFEdpKVn87lZ2uEZTL+erUN3EZggkxC1K3Nc="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.67505d77381ebd82623ab9296c1989c44ec828d867c00296e80e52ef860cac37.css integrity="sha256-Z1BddzgevYJiOrkpbBmJxE7IKNhnwAKW6A5S74YMrDc="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.b60cba31b8c292392a2d336408f8f344e261df78516eb17bcf029173b24a42b5.css integrity="sha256-tgy6MbjCkjkqLTNkCPjzROJh33hRbrF7zwKRc7JKQrU="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/home-automation/>Home Automation</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><h1 class=entry-title data-pagefind-meta=title>Programming, Topic:
Content Security Policy</h1><div class=entry-content></div><h2>All posts</h2><ul><li><span class=entry-date>2025-07-25</span>:
<a href=https://blog.jverkamp.com/2025/07/25/using-csp-unsafe-hashes/>Using CSP unsafe-hashes</a></li><li><span class=entry-date>2025-02-19</span>:
<a href=https://blog.jverkamp.com/2025/02/19/a-quick-mitmproxy-setup/>A quick mitmproxy setup</a></li></ul><h2>Recent posts</h2><div class=post-list><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2025/07/25/using-csp-unsafe-hashes/ class=clearfix>Using CSP unsafe-hashes</a></h1><div class=entry-meta><span class=entry-date>2025-07-25</span></div></header><div class=entry-content><p>So here&rsquo;s a fun one: how does the <code>unsafe-hashes</code> directive in a <a href=https://en.wikipedia.org/wiki/content%20security%20police>content security police</a> work?</p><p>In a perfect world, you don&rsquo;t need it. You can write a CSP with a minimal <code>script-src</code> policy, including only scripts from your own domains (<code>self</code>) or a list of specific other scripts or at worst domains.</p><p>But sometimes real life (and third party libraries) get in the way.</p><p>It starts with inline scripts. So you have to add <code>unsafe-inline</code>. But there&rsquo;s a better way to do that: CSP nonces. Specify a randomly generated (per request) nonce in the CSP header and then apply that same nonce to every <code>script</code> tag. Voila. Better.</p><h2 id=the-problem-inline-javascript-events>The problem: inline JavaScript events</h2><p>But what about something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;doSomething();&#34;</span>&gt;
</span></span></code></pre></div><p>Well, you might say, don&rsquo;t do that. Write it as a script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;doSomethinger&#34;</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>nonce</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;correctHorseBatteryStable&#34;</span>&gt;
</span></span><span style=display:flex><span>document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;doSomethinger&#34;</span>).<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;click&#34;</span>, <span style=color:#66d9ef>function</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>doSomething</span>();
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>But like I said&ndash;third parties scripts can be imperfect. And sometimes, they just <em>insist</em> on embedding their own event handlers inline.</p><h2 id=a-solution-unsafe-hashes>A solution: <code>unsafe-hashes</code></h2><p>Enter: <code>unsafe-hashes</code>.</p><p>Basically, you can add this to your CSP:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>script-src &#39;unsafe-hashes&#39; &#39;sha256-44558f2c36efd8163eac2903cec13ed1fafcca51abd91d9f696321ab895f1107&#39;
</span></span></code></pre></div><p>This tells the browser that you <em>are</em> allowed to have event listeners directly on HTML elements&mldr; so long as the content of the JavaScript hashes <em>exactly</em> to any hash listed as an <code>unsafe-hash</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo -n <span style=color:#e6db74>&#34;doSomething();&#34;</span> | sha256
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>44558f2c36efd8163eac2903cec13ed1fafcca51abd91d9f696321ab895f1107
</span></span></code></pre></div><h2 id=it-gets-worse-dynamically-generated-javascript>It gets worse: dynamically generated JavaScript</h2><p>There is, however, one problem with this that does come up unfortunately often. If you&rsquo;re already dealing with third parties not doing things you wish they would, well then you have to deal with fun code like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span> ($buttonIds <span style=color:#66d9ef>as</span> $buttonId) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;&lt;button onclick=&#34;doSomething(&#39;</span> <span style=color:#f92672>.</span> $buttonId <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;);&#34;&gt;Button &#39;</span> <span style=color:#f92672>.</span> $buttonId <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;&lt;/button&gt;&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Unfortunately&mldr; that completely blows up the CSP. Because&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo -n <span style=color:#e6db74>&#34;doSomething(1);&#34;</span> | sha256
</span></span><span style=display:flex><span>2ef899c15aae95711855a45a5bb93c55363162e0e75e295aad4f189f20323d7c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ echo -n <span style=color:#e6db74>&#34;doSomething(5);&#34;</span> | sha256
</span></span><span style=display:flex><span>0e03bb385169b89c95eb62659f50604ffb8283154bd58ab8cc7e692c4b5c05a3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ echo -n <span style=color:#e6db74>&#34;doSomething(42);&#34;</span> | sha256
</span></span><span style=display:flex><span>4d9691449db6740ee19207c5bb52361eb97e18f06352ed400f83ae7caee270da
</span></span></code></pre></div><p>Just hashes doing hash things there. So basically, you have to be able to dynamically generate your CSP on the fly, including all of the hashes of all of the functions <em>and with each of their arguments</em> that are either possible or (even better) actually used.</p><p>And this isn&rsquo;t fun at all.</p><p>Now, you might say: but you can do something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span> ($buttonIds <span style=color:#66d9ef>as</span> $buttonId) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;&lt;button data-id=&#34;$buttonId&#34; onclick=&#34;doSomething(this.dataset.id);&#34;&gt;&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>After all</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo -n <span style=color:#e6db74>&#34;doSomething(this.dataset.id);&#34;</span> | sha256
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>d2ecabb98b1bb7cc81cd75d43dcb7bac08ce31055339920976cb92aa2f5dd2f5
</span></span></code></pre></div><p>Only one hash!</p><p>But if you have that much control&mldr; then why are you using inline JavaScript in the first place?</p><h2 id=is-it-safe>Is it safe?</h2><p>Is this safe?</p><p>No. It&rsquo;s called <code>unsafe-*</code> for a reason. An attacker that controls input can theoretically take any of the hashed functions you&rsquo;re including (like <code>submitPayment</code>&mldr;) and inject them in places they shouldn&rsquo;t be. And heck, if you manage to find a SHA-256 hash collision? Well, then you have far more interesting things to do with <em>that</em> then attacking some site that found themselves force to used <code>unsafe-hashes</code>&mldr;</p><p><em>But</em> it&rsquo;s better than <code>unsafe-inline</code> without <code>nonces</code> which allows arbitrary inline scripts. And unfortunately, there&rsquo;s no way to actually use <code>nonces</code> with inline scripts.</p><p>And while a perfectly secure system would be the best case, it&rsquo;s absolutely better to do as much as you can to secure a system rather than doing nothing waiting for the perfect solution to become possible.</p><p>Onward!</p><p><a href=/2025/07/25/using-csp-unsafe-hashes/>read more...</a></p></div><hr></article><article class=li><header><h1 class=entry-title><a href=https://blog.jverkamp.com/2025/02/19/a-quick-mitmproxy-setup/ class=clearfix>A quick mitmproxy setup</a></h1><div class=entry-meta><span class=entry-date>2025-02-19</span></div></header><div class=entry-content><p>Another quick thing that I set up for the first time in a <em>long</em> time. It&rsquo;s honestly as much a note for myself as anything, but perhaps you&rsquo;ll find it useful too.</p><p>The problem: We were having intermittent issues with a <a href=https://en.wikipedia.org/wiki/content%20security%20policy>content security policy</a>. One of the warnings that cropped up was the inclusion of <code>'inline-speculation-rules'</code> in the policy. This is currently only supported in Chrome and the issue was only appearing in Firefox. I could of course go through the effort of removing the header locally and testing&ndash;but what if I could lie to the browser and change the header on the fly?</p><p>Well, for that, you have a number of options. <a href=https://portswigger.net/burp target=_blank rel=noopener>Burp Suite</a>, <a href=https://www.zaproxy.org/ target=_blank rel=noopener>ZAP</a>, <a href=https://www.charlesproxy.com/ target=_blank rel=noopener>Charles Proxy</a>. Many more, I&rsquo;m sure. Any of these can modify traffic on the fly like that, but they&rsquo;ll all designed for <em>so much more</em> than that, making them a bit unwieldy. What I really wanted was something that was a whole lot smaller and did only this one thing (or could be at least configured as such)</p><p>Enter <a href=https://mitmproxy.org/ target=_blank rel=noopener><code>mitmproxy</code></a>. I&rsquo;ve used it before, but never quite like this. As the name suggests, <code>mitmproxy</code> is designed to <a href=https://en.wikipedia.org/wiki/man-in-the-middle>man-in-the-middle</a> yourself as a proxy&ndash;feed all web requests through it and it can read requests, modify and forward (or block them), read responses, modify or replace them entirely, and all so much more.</p><p>Exactly what I needed!</p><p><a href=/2025/02/19/a-quick-mitmproxy-setup/>read more...</a></p></div></article></div><nav id=pagination-navigation role=navigation></nav></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!doctype html><html><head><title>AoC 2017 Day 23: Duetvmc â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_6894410585563545744.min.cc1cade18c999752b7befe111634889dca8d89b24923775954ecebc68c54fcd3.js integrity="sha256-zByt4YyZl1K3vv4RFjSIncqNibJJI3dZVOzrxoxU/NM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/custom.min.9bb1a6d1e0b58ced38df246e4479317e4561461cfabab31b36fbc36035186214.js integrity="sha256-m7Gm0eC1jO043yRuRHkxfkVhRhz6urMbNvvDYDUYYhQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="><link rel=stylesheet href=/custom.min.3bcba67844fc4a76aa7c1947a1fcf14cddaf8e9e0f1e734fde0fa219416f058d.css integrity="sha256-O8umeET8SnaqfBlHofzxTN2vjp4PHnNP3g+iGUFvBY0="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>AoC 2017 Day 23: Duetvmc</h1><div class=entry-meta><span class=entry-date>2017-12-23</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/12/22/aoc-2017-day-22-langtons-ant/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2017/12/24/aoc-2017-day-24-maker-of-bridges/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/12/22/aoc-2017-day-22-langtons-ant/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/advent-of-code>Advent of Code</a><a href=https://blog.jverkamp.com/2017/12/24/aoc-2017-day-24-maker-of-bridges/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2013/08/22/tiny-turing-completeness-without-mmov/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/compilers>Compilers</a><a href=https://blog.jverkamp.com/2023/01/12/writing-a-curry-macro-for-macrokata/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/12/22/aoc-2017-day-22-langtons-ant/ class=previous-link></a><a class=taxonomy-value href=/series/advent-of-code-2017>Advent of Code 2017</a><a href=https://blog.jverkamp.com/2017/12/24/aoc-2017-day-24-maker-of-bridges/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2017/12/22/aoc-2017-day-22-langtons-ant/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2017/12/24/aoc-2017-day-24-maker-of-bridges/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2017/12/22/aoc-2017-day-22-langtons-ant/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2017/12/24/aoc-2017-day-24-maker-of-bridges/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><h3 id=source-coprocessor-conflagrationhttpadventofcodecom2017day23>Source: <a href=http://adventofcode.com/2017/day/23>Coprocessor Conflagration</a></h3><blockquote><p><strong>Part 1:</strong> Create a variation of the <a href=https://blog.jverkamp.com/2017/12/18/aoc-2017-day-18-duetvm/>previous DuetVM</a> with only the following four instructions:</p></blockquote><blockquote><ul><li><code>set X Y</code> sets register <code>X</code> to <code>Y</code></li><li><code>sub X Y</code> set register <code>X</code> to <code>X - Y</code></li><li><code>mul X Y</code> sets register <code>X</code> to <code>X * Y</code></li><li><code>jnz X Y</code> jumps with an offset of the value of <code>Y</code>, iff <code>X</code> is not equal to zero</li></ul></blockquote><blockquote><p>If you run the given program, how many times is <code>mul</code> invoked?</p></blockquote><p>Interesting.</p><p>We could definitely use the same code as <a href=https://blog.jverkamp.com/2017/12/18/aoc-2017-day-18-duetvm/>before</a>, implementing the instructions as such:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set</span>(vm, x, y):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>=</span> vm<span style=color:#f92672>.</span>value(y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sub</span>(vm, x, y):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>-=</span> vm<span style=color:#f92672>.</span>value(y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>mul</span>(vm, x, y):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>mul_count <span style=color:#f92672>=</span> getattr(vm, <span style=color:#e6db74>&#39;mul_count&#39;</span>, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>*=</span> vm<span style=color:#f92672>.</span>value(y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>jnz</span>(vm, x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> vm<span style=color:#f92672>.</span>value(x) <span style=color:#960050;background-color:#1e0010>!</span><span style=color:#f92672>-</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        vm<span style=color:#f92672>.</span>pc <span style=color:#f92672>+=</span> vm<span style=color:#f92672>.</span>value(y) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Just print out <code>vm.mul_count</code> at the end and we&rsquo;re good. But where&rsquo;s the fun in that?</p><p>Instead, let&rsquo;s implement a <a href=https://en.wikipedia.org/wiki/compiler>compiler</a> to turn DuetVM code into Python. ðŸ˜‡ It&rsquo;s probably a bad idea, but we&rsquo;re just going to use a series of <a href=https://en.wikipedia.org/wiki/regular%20expressions>regular expressions</a> that will match the input program and rewrite sections one step at a time. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@compile_step</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rewrite_simple_binops</span>(code):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Rewrite simple binary ops that have a direct python equivalent.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> name, symbol <span style=color:#f92672>in</span> [(<span style=color:#e6db74>&#39;set&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>), (<span style=color:#e6db74>&#39;sub&#39;</span>, <span style=color:#e6db74>&#39;-&#39;</span>), (<span style=color:#e6db74>&#39;mul&#39;</span>, <span style=color:#e6db74>&#39;*&#39;</span>)]:
</span></span><span style=display:flex><span>        code <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> ([a-h]) ([a-h]|-?\d+)&#39;</span><span style=color:#f92672>.</span>format(name),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;\1 </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>= \2&#39;</span><span style=color:#f92672>.</span>format(symbol),
</span></span><span style=display:flex><span>            code
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> code
</span></span></code></pre></div><p>This will take any of the three basic commands and directly rewrite them as the Python equiavlent. <code>set X Y</code> becomes <code>X = Y</code>, <code>sub X Y</code> becomes <code>X -= Y</code> (and the same for <code>mul</code>). Easy enough.</p><p><code>compile_step</code> is a decorator which essentially stores the step to be used later:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>compilation_steps <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>compile_step</span>(f):
</span></span><span style=display:flex><span>    functools<span style=color:#f92672>.</span>wraps(f)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new_f</span>(code):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> f(code)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    compilation_steps<span style=color:#f92672>.</span>append(new_f)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> f
</span></span></code></pre></div><p>Next, we want to get rid of the relative jumps. First, Python doesn&rsquo;t have relative jumps (well, it doesn&rsquo;t have direct jumps at all, we&rsquo;ll get to that), and second as we rewrite code, the relative jumps will change. So let&rsquo;s make them absolute jumps instead, specified (for now) by comments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@compile_step</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rewrite_jumps_as_absolute</span>(code):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Rewrite jumps in an absolute form with a label at the destination.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    labels <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    lines <span style=color:#f92672>=</span> code<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> index, line <span style=color:#f92672>in</span> enumerate(lines):
</span></span><span style=display:flex><span>        m <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>match(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;jnz ([a-h]|-?\d+) (-?\d+)&#39;</span>, line)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> m:
</span></span><span style=display:flex><span>            register, offset <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span>groups()
</span></span><span style=display:flex><span>            offset <span style=color:#f92672>=</span> int(offset)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&lt;=</span> index <span style=color:#f92672>+</span> offset <span style=color:#f92672>&lt;</span> len(lines):
</span></span><span style=display:flex><span>                label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;L</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(len(labels))
</span></span><span style=display:flex><span>                labels[label] <span style=color:#f92672>=</span> index <span style=color:#f92672>+</span> offset
</span></span><span style=display:flex><span>                lines[index] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;jnz </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(register, label)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># Out of bounds jumps will instead compile into a `halt` (stop execution)</span>
</span></span><span style=display:flex><span>                lines[index] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;sys.exit(0)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> label, index <span style=color:#f92672>in</span> labels<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        lines[index] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;# </span><span style=color:#e6db74>{}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(label, lines[index])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(lines)
</span></span></code></pre></div><p>As an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> code <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set a 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set b 3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... jnz a 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... add a b
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... mul a b
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(rewrite_jumps_as_absolute(code))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set a <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>set b <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>jnz a L0
</span></span><span style=display:flex><span>add a b
</span></span><span style=display:flex><span><span style=color:#75715e># L0</span>
</span></span><span style=display:flex><span>mul a b
</span></span></code></pre></div><p>It&rsquo;s no longer either DuetVM code or Python, but rather something in between. In an optimal case, it would be best if every stage of the compiler were runnable so that we can test that the functionality of each step is exactly the same, but that&rsquo;s just not something I&rsquo;m going to do this time around.</p><p>Next, we he have a few different possible styles of jumps. The easiest two are jumps that don&rsquo;t overlap any other jumps, going either forward or backwards. For the case of a jump going forward, it&rsquo;s basically an <code>if</code> statement:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rewrite_simple_if</span>(code):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Rewrite non-nested foward jumps as simple ifs.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_if</span>(m):
</span></span><span style=display:flex><span>        indentation, register, label, body <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span>groups()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>if </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> == 0:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(
</span></span><span style=display:flex><span>            indentation,
</span></span><span style=display:flex><span>            register,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;    &#39;</span> <span style=color:#f92672>+</span> line <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> body<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> re<span style=color:#f92672>.</span>sub(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(\s*)jnz ([a-h]|-?\d+) (L\d+)\n((?!jnz|# L).*)\n\1# \3&#39;</span>,
</span></span><span style=display:flex><span>        make_if,
</span></span><span style=display:flex><span>        code,
</span></span><span style=display:flex><span>        flags <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>DOTALL
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><p>The regular expressions get a bit complicated here sadly, but they&rsquo;re still more or or less readable:</p><table><thead><tr><th>Part</th><th>Group</th><th>Description</th></tr></thead><tbody><tr><td><code>(\s*)</code></td><td><code>\1</code> is indentation</td><td>Start by matching whitespace, this is the current indentation (nested <code>if</code> statements)</td></tr><tr><td><code>jnz ([a-h]|-?\d+) (L\d+)</code></td><td><code>\2</code> is the conditional, <code>\3</code> is the label</td><td>Match the forward jump, storing the conditional and label</td></tr><tr><td><code>\n</code></td><td></td><td>Start the block</td></tr><tr><td><code>((?!jnz|# L).*)</code></td><td></td><td>Match any content so long as you do not see either <code>jnz</code> instructions or a <code># L</code> label comment; nested <code>if</code>s are fine</td></tr><tr><td><code>\n</code></td><td></td><td>Finish the block</td></tr><tr><td><code>\1# \3</code></td><td></td><td>Match the closing label comment. It has the same indentation and label as the <code>jnz</code> instruction</td></tr></tbody></table><p>When we rewrite that, we want to generate the condition <code>if {register} == 0:</code> and then intent each line in the block by an additional four spaces. So if we apply this to the code we had earlier:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> code <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set a 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set b 3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... jnz a 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... add a b
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... mul a b
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(rewrite_simple_if(rewrite_jumps_as_absolute(code)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set a <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>set b <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> a <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    add a b
</span></span><span style=display:flex><span>mul a b
</span></span></code></pre></div><p>Next up, let&rsquo;s rewrite non-overlapping backward loops.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rewrite_simple_while</span>(code):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Rewrite non-nested backward jumps as while loops with a flag.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_while</span>(m):
</span></span><span style=display:flex><span>            indentation, label, body, register <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span>groups()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>{indentation}</span><span style=color:#e6db74># </span><span style=color:#e6db74>{label}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{indentation}</span><span style=color:#e6db74>while True:
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{body}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{indentation}</span><span style=color:#e6db74>    if </span><span style=color:#e6db74>{register}</span><span style=color:#e6db74> == 0: break</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#f92672>.</span>format(
</span></span><span style=display:flex><span>    indentation <span style=color:#f92672>=</span> indentation,
</span></span><span style=display:flex><span>    register <span style=color:#f92672>=</span> register,
</span></span><span style=display:flex><span>    label <span style=color:#f92672>=</span> label,
</span></span><span style=display:flex><span>    body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;    &#39;</span> <span style=color:#f92672>+</span> line <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> body<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> re<span style=color:#f92672>.</span>sub(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(\s*)# (L\d+)\n((?!jnz|# L).*)\n\1jnz ([a-h]|-?\d+) \2&#39;</span>,
</span></span><span style=display:flex><span>            make_while,
</span></span><span style=display:flex><span>            code,
</span></span><span style=display:flex><span>            flags <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>DOTALL
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><p>This one is a bit more complicated, since we want the code to run at least one time. If only we had a <code>do while</code> loop. But instead, all we have to do is make it <code>while True</code> and put the actual conditional and a <code>break</code> at the end of the loop.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(rewrite_jumps_as_absolute(code))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set a <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>set b <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># L0</span>
</span></span><span style=display:flex><span>add a b
</span></span><span style=display:flex><span>sub b <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>jnz b L0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(rewrite_jumps(rewrite_jumps_as_absolute(code)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set a <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>set b <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># L0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    add a b
</span></span><span style=display:flex><span>    sub b <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> b <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>Finally, let&rsquo;s rewrite one simple case that we have in our actual example code, and <code>if-not</code>. Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>jnz a 2
</span></span><span style=display:flex><span>jnz 1 5
</span></span><span style=display:flex><span>mul b 100
</span></span><span style=display:flex><span>sub b -100000
</span></span><span style=display:flex><span>set c b
</span></span><span style=display:flex><span>sub c -17000
</span></span><span style=display:flex><span>set f 1
</span></span></code></pre></div><p>How to read that is if <code>a != 0</code>, we want to skip the second jump and run the rest of the code. If <code>a == 0</code>, then we hit the second jump and always skip over five instructions (<code>1 != 0</code> is always true). Logically, that means that if <code>a != 0</code>, we&rsquo;ll run the instructions but if <code>a == 2</code>, we will not. So we can rewrite that as so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rewrite_if_not</span>(code):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Rewrite an overlapping pair of forward jumps as if/else.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_if_not</span>(m):
</span></span><span style=display:flex><span>        indentation, register, label_1, label_2, body <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span>groups()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>{indentation}</span><span style=color:#e6db74>if </span><span style=color:#e6db74>{register}</span><span style=color:#e6db74> != 0:
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{body}</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#f92672>.</span>format(
</span></span><span style=display:flex><span>indentation <span style=color:#f92672>=</span> indentation,
</span></span><span style=display:flex><span>register <span style=color:#f92672>=</span> register,
</span></span><span style=display:flex><span>body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;    &#39;</span> <span style=color:#f92672>+</span> line <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> body<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> re<span style=color:#f92672>.</span>sub(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(\s*)jnz ([a-h]) (L\d+)\n\1jnz (?!0)-?\d+ (L\d+)\n\1# \3\n((?!jnz|# L).*)\n\1# \4&#39;</span>,
</span></span><span style=display:flex><span>        make_if_not,
</span></span><span style=display:flex><span>        code,
</span></span><span style=display:flex><span>        flags <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>DOTALL
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><p>It&rsquo;s similar to the <code>if</code> statements, but the regular expression is a bit more complicated, since we&rsquo;re matching two back to back jumps and have to have two closing labels. In practice:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> code <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set a 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set b 3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... jnz a 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... jnz 1 5
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... mul b 100
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... sub b -100000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set c b
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... sub c -17000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... set f 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>... &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(rewrite_jumps(rewrite_jumps_as_absolute(code)))
</span></span><span style=display:flex><span>set a <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>set b <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> a <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    mul b <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    sub b <span style=color:#f92672>-</span><span style=color:#ae81ff>100000</span>
</span></span><span style=display:flex><span>    set c b
</span></span><span style=display:flex><span>    sub c <span style=color:#f92672>-</span><span style=color:#ae81ff>17000</span>
</span></span><span style=display:flex><span>set f <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>That&rsquo;s pretty neat.</p><p>One last thing we want to do is deal with potentially nested if statements. To do that, we just want to run the above three functions over and over again until the current code stops changing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@compile_step</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rewrite_jumps</span>(code):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Using the previous step, rewrite jumps.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Keep running these functions until we reach a stable state</span>
</span></span><span style=display:flex><span>    functions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        rewrite_simple_if,
</span></span><span style=display:flex><span>        rewrite_if_not,
</span></span><span style=display:flex><span>        rewrite_simple_while,
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        new_code <span style=color:#f92672>=</span> code
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> f <span style=color:#f92672>in</span> functions:
</span></span><span style=display:flex><span>            new_code <span style=color:#f92672>=</span> f(new_code)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> code <span style=color:#f92672>==</span> new_code:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            code <span style=color:#f92672>=</span> new_code
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> code
</span></span></code></pre></div><p>That&rsquo;s actually enough to make runnable Python code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># BASH$ cat input.txt
</span></span><span style=display:flex><span>set b 65
</span></span><span style=display:flex><span>set c b
</span></span><span style=display:flex><span>jnz a 2
</span></span><span style=display:flex><span>jnz 1 5
</span></span><span style=display:flex><span>mul b 100
</span></span><span style=display:flex><span>sub b -100000
</span></span><span style=display:flex><span>set c b
</span></span><span style=display:flex><span>sub c -17000
</span></span><span style=display:flex><span>set f 1
</span></span><span style=display:flex><span>set d 2
</span></span><span style=display:flex><span>set e 2
</span></span><span style=display:flex><span>set g d
</span></span><span style=display:flex><span>mul g e
</span></span><span style=display:flex><span>sub g b
</span></span><span style=display:flex><span>jnz g 2
</span></span><span style=display:flex><span>set f 0
</span></span><span style=display:flex><span>sub e -1
</span></span><span style=display:flex><span>set g e
</span></span><span style=display:flex><span>sub g b
</span></span><span style=display:flex><span>jnz g -8
</span></span><span style=display:flex><span>sub d -1
</span></span><span style=display:flex><span>set g d
</span></span><span style=display:flex><span>sub g b
</span></span><span style=display:flex><span>jnz g -13
</span></span><span style=display:flex><span>jnz f 2
</span></span><span style=display:flex><span>sub h -1
</span></span><span style=display:flex><span>set g b
</span></span><span style=display:flex><span>sub g c
</span></span><span style=display:flex><span>jnz g 2
</span></span><span style=display:flex><span>jnz 1 3
</span></span><span style=display:flex><span>sub b -17
</span></span><span style=display:flex><span>jnz 1 -23
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># BASH$ python3 duetvmc.py input.txt</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Final code:</span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> <span style=color:#ae81ff>65</span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> a <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    mul_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>; b <span style=color:#f92672>*=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    b <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>100000</span>
</span></span><span style=display:flex><span>    c <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span>    c <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>17000</span>
</span></span><span style=display:flex><span><span style=color:#75715e># L7</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    d <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># L4</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        e <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># L3</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            g <span style=color:#f92672>=</span> d
</span></span><span style=display:flex><span>            g <span style=color:#f92672>*=</span> e
</span></span><span style=display:flex><span>            g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                f <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            e <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            g <span style=color:#f92672>=</span> e
</span></span><span style=display:flex><span>            g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        d <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        g <span style=color:#f92672>=</span> d
</span></span><span style=display:flex><span>        g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> f <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        h <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    g <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span>    g <span style=color:#f92672>-=</span> c
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    b <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>Okay. It&rsquo;s not quite done. We still need three more things:</p><ul><li>Initialize the registers</li><li>Import <code>sys</code> so we can run <code>sys.exit(0)</code> towards the end</li><li>Count <code>mul</code> instructions</li><li>Print the final value of that count, either if we <code>sys.exit(0)</code> or reach the end of the program</li></ul><p>To do that, we can add two more compile steps:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@compile_step</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_debug_statements</span>(code):
</span></span><span style=display:flex><span>    code <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;([a-h]) \*=&#39;</span>, <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;mul_count += 1; \1 *=&#39;</span>, code)
</span></span><span style=display:flex><span>    code <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;sys.exit&#39;</span>, <span style=color:#e6db74>&#39;print(mul_count); sys.exit&#39;</span>, code)
</span></span><span style=display:flex><span>    code <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;mul_count = 0</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> code <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>print(mul_count)&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> code
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@compile_step</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_initial_registers</span>(code):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;a = b = c = d = e = f = g = h = 0</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> code
</span></span></code></pre></div><p>That leaves our actual final code as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Final code:</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> b <span style=color:#f92672>=</span> c <span style=color:#f92672>=</span> d <span style=color:#f92672>=</span> e <span style=color:#f92672>=</span> f <span style=color:#f92672>=</span> g <span style=color:#f92672>=</span> h <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>mul_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> <span style=color:#ae81ff>65</span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> a <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    mul_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>; b <span style=color:#f92672>*=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    b <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>100000</span>
</span></span><span style=display:flex><span>    c <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span>    c <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>17000</span>
</span></span><span style=display:flex><span><span style=color:#75715e># L7</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    d <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># L4</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        e <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># L3</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            g <span style=color:#f92672>=</span> d
</span></span><span style=display:flex><span>            mul_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>; g <span style=color:#f92672>*=</span> e
</span></span><span style=display:flex><span>            g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                f <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            e <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            g <span style=color:#f92672>=</span> e
</span></span><span style=display:flex><span>            g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        d <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        g <span style=color:#f92672>=</span> d
</span></span><span style=display:flex><span>        g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> f <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        h <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    g <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span>    g <span style=color:#f92672>-=</span> c
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(mul_count); sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    b <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>print(mul_count)
</span></span></code></pre></div><p>Which we can directly run with the <code>python</code> executable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 duetvmc.py input.txt | python3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3969</span>
</span></span></code></pre></div><p>That&rsquo;s just cool.</p><blockquote><p><strong>Part 2:</strong> Set <code>a = 1</code>. What is the final value of <code>h</code>?</p></blockquote><p>Well. We could run the initial program again. That would work. The problem is that it would take a <strong>really</strong> long time to finish (I tried it).</p><p>We could do a bunch of additional optimizations to try to make the code run more quickly, but for this one case, I decided just to actually look at the code and try to figure it out myself. Specifically, everything after <code># L7</code> is something we need to optimize.</p><p>First, the innermost block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># L3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    g <span style=color:#f92672>=</span> d
</span></span><span style=display:flex><span>    mul_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>; g <span style=color:#f92672>*=</span> e
</span></span><span style=display:flex><span>    g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        f <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    e <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    g <span style=color:#f92672>=</span> e
</span></span><span style=display:flex><span>    g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>If you start at that for a while, you have a divisibility check. If <code>g</code> is an exact multiple of <code>e</code>, <code>f</code> will be set to <code>0</code>. Otherwise, <code>f</code> will be <code>1</code> (set in <code>L7</code>). So that loop is more or less equivalent to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> g <span style=color:#f92672>%</span> e <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Going out one layer, we have:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># L4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    e <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>%</span> e <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        f <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    d <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    g <span style=color:#f92672>=</span> d
</span></span><span style=display:flex><span>    g <span style=color:#f92672>-=</span> b
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>This is a loop from <code>2</code> up to <code>g</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> e <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>2</span>, g):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>%</span> e <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        f <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>And finally, one level more:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># L7</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    d <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> e <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>2</span>, g):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> g <span style=color:#f92672>%</span> e <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            f <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> f <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        h <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    g <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span>    g <span style=color:#f92672>-=</span> c
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(mul_count); sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    b <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>: <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>Two things to recognize here. First, this is another loop on <code>g</code> from <code>b</code> to <code>c</code> but with a step size of <code>17</code> (the <code>b -= 17</code> line). Also, we&rsquo;re reading from <code>f</code> here. If it&rsquo;s set, add one to <code>h</code>. Since we can never unset <code>f</code> back to one once it&rsquo;s zero, we can rewrite the inner loop as <code>h += 1</code> with a <code>break</code> as another speed boost. That gives us:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> g <span style=color:#f92672>in</span> range(b, c <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>17</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> e <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>2</span>, g):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> g <span style=color:#f92672>%</span> e <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            h <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>print(h)
</span></span></code></pre></div><p>That looks familiar. Essentially, it&rsquo;s doing the inverse of a <a href=https://en.wikipedia.org/wiki/primality%20test>primality test</a>. For each <code>g</code>, if <code>g</code> is a <a href=https://en.wikipedia.org/wiki/composite%20number>composite number</a>, add 1 to <code>h</code>. Adding this all as a hacky compiler step:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># HACK</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@compile_step</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>replace_with_composite_counter</span>(code):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>comment_out</span>(m):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;# &#39;</span> <span style=color:#f92672>+</span> line <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> m<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    code <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(# L7\n.*)&#39;</span>, comment_out, code, flags <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>DOTALL)
</span></span><span style=display:flex><span>    code <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Turns out the code is checking for composite numbers... very inefficiently
</span></span></span><span style=display:flex><span><span style=color:#e6db74># a != 0 sets up the range on b and c (note the off by one for c...)
</span></span></span><span style=display:flex><span><span style=color:#e6db74># The L7 loop is looping from b to c by 17 (the b -= -17 at the end)
</span></span></span><span style=display:flex><span><span style=color:#e6db74># The L4 loop is looping from 2 to g, setting f = 0 if g is divisible by the given numbers
</span></span></span><span style=display:flex><span><span style=color:#e6db74># - NOTE: The original loop doesn&#39;t bail out early, which helps speed up a fair bit
</span></span></span><span style=display:flex><span><span style=color:#e6db74># The L3 loop is doing the trial division ()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>for g in range(b, c + 1, 17):
</span></span></span><span style=display:flex><span><span style=color:#e6db74>for e in range(2, g):
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if g </span><span style=color:#e6db74>% e</span><span style=color:#e6db74> == 0:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        h += 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        break
</span></span></span><span style=display:flex><span><span style=color:#e6db74>print(h)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> code
</span></span></code></pre></div><p>Which gives us a final result of:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> python3 duetvmc<span style=color:#f92672>.</span>py input<span style=color:#f92672>.</span>txt <span style=color:#f92672>--</span>part <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Final code:</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> c <span style=color:#f92672>=</span> d <span style=color:#f92672>=</span> e <span style=color:#f92672>=</span> f <span style=color:#f92672>=</span> g <span style=color:#f92672>=</span> h <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> <span style=color:#ae81ff>65</span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> a <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    b <span style=color:#f92672>*=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    b <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>100000</span>
</span></span><span style=display:flex><span>    c <span style=color:#f92672>=</span> b
</span></span><span style=display:flex><span>    c <span style=color:#f92672>-=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>17000</span>
</span></span><span style=display:flex><span><span style=color:#75715e># # L7</span>
</span></span><span style=display:flex><span><span style=color:#75715e># while True:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     f = 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     d = 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     # L4</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     while True:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         e = 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         # L3</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         while True:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             g = d</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             g *= e</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             g -= b</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             if g == 0:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#                 f = 0</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             e -= -1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             g = e</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             g -= b</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#             if g == 0: break</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         d -= -1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         g = d</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         g -= b</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         if g == 0: break</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     if f == 0:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         h -= -1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     g = b</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     g -= c</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     if g == 0:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         sys.exit(0)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     b -= -17</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     if 1 == 0: break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Turns out the code is checking for composite numbers... very inefficiently</span>
</span></span><span style=display:flex><span><span style=color:#75715e># a != 0 sets up the range on b and c (note the off by one for c...)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The L7 loop is looping from b to c by 17 (the b -= -17 at the end)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The L4 loop is looping from 2 to g, setting f = 0 if g is divisible by the given numbers</span>
</span></span><span style=display:flex><span><span style=color:#75715e># - NOTE: The original loop doesn&#39;t bail out early, which helps speed up a fair bit</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The L3 loop is doing the trial division ()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> g <span style=color:#f92672>in</span> range(b, c <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>17</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> e <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>2</span>, g):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> g <span style=color:#f92672>%</span> e <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            h <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>print(h)
</span></span></code></pre></div><p>Which runs much more quickly (especially if we leverage <a href=https://pypy.org/>PyPy</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 run-all.py day-23
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>day-23  python3 duetvmc.py input.txt --part <span style=color:#ae81ff>1</span> | python3 0.10982990264892578     <span style=color:#ae81ff>3969</span>
</span></span><span style=display:flex><span>day-23  python3 duetvmc.py input.txt --part <span style=color:#ae81ff>2</span> | python3 1.5763399600982666      <span style=color:#ae81ff>917</span>
</span></span><span style=display:flex><span>day-23  python3 duetvmc.py input.txt --part <span style=color:#ae81ff>2</span> | pypy    0.42662978172302246     <span style=color:#ae81ff>917</span>
</span></span></code></pre></div><p>That was fun. I want to write a much bigger &lsquo;real&rsquo; compiler now.</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
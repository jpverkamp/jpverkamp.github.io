<!doctype html><html><head><title>AoC 2017 Day 18: Duetvm â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.1a5fbab1ecff843d4ee6e936243fb06066197cd8c9357883d791333ce6001f3b.css integrity="sha256-Gl+6sez/hD1O5uk2JD+wYGYZfNjJNXiD15EzPOYAHzs="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>AoC 2017 Day 18: Duetvm</h1><div class=entry-meta><span class=entry-date>2017-12-18</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/12/17/aoc-2017-day-17-spinlock/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2017/12/19/aoc-2017-day-19-networkout/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/12/17/aoc-2017-day-17-spinlock/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/advent-of-code>Advent of Code</a><a href=https://blog.jverkamp.com/2017/12/19/aoc-2017-day-19-networkout/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/12/16/aoc-2017-day-16-swing-your-partner/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/assemblers>Assemblers</a><a href=https://blog.jverkamp.com/2017/12/25/aoc-2017-day-25-turing/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2016/02/26/audiobooks-to-podcasts/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/audio>Audio</a><a href=https://blog.jverkamp.com/2023/02/10/genuary-2023.10-generative-music/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2013/11/12/making-music-part-3-making-noise/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/music>Music</a><a href=https://blog.jverkamp.com/2023/02/10/genuary-2023.10-generative-music/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2017/12/17/aoc-2017-day-17-spinlock/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/optimization>Optimization</a><a href=https://blog.jverkamp.com/2021/12/12/aoc-2021-day-12-submarine-spider/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2017/12/16/aoc-2017-day-16-swing-your-partner/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/virtual-machines>Virtual Machines</a><a href=https://blog.jverkamp.com/2017/12/25/aoc-2017-day-25-turing/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2017/12/14/aoc-2017-day-14-knot-hash-gridinator/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/visualization>Visualization</a><a href=https://blog.jverkamp.com/2017/12/20/aoc-2017-day-20-miniature-universe-simulator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2017/12/17/aoc-2017-day-17-spinlock/ class=previous-link></a><a class=taxonomy-value href=/series/advent-of-code-2017>Advent of Code 2017</a><a href=https://blog.jverkamp.com/2017/12/19/aoc-2017-day-19-networkout/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2017/12/18/ssh-config-proxycommand-tricks/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2017/12/19/aoc-2017-day-19-networkout/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2017/12/18/ssh-config-proxycommand-tricks/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2017/12/19/aoc-2017-day-19-networkout/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><h3 id=source-duethttpadventofcodecom2017day18>Source: <a href=http://adventofcode.com/2017/day/18>Duet</a></h3><blockquote><p><strong>Part 1:</strong> Create a virtual machine with the following instruction set:</p></blockquote><blockquote><ul><li><code>snd X</code> plays a sound with a frequency equal to the value of <code>X</code></li><li><code>set X Y</code> sets register <code>X</code> to <code>Y</code></li><li><code>add X Y</code> set register <code>X</code> to <code>X + Y</code></li><li><code>mul X Y</code> sets register <code>X</code> to <code>X * Y</code></li><li><code>mod X Y</code> sets register <code>X</code> to <code>X mod Y</code></li><li><code>rcv X</code> recovers the frequency of the last sound played, if <code>X</code> is not zero</li><li><code>jgz X Y</code> jumps with an offset of the value of <code>Y</code>, iff <code>X</code> is greater than zero</li></ul></blockquote><blockquote><p>In most cases, <code>X</code> and <code>Y</code> can be either an integer value or a register.</p></blockquote><blockquote><p>What is the value recovered by <code>rcv</code> the first time <code>X</code> is non-zero?</p></blockquote><p>Another <a href=https://en.wikipedia.org/wiki/virtual%20machine>virtual machine</a>! These are my favorite. ðŸ˜„</p><p>This time, assuming that we&rsquo;ll use it again<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, I&rsquo;m going to create an open class and use decorators to actually create the methods. It&rsquo;s a bit weird to do it this way, but it&rsquo;s nicely flexible:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VM</span>(object):
</span></span><span style=display:flex><span>    vms <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Initialize a VM.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>tick <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>pc <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>registers <span style=color:#f92672>=</span> collections<span style=color:#f92672>.</span>defaultdict(<span style=color:#66d9ef>lambda</span> : <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>output <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>messages <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span>Queue()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>id <span style=color:#f92672>=</span> len(VM<span style=color:#f92672>.</span>vms)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>registers[<span style=color:#e6db74>&#39;p&#39;</span>] <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>id
</span></span><span style=display:flex><span>        VM<span style=color:#f92672>.</span>vms<span style=color:#f92672>.</span>append(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ready&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>(f, name <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        setattr(VM, name <span style=color:#f92672>or</span> f<span style=color:#f92672>.</span>__name__, f)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>value</span>(self, key):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;If key is a number, return that number; if it&#39;s a register, return it&#39;s value.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        val <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>registers<span style=color:#f92672>.</span>get(key, key)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> int(val)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> val
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, code, daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Run the given code with the given VM.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> daemon:
</span></span><span style=display:flex><span>            t <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target <span style=color:#f92672>=</span> self, args <span style=color:#f92672>=</span> [code])
</span></span><span style=display:flex><span>            t<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> t
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;running&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&lt;=</span> self<span style=color:#f92672>.</span>pc <span style=color:#f92672>&lt;</span> len(code):
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>tick <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                cmd, <span style=color:#f92672>*</span>args <span style=color:#f92672>=</span> code[self<span style=color:#f92672>.</span>pc]
</span></span><span style=display:flex><span>                getattr(self, cmd)(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>pc <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;exited&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>output
</span></span></code></pre></div><p>There are a few bits that we don&rsquo;t need just yet (not until part 2). The important bits are the <code>register</code> function and the <code>__call__</code> function (specifically the <code>getattr</code> in the main loop).</p><p>In the <code>register</code> function, we have the ability to add attributes to the <code>VM</code> class that any objects created from it will have access to. So for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set</span>(vm, x, y):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>=</span> vm<span style=color:#f92672>.</span>value(y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(vm, x, y):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>+=</span> vm<span style=color:#f92672>.</span>value(y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>mul</span>(vm, x, y):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>*=</span> vm<span style=color:#f92672>.</span>value(y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>mod</span>(vm, x, y):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>%=</span> vm<span style=color:#f92672>.</span>value(y)
</span></span></code></pre></div><p>That means that if we have a <code>VM</code> object, we could theoretically call any of those methods on it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> vm <span style=color:#f92672>=</span> VM()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> vm<span style=color:#f92672>.</span>set(<span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> vm<span style=color:#f92672>.</span>set(<span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> vm<span style=color:#f92672>.</span>mul(<span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> dict(vm<span style=color:#f92672>.</span>registers)
</span></span><span style=display:flex><span>{<span style=color:#e6db74>&#39;p&#39;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;a&#39;</span>: <span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#39;b&#39;</span>: <span style=color:#ae81ff>5</span>}
</span></span></code></pre></div><p>Alternatively, implementing the <code>__call__</code> function in a class means that objects of that class can be called as if they were functions. In this case, I will run code provided to them this way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> vm <span style=color:#f92672>=</span> VM()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> vm([
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>     (<span style=color:#e6db74>&#39;set&#39;</span>, <span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>     (<span style=color:#e6db74>&#39;set&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>     (<span style=color:#e6db74>&#39;mul&#39;</span>, <span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>...</span> ])
</span></span><span style=display:flex><span>[]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> dict(vm<span style=color:#f92672>.</span>registers)
</span></span><span style=display:flex><span>{<span style=color:#e6db74>&#39;p&#39;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;a&#39;</span>: <span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#39;b&#39;</span>: <span style=color:#ae81ff>5</span>}
</span></span></code></pre></div><p>I don&rsquo;t know about you, but I think that&rsquo;s pretty cool. ðŸ˜„</p><p>The remaining three functions (for part 1) are:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>snd</span>(vm, x):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>append((vm<span style=color:#f92672>.</span>tick, vm<span style=color:#f92672>.</span>value(x)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>jgz</span>(vm, x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> vm<span style=color:#f92672>.</span>value(x) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        vm<span style=color:#f92672>.</span>pc <span style=color:#f92672>+=</span> vm<span style=color:#f92672>.</span>value(y) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rcv</span>(vm, x):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> vm<span style=color:#f92672>.</span>value(x) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>and</span> vm<span style=color:#f92672>.</span>output:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Recovered </span><span style=color:#e6db74>{</span>vm<span style=color:#f92672>.</span>output[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>StopIteration</span>
</span></span></code></pre></div><p>I&rsquo;m specifically using <code><a href="https://docs.python.org/3/search.html?q=StopIteration">StopIteration</a></code>
since that&rsquo;s the Pythonic way of breaking out of a generator<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>That&rsquo;s all we need to run part 1:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>code <span style=color:#f92672>=</span> [line<span style=color:#f92672>.</span>split() <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> lib<span style=color:#f92672>.</span>input()]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vm <span style=color:#f92672>=</span> VM()
</span></span><span style=display:flex><span>vm(code)
</span></span></code></pre></div><p>We don&rsquo;t have to output anything since the implementation of <code>rcv</code> above does it for us. Coolio.</p><p>But that&rsquo;s not everything I want to do here. Supposedly, the <code>snd</code> instruction is playing a note. What does this actually sound like?</p><p>Well, we can use <a href=https://github.com/duggan/midiutil>midiutil</a> to write MIDI files, lets see what it sounds like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VM</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_midi</span>(self, filename):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Write all of the output of the program so far as a MIDI file.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>import</span> math
</span></span><span style=display:flex><span>        <span style=color:#f92672>import</span> midiutil
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>output:
</span></span><span style=display:flex><span>            offset <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>output[<span style=color:#ae81ff>0</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        clock <span style=color:#f92672>=</span> lib<span style=color:#f92672>.</span>param(<span style=color:#e6db74>&#39;clock&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        midi <span style=color:#f92672>=</span> midiutil<span style=color:#f92672>.</span>MIDIFile(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        midi<span style=color:#f92672>.</span>addTempo(
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span>,          <span style=color:#75715e># Track</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span>,          <span style=color:#75715e># Start time</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>120</span>,        <span style=color:#75715e># Tempo (BPM)</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> tick, frequency <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>output:
</span></span><span style=display:flex><span>            <span style=color:#75715e># https://en.wikipedia.org/wiki/MIDI_tuning_standard#Frequency_values</span>
</span></span><span style=display:flex><span>            pitch <span style=color:#f92672>=</span> int(<span style=color:#ae81ff>69</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>12</span> <span style=color:#f92672>*</span> math<span style=color:#f92672>.</span>log(frequency <span style=color:#f92672>/</span> <span style=color:#ae81ff>440</span>))
</span></span><span style=display:flex><span>            midi<span style=color:#f92672>.</span>addNote(
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>0</span>,      <span style=color:#75715e># Track</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>0</span>,      <span style=color:#75715e># Channel</span>
</span></span><span style=display:flex><span>                pitch,  <span style=color:#75715e># Pitch of the note (midi data values)</span>
</span></span><span style=display:flex><span>                (tick <span style=color:#f92672>-</span> offset) <span style=color:#f92672>/</span> clock, <span style=color:#75715e># Tick to add the note</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>1</span>,      <span style=color:#75715e># Duration (beats)</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>100</span>,    <span style=color:#75715e># Volume (0-127)</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> fout:
</span></span><span style=display:flex><span>            midi<span style=color:#f92672>.</span>writeFile(fout)
</span></span></code></pre></div><p>There are a few complications / tuning factors here. Specifically, we are arbitrarily choosing 120 BPM for the tempo along with parameterizing how fast the virtual CPU can run compared to that tempo. Also, the output values appear to be raw frequencies, so we need toconvert them to MIDI notes before playing them using <a href=https://en.wikipedia.org/wiki/MIDI_tuning_standard#Frequency_values>this formula</a>.</p><p>Writing this out for part 1, we can generate the <a href=/embeds/2017/duetvm-output.mid>output as a MIDI file</a>. Using one of various programs<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>, we can convert this to an MP3:</p><audio controls><source src=/embeds/2017/duetvm-output.mp3 type=audio/mp3></audio><p>It&rsquo;s &mldr; not quite as interesting as I expected, but kind of haunting. Mostly I think it&rsquo;s just cool that it&rsquo;s playing something that was completely generated by running a ~40 line assembly language problem. That&rsquo;s just cool<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><blockquote><p><strong>Part 2:</strong> Rewrite the following two instructions:</p></blockquote><blockquote><ul><li><code>snd X</code> plays a sound with a frequency equal to the value of <code>X</code> and send <code>X</code> to the other program&rsquo;s message queue</li><li><code>rcv X</code> read a value from this program&rsquo;s message queue (send by the other program&rsquo;s <code>snd</code> command)</li></ul></blockquote><blockquote><p>Initialize a special register <code>p</code> to <code>0</code> for the first VM and <code>1</code> for the second one.</p></blockquote><blockquote><p>Eventually, the two programs will <a href=https://en.wikipedia.org/wiki/deadlock>deadlock</a> (both will be waiting for the other to send a value). When that happens, how many times has the second program (<code>p = 1</code>) send a value before this happened?</p></blockquote><p>Okay. That&rsquo;s interesting. The main two challenges here are implementing the message queues and detecting when a deadlock has occurred.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>snd</span>(vm, x):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> hasattr(vm, <span style=color:#e6db74>&#39;send_count&#39;</span>): vm<span style=color:#f92672>.</span>send_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>send_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    index <span style=color:#f92672>=</span> VM<span style=color:#f92672>.</span>vms<span style=color:#f92672>.</span>index(vm)
</span></span><span style=display:flex><span>    VM<span style=color:#f92672>.</span>vms[(index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(VM<span style=color:#f92672>.</span>vms)]<span style=color:#f92672>.</span>messages<span style=color:#f92672>.</span>put(vm<span style=color:#f92672>.</span>value(x))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>output<span style=color:#f92672>.</span>append((vm<span style=color:#f92672>.</span>tick, vm<span style=color:#f92672>.</span>value(x)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rcv</span>(vm, x):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;waiting&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    value <span style=color:#f92672>=</span> vm<span style=color:#f92672>.</span>messages<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> value <span style=color:#f92672>==</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>StopIteration</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;running&#39;</span>
</span></span></code></pre></div><p>Essentially, we&rsquo;re going to use the <code>messages</code> objects we built into the simulations earlier in order to send messages along with a class variable <code>vms</code> on <code>VM</code> that will keep track of all VMs running. In this case, there are only two, but this code is currently flexible enough for arbitrarily many VMs running together. In that case, each would send all values to the VM that was initialized next after them with the last sending to the first.</p><p>For the second requirement (deadlocks), we&rsquo;re going to keep track of the current VM state. While the VMs are running, <code>vm.state</code> will be <code>running</code>, but while we are waiting to receive a value from the message queue, they will go to <code>waiting</code>. If we detect that both end up in <code>waiting</code> at the same time (plus some time to avoid just waiting for the VMs to realize the other has sent a message), we have a deadlock.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> vm0<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> vm1<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;waiting&#39;</span>:
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> vm0<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> vm1<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;waiting&#39;</span>:
</span></span><span style=display:flex><span>            vm0<span style=color:#f92672>.</span>messages<span style=color:#f92672>.</span>put(<span style=color:#a6e22e>StopIteration</span>)
</span></span><span style=display:flex><span>            vm1<span style=color:#f92672>.</span>messages<span style=color:#f92672>.</span>put(<span style=color:#a6e22e>StopIteration</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>For this to work, both VMs have to be in the <code>waiting</code> state twice a second apart. This isn&rsquo;t perfect, since they could both be waiting on Python&rsquo;s <a href=https://wiki.python.org/moin/GlobalInterpreterLock>GIL</a> to be doing something else at both times, but in practice I didn&rsquo;t have that problem. This worked. We&rsquo;ll also specifically use <code><a href="https://docs.python.org/3/search.html?q=StopIteration">StopIteration</a></code>
again, this time in the message queues to tell the VMs to stop executing.</p><p>After that, we wait again for both to exit and print out how many times <code>p = 1</code> sent a value:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> vm0<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> vm1<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;exited&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(vm1<span style=color:#f92672>.</span>send_count)
</span></span></code></pre></div><p>And just like last time, we can generate MIDI files for each program (<a href=/embeds/2017/duetvm-output-part0.mid>vm0</a>, <a href=/embeds/2017/duetvm-output-part1.mid>vm1</a>) and then play them together as a single MP3:</p><audio controls><source src=/embeds/2017/duetvm-output-combined.mp3 type=audio/mp3></audio><p>Turns out, it takes rather a while for those to settle down (around an hour at the given tempo). There are some interesting features too. Starting around five minutes in, you can see <code>vm1</code> run down a scale and them <code>vm2</code> follow it:</p><figure><img src=/embeds/2017/duetvm-m171.png></figure><p>This happens more and more often as the song goes on with less noise before it and longer descents until finally the noise goes away completely and the two programs deadlock:</p><figure><a href=/embeds/2017/duetvm-full.png><img src=/embeds/2017/duetvm-full.png alt="Click for full size"></a><figcaption><p>Click for full size</p></figcaption></figure><p>That&rsquo;s kind of neat.</p><p>The problem is&mldr; it&rsquo;s not correct.</p><p>The problem is that I&rsquo;m using locking queues for my messages and not advancing the VMs clock while they are waiting. So if <code>vm0</code> sends a value at <code>tick=100</code> but <code>vm1</code> already ran <code>rcv</code> back at <code>tick=50</code>, the timestamps between the two machines are off by rather a bit. Instead of using the same <code>tick</code> values, it will always take exactly 1 <code>tick</code> to <code>rcv</code>. How do we fix that?</p><p>One option would be to not use a blocking get but rather to rewrite <code>rcv</code> to <code>rcv</code> a value if there is one to receive and do nothing (but not wait) if there isn&rsquo;t (not advancing the <code>pc</code> either, so it will <code>rcv</code> again the next tick). This will be a lot closer, but it&rsquo;s still not correct, since the two machines clocks don&rsquo;t have to run at the same speed. Instead, they will each run as quickly as they can, so that <code>rcv</code> may be waiting anywhere between <code>0</code> and <code>50</code> ticks in the example above.</p><p>Another option would be to tie the VMs together even more so that I specifically execute one instruction on each VM per tick. This is actually the one I went with. What we want to do is add a second mode to the <code>__call__</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> __call__(self, code, daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>, generator <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Run the given code with the given VM.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    If daemon is True, spawn a background thread to run the program in.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    If generator is True, return a generator that yields once per tick.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;running&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&lt;=</span> self<span style=color:#f92672>.</span>pc <span style=color:#f92672>&lt;</span> len(code):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>tick <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            cmd, <span style=color:#f92672>*</span>args <span style=color:#f92672>=</span> code[self<span style=color:#f92672>.</span>pc]
</span></span><span style=display:flex><span>            getattr(self, cmd)(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>pc <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> generator:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;exited&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>output
</span></span></code></pre></div><p>All that really changed here is that if we tell the <code>__call__</code> function to return a generator, it will yield on each tick. This does force the client running the virtual machines to manually advance the generator, but they know what they&rsquo;re getting into, so it works.</p><p>Next, we need to tweak the <code>rcv</code> function to not block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@VM.register</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rcv</span>(vm, x):
</span></span><span style=display:flex><span>    vm<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;waiting&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> vm<span style=color:#f92672>.</span>messages<span style=color:#f92672>.</span>get(block <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> value <span style=color:#f92672>==</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>StopIteration</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            vm<span style=color:#f92672>.</span>registers[x] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        vm<span style=color:#f92672>.</span>state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;running&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> queue<span style=color:#f92672>.</span>Empty:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Run the rcv command again next tick</span>
</span></span><span style=display:flex><span>        vm<span style=color:#f92672>.</span>pc <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>By specifying <code>block = False</code>, the <code>get</code> will raise a <code>queue.Empty</code> exception, which we can catch. If we do, that means we need to try to <code>rcv</code> again on the next tick, so undo advancing the <code>pc</code>.</p><p>Finally, the main loop needs to run one <code>tick</code> on both VMs in step:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    next(generator0)
</span></span><span style=display:flex><span>    next(generator1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> vm0<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;waiting&#39;</span> <span style=color:#f92672>and</span> vm1<span style=color:#f92672>.</span>state <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;waiting&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>Once nice thing here is that the deadlock detection is much easier to implement.</p><p>If we run it through, we see that we get exactly the same answer as before. We can then generate the corresponding two MIDI files (<a href=/embeds/2017/duetvm-output-better-part0.mid>vm0</a>, <a href=/embeds/2017/duetvm-output-better-part1.mid>vm1</a>) and the new (much better sounding) MP3:</p><audio controls><source src=/embeds/2017/duetvm-output-better-combined.mp3 type=audio/mp3></audio><p>It really does sound like the two machines playing a duet with one another, bouncing back and forth in some parts and actually playing together in others. It&rsquo;s just as long as before (which makes sense), but sounds much better.</p><p>It took quite a bit longer to write up the MIDI half of that and this post then it did to originally solve the problem. But I think it was worth it. ðŸ˜„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 run-all.py day-18
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>day-18  python3 duetvm.py input.txt --part <span style=color:#ae81ff>1</span>    0.10424304008483887     Recovered <span style=color:#ae81ff>3188</span>
</span></span><span style=display:flex><span>day-18  python3 duetvm.py input.txt --part <span style=color:#ae81ff>2</span>    1.1558499336242676      <span style=color:#ae81ff>7112</span>
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>We will! On <a href=https://blog.jverkamp.com/2017/12/23/aoc-2017-day-23-duetvmc/>Day 23: DuetVMC</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Under the hood, that&rsquo;s exactly how generators tell <code>for</code> loops they are done running.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>I used <a href=https://www.apple.com/mac/garageband/>GarageBand</a>.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Yes, I know I&rsquo;m a geek.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
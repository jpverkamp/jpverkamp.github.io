<!doctype html><html><head><title>Syncing Kobo Annotations – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_17422284542669262002.min.834c1e2313951f0c25b90152fe8b62250eab4a2e8cbd2560fa1a1cdc91c71733.js integrity="sha256-g0weIxOVHwwluQFS/otiJQ6rSi6MvSVg+hoc3JHHFzM=" defer></script><script src=/jquery.fancybox_16245765822111608191.min.a8e11addf4349ee2ca5045f7f3cbf1febbf2c3a2840be2143ea69539c10f8c7f.js integrity="sha256-qOEa3fQ0nuLKUEX388vx/rvyw6KEC+IUPqaVOcEPjH8=" defer></script><script src=/katex_17296078054267651618.min.4a06464d8d6f8358d8896de62b53b5a89205d335dfd8c5b6b27edd7c039ae9d8.js integrity="sha256-SgZGTY1vg1jYiW3mK1O1qJIF0zXf2MW2sn7dfAOa6dg=" defer></script><script src=/auto-render_14944144240389301023.min.e694d9d5eae2917984179683ead27b998784a81398e8836c369373d2c67fc32a.js integrity="sha256-5pTZ1erikXmEF5aD6tJ7mYeEqBOY6INsNpNz0sZ/wyo=" defer></script><script src=/bigfoot_28293813221957978.min.af671f08986f0a2267c5a0cb2748b005489e47fa25f55479b200e2a563d23022.js integrity="sha256-r2cfCJhvCiJnxaDLJ0iwBUieR/ol9VR5sgDipWPSMCI=" defer></script><script src=/mermaid_9520146763733687737.min.a17078917a4403310cd19178939257b706fb5e1da76167c9f4a6d2123c9d59c4.js integrity="sha256-oXB4kXpEAzEM0ZF4k5JXtwb7Xh2nYWfJ9KbSEjydWcQ=" defer></script><script src=/main.min.d60298c89fc4f1e938aceb45c60926efee8b03efc8b50683082e669a100da643.js integrity="sha256-1gKYyJ/E8ek4rOtFxgkm7+6LA+/ItQaDCC5mmhANpkM=" defer></script><link rel=stylesheet href=/katex_13658330645258633971.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_8781527669040159104.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_5330465509389191777.min.7420a1602c62a85d4b50881c1d8ce42f72c049dc2b097d440696425d6e54bb1e.css integrity="sha256-dCChYCxiqF1LUIgcHYzkL3LASdwrCX1EBpZCXW5Uux4="><link rel=stylesheet href=/css_1846377409604050217.min.fffe842bc000dd1fe8661ac6427a392a08faa95e8edab1ea7fb98c5f8dac6a6f.css integrity="sha256-//6EK8AA3R/oZhrGQno5Kgj6qV6O2rHqf7mMX42sam8="><link rel=stylesheet href=/main.min.61064b3964637440ee1c28e577377fcf238ddc5939020ef8b3c3cae543898111.css integrity="sha256-YQZLOWRjdEDuHCjldzd/zyON3Fk5Ag74s8PK5UOJgRE="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=/search/ method=get class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/home-automation/>Home Automation</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li><a href=https://blog.jverkamp.com/search/>Search</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article data-pagefind-body><header><h1 class=entry-title data-pagefind-meta=title>Syncing Kobo Annotations</h1><div class=entry-meta><span class=entry-date>2025-12-29</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2020/04/09/command-line-aes-with-openssl-and-tar/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/bash>Bash</a></li><li><a href=https://blog.jverkamp.com/2025/02/19/a-quick-mitmproxy-setup/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2022/01/25/pulling-more-than-5000-logs-from-datadog/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/apis>APIs</a></li><li><a class=taxonomy-value href=/programming/topics/automation>Automation</a></li><li><a class=taxonomy-value href=/programming/topics/dropbox>Dropbox</a></li><li><a href=https://blog.jverkamp.com/2022/12/07/aoc-2022-day-7-recursive-fileinator/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/filesystems>Filesystems</a></li><li><a href=https://blog.jverkamp.com/2025/02/12/a-kitchen-calendar-display-running-on-an-orange-pi-zero-2w/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/linux>Linux</a></li><li><a href=https://blog.jverkamp.com/2025/12/20/locking-bga-tabs-with-userscripts/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/productivity>Productivity</a></li><li><a href=https://blog.jverkamp.com/2018/01/12/making-fish-shell-smile/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/shell-scripting>Shell Scripting</a></li><li><a href=https://blog.jverkamp.com/2023/11/09/sqlite-metadata-via-sql-injection/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/sqlite>SQLite</a></li><li><a href=https://blog.jverkamp.com/2023/03/27/automated-transcripts-from-video-with-whisper.cpp/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/text>Text</a></li><li><a href=https://blog.jverkamp.com/2023/02/14/genuary-2023.14-asemic-writing/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/writing>Writing</a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2025/12/20/locking-bga-tabs-with-userscripts/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2026/01/01/genuary-2026.01-one-color-one-shape/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2025/12/29/the-river/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2025/12/30/doctor-who-2008-specials/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>I&rsquo;ve recently been trying out a <a href=https://www.kobo.com/ target=_blank rel=noopener>Kobo</a>. Amazon has some issues and Kindles are hard to do any amount of customization to, let&rsquo;s just leave it at that.</p><p>So what fun tricks can one do with a Kobo?</p><p>Well, for one, it&rsquo;s a Linux system. And if you attach it to your computer, you get access to a lot of the local filesystem. This includes the SQLite database holding all of teh system metadata, along with places to install all sorts of interesting scripts.</p><p>One that I&rsquo;ve been wanting in particular is the ability to extract my annotations. It&rsquo;s a great way to <a href=/reviews>review</a> books. Highlight, write a note, and then export right at the end.</p><p>So how do you do that on a Kobo?</p><nav id=TableOfContents><ul><li><a href=#starting-point>Starting point</a></li><li><a href=#via-dropbox>Via Dropbox</a></li><li><a href=#adding-a-button-on-the-kobo>Adding a button on the Kobo</a></li><li><a href=#exporting-notes>Exporting notes</a></li><li><a href=#todo>Todo</a></li></ul></nav><hr><h2 id=starting-point>Starting point</h2><p>Well, to start out, I found <a href="https://www.mobileread.com/forums/showthread.php?t=349637" target=_blank rel=noopener>this thread</a>. This gives me the initial script, although it&rsquo;s designed to extract the notes directly on device. I wanted more control than that.</p><h2 id=via-dropbox>Via Dropbox</h2><p>So here we end up with this script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>APP_KEY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;...&#34;</span>
</span></span><span style=display:flex><span>APP_SECRET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;...&#34;</span>
</span></span><span style=display:flex><span>REFRESH_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;...&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NOTES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/mnt/onboard/.adds/notes&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DB<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/mnt/onboard/.kobo/KoboReader.sqlite&#34;</span>
</span></span><span style=display:flex><span>CURL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NOTES<span style=color:#e6db74>}</span><span style=color:#e6db74>/curl&#34;</span>
</span></span><span style=display:flex><span>CERT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NOTES<span style=color:#e6db74>}</span><span style=color:#e6db74>/ca-bundle.crt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LD_LIBRARY_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NOTES<span style=color:#e6db74>}</span><span style=color:#e6db74>/lib:</span><span style=color:#e6db74>${</span>LD_LIBRARY_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>export LD_LIBRARY_PATH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># First we need a short lived access token</span>
</span></span><span style=display:flex><span>ACCESS_TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>$CURL --cacert $CERT -s -X POST https://api.dropboxapi.com/oauth2/token <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -u <span style=color:#e6db74>&#34;</span>$APP_KEY<span style=color:#e6db74>:</span>$APP_SECRET<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -d grant_type<span style=color:#f92672>=</span>refresh_token <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -d refresh_token<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$REFRESH_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  | grep -o <span style=color:#e6db74>&#39;&#34;access_token&#34;: *&#34;[^&#34;]*&#34;&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  | sed <span style=color:#e6db74>&#39;s/.*: *&#34;//;s/&#34;$//&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Then we can actually upload the file</span>
</span></span><span style=display:flex><span>$CURL --cacert $CERT -X POST https://content.dropboxapi.com/2/files/upload <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --header <span style=color:#e6db74>&#34;Authorization: Bearer </span>$ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --header <span style=color:#e6db74>&#34;Dropbox-API-Arg: {\&#34;path\&#34;: \&#34;/KoboReader.sqlite\&#34;,\&#34;mode\&#34;: \&#34;overwrite\&#34;,\&#34;mute\&#34;: false}&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --header <span style=color:#e6db74>&#34;Content-Type: application/octet-stream&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --data-binary @<span style=color:#e6db74>&#34;</span>$DB<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>This is &mldr; slightly odd. Since we&rsquo;re bundling <code>curl</code> and the <code>ca-bundle.crt</code> directly rather than installing them on the system. Other than that, we&rsquo;ll be using the Dropbox API in three parts:</p><ol><li>Go to <a href=https://www.dropbox.com/developers/apps target=_blank rel=noopener>https://www.dropbox.com/developers/apps</a></li><li>Click “Create app”<ol><li>Scoped access</li><li>Select App Folder</li><li>Scopes: <code>files.content.write</code> and <code>files.content.read</code></li><li>Save the app key and secret</li></ol></li><li>Get your refresh token<ol><li>Visit <code>https://www.dropbox.com/oauth2/authorize?client_id=APP_KEY&amp;response_type=code&amp;token_access_type=offline</code></li><li>Copy the code from the &lsquo;access code generated&rsquo; page</li></ol></li><li>Create a refresh token:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST https://api.dropboxapi.com/oauth2/token <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -u YOUR_APP_KEY:YOUR_APP_SECRET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -d code<span style=color:#f92672>=</span>ACCESS_CODE <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -d grant_type<span style=color:#f92672>=</span>authorization_code
</span></span></code></pre></div><p>After that is all set up, we need a way to run it:</p><h2 id=adding-a-button-on-the-kobo>Adding a button on the Kobo</h2><p>As I mentioned, use NickleMenu to add a button:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>menu_item :main :Send DB :nickel_wifi :autoconnect
</span></span><span style=display:flex><span>  chain_success :cmd_spawn :quiet :/mnt/onboard/.adds/notes/send-db.sh
</span></span><span style=display:flex><span>  chain_success :dbg_toast :Syncing Notes
</span></span></code></pre></div><p>Now, unmount, restart, and click the new &lsquo;Send DB&rsquo; button.</p><p>Voilá. We have the kobo database in our Dropbox!</p><h2 id=exporting-notes>Exporting notes</h2><p>Okay, for the next part, I took the SQL queries from the original forum thread, wrapped them in some Python, and used that to export them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sqlite3
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>db <span style=color:#f92672>=</span> sqlite3<span style=color:#f92672>.</span>connect(<span style=color:#e6db74>&#34;KoboReader.sqlite&#34;</span>)
</span></span><span style=display:flex><span>db<span style=color:#f92672>.</span>row_factory <span style=color:#f92672>=</span> sqlite3<span style=color:#f92672>.</span>Row
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    c.Title as title,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    COALESCE(c_chapter_titled.Title, c_chapter.Title, b.ContentID) as chapter,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    b.Text as text,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    b.Annotation as annotation
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Bookmark b
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    INNER JOIN content c ON b.VolumeID = c.ContentID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    LEFT JOIN content c_chapter_titled ON c_chapter_titled.ContentID = b.ContentID || &#39;-1&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    LEFT JOIN content c_chapter ON c_chapter.ContentID = b.ContentID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ORDER BY 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    c.Title ASC,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    CAST(COALESCE(SUBSTR(b.ContentID, INSTR(b.ContentID, &#39;chapter_&#39;) + 8, 3), &#39;0&#39;) AS INTEGER) ASC,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    b.ChapterProgress ASC,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    b.DateCreated ASC
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>makedirs(<span style=color:#e6db74>&#34;notes&#34;</span>, exist_ok<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>buffer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>last_title <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>last_chapter <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_out</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Write the buffer to a file and clear it (if it&#39;s not empty)&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> buffer, last_title, last_chapter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> buffer:
</span></span><span style=display:flex><span>        path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;notes&#34;</span>, last_title <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.md&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Writing </span><span style=color:#e6db74>{</span>path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> open(path, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            f<span style=color:#f92672>.</span>write(buffer)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        last_chapter <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>markdownify</span>(text):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Convert text to a markdown blockquote&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add markdown blockquotes (with paragraphs)</span>
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;^\s*(.*)&#34;</span>, <span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;&gt; \1\n&gt; &#34;</span>, text, flags<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>MULTILINE)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Remove multiple empty lines within blockquotes</span>
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;(^&gt;\s*$\n?){2,}&#34;</span>, <span style=color:#e6db74>&#34;&gt;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, text, flags<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>MULTILINE)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Remove trailing empty lines of blockquotes</span>
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;^&gt;\s*$(^$){2,}&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, text, flags<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>MULTILINE)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> title, chapter, text, annotation <span style=color:#f92672>in</span> db<span style=color:#f92672>.</span>execute(query):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Skip bookmarks</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> text:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If we&#39;ve switched books, print the new one</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> title <span style=color:#f92672>!=</span> last_title:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;New title: </span><span style=color:#e6db74>{</span>title<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        write_out()
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>+=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;# </span><span style=color:#e6db74>{</span>title<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        last_title <span style=color:#f92672>=</span> title
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Likewise, chapters</span>
</span></span><span style=display:flex><span>    chapter <span style=color:#f92672>=</span> chapter<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;#&#34;</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> chapter <span style=color:#f92672>!=</span> last_chapter:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;New chapter: </span><span style=color:#e6db74>{</span>chapter<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>+=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;## </span><span style=color:#e6db74>{</span>chapter<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        last_chapter <span style=color:#f92672>=</span> chapter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># TODO: Format as markdown</span>
</span></span><span style=display:flex><span>    buffer <span style=color:#f92672>+=</span> markdownify(text) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> annotation:
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>+=</span> annotation <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>write_out()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>db_time <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>getmtime(<span style=color:#e6db74>&#34;KoboReader.sqlite&#34;</span>)
</span></span><span style=display:flex><span>db_time <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>fromtimestamp(db_time)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my_time <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print()
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Database last modified: </span><span style=color:#e6db74>{</span>db_time<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Time since last modified: </span><span style=color:#e6db74>{</span>my_time <span style=color:#f92672>-</span> db_time<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>Converting to Markdown and cleaning up the markdown took a moment.</p><p>Other than that, we now have a number of Markdown files&ndash;one for each book, with each highlights (and optionally note text), broken down by chapter.</p><p>It doesn&rsquo;t work for every book (it depends on how the epub is laid out), but it does mostly work.</p><h2 id=todo>Todo</h2><p>So what can I do next? As easy as it makes things, I&rsquo;d actually like to remove the dependency on Dropbox and directly build a server into the Python script. That will catch the DB, automatically generate the Markdown, and allow me to look at it in a browser. Easy enough if it&rsquo;s living on my local network (perhaps with a <a href=https://blog.jverkamp.com/2025/12/28/dns/wireguard-tunnel-weirdness-on-ios/>wireguard</a> tunnel). But for now, this works fine.</p><p>Onward!</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content data-pagefind-ignore=all><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
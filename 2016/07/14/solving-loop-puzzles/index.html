<!doctype html><html><head><title>Solving Loop Puzzles – jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js integrity="sha256-MESIkqofkenEy1SU5cXlq8E7d3jed4blJWzcfSQkgTo=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js integrity="sha256-a6A3Rm25+IQ7ZsOMMv5aNTNE5/1o7NqX77Y6hMiB+Cg=" defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js integrity="sha256-PMOggMA2h4UXnjewzQpxxs9gxPxajc5QP1pULsCiUEM=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js integrity="sha256-6PGSg6YyB3CFua10rsrVSr6EQpxpeJ/Sn/o6JU2Gq90=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css integrity="sha256-fPrJW92WLYXO7FYOUP57BMRLWKduUgIAbvNsqMCn2DY="><link rel=stylesheet href=/main.min.9efa38cb8d96be1a2d31208e5279a2f48fd2a15f6bcc9173c7375c675225b767.css integrity="sha256-nvo4y42WvhotMSCOUnmi9I/SoV9rzJFzxzdcZ1Ilt2c="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>Solving Loop Puzzles</h1><div class=entry-meta><span class=entry-date>2016-07-14</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2016/06/22/mirror-itunes-playlists-to-spotify/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2016/12/01/aoc-2016-day-1-taxicab-simulator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2016/06/22/mirror-itunes-playlists-to-spotify/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2016/12/01/aoc-2016-day-1-taxicab-simulator/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2016/07/12/the-bands-of-mourning/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2016/07/17/the-dunwich-horror/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><p>A quick puzzle from Daily Programmer:</p><blockquote><p>∞ Loop is a mobile game that consists of n<em>m tiles, placed in a n</em>m grid. There are 16 different tiles:</p></blockquote><blockquote><p><code>┃, ━, ┏, ┓, ┛, ┗, ┣, ┳, ┫, ┻, ╋, ╹, ╺, ╻, ╸, ' '.</code></p></blockquote><blockquote><p>The objective is to create a closed loop: every pipe must have another tile facing it in the adjacent tile <code>—</code> for example if some tile has a pipe going right, its adjacent tile to the right must have a pipe going left.</p></blockquote><p>The most straightforward solution is a hybrid combination of constraints and backtracking, similar to what I did when solving <a href=https://blog.jverkamp.com/2015/10/29/takuzu-solver/>Takuzu</a> and <a href=https://blog.jverkamp.com/2014/10/28/tile-puzzle/>tile puzzles</a>.</p><p>First, we&rsquo;ll create two classes, one for individual characters and one for puzzles. Think what you may about <a href=https://en.wikipedia.org/wiki/object%20oriented%20programming>object oriented programming</a>, but I think it fits fairly well with this problem.</p><p>First, characters. We want something that will be able to represent characters with with their character form (the <a href=https://en.wikipedia.org/wiki/box%20drawing%20characters>box drawing characters</a> above) or as a collection of edges (if the top / right / bottom / left pipe is included). This could be represented as a 4-bit integer, but instead I&rsquo;ll use a 4-tuple of bools. It&rsquo;s just a bit easier to read by default.</p><p>On top of that, we want functions that can rotate pieces, test if two characters are actually the same, and to test if two neighboring pieces can border each other or not. The last is true if they either both have a pipe pointing inwards or neither does.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Character</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;A box drawing character or empty space ( ╸╻┓╺━┏┳╹┛┃┫┗┻┣╋).&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    order <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; ╸╻┓╺━┏┳╹┛┃┫┗┻┣╋&#39;</span>
</span></span><span style=display:flex><span>    sides <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;top&#39;</span>: (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>), <span style=color:#e6db74>&#39;right&#39;</span>: (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>), <span style=color:#e6db74>&#39;bottom&#39;</span>: (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>), <span style=color:#e6db74>&#39;left&#39;</span>: (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>1</span>)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, symbol_or_bits):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Create a new character from either the symbol (must be a valid symbol)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        or a 4-tuple of booleans representing the sides (top, right, bottom,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        left).
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(symbol_or_bits, str):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>symbol <span style=color:#f92672>=</span> symbol_or_bits
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            bits <span style=color:#f92672>=</span> bin(Character<span style=color:#f92672>.</span>order<span style=color:#f92672>.</span>find(symbol_or_bits))[<span style=color:#ae81ff>2</span>:]
</span></span><span style=display:flex><span>            bits <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>4</span> <span style=color:#f92672>-</span> len(bits)) <span style=color:#f92672>+</span> bits
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>bits <span style=color:#f92672>=</span> tuple(bit <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#66d9ef>for</span> bit <span style=color:#f92672>in</span> bits)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>bits <span style=color:#f92672>=</span> symbol_or_bits
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>symbol <span style=color:#f92672>=</span> Character<span style=color:#f92672>.</span>order[int(<span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#66d9ef>if</span> bit <span style=color:#66d9ef>else</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#66d9ef>for</span> bit <span style=color:#f92672>in</span> symbol_or_bits), <span style=color:#ae81ff>2</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rotate</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Return the next rotation for this character.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Character(tuple(self<span style=color:#f92672>.</span>bits[i] <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rotations</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Generate all four of the rotations this character could have.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        c <span style=color:#f92672>=</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>4</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span> c
</span></span><span style=display:flex><span>            c <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span>rotate()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>can_neighbor</span>(self, other, side):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Test if this character can neighbor a given other on a given side.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Two characters can be neighbors if they either both have a line on that
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        side or neither does. If other is not set, that is assumed to be a
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        outside of the puzzle and thus not have a line.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        my_bit, their_bit <span style=color:#f92672>=</span> Character<span style=color:#f92672>.</span>sides[side]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># print(side, self, other, my_bit, their_bit, self.bits, other.bits) # DEBUG</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> other:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>bits[my_bit] <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span>bits[their_bit]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>bits[my_bit]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __hash__(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Use the symbol as a hash. This is so we can put characters in sets.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> hash(self<span style=color:#f92672>.</span>symbol)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __eq__(self, other):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Characters are equal if they have the same symbol.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>symbol <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span>symbol
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Print which character this is.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>symbol
</span></span></code></pre></div><p>After that, the next step will be to create a <code>Puzzle</code>. This is the grid of characters, but we&rsquo;ll actually go a step larger. Each cell in the <code>Puzzle</code> will actually be a set of rotations that are still possible. This means that as long as any cell has more than 1 possibility, it&rsquo;s not solved. If any has managed to reach 0, no solution is possible.</p><p>In addition, we&rsquo;ll put the constraining function here. This will loop through every single cell in the puzzle: for each, it will match each rotation remaining against each rotation of all four neighbors. If a given rotation cannot possibly match any one of the neighbors, remove it from the set. Imagine:</p><pre tabindex=0><code class=language-test data-lang=test>┛╸╸
╺┓╻
┗ ┣
</code></pre><p>The middle character can originally be any of <code>{┏, ┓, ┛, ┗}</code>; however, the bottom center is an empty space, so we should not include any downward facing options. Thus, with a single round of constraint, we&rsquo;ve reduced the center tile to <code>{┛, ┗}</code>. Even better, this will further constrain the top center piece. At first it was <code>{╹, ╺, ╻, ╸}</code>, but the center has to have an upward pointing point, forcing the top center to be <code>{╻}</code>. Each round of constraints only sets each tile once and won&rsquo;t work recursively, but it&rsquo;s easy enough to call it more than once. Especially since the function will return <code>True</code> until the puzzle reaches a steady state.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Puzzle</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Represent a grid of possible characters.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    border <span style=color:#f92672>=</span> {Character(<span style=color:#e6db74>&#39; &#39;</span>)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, data):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Initialize from a string containing characters.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>data <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            [set(Character(c)<span style=color:#f92672>.</span>rotations()) <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> line]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> data<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>rows <span style=color:#f92672>=</span> len(self<span style=color:#f92672>.</span>data)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>cols <span style=color:#f92672>=</span> len(self<span style=color:#f92672>.</span>data[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>possibilities</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Return the number of possibilities in the form (unsolved squares, total
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        possibilities). A solved puzzle will return (0, rows * cols).
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>            sum(<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>if</span> len(el) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> row),
</span></span><span style=display:flex><span>            sum(len(el) <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> row)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>is_solvable</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Test if the puzzle is still solvable (no empty possibilities.)&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>not</span> any(
</span></span><span style=display:flex><span>            len(el) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> row
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>is_solved</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Test if this puzzle is currently solved.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> all(
</span></span><span style=display:flex><span>            len(el) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> row
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>constrain</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Constrain this puzzle by removing any rotations that could not possibly
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        be used (there&#39;s no possibility in the neighbor to match them).
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Only make one pass, call this function multiple times in case one
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        constraint cascades.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Return if anything changed.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>&#39;Applying constraints, possiblities: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>possibilities()))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        offsets <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            (<span style=color:#e6db74>&#39;top&#39;</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>            (<span style=color:#e6db74>&#39;right&#39;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>            (<span style=color:#e6db74>&#39;bottom&#39;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>            (<span style=color:#e6db74>&#39;left&#39;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        something_changed <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> range(self<span style=color:#f92672>.</span>rows):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> col <span style=color:#f92672>in</span> range(self<span style=color:#f92672>.</span>cols):
</span></span><span style=display:flex><span>                invalid <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> first_point <span style=color:#f92672>in</span> self[row, col]:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> all(
</span></span><span style=display:flex><span>                        any(
</span></span><span style=display:flex><span>                            first_point<span style=color:#f92672>.</span>can_neighbor(second_point, direction)
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>for</span> second_point <span style=color:#f92672>in</span> self[row <span style=color:#f92672>+</span> row_offset, col <span style=color:#f92672>+</span> col_offset]
</span></span><span style=display:flex><span>                        ) <span style=color:#66d9ef>for</span> direction, row_offset, col_offset <span style=color:#f92672>in</span> offsets
</span></span><span style=display:flex><span>                    ):
</span></span><span style=display:flex><span>                        invalid<span style=color:#f92672>.</span>add(first_point)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> impossibility <span style=color:#f92672>in</span> invalid:
</span></span><span style=display:flex><span>                    something_changed <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>                    self[row, col]<span style=color:#f92672>.</span>remove(impossibility)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> something_changed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, pt):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Fetch the current possibility set from a given row and column.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        If the index is out of bounds, instead return a &#39;border character&#39; with
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        no edges to help guarantee that no pieces point outwards.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        row, col <span style=color:#f92672>=</span> pt
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&lt;=</span> row <span style=color:#f92672>&lt;</span> self<span style=color:#f92672>.</span>rows <span style=color:#f92672>and</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&lt;=</span> col <span style=color:#f92672>&lt;</span> self<span style=color:#f92672>.</span>cols:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>data[row][col]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Puzzle<span style=color:#f92672>.</span>border
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;If solved, print the puzzle; if not, print remaining possibilities.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>is_solved():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(str(list(el)[<span style=color:#ae81ff>0</span>]) <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> row)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pad_set</span>(el):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(str(each) <span style=color:#66d9ef>for</span> each <span style=color:#f92672>in</span> el) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>4</span> <span style=color:#f92672>-</span> len(el))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            line_seperator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> (<span style=color:#e6db74>&#39;┈&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>7</span> <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>cols <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span>)) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> line_seperator<span style=color:#f92672>.</span>join(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39; ┆ &#39;</span><span style=color:#f92672>.</span>join(pad_set(el) <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> row)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> repr(self<span style=color:#f92672>.</span>data)
</span></span></code></pre></div><p>That&rsquo;s actually enough by itself to solve some puzzles. But sometimes, particularly in larger puzzles, you&rsquo;ll reach states where two arrangements are still possible. In those cases, we want to take a <a href=https://en.wikipedia.org/wiki/backtracking>backtracking</a> step: choose each of the possible states in turn and assume it is correct, switching back to the constraint solver until the next block. If a solution is found in that branch, just return. If not, try the next branch from that position.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>solve</span>(puzzle):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Use a hybrid constraint / backtracking solver to solve the puzzle.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    while not solved:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        apply constraint solver until it doesn&#39;t work any more
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        find the first mismatched point and try each possibility
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    queue <span style=color:#f92672>=</span> [puzzle]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> queue:
</span></span><span style=display:flex><span>        puzzle <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span>pop()
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;Running backtracker, states: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, possiblities in current state: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(len(queue), puzzle<span style=color:#f92672>.</span>possibilities()))
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>debug(puzzle)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Apply constraint until the constrain function returns false</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> puzzle<span style=color:#f92672>.</span>constrain(): <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>debug(puzzle)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> puzzle<span style=color:#f92672>.</span>is_solvable():
</span></span><span style=display:flex><span>            logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;Unsolveable state found, removing it&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> puzzle<span style=color:#f92672>.</span>is_solved():
</span></span><span style=display:flex><span>            logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;Solved state found, returning it&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> puzzle
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Split to backtracking</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>first_unclear_point</span>():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> range(puzzle<span style=color:#f92672>.</span>rows):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> col <span style=color:#f92672>in</span> range(puzzle<span style=color:#f92672>.</span>cols):
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> len(puzzle[row, col]) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> row, col, puzzle[row, col]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        row, col, possibilities <span style=color:#f92672>=</span> first_unclear_point()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> possibility <span style=color:#f92672>in</span> possibilities:
</span></span><span style=display:flex><span>            copied_puzzle <span style=color:#f92672>=</span> copy<span style=color:#f92672>.</span>deepcopy(puzzle)
</span></span><span style=display:flex><span>            copied_puzzle[row, col]<span style=color:#f92672>.</span>clear()
</span></span><span style=display:flex><span>            copied_puzzle[row, col]<span style=color:#f92672>.</span>add(possibility)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            queue<span style=color:#f92672>.</span>append(copied_puzzle)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If we made it out of the loop, there is no solution to the puzzle</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span></code></pre></div><p>And that&rsquo;s it. We can solve puzzles from <code>stdin</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>puzzle <span style=color:#f92672>=</span> Puzzle(sys<span style=color:#f92672>.</span>stdin<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>solution <span style=color:#f92672>=</span> solve(puzzle)
</span></span><span style=display:flex><span>print(solution)
</span></span></code></pre></div><p>Example running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat 10x10.loops
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>┗┣┃┃┗┏┳┓┛┏
</span></span><span style=display:flex><span>┗┛┛━┳┫┃┃━━
</span></span><span style=display:flex><span>┛┛━┓┳╋┫━┣┏
</span></span><span style=display:flex><span>┫╋┻┛┛┻━┳╋┗
</span></span><span style=display:flex><span>┛┳┃┳┃╋┫┃┳┗
</span></span><span style=display:flex><span>┓━┓━┏╋┏┻╋┓
</span></span><span style=display:flex><span>┛┛━┃┻┗┓┓┳┓
</span></span><span style=display:flex><span>┏╋╋┏┏┳┣┗┗┗
</span></span><span style=display:flex><span>┣╋╋┏┏┻┓┓┏┫
</span></span><span style=display:flex><span>┏┏┗┫┣┳┳━┫┗
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat 10x10.loops | python3 loop-solver.py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>┏┳━━┓┏┳┓┏┓
</span></span><span style=display:flex><span>┗┛┏━┻┫┃┃┃┃
</span></span><span style=display:flex><span>┏┓┃┏┳╋┫┃┣┛
</span></span><span style=display:flex><span>┣╋┻┛┗┫┃┣╋┓
</span></span><span style=display:flex><span>┗┻━┳━╋┫┃┣┛
</span></span><span style=display:flex><span>┏━┓┃┏╋┛┣╋┓
</span></span><span style=display:flex><span>┗┓┃┃┣┛┏┛┣┛
</span></span><span style=display:flex><span>┏╋╋┛┗┳┻┓┗┓
</span></span><span style=display:flex><span>┣╋╋┓┏┫┏┛┏┫
</span></span><span style=display:flex><span>┗┛┗┻┻┻┻━┻┛
</span></span></code></pre></div><p>Cool. Looking at this and several other puzzles, it seems like it would be a good generic framework to work out. Given a definition for a puzzle with an <code>is_valid</code> function (<code>can_neighbor</code> here), a <code>constrain</code> function, and the backtracking code above, it should be able to solve a large class of puzzles. <a href=https://en.wikipedia.org/wiki/Sudoku>Sudoku</a>, for example, or <a href=https://en.wikipedia.org/wiki/Hashi>Hashi</a>. Both puzzles I&rsquo;ve been working on solvers for. Even better, once you have a solver you can use it to generate puzzles with a difficulty gradient. Just solve each puzzle, keeping track of how many times you had to backtrack and how many were solved with the constraints.</p><p>And that&rsquo;s it. A fun little puzzle.</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
<!DOCTYPE html>
<html>
<head>
    <title>
    Solving Loop Puzzles – jverkamp.com
</title>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" title="jverkamp.com (Atom 2.0)" href="//blog.jverkamp.com/feed/">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/css/themes/light/nanogallery_light.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css" integrity="sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css">

<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel="stylesheet">

<link rel="stylesheet" href="/custom.css" defer />


    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
    <div id="wrapper">
        <header id="page-header" role="banner">
    <h1><a href="/">JP's Blog</a></h1>

    <ul id="page-header-links">
        <li><a href="/about/">About Me</a></li>
        <li>
            <form action="//www.google.com/search" method="get" onsubmit="(function(obj){obj.q.value='site:blog.jverkamp.com '+obj.qfront.value;})(this)" class="navbar-form navbar-right" role="search" _lpchecked="1">
                <div class="form-group">
                    <input name="q" type="hidden">
                    <input name="qfront" type="text" class="form-control" placeholder="Search">
                    <button type="submit" class="btn btn-default" value="Search">Search</button>
                </div>
            </form>
        </li>

    </ul>

    <nav id="header-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
        
            
        
            
            <li><a href="https://blog.jverkamp.com/photography/">Photography</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/programming/">Programming</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/research/">Research</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/reviews/">Reviews</a></li>
            
        
            
            <li><a href="https://blog.jverkamp.com/writing/">Writing</a></li>
            
        
            <li class="subscription" data-subscription="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
    </nav>
</header>


        <div id="page-content-wrapper">
            <div id="page-content">
            
<article>
	<header>
		<h1 class="entry-title">Solving Loop Puzzles</h1>

        <div class="entry-meta">
            
            <span class="entry-date">2016-07-14</span>
            
            
        </div>

        <div class="entry-tags">
    
    

    <ul class="taxonomy-keys">
    
        
        

        
        

        
    
        
        

        
        

        
        <li>
            <a class="taxonomy-key" href="/programming/languages/">Languages</a>
            <ul class="taxonomy-values">
            
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
                    
                    
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    

                    
                    

                    <li>
                        <a href="https://blog.jverkamp.com/2016/06/22/mirror-itunes-playlists-to-spotify/" class="previous-link"></a>
                        <a class="taxonomy-value" href="/programming/languages/python">Python</a>
                        
                    </li>
                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
                

                
                

                
            
            
            </ul>
        </li>
        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    
        
        

        
        

        
    

    
        
        <li><a class="taxonomy-key" href="/programming">programming</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2016/06/22/mirror-itunes-playlists-to-spotify/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2017/11/15/clock-drift-in-docker-containers/" class="next-link">Next</a>
                
            </ul>
        </li>
        

        
        <li><a class="taxonomy-key" href="/">All Posts</a>
            <ul>
                <li>
                
                <a href="https://blog.jverkamp.com/2016/07/12/the-bands-of-mourning/" class="previous-link">Prev</a>
                

                
                <a href="https://blog.jverkamp.com/2016/07/17/the-dunwich-horror/" class="next-link">Next</a>
                
            </ul>
        </li>
        
    
    </ul>
</div>

    </header>

	<div class="entry-content">
		<p>A quick puzzle from Daily Programmer:</p>

<blockquote>
<p>∞ Loop is a mobile game that consists of n*m tiles, placed in a n*m grid. There are 16 different tiles:</p>

<p><code>┃, ━, ┏, ┓, ┛, ┗, ┣, ┳, ┫, ┻, ╋, ╹, ╺, ╻, ╸, ' '.</code></p>

<p>The objective is to create a closed loop: every pipe must have another tile facing it in the adjacent tile <code>—</code> for example if some tile has a pipe going right, its adjacent tile to the right must have a pipe going left.</p>
</blockquote>

<p>The most straightforward solution is a hybrid combination of constraints and backtracking, similar to what I did when solving <a href="https://blog.jverkamp.com/2015/10/29/takuzu-solver/">Takuzu</a> and <a href="https://blog.jverkamp.com/2014/10/28/tile-puzzle/">tile puzzles</a>.</p>

<p></p>

<p>First, we&rsquo;ll create two classes, one for individual characters and one for puzzles. Think what you may about <a href="https://en.wikipedia.org/wiki/object%20oriented%20programming">object oriented programming</a>, but I think it fits fairly well with this problem.</p>

<p>First, characters. We want something that will be able to represent characters with with their character form (the <a href="https://en.wikipedia.org/wiki/box%20drawing%20characters">box drawing characters</a> above) or as a collection of edges (if the top / right / bottom / left pipe is included). This could be represented as a 4-bit integer, but instead I&rsquo;ll use a 4-tuple of bools. It&rsquo;s just a bit easier to read by default.</p>

<p>On top of that, we want functions that can rotate pieces, test if two characters are actually the same, and to test if two neighboring pieces can border each other or not. The last is true if they either both have a pipe pointing inwards or neither does.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Character</span>(object):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;A box drawing character or empty space ( ╸╻┓╺━┏┳╹┛┃┫┗┻┣╋).&#39;&#39;&#39;</span>

    order <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39; ╸╻┓╺━┏┳╹┛┃┫┗┻┣╋&#39;</span>
    sides <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;top&#39;</span>: (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;right&#39;</span>: (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;bottom&#39;</span>: (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;left&#39;</span>: (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>)}

    <span style="color:#66d9ef">def</span> __init__(self, symbol_or_bits):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">        Create a new character from either the symbol (must be a valid symbol)
</span><span style="color:#e6db74">        or a 4-tuple of booleans representing the sides (top, right, bottom,
</span><span style="color:#e6db74">        left).
</span><span style="color:#e6db74">        &#39;&#39;&#39;</span>

        <span style="color:#66d9ef">if</span> isinstance(symbol_or_bits, str):
            self<span style="color:#f92672">.</span>symbol <span style="color:#f92672">=</span> symbol_or_bits

            bits <span style="color:#f92672">=</span> bin(Character<span style="color:#f92672">.</span>order<span style="color:#f92672">.</span>find(symbol_or_bits))[<span style="color:#ae81ff">2</span>:]
            bits <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> len(bits)) <span style="color:#f92672">+</span> bits

            self<span style="color:#f92672">.</span>bits <span style="color:#f92672">=</span> tuple(bit <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> bits)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>bits <span style="color:#f92672">=</span> symbol_or_bits
            self<span style="color:#f92672">.</span>symbol <span style="color:#f92672">=</span> Character<span style="color:#f92672">.</span>order[int(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">if</span> bit <span style="color:#66d9ef">else</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> symbol_or_bits), <span style="color:#ae81ff">2</span>)]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rotate</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Return the next rotation for this character.&#39;&#39;&#39;</span>

        <span style="color:#66d9ef">return</span> Character(tuple(self<span style="color:#f92672">.</span>bits[i] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>)))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rotations</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Generate all four of the rotations this character could have.&#39;&#39;&#39;</span>

        c <span style="color:#f92672">=</span> self
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>):
            <span style="color:#66d9ef">yield</span> c
            c <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span>rotate()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">can_neighbor</span>(self, other, side):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">        Test if this character can neighbor a given other on a given side.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Two characters can be neighbors if they either both have a line on that
</span><span style="color:#e6db74">        side or neither does. If other is not set, that is assumed to be a
</span><span style="color:#e6db74">        outside of the puzzle and thus not have a line.
</span><span style="color:#e6db74">        &#39;&#39;&#39;</span>

        my_bit, their_bit <span style="color:#f92672">=</span> Character<span style="color:#f92672">.</span>sides[side]

        <span style="color:#75715e"># print(side, self, other, my_bit, their_bit, self.bits, other.bits) # DEBUG</span>

        <span style="color:#66d9ef">if</span> other:
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>bits[my_bit] <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>bits[their_bit]
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>bits[my_bit]

    <span style="color:#66d9ef">def</span> __hash__(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Use the symbol as a hash. This is so we can put characters in sets.&#39;&#39;&#39;</span>

        <span style="color:#66d9ef">return</span> hash(self<span style="color:#f92672">.</span>symbol)

    <span style="color:#66d9ef">def</span> __eq__(self, other):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Characters are equal if they have the same symbol.&#39;&#39;&#39;</span>

        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>symbol <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>symbol

    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Print which character this is.&#39;&#39;&#39;</span>

        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>symbol</code></pre></div>
<p>After that, the next step will be to create a <code>Puzzle</code>. This is the grid of characters, but we&rsquo;ll actually go a step larger. Each cell in the <code>Puzzle</code> will actually be a set of rotations that are still possible. This means that as long as any cell has more than 1 possibility, it&rsquo;s not solved. If any has managed to reach 0, no solution is possible.</p>

<p>In addition, we&rsquo;ll put the constraining function here. This will loop through every single cell in the puzzle: for each, it will match each rotation remaining against each rotation of all four neighbors. If a given rotation cannot possibly match any one of the neighbors, remove it from the set. Imagine:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-test" data-lang="test">┛╸╸
╺┓╻
┗ ┣</code></pre></div>
<p>The middle character can originally be any of <code>{┏, ┓, ┛, ┗}</code>; however, the bottom center is an empty space, so we should not include any downward facing options. Thus, with a single round of constraint, we&rsquo;ve reduced the center tile to <code>{┛, ┗}</code>. Even better, this will further constrain the top center piece. At first it was <code>{╹, ╺, ╻, ╸}</code>, but the center has to have an upward pointing point, forcing the top center to be <code>{╻}</code>. Each round of constraints only sets each tile once and won&rsquo;t work recursively, but it&rsquo;s easy enough to call it more than once. Especially since the function will return <code>True</code> until the puzzle reaches a steady state.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Puzzle</span>(object):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Represent a grid of possible characters.&#39;&#39;&#39;</span>

    border <span style="color:#f92672">=</span> {Character(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39; &#39;</span>)}

    <span style="color:#66d9ef">def</span> __init__(self, data):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Initialize from a string containing characters.&#39;&#39;&#39;</span>

        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [
            [set(Character(c)<span style="color:#f92672">.</span>rotations()) <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> line]
            <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
        ]
        self<span style="color:#f92672">.</span>rows <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>data)
        self<span style="color:#f92672">.</span>cols <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>data[<span style="color:#ae81ff">0</span>])

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">possibilities</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">        Return the number of possibilities in the form (unsolved squares, total
</span><span style="color:#e6db74">        possibilities). A solved puzzle will return (0, rows * cols).
</span><span style="color:#e6db74">        &#39;&#39;&#39;</span>

        <span style="color:#66d9ef">return</span> (
            sum(<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">if</span> len(el) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>data <span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> row),
            sum(len(el) <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>data <span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> row)
        )

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_solvable</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Test if the puzzle is still solvable (no empty possibilities.)&#39;&#39;&#39;</span>

        <span style="color:#66d9ef">return</span> <span style="color:#f92672">not</span> any(
            len(el) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
            <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>data
            <span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> row
        )

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_solved</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;Test if this puzzle is currently solved.&#39;&#39;&#39;</span>

        <span style="color:#66d9ef">return</span> all(
            len(el) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>data
            <span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> row
        )

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">constrain</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">        Constrain this puzzle by removing any rotations that could not possibly
</span><span style="color:#e6db74">        be used (there&#39;s no possibility in the neighbor to match them).
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Only make one pass, call this function multiple times in case one
</span><span style="color:#e6db74">        constraint cascades.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Return if anything changed.
</span><span style="color:#e6db74">        &#39;&#39;&#39;</span>

        logging<span style="color:#f92672">.</span>debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Applying constraints, possiblities: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>possibilities()))

        offsets <span style="color:#f92672">=</span> [
            (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;top&#39;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>),
            (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;right&#39;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>),
            (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;bottom&#39;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>),
            (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;left&#39;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),
        ]

        something_changed <span style="color:#f92672">=</span> False

        <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>rows):
            <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>cols):
                invalid <span style="color:#f92672">=</span> set()
                <span style="color:#66d9ef">for</span> first_point <span style="color:#f92672">in</span> self[row, col]:
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> all(
                        any(
                            first_point<span style="color:#f92672">.</span>can_neighbor(second_point, direction)
                            <span style="color:#66d9ef">for</span> second_point <span style="color:#f92672">in</span> self[row <span style="color:#f92672">+</span> row_offset, col <span style="color:#f92672">+</span> col_offset]
                        ) <span style="color:#66d9ef">for</span> direction, row_offset, col_offset <span style="color:#f92672">in</span> offsets
                    ):
                        invalid<span style="color:#f92672">.</span>add(first_point)

                <span style="color:#66d9ef">for</span> impossibility <span style="color:#f92672">in</span> invalid:
                    something_changed <span style="color:#f92672">=</span> True
                    self[row, col]<span style="color:#f92672">.</span>remove(impossibility)

        <span style="color:#66d9ef">return</span> something_changed


    <span style="color:#66d9ef">def</span> __getitem__(self, pt):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">        Fetch the current possibility set from a given row and column.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        If the index is out of bounds, instead return a &#39;border character&#39; with
</span><span style="color:#e6db74">        no edges to help guarantee that no pieces point outwards.
</span><span style="color:#e6db74">        &#39;&#39;&#39;</span>


        row, col <span style="color:#f92672">=</span> pt
        <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;=</span> row <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>rows <span style="color:#f92672">and</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;=</span> col <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>cols:
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>data[row][col]
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> Puzzle<span style="color:#f92672">.</span>border

    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;If solved, print the puzzle; if not, print remaining possibilities.&#39;&#39;&#39;</span>

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>is_solved():
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(
                <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(str(list(el)[<span style="color:#ae81ff">0</span>]) <span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> row)
                <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>data
            )

        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pad_set</span>(el):
                <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(str(each) <span style="color:#66d9ef">for</span> each <span style="color:#f92672">in</span> el) <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> len(el))

            line_seperator <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;┈&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>cols <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>)) <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>

            <span style="color:#66d9ef">return</span> line_seperator<span style="color:#f92672">.</span>join(
                <span style="color:#e6db74"></span><span style="color:#e6db74">&#39; ┆ &#39;</span><span style="color:#f92672">.</span>join(pad_set(el) <span style="color:#66d9ef">for</span> el <span style="color:#f92672">in</span> row)
                <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>data
            )
            <span style="color:#66d9ef">return</span> repr(self<span style="color:#f92672">.</span>data)</code></pre></div>
<p>That&rsquo;s actually enough by itself to solve some puzzles. But sometimes, particularly in larger puzzles, you&rsquo;ll reach states where two arrangements are still possible. In those cases, we want to take a <a href="https://en.wikipedia.org/wiki/backtracking">backtracking</a> step: choose each of the possible states in turn and assume it is correct, switching back to the constraint solver until the next block. If a solution is found in that branch, just return. If not, try the next branch from that position.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">solve</span>(puzzle):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">    Use a hybrid constraint / backtracking solver to solve the puzzle.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    while not solved:
</span><span style="color:#e6db74">        apply constraint solver until it doesn&#39;t work any more
</span><span style="color:#e6db74">        find the first mismatched point and try each possibility
</span><span style="color:#e6db74">    &#39;&#39;&#39;</span>

    queue <span style="color:#f92672">=</span> [puzzle]
    <span style="color:#66d9ef">while</span> queue:
        puzzle <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>pop()
        logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Running backtracker, states: {}, possiblities in current state: {}&#39;</span><span style="color:#f92672">.</span>format(len(queue), puzzle<span style="color:#f92672">.</span>possibilities()))
        logging<span style="color:#f92672">.</span>debug(puzzle)

        <span style="color:#75715e"># Apply constraint until the constrain function returns false</span>
        <span style="color:#66d9ef">while</span> puzzle<span style="color:#f92672">.</span>constrain(): <span style="color:#66d9ef">pass</span>
        logging<span style="color:#f92672">.</span>debug(puzzle)

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> puzzle<span style="color:#f92672">.</span>is_solvable():
            logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Unsolveable state found, removing it&#39;</span>)
            <span style="color:#66d9ef">continue</span>

        <span style="color:#66d9ef">if</span> puzzle<span style="color:#f92672">.</span>is_solved():
            logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Solved state found, returning it&#39;</span>)
            <span style="color:#66d9ef">return</span> puzzle

        <span style="color:#75715e"># Split to backtracking</span>
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">first_unclear_point</span>():
            <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> range(puzzle<span style="color:#f92672">.</span>rows):
                <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> range(puzzle<span style="color:#f92672">.</span>cols):
                    <span style="color:#66d9ef">if</span> len(puzzle[row, col]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
                        <span style="color:#66d9ef">return</span> row, col, puzzle[row, col]

        row, col, possibilities <span style="color:#f92672">=</span> first_unclear_point()
        <span style="color:#66d9ef">for</span> possibility <span style="color:#f92672">in</span> possibilities:
            copied_puzzle <span style="color:#f92672">=</span> copy<span style="color:#f92672">.</span>deepcopy(puzzle)
            copied_puzzle[row, col]<span style="color:#f92672">.</span>clear()
            copied_puzzle[row, col]<span style="color:#f92672">.</span>add(possibility)

            queue<span style="color:#f92672">.</span>append(copied_puzzle)

    <span style="color:#75715e"># If we made it out of the loop, there is no solution to the puzzle</span>
    <span style="color:#66d9ef">return</span> None</code></pre></div>
<p>And that&rsquo;s it. We can solve puzzles from <code>stdin</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys
puzzle <span style="color:#f92672">=</span> Puzzle(sys<span style="color:#f92672">.</span>stdin<span style="color:#f92672">.</span>read())
solution <span style="color:#f92672">=</span> solve(puzzle)
<span style="color:#66d9ef">print</span>(solution)</code></pre></div>
<p>Example running:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat 10x10.loops

┗┣┃┃┗┏┳┓┛┏
┗┛┛━┳┫┃┃━━
┛┛━┓┳╋┫━┣┏
┫╋┻┛┛┻━┳╋┗
┛┳┃┳┃╋┫┃┳┗
┓━┓━┏╋┏┻╋┓
┛┛━┃┻┗┓┓┳┓
┏╋╋┏┏┳┣┗┗┗
┣╋╋┏┏┻┓┓┏┫
┏┏┗┫┣┳┳━┫┗

$ cat 10x10.loops | python3 loop-solver.py

┏┳━━┓┏┳┓┏┓
┗┛┏━┻┫┃┃┃┃
┏┓┃┏┳╋┫┃┣┛
┣╋┻┛┗┫┃┣╋┓
┗┻━┳━╋┫┃┣┛
┏━┓┃┏╋┛┣╋┓
┗┓┃┃┣┛┏┛┣┛
┏╋╋┛┗┳┻┓┗┓
┣╋╋┓┏┫┏┛┏┫
┗┛┗┻┻┻┻━┻┛</code></pre></div>
<p>Cool. Looking at this and several other puzzles, it seems like it would be a good generic framework to work out. Given a definition for a puzzle with an <code>is_valid</code> function (<code>can_neighbor</code> here), a <code>constrain</code> function, and the backtracking code above, it should be able to solve a large class of puzzles. <a href="https://en.wikipedia.org/wiki/Sudoku">Sudoku</a>, for example, or <a href="https://en.wikipedia.org/wiki/Hashi">Hashi</a>. Both puzzles I&rsquo;ve been working on solvers for. Even better, once you have a solver you can use it to generate puzzles with a difficulty gradient. Just solve each puzzle, keeping track of how many times you had to backtrack and how many were solved with the constraints.</p>

<p>And that&rsquo;s it. A fun little puzzle.</p>
	</div>

    
<div class="entry-comments">
    <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = "jverkamp";
            var disqus_title = "Solving Loop Puzzles";
            var disqus_url = "https:\/\/blog.jverkamp.com\/2016\/07\/14\/solving-loop-puzzles\/";

             
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


</article>

            </div>
        </div>

        <footer id="page-footer" role="contentinfo">
    <nav id="footer-navigation" role="navigation" class="ribbon">
        <ul class="main-navigation">
            <li><a href="/archive-by-date/">All posts: By Date</a></li>
            <li><a href="/archive-by-tag/">All posts: By Tag</a></li>

            <li>
                <a href="/atom.xml">
                    RSS: All <sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>

            
            <li>
                <a href="/programming/atom.xml">
                    RSS: programming<sup>

<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24">
    <path fill="white" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z" />
</svg>
</sup>
                </a>
            </li>
            
        </ul>
    </nav>

    <div id="page-footer-content">
        <div class="legal">
            <p>
                All posts unless otherwise mentioned are licensed under
                <a rel="license" href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                    <img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png">
                </a>
            </p>

            <p>
                Any source code unless otherwise mentioned is licensed under the <a href="//directory.fsf.org/wiki/License:BSD_3Clause">3 clause BSD license</a>
            </p>
        </div>
    </div>
</footer>

    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/nanogallery/4.4.2/jquery.nanogallery.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js" integrity="sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js"></script>

<script type="text/javascript" src="/custom.js" defer></script>

</body>
</html>

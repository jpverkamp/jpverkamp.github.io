<!doctype html><html>
<head>
<title>AoC 2016 Day 19: Blist Table â€“ jverkamp.com</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.css integrity=sha384-exe4Ak6B0EoJI0ogGxjJ8rn+RN3ftPnEQrGwX59KTCl5ybGzvHGKjhPKk/KC3abb crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot-default.min.css integrity="sha256-s0KLB0LnI5oqhHF8gkgfmxU4usUFEHlWJTxT8q72Tq4=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous>
<link href="https://fonts.googleapis.com/css?family=Spectral+SC|Lato|Share+Tech+Mono" rel=stylesheet>
<link rel=stylesheet href=/custom.css defer>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script>
</head>
<body>
<div id=wrapper><header id=page-header role=banner>
<h1><a href=/>JP's Blog</a></h1>
<ul id=page-header-links>
<li>
<a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a>
</li>
<li>
<form action=//www.google.com/search method=get onsubmit="(function(a){a.q.value='site:blog.jverkamp.com '+a.qfront.value})(this)" class="navbar-form navbar-right" role=search _lpchecked=1>
<div class=form-group>
<input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button>
</div>
</form>
</li>
</ul>
<nav id=header-navigation role=navigation class=ribbon>
<ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li>
</ul>
</nav>
</header>
<div id=page-content-wrapper>
<div id=page-content><article>
<header>
<h1 class=entry-title>AoC 2016 Day 19: Blist Table</h1>
<div class=entry-meta><span class=entry-date>2016-12-19</span>
</div>
<div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li>
<a class=taxonomy-key href=/programming/languages/>Languages</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2016/12/18/aoc-2016-day-18-its-a-trap/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2016/12/20/aoc-2016-day-20-filter-table/ class=next-link></a></li></ul>
</li><li>
<a class=taxonomy-key href=/programming/sources/>Sources</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2016/12/18/aoc-2016-day-18-its-a-trap/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/advent-of-code>Advent of Code</a><a href=https://blog.jverkamp.com/2016/12/20/aoc-2016-day-20-filter-table/ class=next-link></a></li></ul>
</li><li>
<a class=taxonomy-key href=/series/>Series</a>
<ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2016/12/18/aoc-2016-day-18-its-a-trap/ class=previous-link></a><a class=taxonomy-value href=/series/advent-of-code-2016>Advent of Code 2016</a><a href=https://blog.jverkamp.com/2016/12/20/aoc-2016-day-20-filter-table/ class=next-link></a></li></ul>
</li><li><a class=taxonomy-key href=/programming>programming</a>
<ul>
<li><a href=https://blog.jverkamp.com/2016/12/18/aoc-2016-day-18-its-a-trap/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2016/12/20/aoc-2016-day-20-filter-table/ class=next-link>Next</a></ul>
</li><li><a class=taxonomy-key href=/>All Posts</a>
<ul>
<li><a href=https://blog.jverkamp.com/2016/12/18/aoc-2016-day-18-its-a-trap/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2016/12/20/harry-potter-and-the-deathly-hallows/ class=next-link>Next</a></ul>
</li></ul>
</div>
</div>
</header>
<div class=entry-content><h3 id=source-an-elephant-named-josephhttpadventofcodecom2016day19>Source: <a href=http://adventofcode.com/2016/day/19>An Elephant Named Joseph</a></h3>
<blockquote>
<p><strong>Part 1:</strong> Create a <a href=https://en.wikipedia.org/wiki/circular%20list>circular list</a> of the numbers <code>1</code> through <code>n</code>. Going around the list, each currently remaining number removes the number after it. What is the last remaining number?</p>
</blockquote>
<p>I had a bit of fun with this solution, since I solved it with an infinite lazy list.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>last_elf_standing</span>(size):
    sad_elves <span style=color:#f92672>=</span> set()

    <span style=color:#75715e># The magic of lazy evaluation...</span>
    elves <span style=color:#f92672>=</span> filter(<span style=color:#66d9ef>lambda</span> e : e <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> sad_elves, itertools<span style=color:#f92672>.</span>cycle(range(<span style=color:#ae81ff>1</span>, size <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)))

    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
        happy_elf <span style=color:#f92672>=</span> next(elves)
        sad_elf <span style=color:#f92672>=</span> next(elves)
        sad_elves<span style=color:#f92672>.</span>add(sad_elf)

        <span style=color:#75715e># A single elf is happy because they have lots of presents</span>
        <span style=color:#75715e># But sad since they have no friends</span>
        <span style=color:#66d9ef>if</span> happy_elf <span style=color:#f92672>==</span> sad_elf:
            <span style=color:#66d9ef>return</span> happy_elf

        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> took presents from </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> elves remain&#39;</span><span style=color:#f92672>.</span>format(
            happy_elf,
            sad_elf,
            size <span style=color:#f92672>-</span> len(sad_elves),
        ))

print(<span style=color:#e6db74>&#39;Last elf standing (sitting?): </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(last_elf_standing(args<span style=color:#f92672>.</span>size)))
</code></pre></div><p>The basic idea is that we take the list of elves (<code>range(1, size + 1)</code>), make it infinitely repeating (<code><a href="https://docs.python.org/3/search.html?q=itertools.cycle">itertools.cycle</a></code>
), and filter out elves we&rsquo;ve removed (<code><a href="https://docs.python.org/3/search.html?q=filter">filter</a></code>
). Once we&rsquo;ve removed enough that two adjacent elements are the same, we have the last remaining element. It&rsquo;s fast too.</p>
<blockquote>
<p><strong>Part 2:</strong> Rather than removing the number immediately after the current number, remove the one half way around the board (breaking ties by rounding down).</p>
</blockquote>
<p>Despite being quite simple to describe, this one is actually quite a bit more difficult. My first solution was to create a <code>Table</code> class that could remove arbitrary elements and use that:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Table</span>(object):
    <span style=color:#66d9ef>def</span> __init__(self, size, function):
        self<span style=color:#f92672>.</span>_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
        self<span style=color:#f92672>.</span>_size <span style=color:#f92672>=</span> size
        self<span style=color:#f92672>.</span>_elves <span style=color:#f92672>=</span> list(range(<span style=color:#ae81ff>1</span>, size <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))
        self<span style=color:#f92672>.</span>_function <span style=color:#f92672>=</span> function

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>remove_one</span>(self):
        <span style=color:#66d9ef>if</span> len(self<span style=color:#f92672>.</span>_elves) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>:
            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(<span style=color:#e6db74>&#39;Last elf standing&#39;</span>)

        happy_elf <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_elves[self<span style=color:#f92672>.</span>_index]

        to_remove <span style=color:#f92672>=</span> eval(self<span style=color:#f92672>.</span>_function, globals(), {
            <span style=color:#e6db74>&#39;index&#39;</span>: self<span style=color:#f92672>.</span>_index,
            <span style=color:#e6db74>&#39;size&#39;</span>: self<span style=color:#f92672>.</span>_size,
            <span style=color:#e6db74>&#39;count&#39;</span>: len(self<span style=color:#f92672>.</span>_elves),
        })
        to_remove <span style=color:#f92672>%=</span> len(self<span style=color:#f92672>.</span>_elves)
        sad_elf <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_elves[to_remove]

        self<span style=color:#f92672>.</span>_elves<span style=color:#f92672>.</span>pop(to_remove)
        self<span style=color:#f92672>.</span>_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>_index <span style=color:#f92672>&gt;</span> len(self<span style=color:#f92672>.</span>_elves):
            self<span style=color:#f92672>.</span>_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>last_elf_standing</span>(self):
        <span style=color:#66d9ef>while</span> len(self<span style=color:#f92672>.</span>_elves) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>:
            self<span style=color:#f92672>.</span>remove_one()
        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_elves[<span style=color:#ae81ff>0</span>]

table <span style=color:#f92672>=</span> Table(args<span style=color:#f92672>.</span>size, args<span style=color:#f92672>.</span>function)
last_elf <span style=color:#f92672>=</span> table<span style=color:#f92672>.</span>last_elf_standing()
print(<span style=color:#e6db74>&#39;Last elf standing (sitting?): </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(last_elf))
</code></pre></div><p>Although this does work, the problem with it is that it&rsquo;s <strong>very</strong> slow. This is because Python lists are implemented under the hood as an array of contiguous values in memory. When you remove an element from the middle of the list, you have to copy everything that was after it down a spot. Arbitrarily doing that a few million times takes a while.</p>
<p>The solution was sound. We just needed a better data structure. Enter: <a href=blist>https://pypi.python.org/pypi/blist/</a>. Essentially, it&rsquo;s a list implemented under the hood as a <a href=https://en.wikipedia.org/wiki/binary%20tree>binary tree</a>. This gives you <code>O(log n)</code> removal, so that rather than taking over a million cycles on average (at the start), it takes <span class=latex-inline>log(1,000,000) \equiv 14</span>
.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>last_elf_standing</span>(size, function <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
    index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    elves <span style=color:#f92672>=</span> blist<span style=color:#f92672>.</span>blist(range(<span style=color:#ae81ff>1</span>, size <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))

    <span style=color:#66d9ef>while</span> len(elves) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>:
        happy_elf <span style=color:#f92672>=</span> elves[index]

        <span style=color:#66d9ef>if</span> function:
            sad_elf_index <span style=color:#f92672>=</span> eval(args<span style=color:#f92672>.</span>function, globals(), {
                <span style=color:#e6db74>&#39;index&#39;</span>: index,
                <span style=color:#e6db74>&#39;size&#39;</span>: size,
                <span style=color:#e6db74>&#39;count&#39;</span>: len(elves),
            })
        <span style=color:#66d9ef>else</span>:
            sad_elf_index <span style=color:#f92672>=</span> index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>

        sad_elf_index <span style=color:#f92672>%=</span> len(elves)

        sad_elf <span style=color:#f92672>=</span> elves[sad_elf_index]
        <span style=color:#66d9ef>del</span> elves[sad_elf_index]

        <span style=color:#75715e># If we removed an elf before us, the index doesn&#39;t change (the elf at that index does)</span>
        <span style=color:#66d9ef>if</span> sad_elf_index <span style=color:#f92672>&gt;=</span> index:
            index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
        index <span style=color:#f92672>%=</span> len(elves)

    <span style=color:#66d9ef>return</span> elves[<span style=color:#ae81ff>0</span>]

last_elf <span style=color:#f92672>=</span> last_elf_standing(args<span style=color:#f92672>.</span>size, args<span style=color:#f92672>.</span>function)
print(<span style=color:#e6db74>&#39;Last elf standing (sitting?): </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(last_elf))
</code></pre></div><p>Much faster. It only takes a few seconds on my machine to crank through removing over 3 million elements from a list in semi-random ordering.</p>
<p>The comment there about not changing the index if we removed an elf earlier in the list took a little while to debug. It doesn&rsquo;t happen in the example they gave (too small). It wasn&rsquo;t until I stepped through a larger example on paper that I figured out what was going on there.</p></div>
</article></div>
</div><footer id=page-footer role=contentinfo>
<nav id=footer-navigation role=navigation class=ribbon>
<ul class=main-navigation>
<li><a href=/archive-by-date/>All posts: By Date</a></li>
<li><a href=/archive-by-tag/>All posts: By Tag</a></li>
<li>
<a href=/atom.xml>
RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li><li>
<a href=/programming/atom.xml>
RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
</sup>
</a>
</li></ul>
</nav>
<div id=page-footer-content>
<div class=legal>
<p>
All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US>
<img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png>
</a>
</p>
<p>
Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a>
</p>
</div>
</div>
</footer>
</div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js integrity="sha256-yDarFEUo87Z0i7SaC6b70xGAKCghhWYAZ/3p+89o4lE=" crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-alpha2/katex.min.js integrity=sha384-OMvkZ24ANLwviZR2lVq8ujbE/bUO8IR1FdBrKLQBI14Gq5Xp/lksIccGkmKL8m+h crossorigin=anonymous></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/bigfoot/2.1.4/bigfoot.min.js integrity="sha256-2ylggML6rCJMc817KbE8Cx+cuxYIM+6bjG2Gpq2g7iU=" crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script defer>mermaid.initialize({startOnLoad:!0,securityLevel:'loose'})</script>
<script defer src=/custom.js></script>
</body>
</html>
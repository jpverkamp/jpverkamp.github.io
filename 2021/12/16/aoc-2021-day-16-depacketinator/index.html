<!doctype html><html><head><title>AoC 2021 Day 16: Depacketinator â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.8c7d803d89ebdecf2416d468f4ecb981a3acf645154a7a336f2e5d0190ea8163.js integrity="sha256-jH2APYnr3s8kFtRo9Oy5gaOs9kUVSnozby5dAZDqgWM=" defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.921ca906a32e718ab61ac0b4da24e0eaa6bdd41912654a33b44bd3fc2f0c2a4d.js integrity="sha256-khypBqMucYq2GsC02iTg6qa91BkSZUoztEvT/C8MKk0=" defer></script>
<script src=/katex_12008035502722260518.min.1c3dce03daaf56a7d2fe0d0ec49bf35256837226f835adaf52c09502ef9bc5d1.js integrity="sha256-HD3OA9qvVqfS/g0OxJvzUlaDcib4Na2vUsCVAu+bxdE=" defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js integrity="sha256-XoC9heuuuVYHg01nd7/nAT0dFh8PAqMbhF5L12WJgxY=" defer></script>
<script src=/mermaid_12365941879912544862.min.973b5415b3fa1835d620c0e58236f859d5f80891f447e240cbbb9eb825251ff0.js integrity="sha256-lztUFbP6GDXWIMDlgjb4WdX4CJH0R+JAy7ueuCUlH/A=" defer></script>
<script src=/main.min.982c2d7bb434b4cf8b19c2cf38ef7e7f7162ddbed610e5bdddbb937001e26574.js integrity="sha256-mCwte7Q0tM+LGcLPOO9+f3Fi3b7WEOW93buTcAHiZXQ=" defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css integrity="sha256-FrrNWfsiSubJenSasKwecIy14MnOXJoI1/1z3I5pQp8="><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css integrity="sha256-8V1PqkUZrduXb51ptCvZ60kbNZa2su2oOqPp4fSLjxQ="><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css integrity="sha256-4otdfZ2J76y19wisMMvXaxuaD4Ft/Z2pZjHR0Jy73XY="><link rel=stylesheet href=/css_4780214198035419921.min.246b6f8e7620eeb717bca5e7b121037906e5dfaa05805f427fcc5a09b6c99f5c.css integrity="sha256-JGtvjnYg7rcXvKXnsSEDeQbl36oFgF9Cf8xaCbbJn1w="><link rel=stylesheet href=/main.min.e0e68b86dea32185ab89b0b9cc01649107cc6b0be3290c8c7b13c716bc0dabfa.css integrity="sha256-4OaLht6jIYWribC5zAFkkQfMawvjKQyMexPHFrwNq/o="></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>AoC 2021 Day 16: Depacketinator</h1><div class=entry-meta><span class=entry-date>2021-12-16</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/15/aoc-2021-day-15-low-ceiling-simulator/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2021/12/17/aoc-2021-day-17-pew-pewinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/15/aoc-2021-day-15-low-ceiling-simulator/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/advent-of-code>Advent of Code</a><a href=https://blog.jverkamp.com/2021/12/17/aoc-2021-day-17-pew-pewinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/12/aoc-2021-day-12-submarine-spider/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2021/12/18/aoc-2021-day-18-pairs-of-pairs/ class=next-link></a></li><li><a class=taxonomy-value href=/programming/topics/network>Network</a></li><li><a href=https://blog.jverkamp.com/2021/12/10/aoc-2021-day-10-chunkinator/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/parsing>Parsing</a><a href=https://blog.jverkamp.com/2021/12/24/aoc-2021-day-24-aluinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/15/aoc-2021-day-15-low-ceiling-simulator/ class=previous-link></a><a class=taxonomy-value href=/series/advent-of-code-2021>Advent of Code 2021</a><a href=https://blog.jverkamp.com/2021/12/17/aoc-2021-day-17-pew-pewinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2021/12/15/aoc-2021-day-15-low-ceiling-simulator/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2021/12/17/aoc-2021-day-17-pew-pewinator/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2021/12/15/aoc-2021-day-15-low-ceiling-simulator/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2021/12/17/aoc-2021-day-17-pew-pewinator/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><h3 id=source-packet-decoderhttpsadventofcodecom2021day16>Source: <a href=https://adventofcode.com/2021/day/16 target=_blank rel=noopener>Packet Decoder</a></h3><h4 id=part-1-given-a-recursive-binary-packet-definition-see-below-parse-the-given-packet-return-the-sum-of-each-packets-version><strong>Part 1:</strong> Given a recursive binary packet definition (see below), parse the given packet. Return the sum of each packet&rsquo;s <code>version</code>.</h4><p>All packet fields are in bits. Possible packet formats:</p><table><thead><tr><th>Name</th><th>Structure</th></tr></thead><tbody><tr><td>Literal Value</td><td><code>AAA 010 [1CCCC]* [1CCCC]</code></td></tr><tr><td>Type 0 Operator</td><td><code>AAA BBB 0 DDDDDDDDDDDDDDD (children)</code></td></tr><tr><td>Type 1 Operator</td><td><code>AAA BBB 1 EEEEEEEEEEE (children)</code></td></tr></tbody></table><p>In all packets:</p><ul><li><code>AAA</code> - 3 bits representing the <code>version</code> of the packet</li><li><code>BBB</code> - 3 bits representing the <code>type_id</code> of the packet</li></ul><p>In literal packets&ndash;where <code>type_id</code> = 4 (<code>010</code>)&ndash;the value is an integer encoded in a value similar to <a href=https://en.wikipedia.org/wiki/UTF-8%20encoding>UTF-8 encoding</a>. There will be a sequence of 0 or more 5 bit values <code>1CCCC</code> (with the <code>1</code> indicating the number continues, followed by a single <code>0CCCC</code> segment, ending the value. These <code>C*</code>s will be concatenated and treated as a single unsigned binary value and converted to an integer.</p><p>In Type 0 Operator packets, the next 15 bits (<code>D{15}</code>) should be interpreted as an unsigned integer containing the number of following bits that encode &lsquo;child&rsquo; packets. Parse the following <code>D</code> bits as child packets (perhaps recursively) and attach those to the Type 0 Operator as children.</p><p>In Type 1 Operator packets, the next 11 bits (<code>E{11}</code>) should be interpreted as an unsigned integer containing the number of child packets (instead of their length). Parse that many child packets (perhaps recursively, only top level children count towards this number <code>E</code>) and attach those to the Type 1 Operator as children.</p><p>Yeah, that&rsquo;s a mouthful. But it&rsquo;s a pretty awesome excuse to use a few techniques that are common in parsing binary encodings, such as network packets.</p><p>First things first, I want to make a <code>BitStream</code> class that can take in the data that&rsquo;s going to make up our packets and keep track of where we are. That way, we can read out an arbitrary number of bits (3, 1, 4, 15, and 11 bits in this case, depending on the structure) as whatever types we need:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BitStream</span>:
</span></span><span style=display:flex><span>    index: int
</span></span><span style=display:flex><span>    data: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>from_hex</span>(hex_data: str) <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;BitStream&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BitStream(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{:04b}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(int(c, <span style=color:#ae81ff>16</span>)) <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> hex_data
</span></span><span style=display:flex><span>        ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_bits</span>(self, n: int) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Read n bits from the current position in the bitsting as a string of 0/1&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>data[self<span style=color:#f92672>.</span>index:self<span style=color:#f92672>.</span>index<span style=color:#f92672>+</span>n]
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>index <span style=color:#f92672>+=</span> n
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>index <span style=color:#f92672>&gt;</span> len(self<span style=color:#f92672>.</span>data):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> BitStreamException(<span style=color:#e6db74>&#39;Attempted to read past the end of bitstream&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_int</span>(self, n: int) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Read n bits from the current position and convert to an integer&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> int(self<span style=color:#f92672>.</span>read_bits(n), <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_bool</span>(self) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Read the next bit from the current position as True/False&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>read_bits(<span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __str__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>index <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span> <span style=color:#f92672>&lt;</span> len(self<span style=color:#f92672>.</span>data):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;&lt;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>index<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>len(self<span style=color:#f92672>.</span>data)<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>data[self<span style=color:#f92672>.</span>index:self<span style=color:#f92672>.</span>index<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>...&gt;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;&lt;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>index<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>len(self<span style=color:#f92672>.</span>data)<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>data[self<span style=color:#f92672>.</span>index:]<span style=color:#e6db74>}</span><span style=color:#e6db74>&gt;&#39;</span>
</span></span></code></pre></div><p>That&rsquo;s actually not that bad, I don&rsquo;t think. It&rsquo;s a bit interesting that we&rsquo;re mostly reading in <code>from_hex</code>, but that just means take each single hex character, turn it into an integer with <code>int(c, 16)</code> and then print that as a fixed four bits with <code>{:04b}.format(...)</code>. Other than that, <code>read_bits</code> will read n bits and advance the current pointer into the stream, and <code>read_int</code> / <code>read_bool</code> will wrap that to read a specific kind of value.</p><p>With all that, we should be ready to parse the packets:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Packet</span>:
</span></span><span style=display:flex><span>    version: int
</span></span><span style=display:flex><span>    type_id: int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    value: int
</span></span><span style=display:flex><span>    children: List[<span style=color:#e6db74>&#39;Packet&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    length: int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>from_hex</span>(hex: str) <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;Packet&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Packet<span style=color:#f92672>.</span>from_bitstream(BitStream<span style=color:#f92672>.</span>from_hex(hex))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>from_bitstream</span>(bits: BitStream, _depth: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;Packet&#39;</span>:
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74>Parsing new packet at </span><span style=color:#e6db74>{</span>bits<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        version <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_int(<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>        type_id <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_int(<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>        length <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        children <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>version<span style=color:#e6db74>=}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>type_id<span style=color:#e6db74>=}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Literal values</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> type_id <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>:
</span></span><span style=display:flex><span>            logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - Mode=literal&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            keep_reading <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> keep_reading:
</span></span><span style=display:flex><span>                keep_reading <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_bool()
</span></span><span style=display:flex><span>                byte <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_int(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - Read byte </span><span style=color:#e6db74>{</span>byte<span style=color:#e6db74>}</span><span style=color:#e6db74>, will continue: </span><span style=color:#e6db74>{</span>keep_reading<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                value <span style=color:#f92672>=</span> value <span style=color:#f92672>*</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>+</span> byte
</span></span><span style=display:flex><span>                length <span style=color:#f92672>+=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Any other operator value</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># The next bit is the length_type_id</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># If it&#39;s set, read the number of bits in subpackets</span>
</span></span><span style=display:flex><span>            length <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> bits<span style=color:#f92672>.</span>read_bool():
</span></span><span style=display:flex><span>                length <span style=color:#f92672>+=</span> <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>                number_of_children <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_int(<span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - Mode=operator, length_type=1 (</span><span style=color:#e6db74>{</span>number_of_children<span style=color:#e6db74>}</span><span style=color:#e6db74> children)&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(number_of_children):
</span></span><span style=display:flex><span>                    child <span style=color:#f92672>=</span> Packet<span style=color:#f92672>.</span>from_bitstream(bits, _depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                    children<span style=color:#f92672>.</span>append(child)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    length <span style=color:#f92672>+=</span> child<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># If it&#39;s not, read the number of subpackets</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                length <span style=color:#f92672>+=</span> <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>                body_length <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_int(<span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - Mode=operator, length_type=0 (</span><span style=color:#e6db74>{</span>body_length<span style=color:#e6db74>}</span><span style=color:#e6db74> bits)&#39;</span>)
</span></span><span style=display:flex><span>                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>len(bits<span style=color:#f92672>.</span>data)<span style=color:#f92672>-</span>bits<span style=color:#f92672>.</span>index<span style=color:#e6db74>}</span><span style=color:#e6db74> of </span><span style=color:#e6db74>{</span>len(bits<span style=color:#f92672>.</span>data)<span style=color:#e6db74>}</span><span style=color:#e6db74> remaining&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> body_length:
</span></span><span style=display:flex><span>                    child <span style=color:#f92672>=</span> Packet<span style=color:#f92672>.</span>from_bitstream(bits, _depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                    children<span style=color:#f92672>.</span>append(child)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    body_length <span style=color:#f92672>-=</span> child<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span>                    length <span style=color:#f92672>+=</span> child<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - New child used </span><span style=color:#e6db74>{</span>child<span style=color:#f92672>.</span>length<span style=color:#e6db74>}</span><span style=color:#e6db74> bits, </span><span style=color:#e6db74>{</span>body_length<span style=color:#e6db74>}</span><span style=color:#e6db74> remaining&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> body_length <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>raise</span> PacketParseException(<span style=color:#e6db74>&#39;Could not parse packet, too many bits used by children&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        p <span style=color:#f92672>=</span> Packet(version, type_id, value, children, length)
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> \ Packet parsed: </span><span style=color:#e6db74>{</span>p<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> p
</span></span></code></pre></div><p>There&rsquo;s a fair amount of debugging code in there&mldr; because this took a bit to get right. And all for a relatively simple mistake. Essentially, we start by taking the bit stream and reading the <code>value</code> and <code>type_id</code>. That is always 6 bits. After that, there&rsquo;s a special case for <code>type_id = 4</code>: literals. That&rsquo;s the first half of the <code>if</code>. In there, we&rsquo;re going to read 1 + 4 bits at a time until the first bit is 0, adding the other 4 bits as an ever growing base 16 literal. Pretty cool!</p><p>The other two cases depend on the next bit read with <code>bits.read_bool()</code>. If it&rsquo;s 0, we&rsquo;re parsing a specific number of children. That one&rsquo;s not so bad, because we can just read off <code>Packet.from_bitstream</code> at the current point for that many children. But we absolutely have to update the length because of the next case:</p><p>If the <code>bits.read_bool()</code> was 1. In this case, we only know how many bits the child packets are made of. This is actually the more common method in network and other binary formats I&rsquo;ve found, because it lets you skip parsing if you don&rsquo;t actually care about the children. You can just jump ahead that many bits. In the above case with a number of children, you have no idea how large those children actually are, so you have to parse them.</p><p>In any case, we now have perfectly functional parsing of packets. It&rsquo;s pretty cool to see it work too:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> Packet<span style=color:#f92672>.</span>from_hex(<span style=color:#e6db74>&#39;D2FE28&#39;</span>)
</span></span><span style=display:flex><span>Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>2021</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>21</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> Packet<span style=color:#f92672>.</span>from_hex(<span style=color:#e6db74>&#39;38006F45291200&#39;</span>)
</span></span><span style=display:flex><span>Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, children<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>),
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>], length<span style=color:#f92672>=</span><span style=color:#ae81ff>49</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> Packet<span style=color:#f92672>.</span>from_hex(<span style=color:#e6db74>&#39;EE00D40C823060&#39;</span>)
</span></span><span style=display:flex><span>Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, children<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>), 
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>), 
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>], length<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span>)
</span></span></code></pre></div><p>I like reading the debug view as well (which is good, since I spent a while staring at it&mldr;)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> Packet<span style=color:#f92672>.</span>from_hex(<span style=color:#e6db74>&#39;EE00D40C823060&#39;</span>)
</span></span><span style=display:flex><span>INFO Parsing new packet at <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span><span style=color:#f92672>/</span><span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>11101110.</span><span style=color:#f92672>..&gt;</span>
</span></span><span style=display:flex><span>INFO  <span style=color:#f92672>-</span> version<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>INFO  <span style=color:#f92672>-</span> Mode<span style=color:#f92672>=</span>operator, length_type<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> (<span style=color:#ae81ff>3</span> children)
</span></span><span style=display:flex><span>INFO  Parsing new packet at <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>18</span><span style=color:#f92672>/</span><span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>01010000.</span><span style=color:#f92672>..&gt;</span>
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> Mode<span style=color:#f92672>=</span>literal
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> Read byte <span style=color:#ae81ff>1</span>, will <span style=color:#66d9ef>continue</span>: <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>INFO   \ Packet parsed: Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>INFO  Parsing new packet at <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>29</span><span style=color:#f92672>/</span><span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>10010000.</span><span style=color:#f92672>..&gt;</span>
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> Mode<span style=color:#f92672>=</span>literal
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> Read byte <span style=color:#ae81ff>2</span>, will <span style=color:#66d9ef>continue</span>: <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>INFO   \ Packet parsed: Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>INFO  Parsing new packet at <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>40</span><span style=color:#f92672>/</span><span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>00110000.</span><span style=color:#f92672>..&gt;</span>
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> Mode<span style=color:#f92672>=</span>literal
</span></span><span style=display:flex><span>INFO   <span style=color:#f92672>-</span> Read byte <span style=color:#ae81ff>3</span>, will <span style=color:#66d9ef>continue</span>: <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>INFO   \ Packet parsed: Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>INFO  \ Packet parsed: Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, children<span style=color:#f92672>=</span>[Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>), Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>), Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>)], length<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, children<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>), 
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>), 
</span></span><span style=display:flex><span>    Packet(version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, type_id<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, value<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, children<span style=color:#f92672>=</span>[], length<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>], length<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span>)
</span></span></code></pre></div><p>Neat!</p><p>Wrap it to actually satisfy the actual prompt (sum all <code>versions</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>part1</span>(file: typer<span style=color:#f92672>.</span>FileText):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sum_versions</span>(p: Packet) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> p<span style=color:#f92672>.</span>version <span style=color:#f92672>+</span> sum(sum_versions(child) <span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> p<span style=color:#f92672>.</span>children)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Packet<span style=color:#f92672>.</span>from_hex(file<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>strip())
</span></span><span style=display:flex><span>    logging<span style=color:#f92672>.</span>info(p)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>sum_versions(p)<span style=color:#e6db74>:</span><span style=color:#e6db74>-16</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>line<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span></code></pre></div><p>And that&rsquo;s it. A nice recursive <code>sum_versions</code> that looks into <code>children</code> if there are any, summing as it goes. Nice. So&mldr; how does it work on the given input?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> python3 depacketinator<span style=color:#f92672>.</span>py part1 input<span style=color:#f92672>.</span>txt
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>981</span> <span style=color:#ae81ff>0055.</span><span style=color:#f92672>...</span>C000
</span></span><span style=display:flex><span><span style=color:#75715e># time 63753417ns / 0.06s</span>
</span></span></code></pre></div><p>Nice. Quick too.</p><p>So&mldr; while we&rsquo;re here, what was the error that took me forever to figure out? Originally, my <code>else</code> block (the type 0/1 operators) looked like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Any other operator value</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># The next bit is the length_type_id</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># If it&#39;s set, read the number of bits in subpackets</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> bits<span style=color:#f92672>.</span>read_bool():
</span></span><span style=display:flex><span>                number_of_children <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_int(<span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - Mode=operator, length_type=1 (</span><span style=color:#e6db74>{</span>number_of_children<span style=color:#e6db74>}</span><span style=color:#e6db74> children)&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(number_of_children):
</span></span><span style=display:flex><span>                    child <span style=color:#f92672>=</span> Packet<span style=color:#f92672>.</span>from_bitstream(bits, _depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                    children<span style=color:#f92672>.</span>append(child)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    length <span style=color:#f92672>+=</span> child<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># If it&#39;s not, read the number of subpackets</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                body_length <span style=color:#f92672>=</span> bits<span style=color:#f92672>.</span>read_int(<span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - Mode=operator, length_type=0 (</span><span style=color:#e6db74>{</span>body_length<span style=color:#e6db74>}</span><span style=color:#e6db74> bits)&#39;</span>)
</span></span><span style=display:flex><span>                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>len(bits<span style=color:#f92672>.</span>data)<span style=color:#f92672>-</span>bits<span style=color:#f92672>.</span>index<span style=color:#e6db74>}</span><span style=color:#e6db74> of </span><span style=color:#e6db74>{</span>len(bits<span style=color:#f92672>.</span>data)<span style=color:#e6db74>}</span><span style=color:#e6db74> remaining&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> body_length:
</span></span><span style=display:flex><span>                    child <span style=color:#f92672>=</span> Packet<span style=color:#f92672>.</span>from_bitstream(bits, _depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                    children<span style=color:#f92672>.</span>append(child)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    body_length <span style=color:#f92672>-=</span> child<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span>                    length <span style=color:#f92672>+=</span> child<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> - New child used </span><span style=color:#e6db74>{</span>child<span style=color:#f92672>.</span>length<span style=color:#e6db74>}</span><span style=color:#e6db74> bits, </span><span style=color:#e6db74>{</span>body_length<span style=color:#e6db74>}</span><span style=color:#e6db74> remaining&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> body_length <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>raise</span> PacketParseException(<span style=color:#e6db74>&#39;Could not parse packet, too many bits used by children&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        p <span style=color:#f92672>=</span> Packet(version, type_id, value, children, length)
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>*</span> _depth<span style=color:#e6db74>}</span><span style=color:#e6db74> \ Packet parsed: </span><span style=color:#e6db74>{</span>p<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> p
</span></span></code></pre></div><p>Pretty much the same, no?</p><p>Well, actually there are three very important lines missing. Three lines that, because of how the test packet lengths worked out, led to a number of hard to debug errors, but only in <em>some</em> of the test cases.</p><p>Any guesses? Look back and compare?</p><p>Turns out, you absolutely need to have the correct lengths for nested operator packets. So 1 bit for the type and either 15 or 11 for the count. It only matters if you have a Type 1 packet with non-literals inside of it (so at least two levels of nesting), otherwise the lengths work well enough, but in that case, it certainly got tricky. It kept looking for more information when there just weren&rsquo;t any more bits to be had.</p><p>Oh, debuggging.</p><p>I really should be writing better test cases, but in this case, that wouldn&rsquo;t have necessarily helped. I <em>knew</em> which test was failing, I just didn&rsquo;t know (at first) <em>why</em>. Live and learn.</p><h4 id=part-2-given-the-following-type_id-to-function-mappings-evaluate-the-packet><strong>Part 2:</strong> Given the following <code>type_id</code> to function mappings, evaluate the packet.</h4><ul><li><code>0</code>: <code>sum</code> of the values of child packets</li><li><code>1</code>: <code>product</code> of the values of child packets</li><li><code>2</code>: <code>minimum</code> of the values of child packets</li><li><code>3</code>: <code>maximum</code> of the values of child packets</li><li><code>4</code>: <code>literal</code> values (see above)</li><li><code>5</code>: will have exactly two child packets, <code>1</code> if <code>a > b</code> else <code>0</code></li><li><code>6</code>: will have exactly two child packets, <code>1</code> if <code>a &lt; b</code> else <code>0</code></li><li><code>7</code>: will have exactly two child packets, <code>1</code> if <code>a = b</code> else <code>0</code></li></ul><p>Well, we did the hard part. We just have to change the recursive function. Instead of summing values, we need to evaluate the children then apply the given function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.command</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>part2</span>(file: typer<span style=color:#f92672>.</span>FileText):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>prod</span>(ls):
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> el <span style=color:#f92672>in</span> ls:
</span></span><span style=display:flex><span>            result <span style=color:#f92672>*=</span> el
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    operators: Mapping[int, Callable[[List[int]], int]] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0</span>: sum,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>1</span>: prod,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>2</span>: min,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>3</span>: max,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>5</span>: <span style=color:#66d9ef>lambda</span> ab: <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>if</span> ab[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&gt;</span> ab[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>6</span>: <span style=color:#66d9ef>lambda</span> ab: <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>if</span> ab[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;</span> ab[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>7</span>: <span style=color:#66d9ef>lambda</span> ab: <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>if</span> ab[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> ab[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>a_better_eval</span>(p: Packet) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Literal values first</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> p<span style=color:#f92672>.</span>type_id <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>:
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Otherwise, parse children</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            values <span style=color:#f92672>=</span> [a_better_eval(child) <span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> p<span style=color:#f92672>.</span>children]
</span></span><span style=display:flex><span>            f <span style=color:#f92672>=</span> operators[p<span style=color:#f92672>.</span>type_id]
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> f(values)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;a_better_eval(</span><span style=color:#e6db74>{</span>p<span style=color:#e6db74>}</span><span style=color:#e6db74>) = </span><span style=color:#e6db74>{</span>result<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Packet<span style=color:#f92672>.</span>from_hex(line<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>strip())
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>a_better_eval(p)<span style=color:#e6db74>:</span><span style=color:#e6db74>-16</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>line<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span></code></pre></div><p>And of course, this one worked first try:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 depacketinator.py part2 input.txt
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>299227024091</span> 0055...C000
</span></span><span style=display:flex><span><span style=color:#75715e># time 40238833ns / 0.04s</span>
</span></span></code></pre></div><p>Pretty fun.</p><p>I&rsquo;ve really enjoyed the last few days of these puzzles! In the world of the more common web apps, where space isn&rsquo;t really an issue and everything is sent in something as verbose as JSON, it&rsquo;s kind of fun to actually get down into really compact formats where the equivalent of a single 8-bit character can store 3+ fields.</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>
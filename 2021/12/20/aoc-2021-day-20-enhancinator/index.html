<!doctype html><html><head><title>AoC 2021 Day 20: Enhancinator â€“ jverkamp.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=alternate type=application/atom+xml title="jverkamp.com (Atom 2.0)" href=//blog.jverkamp.com/feed/><script src=/jquery_5823201688106629450.min.30448892aa1f91e9c4cb5494e5c5e5abc13b7778de7786e5256cdc7d2424813a.js defer></script>
<script src=/jquery.fancybox_6181813213021922412.min.6ba037466db9f8843b66c38c32fe5a353344e7fd68ecda97efb63a84c881f828.js defer></script>
<script src=/katex_12008035502722260518.min.3cc3a080c0368785179e37b0cd0a71c6cf60c4fc5a8dce503f5a542ec0a25043.js defer></script>
<script src=/bigfoot_8444447145154709333.min.5e80bd85ebaeb95607834d6777bfe7013d1d161f0f02a31b845e4bd765898316.js defer></script>
<script src=/mermaid_12365941879912544862.min.e8f19283a632077085b9ad74aecad54abe84429c69789fd29ffa3a254d86abdd.js defer></script>
<script src=/custom.min.9bb1a6d1e0b58ced38df246e4479317e4561461cfabab31b36fbc36035186214.js defer></script>
<link rel=stylesheet href=/katex_14163593549783030822.min.16bacd59fb224ae6c97a749ab0ac1e708cb5e0c9ce5c9a08d7fd73dc8e69429f.css><link rel=stylesheet href=/bigfoot-default_16482899066638414220.min.f15d4faa4519addb976f9d69b42bd9eb491b3596b6b2eda83aa3e9e1f48b8f14.css><link rel=stylesheet href=/jquery.fancybox_16222217791602823071.min.e28b5d7d9d89efacb5f708ac30cbd76b1b9a0f816dfd9da96631d1d09cbbdd76.css><link rel=stylesheet href=/css_4780214198035419921.min.7cfac95bdd962d85ceec560e50fe7b04c44b58a76e5202006ef36ca8c0a7d836.css><link rel=stylesheet href=/custom.min.3bcba67844fc4a76aa7c1947a1fcf14cddaf8e9e0f1e734fde0fa219416f058d.css></head><body><div id=wrapper><header id=page-header role=banner><h1><a href=/>JP's Blog</a></h1><ul id=page-header-links><li><a href=https://github.com/jpverkamp>GitHub</a> *
<a href=https://www.flickr.com/photos/jpverkamp>Flickr</a> *
<a href=/resume>Resume</a></li><li><form action=//www.google.com/search method=get onsubmit='(function(e){e.q.value="site:blog.jverkamp.com "+e.qfront.value})(this)' class="navbar-form navbar-right" role=search _lpchecked=1><div class=form-group><input name=q type=hidden>
<input name=qfront type=text class=form-control placeholder=Search>
<button type=submit class="btn btn-default" value=Search>Search</button></div></form></li></ul><nav id=header-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=https://blog.jverkamp.com/programming/>Programming</a></li><li><a href=https://blog.jverkamp.com/reviews/>Reviews</a></li><li><a href=https://blog.jverkamp.com/photography/>Photography</a></li><li><a href=https://blog.jverkamp.com/maker/>Maker</a></li><li><a href=https://blog.jverkamp.com/writing/>Writing</a></li><li><a href=https://blog.jverkamp.com/research/>Research</a></li><li class=subscription data-subscription=rss><a href=/atom.xml rel=subscribe-rss title="subscribe via RSS">RSS</a></li></ul></nav></header><div id=page-content-wrapper><div id=page-content><article><header><h1 class=entry-title>AoC 2021 Day 20: Enhancinator</h1><div class=entry-meta><span class=entry-date>2021-12-20</span></div><div class=entry-taxonomies><div class=entry-tags><ul class=taxonomy-keys><li><a class=taxonomy-key href=/programming/languages/>Languages</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/19/aoc-2021-day-19-point-matchinator/ class=previous-link></a><a class=taxonomy-value href=/programming/languages/python>Python</a><a href=https://blog.jverkamp.com/2021/12/21/aoc-2021-day-21-dicinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/sources/>Sources</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/19/aoc-2021-day-19-point-matchinator/ class=previous-link></a><a class=taxonomy-value href=/programming/sources/advent-of-code>Advent of Code</a><a href=https://blog.jverkamp.com/2021/12/21/aoc-2021-day-21-dicinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming/topics/>Topics</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/11/aoc-2021-day-11-octopus-flashinator/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/cellular-automata>Cellular Automata</a><a href=https://blog.jverkamp.com/2021/12/25/aoc-2021-day-25-cucumbinator/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2021/12/19/aoc-2021-day-19-point-matchinator/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/data-structures>Data Structures</a><a href=https://blog.jverkamp.com/2021/12/22/aoc-2021-day-22-cubinator/ class=next-link></a></li><li><a href=https://blog.jverkamp.com/2021/12/11/aoc-2021-day-11-octopus-flashinator/ class=previous-link></a><a class=taxonomy-value href=/programming/topics/generative-art>Generative Art</a><a href=https://blog.jverkamp.com/2021/12/25/aoc-2021-day-25-cucumbinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/series/>Series</a><ul class=taxonomy-values><li><a href=https://blog.jverkamp.com/2021/12/19/aoc-2021-day-19-point-matchinator/ class=previous-link></a><a class=taxonomy-value href=/series/advent-of-code-2021>Advent of Code 2021</a><a href=https://blog.jverkamp.com/2021/12/21/aoc-2021-day-21-dicinator/ class=next-link></a></li></ul></li><li><a class=taxonomy-key href=/programming>programming</a><ul><li><a href=https://blog.jverkamp.com/2021/12/19/aoc-2021-day-19-point-matchinator/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2021/12/21/aoc-2021-day-21-dicinator/ class=next-link>Next</a></ul></li><li><a class=taxonomy-key href=/>All Posts</a><ul><li><a href=https://blog.jverkamp.com/2021/12/20/mr.-robot-season-3/ class=previous-link>Prev</a>
<a href=https://blog.jverkamp.com/2021/12/21/the-greatest-showman/ class=next-link>Next</a></ul></li></ul></div></div></header><div class=entry-content><h3 id=source-trench-maphttpsadventofcodecom2021day20>Source: <a href=https://adventofcode.com/2021/day/20>Trench Map</a></h3><h4 id=part-1-given-a-9-1-hahahugoshortcode-s0-hbhb-update-function-take-the-pixel-and-8-surrounding-pixels-as-a-9-bit-index-into-the-function-and-a-binary-image-apply-the-function-twice-and-count-the-number-of-lit-pixels-assume-that-the-canvas-is-infinite><strong>Part 1:</strong> Given a 9->1 <a href=https://en.wikipedia.org/wiki/cellular%20automota>cellular automota</a> update function (take the pixel and 8 surrounding pixels as a 9-bit index into the function) and a binary image, apply the function twice and count the number of &rsquo;lit&rsquo; pixels. Assume that the canvas is infinite.</h4><p>That was fun!</p><p>First, we want to represent our two data structures. First, the image itself. Because it can be infinite, we&rsquo;re going to store both pixels we know about (<code>data</code>) and a single value for <code>infinity</code>. We won&rsquo;t end up with stripes reaching out in this particular case. In most function applications, <code>infinity</code> will stay either on or off. But there is an edge case where it will oscillate. I&rsquo;ll come back to that when we get there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>Point <span style=color:#f92672>=</span> Tuple[int, int]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>(frozen<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InfiniteBitmap</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Store an infinitely large bitmap.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    data is &#39;known&#39; values
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    infinity is every other point off to infinity
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    data: MutableMapping[Point, bool]
</span></span><span style=display:flex><span>    infinity: bool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(file: TextIO) <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;InfiniteBitmap&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Read an infinite bitmap from file. Assume unset bits (infinity) are False.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;Reading infinity bitmap&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            (x, y): c <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;#&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> y, line <span style=color:#f92672>in</span> enumerate(file)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> x, c <span style=color:#f92672>in</span> enumerate(line<span style=color:#f92672>.</span>strip())
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        mid_x <span style=color:#f92672>=</span> max(x <span style=color:#66d9ef>for</span> x, _ <span style=color:#f92672>in</span> data) <span style=color:#f92672>//</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        mid_y <span style=color:#f92672>=</span> max(y <span style=color:#66d9ef>for</span> _, y <span style=color:#f92672>in</span> data) <span style=color:#f92672>//</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> InfiniteBitmap({(x <span style=color:#f92672>-</span> mid_x, y <span style=color:#f92672>-</span> mid_y): bit <span style=color:#66d9ef>for</span> (x, y), bit <span style=color:#f92672>in</span> data<span style=color:#f92672>.</span>items()}, <span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Return a much smaller representation.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;InfiniteBinary&lt;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>infinity<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>len(self)<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>len(self<span style=color:#f92672>.</span>data)<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>bounds()<span style=color:#e6db74>}</span><span style=color:#e6db74>&gt;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __len__(self) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Return the number of lit pixels (might be effectively infinite).&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>infinity:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> sys<span style=color:#f92672>.</span>maxsize
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> sum(
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>if</span> self[p] <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, p: Point) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Get the value at a given point p (use infinity if the point isn&#39;t otherwise known).&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>get(p, self<span style=color:#f92672>.</span>infinity)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bounds</span>(self) <span style=color:#f92672>-&gt;</span> Tuple[int, int, int, int]:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Return (minimum x, maximum x, minimum y, maximum y)&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>            min(x <span style=color:#66d9ef>for</span> x, _ <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data) <span style=color:#f92672>-</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>            max(x <span style=color:#66d9ef>for</span> x, _ <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data) <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>            min(y <span style=color:#66d9ef>for</span> _, y <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data) <span style=color:#f92672>-</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>            max(y <span style=color:#66d9ef>for</span> _, y <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>data) <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><p>Most of this is just reading the data. I did do one interesting bit in the <code>read</code> function, which was to &lsquo;recenter&rsquo; the data. After reading, the range is (0, width), but I&rsquo;d rather it be (-width/2, width/2) so that the center point is actually in the center.</p><p>In addition, we went ahead and put a <code>__len__</code> function here: the number of lit pixels.</p><p>Okay, next up, let&rsquo;s work on that mapping function. This is the bulk of the problem:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>BitIndex <span style=color:#f92672>=</span> List[bool]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NEIGHBORHOOD <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>    (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>), (<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>), (<span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>    (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>(frozen<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BinaryMapping</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Store a mapping from 9-bit values to 1-bit, loaded from a 512 character string of . (0) and # (1).&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    map: List[bool]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(file: TextIO):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Read a BinaryMapping from an input stream.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;Reading binary mapping&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BinaryMapping([c <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;#&#39;</span> <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> file<span style=color:#f92672>.</span>readline()<span style=color:#f92672>.</span>strip()])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Return a unique representation of this map.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        binary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#66d9ef>if</span> bit <span style=color:#66d9ef>else</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#66d9ef>for</span> bit <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>map)
</span></span><span style=display:flex><span>        integer <span style=color:#f92672>=</span> int(binary, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>        bytes <span style=color:#f92672>=</span> integer<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>64</span>, <span style=color:#e6db74>&#39;big&#39;</span>)
</span></span><span style=display:flex><span>        b64 <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b64encode(bytes)<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;BinaryMapping&lt;</span><span style=color:#e6db74>{</span>b64<span style=color:#e6db74>}</span><span style=color:#e6db74>&gt;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, k: Union[int, BitIndex]) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Get the value of the BinaryMapping by either integer index of a 9-bit binary BitIndex.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(k, int):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>map[k]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># TODO: Make this more efficient</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>map[int(<span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#66d9ef>if</span> bit <span style=color:#66d9ef>else</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#66d9ef>for</span> bit <span style=color:#f92672>in</span> k), <span style=color:#ae81ff>2</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, bitmap: InfiniteBitmap) <span style=color:#f92672>-&gt;</span> InfiniteBitmap:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Apply this mapping to an infinite bitmap, generating a new one with this applied.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Calling </span><span style=color:#e6db74>{</span>self<span style=color:#e6db74>}</span><span style=color:#e6db74> on </span><span style=color:#e6db74>{</span>bitmap<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Calculate the new infinity</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># If the lowest mapping is set, infinity goes from off to on</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Likewise on the highest mapping for infinity from on to off</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> bitmap<span style=color:#f92672>.</span>infinity <span style=color:#f92672>and</span> self[<span style=color:#ae81ff>0</span>]:
</span></span><span style=display:flex><span>            new_infinity <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> bitmap<span style=color:#f92672>.</span>infinity <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> self[<span style=color:#ae81ff>511</span>]:
</span></span><span style=display:flex><span>            new_infinity <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            new_infinity <span style=color:#f92672>=</span> bitmap<span style=color:#f92672>.</span>infinity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Calculate all new points</span>
</span></span><span style=display:flex><span>        new_data <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Have to calculate all pixels one level out as well</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> x, y <span style=color:#f92672>in</span> bitmap<span style=color:#f92672>.</span>data:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> xd, yd <span style=color:#f92672>in</span> NEIGHBORHOOD:
</span></span><span style=display:flex><span>                <span style=color:#75715e># Don&#39;t calculate points more than once per update</span>
</span></span><span style=display:flex><span>                center <span style=color:#f92672>=</span> (x <span style=color:#f92672>+</span> xd, y <span style=color:#f92672>+</span> yd)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> center <span style=color:#f92672>in</span> new_data:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                neighbors <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>                    bitmap[x <span style=color:#f92672>+</span> xd <span style=color:#f92672>+</span> xd2, y <span style=color:#f92672>+</span> yd <span style=color:#f92672>+</span> yd2]
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>for</span> xd2, yd2 <span style=color:#f92672>in</span> NEIGHBORHOOD
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                new_value <span style=color:#f92672>=</span> self[neighbors]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># If the value wasn&#39;t in the old map and matches the new infinity</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># We don&#39;t need to include it (prevent infinity expansion)</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> center <span style=color:#f92672>in</span> bitmap<span style=color:#f92672>.</span>data <span style=color:#f92672>and</span> new_value <span style=color:#f92672>==</span> new_infinity:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                new_data[center] <span style=color:#f92672>=</span> new_value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> InfiniteBitmap(new_data, new_infinity)
</span></span></code></pre></div><p><code>__getitem__</code> will handle infinity (so we can always read any pixel, even if it&rsquo;s not already defined in the image).</p><p><code>__call__</code> is the core, it allows the function to be called on a <code>InfiniteBitmap</code> and returns the updated bitmap. Let&rsquo;s go through a few interesting points of it:</p><ul><li><p>Updating the infinite pixels: this is the edge case I was talking about earlier. If the first value in the update function (all false) returns true, we need to change infinite to true. Likewise if the last value is false, we need to make infinite false. If both of these are the case (as they are in my input), you&rsquo;ll get a flicker (see the rendering at the end).</p></li><li><p>Updating the majority of pixels</p><ul><li>We need to update all pixels in the image <em>plus</em> all pixels adjacent to them, because those might change from off to on.</li><li>This would lead to infinitely growing memory&mldr; except we don&rsquo;t have to. If the new border pixel matches infinity, not setting it is fine, it will get rescanned on the edge update next time.</li></ul></li></ul><p>And that&rsquo;s, actually it!</p><p>Using the rendering function (we&rsquo;ll see at the end) and the test data, we can go from this:</p><figure><img src=/embeds/2021/aoc2021-20-test-0000.png></figure><p>To this:</p><figure><img src=/embeds/2021/aoc2021-20-test-0001.png></figure><p>To this:</p><figure><img src=/embeds/2021/aoc2021-20-test-0002.png></figure><p>It matches what we expect! A simple wrapper:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>part1</span>(file: typer<span style=color:#f92672>.</span>FileText):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> BinaryMapping<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>    file<span style=color:#f92672>.</span>readline()
</span></span><span style=display:flex><span>    bitmap <span style=color:#f92672>=</span> InfiniteBitmap<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    final_bitmap <span style=color:#f92672>=</span> f(f(bitmap))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(len(final_bitmap))
</span></span></code></pre></div><p>And run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 enhancinator.py part1 input.txt
</span></span><span style=display:flex><span><span style=color:#ae81ff>5057</span>
</span></span><span style=display:flex><span><span style=color:#75715e># time 290676167ns / 0.29s</span>
</span></span></code></pre></div><p>Not bad!</p><h4 id=part-2-apply-the-same-function-50-times-and-count-the-number-of-lit-pixels><strong>Part 2:</strong> Apply the same function 50 times and count the number of lit pixels.</h4><p>So&mldr; this isn&rsquo;t actually anything harder:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>part2</span>(file: typer<span style=color:#f92672>.</span>FileText):
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> BinaryMapping<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>    file<span style=color:#f92672>.</span>readline()
</span></span><span style=display:flex><span>    bitmap <span style=color:#f92672>=</span> InfiniteBitmap<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>50</span>):
</span></span><span style=display:flex><span>        bitmap <span style=color:#f92672>=</span> f(bitmap)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(len(bitmap))
</span></span></code></pre></div><p>Just slower:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 enhancinator.py part2 input.txt
</span></span><span style=display:flex><span><span style=color:#ae81ff>18502</span>
</span></span><span style=display:flex><span><span style=color:#75715e># time 10267020083ns / 10.27s</span>
</span></span></code></pre></div><p>A bit slower than I&rsquo;d like, but I don&rsquo;t have a huge buildup I can do here. I could certainly use a bit more complicated code to avoid a lot of the Python packing/uppacking and indirection, but that would make the code a lot more complicated to read. So we&rsquo;ll keep it for now.</p><h4 id=fun-with-rendering-images>Fun with rendering images</h4><p>Let&rsquo;s render these images! We&rsquo;re already mostly there:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>(frozen<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InfiniteBitmap</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>render</span>(self, include_axis: bool <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>) <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;Image&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;Render this infinity bitmap as an image.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image  <span style=color:#75715e># type: ignore</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        min_x, max_x, min_y, max_y <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>bounds()
</span></span><span style=display:flex><span>        width <span style=color:#f92672>=</span> max_x <span style=color:#f92672>-</span> min_x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        height <span style=color:#f92672>=</span> max_y <span style=color:#f92672>-</span> min_y <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        WHITE <span style=color:#f92672>=</span> (<span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>)
</span></span><span style=display:flex><span>        BLACK <span style=color:#f92672>=</span> (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        GRAY <span style=color:#f92672>=</span> (<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>127</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        image <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#39;RGB&#39;</span>, (width, height), WHITE)
</span></span><span style=display:flex><span>        pixels <span style=color:#f92672>=</span> image<span style=color:#f92672>.</span>load()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(width):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> y <span style=color:#f92672>in</span> range(height):
</span></span><span style=display:flex><span>                ix <span style=color:#f92672>=</span> x <span style=color:#f92672>+</span> min_x
</span></span><span style=display:flex><span>                iy <span style=color:#f92672>=</span> y <span style=color:#f92672>+</span> min_y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> self[ix, iy]:
</span></span><span style=display:flex><span>                    pixels[x, y] <span style=color:#f92672>=</span> BLACK
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>elif</span> include_axis <span style=color:#f92672>and</span> (ix <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> iy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>                    pixels[x, y] <span style=color:#f92672>=</span> GRAY
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> image
</span></span></code></pre></div><p>And a wrapper to render with some nice options:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.command</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>render</span>(file: typer<span style=color:#f92672>.</span>FileText, size: str, target: pathlib<span style=color:#f92672>.</span>Path, generations: int):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image  <span style=color:#75715e># type: ignore</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> BinaryMapping<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>    file<span style=color:#f92672>.</span>readline()
</span></span><span style=display:flex><span>    bitmap <span style=color:#f92672>=</span> InfiniteBitmap<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        width, height <span style=color:#f92672>=</span> [int(v) <span style=color:#66d9ef>for</span> v <span style=color:#f92672>in</span> size<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;x&#39;</span>)]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        typer<span style=color:#f92672>.</span>echo(<span style=color:#e6db74>&#39;Unable to parse size, expecting a value like 400x400&#39;</span>, err<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> typer<span style=color:#f92672>.</span>Exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    base_image <span style=color:#f92672>=</span> bitmap<span style=color:#f92672>.</span>render(<span style=color:#66d9ef>True</span>)<span style=color:#f92672>.</span>resize((width, height), Image<span style=color:#f92672>.</span>NEAREST)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rest_images <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, generations <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        bitmap <span style=color:#f92672>=</span> f(bitmap)
</span></span><span style=display:flex><span>        rest_images<span style=color:#f92672>.</span>append(bitmap<span style=color:#f92672>.</span>render(<span style=color:#66d9ef>True</span>)<span style=color:#f92672>.</span>resize((width, height), Image<span style=color:#f92672>.</span>NEAREST))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> str(target)<span style=color:#f92672>.</span>lower()<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#39;gif&#39;</span>):
</span></span><span style=display:flex><span>        base_image<span style=color:#f92672>.</span>save(target, save_all<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, append_images<span style=color:#f92672>=</span>rest_images)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i, image <span style=color:#f92672>in</span> enumerate([base_image] <span style=color:#f92672>+</span> rest_images):
</span></span><span style=display:flex><span>            image<span style=color:#f92672>.</span>save(str(target)<span style=color:#f92672>.</span>format(i<span style=color:#f92672>=</span>i))
</span></span></code></pre></div><p>For the test input:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 enhancinator.py render test.txt 400x400 <span style=color:#e6db74>&#39;aoc2021-20-test.gif&#39;</span> <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><figure><img src=/embeds/2021/aoc2021-20-test.gif></figure><p>That&rsquo;s pretty cool. What about my own input?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 enhancinator.py render input.txt 400x400 <span style=color:#e6db74>&#39;aoc2021-20-input.gif&#39;</span> <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><figure><img src=/embeds/2021/aoc2021-20-input.gif></figure><p>Huh. Other than the flashing, that&rsquo;s not actually that cool. Eating away at the corner is interesting enough. I suppose it has to be generated for different users, so there&rsquo;s only so much you can do with it. So it goes.</p><p>Now I wonder how long it takes to completely clear&mldr;</p><h4 id=finding-emptiness>Finding emptiness</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>find_emptiness</span>(file: typer<span style=color:#f92672>.</span>FileText):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> BinaryMapping<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>    file<span style=color:#f92672>.</span>readline()
</span></span><span style=display:flex><span>    bitmap <span style=color:#f92672>=</span> InfiniteBitmap<span style=color:#f92672>.</span>read(file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    generation <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> len(bitmap):
</span></span><span style=display:flex><span>        bitmap <span style=color:#f92672>=</span> f(bitmap)
</span></span><span style=display:flex><span>        generation <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(generation)
</span></span></code></pre></div><p>How long?</p><p>It&rsquo;s still running&mldr;</p></div></article></div></div><footer id=page-footer role=contentinfo><nav id=footer-navigation role=navigation class=ribbon><ul class=main-navigation><li><a href=/archive-by-date/>All posts: By Date</a></li><li><a href=/archive-by-tag/>All posts: By Tag</a></li><li><a href=/atom.xml>RSS: All <sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li><li><a href=/programming/atom.xml>RSS: programming<sup><svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24"><path fill="#fff" d="M6.503 20.752C6.503 22.546 5.047 24 3.252 24c-1.796.0-3.252-1.454-3.252-3.248s1.456-3.248 3.252-3.248c1.795.001 3.251 1.454 3.251 3.248zM0 8.18v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817C15.777 15.29 8.721 8.242.0 8.18zm0-3.368C10.58 4.858 19.152 13.406 19.183 24H24c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg></sup></a></li></ul></nav><div id=page-footer-content><div class=legal><p>All posts unless otherwise mentioned are licensed under
<a rel=license href=//creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US><img alt="Creative Commons License" style=border-width:0 src=//i.creativecommons.org/l/by-nc-sa/3.0/80x15.png></a></p><p>Any source code unless otherwise mentioned is licensed under the <a href=//directory.fsf.org/wiki/License:BSD_3Clause>3 clause BSD license</a></p></div></div></footer></div></body></html>